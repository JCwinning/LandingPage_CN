---
title: "ç»“åˆ AI é¢„æµ‹çš„ Streamlit å¤©æ°”é¢„æŠ¥åº”ç”¨"
author: "Tony D"
date: "2025-11-06"
categories: [Python, Streamlit, AI, tutorial]
image: "images/0.png"

format:
  html:
    code-fold: true
    code-tools: true
    code-copy: true

execute:
  eval: false
  warning: false
---


# é¡¹ç›®æ¦‚è§ˆ

åœ¨è¿™ä¸€è¯¦å°½çš„æ•™ç¨‹ä¸­ï¼Œæˆ‘å°†æŒ‡å¯¼æ‚¨åˆ›å»ºä¸€ä¸ªç²¾è‡´çš„å¤©æ°”é¢„æŠ¥åº”ç”¨ç¨‹åºï¼Œè¯¥åº”ç”¨å°†ç°ä»£ Web å¼€å‘ä¸äººå·¥æ™ºèƒ½ç›¸ç»“åˆã€‚æœ¬é¡¹ç›®æ¼”ç¤ºäº†å¦‚ä½•æ„å»ºä¸€ä¸ªå…·å¤‡äº¤äº’å¼åœ°å›¾ã€åŒè¯­æ”¯æŒã€å®æ—¶æ•°æ®å¯è§†åŒ–å’Œ AI é©±åŠ¨çš„å¤©æ°”åˆ†æåŠŸèƒ½çš„ç”Ÿäº§çº§å¤©æ°”åº”ç”¨ã€‚


åœ¨çº¿æ¼”ç¤º: [https://weather-trend.streamlit.app/](https://weather-trend.streamlit.app/)

Github: [https://github.com/JCwinning/weather_trend](https://github.com/JCwinning/weather_trend)


![å¤©æ°”é¢„æŠ¥åº”ç”¨ä¸»ç•Œé¢](images/0.png){width="100%"}



è¿™æ¬¾å¤©æ°”é¢„æŠ¥åº”ç”¨ä¸ä»…ä»…æä¾›åŸºç¡€çš„å¤©æ°”æ•°æ®ï¼Œè¿˜é›†æˆäº†å¤šé¡¹é«˜çº§åŠŸèƒ½ï¼š

- **äº¤äº’å¼ä½ç½®é€‰æ‹©**ï¼šç‚¹å‡»åœ°å›¾ä¸Šçš„ä»»æ„ä½ç½®æˆ–é€šè¿‡åŸå¸‚åç§°æœç´¢
- **åŒè¯­ç•Œé¢**ï¼šå®Œæ•´çš„è‹±æ–‡/ä¸­æ–‡è¯­è¨€æ”¯æŒåŠåˆ‡æ¢åŠŸèƒ½
- **AI é©±åŠ¨çš„åˆ†æ**ï¼šä½¿ç”¨ DeepSeek AI æä¾›å¤©æ°”åˆ†æå’Œå»ºè®®
- **é«˜çº§å¯è§†åŒ–**ï¼šæ¸©åº¦è¶‹åŠ¿ã€ç©ºæ°”è´¨é‡ç›‘æµ‹å’Œé™é›¨æ¦‚ç‡
- **å®æ—¶æ•°æ®**ï¼š7 å¤©å†å²æ•°æ®å’Œ 5 å¤©é¢„æŠ¥æ•°æ®
- **å“åº”å¼è®¾è®¡**ï¼šåœ¨æ¡Œé¢ã€å¹³æ¿å’Œç§»åŠ¨è®¾å¤‡ä¸Šè¿è¡Œæ— é˜»

## æŠ€æœ¯æ¶æ„

```{mermaid}
%%| fig-cap: "å¤©æ°”åº”ç”¨æ¶æ„"
%%| eval: true
flowchart TD
    A[ç”¨æˆ·ç•Œé¢<br/>Streamlit Web åº”ç”¨] --> B[ä½ç½®æœåŠ¡]
    A --> C[å¤©æ°”æ•°æ® API]
    A --> D[AI é›†æˆå±‚]
    A --> E[å¯è§†åŒ–å¼•æ“]

    B --> F[äº¤äº’å¼åœ°å›¾<br/>Folium + OpenStreetMap]
    B --> G[åŸå¸‚æœç´¢<br/>Nominatim åœ°ç†ç¼–ç ]

    C --> H[Open-Meteo API<br/>å¤©æ°” + ç©ºæ°”è´¨é‡]
    C --> I[æ•°æ®å¤„ç†<br/>Pandas DataFrame]

    D --> J[ModelScope API<br/>DeepSeek-V3.2 AI]
    D --> K[æ™ºèƒ½åˆ†æ<br/>å¤©æ°”å»ºè®®]

    E --> L[Altair å›¾è¡¨<br/>æ¸©åº¦è¶‹åŠ¿]
    E --> M[æ•°æ®è¡¨æ ¼<br/>å¤©æ°”è¯¦æƒ…]

    F --> A
    G --> A
    I --> E
    K --> A
```

### æŠ€æœ¯æ ˆ

- **å‰ç«¯æ¡†æ¶**ï¼šStreamlitï¼Œç”¨äºå¿«é€Ÿå¼€å‘ Web åº”ç”¨ç¨‹åº
- **åœ°å›¾**ï¼šFolium é…åˆ OpenStreetMap å›¾å±‚ï¼Œå®ç°äº¤äº’å¼ä½ç½®é€‰æ‹©
- **æ•°æ®å¯è§†åŒ–**ï¼šAltairï¼Œç”¨äºä¸“ä¸šçš„å›¾è¡¨å’Œå›¾å½¢
- **API é›†æˆ**ï¼šOpen-Meteoï¼Œè·å–å¤©æ°”å’Œç©ºæ°”è´¨é‡æ•°æ®
- **AI æœåŠ¡**ï¼šé€šè¿‡ ModelScope API ä½¿ç”¨ DeepSeek-V3.2 è¿›è¡Œæ™ºèƒ½åˆ†æ
- **åœ°ç†ç¼–ç **ï¼šNominatimï¼Œç”¨äºåœ°å€ä¸åæ ‡çš„è½¬æ¢
- **å›½é™…åŒ–**ï¼šè‡ªå®šä¹‰è¯­è¨€ç³»ç»Ÿï¼Œæ”¯æŒä¸­è‹±æ–‡åˆ‡æ¢

## å¿«é€Ÿä¸Šæ‰‹

### ç¯å¢ƒè¦æ±‚ä¸å®‰è£…

åœ¨æ·±å…¥ä»£ç ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆæ­å»ºå¥½å¼€å‘ç¯å¢ƒï¼š

```bash
# 1. å…‹éš†ä»“åº“
git clone <your-repo-url>
cd weather_trend

# 2. å®‰è£…æ‰€éœ€è½¯ä»¶åŒ…
pip install streamlit pandas requests altair folium streamlit-folium geopy python-dotenv openai

# 3. ä¸º AI åŠŸèƒ½è®¾ç½®ç¯å¢ƒå˜é‡
echo "modelscope=æ‚¨çš„ API å¯†é’¥" > .env
```

### æ ¸å¿ƒä¾èµ–é¡¹è¯´æ˜

- **streamlit**ï¼šå…·å¤‡å“åº”å¼ UI ç»„ä»¶çš„ Web åº”ç”¨æ¡†æ¶
- **pandas**ï¼šç”¨äºå¤©æ°”æ•°æ®é›†çš„æ•°æ®æ“ä½œå’Œåˆ†æ
- **requests**ï¼šç”¨äº API é€šä¿¡çš„ HTTP å®¢æˆ·ç«¯
- **altair**ï¼šå£°æ˜å¼ç»Ÿè®¡å¯è§†åŒ–åº“
- **folium + streamlit-folium**ï¼šäº¤äº’å¼åœ°å›¾é›†æˆ
- **geopy**ï¼šç”¨äºä½ç½®æŸ¥æ‰¾çš„åœ°ç†ç¼–ç æœåŠ¡
- **python-dotenv**ï¼šç¯å¢ƒå˜é‡ç®¡ç†
- **openai**ï¼šAI æ¨¡å‹é›†æˆï¼ˆä¸ ModelScope å…¼å®¹ï¼‰

## æ ¸å¿ƒåŠŸèƒ½å®ç°

### 1. å¸¦ä½ç½®é€‰æ‹©çš„äº¤äº’å¼åœ°å›¾

åœ°å›¾åŠŸèƒ½å…è®¸ç”¨æˆ·ç‚¹å‡»ä»»æ„ä½ç½®å¹¶è·å–è¯¥åœ°ç‚¹çš„å®æ—¶å¤©æ°”æ•°æ®ï¼š

```{python}
import folium
from streamlit_folium import st_folium

# åˆ›å»ºä»¥é»˜è®¤ä½ç½®ä¸ºä¸­å¿ƒçš„äº¤äº’å¼åœ°å›¾
def create_interactive_map(lat=40.7128, lon=-74.0060, zoom=10):
    """åˆ›å»ºäº¤äº’å¼ Folium åœ°å›¾"""
    m = folium.Map(
        location=[lat, lon],
        zoom_start=zoom,
        tiles="OpenStreetMap"
    )

    # æ·»åŠ ç‚¹å‡»äº‹ä»¶å¤„ç†å™¨ä»¥æ•è·åæ ‡
    m.add_child(folium.LatLngPopup())

    return m

# åœ¨ Streamlit ä¸­æ˜¾ç¤ºåœ°å›¾
if 'map_data' not in st.session_state:
    st.session_state.map_data = None

map_object = create_interactive_map()
st_data = st_folium(map_object, width=700, height=500)

# æ•è·ç‚¹å‡»å¤„çš„åæ ‡
if st_data['last_clicked']:
    lat = st_data['last_clicked']['lat']
    lon = st_data['last_clicked']['lng']
    st.session_state.clicked_location = (lat, lon)
    get_weather_for_coordinates(lat, lon)
```

**å…³é”®ç‰¹æ€§ï¼š**
- **ç‚¹å‡»é€‰æ‹©**ï¼šç”¨æˆ·å¯ä»¥ç‚¹å‡»åœ°å›¾ä¸Šçš„ä»»ä½•åœ°æ–¹
- **ç¼©æ”¾æ§åˆ¶**ï¼šæ ‡å‡†çš„åœ°å›¾å¯¼èˆªåŠŸèƒ½
- **å“åº”å¼è®¾è®¡**ï¼šé€‚åº”ä¸åŒçš„å±å¹•å°ºå¯¸
- **åæ ‡æ•è·**ï¼šè‡ªåŠ¨æå–æ‰€é€‰ä½ç½®çš„ä¿¡æ¯

### 2. åŒè¯­åŸå¸‚æœç´¢ç³»ç»Ÿ

æ­¤åº”ç”¨æ”¯æŒä¸­è‹±æ–‡åŸå¸‚åç§°ï¼Œå¹¶å…·å¤‡æ™ºèƒ½çš„å›é€€æœºåˆ¶ï¼š

```{python}
import re
from geopy.geocoders import Nominatim

# æ‰©å±•çš„ä¸­æ–‡å­—ç¬¦æ£€æµ‹
def contains_chinese(text):
    """æ£€æŸ¥æ–‡æœ¬æ˜¯å¦åŒ…å«ä¸­æ–‡å­—ç¬¦ï¼ŒåŒ…æ‹¬ CJK ç»Ÿä¸€æ±‰å­—"""
    chinese_pattern = re.compile(
        r"[\u4e00-\u9fff\u3400-\u4dbf\U00020000-\U0002a6df\U0002a700-\U0002b73f]"
    )
    return bool(chinese_pattern.search(text))

# ä¸­æ–‡åŸå¸‚æ˜ å°„ï¼Œä»¥è·å¾—æ›´å¥½çš„è§£ææ•ˆæœ
CHINESE_CITY_MAPPING = {
    "çº½çº¦": "New York",
    "ä¸œäº¬": "Tokyo",
    "ä¼¦æ•¦": "London",
    "å·´é»": "Paris",
    "æ´›æ‰çŸ¶": "Los Angeles",
    # ... æ›´å¤šæ˜ å°„
}

def get_coordinates_for_city(city_name):
    """è·å–åŸå¸‚åæ ‡ï¼Œæ”¯æŒå¤šè¯­è¨€"""
    # æ£€æŸ¥ä¸­æ–‡åŸå¸‚åç§°æ˜ å°„
    if contains_chinese(city_name) and city_name in CHINESE_CITY_MAPPING:
        city_name = CHINESE_CITY_MAPPING[city_name]

    # å¯¹åŸå¸‚è¿›è¡Œåœ°ç†ç¼–ç 
    geolocator = Nominatim(user_agent="weather_app")
    try:
        location = geolocator.geocode(city_name)
        return (location.latitude, location.longitude) if location else None
    except:
        return None
```

**åŒè¯­ç‰¹æ€§ï¼š**
- **ä¸­æ–‡å­—ç¬¦æ£€æµ‹**ï¼šé’ˆå¯¹ CJK å­—ç¬¦çš„é«˜çº§æ­£åˆ™æ¨¡å¼
- **åŸå¸‚åç§°æ˜ å°„**ï¼šä¸»è¦åŸå¸‚çš„ç¿»è¯‘æ•°æ®åº“
- **é”™è¯¯å¤„ç†**ï¼šå½“åœ°ç†ç¼–ç å¤±è´¥æ—¶ä¿æŒç³»ç»Ÿç¨³å®š
- **Unicode æ”¯æŒ**ï¼šå®Œæ•´æ”¯æŒå›½é™…åŒ–å­—ç¬¦

### 3. å¤©æ°”æ•°æ®é›†æˆ

è¯¥åº”ç”¨ç¨‹åºä» Open-Meteo API è·å–å…¨é¢çš„å¤©æ°”æ•°æ®ï¼š

```{python}
import requests
import pandas as pd

def get_weather_data(latitude, longitude):
    """è·å– 12 å¤©çš„å¤©æ°”æ•°æ®ï¼ˆ7 å¤©å†å² + 5 å¤©é¢„æŠ¥ï¼‰"""

    # API ç«¯ç‚¹é…ç½®
    url = "https://api.open-meteo.com/v1/forecast"
    params = {
        'latitude': latitude,
        'longitude': longitude,
        'daily': [
            'temperature_2m_max', 'temperature_2m_min', 'temperature_2m_mean',
            'weathercode', 'windspeed_10m_max', 'precipitation_probability_max',
            'pm10', 'pm2_5'
        ],
        'timezone': 'auto',
        'past_days': 7,  # è·å–å†å²æ•°æ®
        'forecast_days': 5  # è·å–æœªæ¥é¢„æŠ¥
    }

    try:
        response = requests.get(url, params=params, timeout=10)
        response.raise_for_status()

        # å¤„ç†å“åº”æ•°æ®
        data = response.json()
        df = process_weather_data(data)

        return df

    except requests.RequestException as e:
        st.error(f"API è¯·æ±‚å¤±è´¥: {e}")
        return None

def process_weather_data(data):
    """å°† API å“åº”è½¬æ¢ä¸ºç»“æ„åŒ– DataFrame"""
    daily_data = data['daily']

    # åˆ›å»ºæ—¥æœŸèŒƒå›´ï¼ˆå†å² + æœªæ¥ï¼‰
    dates = pd.date_range(
        start=pd.to_datetime(daily_data['time'][0]),
        periods=len(daily_data['time']),
        freq='D'
    )

    # æ„å»º DataFrame
    df = pd.DataFrame({
        'date': dates,
        'temperature_max': daily_data['temperature_2m_max'],
        'temperature_min': daily_data['temperature_2m_min'],
        'temperature_mean': daily_data['temperature_2m_mean'],
        'weather_code': daily_data['weathercode'],
        'wind_speed_max': daily_data['windspeed_10m_max'],
        'rain_probability': daily_data['precipitation_probability_max'],
        'pm2_5': daily_data.get('pm2_5', [0] * len(dates))
    })

    # æ·»åŠ è¡ç”Ÿåˆ—
    df['is_today'] = df['date'].dt.date == pd.Timestamp.now().date()
    df['is_future'] = df['date'] > pd.Timestamp.now()

    return df
```

**æ•°æ®å¤„ç†ç‰¹æ€§ï¼š**
- **å†å² + é¢„æŠ¥**ï¼š7 å¤©è¿‡å» + 5 å¤©æœªæ¥
- **ç©ºæ°”è´¨é‡é›†æˆ**ï¼šPM2.5 å’Œ PM10 æ•°æ®
- **æŒ‡æ ‡è¡ç”Ÿ**ï¼šä»Šæ—¥æ£€æµ‹å’Œæœªæ¥è¶‹åŠ¿åˆ†æ
- **é”™è¯¯ç®¡ç†**ï¼šå¥å£®çš„ API é”™è¯¯å¤„ç†æœºåˆ¶

### 4. é«˜çº§æ•°æ®å¯è§†åŒ–

æ¸©åº¦è¶‹åŠ¿å›¾ï¼Œæ¸…æ™°åœ°åŒºåˆ†äº†å†å²æ•°æ®å’Œé¢„æŠ¥æ•°æ®ï¼š

```{python}
import altair as alt

def create_temperature_chart(weather_df):
    """åˆ›å»ºäº¤äº’å¼æ¸©åº¦è¶‹åŠ¿å›¾"""

    # åŒ…å«æ¸©åº¦çº¿çš„åŸºå‡†å›¾è¡¨
    base_chart = alt.Chart(weather_df).mark_line(
        point=True,
        strokeWidth=3,
        opacity=0.8
    ).encode(
        x=alt.X('date:T', title='æ—¥æœŸ'),
        y=alt.Y('temperature_mean:Q', title='æ¸©åº¦ (Â°C)', scale=alt.Scale(domain=[weather_df['temperature_min'].min()-5, weather_df['temperature_max'].max()+5]))
    ).properties(
        width=800,
        height=400,
        title='æ¸©åº¦è¶‹åŠ¿å›¾'
    )

    # å†å²æ•°æ®ï¼ˆå®çº¿ï¼‰
    historical_data = weather_df[weather_df['is_future'] == False]
    historical_line = base_chart.transform_filter(
        'datum.is_future == false'
    ).encode(
        color=alt.value('blue'),
        strokeDash=alt.value([0])  # å®çº¿
    )

    # æœªæ¥é¢„æŠ¥ï¼ˆè™šçº¿ï¼‰
    future_data = weather_df[weather_df['is_future'] == True]
    future_line = base_chart.transform_filter(
        'datum.is_future == true'
    ).encode(
        color=alt.value('red'),
        strokeDash=alt.value([5, 5])  # è™šçº¿
    )

    # ä»Šæ—¥æŒ‡ç¤ºçº¿
    today_line = alt.Chart(pd.DataFrame({'x': [pd.Timestamp.now()]})).mark_rule(
        strokeDash=[2, 2],
        stroke='green',
        strokeWidth=2
    ).encode(x='x:T')

    return (historical_line + future_line + today_line).resolve_scale(color='independent')
```

**å¯è§†åŒ–ç‰¹æ€§ï¼š**
- **çº¿æ¡æ ·å¼åŒºåˆ†**ï¼šå®çº¿ï¼ˆå†å²ï¼‰å¯¹æ¯”è™šçº¿ï¼ˆé¢„æŠ¥ï¼‰
- **ä»Šæ—¥æŒ‡ç¤ºå™¨**ï¼šå¯¹å½“å‰æ—¥æœŸçš„è§†è§‰æ ‡è®°
- **é¢œè‰²ç¼–ç **ï¼šè“è‰²ä»£è¡¨è¿‡å»ï¼Œçº¢è‰²ä»£è¡¨æœªæ¥
- **äº¤äº’å¼æç¤º**ï¼šæ‚¬åœæ—¶æ˜¾ç¤ºæ•°æ®ç‚¹ä¿¡æ¯

### 5. ç©ºæ°”è´¨é‡ç›‘æµ‹

ç¬¦åˆ EPA æ ‡å‡†çš„ PM2.5 æ°´å¹³é¢œè‰²ç¼–ç ï¼š

```{python}
def get_air_quality_level(pm25_value):
    """åŸºäºç¾å›½ EPA PM2.5 æ ‡å‡†è·å–ç©ºæ°”è´¨é‡ç­‰çº§"""

    if pm25_value <= 12:
        return {
            'level': 'ä¼˜',
            'color': '#00e400',  # æ·±ç»¿
            'text_color': 'white',
            'icon': 'ğŸŸ¢'
        }
    elif pm25_value <= 35.4:
        return {
            'level': 'è‰¯',
            'color': '#ffff00',  # æµ…é»„
            'text_color': 'black',
            'icon': 'ğŸŸ¢'
        }
    elif pm25_value <= 55.4:
        return {
            'level': 'è½»åº¦æ±¡æŸ“',
            'color': '#ff7e00',  # æ©™é»„
            'text_color': 'black',
            'icon': 'ğŸŸ¡'
        }
    elif pm25_value <= 150.4:
        return {
            'level': 'ä¸­åº¦æ±¡æŸ“',
            'color': '#ff0000',  # çº¢è‰²
            'text_color': 'white',
            'icon': 'ğŸŸ '
        }
    elif pm25_value <= 250.4:
        return {
            'level': 'é‡åº¦æ±¡æŸ“',
            'color': '#8f3f97',  # ç´«è‰²
            'text_color': 'white',
            'icon': 'ğŸ”´'
        }
    else:
        return {
            'level': 'ä¸¥é‡æ±¡æŸ“',
            'color': '#7e0023',  # æ·±è¤
            'text_color': 'white',
            'icon': 'âš«'
        }

def display_air_quality_badge(pm25_value):
    """æ˜¾ç¤ºå¸¦è§†è§‰æŒ‡ç¤ºçš„ç©ºæ°”è´¨é‡å¾½ç« """
    aq_info = get_air_quality_level(pm25_value)

    st.markdown(f"""
    <div style="background-color: {aq_info['color']}; color: {aq_info['text_color']};
                padding: 10px; border-radius: 5px; text-align: center; margin: 5px 0;">
        <strong>{aq_info['icon']} PM2.5: {pm25_value} Î¼g/mÂ³</strong><br>
        <small>{aq_info['level']}</small>
    </div>
    """, unsafe_allow_html=True)
```

**ç©ºæ°”è´¨é‡åŠŸèƒ½ç‰¹æ€§ï¼š**
- **EPA æ ‡å‡†**ï¼šåŸºäºç¾å›½ç¯å¢ƒä¿æŠ¤ç½²çš„æ ‡å‡†
- **è§†è§‰æŒ‡ç¤ºå™¨**ï¼šå¸¦å›¾æ ‡çš„é¢œè‰²ç¼–ç å¾½ç« 
- **å¯è®¿é—®æ€§**ï¼šé«˜å¯¹æ¯”åº¦è‰²å€¼ç¡®ä¿å¯è¯»æ€§
- **ç§‘æ™®æ€§**ï¼šé€šè¿‡ç­‰çº§è¯´æ˜å¸®åŠ©ç”¨æˆ·ç†è§£

## AI é©±åŠ¨çš„å¤©æ°”æ™ºèƒ½

### é›†æˆ DeepSeek AI

æœ¬é¡¹ç›®æœ€å…·åˆ›æ–°æ€§çš„åŠŸèƒ½æ˜¯ä½¿ç”¨ ModelScope å¹³å°ä¸Šçš„ DeepSeek-V3.2 æ¨¡å‹æä¾› AI å¤©æ°”åˆ†æï¼š

![AI å¤©æ°”åˆ†æå»ºè®®](images/1.png){width="100%"}

```{python}
from openai import OpenAI
import os

# åˆå§‹åŒ– ModelScope çš„ AI å®¢æˆ·ç«¯
def init_ai_client():
    """åˆå§‹åŒ–ç”¨äº ModelScope API çš„ OpenAI å®¢æˆ·ç«¯"""
    return OpenAI(
        base_url="https://dashscope.aliyuncs.com/compatible-mode/v1",
        api_key=os.getenv("modelscope"),
    )

def generate_weather_insights(weather_df, location_name, language="en"):
    """ç”Ÿæˆ AI é©±åŠ¨çš„å¤©æ°”åˆ†æå»ºè®®"""

    # å‡†å¤‡ç”¨äº AI åˆ†æçš„å¤©æ°”æ•°æ®
    today_index = weather_df[weather_df['is_today']].index[0] if any(weather_df['is_today']) else 0
    historical_data = weather_df.iloc[:today_index+1]  # æˆªè‡³ä»Šæ—¥
    future_data = weather_df.iloc[today_index:]  # ä»Šæ—¥èµ·

    # ä¸º AI åˆ›å»ºå¤©æ°”æ‘˜è¦
    weather_summary = f"""
    åœ°ç‚¹: {location_name}

    å†å²å¤©æ°” (è¿‡å» {len(historical_data)} å¤©):
    - æ¸©åº¦èŒƒå›´: {historical_data['temperature_min'].min():.1f}Â°C åˆ° {historical_data['temperature_max'].max():.1f}Â°C
    - å¹³å‡æ¸©åº¦: {historical_data['temperature_mean'].mean():.1f}Â°C
    - ç©ºæ°”è´¨é‡èŒƒå›´: {historical_data['pm2_5'].min():.1f} åˆ° {historical_data['pm2_5'].max():.1f} PM2.5

    å¤©æ°”é¢„æŠ¥ (æœªæ¥ {len(future_data)} å¤©):
    - æ¸©åº¦èŒƒå›´: {future_data['temperature_min'].min():.1f}Â°C åˆ° {future_data['temperature_max'].max():.1f}Â°C
    - å¹³å‡é™é›¨æ¦‚ç‡: {future_data['rain_probability'].mean():.0f}%
    """

    # æ ¹æ®è¯­è¨€ç”Ÿæˆæç¤ºè¯
    if language == "zh":
        prompt = f"""
        åŸºäºä»¥ä¸‹å¤©æ°”æ•°æ®ï¼Œè¯·æä¾›ç®€æ´å®ç”¨çš„å¤©æ°”å»ºè®®ï¼ˆ100-200å­—ï¼‰ï¼š

        {weather_summary}

        è¯·åŒ…æ‹¬ï¼š
        1. å¤©æ°”æ¨¡å¼åˆ†æ
        2. ç©¿è¡£å»ºè®®
        3. æˆ·å¤–æ´»åŠ¨å»ºè®®
        4. å¥åº·æ³¨æ„äº‹é¡¹ï¼ˆå¦‚ç©ºæ°”è´¨é‡ç›¸å…³ï¼‰

        è¯·ç”¨ä¸­æ–‡å›å¤ï¼Œè¯­æ°”å‹å¥½å®ç”¨ã€‚
        """
    else:
        prompt = f"""
        Based on the following weather data, please provide concise and practical weather advice (100-200 words):

        {weather_summary}

        Please include:
        1. Weather pattern analysis
        2. Clothing recommendations
        3. Outdoor activity suggestions
        4. Health considerations (related to air quality if applicable)

        Please respond in {language} with a friendly and practical tone.
        """

    try:
        client = init_ai_client()
        response = client.chat.completions.create(
            model="deepseek-ai/DeepSeek-V3",
            messages=[{"role": "user", "content": prompt}],
            max_tokens=300,
            temperature=0.7
        )

        return response.choices[0].message.content

    except Exception as e:
        return f"AI æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ã€‚é”™è¯¯ä¿¡æ¯: {str(e)}"

# åœ¨ Streamlit åº”ç”¨ä¸­
if st.button(get_text("ai_button", language)):
    with st.spinner("æ­£åœ¨è·å– AI å¤©æ°”å»ºè®®..."):
        if 'weather_df' in st.session_state and 'location_name' in st.session_state:
            ai_insights = generate_weather_insights(
                st.session_state.weather_df,
                st.session_state.location_name,
                language
            )
            st.markdown("### ğŸ¤– AI å¤©æ°”åˆ†æ")
            st.write(ai_insights)
        else:
            st.warning("è¯·å…ˆè·å–å¤©æ°”æ•°æ®ã€‚")
```

**AI ç‰¹æ€§ï¼š**
- **ä¸Šä¸‹æ–‡æ„ŸçŸ¥åˆ†æ**ï¼šåŒæ—¶å¤„ç†å†å²å’Œé¢„æŠ¥æ•°æ®
- **å¤šè¯­è¨€æ”¯æŒ**ï¼šAI æ ¹æ®ç”¨æˆ·é€‰æ‹©çš„è¯­è¨€å›å¤
- **å®ç”¨å»ºè®®**ï¼šæä¾›ç©¿è¡£ã€æ´»åŠ¨å’Œå¥åº·æ–¹é¢çš„è§è§£
- **å®¹é”™å¤„ç†**ï¼šåœ¨ AI æœåŠ¡ä¸å¯ç”¨æ—¶ä¼˜é›…åœ°æç¤º

### AI æç¤ºè¯å·¥ç¨‹

AI ç³»ç»Ÿé€šè¿‡ç²¾å¿ƒè®¾è®¡çš„æç¤ºè¯ç”Ÿæˆæœ‰ä»·å€¼çš„è§è§£ï¼š

**æç¤ºè¯ç»“æ„ï¼š**
1. **æ•°æ®ä¸Šä¸‹æ–‡**ï¼šå…¨é¢çš„å¤©æ°”ç»Ÿè®¡ä¿¡æ¯
2. **ä»»åŠ¡å®šä¹‰**ï¼šæ˜ç¡®çš„åˆ†æè¦æ±‚
3. **è¾“å‡ºæ ¼å¼**ï¼šç»“æ„åŒ–çš„å›å¤ç±»åˆ«
4. **è¯­è¨€é€‚é…**ï¼šä¸ UI è¯­è¨€ä¿æŒä¸€è‡´

**å»ºè®®ç±»åˆ«ï¼š**
- **å¤©æ°”æ¨¡å¼åˆ†æ**ï¼šè¶‹åŠ¿å’Œå¼‚å¸¸åˆ†æ
- **ç©¿è¡£å»ºè®®**ï¼šå®ç”¨çš„ç©¿ç€æŒ‡å¯¼
- **æ´»åŠ¨å»ºè®®**ï¼šæˆ·å¤–è®¡åˆ’çš„æ¨è
- **å¥åº·æ³¨æ„äº‹é¡¹**ï¼šç©ºæ°”è´¨é‡åŠå¤©æ°”å½±å“

## å›½é™…åŒ–ç³»ç»Ÿ

### è¯­è¨€ç®¡ç†æ¶æ„

åº”ç”¨å®ç°äº†ä¸€ä¸ªå…¨é¢çš„åŒè¯­ç³»ç»Ÿï¼š

```{python}
# language.py - ç¿»è¯‘ç®¡ç†
TRANSLATIONS = {
    "en": {
        "app_title": "Weather Forecast App",
        "sidebar_header": "Weather Query",
        "city_input_placeholder": "Enter a city name",
        "get_weather_button": "Get Weather",
        "weather_trends_title": "Weather Trends for",
        "ai_button": "AI Weather Advice",
        # ... æ›´å¤šç¿»è¯‘
    },
    "zh": {
        "app_title": "å¤©æ°”é¢„æŠ¥åº”ç”¨",
        "sidebar_header": "å¤©æ°”æŸ¥è¯¢",
        "city_input_placeholder": "è¾“å…¥åŸå¸‚åç§°",
        "get_weather_button": "è·å–å¤©æ°”",
        "weather_trends_title": "å¤©æ°”è¶‹åŠ¿",
        "ai_button": "AIå¤©æ°”å»ºè®®",
        # ... æ›´å¤šç¿»è¯‘
    }
}

def get_text(key, language="en"):
    """è·å–æŒ‡å®šé”®å’Œè¯­è¨€çš„ç¿»è¯‘æ–‡æœ¬"""
    return TRANSLATIONS.get(language, {}).get(key, key)

def get_available_languages():
    """è·å–å¯ç”¨çš„è¯­è¨€é€‰é¡¹"""
    return {"en": "English", "zh": "ä¸­æ–‡"}

# åœ¨ä¸»ç¨‹åº (app.py) ä¸­
def main():
    # è¯­è¨€çŠ¶æ€ç®¡ç†
    if 'language' not in st.session_state:
        st.session_state.language = "en"

    # è¯­è¨€åˆ‡æ¢æŒ‰é’®
    current_lang = st.session_state.language
    available_langs = get_available_languages()

    col1, col2, col3 = st.columns([1,1,6])
    with col1:
        if st.button("EN", disabled=current_lang=="en"):
            st.session_state.language = "en"
            st.rerun()

    with col2:
        if st.button("ä¸­æ–‡", disabled=current_lang=="zh"):
            st.session_state.language = "zh"
            st.rerun()

    # åœ¨æ‰€æœ‰ UI å…ƒç´ ä¸­ä½¿ç”¨å½“å‰è¯­è¨€
    language = st.session_state.language
    st.title(get_text("app_title", language))
    st.sidebar.header(get_text("sidebar_header", language))
```

**å›½é™…åŒ–ç‰¹æ€§ï¼š**
- **å®Œæ•´çš„ UI ç¿»è¯‘**ï¼šæœ¬åœ°åŒ–æ‰€æœ‰ç•Œé¢å…ƒç´ 
- **åŠ¨æ€è¯­è¨€åˆ‡æ¢**ï¼šè¯­è¨€æ›´æ”¹æ—¶å³æ—¶æ›´æ–° UI
- **ä¸­æ–‡å­—ç¬¦æ”¯æŒ**ï¼šå®Œæ•´çš„ Unicode å’Œ CJK æ”¯æŒ
- **è¯­å¢ƒä¸€è‡´**ï¼šAI å›å¤ä¸ UI è¯­è¨€ç›¸åŒ¹é…

## é«˜çº§ UI ç»„ä»¶

### å¸¦è§†è§‰æŒ‡ç¤ºçš„å¤©æ°”æ•°æ®è¡¨

å¤©æ°”è¡¨ç»“åˆäº†æ•°æ®ä¸è§†è§‰å…ƒç´ ï¼Œæ–¹ä¾¿ç”¨æˆ·å¿«é€Ÿç†è§£ï¼š

```{python}
def create_weather_table(weather_df, language="en"):
    """åˆ›å»ºå¢å¼ºçš„å¤©æ°”è¡¨ï¼ŒåŒ…å«å›¾æ ‡å’Œé¢œè‰²æ˜¾ç¤º"""

    # å¤©æ°”ä»£ç åˆ° Emoji çš„æ˜ å°„
    WEATHER_ICONS = {
        0: "â˜€ï¸",   # æ™´
        1: "â›…",   # æ™´é—´å¤šäº‘
        2: "â˜ï¸",   # å¤šäº‘
        3: "â˜ï¸",   # é˜´
        45: "ğŸŒ«ï¸",  # é›¾
        48: "ğŸŒ¦ï¸",  # é˜µé›¨
        51: "ğŸŒ§ï¸",  # é›¨
        53: "â„ï¸",  # é›ª
        95: "â›ˆï¸",  # é›·é˜µé›¨
    }

    def format_weather_row(row):
        """æ ¼å¼åŒ–å•è¡Œå¤©æ°”æƒ…å†µå¹¶æ·»åŠ æ ·å¼"""
        date_str = row['date'].strftime('%Y-%m-%d')
        temp_range = f"{row['temperature_min']:.1f}Â° ~ {row['temperature_max']:.1f}Â°"
        weather_icon = WEATHER_ICONS.get(row['weather_code'], "ğŸŒ¡ï¸")

        # ç©ºæ°”è´¨é‡å¾½ç« 
        aq_info = get_air_quality_level(row['pm2_5'])
        aq_badge = f'<span style="background-color: {aq_info["color"]}; color: {aq_info["text_color"]}; padding: 2px 6px; border-radius: 3px; font-size: 0.8em;">{aq_info["icon"]} {row["pm2_5"]:.0f}</span>'

        # é™é›¨æ¦‚ç‡æŒ‡ç¤º
        rain_color = 'red' if row['rain_probability'] >= 80 else 'orange' if row['rain_probability'] >= 50 else 'gray'
        rain_indicator = f'<span style="color: {rain_color};">ğŸ”´ {row["rain_probability"]:.0f}%</span>' if row['rain_probability'] >= 50 else f'<span style="color: {rain_color};">ğŸŸ¢ {row["rain_probability"]:.0f}%</span>'

        # â€œä»Šæ—¥â€è¡Œé«˜äº®æ˜¾ç¤º
        row_style = 'font-size: 1.2em; font-weight: bold;' if row['is_today'] else ''

        return {
            'æ—¥æœŸ': f'<span style="{row_style}">{date_str}</span>',
            'å¤©æ°”': f'<span style="{row_style}">{weather_icon}</span>',
            'æ¸©åº¦': f'<span style="{row_style}">{temp_range}</span>',
            'é£é€Ÿ': f'<span style="{row_style}">ğŸ’¨ {row["wind_speed_max"]:.1f} km/h</span>',
            'é™é›¨': rain_indicator,
            'ç©ºæ°”è´¨é‡': aq_badge
        }

    # å¯¹æ‰€æœ‰è¡Œåº”ç”¨æ ¼å¼åŒ–
    formatted_rows = [format_weather_row(row) for _, row in weather_df.iterrows()]

    return pd.DataFrame(formatted_rows)

# åœ¨ Streamlit ä¸­æ˜¾ç¤º
st.markdown("### ğŸ“Š å¤©æ°”è¯¦æƒ…")
st.dataframe(
    create_weather_table(weather_df, language),
    width=1200,
    hide_index=True,
    unsafe_allow_html=True
)
```

**è¡¨æ ¼ç‰¹æ€§ï¼š**
- **å¤©æ°”å›¾æ ‡**ï¼šEmoji è¡¨è¾¾æ–¹å¼ï¼Œç›´è§‚æ˜“æ‡‚
- **ä»Šæ—¥é«˜äº®**ï¼šå¯¹å½“å¤©æ—¥æœŸä½¿ç”¨æ›´å¤§ã€åŠ ç²—çš„æ–‡å­—
- **ç©ºæ°”è´¨é‡å¾½ç« **ï¼šé¢œè‰²ç¼–ç çš„ PM2.5 æŒ‡æ ‡
- **é™é›¨æ¦‚ç‡**ï¼šåŸºäº Material Design è‰²ç³»çš„è§†è§‰æŒ‡ç¤º
- **å“åº”å¼å¸ƒå±€**ï¼šé€‚åº”å„ç§å±å¹•å®½åº¦

## éƒ¨ç½²ä¸ç”Ÿäº§

### ç¯å¢ƒé…ç½®

åœ¨ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ—¶ï¼Œè¯·é…ç½®ç¯å¢ƒå˜é‡ï¼š

```bash
# .env æ–‡ä»¶
modelscope=æ‚¨çš„ API å¯†é’¥

# å…¶ä»–ç”Ÿäº§ç¯å¢ƒè®¾ç½®
# è€ƒè™‘é¢‘ç‡é™åˆ¶ã€ç¼“å­˜æœºåˆ¶å’Œç›‘æ§
```

### éƒ¨ç½²åˆ° Streamlit Cloud

```bash
# 1. å®‰è£… Streamlit CLI
pip install streamlit

# 2. ç™»å½• Streamlit
streamlit login

# 3. éƒ¨ç½²åˆ° Streamlit Cloud
streamlit run app.py  # é¦–å…ˆåœ¨æœ¬åœ°æµ‹è¯•
# ç„¶åé€šè¿‡ cloud.streamlit.io æˆ– CLI è¿›è¡Œéƒ¨ç½²
```

### Docker éƒ¨ç½² (å¯é€‰)

```dockerfile
FROM python:3.9-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install -r requirements.txt

COPY . .

EXPOSE 8501

CMD ["streamlit", "run", "app.py", "--server.address", "0.0.0.0"]
```

## æ€§èƒ½ä¼˜åŒ–

### ç¼“å­˜ç­–ç•¥

```python
@st.cache_data(ttl=3600)  # ç¼“å­˜ 1 å°æ—¶
def get_weather_data_cached(lat, lon):
    """ç¼“å­˜å¤©æ°”æ•°æ®è·å–æ“ä½œ"""
    return get_weather_data(lat, lon)

@st.cache_resource
def get_ai_client():
    """ç¼“å­˜ AI å®¢æˆ·ç«¯åˆå§‹åŒ–"""
    return init_ai_client()

# ç¼“å­˜åœ°å›¾ç”Ÿæˆ
@st.cache_data(ttl=3600)
def create_map_cached(lat, lon):
    """ç¼“å­˜åœ°å›¾åˆ›å»ºæ“ä½œ"""
    return create_interactive_map(lat, lon)
```

### é”™è¯¯å¤„ç†ä¸å®¹é”™

```{python}
def robust_api_call(func, *args, max_retries=3, **kwargs):
    """å¸¦é‡è¯•é€»è¾‘çš„é«˜å¯ç”¨ API è°ƒç”¨"""
    for attempt in range(max_retries):
        try:
            return func(*args, **kwargs)
        except requests.exceptions.Timeout:
            if attempt == max_retries - 1:
                st.error("å¤©æ°”æœåŠ¡æš‚æ—¶ä¸å¯ç”¨")
                return None
            time.sleep(2 ** attempt)  # æŒ‡æ•°é€€é¿é‡è¯•
        except requests.exceptions.RequestException as e:
            st.error(f"API é”™è¯¯: {e}")
            return None
```


- **æ•°æ®å¯è§†åŒ–**ï¼šä¸“ä¸šå›¾è¡¨ä¸äº¤äº’å¼åœ°å›¾ã€‚
- **AI é›†æˆ**ï¼šå°†è¯­è¨€æ¨¡å‹å®é™…åº”ç”¨äºæ•°æ®åˆ†æã€‚
- **å›½é™…åŒ–**ï¼šå®Œæ•´çš„åŒè¯­æ”¯æŒã€‚
- **ç”Ÿäº§å°±ç»ª**ï¼šåŒ…å«é”™è¯¯å¤„ç†ã€ç¼“å­˜å’Œæ€§èƒ½ä¼˜åŒ–ã€‚

æ— è®ºæ‚¨æ˜¯åœ¨æ„å»ºå¤©æ°”åº”ç”¨ã€æ•°æ®çœ‹æ¿è¿˜æ˜¯ AI é©±åŠ¨çš„å·¥å…·ï¼Œè¯¥é¡¹ç›®éƒ½ä¸ºåˆ›å»ºå¤æ‚ä¸”ç”¨æˆ·å‹å¥½çš„åº”ç”¨ç¨‹åºæä¾›äº†åšå®çš„åŸºç¡€ã€‚
