---
title: "OpenRouterï¼šå¤š AI æ¨¡å‹çš„ç»Ÿä¸€ API"
author: "Tony D"
date: "2025-11-01"
categories: [AI, API, tutorial]
image: "images.png"

format:
  html:
    code-fold: true
    code-tools: true
    code-copy: true

execute:
  eval: false
  warning: false
---


```{python}
#| include: false
# Install required packages
import subprocess
import sys

required_packages = ['openai', 'python-dotenv', 'pandas', 'IPython','panel']
for package in required_packages:
    try:
        __import__(package.replace('-', '_'))
        print(f"{package} already installed")
    except ImportError:
        print(f"Installing {package}...")
        subprocess.check_call([sys.executable, "-m", "pip", "install", package])
```



```{python}
#| include: false
import sys, platform
print(sys.executable)
```

# OpenRouter ç®€ä»‹

OpenRouter æ˜¯ä¸€ä¸ªå¼ºå¤§çš„å¹³å°ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªç»Ÿä¸€çš„ API æ¥å£ï¼Œç”¨äºè®¿é—®æ¥è‡ªä¸åŒæä¾›å•†çš„å¤šä¸ª AI æ¨¡å‹ã€‚å¼€å‘äººå‘˜æ— éœ€åˆ†åˆ«ä¸ºæ¯ä¸ª AI æœåŠ¡è¿›è¡Œé›†æˆï¼Œè€Œæ˜¯å¯ä»¥ä½¿ç”¨ OpenRouter çš„å•ä¸€ç«¯ç‚¹è®¿é—®æ¥è‡ª OpenAIã€Anthropicã€Google ç­‰å…¬å¸çš„æ¨¡å‹ã€‚

## OpenRouter å…¥é—¨

ä½¿ç”¨ OpenRouter éå¸¸ç®€å•ï¼Œåªéœ€å‡ ä¸ªæ­¥éª¤å³å¯å®Œæˆã€‚è¯¥å¹³å°æ—¨åœ¨æœ€å¤§é™åº¦åœ°å‡å°‘è®¾ç½®æ—¶é—´ï¼ŒåŒæ—¶ä¿æŒå®‰å…¨æœ€ä½³å®è·µã€‚

## 1. åˆ›å»ºæ‚¨çš„ OpenRouter è´¦æˆ·

é¦–å…ˆï¼Œè®¿é—® [openrouter.ai](https://openrouter.ai) å¹¶åˆ›å»ºä¸€ä¸ªè´¦æˆ·ã€‚æ³¨å†Œè¿‡ç¨‹éå¸¸ç®€å•ï¼š

1. **æ³¨å†Œ**ï¼šä½¿ç”¨æ‚¨çš„ç”µå­é‚®ç®±æˆ–ç¤¾äº¤ç™»å½•ï¼ˆGoogleã€GitHubï¼‰
2. **éªŒè¯é‚®ç®±**ï¼šé€šè¿‡éªŒè¯é“¾æ¥ç¡®è®¤æ‚¨çš„ç”µå­é‚®ç®±åœ°å€
3. **è®¿é—®ä»ªè¡¨æ¿**ï¼šå¯¼èˆªåˆ°ä»ªè¡¨æ¿ï¼Œæ‚¨å¯ä»¥åœ¨é‚£é‡Œæ‰¾åˆ°æ‚¨çš„ API å¯†é’¥

**ğŸ’¡ ä¸“å®¶æç¤º**ï¼šæ‚¨çš„ä»ªè¡¨æ¿æä¾›äº†å®è´µçš„æ´å¯Ÿï¼ŒåŒ…æ‹¬ï¼š
- ä½¿ç”¨ç»Ÿè®¡å’Œæˆæœ¬è¿½è¸ª
- æ¨¡å‹æ€§èƒ½æŒ‡æ ‡
- API å¯†é’¥ç®¡ç†
- è´¦å•ä¿¡æ¯

## 2. å®‰å…¨çš„ API å¯†é’¥ç®¡ç†

åœ¨ä½¿ç”¨ AI API æ—¶ï¼Œå®‰å…¨è‡³å…³é‡è¦ã€‚åˆ‡å‹¿ç›´æ¥åœ¨ä»£ç ä¸­ç¡¬ç¼–ç  API å¯†é’¥ã€‚ç›¸åï¼Œä½¿ç”¨ç¯å¢ƒå˜æ¥ç¡®ä¿æ‚¨çš„å‡­æ®å®‰å…¨ï¼š

### ä¸ºä»€ä¹ˆç¯å¢ƒå˜é‡å¾ˆé‡è¦
- **å®‰å…¨æ€§**ï¼šé˜²æ­¢åœ¨ç‰ˆæœ¬æ§åˆ¶ä¸­æ„å¤–æ³„éœ²
- **çµæ´»æ€§**ï¼šå…è®¸ä¸ºå¼€å‘ã€æµ‹è¯•å’Œç”Ÿäº§ç¯å¢ƒä½¿ç”¨ä¸åŒçš„å¯†é’¥
- **åä½œ**ï¼šå›¢é˜Ÿæˆå‘˜å¯ä»¥åœ¨ä¸å…±äº«çš„æƒ…å†µä¸‹ä½¿ç”¨è‡ªå·±çš„å¯†é’¥
- **éƒ¨ç½²**ï¼šæ˜“äºåœ¨ä¸åŒçš„æ‰˜ç®¡ç¯å¢ƒä¸­è¿›è¡Œç®¡ç†

### è®¾ç½®ç¯å¢ƒå˜é‡

åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª `.env` æ–‡ä»¶ï¼š

OPENROUTER_API_KEY=your_actual_api_key_here



å®‰è£… `python-dotenv` åº“ä»¥åŠ è½½ç¯å¢ƒå˜é‡ï¼š

pip install python-dotenv


## 3. æ‚¨çš„ç¬¬ä¸€æ¬¡ API è°ƒç”¨

ç°åœ¨æ‚¨å·²ç»è®¾ç½®å¥½äº† API å¯†é’¥ï¼Œè®©æˆ‘ä»¬è¿›è¡Œç¬¬ä¸€æ¬¡ API è°ƒç”¨ã€‚OpenRouter å·§å¦™åœ°ä½¿ç”¨äº†ä¸ OpenAI ç›¸åŒçš„ API æ ¼å¼ï¼Œè¿™æ„å‘³ç€æ‚¨å¯ä»¥ä½¿ç”¨ç†Ÿæ‚‰çš„ `openai` Python åº“ â€”â€” åªæ˜¯ä½¿ç”¨ä¸åŒçš„åŸºç«¯ç‚¹ URLã€‚

### äº†è§£æ¶æ„

**ğŸ”§ å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„**ï¼šOpenRouter å……å½“æ™ºèƒ½ä»£ç†ï¼Œè´Ÿè´£ï¼š
1. æ¥æ”¶æ‚¨çš„æ ‡å‡†åŒ– API è¯·æ±‚
2. å°†å…¶è·¯ç”±åˆ°é€‚å½“çš„ AI æ¨¡å‹æä¾›å•†
3. å¤„ç†ç‰¹å®šäºæä¾›å•†çš„èº«ä»½éªŒè¯å’Œæ ¼å¼åŒ–
4. ä»¥ä¸€è‡´çš„æ ¼å¼è¿”å›å“åº”
5. è¿½è¸ªæ‰€æœ‰æ¨¡å‹çš„ä½¿ç”¨æƒ…å†µå’Œæˆæœ¬

### å¿…éœ€çš„ä¾èµ–é¡¹

åœ¨å¼€å§‹ä¹‹å‰ï¼Œè¯·ç¡®ä¿æ‚¨å·²å®‰è£…å¿…è¦çš„ Python åŒ…ï¼š

```bash
pip install openai python-dotenv
```

- **openai**: å®˜æ–¹çš„ OpenAI Python å®¢æˆ·ç«¯ï¼ˆä¸ OpenRouter å…¼å®¹ï¼‰
- **python-dotenv**: ç”¨äºä» `.env` æ–‡ä»¶åŠ è½½ç¯å¢ƒå˜é‡

### åŸºç¡€æ–‡æœ¬ç”Ÿæˆç¤ºä¾‹


::: {.panel-tabset}

## Python (ä½¿ç”¨ OpenAI åŒ…)

```{python}
#| eval: false
from openai import OpenAI
import os
from dotenv import load_dotenv

# ä» .env æ–‡ä»¶åŠ è½½ç¯å¢ƒå˜é‡
load_dotenv()

# ä½¿ç”¨ OpenRouter åˆå§‹åŒ– OpenAI å®¢æˆ·ç«¯
client = OpenAI(
  base_url="https://openrouter.ai/api/v1",  # OpenRouter çš„ API ç«¯ç‚¹
  api_key=os.getenv("OPENROUTER_API_KEY"),  # æ‚¨å®‰å…¨çš„ API å¯†é’¥
)

# ä½¿ç”¨ OpenRouter åˆ›å»ºå¯¹è¯è¡¥å…¨
completion = client.chat.completions.create(
  extra_headers={
    "HTTP-Referer": "https://your-site.com",  # å¯é€‰ï¼šå¸®åŠ© OpenRouter æ”¹è¿›æœåŠ¡
    "X-Title": "Your Site Name",             # å¯é€‰ï¼šç”¨äº OpenRouter æ’åçš„ç½‘ç«™åç§°
  },
  model="openai/gpt-oss-20b:free",          # ç”¨äºæµ‹è¯•/å¼€å‘çš„å…è´¹æ¨¡å‹
  messages=[
    {
      "role": "user",
      "content": "ä½ å¥½ï¼ä½ èƒ½ç”¨ç®€å•çš„æœ¯è¯­è§£é‡Šä¸€ä¸‹ä»€ä¹ˆæ˜¯ OpenRouter å—ï¼Ÿ"
    }
  ],
  temperature=0.7  # æ§åˆ¶åˆ›é€ åŠ› (0.0 = ç¡®å®šæ€§, 1.0 = éå¸¸æœ‰åˆ›æ„)
)

# æå–å¹¶æ‰“å°å“åº”
print(completion.choices[0].message.content)
```



## Python (ä½¿ç”¨ Chatlas åŒ…)

```{python}
#| eval: false
from chatlas import ChatOpenRouter
import os
from dotenv import load_dotenv

# ä» .env æ–‡ä»¶åŠ è½½ç¯å¢ƒå˜é‡
load_dotenv()

# ä½¿ç”¨ OpenRouter åˆå§‹åŒ– OpenAI å®¢æˆ·ç«¯
client = ChatOpenRouter(api_key=os.getenv("OPENROUTER_API_KEY")
,base_url='https://openrouter.ai/api/v1'
 ,system_prompt=None
 ,model="openai/gpt-oss-20b:free")
```

```{python}
response=client.chat("æ³•å›½çš„é¦–éƒ½æ˜¯å“ªé‡Œï¼Ÿ")
#str(response)
```


## R (ä½¿ç”¨ Ellmer åŒ…)

```{r}
library(ellmer)
library(dotenv)
load_dot_env(file = ".env")

chat <- chat_openrouter(
  system_prompt = NULL,
  api_key = Sys.getenv("OPENROUTER_API_KEY"),
 
  model = "openai/gpt-oss-20b:free",
  echo = "none"
)
```



```{r}
chat$chat("ç»™æˆ‘è®²ä¸‰ä¸ªå…³äºç»Ÿè®¡å­¦å®¶çš„ç¬‘è¯")
```


:::


**æ ¸å¿ƒç»„ä»¶è¯´æ˜ï¼š**

- **`base_url`**ï¼šæŒ‡å‘ OpenRouter çš„ API è€Œé OpenAI çš„
- **`model`**ï¼šä½¿ç”¨ OpenRouter çš„æ¨¡å‹å‘½åæ ¼å¼ (`æä¾›å•†/æ¨¡å‹åç§°`)
- **`extra_headers`**ï¼šå¯é€‰ï¼Œä½†å»ºè®®ç”¨äº OpenRouter çš„åˆ†æ
- **`temperature`**ï¼šæ§åˆ¶å“åº”çš„åˆ›é€ åŠ›ï¼ˆèŒƒå›´ 0.0-2.0ï¼‰
- **`messages`**ï¼šæ ‡å‡†çš„èŠå¤©æ ¼å¼ï¼Œé‡‡ç”¨åŸºäºè§’è‰²çš„å¯¹è¯ç»“æ„

**ğŸ’¡ æ¨¡å‹é€‰æ‹©å»ºè®®ï¼š**
- **å…è´¹æ¨¡å‹**ï¼šéå¸¸é€‚åˆå¼€å‘é˜¶æ®µï¼ˆä»¥ `*free` ç»“å°¾ï¼‰
- **ç»æµå‹æ¨¡å‹**ï¼šé€‚åˆç”Ÿäº§ç¯å¢ƒçš„æˆæœ¬æ•ˆç›Šæ¨¡å‹ï¼ˆä»¥ `*:budget` ç»“å°¾ï¼‰
- **é«˜çº§æ¨¡å‹**ï¼šæœ€ä½³æ€§èƒ½ï¼ˆ`*`ã€`*:pro`ã€`*:latest`ï¼‰
- **ä¸“ä¸šæ¨¡å‹**ï¼šé’ˆå¯¹ç‰¹å®šä»»åŠ¡ä¼˜åŒ–çš„æ¨¡å‹ï¼ˆç¼–ç¨‹ã€æ•°å­¦ã€åˆ›æ„å†™ä½œï¼‰

## 4. æŒæ¡ç³»ç»Ÿæç¤ºè¯ (System Prompts)

ç³»ç»Ÿæç¤ºè¯æ˜¯å¡‘é€  AI è¡Œä¸ºã€ä¸ªæ€§å’Œå›å¤é£æ ¼çš„å¼ºå¤§å·¥å…·ã€‚å®ƒä»¬è®¾ç½®äº†æ•´ä¸ªå¯¹è¯çš„ä¸Šä¸‹æ–‡å’Œè§„åˆ™ï¼Œåœ¨å¯¹è¯æµä¸­å‡ºç°åœ¨ç”¨æˆ·æ¶ˆæ¯ä¹‹å‰ã€‚

### ä»€ä¹ˆæ˜¯ç³»ç»Ÿæç¤ºè¯ï¼Ÿ

ç³»ç»Ÿæç¤ºè¯å……å½“**å…ƒæŒ‡ä»¤**ï¼ŒæŒ‡å¯¼ AI åœ¨æ•´ä¸ªå¯¹è¯ä¸­åº”å¦‚ä½•ååº”ã€‚å®ƒä»¬æœ€å…ˆè¢«å¤„ç†ï¼Œå¹¶å½±å“æ‰€æœ‰åç»­çš„äº¤äº’ã€‚

### ä¸ºä»€ä¹ˆç³»ç»Ÿæç¤ºè¯å¾ˆé‡è¦

- **ä¸€è‡´çš„è¡Œä¸º**ï¼šç¡®ä¿ AI åœ¨æ•´ä¸ªè¿‡ç¨‹ä¸­ä¿æŒæ‰€éœ€çš„ä¸ªæ€§
- **è¾“å‡ºæ ¼å¼**ï¼šè§„å®šå“åº”ç»“æ„ï¼ˆJSONã€Markdownã€ä»£ç å—ï¼‰
- **å®‰å…¨çº¦æŸ**ï¼šè®¾ç½®å›å¤çš„è¾¹ç•Œå’Œé™åˆ¶
- **ä¸Šä¸‹æ–‡è®¾ç½®**ï¼šæä¾›èƒŒæ™¯ä¿¡æ¯ä»¥è·å¾—æ›´å¥½çš„å›å¤
- **ä»»åŠ¡ä¸“é—¨åŒ–**ï¼šé’ˆå¯¹ç‰¹å®šç”¨ä¾‹ä¼˜åŒ– AI

### æœ‰æ•ˆçš„ç³»ç»Ÿæç¤ºè¯ç¤ºä¾‹

```{python}
#| eval: false
# å¸¦æœ‰ç³»ç»Ÿæç¤ºè¯çš„ç¤ºä¾‹
completion = client.chat.completions.create(
  model="openai/gpt-oss-20b:free",
  messages=[
    {
      "role": "system",
      "content": "ä½ æ˜¯ä¸€ä¸ªä¹äºåŠ©äººçš„ AI åŠ©æ‰‹ï¼Œå¯ä»¥ç”¨ç®€å•çš„æœ¯è¯­è§£é‡ŠæŠ€æœ¯æ¦‚å¿µã€‚å§‹ç»ˆä¿æŒå‹å¥½ï¼Œå¹¶å°½å¯èƒ½ä½¿ç”¨ç±»æ¯”ï¼Œä¿æŒç®€å•ã€‚"
    },
    {
      "role": "user",
      "content": "LLM æ¨¡å‹ä¸­çš„æ¸©åº¦ (temperature) æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ"
    }
  ],
  temperature=0.7
)

print(completion.choices[0].message.content)
```

å¸¸è§çš„ç³»ç»Ÿæç¤ºè¯æ¨¡å¼ï¼š

```{python}
#| eval: false
# ä¸åŒçš„ç³»ç»Ÿæç¤ºè¯ç¤ºä¾‹
system_prompts = {
    "coding_assistant": "ä½ æ˜¯ä¸€ä¸ªä¸“å®¶çº§ç¨‹åºå‘˜ã€‚æä¾›æ•´æ´ã€æ³¨é‡Šè‰¯å¥½çš„ä»£ç è§£å†³æ–¹æ¡ˆï¼Œå¹¶è§£é‡Šä½ çš„æ¨ç†ã€‚",
    "creative_writer": "ä½ æ˜¯ä¸€ä¸ªåˆ›æ„æ•…äº‹è®²è¿°è€…ã€‚ç¼–å†™å…·æœ‰ç”ŸåŠ¨æè¿°å’Œå¼•äººå…¥èƒœè§’è‰²çš„åŠ¨äººå™è¿°ã€‚",
    "data_analyst": "ä½ æ˜¯ä¸€ä¸ªæ•°æ®åˆ†æå¸ˆã€‚æ ¹æ®æ•°æ®æä¾›è§è§£ï¼Œå»ºè®®å¯è§†åŒ–æ–¹å¼ï¼Œå¹¶æ¸…æ™°åœ°è§£é‡Šç»Ÿè®¡æ¦‚å¿µã€‚",
    "tutor": "ä½ æ˜¯ä¸€ä¸ªè€å¿ƒçš„å¯¼å¸ˆã€‚å°†å¤æ‚çš„ä¸»é¢˜åˆ†è§£ä¸ºç®€å•çš„æ­¥éª¤å¹¶æä¾›é¼“åŠ±æ€§çš„åé¦ˆã€‚"
}

def chat_with_persona(persona, user_message):
    completion = client.chat.completions.create(
        model="openai/gpt-oss-20b:free",
        messages=[
            {"role": "system", "content": system_prompts[persona]},
            {"role": "user", "content": user_message}
        ],
        temperature=0.7
    )
    return completion.choices[0].message.content

# ç¤ºä¾‹ç”¨æ³•
#response = chat_with_persona("coding_assistant", "å¦‚ä½•ç”¨ Python åè½¬å­—ç¬¦ä¸²ï¼Ÿ")
#print(response)
```


## 5. æµå¼å“åº”ï¼šå®æ—¶ AI äº¤äº’

æµå¼ä¼ è¾“ (Streaming) æ˜¯æå‡ç”¨æˆ·ä½“éªŒçš„åˆ©å™¨ï¼Œç‰¹åˆ«æ˜¯åœ¨èŠå¤©åº”ç”¨å’Œäº¤äº’å¼å·¥å…·ä¸­ã€‚æµå¼ä¼ è¾“ä¸æ˜¯ç­‰å¾…å®Œæ•´çš„å“åº”ï¼Œè€Œæ˜¯åœ¨ç”Ÿæˆå†…å®¹æ—¶ç«‹å³äº¤ä»˜ï¼Œä»è€Œåˆ›é€ è‡ªç„¶ä¸”å¼•äººå…¥èƒœçš„å¯¹è¯ã€‚

### ä¸ºä»€ä¹ˆæµå¼ä¼ è¾“å¾ˆé‡è¦

**ğŸš€ ç”¨æˆ·ä½“éªŒä¼˜åŠ¿ï¼š**
- **ç«‹å³åé¦ˆ**ï¼šç”¨æˆ·èƒ½ç«‹å³çœ‹åˆ°å“åº”å¼€å§‹ç”Ÿæˆ
- **é™ä½æ„ŸçŸ¥å»¶è¿Ÿ**ï¼šå†…å®¹åœ¨ç”Ÿæˆæ—¶å³åˆ»æ˜¾ç¤º
- **è‡ªç„¶çš„å¯¹è¯æµ**ï¼šæ¨¡ä»¿äººç±»è¯´è¯çš„æ¨¡å¼
- **è¿›åº¦æŒ‡ç¤º**ï¼šç”¨æˆ·çŸ¥é“ AI æ­£åœ¨å·¥ä½œ
- **åŠæ—©ç»ˆæ­¢**ï¼šå¦‚æœéœ€è¦ï¼Œç”¨æˆ·å¯ä»¥åœæ­¢è¿‡é•¿çš„å›å¤

**âš¡ æŠ€æœ¯ä¼˜åŠ¿ï¼š**
- **æ›´ä½çš„å†…å­˜å ç”¨**ï¼šæ— éœ€ç¼“å†²å®Œæ•´å“åº”
- **æ›´å¿«çš„é¦–å­—èŠ‚æ—¶é—´**ï¼šå†…å®¹ç«‹å³å¼€å§‹æµåŠ¨
- **æ›´å¥½çš„é”™è¯¯å¤„ç†**ï¼šåœ¨è¿‡ç¨‹ä¸­æ›´æ—©å‘ç°é—®é¢˜
- **èµ„æºæ•ˆç‡**ï¼šå¢é‡å¤„ç†æ•°æ®

### åœ¨ OpenRouter ä¸­å®ç°æµå¼ä¼ è¾“

```{python}
#| eval: false
# åˆå§‹åŒ– OpenAI å®¢æˆ·ç«¯ï¼ˆå¦‚æœå°šæœªå®Œæˆï¼‰
from openai import OpenAI
import os
from dotenv import load_dotenv

load_dotenv()
client = OpenAI(
  base_url="https://openrouter.ai/api/v1",
  api_key=os.getenv("OPENROUTER_API_KEY"),
)

def stream_response(model, message):
    stream = client.chat.completions.create(
        model=model,
        messages=[{"role": "user", "content": message}],
        stream=True
    )

    for chunk in stream:
        if chunk.choices[0].delta.content is not None:
            print(chunk.choices[0].delta.content, end='', flush=True)

# æµå¼ä¼ è¾“ç¤ºä¾‹
print("æ­£åœ¨æµå¼ä¼ è¾“å“åº”ï¼š")
stream_response("openai/gpt-oss-20b:free", "è¯·ç»™æˆ‘è®²ä¸€ä¸ªå…³äº AI çš„çŸ­ç¯‡æ•…äº‹")
print()  # æµå¼ä¼ è¾“ç»“æŸåæ·»åŠ æ¢è¡Œ
```




### 6. æ–‡å­—è½¬å›¾åƒ (Text to Image)


```{python}
from openai import OpenAI
import base64
import datetime
```


```{python}
# | eval: false
from openai import OpenAI
import os
from dotenv import load_dotenv

# ä» .env æ–‡ä»¶åŠ è½½ç¯å¢ƒå˜é‡
load_dotenv()

# ä½¿ç”¨ OpenRouter åˆå§‹åŒ– OpenAI å®¢æˆ·ç«¯
client = OpenAI(
    base_url="https://openrouter.ai/api/v1",
    api_key=os.getenv("OPENROUTER_API_KEY"),
)
```


```{python}
#| eval: false
# å›¾åƒç”Ÿæˆè¯·æ±‚
response = client.chat.completions.create(
    extra_headers={
        "HTTP-Referer": "www.tonydotdev.com",
        "X-Title": "TT_AI_blog",
    },
    model="google/gemini-2.5-flash-image",
    messages=[
        {
            "role": "user",
            "content": "ç”Ÿæˆä¸€å¼ å®é™ä¸”å†™å®çš„æ—¥å‡ºé›ªå±±é£æ™¯å›¾ã€‚",
        }
    ],
    modalities=["image", "text"],
    #image_size="1024x1024",
)
```




```{python}
#| eval: false
import base64
import datetime
# æå–æ¶ˆæ¯
message = response.choices[0].message

# å¤„ç†å›¾åƒè¾“å‡ºï¼ˆbase64 å­—ç¬¦ä¸²ä½äº "data:image/png;base64,..." ä¸­ï¼‰
if message.images:
    data_url = message.images[0]["image_url"]["url"]

    # å¦‚æœå­˜åœ¨å‰ç¼€åˆ™å°†å…¶å‰¥ç¦»
    if data_url.startswith("data:image"):
        _, base64_data = data_url.split(",", 1)
    else:
        base64_data = data_url

    # è§£ç å¹¶ä¿å­˜ä¸º PNG
    image_bytes = base64.b64decode(base64_data)
    current_time = datetime.datetime.now().strftime("%H%M")
    output_file = f"text_image_gemini_25_openrouter_{current_time}.png"
    with open(output_file, "wb") as f:
        f.write(image_bytes)

    print(f"âœ… å›¾åƒå·²ä¿å­˜ä¸º {output_file}")
else:
    print("âŒ å“åº”ä¸­æœªè¿”å›å›¾åƒ")
```

```{python}
#| eval: true
#| include: false
# ç¡®ä¿ IPython å¯ç”¨
try:
    from IPython.display import Image, display
    print("IPython åŠ è½½æˆåŠŸ")
except ImportError as e:
    print(f"IPython å¯¼å…¥é”™è¯¯: {e}")
    import subprocess
    import sys
    subprocess.check_call([sys.executable, "-m", "pip", "install", "IPython"])
    from IPython.display import Image, display
```

```{python}
#| eval: true
from IPython.display import Image, display

display(Image(filename="text_image_gemini_25_openrouter_1352.png"))
```


### 7. å›¾åƒè½¬æ–‡å­— (Image to Text)

```{python}
#| eval: false
import base64

# å°†æœ¬åœ°å›¾åƒè½¬æ¢ä¸º data URL
with open("text_image_gemini_25_openrouter_1352.png", "rb") as image_file:
    base64_image = base64.b64encode(image_file.read()).decode('utf-8')
    data_url = f"data:image/png;base64,{base64_image}"

completion = client.chat.completions.create(
  extra_headers={
    "HTTP-Referer": "<æ‚¨çš„ç½‘ç«™URL>", # å¯é€‰ï¼šOpenRouter æ’åç”¨çš„ç½‘ç«™ URL
    "X-Title": "<æ‚¨çš„ç½‘ç«™åç§°>", # å¯é€‰ï¼šOpenRouter æ’åç”¨çš„ç½‘ç«™åç§°
  },
  extra_body={},
  model="nvidia/nemotron-nano-12b-v2-vl:free",
  messages=[
              {
                "role": "user",
                "content": [
                  {
                    "type": "text",
                    "text": "è¿™å¼ å›¾ç‰‡é‡Œæœ‰ä»€ä¹ˆï¼Ÿ"
                  },
                  {
                    "type": "image_url",
                    "image_url": {
                      "url": data_url
                    }
                  }
                ]
              }
            ]
)
print(completion.choices[0].message.content)
```



### 8. æ–‡å­—ä¸å›¾åƒç»“åˆç”Ÿæˆå›¾åƒ (Text & Image to Image)

```{python}
# | eval: false
import base64

# å°†ä¹‹å‰ç”Ÿæˆçš„å›¾åƒè½¬æ¢ä¸º base64
with open("text_image_gemini_25_openrouter_1352.png", "rb") as image_file:
    base64_image = base64.b64encode(image_file.read()).decode("utf-8")

response = client.chat.completions.create(
    extra_headers={
        "HTTP-Referer": "www.tonydotdev.com",
        "X-Title": "TT_AI_blog",
    },
    model="google/gemini-2.5-flash-image",
    messages=[
        {
            "role": "user",
            "content": [
                {
                    "type": "text",
                    "text": "å°†è¿™å¼ å›¾ç‰‡è½¬æ¢ä¸ºæ—¥è½ç‰ˆæœ¬ï¼Œä½¿ç”¨æ›´æ¸©æš–çš„è‰²å½©å’Œé‡‘è‰²çš„å…‰çº¿ã€‚åœ¨å‰æ™¯ä¸­å¢åŠ ä¸€ä¸ªæ­£åœ¨æ»‘é›ªçš„äººã€‚",
                },
                {
                    "type": "image_url",
                    "image_url": {"url": f"data:image/png;base64,{base64_image}"},
                },
            ],
        }
    ],
    modalities=["image", "text"],
    # image_size="1024x1024",
)
```


```{python}
#| eval: false
import base64
import datetime
# æå–æ¶ˆæ¯
message = response.choices[0].message

# å¤„ç†å›¾åƒè¾“å‡ºï¼ˆbase64 å­—ç¬¦ä¸²ä½äº "data:image/png;base64,..." ä¸­ï¼‰
if message.images:
    data_url = message.images[0]["image_url"]["url"]

    # å¦‚æœå­˜åœ¨å‰ç¼€åˆ™å°†å…¶å‰¥ç¦»
    if data_url.startswith("data:image"):
        _, base64_data = data_url.split(",", 1)
    else:
        base64_data = data_url

    # è§£ç å¹¶ä¿å­˜ä¸º PNG
    image_bytes = base64.b64decode(base64_data)
    current_time = datetime.datetime.now().strftime("%H%M")
    output_file = f"text_image_gemini_25_openrouter_{current_time}.png"
    with open(output_file, "wb") as f:
        f.write(image_bytes)

    print(f"âœ… å›¾åƒå·²ä¿å­˜ä¸º {output_file}")
else:
    print("âŒ å“åº”ä¸­æœªè¿”å›å›¾åƒ")
```


```{python}
from IPython.display import Image, display

display(Image(filename="text_image_gemini_25_openrouter_1405.png"))
```

### 8 Embedding

```{python}
from openai import OpenAI
## 8. æ–‡æœ¬åµŒå…¥ (Embedding)

```{python}
#| eval: false
from openai import OpenAI
import os
from dotenv import load_dotenv

# ä» .env æ–‡ä»¶åŠ è½½ç¯å¢ƒå˜é‡
load_dotenv()

# ä½¿ç”¨ OpenRouter åˆå§‹åŒ– OpenAI å®¢æˆ·ç«¯
client = OpenAI(
    base_url="https://openrouter.ai/api/v1",
    api_key=os.getenv("OPENROUTER_API_KEY"),
)


embedding = client.embeddings.create(
  extra_headers={
    "HTTP-Referer": "<YOUR_SITE_URL>", # å¯é€‰ï¼šOpenRouter æ’åç”¨çš„ç½‘ç«™ URL
    "X-Title": "<YOUR_SITE_NAME>", # å¯é€‰ï¼šOpenRouter æ’åç”¨çš„ç½‘ç«™åç§°
  },
  model="thenlper/gte-base",
  input="I can",
  encoding_format="float"
)

#print(embedding.data[0].embedding) 
```


```{python}
len(embedding.data[0].embedding)
```


```{python}
print(embedding.data[0].embedding[:5])  # æ‰“å°å‰ 5 ä¸ªç»´åº¦
```



## æˆæœ¬ç®¡ç†ï¼šä¼˜åŒ–æ‚¨çš„ AI æ”¯å‡º

OpenRouter æœ€å¼ºå¤§çš„åŠŸèƒ½ä¹‹ä¸€æ˜¯å…¶é€æ˜çš„å®šä»·æ¨¡å‹å’Œæˆæœ¬ç®¡ç†èƒ½åŠ›ã€‚å¯¹äºç”Ÿäº§çº§ AI åº”ç”¨æ¥è¯´ï¼Œç†è§£å’Œç®¡ç†æˆæœ¬è‡³å…³é‡è¦ã€‚

## ä¸ºä»€ä¹ˆæˆæœ¬ç®¡ç†å¾ˆé‡è¦

**ğŸ’° è´¢åŠ¡è§„åˆ’ï¼š**
- å¯é¢„æµ‹çš„æ¯æœˆæ”¯å‡º
- ä¸ºä¸åŒç”¨ä¾‹åˆ†é…é¢„ç®—
- AI åŠŸèƒ½çš„ ROI åˆ†æ
- æ¯ä¸ªç”¨æˆ·çš„æˆæœ¬è¿½è¸ª

**ğŸ” æŠ€æœ¯ä¼˜åŒ–ï¼š**
- æ ¹æ®æˆæœ¬/æ€§èƒ½æ¯”é€‰æ‹©æ¨¡å‹
- æç¤ºè¯å·¥ç¨‹ä»¥å‡å°‘ Token ä½¿ç”¨
- é‡å¤è¯·æ±‚çš„ç¼“å­˜ç­–ç•¥
- æé«˜æ•ˆç‡çš„æ‰¹é‡å¤„ç†

## å®æ—¶æˆæœ¬è¿½è¸ª

OpenRouter æä¾›äº†é€šè¿‡ç¼–ç¨‹æ–¹å¼è®¿é—®æ‰€æœ‰æ¨¡å‹å½“å‰å®šä»·çš„æ¥å£ï¼š

```{python}
#| eval: true
#| include: false
# å®‰è£…æ‰€éœ€åŒ…
import subprocess
import sys

required_packages = ['openai', 'python-dotenv', 'pandas', 'IPython','panel']
for package in required_packages:
    try:
        __import__(package.replace('-', '_'))
        print(f"{package} å·²å®‰è£…")
    except ImportError:
        print(f"æ­£åœ¨å®‰è£… {package}...")
        subprocess.check_call([sys.executable, "-m", "pip", "install", package])
```

```{python}
#| eval: true
# åˆå§‹åŒ– OpenAI å®¢æˆ·ç«¯ï¼ˆå¦‚æœå°šæœªå®Œæˆï¼‰
from openai import OpenAI
import os
from dotenv import load_dotenv
import pandas as pd

load_dotenv()
client = OpenAI(
  base_url="https://openrouter.ai/api/v1",
  api_key=os.getenv("OPENROUTER_API_KEY"),
)

def get_model_pricing():
    models_list = client.models.list()
    pricing_data = []

    for model in models_list.data:
        name = model.id
        pricing = model.pricing

        # è·å–æ¨¡å‹å…ƒæ•°æ®
        context_length = getattr(model, 'context_length', None)
        description = getattr(model, 'description', '')

        # è·å–åˆ›å»ºæ—¥æœŸå¹¶è½¬æ¢ä¸ºå¯è¯»æ ¼å¼
        created_timestamp = getattr(model, 'created', None)
        if created_timestamp:
            import datetime
            created_date = datetime.datetime.fromtimestamp(created_timestamp).strftime('%Y-%m-%d')
        else:
            created_date = None

        # ä»æ¨¡å‹åç§°ä¸­æå–å…¬å¸ï¼ˆ'/' å‰çš„ç¬¬ä¸€éƒ¨åˆ†ï¼‰
        company = name.split('/')[0] if '/' in name else 'Unknown'

        # å°†æ¯ä¸ª Token çš„ä»·æ ¼è½¬æ¢ä¸ºæ¯ 100 ä¸‡ä¸ª Token çš„æˆæœ¬
        prompt_cost = float(pricing.get('prompt', 0)) * 1000000 if pricing and pricing.get('prompt') else 0
        completion_cost = float(pricing.get('completion', 0)) * 1000000 if pricing and pricing.get('completion') else 0
        request_cost = float(pricing.get('request', 0)) * 1000000 if pricing and pricing.get('request') else 0
        image_cost = float(pricing.get('image', 0)) * 1000000 if pricing and pricing.get('image') else 0

        pricing_data.append({
            'æ¨¡å‹': name,
            'å…¬å¸': company,
            'æè¿°': description,
            'ä¸Šä¸‹æ–‡é•¿åº¦': context_length,
            'åˆ›å»ºæ—¥æœŸ': created_date,
            'æç¤ºè¯æˆæœ¬_æ¯1M': prompt_cost,
            'è¡¥å…¨æˆæœ¬_æ¯1M': completion_cost,
            'è¯·æ±‚æˆæœ¬_æ¯1M': request_cost,
            'å›¾åƒæˆæœ¬_æ¯1M': image_cost
        })

    # åˆ›å»º Pandas DataFrame
    df = pd.DataFrame(pricing_data)

    # æŒ‰å…¬å¸ã€æ¨¡å‹åç§°æ’åºï¼Œæ–¹ä¾¿æ•´ç†
    df = df.sort_values(['å…¬å¸', 'æ¨¡å‹']).reset_index(drop=True)

    return df

# è·å–ä»·æ ¼ DataFrameï¼ˆå…¨é‡æ¨¡å‹ä»¥åŠä»…ä»˜è´¹æ¨¡å‹ï¼‰
all_models_df = get_model_pricing()
```




#### æœ€æ˜‚è´µçš„æ¨¡å‹

```{python}
#| eval: true
import panel as pn


df = all_models_df[
    [
        "æ¨¡å‹",
        "ä¸Šä¸‹æ–‡é•¿åº¦",
        "åˆ›å»ºæ—¥æœŸ",
        "æç¤ºè¯æˆæœ¬_æ¯1M",
        "è¡¥å…¨æˆæœ¬_æ¯1M",
    ]
].sort_values("æç¤ºè¯æˆæœ¬_æ¯1M", ascending=False)

# åˆ›å»ºä¸€ä¸ªå¸¦åˆ†é¡µçš„è¡¨æ ¼
pn.extension("tabulator")
table = pn.widgets.Tabulator(df, pagination="local", page_size=10, show_index=False)
table
```


## æœ€ä½³å®è·µï¼šç”Ÿäº§å°±ç»ªçš„ AI å¼€å‘

éµå¾ªè¿™äº›æœ€ä½³å®è·µå°†å¸®åŠ©æ‚¨ä½¿ç”¨ OpenRouter æ„å»ºç¨³å¥ã€å®‰å…¨ä¸”é«˜æ•ˆçš„ AI åº”ç”¨ç¨‹åºã€‚

## ğŸ”’ å®‰å…¨æœ€ä½³å®è·µ

### 1. API å¯†é’¥ç®¡ç†
- **åˆ‡å‹¿ç¡¬ç¼–ç  API å¯†é’¥**åœ¨æºä»£ç æˆ–é…ç½®æ–‡ä»¶ä¸­
- **ä½¿ç”¨ç¯å¢ƒå˜é‡**æˆ–ç§˜å¯†ç®¡ç†ç³»ç»Ÿï¼ˆå¦‚ AWS Secrets Managerã€Azure Key Vaultï¼‰
- **å®šæœŸè½®æ¢ API å¯†é’¥**å¹¶å®æ–½å¯†é’¥è½®æ¢ç­–ç•¥
- **ä½¿ç”¨ä¸åŒçš„å¯†é’¥**ç”¨äºå¼€å‘ã€æµ‹è¯•å’Œç”Ÿäº§ç¯å¢ƒ
- **å°† .env æ·»åŠ åˆ° .gitignore** â€”â€” æ°¸è¿œä¸è¦å°†å‡­æ®æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶ä¸­

### 2. è¾“å…¥éªŒè¯ä¸æ¸…ç†
- **åœ¨å‘é€åˆ° AI æ¨¡å‹ä¹‹å‰éªŒè¯ç”¨æˆ·è¾“å…¥**
- **æ¸…ç†æç¤ºè¯**ä»¥é˜²æ­¢æç¤ºè¯æ³¨å…¥æ”»å‡»
- **å®æ–½é€Ÿç‡é™åˆ¶**ä»¥é˜²æ­¢æ»¥ç”¨
- **è®°å½•å¹¶ç›‘æ§**å¼‚å¸¸æ´»åŠ¨æ¨¡å¼

## âš¡ æ€§èƒ½æœ€ä½³å®è·µ

### 3. æ¨¡å‹é€‰æ‹©ç­–ç•¥
- **ä¸ºæ‚¨çš„ç”¨ä¾‹é€‰æ‹©åˆé€‚çš„æ¨¡å‹** â€”â€” å¹¶éæ‰€æœ‰ä»»åŠ¡éƒ½éœ€è¦æœ€æ˜‚è´µçš„æ¨¡å‹
- **é’ˆå¯¹æ‚¨çš„ç‰¹å®šç”¨ä¾‹è¿›è¡Œæ¨¡å‹åŸºå‡†æµ‹è¯•**
- **ä½¿ç”¨å…è´¹æ¨¡å‹**è¿›è¡Œå¼€å‘å’Œæµ‹è¯•
- **è€ƒè™‘ä¸“ç”¨æ¨¡å‹**å¤„ç†ç‰¹å®šä»»åŠ¡ï¼ˆç¼–ç¨‹ã€æ•°å­¦ã€åˆ›æ„å†™ä½œï¼‰

### 4. ä¼˜åŒ–æŠ€æœ¯
- **å®æ–½ç¼“å­˜**ä»¥å‡å°‘é‡å¤è¯·æ±‚çš„æˆæœ¬
- **ä½¿ç”¨æµå¼ä¼ è¾“**ä»¥è·å¾—æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ
- **åœ¨é€‚å½“æƒ…å†µä¸‹è¿›è¡Œæ‰¹é‡è¯·æ±‚**ä»¥æé«˜æ•ˆç‡
- **ä¼˜åŒ–æç¤ºè¯** â€”â€” ç²¾å¿ƒè®¾è®¡çš„æç¤ºè¯å¯ä»¥å‡å°‘ Token ä½¿ç”¨å¹¶æ”¹å–„ç»“æœ

## ğŸ›¡ï¸ å¯é æ€§æœ€ä½³å®è·µ

### 5. é”™è¯¯å¤„ç†ä¸å®¹é”™
- **å®æ–½å…¨é¢çš„é”™è¯¯å¤„ç†** â€”â€” æ¨¡å‹å¯èƒ½ä¼šä¸å¯ç”¨æˆ–å—åˆ°é€Ÿç‡é™åˆ¶
- **ä½¿ç”¨å¤‡ç”¨æ¨¡å‹** â€”â€” ç¡®ä¿å³ä½¿ä¸€ä¸ªæ¨¡å‹å®•æœºï¼Œæ‚¨çš„åº”ç”¨ç¨‹åºä»èƒ½æ­£å¸¸è¿è¡Œ
- **å®æ–½å¸¦æœ‰æŒ‡æ•°é€€é¿çš„é‡è¯•é€»è¾‘**
- **ç›‘æ§å“åº”æ—¶é—´**å¹¶è®¾ç½®é€‚å½“çš„è¶…æ—¶

### 6. ç›‘æ§ä¸åˆ†æ
- **ç›‘æ§ä½¿ç”¨æƒ…å†µ** â€”â€” è¿½è¸ªæˆæœ¬å¹¶è®¾ç½®é™åˆ¶
- **è¿½è¸ªæ€§èƒ½æŒ‡æ ‡**ï¼ˆå»¶è¿Ÿã€æˆåŠŸç‡ã€é”™è¯¯ç‡ï¼‰
- **ä¸ºå¼‚å¸¸æ´»åŠ¨æ¨¡å¼è®¾ç½®å‘Šè­¦**
- **åˆ›å»ºå®æ—¶ç›‘æ§ä»ªè¡¨æ¿**

## ğŸ“Š æˆæœ¬ç®¡ç†æœ€ä½³å®è·µ

### 7. é¢„ç®—æ§åˆ¶
- **åœ¨ OpenRouter ä»ªè¡¨æ¿ä¸­è®¾ç½®æ”¯å‡ºé™åˆ¶**å’Œå‘Šè­¦
- **ä¸ºéå…³é”®ä»»åŠ¡ä½¿ç”¨é«˜æ€§ä»·æ¯”æ¨¡å‹**
- **å®æ–½ Token è®¡æ•°**ä»¥åœ¨è¯·æ±‚å‰ä¼°ç®—æˆæœ¬
- **å®šæœŸæŸ¥çœ‹ä½¿ç”¨æŠ¥å‘Š**ä»¥è¯†åˆ«ä¼˜åŒ–æœºä¼š

## ç»“è®ºï¼šæ„å»º AI åº”ç”¨çš„æœªæ¥

OpenRouter ä»£è¡¨äº†å¼€å‘äººå‘˜ä¸ AI æ¨¡å‹äº¤äº’æ–¹å¼çš„èŒƒå¼è½¬å˜ã€‚é€šè¿‡æä¾›è®¿é—®ä¸–ç•Œä¸Šæœ€å…ˆè¿› AI æ¨¡å‹çš„ç»Ÿä¸€ã€å¯é ä¸”æå…·æˆæœ¬æ•ˆç›Šçš„ç½‘å…³ï¼ŒOpenRouter è®©å¼€å‘äººå‘˜èƒ½å¤Ÿä¸“æ³¨äºåˆ›é€ ä»·å€¼ï¼Œè€Œä¸æ˜¯å¤„ç†å¤æ‚çš„åŸºç¡€è®¾æ–½ã€‚







