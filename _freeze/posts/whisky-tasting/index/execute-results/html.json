{
  "hash": "8b364d62cf9686ffe82e1deb9d8d9e5a",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: \"åŸºäº RAG çš„å¨å£«å¿Œå“é‰´ç¬”è®°\"\nauthor: \"Tony D\"\ndate: \"2025-11-05\"\ncategories: [AI, API, tutorial]\nimage: \"images/0.png\"\n\nformat:\n  html:\n    code-fold: true\n    code-tools: true\n    code-copy: true\n\nexecute:\n  eval: false\n  warning: false\n\n  \n  \n---\n\n\n# é¡¹ç›®æ¦‚è§ˆ\n\nå¨å£«å¿Œå“é‰´åº”ç”¨æ˜¯ä¸€æ¬¾å…ˆè¿›çš„ AI é©±åŠ¨ Web åº”ç”¨ç¨‹åºï¼Œå¯ç”Ÿæˆè¯¦ç»†ã€ä¸“ä¸šçš„å¨å£«å¿Œå“é‰´ç¬”è®°å’Œå»ºè®®ã€‚è¯¥ç³»ç»Ÿçš„ç‰¹åˆ«ä¹‹å¤„åœ¨äºå…¶é‡‡ç”¨äº†å¤š Agent æ¶æ„ï¼Œå¹¶é…å¤‡äº†ä¸“é—¨çš„ AI äººæ ¼ï¼Œæ¯ä¸ªäººæ ¼éƒ½ç»è¿‡äº†ä¸åŒå¨å£«å¿Œè¯„è®ºæºå’Œè¯­è¨€é£æ ¼çš„è®­ç»ƒã€‚\n\nåœ¨çº¿æ¼”ç¤º (Modelscope): [https://modelscope.cn/studios/ttflying/whisky_AI_tasting](https://modelscope.cn/studios/ttflying/whisky_AI_tasting)\n\nåœ¨çº¿æ¼”ç¤º (Shinyapp): [https://jcflyingco.shinyapps.io/ai-whisky-tasting/](https://jcflyingco.shinyapps.io/ai-whisky-tasting)\n\nGithub: [https://github.com/JCwinning/whisky_tasting](https://github.com/JCwinning/whisky_tasting)\n\n\n\n::: {.panel-tabset}\n\n\n\n\n## AI å“é‰´è¯\n![](images/0.png){width=\"100%\"}\n\n\n## AI æ¨è\n\n![](images/1.png){width=\"100%\"}\n\n\n::: \n\n\n## æ ¸å¿ƒæ¶æ„\n\n### å¤š Agent AI ç³»ç»Ÿ\n\nè¯¥åº”ç”¨åŒ…å«ä¸‰ä¸ªä¸“é—¨çš„ AI Agentï¼Œæ¯ä¸ª Agent éƒ½æœ‰ç‹¬ç‰¹çš„ç‰¹å¾å’Œæ•°æ®æºï¼š\n\n1. **DrunkTony (dt)** - ä¸­æ–‡ Agentï¼Œä¸“æ³¨äºä¸­æ–‡å¨å£«å¿Œè¯„è®ºã€‚\n2. **WhiskyFunny (wf)** - è‹±æ–‡ Agentï¼Œæ•°æ®æºè‡ª whiskyfun.comã€‚\n3. **WhiskyNotebook (wn)** - è‹±æ–‡ Agentï¼Œæ•°æ®æºè‡ª whiskynotes.beã€‚\n\n### æŠ€æœ¯æ ˆ\n- **ä¸»è¦è¯­è¨€**: Python 3.13+\n- **Web æ¡†æ¶**: Streamlit (ä¸»é€‰) + Shiny for Python (å¤‡é€‰)\n- **æ•°æ®åº“**: DuckDB (376MBï¼Œé’ˆå¯¹å‘é‡æ“ä½œè¿›è¡Œäº†ä¼˜åŒ–)\n- **AI/ML**: OpenAI API, å‘é‡åµŒå…¥ (Vector embeddings), RAG ç³»ç»Ÿ\n- **æ•°æ®æº**: ä½¿ç”¨ BeautifulSoup4 è¿›è¡Œç½‘é¡µæŠ“å–\n\n## æ•°æ®åº“æ¶æ„\n\n### æ•°æ®æ¨¡å¼ä¸æ¥æº\n\nç³»ç»Ÿä½¿ç”¨ DuckDB ä½œä¸ºä¸»æ•°æ®åº“ï¼Œå› å…¶åœ¨å‘é‡æ“ä½œæ–¹é¢è¡¨ç°å“è¶Šï¼š\n\n```sql\n-- æ•°æ®åº“ç»“æ„\nCREATE TABLE drinktony_embed (\n    full TEXT,\n    bottle_embedding FLOAT[1024]  -- 1024 ç»´å‘é‡\n);\n\nCREATE TABLE whiskyfun_embed (\n    full TEXT,\n    bottle_embedding FLOAT[1024]\n);\n\nCREATE TABLE whiskynote_embed (\n    full TEXT,\n    bottle_embedding FLOAT[1024]\n);\n```\n\n### æ•°æ®é‡‡é›†æµç¨‹\n\n::: {#be223295 .cell execution_count=1}\n``` {.python .cell-code}\n# get_data_dt.py ä¸­çš„ç½‘é¡µæŠ“å–ç¤ºä¾‹\ndef scrape_drinktony_reviews():\n    \"\"\"ä» drinktony.netlify.app æŠ“å–ä¸­æ–‡å¨å£«å¿Œè¯„è®º\"\"\"\n    url = \"https://drinktony.netlify.app/\"\n    response = requests.get(url)\n    soup = BeautifulSoup(response.content, \"html.parser\")\n\n    # æŸ¥æ‰¾æ‰€æœ‰è¯„è®ºé“¾æ¥\n    post_links = [urljoin(url, a.get(\"href\"))\n                 for a in soup.select(\"a.quarto-grid-link\")]\n\n    all_reviews = []\n    for post_url in post_links:\n        response = requests.get(post_url)\n        soup = BeautifulSoup(response.content, \"html.parser\")\n\n        # æå–è¯„è®ºç« èŠ‚\n        review_sections = soup.select(\"section.level1\")\n        for section in review_sections:\n            # è§£æå¨å£«å¿Œåç§°å’Œè¯„è®ºå†…å®¹\n            whisky_name = extract_whisky_name(section)\n            review_text = extract_review_text(section)\n            all_reviews.append({\n                'whisky': whisky_name,\n                'review': review_text\n            })\n\n    return all_reviews\n```\n:::\n\n\n## AI/ML å®ç°\n\n### å‘é‡åµŒå…¥æŠ€æœ¯\n\nåº”ç”¨ä½¿ç”¨å°–ç«¯çš„åµŒå…¥æŠ€æœ¯å°†æ–‡æœ¬è½¬æ¢ä¸ºé«˜ç»´å‘é‡ï¼Œä»¥ä¾¿è¿›è¡Œè¯­ä¹‰ç›¸ä¼¼åº¦æœç´¢ã€‚\n\n#### åµŒå…¥æ¨¡å‹è¯¦æƒ…\n\n**æ¨¡å‹**: BAAI/bge-large-zh-v1.5\n- **ç»´åº¦**: 1024\n- **æœåŠ¡å•†**: SiliconFlow API\n- **ç”¨é€”**: è·¨è¯­è¨€æ–‡æœ¬ç†è§£ï¼ˆåœ¨ä¸­è‹±æ–‡æ–¹é¢è¡¨ç°å‡å¾ˆå‡ºè‰²ï¼‰\n\n#### ä¸ºä»€ä¹ˆé€‰æ‹© BGE-Large-ZH?\n\n1. **è·¨è¯­è¨€èƒ½åŠ›**: åœ¨ç†è§£ä¸­è‹±æ–‡å¨å£«å¿Œä¸“ä¸šæœ¯è¯­æ–¹é¢è¡¨ç°ä¼˜å¼‚ã€‚\n2. **é«˜æ€§èƒ½**: ä¸é€šç”¨åµŒå…¥æ¨¡å‹ç›¸æ¯”ï¼Œå…·å¤‡æ›´å‡ºè‰²çš„è¯­ä¹‰ç†è§£èƒ½åŠ›ã€‚\n3. **é«˜æ•ˆå°ºå¯¸**: 1024 ç»´åº¦åœ¨æ€§èƒ½å’Œå­˜å‚¨æ•ˆç‡ä¹‹é—´è¾¾åˆ°äº†å¹³è¡¡ã€‚\n4. **API è®¿é—®**: é€šè¿‡ SiliconFlow æä¾›ç¨³å®šçš„æœåŠ¡ã€‚\n\n#### åµŒå…¥æµç¨‹\n\nè¯¥åº”ç”¨ä½¿ç”¨ BGE-Large-ZH-v1.5 æ¨¡å‹ç”ŸæˆåµŒå…¥å‘é‡ï¼š\n\n::: {#221c4646 .cell execution_count=2}\n``` {.python .cell-code}\ndef get_embedding(text: str, api_key: str):\n    \"\"\"ä½¿ç”¨ SiliconFlow API ç”Ÿæˆæ–‡æœ¬åµŒå…¥\"\"\"\n    client = OpenAI(\n        api_key=api_key,\n        base_url=\"https://api.siliconflow.cn/v1\"\n    )\n    response = client.embeddings.create(\n        model=\"BAAI/bge-large-zh-v1.5\",\n        input=[text]\n    )\n    return np.array(response.data[0].embedding)\n\ndef cosine_similarity(v1, v2):\n    \"\"\"è®¡ç®—ä¸¤ä¸ªå‘é‡ä¹‹é—´çš„ä½™å¼¦ç›¸ä¼¼åº¦\"\"\"\n    if v1 is None or v2 is None:\n        return 0\n    return np.dot(v1, v2) / (np.linalg.norm(v1) * np.linalg.norm(v2))\n```\n:::\n\n\n### RAG ç³»ç»Ÿæ¶æ„\n\næ£€ç´¢å¢å¼ºç”Ÿæˆ (RAG) ç³»ç»Ÿæ˜¯æ­¤åº”ç”¨çš„æ ¸å¿ƒåˆ›æ–°ã€‚è®©æˆ‘ä»¬è¯¦ç»†æ¢è®¨å…¶ç»„ä»¶ã€‚\n\n### RAG å·¥ä½œæµ\n\næ£€ç´¢å¢å¼ºç”Ÿæˆè¿‡ç¨‹éµå¾ªä»¥ä¸‹æ­¥éª¤ï¼š\n\n```mermaid\n%%| fig-cap: \"å¨å£«å¿Œå“é‰´çš„ RAG å·¥ä½œæµ\"\nflowchart TD\n    A[ç”¨æˆ·è¾“å…¥<br/>å¨å£«å¿Œåç§°] --> B[ç”ŸæˆåµŒå…¥å‘é‡]\n    B --> C[DuckDB ä¸­çš„<br/>å‘é‡ç›¸ä¼¼åº¦æœç´¢]\n    C --> D[æ£€ç´¢å‰ 10 æ¡<br/>ç›¸ä¼¼è¯„è®º]\n    D --> E[ä¸º LLM æ ¼å¼åŒ–ä¸Šä¸‹æ–‡]\n    E --> F[ä¸» LLM<br/>ç”Ÿæˆå“é‰´ç¬”è®°]\n    F --> G[å‰¯ LLM<br/>ç”Ÿæˆæ¨èå»ºè®®]\n    G --> H[æ ¼å¼åŒ–å¹¶<br/>æ˜¾ç¤ºç»“æœ]\n\n    C --> I[æ•°æ®åº“]\n    I --> J[drinktony_embed<br/>1200 æ¡ä¸­æ–‡è¯„è®º]\n    I --> K[whiskyfun_embed<br/>2 ä¸‡æ¡è‹±æ–‡è¯„è®º]\n    I --> L[whiskynote_embed<br/>5000 æ¡è‹±æ–‡è¯„è®º]\n```\n\n### ç›¸ä¼¼åº¦æœç´¢å®ç°\n\n::: {#8be53adf .cell execution_count=3}\n``` {.python .cell-code}\ndef find_similar_chunks(\n    query_embedding,\n    db_path,\n    table_name,\n    text_col,\n    embedding_col,\n    top_n=10,\n):\n    \"\"\"ä½¿ç”¨ä½™å¼¦ç›¸ä¼¼åº¦åœ¨æ•°æ®åº“ä¸­æŸ¥æ‰¾æœ€ç›¸ä¼¼çš„æ–‡æœ¬å—\"\"\"\n    try:\n        with duckdb.connect(database=db_path, read_only=True) as con:\n            df = con.execute(\n                f'SELECT \"{text_col}\", \"{embedding_col}\" FROM \"{table_name}\"'\n            ).fetchdf()\n\n            # è®¡ç®—ç›¸ä¼¼åº¦\n            similarities = []\n            for _, row in df.iterrows():\n                text = row[text_col]\n                embedding = np.array(row[embedding_col])\n                similarity = cosine_similarity(query_embedding, embedding)\n                similarities.append((text, similarity))\n\n            # æŒ‰ç›¸ä¼¼åº¦æ’åºå¹¶è¿”å›å‰ N æ¡\n            similarities.sort(key=lambda x: x[1], reverse=True)\n            return similarities[:top_n]\n\n    except Exception as e:\n        print(f\"æœç´¢ç›¸ä¼¼å—æ—¶å‡ºé”™: {e}\")\n        return []\n```\n:::\n\n\n## ä¸“é—¨ Agent çš„å®ç°\n\n### DrunkTony (ä¸­æ–‡ Agent)\n\n::: {#78e9c8b2 .cell execution_count=4}\n``` {.python .cell-code}\ndef run_conversation(query, api_key, model):\n    \"\"\"ç”Ÿæˆä¸­æ–‡æ ¼å¼çš„å¨å£«å¿Œå“é‰´ç¬”è®°\"\"\"\n\n    # ç¬¬ 1 æ­¥ï¼šç”ŸæˆåµŒå…¥å¹¶æŸ¥æ‰¾ç›¸ä¼¼è¯„è®º\n    query_embedding = get_embedding(query, api_key)\n    similar_reviews = find_similar_chunks(\n        query_embedding=query_embedding,\n        db_path=\"data/whisky_database.duckdb\",\n        table_name=\"drinktony_embed\",\n        text_col=\"full\",\n        embedding_col=\"bottle_embedding\"\n    )\n\n    # ç¬¬ 2 æ­¥ï¼šä¸º LLM å‡†å¤‡ä¸Šä¸‹æ–‡\n    context = \"\\n---\\n\".join([review[0] for review in similar_reviews])\n\n    # ç¬¬ 3 æ­¥ï¼šç”Ÿæˆå“é‰´ç¬”è®°\n    prompt = f\"\"\"ä½œä¸ºå¨å£«å¿Œä¸“å®¶ï¼ŒåŸºäºä»¥ä¸‹å¨å£«å¿Œå“é‰´ç¬”è®°ï¼Œä¸º\"{query}\"ç”Ÿæˆä¸“ä¸šçš„å“é‰´æŠ¥å‘Šï¼š\n\nå‚è€ƒå“é‰´ç¬”è®°ï¼š\n{context}\n\nè¯·æŒ‰ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼š\n{query}\né—»é¦™: [è¯¦ç»†æè¿°]\nå“å‘³: [è¯¦ç»†æè¿°]\næ‰“åˆ†: [90-100åˆ†]\n\"\"\"\n\n    response = llm_client.chat.completions.create(\n        model=model,\n        messages=[\n            {\"role\": \"system\", \"content\": \"ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„å¨å£«å¿Œå“é‰´å¸ˆï¼Œæ“…é•¿ç”Ÿæˆè¯¦ç»†å‡†ç¡®çš„å“é‰´ç¬”è®°ã€‚\"},\n            {\"role\": \"user\", \"content\": prompt}\n        ],\n        temperature=0.7,\n        max_tokens=1000\n    )\n\n    return response.choices[0].message.content\n```\n:::\n\n\n### WhiskyFunny (è‹±æ–‡ Agent)\n\n::: {#d7aa02cd .cell execution_count=5}\n``` {.python .cell-code}\ndef run_conversation(query, api_key, model):\n    \"\"\"ç”Ÿæˆè‹±æ–‡æ ¼å¼çš„å¨å£«å¿Œå“é‰´ç¬”è®°\"\"\"\n\n    query_embedding = get_embedding(query, api_key)\n    similar_reviews = find_similar_chunks(\n        query_embedding=query_embedding,\n        db_path=\"data/whisky_database.duckdb\",\n        table_name=\"whiskyfun_embed\",\n        text_col=\"full\",\n        embedding_col=\"bottle_embedding\"\n    )\n\n    context = \"\\n---\\n\".join([review[0] for review in similar_reviews])\n\n    prompt = f\"\"\"As a whisky expert, generate professional tasting notes for \"{query}\" based on these reference reviews:\n\nReference reviews:\n{context}\n\nPlease output in this format:\nColour: [detailed description]\nNose: [detailed aroma description]\nMouth: [detailed taste description]\nFinish: [detailed finish description]\nComments: [overall impression]\nSGP: xxx - xx points\n\"\"\"\n\n    response = llm_client.chat.completions.create(\n        model=model,\n        messages=[\n            {\"role\": \"system\", \"content\": \"You are a professional whisky taster specializing in detailed sensory analysis.\"},\n            {\"role\": \"user\", \"content\": prompt}\n        ],\n        temperature=0.7,\n        max_tokens=1200\n    )\n\n    return response.choices[0].message.content\n```\n:::\n\n\n## æ¨èå¼•æ“\n\n### åŒ LLM æ¨èç³»ç»Ÿ\n\nåº”ç”¨ä½¿ç”¨ä¸€ä¸ªç‹¬ç«‹çš„ LLM æ¥ç”Ÿæˆå¨å£«å¿Œæ¨èå»ºè®®ï¼š\n\n::: {#d60e91fb .cell execution_count=6}\n``` {.python .cell-code}\ndef recommend_whiskies_by_profile(tasting_notes, api_key, model):\n    \"\"\"åŸºäºå“é‰´ç‰¹å¾ç”Ÿæˆå¨å£«å¿Œæ¨è\"\"\"\n\n    prompt = f\"\"\"Based on these tasting notes, recommend 2 similar whiskies that the user might enjoy:\n\n{Tasting Notes:}\n{tasting_notes}\n\nPlease provide:\n1. Whisky name with brief description\n2. Why it matches the user's preference\n3. Price range and availability\n\nFormat each recommendation as:\n**Recommendation [1/2]:** [Whisky Name]\n**Why it matches:** [detailed reasoning]\n**Details:** [price, availability, tasting profile]\n\"\"\"\n\n    response = recommendation_client.chat.completions.create(\n        model=model,  # æ¨èä½¿ç”¨ä¸åŒçš„æ¨¡å‹\n        messages=[\n            {\"role\": \"system\", \"content\": \"You are a whisky recommendation expert with deep knowledge of global whisky brands and profiles.\"},\n            {\"role\": \"user\", \"content\": prompt}\n        ],\n        temperature=0.8,\n        max_tokens=800\n    )\n\n    return response.choices[0].message.content\n```\n:::\n\n\n## ç”¨æˆ·ç•Œé¢è®¾è®¡\n\n### Streamlit å®ç°\n\n::: {#63277e57 .cell execution_count=7}\n``` {.python .cell-code}\n# ä¸»åº”ç”¨ç¨‹åºç•Œé¢\ndef main():\n    st.set_page_config(\n        page_title=\"AI å¨å£«å¿Œå“é‰´ç³»ç»Ÿ\",\n        page_icon=\"ğŸ¥ƒ\",\n        layout=\"wide\"\n    )\n\n    # ä¾§è¾¹æ  Agent é€‰æ‹©\n    with st.sidebar:\n        st.header(\"ğŸ¥ƒ å¨å£«å¿Œ AI å“é‰´\")\n\n        # Agent é€‰æ‹©\n        agent_type = st.selectbox(\n            \"é€‰æ‹©å“é‰´ Agent:\",\n            [\"DrunkTony (ä¸­æ–‡)\", \"WhiskyFunny (English)\", \"WhiskyNotebook (English)\"],\n            help=\"æ¯ä¸ª Agent éƒ½æœ‰ä¸åŒçš„æ€§æ ¼å’Œæ•°æ®æº\"\n        )\n\n        # æ¨¡å‹é€‰æ‹©\n        model_options = get_model_options(agent_type)\n        selected_model = st.selectbox(\"æ¨¡å‹:\", model_options)\n\n    # ä¸»å†…å®¹åŒºåŸŸ\n    st.header(\"ä¸“ä¸šçš„å¨å£«å¿Œå“é‰´ç¬”è®°ç”Ÿæˆå™¨\")\n\n    # è¾“å…¥éƒ¨åˆ†\n    col1, col2 = st.columns([2, 1])\n    with col1:\n        whisky_name = st.text_input(\n            \"è¾“å…¥å¨å£«å¿Œåç§°:\",\n            placeholder=\"ä¾‹å¦‚: Macallan 18 Year Old\",\n            help=\"è¾“å…¥å®Œæ•´çš„å¨å£«å¿Œåç§°ï¼ŒåŒ…æ‹¬å¹´ä»½å’Œæ¡¶å‹\"\n        )\n\n    with col2:\n        st.write(\"\")  # é—´è·\n        generate_btn = st.button(\"ğŸ· ç”Ÿæˆå“é‰´ç¬”è®°\", type=\"primary\")\n        recommend_btn = st.button(\"ğŸ¯ è·å–æ¨è\")\n\n    # è¾“å‡ºéƒ¨åˆ†\n    if generate_btn:\n        if not whisky_name:\n            st.error(\"è¯·è¾“å…¥å¨å£«å¿Œåç§°\")\n        else:\n            with st.spinner(\"æ­£åœ¨åˆ†æå¨å£«å¿Œ...\"):\n                tasting_notes = generate_tasting_notes(whisky_name, agent_type, selected_model)\n                st.markdown(\"### ğŸ¥ƒ å“é‰´ç¬”è®°\")\n                st.markdown(tasting_notes)\n\n    if recommend_btn:\n        with st.spinner(\"æ­£åœ¨æŸ¥æ‰¾æ¨è...\"):\n            recommendations = get_recommendations(tasting_notes, agent_type)\n            st.markdown(\"### ğŸ¯ ä¸ªæ€§åŒ–æ¨è\")\n            st.markdown(recommendations)\n```\n:::\n\n\n## é¢‘ç‡é™åˆ¶ä¸æˆæœ¬ç®¡ç†\n\n### API ä½¿ç”¨æ§åˆ¶\n\n::: {#b9345ef8 .cell execution_count=8}\n``` {.python .cell-code}\n# é¢‘ç‡é™åˆ¶å®ç°\nRATE_LIMIT_FILE = \"rate_limit.json\"\nMAX_RUNS_PER_DAY = 80\n\ndef get_rate_limit_data():\n    \"\"\"è·å–å½“å‰ä½¿ç”¨æ•°æ®\"\"\"\n    try:\n        with open(RATE_LIMIT_FILE, \"r\") as f:\n            data = json.load(f)\n            # ç¡®ä¿é”®å­˜åœ¨\n            if \"date\" not in data or \"count\" not in data:\n                return {\"date\": str(datetime.date.today()), \"count\": 0}\n            return data\n    except (FileNotFoundError, json.JSONDecodeError):\n        return {\"date\": str(datetime.date.today()), \"count\": 0}\n\ndef check_rate_limit():\n    \"\"\"æ£€æŸ¥ç”¨æˆ·æ˜¯å¦è¶…å‡ºäº†æ¯æ—¥é™åˆ¶\"\"\"\n    data = get_rate_limit_data()\n    today = str(datetime.date.today())\n\n    if data[\"date\"] != today:\n        # ä¸ºæ–°çš„ä¸€å¤©é‡ç½®è®¡æ•°å™¨\n        return {\"date\": today, \"count\": 0, \"can_run\": True}\n\n    if data[\"count\"] >= MAX_RUNS_PER_DAY:\n        return {\"date\": today, \"count\": data[\"count\"], \"can_run\": False}\n\n    return {\"date\": today, \"count\": data[\"count\"], \"can_run\": True}\n```\n:::\n\n\n## æ€§èƒ½ä¼˜åŒ–\n\n### å‘é‡æ•°æ®åº“æ€§èƒ½\n\n::: {#463c1b95 .cell execution_count=9}\n``` {.python .cell-code}\n# é’ˆå¯¹å¤§æ•°æ®çš„åˆ†æ‰¹ä¼˜åŒ–ç›¸ä¼¼åº¦æœç´¢\ndef batch_similarity_search(query_embedding, db_path, table_name, batch_size=1000):\n    \"\"\"é’ˆå¯¹å¤§å‹æ•°æ®é›†çš„åˆ†æ‰¹ç›¸ä¼¼åº¦æœç´¢ä¼˜åŒ–\"\"\"\n\n    with duckdb.connect(database=db_path, read_only=True) as con:\n        # è·å–æ€»è¡Œæ•°\n        total_rows = con.execute(f\"SELECT COUNT(*) FROM {table_name}\").fetchone()[0]\n\n        all_similarities = []\n\n        # åˆ†æ‰¹å¤„ç†ä»¥ç®¡ç†å†…å­˜\n        for offset in range(0, total_rows, batch_size):\n            batch_df = con.execute(\n                f'SELECT full, bottle_embedding FROM {table_name} LIMIT {batch_size} OFFSET {offset}'\n            ).fetchdf()\n\n            # è®¡ç®—è¯¥æ‰¹æ¬¡çš„ç›¸ä¼¼åº¦\n            for _, row in batch_df.iterrows():\n                embedding = np.array(row['bottle_embedding'])\n                similarity = cosine_similarity(query_embedding, embedding)\n                all_similarities.append((row['full'], similarity))\n\n        # æ’åºå¹¶è¿”å›å‰å‡ æ¡ç»“æœ\n        all_similarities.sort(key=lambda x: x[1], reverse=True)\n        return all_similarities[:10]\n```\n:::\n\n\n## éƒ¨ç½²ä¸é…ç½®\n\n### ç¯å¢ƒæ­å»º\n\n```bash\n# .env æ–‡ä»¶ä¸­çš„ç¯å¢ƒå˜é‡\nSILICONFLOW_API_KEY=æ‚¨çš„ SiliconFlow å¯†é’¥\nMODELSCOPE_API_KEY=æ‚¨çš„ ModelScope å¯†é’¥\nGEMINI_API_KEY=æ‚¨çš„ Gemini å¯†é’¥  # å¯é€‰\n\n# æ•°æ®åº“åˆå§‹åŒ–\npython -c \"\nimport duckdb\nconn = duckdb.connect('data/whisky_database.duckdb')\n# åˆ›å»ºæ”¯æŒå‘é‡çš„è¡¨æ ¼\n\"\n```\n\n\n### Shiny for Python å¤‡é€‰æ–¹æ¡ˆ\n\n::: {#b6a00a34 .cell execution_count=10}\n``` {.python .cell-code}\n# ä½¿ç”¨ Shiny å®ç°çš„å¤‡é€‰ UI\nfrom shiny import App, ui, render, reactive, req\n\napp_ui = ui.page_fluid(\n    ui.h2(\"ğŸ¥ƒ AI å¨å£«å¿Œå“é‰´ç³»ç»Ÿ\"),\n    ui.layout_sidebar(\n        ui.sidebar(\n            ui.input_select(\"agent\", \"é€‰æ‹© Agent:\", [\n                \"DrunkTony (ä¸­æ–‡)\", \"WhiskyFunny (English)\", \"WhiskyNotebook (English)\"\n            ]),\n            ui.input_text(\"whisky_name\", \"å¨å£«å¿Œåç§°:\", \"\"),\n            ui.input_action_button(\"generate\", \"ç”Ÿæˆå“é‰´ç¬”è®°\")\n        ),\n        ui.output_text_verbatim(\"tasting_notes\"),\n        ui.output_text_verbatim(\"recommendations\")\n    )\n)\n\ndef server(input, output, session):\n    @output\n    @render.text\n    def tasting_notes():\n        req(input.generate())\n        # ç”Ÿæˆå“é‰´ç¬”è®°é€»è¾‘\n        return generate_tasting_notes(input.whisky_name(), input.agent())\n\napp = App(app_ui, server)\n```\n:::\n\n\n## æŠ€æœ¯æˆå°±\n\n### æ ¸å¿ƒåˆ›æ–°\n\n1. **å¤š Agent æ¶æ„**: æ‹¥æœ‰ä¸åŒçš„ AI äººæ ¼å’Œæ•°æ®æºã€‚\n2. **RAG å®ç°**: ä½¿ç”¨çœŸå®å¨å£«å¿Œè¯„è®ºè¿›è¡Œæ£€ç´¢å¢å¼ºç”Ÿæˆã€‚\n3. **å‘é‡æ•°æ®åº“**: ä½¿ç”¨ 376MB æ•°æ®åº“è¿›è¡Œé«˜æ•ˆç›¸ä¼¼åº¦æœç´¢ã€‚\n4. **åŒè¯­æ”¯æŒ**: æä¾›ä¸­æ–‡å’Œè‹±æ–‡ Agentã€‚\n5. **æˆæœ¬ç®¡ç†**: å†…ç½®é¢‘ç‡é™åˆ¶å’Œ API ä¼˜åŒ–ã€‚\n6. **ä¸“ä¸šå“é‰´æ ¼å¼**: ç¬¦åˆè¡Œä¸šæ ‡å‡†çš„ç¬”è®°ç»“æ„ã€‚\n\n### æ€§èƒ½æŒ‡æ ‡\n\n| æŒ‡æ ‡ | æ•°å€¼ |\n|--------|-------|\n| æ•°æ®åº“å¤§å° | 376MB (26,000+ æ¡è¯„è®º) |\n| åµŒå…¥ç»´åº¦ | 1024 |\n| æœç´¢å»¶è¿Ÿ | < 2 ç§’ |\n| æ¯æ—¥è¯·æ±‚é™åˆ¶ | 80 æ¬¡è¯·æ±‚ |\n| æ”¯æŒè¯­è¨€ | 2 (EN/ZH) |\n| æ•°æ®æº | 3 (drinktony, whiskyfun, whiskynotes) |\n\n## æœªæ¥å¢å¼ºæ–¹å‘\n\nä¸‹ä¸€ç‰ˆæœ¬çš„æ½œåœ¨æ”¹è¿›ç‚¹ï¼š\n\n1. **é«˜çº§ç›¸ä¼¼åº¦ç®—æ³•**: å®ç°æ–‡æœ¬ + å…ƒæ•°æ®çš„æ··åˆæœç´¢ã€‚\n2. **ç”¨æˆ·ä¸ªæ€§åŒ–**: éšç€æ—¶é—´æ¨ç§»å­¦ä¹ ç”¨æˆ·çš„åå¥½ã€‚\n3. **ç§»åŠ¨ç«¯åº”ç”¨**: åŸç”Ÿçš„ iOS/Android åº”ç”¨ç¨‹åºã€‚\n4. **å®æ—¶æ•°æ®æ›´æ–°**: è‡ªåŠ¨åŒ–çš„ç½‘é¡µæŠ“å–æµæ°´çº¿ã€‚\n5. **å£å‘³ç‰¹å¾åˆ†æ**: æ ¹æ®ç”¨æˆ·åå¥½ç”Ÿæˆå…¶å£å‘³ç‰¹å¾å›¾è°±ã€‚\n6. **ç¤¾äº¤åŠŸèƒ½**: ä¸ç¤¾åŒºåˆ†äº«å“é‰´ç¬”è®°å’Œæ¨èã€‚\n\n## ç»“è®º\n\nè¿™æ¬¾å¨å£«å¿Œå“é‰´åº”ç”¨å±•ç¤ºäº†å°† RAG æŠ€æœ¯ä¸ä¸“é—¨çš„ AI Agent ç›¸ç»“åˆï¼Œä»è€Œæ„å»ºå¤æ‚çš„é¢†åŸŸç‰¹å®šç³»ç»Ÿçš„å¼ºå¤§åŠ›é‡ã€‚æœ¬é¡¹ç›®å±•ç¤ºäº†ï¼š\n\n- **å…ˆè¿›çš„ AI æ¶æ„**: å…·å¤‡ä¸åŒäººæ ¼çš„å¤š Agent ç³»ç»Ÿã€‚\n- **æ•°æ®å·¥ç¨‹**: å¤§è§„æ¨¡å‘é‡æ•°æ®åº“ç®¡ç†ã€‚\n- **ä¸“ä¸šçŸ¥è¯†**: è¡Œä¸šæ ‡å‡†çš„å“é‰´ç¬”è®°æ ¼å¼ã€‚\n- **ç”¨æˆ·ä½“éªŒ**: è·¨å¹³å°çš„ç®€æ´ã€ç›´è§‚ç•Œé¢ã€‚\n- **æˆæœ¬æ•ˆç›Š**: æ™ºèƒ½çš„é¢‘ç‡é™åˆ¶å’Œä¼˜åŒ–ã€‚\n\næ— è®ºæ‚¨æ˜¯å¨å£«å¿Œçˆ±å¥½è€…ã€AI å¼€å‘äººå‘˜è¿˜æ˜¯æ•°æ®ç§‘å­¦å®¶ï¼Œæœ¬é¡¹ç›®éƒ½ä¸ºæ‚¨æä¾›äº†ä¸€ä¸ªæä½³çš„èŒƒä¾‹ï¼Œå±•ç¤ºäº†å¦‚ä½•ç»“åˆçœŸå®ä¸–ç•Œæ•°æ®ä¸å…ˆè¿›æœºå™¨å­¦ä¹ æŠ€æœ¯æ¥æ„å»ºç”Ÿäº§çº§ AI åº”ç”¨ã€‚\n\n---\n\n\n**æŠ€æœ¯æ ˆ**: Python, Streamlit, DuckDB, OpenAI API, å‘é‡åµŒå…¥ (Vector Embeddings)\n\n**æ•°æ®åº“**: æ¶µç›– 3 ä¸ªä¸“é—¨æ¥æºçš„ 26,000+ æ¡çœŸå®å¨å£«å¿Œè¯„è®ºã€‚\n\n",
    "supporting": [
      "index_files/figure-html"
    ],
    "filters": [],
    "includes": {}
  }
}