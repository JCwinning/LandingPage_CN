{
  "hash": "07778fa3cf6ab3097b9b025d85292003",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"MCP 教程：将麦当劳服务与 AI Agent 集成\"\nauthor: \"Tony D\"\ndate: \"2025-11-02\"\ncategories: [AI, API, tutorial]\nimage: \"images/0.png\"\nformat:\n  html:\n    code-fold: show\n    code-tools: true\n    code-copy: false\nexecute:\n  warning: false\neditor: \n  markdown: \n    wrap: 72\n---\n\n# 什么是模型上下文协议 (MCP)？\n\n**模型上下文协议 (Model Context Protocol, MCP)** 是一项开放标准，旨在使 AI 模型能够无缝连接外部数据源和工具。\n它由 Anthropic 开发，充当一个通用接口（类似于 USB 接口），允许开发者为大语言模型（LLM）提供对本地文件、数据库和第三方 API 的标准化、安全访问，而无需为每个特定服务编写自定义集成。\n\n通过使用 MCP，AI Agent 可以“触及”物理世界，执行诸如查看库存、查询营养数据，甚至领取优惠券等任务——正如我们将在本教程中使用麦当劳服务所演示的那样。\n\n# 设置 MCP\n\n## 获取密钥\n\n1.  从 https://openrouter.ai 获取 LLM 模型 API Key。\n\n2.  从 https://open.mcd.cn/mcp 获取访问 mcd-mcp 的 `MCD_TOKEN`。\n\n并将它们保存到 `.env` 文件中：\n\n\n::: {.cell}\n\n```{.r .cell-code}\nOPENROUTER_API_KEY=xxxxxx\n\nMCD_TOKEN=XXXX\n```\n:::\n\n\n# 在代码中使用 MCP\n\n::: panel-tabset\n## R 代码实现\n\n### 初始化集成 MCP 工具的聊天\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ellmer)\nlibrary(mcptools)\nlibrary(dotenv)\n# Load environment variables\nload_dot_env(file = \".env\")\n\n# Define model \nmodel_name <- \"x-ai/grok-4.1-fast\"\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create an ellmer chat object (using OpenRouter as example)\nchat <- chat_openrouter(\n  system_prompt = \"您是一位麦当劳助手。请简短回答。\",\n  api_key = Sys.getenv(\"OPENROUTER_API_KEY\"),\n  model = model_name,\n  echo = \"output\"\n)\n\n# Create dynamic configuration with token from environment\nconfig_data <- list(\n  mcpServers = list(\n    \"mcd-mcp\" = list(\n      command = \"npx\",\n      args = c(\n        \"mcp-remote\",\n        \"https://mcp.mcd.cn/mcp-servers/mcd-mcp\",\n        \"--header\",\n        paste0(\"Authorization: Bearer \", Sys.getenv(\"MCD_TOKEN\"))\n      )\n    )\n  )\n)\n\nconfig_file <- tempfile(fileext = \".json\")\njsonlite::write_json(config_data, config_file, auto_unbox = TRUE)\n\n# Load MCP tools via the temporary configuration file\nmcd_tools <- mcp_tools(config = config_file)\n\n# Register the MCP tools with the chat\nchat$set_tools(mcd_tools)\n```\n:::\n\n\n### 集成 MCP 的对话测试\n\n现在你可以提问，AI 将使用麦当劳 MCP 工具：\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Query available coupons\nchat$chat(\"目前有什么优惠券\")\n```\n\n\n::: {.cell-output .cell-output-stdout}\n\n```\n您当前可用的麦麦省优惠券（均已领取）：\n\n- 北非蛋风味麦满分特惠组合\n- 9.9元大薯条\n- 9.9元新派组合\n- 北非蛋风味麦满分\n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Auto-claim all coupons\nchat$chat(\"帮我领取所有优惠券\")\n```\n\n\n::: {.cell-output .cell-output-stdout}\n\n```\n暂无可领取的优惠券，所有可用券已领取！\n```\n\n\n:::\n:::\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Get nutrition information\nchat$chat(\"帮我建议一个1000卡路里的套餐，需要包括有糖可乐。\")\n```\n\n\n::: {.cell-output .cell-output-stdout}\n\n```\n**推荐套餐（总热量 ≈1011 kcal）：**\n\n- 麦辣鸡腿汉堡（485 kcal）\n- 大薯条（379 kcal，使用9.9元优惠券）\n- 可乐中杯（147 kcal）\n\n营养均衡，辣味主食+薯条+甜饮，超值！\n```\n\n\n:::\n:::\n\n\n## Python 代码实现\n\n### 初始化集成 MCP 工具的聊天\n\n\n::: {.cell}\n\n```{.python .cell-code}\nimport os\nimport asyncio\nfrom dotenv import load_dotenv\nfrom langchain_mcp_adapters.client import MultiServerMCPClient\nfrom langchain_openai import ChatOpenAI\nfrom langgraph.prebuilt import create_react_agent\n\n# Load environment variables\nload_dotenv()\n\n# Define model (using OpenRouter)\nmodel_name = \"x-ai/grok-4.1-fast\"\n\n# Create the LLM with OpenRouter\nllm = ChatOpenAI(\n    model=model_name,\n    openai_api_key=os.getenv(\"OPENROUTER_API_KEY\"),\n    openai_api_base=\"https://openrouter.ai/api/v1\",\n    temperature=0\n)\n\n# Build the mcp-remote command with authorization header\nmcd_token = os.getenv(\"MCD_TOKEN\")\nmcp_command_args = [\n    \"mcp-remote\",\n    \"https://mcp.mcd.cn/mcp-servers/mcd-mcp\",\n    \"--header\",\n    f\"Authorization: Bearer {mcd_token}\"\n]\n\n# Configure the MCP client\nmcp_config = {\n    \"mcd-mcp\": {\n        \"command\": \"npx\",\n        \"args\": mcp_command_args,\n        \"transport\": \"stdio\"\n    }\n}\n\nasync def run_mcp_agent(query: str):\n    \"\"\"Run an MCP-enabled agent with the given query.\"\"\"\n    # Create client (no context manager in v0.1.0+)\n    client = MultiServerMCPClient(mcp_config)\n    \n    # Get tools from MCP server (await required)\n    tools = await client.get_tools()\n    \n    # Create a ReAct agent with the tools\n    agent = create_react_agent(llm, tools)\n    \n    # Run the agent\n    result = await agent.ainvoke({\n        \"messages\": [\n            {\"role\": \"system\", \"content\": \"You are a helpful assistant that can interact with McDonald's services. Please be concise.\"},\n            {\"role\": \"user\", \"content\": query}\n        ]\n    })\n    \n    # Return the final response\n    return result[\"messages\"][-1].content\n```\n:::\n\n\n### 集成 MCP 的对话测试\n\n现在你可以提问，AI 将使用麦当劳 MCP 工具：\n\n\n::: {.cell}\n\n```{.python .cell-code}\n# Query available coupons\nasyncio.run(run_mcp_agent(\"What coupons are available right now?\"))\n```\n:::\n\n\n\n::: {.cell}\n\n```{.python .cell-code}\n# Auto-claim all coupons\nasyncio.run(run_mcp_agent(\"Help me claim all available coupons.\"))\n```\n:::\n\n\n\n::: {.cell}\n\n```{.python .cell-code}\n# Check your coupons\nasyncio.run(run_mcp_agent(\"Show me all my current coupons.\"))\n```\n:::\n\n\n\n::: {.cell}\n\n```{.python .cell-code}\n# Query campaign calendar\nasyncio.run(run_mcp_agent(\"What exciting activities are happening in the next 15 days?\"))\n```\n:::\n\n\n\n::: {.cell}\n\n```{.python .cell-code}\n# Get nutrition information\nasyncio.run(run_mcp_agent(\"Help me design a 1000-calorie meal that includes a sugared cola and costs no more than 30 yuan.\"))\n```\n:::\n\n:::\n\n# 在 Agent 中使用 MCP\n\n::: panel-tabset\n## Claude Code CLI\n\n将 \"xxx\" 替换为你的 Token，并将以下设置添加到用户级或项目级配置文件中。\n\n### JSON 文件配置\n\n\n::: {.cell}\n\n```{.r .cell-code}\n{\n  \"mcpServers\": {\n    \"mcd-mcp\": {\n      \"type\": \"http\",\n      \"url\": \"https://mcp.mcd.cn/mcp-servers/mcd-mcp\",\n      \"headers\": {\n        \"Authorization\": \"Bearer xxx\"\n      }\n    }\n  }\n}\n```\n:::\n\n\n*用户级配置文件*:\n\n\\~/.claude.json\n\n*项目级配置文件*:\n\nyour_project/.mcp.json\n\n### 提问: \"What coupons are available right now?\"\n\n![](images/clipboard-3343486679.png){width=\"700\"}\n\n## Gemini CLI\n\n将 \"xxx\" 替换为你的 Token，并将以下设置添加到用户级或项目级配置文件中。\n\n### JSON 文件配置\n\n\n::: {.cell}\n\n```{.python .cell-code}\n{\n\"mcpServers\": {\n    \"mcd-mcp\": {\n      \"url\": \"https://mcp.mcd.cn/mcp-servers/mcd-mcp\",\n      \"headers\": {\n        \"Authorization\": \"Bearer xxx\"\n      }\n    }\n  } \n} \n```\n:::\n\n\n*用户级配置*:\n\n\\~/.gemini/settings.json\n\n*项目级配置*:\n\nyour_project/.gemini/settings.json\n\n### 提问: \"What coupons are available right now?\"\n\n![](images/clipboard-1202098417.png){width=\"700\"}\n\n## Opencode CLI\n\n将 \"xxx\" 替换为你的 Token，并将以下设置添加到用户级或项目级配置文件中。\n\n### JSON 文件配置\n\n\n::: {.cell}\n\n```{.python .cell-code}\n{\n  \"$schema\": \"https://opencode.ai/config.json\",\n  \"mcp\": {\n    \"mcd-mcp\": {\n      \"type\": \"remote\",\n      \"url\": \"https://mcp.mcd.cn/mcp-servers/mcd-mcp\",\n      \"enabled\": true,\n      \"headers\": {\n        \"Authorization\": \"Bearer xxx\"\n      }\n    }\n  }\n}\n```\n:::\n\n\n*用户级配置*:\n\n\\~/.opencode.json\n\n*项目级配置*:\n\n.config/opencode/opencode.json\n\n### 提问: \"What coupons are available right now?\"\n\n![](images/clipboard-4015309059.png)\n\n## Antigravity IDE\n\n将 \"xxx\" 替换为你的 Token，并将以下设置添加到用户级或项目级配置文件中。\n\n### JSON 文件配置\n\n\n::: {.cell}\n\n```{.python .cell-code}\n{\n  \"mcpServers\": {\n    \"mcd-mcp\": {\n      \"serverUrl\": \"https://mcp.mcd.cn/mcp-servers/mcd-mcp\",\n      \"headers\": {\n        \"Authorization\": \"Bearer xxx\"\n      }\n    }\n  }\n}\n```\n:::\n\n\n*用户级配置*:\n\n\\~/.gemini/antigravity/mcp_config.json\n\n*项目级配置*:\n\n暂不支持\n\n### 提问: \"What coupons are available right now?\"\n\n![](images/clipboard-4292207523.png)\n\n## Trae IDE\n\n将 \"xxx\" 替换为你的 Token，并将以下设置添加到用户级或项目级配置文件中。\n\n### JSON 文件配置\n\n\n::: {.cell}\n\n```{.python .cell-code}\n{\n  \"mcpServers\": {\n    \"mcd-mcp\": {\n      \"command\": \"npx\",\n      \"args\": [\n        \"mcp-remote\",\n        \"https://mcp.mcd.cn/mcp-servers/mcd-mcp\",\n        \"--header\",\n        \"Authorization: Bearer xxx\"\n      ]\n    }\n  }\n}\n```\n:::\n\n\n\n\n*用户级配置*:\n\n\\~/user/Library/Application Support/Trae/User/mcp.json\n\n*项目级配置*:\n\nyour_project/.trae/mcp.json\n\n### 开启 Trae 项目级设置: Setting -> Beta -> Enable project MCP\n\n### 切换模式为 @Builder 并提问: \"What coupons are available right now?\"\n\n![](images/clipboard-1218453575.png)\n\n\n## Cody Buddy\n\nComing soon\n\n## Qoder\n\nComing soon\n\n## Cline VS Code\n\nComing soon\n\n:::\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}