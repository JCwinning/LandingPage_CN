{
  "hash": "096ec33d86de3f786b575c31427a054c",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"结合 AI 分析的 Shiny 和 Streamlit 体重追踪看板\"\nauthor: \"Tony D\"\ndate: \"2025-11-05\"\ncategories: [AI, API, tutorial]\nimage: \"images/0.png\"\nexecute: \n  cache: true\n  eval: false\n  warning: false\n  \nformat:\n  html:\n    code-fold: true\n    code-tools: true\n    code-copy: true\n  \n---\n\n\n# 项目概览\n\n体重追踪应用是一款全面的 R Shiny Web 应用程序，可帮助用户监测体重趋势、计算 BMI，并获得基于 AI 的个性化健康建议。本项目的一个特别之处在于它集成了多个 AI 服务商，并具备实时数据同步功能。\n\n在线演示: [https://jcflyingco.shinyapps.io/weight_tracking/](https://jcflyingco.shinyapps.io/weight_tracking/)\n\nGithub: [https://github.com/JCwinning/weight_tracking](https://github.com/JCwinning/weight_tracking)\n\n\n\n::: {.panel-tabset}\n\n## 体重趋势图\n\n![](images/0.png){width=\"100%\"}\n\n## AI 反馈\n\n![](images/3.png){width=\"100%\"}\n\n:::\n\n## 核心功能\n\n### 健康监测能力\n- **体重追踪**：交互式的体重记录和随时间变化的可视化。\n- **BMI 计算器**：自动计算 BMI 并与健康范围进行对比。\n- **单位转换**：在公制（kg/cm）和英制（磅/英寸）之间无缝切换。\n- **实时更新**：当修改 Excel 文件时，数据会自动刷新。\n\n### 高级技术特性\n- **多服务商 AI 集成**：支持 Modelscope、OpenRouter、Gemini 和 OpenAI 兼容的 API。\n- **完善的国际化**：完整的英文/中文双语支持，包含 50+ 个翻译字段。\n- **实时文件监控**：当数据文件发生变化时，UI 会自动更新。\n- **交互式可视化**：具备缩放、平移和悬停功能的 Plotly 图表。\n- **数据管理**：支持 Excel 导入/导出，并具备响应式数据更新。\n\n## 技术架构\n\n```{mermaid}\n%%| fig-cap: \"体重追踪应用架构\"\nflowchart TD\n    A[用户界面<br/>R Shiny Web 应用] --> B[数据管理层]\n    A --> C[AI 集成层]\n    A --> D[可视化层]\n\n    B --> E[Excel 文件<br/>weight.xlsx]\n    B --> F[实时监控<br/>reactivePoll 1000ms]\n    B --> G[数据处理<br/>BMI 计算]\n\n    C --> H[AI 服务商配置]\n    H --> I[Modelscope<br/>GLM-4.6]\n    H --> J[OpenRouter<br/>GPT Models]\n    H --> K[Gemini<br/>2.5 Flash/Pro]\n    H --> L[OpenAI 兼容<br/>自定义 API]\n\n    D --> M[Plotly 图表]\n    D --> N[交互式表格]\n    D --> O[代码查看器]\n\n    E --> P[自动刷新]\n    F --> P\n    G --> Q[健康见解]\n    I --> Q\n    J --> Q\n    K --> Q\n    L --> Q\n\n    P --> A\n    Q --> A\n```\n\n### 技术栈\n- **主要框架**：R Shiny（经典架构）\n- **UI 组件**：基于 Bootstrap 的响应式设计，使用 `bslib`\n- **数据处理**：`tidyverse`, `readxl`, `openxlsx`\n- **可视化**：使用 `plotly` 实现交互式图表\n- **AI 集成**：使用 `ellmer` 支持多服务商 AI\n\n### 文件结构分析\n```\nweight_tracking/\n├── ui.R              # 包含控件的多标签界面\n├── server.R          # 服务器逻辑和数据管理\n├── global.R          # URL 书签配置\n├── ai_config.R       # 统一的 AI 服务商管理\n├── language.R        # 完整的国际化系统\n├── weight.xlsx       # 主要数据存储\n├── www/logo.png      # 应用品牌标识\n└── images/           # 应用截图\n```\n\n## 数据管理系统\n\n该应用实现了一套精致的数据处理流程，确保了实时同步和高效的数据处理。\n\n### 数据处理工作流\n\n```{mermaid}\n%%| fig-cap: \"数据处理工作流\"\nflowchart LR\n    A[Excel 文件<br/>weight.xlsx] --> B[文件监控<br/>1000ms 间隔]\n    B --> C[数据验证<br/>文件存在检查]\n    C --> D[数据读取<br/>readxl::read_excel]\n    D --> E[数据转换<br/>日期解析, BMI 计算]\n    E --> F[响应式更新<br/>UI 自动刷新]\n\n    F --> G[可视化<br/>Plotly 图表]\n    F --> H[数据表格<br/>DT::dataTable]\n    F --> I[AI 分析<br/>健康建议]\n```\n\n### 实时文件监控\n\n应用使用 `reactivePoll()` 来监控 Excel 数据文件的更改：\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 实时数据监控，间隔为 1000ms\nweight_data <- reactivePoll(\n  intervalMillis = 1000,\n  session = session,\n  checkFunc = function() {\n    # 检查文件修改时间\n    if (file.exists(\"weight.xlsx\")) {\n      file.info(\"weight.xlsx\")$mtime\n    } else {\n      0\n    }\n  },\n  valueFunc = function() {\n    # 读取并处理 Excel 文件\n    if (file.exists(\"weight.xlsx\")) {\n      data <- read_excel(\"weight.xlsx\") %>%\n        mutate(\n          Date = anytime(Date),\n          BMI = case_when(\n            Unit == \"kg\" ~ Weight / (Height/100)^2,\n            Unit == \"pound\" ~ (Weight * 0.453592) / ((Height * 2.54)/100)^2\n          )\n        )\n      return(data)\n    }\n    return(data.frame())\n  }\n)\n```\n:::\n\n\n### BMI 计算算法\n\n应用实现了包含单位转换的全面 BMI 计算：\n\n#### BMI 类别和健康范围\n\n| BMI 范围 | 类别 | 健康风险 | 颜色代码 |\n|-----------|----------|-------------|------------|\n| < 18.5 | 体重过轻 | 中度风险 | 黄色 |\n| 18.5 - 24.9 | 体重正常 | 风险最小 | 绿色 |\n| 25.0 - 29.9 | 超重 | 风险增加 | 橙色 |\n| ≥ 30.0 | 肥胖 | 高风险 | 红色 |\n\n#### 单位转换示例\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 公制和英制单位的 BMI 计算\ncalculate_bmi <- function(weight, height, unit) {\n  if (unit == \"kg\") {\n    # 公制计算\n    bmi <- weight / ((height/100)^2)\n  } else {\n    # 英制计算并转换\n    weight_kg <- weight * 0.453592  # 磅转换为千克\n    height_m <- height * 2.54 / 100  # 英寸转换为米\n    bmi <- weight_kg / (height_m^2)\n  }\n\n  # BMI 分类\n  category <- case_when(\n    bmi < 18.5 ~ \"underweight\",\n    bmi < 25 ~ \"normal\",\n    bmi < 30 ~ \"overweight\",\n    TRUE ~ \"obese\"\n  )\n\n  return(list(bmi = round(bmi, 1), category = category))\n}\n```\n:::\n\n\n## AI 集成架构\n\n### 多服务商 AI 系统\n\n应用支持多个 AI 服务商，并可动态切换：\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# AI 服务商配置\nai_providers <- list(\n  modelscope = list(\n    provider_url = \"https://api-inference.modelscope.cn/v1\",\n    models = c(\"zhipuAI/GLM-4.6\", \"Qwen/Qwen3-Next-80B-A3B-Instruct\")\n  ),\n  openrouter = list(\n    provider_url = \"https://openrouter.ai/api/v1\",\n    models = c(\"openai/gpt-oss-120b:exacto\", \"minimax/minimax-m2:free\")\n  ),\n  Gemini = list(\n    provider_url = \"https://generativelanguage.googleapis.com/v1beta/openai/\",\n    models = c(\"gemini-2.5-flash\", \"gemini-2.5-pro\")\n  )\n)\n\n# 动态服务商选择\nobserveEvent(input$ai_provider, {\n  set_current_provider(input$ai_provider)\n  updateSelectInput(session, \"ai_model\",\n                    choices = get_provider_models(input$ai_provider))\n})\n```\n:::\n\n\n### AI 健康建议系统\n\nAI 根据体重趋势生成个性化健康建议：\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# AI 建议生成\nget_ai_suggestion <- function(weight_data, api_key, model, provider) {\n  # 准备 AI 分析数据\n  recent_trend <- analyze_weight_trend(weight_data)\n  current_bmi <- get_current_bmi(weight_data)\n\n  # 创建特定语言的提示词\n  prompt <- if (current_language == \"zh\") {\n    paste(\"基于以下体重数据分析，请提供个性化的健康建议：\",\n          \"最近体重趋势：\", recent_trend,\n          \"当前BMI：\", current_bmi,\n          \"请用中文回复，包含具体的饮食和运动建议。\")\n  } else {\n    paste(\"Based on the following weight data analysis, please provide personalized health advice:\",\n          \"Recent weight trend:\", recent_trend,\n          \"Current BMI:\", current_bmi,\n          \"Please respond in English with specific diet and exercise recommendations.\")\n  }\n\n  # 调用选定服务商的 API\n  response <- ellmer::chat_completion(\n    model = model,\n    messages = list(\n      list(role = \"user\", content = prompt)\n    ),\n    api_key = api_key,\n    base_url = get_provider_url(provider)\n  )\n\n  return(response$choices[[1]]$message$content)\n}\n```\n:::\n\n\n## 用户界面设计\n\n### 多标签导航结构\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 基于标签页的界面组织\nmainPanel(\n  tabsetPanel(\n    tabPanel(get_text(\"plot_tab\"),\n             # 体重和 BMI 图表\n             fluidRow(\n               column(6, plotlyOutput(\"weight_plot\")),\n               column(6, plotlyOutput(\"bmi_plot\"))\n             )\n    ),\n    tabPanel(get_text(\"ui_tab\"),\n             # 包含语法高亮的 UI 代码查看器\n             verbatimTextOutput(\"ui_code\")\n    ),\n    tabPanel(get_text(\"server_tab\"),\n             # Server 代码查看器\n             verbatimTextOutput(\"server_code\")\n    ),\n    tabPanel(get_text(\"data_tab\"),\n             # 交互式数据表格\n             DT::dataTableOutput(\"data_table\")\n    )\n  )\n)\n```\n:::\n\n\n### 国际化系统\n\n完善的双语支持，具备动态语言切换功能：\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 语言翻译系统\ntranslations <- list(\n  en = list(\n    app_title = \"Weight tracking\",\n    your_weight = \"Your weight:\",\n    your_bmi = \"Your BMI:\",\n    get_ai_suggestion = \"Get AI Suggestion\"\n    # ... 更多翻译\n  ),\n  zh = list(\n    app_title = \"体重追踪\",\n    your_weight = \"您的体重:\",\n    your_bmi = \"您的BMI:\",\n    get_ai_suggestion = \"获取AI建议\"\n    # ... 更多翻译\n  )\n)\n\n# 语言切换处理器\nobserveEvent(input$lang_en, {\n  current_lang(\"en\")\n  set_language(\"en\")\n  updateUI()  # 触发 UI 更新\n})\n```\n:::\n\n\n## 数据可视化\n\n### 交互式 Plotly 图表\n\n应用具备带健康指标的动态图表：\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 带健康范围的 BMI 图表\noutput$bmi_plot <- renderPlotly({\n  data <- weight_data()\n\n  plot_ly(data, x = ~Date, y = ~BMI, type = 'scatter', mode = 'lines+markers',\n          name = get_text(\"chart_bmi_legend\"),\n          line = list(color = 'blue', width = 3),\n          marker = list(size = 8)) %>%\n    # 添加健康范围带\n    add_trace(y = rep(18.5, nrow(data)), mode = 'lines',\n              line = list(color = 'green', dash = 'dash'), name = \"理想范围起点\") %>%\n    add_trace(y = rep(24.9, nrow(data)), mode = 'lines',\n              line = list(color = 'red', dash = 'dash'), name = \"理想范围终点\") %>%\n    layout(\n      title = get_text(\"chart_bmi_title\"),\n      xaxis = list(title = \"日期\"),\n      yaxis = list(title = \"BMI\", range = c(15, 35)),\n      hovermode = 'x unified'\n    )\n})\n```\n:::\n\n\n## 部署与配置\n\n### ShinyApps.io 部署\n\n应用已部署并可通过以下链接访问：\n**https://jcflyingco.shinyapps.io/weight-tracking/**\n\n### URL 书签系统\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 在 global.R 中启用 URL 书签\nshinyServer(\n  function(input, output, session) {\n    # 书签配置\n    enableBookmarking(\"url\")\n\n    # 保存/恢复 UI 状态\n    setBookmarkExclude(c(\"lang_en\", \"lang_zh\"))  # 排除语言按钮\n  }\n)\n```\n:::\n\n\n## 性能优化\n\n### 响应式编程最佳实践\n\n应用实现了高效的响应式编程：\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 高效的带缓存数据处理\nprocessed_data <- reactive({\n  data <- weight_data()\n  if (nrow(data) == 0) return(NULL)\n\n  # 仅计算一次派生指标\n  data %>%\n    mutate(\n      Weight_Change = c(NA, diff(Weight)),\n      BMI_Category = case_when(\n        BMI < 18.5 ~ \"underweight\",\n        BMI < 25 ~ \"normal\",\n        BMI < 30 ~ \"overweight\",\n        TRUE ~ \"obese\"\n      ),\n      Date_Formatted = format(Date, \"%Y-%m-%d\")\n    )\n})\n\n# 用于多个输出的共享计算\ncurrent_stats <- reactive({\n  data <- processed_data()\n  if (is.null(data) || nrow(data) == 0) return(NULL)\n\n  list(\n    last_weight = tail(data$Weight, 1),\n    last_bmi = tail(data$BMI, 1),\n    trend = calculate_trend(data$Weight),\n    days_tracked = nrow(data)\n  )\n})\n```\n:::\n\n\n## 安全与最佳实践\n\n### API 密钥管理\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 安全的 API 密钥处理（仅限会话存储）\nobserveEvent(input$get_ai_suggestion, {\n  if (is.null(input$api_key) || input$api_key == \"\") {\n    showNotification(get_text(\"please_provide_api_key\"), type = \"error\")\n    return()\n  }\n\n  # 使用会话中的 API 密钥（不持久化）\n  withBusyIndicator(\"正在获取 AI 建议...\", {\n    suggestion <- get_ai_suggestion(\n      weight_data = weight_data(),\n      api_key = input$api_key,\n      model = input$ai_model,\n      provider = input$ai_provider\n    )\n\n    output$ai_response <- renderUI({\n      div(class = \"markdown-content\",\n          HTML(markdown::renderMarkdown(suggestion))\n      )\n    })\n  })\n})\n```\n:::\n\n\n### 错误处理\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 全面的错误处理\nget_ai_suggestion <- function(...) {\n  tryCatch({\n    # API 调用逻辑\n    response <- ellmer::chat_completion(...)\n    return(response$choices[[1]]$message$content)\n  }, error = function(e) {\n    # 错误日志记录和用户反馈\n    log_error(paste(\"AI API 错误:\", e$message))\n    return(get_text(\"ai_error_check_config\"))\n  })\n}\n```\n:::\n\n\n## 使用示例与用户工作流\n\n### 每日体重追踪工作流\n1. 在浏览器中打开应用程序。\n2. 查看当前体重趋势图和 BMI 图表。\n3. 通过 Excel 上传添加新的体重数据。\n4. 获取 AI 驱动的健康建议。\n5. 下载更新后的数据供离线使用。\n\n### 多语言使用\n1. 使用右上角的按钮在 EN/中文 之间切换。\n2. 所有 UI 元素动态更新。\n3. AI 提示词适配所选语言。\n4. 图表和数据保持语境一致。\n\n## 技术成就\n\n### 核心创新\n1. **实时 Excel 同步**：数据更改时 UI 自动更新。\n2. **多服务商 AI 集成**：灵活的 AI 服务商切换。\n3. **完善的国际化**：完整的双语支持。\n4. **专业 UI 设计**：基于 Bootstrap 的响应式布局。\n5. **交互式可视化**：可缩放、可悬停的 Plotly 图表。\n\n### 性能指标\n- **数据刷新**：1 秒轮询间隔。\n- **图表渲染**：典型数据集渲染时间 < 100ms。\n- **API 响应**：AI 建议响应时间为 2-5 秒。\n- **内存占用**：1000+ 条记录下内存占用 < 50MB。\n\n## 未来增强方向\n\n下一版本的潜在改进点：\n\n1. **数据库集成**：将 Excel 替换为 SQLite/PostgreSQL。\n2. **用户认证**：支持多用户，实现个人数据隔离。\n3. **移动端优化**：为移动设备提供 PWA 特性。\n4. **高级分析**：使用时间序列构建体重预测模型。\n5. **集成 API**：连接健身追踪器和健康应用。\n\n## 结论\n\n这款体重追踪应用展示了将 R Shiny 的响应式编程与现代 AI 技术相结合的强大力量。项目展示了：\n\n- **精细的数据管理**：实时文件监控和响应式更新。\n- **AI 集成**：集成多服务商并提供个性化健康建议。\n- **国际化**：完整的双语实现。\n- **专业的 UI/UX**：现代响应式设计配合交互式可视化。\n\n无论您是关注健康监测、数据可视化，还是 AI 集成，本项目都为您提供了一个使用 R Shiny 构建生产级 Web 应用的绝佳范例。\n\n\n---\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}