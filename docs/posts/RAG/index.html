<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Tony D">
<meta name="dcterms.date" content="2025-11-02">

<title>R 和 Python 中的检索增强生成 (RAG) – 由 AI 驱动</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../favicon.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark-b758ccaa5987ceb1b75504551e579abf.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-d7ae91b437850ec40fb8359b7ecc6ae0.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark-cb06e9681ca458196cadc2b80eccd21f.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="../../site_libs/bootstrap/bootstrap-d7ae91b437850ec40fb8359b7ecc6ae0.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-9NBJ66WLRT"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-9NBJ66WLRT', { 'anonymize_ip': true});
</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">由 AI 驱动</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">主页</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">手册</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-">    
        <li>
    <a class="dropdown-item" href="https://jcwinning.github.io/Into_sql/">
 <span class="dropdown-text">SQL 手册</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://jcfly3000.github.io/Into-R/">
 <span class="dropdown-text">R 手册</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://jcfly3000.github.io/Into-Python/">
 <span class="dropdown-text">Python 手册</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://jcwinning.github.io/into_ml/">
 <span class="dropdown-text">机器学习手册</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://tonyfly3000.github.io/tensorflowing/">
 <span class="dropdown-text">TensorFlow 手册</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://jcfly3000.github.io/into_AI/">
 <span class="dropdown-text">AI 手册</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../../posts.html"> 
<span class="menu-text">博客</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../cv.html"> 
<span class="menu-text">CV / 简历</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/JCwinning"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../index.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#简介" id="toc-简介" class="nav-link active" data-scroll-target="#简介">简介</a></li>
  <li><a href="#数据采集" id="toc-数据采集" class="nav-link" data-scroll-target="#数据采集">数据采集</a></li>
  <li><a href="#将网页内容保存到本地" id="toc-将网页内容保存到本地" class="nav-link" data-scroll-target="#将网页内容保存到本地">将网页内容保存到本地</a></li>
  <li><a href="#检索" id="toc-检索" class="nav-link" data-scroll-target="#检索">检索</a></li>
  <li><a href="#结合-rag-进行聊天-chat-with-rag" id="toc-结合-rag-进行聊天-chat-with-rag" class="nav-link" data-scroll-target="#结合-rag-进行聊天-chat-with-rag">结合 RAG 进行聊天 (Chat with RAG)</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content column-page-left" id="quarto-document-content">


<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">R 和 Python 中的检索增强生成 (RAG)</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
  <div class="quarto-categories">
    <div class="quarto-category">AI</div>
    <div class="quarto-category">API</div>
    <div class="quarto-category">tutorial</div>
  </div>
  </div>



<div class="quarto-title-meta column-page-left">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Tony D </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">November 2, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="简介" class="level1">
<h1>简介</h1>
<p>检索增强生成 (Retrieval-Augmented Generation, RAG) 是一种强大的技术，它将大型语言模型 (LLM) 的生成能力与信息检索的精准性相结合。通过将 LLM 的响应锚定在外部、可验证的数据中，RAG 减少了幻觉，并使模型能够回答关于特定、私有或最新信息的问题。</p>
<p>在本教程中，我们将使用 R 和 Python 构建一个 RAG 系统。</p>
<p>在 R 中，我们将利用 <code>ragnar</code> 包处理 RAG 工作流，并使用 <code>ellmer</code> 提供聊天界面。</p>
<p>在 Python 中，我们将使用 <code>LangChain</code> 构建 RAG 流水线，使用 <code>ChromaDB</code> 作为向量数据库，并使用 <code>OpenAI</code> 进行模型交互。</p>
<p>我们的目标是创建一个系统，通过爬取 OpenRouter API 的文档，来回答与其相关的问题。</p>
</section>
<section id="数据采集" class="level1">
<h1>数据采集</h1>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true" href="">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false" href="">Python</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<p>首先，我们需要为知识库收集数据。我们将使用 <code>rvest</code> 包从 OpenRouter 文档中爬取 URL。这将为我们提供待接入的页面列表。</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ragnar)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ellmer)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dotenv)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">load_dot_env</span>(<span class="at">file =</span> <span class="st">".env"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rvest)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 待爬取的 URL</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>url <span class="ot">&lt;-</span> <span class="st">"https://openrouter.ai/docs/quickstart"</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 读取页面的 HTML 内容</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>page <span class="ot">&lt;-</span> <span class="fu">read_html</span>(url)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 提取所有带有 href 的 &lt;a&gt; 标签</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>links <span class="ot">&lt;-</span> page <span class="sc">%&gt;%</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">html_nodes</span>(<span class="st">"a"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">html_attr</span>(<span class="st">"href"</span>)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="co"># 移除空值和重复项</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>links <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">na.omit</span>(links))</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="co"># 可选：仅保留完整 URL</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>links_full <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"https://openrouter.ai"</span>, links[<span class="fu">grepl</span>(<span class="st">"^/docs/"</span>, links)])</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="co"># 打印所有链接</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(links_full)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "https://openrouter.ai/docs/api-reference/overview"                               
 [2] "https://openrouter.ai/docs/quickstart"                                           
 [3] "https://openrouter.ai/docs/api/reference/overview"                               
 [4] "https://openrouter.ai/docs/sdks/agentic-usage"                                   
 [5] "https://openrouter.ai/docs/guides/overview/principles"                           
 [6] "https://openrouter.ai/docs/guides/overview/models"                               
 [7] "https://openrouter.ai/docs/faq"                                                  
 [8] "https://openrouter.ai/docs/guides/overview/report-feedback"                      
 [9] "https://openrouter.ai/docs/guides/routing/model-fallbacks"                       
[10] "https://openrouter.ai/docs/guides/routing/provider-selection"                    
[11] "https://openrouter.ai/docs/guides/features/presets"                              
[12] "https://openrouter.ai/docs/guides/features/tool-calling"                         
[13] "https://openrouter.ai/docs/guides/features/structured-outputs"                   
[14] "https://openrouter.ai/docs/guides/features/message-transforms"                   
[15] "https://openrouter.ai/docs/guides/features/zero-completion-insurance"            
[16] "https://openrouter.ai/docs/guides/features/zdr"                                  
[17] "https://openrouter.ai/docs/app-attribution"                                      
[18] "https://openrouter.ai/docs/guides/features/guardrails"                           
[19] "https://openrouter.ai/docs/faq#how-are-rate-limits-calculated"                   
[20] "https://openrouter.ai/docs/api/reference/streaming"                              
[21] "https://openrouter.ai/docs/guides/community/frameworks-and-integrations-overview"</code></pre>
</div>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<p>首先，我们需要为知识库收集数据。我们将使用 <code>requests</code> 和 <code>BeautifulSoup</code> 从 OpenRouter 文档中爬取 URL。这将为我们提供待接入的页面列表。</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(sys.executable)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>/Library/Frameworks/Python.framework/Versions/3.13/bin/python3</code></pre>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> bs4 <span class="im">import</span> BeautifulSoup</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dotenv <span class="im">import</span> load_dotenv</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> markitdown <span class="im">import</span> MarkItDown</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> io <span class="im">import</span> BytesIO</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 加载环境变量</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>load_dotenv()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>True</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 辅助函数</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fetch_html(url: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">bytes</span>:</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""从 URL 获取 HTML 内容并以字节形式返回。"""</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    resp <span class="op">=</span> requests.get(url)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    resp.raise_for_status()</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> resp.content</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> html_to_markdown(html_bytes: <span class="bu">bytes</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""使用 MarkItDown 将 HTML 字节转换为 Markdown。"""</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    md <span class="op">=</span> MarkItDown()</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    stream <span class="op">=</span> BytesIO(html_bytes)</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> md.convert_stream(stream, mime_type<span class="op">=</span><span class="st">"text/html"</span>)</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result.markdown</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> save_markdown(md_content: <span class="bu">str</span>, output_path: <span class="bu">str</span>):</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""将 Markdown 内容保存到文件。"""</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(output_path, <span class="st">"w"</span>, encoding<span class="op">=</span><span class="st">"utf-8"</span>) <span class="im">as</span> f:</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>        f.write(md_content)</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sanitize_filename(filename: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""清理 URL 以创建合法的文件名。"""</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>    filename <span class="op">=</span> re.sub(<span class="vs">r'</span><span class="dv">^</span><span class="vs">https</span><span class="op">?</span><span class="vs">://</span><span class="pp">[^/]</span><span class="op">+</span><span class="vs">'</span>, <span class="st">''</span>, filename)</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>    filename <span class="op">=</span> re.sub(<span class="vs">r'</span><span class="pp">[^</span><span class="dv">\w</span><span class="ch">\-</span><span class="pp">_.]</span><span class="vs">'</span>, <span class="st">'_'</span>, filename)</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    filename <span class="op">=</span> filename.strip(<span class="st">'_'</span>)</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> filename.endswith(<span class="st">'.md'</span>):</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>        filename <span class="op">+=</span> <span class="st">'.md'</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> filename</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a><span class="co"># 待爬取的 URL</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">"https://openrouter.ai/docs/quickstart"</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a><span class="co"># 读取页面的 HTML 内容</span></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>response <span class="op">=</span> requests.get(url)</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>soup <span class="op">=</span> BeautifulSoup(response.content, <span class="st">'html.parser'</span>)</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a><span class="co"># 提取所有带有 href 的 &lt;a&gt; 标签</span></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>links <span class="op">=</span> [a[<span class="st">'href'</span>] <span class="cf">for</span> a <span class="kw">in</span> soup.find_all(<span class="st">'a'</span>, href<span class="op">=</span><span class="va">True</span>)]</span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a><span class="co"># 移除重复项</span></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>links <span class="op">=</span> <span class="bu">list</span>(<span class="bu">set</span>(links))</span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a><span class="co"># 仅保留文档的完整 URL</span></span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>links_full <span class="op">=</span> [<span class="ss">f"https://openrouter.ai</span><span class="sc">{</span>link<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> link <span class="kw">in</span> links <span class="cf">if</span> link.startswith(<span class="st">"/docs/"</span>)]</span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a><span class="co"># 显式添加 FAQ</span></span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>links_full.append(<span class="st">"https://openrouter.ai/docs/faq"</span>)</span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>links_full <span class="op">=</span> <span class="bu">list</span>(<span class="bu">set</span>(links_full))</span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a><span class="co"># 打印所有链接</span></span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"找到 </span><span class="sc">{</span><span class="bu">len</span>(links_full)<span class="sc">}</span><span class="ss"> 个文档 URL"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>找到 21 个文档 URL</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(links_full)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>['https://openrouter.ai/docs/faq', 'https://openrouter.ai/docs/sdks/agentic-usage', 'https://openrouter.ai/docs/guides/features/message-transforms', 'https://openrouter.ai/docs/api/reference/overview', 'https://openrouter.ai/docs/guides/overview/principles', 'https://openrouter.ai/docs/guides/overview/report-feedback', 'https://openrouter.ai/docs/api-reference/overview', 'https://openrouter.ai/docs/quickstart', 'https://openrouter.ai/docs/guides/community/frameworks-and-integrations-overview', 'https://openrouter.ai/docs/guides/routing/provider-selection', 'https://openrouter.ai/docs/guides/features/structured-outputs', 'https://openrouter.ai/docs/faq#how-are-rate-limits-calculated', 'https://openrouter.ai/docs/guides/features/presets', 'https://openrouter.ai/docs/guides/routing/model-fallbacks', 'https://openrouter.ai/docs/guides/features/guardrails', 'https://openrouter.ai/docs/api/reference/streaming', 'https://openrouter.ai/docs/guides/features/zdr', 'https://openrouter.ai/docs/app-attribution', 'https://openrouter.ai/docs/guides/features/tool-calling', 'https://openrouter.ai/docs/guides/overview/models', 'https://openrouter.ai/docs/guides/features/zero-completion-insurance']</code></pre>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="将网页内容保存到本地" class="level1">
<h1>将网页内容保存到本地</h1>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-2-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-1" role="tab" aria-controls="tabset-2-1" aria-selected="true" href="">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-2" role="tab" aria-controls="tabset-2-2" aria-selected="false" href="">Python DuckDB</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-3" role="tab" aria-controls="tabset-2-3" aria-selected="false" href="">Python Chroma</a></li></ul>
<div class="tab-content">
<div id="tabset-2-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-2-1-tab">
<p>为了进行语义搜索，我们需要将文本数据存储为向量（嵌入）。我们将使用 <code>DuckDB</code> 作为本地向量数据库。我们还需要一个嵌入模型将文本转换为向量。在这里，我们配置 <code>ragnar</code> 通过 OpenAI 兼容的 API (SiliconFlow) 使用特定的嵌入模型。</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># pages &lt;- ragnar_find_links(base_url)</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>pages <span class="ot">&lt;-</span> links_full</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>store_location <span class="ot">&lt;-</span> <span class="st">"openrouter.duckdb"</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>store <span class="ot">&lt;-</span> <span class="fu">ragnar_store_create</span>(</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    store_location,</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">overwrite =</span> <span class="cn">TRUE</span>,</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">embed =</span> \(x) ragnar<span class="sc">::</span><span class="fu">embed_openai</span>(x,</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">model =</span> <span class="st">"BAAI/bge-m3"</span>,</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">base_url =</span> <span class="st">"https://api.siliconflow.cn/v1"</span>,</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">api_key =</span> <span class="fu">Sys.getenv</span>(<span class="st">"siliconflow"</span>)</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>在存储初始化后，我们现在可以接入数据。我们遍历之前爬取的页面列表。对于每个页面，我们： 1. 以 Markdown 格式读取内容。 2. 将内容拆分为较小的块（约 600 字符）。 3. 将这些块插入到我们的向量数据库中。</p>
<p>此过程构建了我们将要搜索的索引。</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># page="https://openrouter.ai/docs/faq"</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="co"># chunks &lt;- page |&gt;read_as_markdown() |&gt;markdown_chunk(target_size = 2000)</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ragnar_chunks_view(chunks)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (page <span class="cf">in</span> pages) {</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"正在接入: "</span>, page)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(page)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    chunks <span class="ot">&lt;-</span> page <span class="sc">|&gt;</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">read_as_markdown</span>() <span class="sc">|&gt;</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">markdown_chunk</span>(<span class="at">target_size =</span> <span class="dv">2000</span>)</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># print(chunks)</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># print('chunks done')</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ragnar_store_insert</span>(store, chunks)</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="st">"插入完成"</span>)</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ragnar_store_build_index</span>(store)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 释放连接以供后续 Python 代码使用</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(store)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="fu">gc</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</div>
<div id="tabset-2-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-2-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> llama_index.core <span class="im">import</span> SimpleDirectoryReader, VectorStoreIndex, StorageContext, Settings</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> llama_index.vector_stores.duckdb <span class="im">import</span> DuckDBVectorStore</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> llama_index.embeddings.openai <span class="im">import</span> OpenAIEmbedding</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 1. 配置 ---</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 确保 API 密钥可用</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>openrouter_api_key <span class="op">=</span> os.getenv(<span class="st">"OPENROUTER_API_KEY"</span>) <span class="co"># 或直接粘贴字符串</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 初始化指向 OpenRouter 的嵌入模型</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a><span class="co"># 我们使用 OpenAI 类，因为 OpenRouter 使用了 OpenAI 兼容的 API 结构</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>embed_model <span class="op">=</span> OpenAIEmbedding(</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>    api_key<span class="op">=</span>openrouter_api_key,</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>    base_url<span class="op">=</span><span class="st">"https://openrouter.ai/api/v1"</span>,</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span><span class="st">"qwen/qwen3-embedding-8b"</span>  </span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a><span class="co"># 更新全局设置，以便 LlamaIndex 知道使用此模型</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>Settings.embed_model <span class="op">=</span> embed_model</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>Settings.chunk_size <span class="op">=</span> <span class="dv">2000</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>Settings.chunk_overlap <span class="op">=</span> <span class="dv">200</span></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 2. 接入与索引 ---</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a><span class="co"># 加载数据</span></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>documents <span class="op">=</span> SimpleDirectoryReader(<span class="st">"markdown_docs"</span>).load_data()</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a><span class="co"># 初始化 DuckDB 向量数据库</span></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>vector_store <span class="op">=</span> DuckDBVectorStore(<span class="st">"openrouter.duckdb"</span>, persist_dir<span class="op">=</span><span class="st">"./persist/"</span>)</span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>storage_context <span class="op">=</span> StorageContext.from_defaults(vector_store<span class="op">=</span>vector_store)</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a><span class="co"># 创建索引</span></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a><span class="co"># 这将自动使用 Settings 中定义的 Qwen 嵌入</span></span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>index <span class="op">=</span> VectorStoreIndex.from_documents(</span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>    documents, </span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>    storage_context<span class="op">=</span>storage_context</span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</div>
<div id="tabset-2-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-3-tab">
<p>为了进行语义搜索，我们需要将文本数据转换为向量（嵌入）进行存储。我们将使用 <code>ChromaDB</code> 作为本地向量数据库。我们还需要一个嵌入模型把文本转为向量。在这里，我们配置了一个自定义的 <code>OpenRouterEmbeddings</code> 类，通过 OpenRouter API 使用 <code>qwen/qwen3-embedding-8b</code> 模型。</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> openai <span class="im">import</span> OpenAI</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain_core.embeddings <span class="im">import</span> Embeddings</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain_chroma <span class="im">import</span> Chroma</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dotenv <span class="im">import</span> load_dotenv</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>load_dotenv()</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 针对 OpenRouter API 的自定义嵌入类</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> OpenRouterEmbeddings(Embeddings):</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""针对 OpenRouter API 的自定义嵌入类。"""</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, api_key: <span class="bu">str</span>, model: <span class="bu">str</span> <span class="op">=</span> <span class="st">"text-embedding-3-small"</span>):</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.client <span class="op">=</span> OpenAI(</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>            base_url<span class="op">=</span><span class="st">"https://openrouter.ai/api/v1"</span>,</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>            api_key<span class="op">=</span>api_key,</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model <span class="op">=</span> model</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> embed_documents(<span class="va">self</span>, texts: List[<span class="bu">str</span>]) <span class="op">-&gt;</span> List[List[<span class="bu">float</span>]]:</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""对文档列表进行嵌入。"""</span></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> <span class="va">self</span>.client.embeddings.create(</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>            extra_headers<span class="op">=</span>{</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>                <span class="st">"HTTP-Referer"</span>: <span class="st">"https://ai-blog.com"</span>,</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>                <span class="st">"X-Title"</span>: <span class="st">"AI Blog RAG"</span>,</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>            model<span class="op">=</span><span class="va">self</span>.model,</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>            <span class="bu">input</span><span class="op">=</span>texts,</span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>            encoding_format<span class="op">=</span><span class="st">"float"</span></span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [item.embedding <span class="cf">for</span> item <span class="kw">in</span> response.data]</span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> embed_query(<span class="va">self</span>, text: <span class="bu">str</span>) <span class="op">-&gt;</span> List[<span class="bu">float</span>]:</span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""对单个查询进行嵌入。"""</span></span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> <span class="va">self</span>.client.embeddings.create(</span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>            extra_headers<span class="op">=</span>{</span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>                <span class="st">"HTTP-Referer"</span>: <span class="st">"https://ai-blog.com"</span>,</span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>                <span class="st">"X-Title"</span>: <span class="st">"AI Blog RAG"</span>,</span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>            model<span class="op">=</span><span class="va">self</span>.model,</span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>            <span class="bu">input</span><span class="op">=</span>text,</span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>            encoding_format<span class="op">=</span><span class="st">"float"</span></span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> response.data[<span class="dv">0</span>].embedding</span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a><span class="co"># 获取 OpenRouter API 密钥</span></span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a>openrouter_api_key <span class="op">=</span> os.getenv(<span class="st">"OPENROUTER_API_KEY"</span>)</span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> openrouter_api_key:</span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"未在环境变量中找到 OPENROUTER_API_KEY"</span>)</span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true" tabindex="-1"></a><span class="co"># 使用 OpenRouter 创建嵌入实例</span></span>
<span id="cb17-53"><a href="#cb17-53" aria-hidden="true" tabindex="-1"></a>embeddings <span class="op">=</span> OpenRouterEmbeddings(</span>
<span id="cb17-54"><a href="#cb17-54" aria-hidden="true" tabindex="-1"></a>    api_key<span class="op">=</span>openrouter_api_key,</span>
<span id="cb17-55"><a href="#cb17-55" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span><span class="st">"qwen/qwen3-embedding-8b"</span></span>
<span id="cb17-56"><a href="#cb17-56" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-57"><a href="#cb17-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-58"><a href="#cb17-58" aria-hidden="true" tabindex="-1"></a><span class="co"># 定义向量数据库位置</span></span>
<span id="cb17-59"><a href="#cb17-59" aria-hidden="true" tabindex="-1"></a>persist_directory <span class="op">=</span> <span class="st">"chroma_db_data"</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>在存储初始化后，我们现在可以接入数据。我们遍历之前保存的 Markdown 文件。对于每个文件，我们： 1. 加载内容。 2. 使用 <code>RecursiveCharacterTextSplitter</code> 将内容拆分为较小的块（约 2000 字符）。 3. 从这些块中创建一个新的 <code>Chroma</code> 向量数据库。</p>
<p>此过程构建了我们将要搜索的索引。</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain_core.documents <span class="im">import</span> Document</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain_text_splitters <span class="im">import</span> RecursiveCharacterTextSplitter</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> shutil</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 加载 Markdown 文件的辅助函数</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> load_markdown_files(directory: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">list</span>[Document]:</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""从目录加载所有 Markdown 文件并创建 Document 对象。"""</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    documents <span class="op">=</span> []</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(directory):</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> documents</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> filename <span class="kw">in</span> os.listdir(directory):</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> filename.endswith(<span class="st">'.md'</span>):</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>            filepath <span class="op">=</span> os.path.join(directory, filename)</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>            <span class="cf">with</span> <span class="bu">open</span>(filepath, <span class="st">'r'</span>, encoding<span class="op">=</span><span class="st">'utf-8'</span>) <span class="im">as</span> f:</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>                content <span class="op">=</span> f.read()</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>                doc <span class="op">=</span> Document(</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>                    page_content<span class="op">=</span>content,</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>                    metadata<span class="op">=</span>{</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"source"</span>: filename,</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"filepath"</span>: filepath</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>                    }</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>                documents.append(doc)</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> documents</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a><span class="co"># 创建 Markdown 文件的输出目录</span></span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>output_dir <span class="op">=</span> <span class="st">"markdown_docs"</span></span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>os.makedirs(output_dir, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a><span class="co"># 将每个 URL 转换为 Markdown 并保存</span></span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, link_url <span class="kw">in</span> <span class="bu">enumerate</span>(links_full, <span class="dv">1</span>):</span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"正在处理 </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(links_full)<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>link_url<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>        html_content <span class="op">=</span> fetch_html(link_url)</span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>        markdown_content <span class="op">=</span> html_to_markdown(html_content)</span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>        filename <span class="op">=</span> sanitize_filename(link_url)</span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>        output_path <span class="op">=</span> os.path.join(output_dir, filename)</span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a>        save_markdown(markdown_content, output_path)</span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  ✓ 已保存至 </span><span class="sc">{</span>output_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  ✗ 处理 </span><span class="sc">{</span>link_url<span class="sc">}</span><span class="ss"> 时出错: </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a><span class="co"># 加载 Markdown 文档</span></span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a>documents <span class="op">=</span> load_markdown_files(output_dir)</span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">加载了 </span><span class="sc">{</span><span class="bu">len</span>(documents)<span class="sc">}</span><span class="ss"> 个 Markdown 文档"</span>)</span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a><span class="co"># 将文档拆分为块</span></span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a>text_splitter <span class="op">=</span> RecursiveCharacterTextSplitter(</span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a>    chunk_size<span class="op">=</span><span class="dv">2000</span>,</span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a>    chunk_overlap<span class="op">=</span><span class="dv">200</span>,</span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a>    length_function<span class="op">=</span><span class="bu">len</span>,</span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a>    is_separator_regex<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb18-54"><a href="#cb18-54" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-55"><a href="#cb18-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-56"><a href="#cb18-56" aria-hidden="true" tabindex="-1"></a>splits <span class="op">=</span> text_splitter.split_documents(documents)</span>
<span id="cb18-57"><a href="#cb18-57" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"拆分为 </span><span class="sc">{</span><span class="bu">len</span>(splits)<span class="sc">}</span><span class="ss"> 个块"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 如果数据库已存在，则将其移除</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> os.path.exists(persist_directory):</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"正在移除位于 </span><span class="sc">{</span>persist_directory<span class="sc">}</span><span class="ss"> 的现有数据库..."</span>)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    shutil.rmtree(persist_directory)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 创建新的向量数据库</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>vectorstore <span class="op">=</span> Chroma.from_documents(</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    documents<span class="op">=</span>splits,</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    embedding<span class="op">=</span>embeddings,</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    persist_directory<span class="op">=</span>persist_directory</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">✓ 成功创建了包含 </span><span class="sc">{</span><span class="bu">len</span>(splits)<span class="sc">}</span><span class="ss"> 个块的 ChromaDB！"</span>)</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ 数据库已保存至: </span><span class="sc">{</span>persist_directory<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="检索" class="level1">
<h1>检索</h1>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-3-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-1" role="tab" aria-controls="tabset-3-1" aria-selected="true" href="">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-2" role="tab" aria-controls="tabset-3-2" aria-selected="false" href="">Python DuckDB</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-3" role="tab" aria-controls="tabset-3-3" aria-selected="false" href="">Python Chroma</a></li></ul>
<div class="tab-content">
<div id="tabset-3-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-3-1-tab">
<p>现在我们的知识库已经填充完毕，我们可以测试检索系统。我们可以提出一个特定的问题，例如“什么是模型变体？(What are model variants?)”，并查询存储库以查看哪些文本块最相关。这确认了我们的嵌入和搜索是否正常工作。</p>
<section id="问题什么是模型变体what-are-model-variants" class="level3">
<h3 class="anchored" data-anchor-id="问题什么是模型变体what-are-model-variants">问题：什么是模型变体？(What are model variants?)</h3>
<p>RAG 结果：</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>store_location <span class="ot">&lt;-</span> <span class="st">"openrouter.duckdb"</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>text <span class="ot">&lt;-</span> <span class="st">"What are model variants?"</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>relevant_chunks <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    store <span class="ot">&lt;-</span> <span class="fu">ragnar_store_connect</span>(store_location)</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ragnar_retrieve</span>(store, text, <span class="at">top_k =</span> <span class="dv">3</span>)</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>}, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"⚠️ 无法连接到 DuckDB (可能被锁定): "</span>, e<span class="sc">$</span>message)</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(relevant_chunks)) {</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"检索到"</span>, <span class="fu">nrow</span>(relevant_chunks), <span class="st">"个文本块：</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">nrow</span>(relevant_chunks))) {</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"--- 块 %d ---</span><span class="sc">\n</span><span class="st">%s</span><span class="sc">\n\n</span><span class="st">"</span>, i, relevant_chunks<span class="sc">$</span>text[i]))</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"知识库当前不可用（由于数据库锁定）。"</span>)</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>检索到 6 个文本块：

--- 块 1 ---
[Zero Completion Insurance](/docs/features/zero-completion-insurance)
  + [Provisioning API Keys](/docs/features/provisioning-api-keys)
  + [App Attribution](/docs/app-attribution)
* API Reference

  + [Overview](/docs/api-reference/overview)
  + [Streaming](/docs/api-reference/streaming)
  + [Embeddings](/docs/api-reference/embeddings)
  + [Limits](/docs/api-reference/limits)
  + [Authentication](/docs/api-reference/authentication)
  + [Parameters](/docs/api-reference/parameters)
  + [Errors](/docs/api-reference/errors)
  + Responses API
  + beta.responses
  + Analytics
  + Credits
  + Embeddings
  + Generations
  + Models
  + Endpoints
  + Parameters
  + Providers
  + API Keys
  + O Auth
  + Chat
  + Completions
* SDK Reference (BETA)

  + [Python SDK](/docs/sdks/python)
  + [TypeScript SDK](/docs/sdks/typescript)
* Use Cases

  + [BYOK](/docs/use-cases/byok)
  + [Crypto API](/docs/use-cases/crypto-api)
  + [OAuth PKCE](/docs/use-cases/oauth-pkce)
  + [MCP Servers](/docs/use-cases/mcp-servers)
  + [Organization Management](/docs/use-cases/organization-management)
  + [For Providers](/docs/use-cases/for-providers)
  + [Reasoning Tokens](/docs/use-cases/reasoning-tokens)
  + [Usage Accounting](/docs/use-cases/usage-accounting)
  + [User Tracking](/docs/use-cases/user-tracking)
* Community

  + [Frameworks and Integrations Overview](/docs/community/frameworks-and-integrations-overview)
  + [Effect AI SDK](/docs/community/effect-ai-sdk)
  + [Arize](/docs/community/arize)
  + [LangChain](/docs/community/lang-chain)
  + [LiveKit](/docs/community/live-kit)
  + [Langfuse](/docs/community/langfuse)
  + [Mastra](/docs/community/mastra)
  + [OpenAI SDK](/docs/community/open-ai-sdk)
  + [PydanticAI](/docs/community/pydantic-ai)
  + [Vercel AI SDK](/docs/community/vercel-ai-sdk)
  + [Xcode](/docs/community/xcode)
  + [Zapier](/docs/community/zapier)
  + [Discord](https://discord.gg/openrouter)

Light

On this page

* [Requests](#requests)
* [Completions Request Format](#completions-request-format)
* [Headers](#headers)
* [Assistant Prefill](#assistant-prefill)
* [Responses](#responses)
* [CompletionsResponse Format](#completionsresponse-format)
* [Finish Reason](#finish-reason)
* [Querying Cost and Stats](#querying-cost-and-stats)

[API Reference](/docs/api-reference/overview)



--- 块 2 ---
###### How frequently are new models added?

We work on adding models as quickly as we can. We often have partnerships with
the labs releasing models and can release models as soon as they are
available. If there is a model missing that you’d like OpenRouter to support, feel free to message us on
[Discord](https://discord.gg/openrouter).

###### What are model variants?

Variants are suffixes that can be added to the model slug to change its behavior.

Static variants can only be used with specific models and these are listed in our [models api](https://openrouter.ai/api/v1/models).

1. `:free` - The model is always provided for free and has low rate limits.
2. `:beta` - The model is not moderated by OpenRouter.
3. `:extended` - The model has longer than usual context length.
4. `:exacto` - The model only uses OpenRouter-curated high-quality endpoints.
5. `:thinking` - The model supports reasoning by default.

Dynamic variants can be used on all models and they change the behavior of how the request is routed or used.

1. `:online` - All requests will run a query to extract web results that are attached to the prompt.
2. `:nitro` - Providers will be sorted by throughput rather than the default sort, optimizing for faster response times.
3. `:floor` - Providers will be sorted by price rather than the default sort, prioritizing the most cost-effective options.

###### I am an inference provider, how can I get listed on OpenRouter?

You can read our requirements at the [Providers
page](/docs/use-cases/for-providers). If you would like to contact us, the best
place to reach us is over email.

###### What is the expected latency/response time for different models?

For each model on OpenRouter we show the latency (time to first token) and the token
throughput for all providers. You can use this to estimate how long requests
will take. If you would like to optimize for throughput you can use the
`:nitro` variant to route to the fastest provider.



--- 块 3 ---
###### How frequently are new models added?

We work on adding models as quickly as we can. We often have partnerships with
the labs releasing models and can release models as soon as they are
available. If there is a model missing that you’d like OpenRouter to support, feel free to message us on
[Discord](https://discord.gg/openrouter).

###### What are model variants?

Variants are suffixes that can be added to the model slug to change its behavior.

Static variants can only be used with specific models and these are listed in our [models api](https://openrouter.ai/api/v1/models).

1. `:free` - The model is always provided for free and has low rate limits.
2. `:beta` - The model is not moderated by OpenRouter.
3. `:extended` - The model has longer than usual context length.
4. `:exacto` - The model only uses OpenRouter-curated high-quality endpoints.
5. `:thinking` - The model supports reasoning by default.

Dynamic variants can be used on all models and they change the behavior of how the request is routed or used.

1. `:online` - All requests will run a query to extract web results that are attached to the prompt.
2. `:nitro` - Providers will be sorted by throughput rather than the default sort, optimizing for faster response times.
3. `:floor` - Providers will be sorted by price rather than the default sort, prioritizing the most cost-effective options.

###### I am an inference provider, how can I get listed on OpenRouter?

You can read our requirements at the [Providers
page](/docs/use-cases/for-providers). If you would like to contact us, the best
place to reach us is over email.

###### What is the expected latency/response time for different models?

For each model on OpenRouter we show the latency (time to first token) and the token
throughput for all providers. You can use this to estimate how long requests
will take. If you would like to optimize for throughput you can use the
`:nitro` variant to route to the fastest provider.



--- 块 4 ---
## The `models` parameter

The `models` parameter lets you automatically try other models if the primary model’s providers are down, rate-limited, or refuse to reply due to content moderation.

TypeScript SDKTypeScript (fetch)Python

```code-block-root not-prose rounded-b-[inherit] rounded-t-none
|  |  |
| --- | --- |
| 1 | import { OpenRouter } from '@openrouter/sdk'; |
| 2 |  |
| 3 | const openRouter = new OpenRouter({ |
| 4 | apiKey: '&lt;OPENROUTER_API_KEY&gt;', |
| 5 | }); |
| 6 |  |
| 7 | const completion = await openRouter.chat.send({ |
| 8 | models: ['anthropic/claude-3.5-sonnet', 'gryphe/mythomax-l2-13b'], |
| 9 | messages: [ |
| 10 | { |
| 11 | role: 'user', |
| 12 | content: 'What is the meaning of life?', |
| 13 | }, |
| 14 | ], |
| 15 | }); |
| 16 |  |
| 17 | console.log(completion.choices[0].message.content); |
```

If the model you selected returns an error, OpenRouter will try to use the fallback model instead. If the fallback model is down or returns an error, OpenRouter will return that error.

By default, any error can trigger the use of a fallback model, including context length validation errors, moderation flags for filtered models, rate-limiting, and downtime.

Requests are priced using the model that was ultimately used, which will be returned in the `model` attribute of the response body.

## Using with OpenAI SDK

To use the `models` array with the OpenAI SDK, include it in the `extra_body` parameter. In the example below, gpt-4o will be tried first, and the `models` array will be tried in order as fallbacks.

PythonTypeScript



--- 块 5 ---
[Web Search](/docs/features/web-search)
  + [Zero Completion Insurance](/docs/features/zero-completion-insurance)
  + [Provisioning API Keys](/docs/features/provisioning-api-keys)
  + [App Attribution](/docs/app-attribution)
* API Reference

  + [Overview](/docs/api-reference/overview)
  + [Streaming](/docs/api-reference/streaming)
  + [Embeddings](/docs/api-reference/embeddings)
  + [Limits](/docs/api-reference/limits)
  + [Authentication](/docs/api-reference/authentication)
  + [Parameters](/docs/api-reference/parameters)
  + [Errors](/docs/api-reference/errors)
  + Responses API
  + beta.responses
  + Analytics
  + Credits
  + Embeddings
  + Generations
  + Models
  + Endpoints
  + Parameters
  + Providers
  + API Keys
  + O Auth
  + Chat
  + Completions
* SDK Reference (BETA)

  + [Python SDK](/docs/sdks/python)
  + [TypeScript SDK](/docs/sdks/typescript)
* Use Cases

  + [BYOK](/docs/use-cases/byok)
  + [Crypto API](/docs/use-cases/crypto-api)
  + [OAuth PKCE](/docs/use-cases/oauth-pkce)
  + [MCP Servers](/docs/use-cases/mcp-servers)
  + [Organization Management](/docs/use-cases/organization-management)
  + [For Providers](/docs/use-cases/for-providers)
  + [Reasoning Tokens](/docs/use-cases/reasoning-tokens)
  + [Usage Accounting](/docs/use-cases/usage-accounting)
  + [User Tracking](/docs/use-cases/user-tracking)
* Community

  + [Frameworks and Integrations Overview](/docs/community/frameworks-and-integrations-overview)
  + [Effect AI SDK](/docs/community/effect-ai-sdk)
  + [Arize](/docs/community/arize)
  + [LangChain](/docs/community/lang-chain)
  + [LiveKit](/docs/community/live-kit)
  + [Langfuse](/docs/community/langfuse)
  + [Mastra](/docs/community/mastra)
  + [OpenAI SDK](/docs/community/open-ai-sdk)
  + [PydanticAI](/docs/community/pydantic-ai)
  + [Vercel AI SDK](/docs/community/vercel-ai-sdk)
  + [Xcode](/docs/community/xcode)
  + [Zapier](/docs/community/zapier)
  + [Discord](https://discord.gg/openrouter)

Light

On this page

* [Within OpenRouter](#within-openrouter)
* [Provider Policies](#provider-policies)
* [Training on Prompts](#training-on-prompts)
* [Data Retention &amp; Logging](#data-retention--logging)
* [Enterprise EU in-region routing](#enterprise-eu-in-region-routing)

[Features](/docs/features/privacy-and-logging)



--- 块 6 ---
[Web Search](/docs/features/web-search)
  + [Zero Completion Insurance](/docs/features/zero-completion-insurance)
  + [Provisioning API Keys](/docs/features/provisioning-api-keys)
  + [App Attribution](/docs/app-attribution)
* API Reference

  + [Overview](/docs/api-reference/overview)
  + [Streaming](/docs/api-reference/streaming)
  + [Embeddings](/docs/api-reference/embeddings)
  + [Limits](/docs/api-reference/limits)
  + [Authentication](/docs/api-reference/authentication)
  + [Parameters](/docs/api-reference/parameters)
  + [Errors](/docs/api-reference/errors)
  + Responses API
  + beta.responses
  + Analytics
  + Credits
  + Embeddings
  + Generations
  + Models
  + Endpoints
  + Parameters
  + Providers
  + API Keys
  + O Auth
  + Chat
  + Completions
* SDK Reference (BETA)

  + [Python SDK](/docs/sdks/python)
  + [TypeScript SDK](/docs/sdks/typescript)
* Use Cases

  + [BYOK](/docs/use-cases/byok)
  + [Crypto API](/docs/use-cases/crypto-api)
  + [OAuth PKCE](/docs/use-cases/oauth-pkce)
  + [MCP Servers](/docs/use-cases/mcp-servers)
  + [Organization Management](/docs/use-cases/organization-management)
  + [For Providers](/docs/use-cases/for-providers)
  + [Reasoning Tokens](/docs/use-cases/reasoning-tokens)
  + [Usage Accounting](/docs/use-cases/usage-accounting)
  + [User Tracking](/docs/use-cases/user-tracking)
* Community

  + [Frameworks and Integrations Overview](/docs/community/frameworks-and-integrations-overview)
  + [Effect AI SDK](/docs/community/effect-ai-sdk)
  + [Arize](/docs/community/arize)
  + [LangChain](/docs/community/lang-chain)
  + [LiveKit](/docs/community/live-kit)
  + [Langfuse](/docs/community/langfuse)
  + [Mastra](/docs/community/mastra)
  + [OpenAI SDK](/docs/community/open-ai-sdk)
  + [PydanticAI](/docs/community/pydantic-ai)
  + [Vercel AI SDK](/docs/community/vercel-ai-sdk)
  + [Xcode](/docs/community/xcode)
  + [Zapier](/docs/community/zapier)
  + [Discord](https://discord.gg/openrouter)

Light

On this page

* [How OpenRouter Manages Data Policies](#how-openrouter-manages-data-policies)
* [Per-Request ZDR Enforcement](#per-request-zdr-enforcement)
* [Usage](#usage)
* [Caching](#caching)
* [OpenRouter’s Retention Policy](#openrouters-retention-policy)
* [Zero Retention Endpoints](#zero-retention-endpoints)

[Features](/docs/features/privacy-and-logging)</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 释放连接以避免文件锁定</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"store"</span>)) {</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rm</span>(store)</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">gc</span>()</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>          used  (Mb) gc trigger  (Mb) limit (Mb) max used  (Mb)
Ncells 2385439 127.4    4675528 249.8         NA  3250438 173.6
Vcells 4239754  32.4   10146329  77.5      16384  5558189  42.5</code></pre>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ragnar_store_inspect(store)</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="co">#ragnar_chunks_view(chunks)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
</div>
<div id="tabset-3-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-2-tab">
<p>在 Python 中，我们可以使用 <code>LlamaIndex</code> 与我们的 DuckDB 向量数据库进行交互。在此步骤中，我们将配置嵌入模型并为查询检索前几个相关块，并将它们保存到文件中以供检查。我们暂不使用 LLM 进行生成，仅专注于验证检索质量。</p>
<section id="问题什么是模型变体what-are-model-variants-1" class="level3">
<h3 class="anchored" data-anchor-id="问题什么是模型变体what-are-model-variants-1">问题：什么是模型变体？(What are model variants?)</h3>
<p>RAG 结果：</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Python 可执行文件路径: </span><span class="sc">{</span>sys<span class="sc">.</span>executable<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Python 可执行文件路径: /Library/Frameworks/Python.framework/Versions/3.13/bin/python3</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Python 路径 (sys.path): </span><span class="sc">{</span>sys<span class="sc">.</span>path<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Python 路径 (sys.path): ['', '/Library/Frameworks/Python.framework/Versions/3.13/bin', '/Library/Frameworks/Python.framework/Versions/3.13/lib/python313.zip', '/Library/Frameworks/Python.framework/Versions/3.13/lib/python3.13', '/Library/Frameworks/Python.framework/Versions/3.13/lib/python3.13/lib-dynload', '/Library/Frameworks/Python.framework/Versions/3.13/lib/python3.13/site-packages', '/Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/library/reticulate/python']</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Any, List</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> openai <span class="im">import</span> OpenAI</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> llama_index.core <span class="im">import</span> VectorStoreIndex, Settings</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> llama_index.core.embeddings <span class="im">import</span> BaseEmbedding</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> llama_index.vector_stores.duckdb <span class="im">import</span> DuckDBVectorStore</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dotenv <span class="im">import</span> load_dotenv</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 加载环境变量</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>load_dotenv()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>True</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 确保 API 密钥可用</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>openrouter_api_key <span class="op">=</span> os.getenv(<span class="st">"OPENROUTER_API_KEY"</span>)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 针对 LlamaIndex 的自定义 OpenRouter 嵌入类</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> OpenRouterEmbedding(BaseEmbedding):</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""与 LlamaIndex 兼容的 OpenRouter API 自定义嵌入类。"""</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>,</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>        api_key: <span class="bu">str</span>,</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>        model: <span class="bu">str</span> <span class="op">=</span> <span class="st">"qwen/qwen3-embedding-8b"</span>,</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>        <span class="op">**</span>kwargs: Any</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>(<span class="op">**</span>kwargs)</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._client <span class="op">=</span> OpenAI(</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>            base_url<span class="op">=</span><span class="st">"https://openrouter.ai/api/v1"</span>,</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>            api_key<span class="op">=</span>api_key,</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._model <span class="op">=</span> model</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _get_query_embedding(<span class="va">self</span>, query: <span class="bu">str</span>) <span class="op">-&gt;</span> List[<span class="bu">float</span>]:</span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""获取查询字符串的嵌入向量。"""</span></span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> <span class="va">self</span>._client.embeddings.create(</span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>            extra_headers<span class="op">=</span>{</span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>                <span class="st">"HTTP-Referer"</span>: <span class="st">"https://ai-blog.com"</span>,</span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a>                <span class="st">"X-Title"</span>: <span class="st">"AI Blog RAG"</span>,</span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a>            model<span class="op">=</span><span class="va">self</span>._model,</span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a>            <span class="bu">input</span><span class="op">=</span>query,</span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a>            encoding_format<span class="op">=</span><span class="st">"float"</span></span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> response.data[<span class="dv">0</span>].embedding</span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _get_text_embedding(<span class="va">self</span>, text: <span class="bu">str</span>) <span class="op">-&gt;</span> List[<span class="bu">float</span>]:</span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""获取文本字符串的嵌入向量。"""</span></span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._get_query_embedding(text)</span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> _aget_query_embedding(<span class="va">self</span>, query: <span class="bu">str</span>) <span class="op">-&gt;</span> List[<span class="bu">float</span>]:</span>
<span id="cb31-39"><a href="#cb31-39" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""异步版本的 get_query_embedding。"""</span></span>
<span id="cb31-40"><a href="#cb31-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._get_query_embedding(query)</span>
<span id="cb31-41"><a href="#cb31-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-42"><a href="#cb31-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> _aget_text_embedding(<span class="va">self</span>, text: <span class="bu">str</span>) <span class="op">-&gt;</span> List[<span class="bu">float</span>]:</span>
<span id="cb31-43"><a href="#cb31-43" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""异步版本的 get_text_embedding。"""</span></span>
<span id="cb31-44"><a href="#cb31-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._get_text_embedding(text)</span>
<span id="cb31-45"><a href="#cb31-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-46"><a href="#cb31-46" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. 使用自定义 OpenRouter 类配置嵌入模型</span></span>
<span id="cb31-47"><a href="#cb31-47" aria-hidden="true" tabindex="-1"></a>embed_model <span class="op">=</span> OpenRouterEmbedding(</span>
<span id="cb31-48"><a href="#cb31-48" aria-hidden="true" tabindex="-1"></a>    api_key<span class="op">=</span>openrouter_api_key,</span>
<span id="cb31-49"><a href="#cb31-49" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span><span class="st">"qwen/qwen3-embedding-8b"</span></span>
<span id="cb31-50"><a href="#cb31-50" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-51"><a href="#cb31-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-52"><a href="#cb31-52" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. 应用设置</span></span>
<span id="cb31-53"><a href="#cb31-53" aria-hidden="true" tabindex="-1"></a>Settings.embed_model <span class="op">=</span> embed_model</span>
<span id="cb31-54"><a href="#cb31-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-55"><a href="#cb31-55" aria-hidden="true" tabindex="-1"></a><span class="co"># 加载与检索</span></span>
<span id="cb31-56"><a href="#cb31-56" aria-hidden="true" tabindex="-1"></a><span class="co"># 加载现有的 DuckDB 向量数据库</span></span>
<span id="cb31-57"><a href="#cb31-57" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"正在从 openrouter.duckdb 加载向量数据库..."</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>正在从 openrouter.duckdb 加载向量数据库...</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>    vector_store <span class="op">=</span> DuckDBVectorStore(database_name<span class="op">=</span><span class="st">"openrouter.duckdb"</span>, persist_dir<span class="op">=</span><span class="st">"./persist/"</span>, read_only<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>    index <span class="op">=</span> VectorStoreIndex.from_vector_store(vector_store<span class="op">=</span>vector_store)</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"⚠️ 无法加载向量数据库 (可能被锁定): </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 创建一个空索引作为备选，或者跳过</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>    index <span class="op">=</span> <span class="va">None</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 定义查询</span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="st">"What are model variants?"</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">60</span><span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
============================================================</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"查询问题: '</span><span class="sc">{</span>query<span class="sc">}</span><span class="ss">'"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>查询问题: 'What are model variants?'</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">60</span><span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>============================================================</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 检索前 3 个相关块</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> index:</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>    retriever <span class="op">=</span> index.as_retriever(similarity_top_k<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    nodes <span class="op">=</span> retriever.retrieve(query)</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>    nodes <span class="op">=</span> []</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 打印详细检索信息</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"从 DuckDB 中检索到 </span><span class="sc">{</span><span class="bu">len</span>(nodes)<span class="sc">}</span><span class="ss"> 个文本块：</span><span class="ch">\n</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>从 DuckDB 中检索到 5 个文本块：</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, node <span class="kw">in</span> <span class="bu">enumerate</span>(nodes, <span class="dv">1</span>):</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'─'</span><span class="op">*</span><span class="dv">60</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"块 </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'─'</span><span class="op">*</span><span class="dv">60</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 打印相似度分数</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">hasattr</span>(node, <span class="st">'score'</span>):</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"相似度分数: </span><span class="sc">{</span>node<span class="sc">.</span>score<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 打印元数据</span></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">hasattr</span>(node, <span class="st">'metadata'</span>) <span class="kw">and</span> node.metadata:</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"元数据:"</span>)</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> key, value <span class="kw">in</span> node.metadata.items():</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  - </span><span class="sc">{</span>key<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>value<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 打印文本内容（截断显示）</span></span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>    text_preview <span class="op">=</span> node.text[:<span class="dv">500</span>] <span class="op">+</span> <span class="st">"..."</span> <span class="cf">if</span> <span class="bu">len</span>(node.text) <span class="op">&gt;</span> <span class="dv">500</span> <span class="cf">else</span> node.text</span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">内容预览:</span><span class="ch">\n</span><span class="sc">{</span>text_preview<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>────────────────────────────────────────────────────────────
块 1
────────────────────────────────────────────────────────────
相似度分数: 0.6170
元数据:
  - file_path: /Users/jinchaoduan/Documents/post_project/AI_Blog/posts/RAG/markdown_docs/docs_features_exacto-variant.md
  - file_name: docs_features_exacto-variant.md
  - file_type: text/markdown
  - file_size: 7972
  - creation_date: 2025-11-21
  - last_modified_date: 2025-11-21

内容预览:
Search

`/`

Ask AI

[API](/docs/api-reference/overview)[Models](https://openrouter.ai/models)[Chat](https://openrouter.ai/chat)[Ranking](https://openrouter.ai/rankings)

* Overview

  + [Quickstart](/docs/quickstart)
  + [FAQ](/docs/faq)
  + [Principles](/docs/overview/principles)
  + [Models](/docs/overview/models)
  + [Enterprise](https://openrouter.ai/enterprise)
* Features

  + [Privacy and Logging](/docs/features/privacy-and-logging)
  + [Zero Data Retention (ZDR)](/docs/features/zdr)
  + ...

────────────────────────────────────────────────────────────
块 2
────────────────────────────────────────────────────────────
相似度分数: 0.6101
元数据:
  - file_path: /Users/jinchaoduan/Documents/post_project/AI_Blog/posts/RAG/markdown_docs/docs_overview_models.md
  - file_name: docs_overview_models.md
  - file_type: text/markdown
  - file_size: 9021
  - creation_date: 2025-11-21
  - last_modified_date: 2025-11-21

内容预览:
Search

`/`

Ask AI

[API](/docs/api-reference/overview)[Models](https://openrouter.ai/models)[Chat](https://openrouter.ai/chat)[Ranking](https://openrouter.ai/rankings)

* Overview

  + [Quickstart](/docs/quickstart)
  + [FAQ](/docs/faq)
  + [Principles](/docs/overview/principles)
  + [Models](/docs/overview/models)
  + [Enterprise](https://openrouter.ai/enterprise)
* Features

  + [Privacy and Logging](/docs/features/privacy-and-logging)
  + [Zero Data Retention (ZDR)](/docs/features/zdr)
  + ...

────────────────────────────────────────────────────────────
块 3
────────────────────────────────────────────────────────────
相似度分数: 0.5821
元数据:
  - file_path: /Users/jinchaoduan/Documents/post_project/AI_Blog/posts/RAG/markdown_docs/docs_guides_overview_models.md
  - file_name: docs_guides_overview_models.md
  - file_type: text/markdown
  - file_size: 7557
  - creation_date: 2026-01-06
  - last_modified_date: 2026-01-06

内容预览:
Search

`/`

Ask AI

[Models](https://openrouter.ai/models)[Chat](https://openrouter.ai/chat)[Ranking](https://openrouter.ai/rankings)[Docs](/docs/api-reference/overview)

[Docs](/docs/quickstart)[API Reference](/docs/api/reference/overview)[SDK Reference](/docs/sdks/call-model/overview)

[Docs](/docs/quickstart)[API Reference](/docs/api/reference/overview)[SDK Reference](/docs/sdks/call-model/overview)

* Overview

  + [Quickstart](/docs/quickstart)
  + [Principles](/docs/guides/overview/princi...

────────────────────────────────────────────────────────────
块 4
────────────────────────────────────────────────────────────
相似度分数: 0.5763
元数据:
  - file_path: /Users/jinchaoduan/Documents/post_project/AI_Blog/posts/RAG/markdown_docs/docs_faq_how-are-rate-limits-calculated.md
  - file_name: docs_faq_how-are-rate-limits-calculated.md
  - file_type: text/markdown
  - file_size: 17710
  - creation_date: 2026-01-06
  - last_modified_date: 2026-01-06

内容预览:
Search

`/`

Ask AI

[Models](https://openrouter.ai/models)[Chat](https://openrouter.ai/chat)[Ranking](https://openrouter.ai/rankings)[Docs](/docs/api-reference/overview)

[Docs](/docs/quickstart)[API Reference](/docs/api/reference/overview)[SDK Reference](/docs/sdks/call-model/overview)

[Docs](/docs/quickstart)[API Reference](/docs/api/reference/overview)[SDK Reference](/docs/sdks/call-model/overview)

* Overview

  + [Quickstart](/docs/quickstart)
  + [Principles](/docs/guides/overview/princi...

────────────────────────────────────────────────────────────
块 5
────────────────────────────────────────────────────────────
相似度分数: 0.5703
元数据:
  - file_path: /Users/jinchaoduan/Documents/post_project/AI_Blog/posts/RAG/markdown_docs/docs_features_model-routing.md
  - file_name: docs_features_model-routing.md
  - file_type: text/markdown
  - file_size: 7024
  - creation_date: 2025-11-21
  - last_modified_date: 2025-11-21

内容预览:
|
| 17 | } |
| 18 | ] |
| 19 | ) |
| 20 |  |
| 21 | print(completion.choices[0].message.content) |
```

Was this page helpful?

YesNo

[Previous](/docs/features/zdr)[#### Provider Routing

Route requests to the best provider

Next](/docs/features/provider-routing)[Built with](https://buildwithfern.com/?utm_campaign=buildWith&amp;utm_medium=docs&amp;utm_source=openrouter.ai)

[![Logo](https://files.buildwithfern.com/openrouter.docs.buildwithfern.com/docs/2025-11-21T16:36:36.134Z/content/assets/logo.svg)!...</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Save retrieved chunks to a markdown file for easy inspection</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="co"># with open("retriever.md", "w", encoding="utf-8") as f:</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="co">#     f.write(f"# Query: {query}\n\n")</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="co">#     f.write(f"# Retrieved {len(nodes)} chunks from openrouter.duckdb\n\n")</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="co">#     for i, node in enumerate(nodes, 1):</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a><span class="co">#         f.write(f"{'─'*60}\n")</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a><span class="co">#         f.write(f"## Chunk {i}\n\n")</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a><span class="co">#         if hasattr(node, 'score'):</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a><span class="co">#             f.write(f"**Similarity Score:** {node.score:.4f}\n\n")</span></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a><span class="co">#         if hasattr(node, 'metadata') and node.metadata:</span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a><span class="co">#             f.write(f"**Metadata:**\n")</span></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a><span class="co">#             for key, value in node.metadata.items():</span></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a><span class="co">#                 f.write(f"- {key}: {value}\n")</span></span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a><span class="co">#             f.write(f"\n")</span></span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a><span class="co">#         f.write(f"{node.text}\n\n")</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
</div>
<div id="tabset-3-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-3-tab">
<p>现在我们的知识库已经填充完毕，我们可以测试检索系统。我们可以提出一个特定的问题，例如“什么是模型变体？ (What are model variants?)”，并查询 <code>Chroma</code> 存储库以查看哪些文本块最相关。这确认了我们的嵌入和搜索是否正常工作。</p>
<section id="问题什么是模型变体-what-are-model-variants" class="level3">
<h3 class="anchored" data-anchor-id="问题什么是模型变体-what-are-model-variants">问题：什么是模型变体？ (What are model variants?)</h3>
<p>RAG 结果：</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> openai <span class="im">import</span> OpenAI</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain_core.embeddings <span class="im">import</span> Embeddings</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain_chroma <span class="im">import</span> Chroma</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dotenv <span class="im">import</span> load_dotenv</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>load_dotenv()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>True</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 针对 OpenRouter API 的自定义嵌入类</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> OpenRouterEmbeddings(Embeddings):</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""针对 OpenRouter API 的自定义嵌入类。"""</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, api_key: <span class="bu">str</span>, model: <span class="bu">str</span> <span class="op">=</span> <span class="st">"qwen/qwen3-embedding-8b"</span>):</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.client <span class="op">=</span> OpenAI(</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>            base_url<span class="op">=</span><span class="st">"https://openrouter.ai/api/v1"</span>,</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>            api_key<span class="op">=</span>api_key,</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model <span class="op">=</span> model</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> embed_documents(<span class="va">self</span>, texts: List[<span class="bu">str</span>]) <span class="op">-&gt;</span> List[List[<span class="bu">float</span>]]:</span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""对文档列表进行嵌入。"""</span></span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> <span class="va">self</span>.client.embeddings.create(</span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>            extra_headers<span class="op">=</span>{</span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>                <span class="st">"HTTP-Referer"</span>: <span class="st">"https://ai-blog.com"</span>,</span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>                <span class="st">"X-Title"</span>: <span class="st">"AI Blog RAG"</span>,</span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a>            model<span class="op">=</span><span class="va">self</span>.model,</span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a>            <span class="bu">input</span><span class="op">=</span>texts,</span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a>            encoding_format<span class="op">=</span><span class="st">"float"</span></span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [item.embedding <span class="cf">for</span> item <span class="kw">in</span> response.data]</span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb46-25"><a href="#cb46-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> embed_query(<span class="va">self</span>, text: <span class="bu">str</span>) <span class="op">-&gt;</span> List[<span class="bu">float</span>]:</span>
<span id="cb46-26"><a href="#cb46-26" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""对单个查询进行嵌入。"""</span></span>
<span id="cb46-27"><a href="#cb46-27" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> <span class="va">self</span>.client.embeddings.create(</span>
<span id="cb46-28"><a href="#cb46-28" aria-hidden="true" tabindex="-1"></a>            extra_headers<span class="op">=</span>{</span>
<span id="cb46-29"><a href="#cb46-29" aria-hidden="true" tabindex="-1"></a>                <span class="st">"HTTP-Referer"</span>: <span class="st">"https://ai-blog.com"</span>,</span>
<span id="cb46-30"><a href="#cb46-30" aria-hidden="true" tabindex="-1"></a>                <span class="st">"X-Title"</span>: <span class="st">"AI Blog RAG"</span>,</span>
<span id="cb46-31"><a href="#cb46-31" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb46-32"><a href="#cb46-32" aria-hidden="true" tabindex="-1"></a>            model<span class="op">=</span><span class="va">self</span>.model,</span>
<span id="cb46-33"><a href="#cb46-33" aria-hidden="true" tabindex="-1"></a>            <span class="bu">input</span><span class="op">=</span>text,</span>
<span id="cb46-34"><a href="#cb46-34" aria-hidden="true" tabindex="-1"></a>            encoding_format<span class="op">=</span><span class="st">"float"</span></span>
<span id="cb46-35"><a href="#cb46-35" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb46-36"><a href="#cb46-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> response.data[<span class="dv">0</span>].embedding</span>
<span id="cb46-37"><a href="#cb46-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-38"><a href="#cb46-38" aria-hidden="true" tabindex="-1"></a><span class="co"># 获取 OpenRouter API 密钥</span></span>
<span id="cb46-39"><a href="#cb46-39" aria-hidden="true" tabindex="-1"></a>openrouter_api_key <span class="op">=</span> os.getenv(<span class="st">"OPENROUTER_API_KEY"</span>)</span>
<span id="cb46-40"><a href="#cb46-40" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> openrouter_api_key:</span>
<span id="cb46-41"><a href="#cb46-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"未在环境变量中找到 OPENROUTER_API_KEY"</span>)</span>
<span id="cb46-42"><a href="#cb46-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-43"><a href="#cb46-43" aria-hidden="true" tabindex="-1"></a><span class="co"># 使用 OpenRouter 创建嵌入实例</span></span>
<span id="cb46-44"><a href="#cb46-44" aria-hidden="true" tabindex="-1"></a>embeddings <span class="op">=</span> OpenRouterEmbeddings(</span>
<span id="cb46-45"><a href="#cb46-45" aria-hidden="true" tabindex="-1"></a>    api_key<span class="op">=</span>openrouter_api_key,</span>
<span id="cb46-46"><a href="#cb46-46" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span><span class="st">"qwen/qwen3-embedding-8b"</span></span>
<span id="cb46-47"><a href="#cb46-47" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb46-48"><a href="#cb46-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-49"><a href="#cb46-49" aria-hidden="true" tabindex="-1"></a><span class="co"># 定义向量数据库位置</span></span>
<span id="cb46-50"><a href="#cb46-50" aria-hidden="true" tabindex="-1"></a>persist_directory <span class="op">=</span> <span class="st">"chroma_db_data"</span></span>
<span id="cb46-51"><a href="#cb46-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-52"><a href="#cb46-52" aria-hidden="true" tabindex="-1"></a><span class="co"># 加载现有的向量数据库</span></span>
<span id="cb46-53"><a href="#cb46-53" aria-hidden="true" tabindex="-1"></a>vectorstore <span class="op">=</span> Chroma(</span>
<span id="cb46-54"><a href="#cb46-54" aria-hidden="true" tabindex="-1"></a>    persist_directory<span class="op">=</span>persist_directory,</span>
<span id="cb46-55"><a href="#cb46-55" aria-hidden="true" tabindex="-1"></a>    embedding_function<span class="op">=</span>embeddings</span>
<span id="cb46-56"><a href="#cb46-56" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb46-57"><a href="#cb46-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-58"><a href="#cb46-58" aria-hidden="true" tabindex="-1"></a><span class="co"># 测试查询</span></span>
<span id="cb46-59"><a href="#cb46-59" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="st">"What are model variants?"</span></span>
<span id="cb46-60"><a href="#cb46-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-61"><a href="#cb46-61" aria-hidden="true" tabindex="-1"></a><span class="co"># 执行相似度搜索</span></span>
<span id="cb46-62"><a href="#cb46-62" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> vectorstore.similarity_search(query, k<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb46-63"><a href="#cb46-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-64"><a href="#cb46-64" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">查询问题: '</span><span class="sc">{</span>query<span class="sc">}</span><span class="ss">'"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
查询问题: 'What are model variants?'</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"找到 </span><span class="sc">{</span><span class="bu">len</span>(results)<span class="sc">}</span><span class="ss"> 个相关块：</span><span class="ch">\n</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>找到 5 个相关块：</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, doc <span class="kw">in</span> <span class="bu">enumerate</span>(results, <span class="dv">1</span>):</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"结果 </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"来源: </span><span class="sc">{</span>doc<span class="sc">.</span>metadata<span class="sc">.</span>get(<span class="st">'source'</span>, <span class="st">'未知'</span>)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"内容预览: </span><span class="sc">{</span>doc<span class="sc">.</span>page_content[:<span class="dv">800</span>]<span class="sc">}</span><span class="ss">..."</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>结果 1:
来源: docs_faq_how-are-rate-limits-calculated.md
内容预览: ###### What are model variants?

Variants are suffixes that can be added to the model slug to change its behavior.

Static variants can only be used with specific models and these are listed in our [models api](https://openrouter.ai/api/v1/models).

1. `:free` - The model is always provided for free and has low rate limits.
2. `:beta` - The model is not moderated by OpenRouter.
3. `:extended` - The model has longer than usual context length.
4. `:exacto` - The model only uses OpenRouter-curated high-quality endpoints.
5. `:thinking` - The model supports reasoning by default.

Dynamic variants can be used on all models and they change the behavior of how the request is routed or used.

1. `:online` - All requests will run a query to extract web results that are attached to the prompt.
2. `:...
结果 2:
来源: docs_faq.md
内容预览: ###### What are model variants?

Variants are suffixes that can be added to the model slug to change its behavior.

Static variants can only be used with specific models and these are listed in our [models api](https://openrouter.ai/api/v1/models).

1. `:free` - The model is always provided for free and has low rate limits.
2. `:beta` - The model is not moderated by OpenRouter.
3. `:extended` - The model has longer than usual context length.
4. `:exacto` - The model only uses OpenRouter-curated high-quality endpoints.
5. `:thinking` - The model supports reasoning by default.

Dynamic variants can be used on all models and they change the behavior of how the request is routed or used.

1. `:online` - All requests will run a query to extract web results that are attached to the prompt.
2. `:...
结果 3:
来源: docs_use-cases_crypto-api.md
内容预览: [API](/docs/api-reference/overview)[Models](https://openrouter.ai/models)[Chat](https://openrouter.ai/chat)[Ranking](https://openrouter.ai/rankings)...
结果 4:
来源: docs_sdks_typescript.md
内容预览: [API](/docs/api-reference/overview)[Models](https://openrouter.ai/models)[Chat](https://openrouter.ai/chat)[Ranking](https://openrouter.ai/rankings)...
结果 5:
来源: docs_features_provider-routing.md
内容预览: Route requests through OpenRouter-curated providers

Next](/docs/features/exacto-variant)[Built with](https://buildwithfern.com/?utm_campaign=buildWith&amp;utm_medium=docs&amp;utm_source=openrouter.ai)

[![Logo](https://files.buildwithfern.com/openrouter.docs.buildwithfern.com/docs/2025-11-21T16:36:36.134Z/content/assets/logo.svg)![Logo](https://files.buildwithfern.com/openrouter.docs.buildwithfern.com/docs/2025-11-21T16:36:36.134Z/content/assets/logo-white.svg)](https://openrouter.ai/)

[API](/docs/api-reference/overview)[Models](https://openrouter.ai/models)[Chat](https://openrouter.ai/chat)[Ranking](https://openrouter.ai/rankings)...</code></pre>
</div>
</div>
</section>
</div>
</div>
</div>
</section>
<section id="结合-rag-进行聊天-chat-with-rag" class="level1">
<h1>结合 RAG 进行聊天 (Chat with RAG)</h1>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-4-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-1" role="tab" aria-controls="tabset-4-1" aria-selected="true" href="">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-4-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-2" role="tab" aria-controls="tabset-4-2" aria-selected="false" href="">Python chatlas</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-4-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-3" role="tab" aria-controls="tabset-4-3" aria-selected="false" href="">Python LangChain</a></li></ul>
<div class="tab-content">
<div id="tabset-4-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-4-1-tab">
<p>最后一个环节是将这种检索能力连接到聊天界面。我们使用 <code>ellmer</code> 创建一个聊天客户端。关键在于，我们使用 <code>ragnar_register_tool_retrieve</code> 注册一个“检索工具”。这使 LLM 能够在需要信息回答用户问题时，自主查询我们的向量数据库。</p>
<p>我们还提供了一个系统提示词，指示模型始终检查知识库并引用其来源。</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ellmer)</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dotenv)</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ragnar)</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="fu">load_dot_env</span>(<span class="at">file =</span> <span class="st">".env"</span>)</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>chat <span class="ot">&lt;-</span> <span class="fu">chat_openrouter</span>(</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">api_key =</span> <span class="fu">Sys.getenv</span>(<span class="st">"OPENROUTER_API_KEY"</span>),</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">model =</span> <span class="st">"openai/gpt-oss-120b"</span>,</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">system_prompt =</span> glue<span class="sc">::</span><span class="fu">trim</span>(<span class="st">"</span></span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a><span class="st">  你是一个负责问答任务的助手。请保持回复简练。</span></span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a><span class="st">  在回复之前，请从知识库中检索相关素材。引用或转述段落，清晰地标注哪些是你自己的话，哪些是来源。</span></span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a><span class="st">  为你引用的每个来源提供一个有效的链接，以及任何其他相关的链接。</span></span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a><span class="st">  除非你已经检索并引用了来源，否则不要回答。如果你没有找到相关信息，请说“我在知识库中找不到任何相关信息”。</span></span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a><span class="st">    "</span>)</span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a><span class="co"># 尝试连接存储并注册工具</span></span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a>store_connected <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a><span class="fu">tryCatch</span>({</span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a>    store <span class="ot">&lt;-</span> <span class="fu">ragnar_store_connect</span>(<span class="st">"openrouter.duckdb"</span>)</span>
<span id="cb52-22"><a href="#cb52-22" aria-hidden="true" tabindex="-1"></a>    chat <span class="ot">&lt;-</span> chat <span class="sc">|&gt;</span> <span class="fu">ragnar_register_tool_retrieve</span>(store, <span class="at">top_k =</span> <span class="dv">3</span>)</span>
<span id="cb52-23"><a href="#cb52-23" aria-hidden="true" tabindex="-1"></a>    store_connected <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb52-24"><a href="#cb52-24" aria-hidden="true" tabindex="-1"></a>}, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb52-25"><a href="#cb52-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"⚠️ 无法连接到 DuckDB 进行工具注册: "</span>, e<span class="sc">$</span>message)</span>
<span id="cb52-26"><a href="#cb52-26" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<section id="问题什么是模型变体what-are-model-variants-2" class="level3">
<h3 class="anchored" data-anchor-id="问题什么是模型变体what-are-model-variants-2">问题：什么是模型变体？(What are model variants?)</h3>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (store_connected) {</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>    chat<span class="sc">$</span><span class="fu">chat</span>(<span class="st">"What are model variants?"</span>)</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 聊天结束后立即释放锁</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rm</span>(store)</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">gc</span>()</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"由于数据库锁定，R 聊天功能暂时不可用。"</span>)</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<p><strong>模型变体（model variants）</strong>是可以在模型标识（slug）后添加的后缀，用来改变模型的行为方式。</p>
<ul>
<li><strong>静态变体</strong>只能用于特定模型，列在 <a href="https://openrouter.ai/api/v1/models">Models API</a> 中。例如：
<ol type="1">
<li><code>:free</code> – 始终免费提供，且速率限制较低。<br>
</li>
<li><code>:beta</code> – 不受 OpenRouter 内容审查。<br>
</li>
<li><code>:extended</code> – 提供比常规更长的上下文长度。<br>
</li>
<li><code>:exacto</code> – 仅使用 OpenRouter 精选的高质量端点。<br>
</li>
<li><code>:thinking</code> – 默认支持推理（reasoning）。</li>
</ol></li>
<li><strong>动态变体</strong>可以在所有模型上使用，改变请求的路由或使用方式。例如：
<ol type="1">
<li><code>:online</code> – 在提示中附加网络搜索结果。<br>
</li>
<li><code>:nitro</code> – 按吞吐量排序提供者，优先更快响应。<br>
</li>
<li><code>:floor</code> – 按价格排序提供者，优先更具成本效益的选项。</li>
</ol></li>
</ul>
<blockquote class="blockquote">
<p>“Variants are suffixes that can be added to the model slug to change its behavior.”【来源: OpenRouter FAQ – 模型和提供者】(https://openrouter.ai/docs/faq) used (Mb) gc trigger (Mb) limit (Mb) max used (Mb) Ncells 3083914 164.7 4675528 249.8 NA 4675528 249.8 Vcells 5315244 40.6 10146329 77.5 16384 9527284 72.7</p>
</blockquote>
</section>
</div>
<div id="tabset-4-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-4-2-tab">
<p>我们还可以使用 <code>chatlas</code> 库来创建一个聊天界面。在这里，我们定义了一个自定义工具 <code>retrieve_trusted_content</code>，用于查询我们的 DuckDB 索引。然后我们将这个工具注册到聊天模型中，使其能够在回答用户问题时引入相关信息。</p>
<section id="问题什么是模型变体what-are-model-variants-3" class="level3">
<h3 class="anchored" data-anchor-id="问题什么是模型变体what-are-model-variants-3">问题：什么是模型变体？(What are model variants?)</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Any, List</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> openai <span class="im">import</span> OpenAI</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> chatlas <span class="im">as</span> ctl</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> llama_index.core <span class="im">import</span> VectorStoreIndex, Settings</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> llama_index.core.embeddings <span class="im">import</span> BaseEmbedding</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> llama_index.vector_stores.duckdb <span class="im">import</span> DuckDBVectorStore</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dotenv <span class="im">import</span> load_dotenv</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>load_dotenv()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>True</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 确保 API 密钥可用</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>openrouter_api_key <span class="op">=</span> os.getenv(<span class="st">"OPENROUTER_API_KEY"</span>)</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 针对 LlamaIndex 的自定义 OpenRouter 嵌入类</span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> OpenRouterEmbedding(BaseEmbedding):</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""与 LlamaIndex 兼容的 OpenRouter API 自定义嵌入类。"""</span></span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>,</span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>        api_key: <span class="bu">str</span>,</span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>        model: <span class="bu">str</span> <span class="op">=</span> <span class="st">"qwen/qwen3-embedding-8b"</span>,</span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>        <span class="op">**</span>kwargs: Any</span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>(<span class="op">**</span>kwargs)</span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._client <span class="op">=</span> OpenAI(</span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a>            base_url<span class="op">=</span><span class="st">"https://openrouter.ai/api/v1"</span>,</span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a>            api_key<span class="op">=</span>api_key,</span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._model <span class="op">=</span> model</span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-21"><a href="#cb56-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _get_query_embedding(<span class="va">self</span>, query: <span class="bu">str</span>) <span class="op">-&gt;</span> List[<span class="bu">float</span>]:</span>
<span id="cb56-22"><a href="#cb56-22" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""获取查询字符串的嵌入向量。"""</span></span>
<span id="cb56-23"><a href="#cb56-23" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> <span class="va">self</span>._client.embeddings.create(</span>
<span id="cb56-24"><a href="#cb56-24" aria-hidden="true" tabindex="-1"></a>            extra_headers<span class="op">=</span>{</span>
<span id="cb56-25"><a href="#cb56-25" aria-hidden="true" tabindex="-1"></a>                <span class="st">"HTTP-Referer"</span>: <span class="st">"https://ai-blog.com"</span>,</span>
<span id="cb56-26"><a href="#cb56-26" aria-hidden="true" tabindex="-1"></a>                <span class="st">"X-Title"</span>: <span class="st">"AI Blog RAG"</span>,</span>
<span id="cb56-27"><a href="#cb56-27" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb56-28"><a href="#cb56-28" aria-hidden="true" tabindex="-1"></a>            model<span class="op">=</span><span class="va">self</span>._model,</span>
<span id="cb56-29"><a href="#cb56-29" aria-hidden="true" tabindex="-1"></a>            <span class="bu">input</span><span class="op">=</span>query,</span>
<span id="cb56-30"><a href="#cb56-30" aria-hidden="true" tabindex="-1"></a>            encoding_format<span class="op">=</span><span class="st">"float"</span></span>
<span id="cb56-31"><a href="#cb56-31" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb56-32"><a href="#cb56-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> response.data[<span class="dv">0</span>].embedding</span>
<span id="cb56-33"><a href="#cb56-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-34"><a href="#cb56-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _get_text_embedding(<span class="va">self</span>, text: <span class="bu">str</span>) <span class="op">-&gt;</span> List[<span class="bu">float</span>]:</span>
<span id="cb56-35"><a href="#cb56-35" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""获取文本字符串的嵌入向量。"""</span></span>
<span id="cb56-36"><a href="#cb56-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._get_query_embedding(text)</span>
<span id="cb56-37"><a href="#cb56-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-38"><a href="#cb56-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> _aget_query_embedding(<span class="va">self</span>, query: <span class="bu">str</span>) <span class="op">-&gt;</span> List[<span class="bu">float</span>]:</span>
<span id="cb56-39"><a href="#cb56-39" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""异步版本的 get_query_embedding。"""</span></span>
<span id="cb56-40"><a href="#cb56-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._get_query_embedding(query)</span>
<span id="cb56-41"><a href="#cb56-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-42"><a href="#cb56-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> _aget_text_embedding(<span class="va">self</span>, text: <span class="bu">str</span>) <span class="op">-&gt;</span> List[<span class="bu">float</span>]:</span>
<span id="cb56-43"><a href="#cb56-43" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""异步版本的 get_text_embedding。"""</span></span>
<span id="cb56-44"><a href="#cb56-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._get_text_embedding(text)</span>
<span id="cb56-45"><a href="#cb56-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-46"><a href="#cb56-46" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. 配置嵌入模型</span></span>
<span id="cb56-47"><a href="#cb56-47" aria-hidden="true" tabindex="-1"></a>embed_model <span class="op">=</span> OpenRouterEmbedding(</span>
<span id="cb56-48"><a href="#cb56-48" aria-hidden="true" tabindex="-1"></a>    api_key<span class="op">=</span>openrouter_api_key,</span>
<span id="cb56-49"><a href="#cb56-49" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span><span class="st">"qwen/qwen3-embedding-8b"</span></span>
<span id="cb56-50"><a href="#cb56-50" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb56-51"><a href="#cb56-51" aria-hidden="true" tabindex="-1"></a>Settings.embed_model <span class="op">=</span> embed_model</span>
<span id="cb56-52"><a href="#cb56-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-53"><a href="#cb56-53" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. 加载索引</span></span>
<span id="cb56-54"><a href="#cb56-54" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb56-55"><a href="#cb56-55" aria-hidden="true" tabindex="-1"></a>    vector_store <span class="op">=</span> DuckDBVectorStore(database_name<span class="op">=</span><span class="st">"openrouter.duckdb"</span>, persist_dir<span class="op">=</span><span class="st">"./persist/"</span>, read_only<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb56-56"><a href="#cb56-56" aria-hidden="true" tabindex="-1"></a>    index <span class="op">=</span> VectorStoreIndex.from_vector_store(vector_store<span class="op">=</span>vector_store)</span>
<span id="cb56-57"><a href="#cb56-57" aria-hidden="true" tabindex="-1"></a>    retriever <span class="op">=</span> index.as_retriever(similarity_top_k<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb56-58"><a href="#cb56-58" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb56-59"><a href="#cb56-59" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"⚠️ 无法加载向量数据库: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb56-60"><a href="#cb56-60" aria-hidden="true" tabindex="-1"></a>    index <span class="op">=</span> <span class="va">None</span></span>
<span id="cb56-61"><a href="#cb56-61" aria-hidden="true" tabindex="-1"></a>    retriever <span class="op">=</span> <span class="va">None</span></span>
<span id="cb56-62"><a href="#cb56-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-63"><a href="#cb56-63" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. 定义聊天工具</span></span>
<span id="cb56-64"><a href="#cb56-64" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> retrieve_trusted_content(question: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb56-65"><a href="#cb56-65" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb56-66"><a href="#cb56-66" aria-hidden="true" tabindex="-1"></a><span class="co">    在知识库中检索信任的内容来回答问题。</span></span>
<span id="cb56-67"><a href="#cb56-67" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb56-68"><a href="#cb56-68" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> retriever:</span>
<span id="cb56-69"><a href="#cb56-69" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">"知识库当前不可用（由于数据库锁定）。"</span></span>
<span id="cb56-70"><a href="#cb56-70" aria-hidden="true" tabindex="-1"></a>    nodes <span class="op">=</span> retriever.retrieve(question)</span>
<span id="cb56-71"><a href="#cb56-71" aria-hidden="true" tabindex="-1"></a>    combined_text <span class="op">=</span> <span class="st">"</span><span class="ch">\n\n</span><span class="st">"</span>.join([<span class="ss">f"Source Content </span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">:</span><span class="ch">\n</span><span class="sc">{</span>node<span class="sc">.</span>text<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> i, node <span class="kw">in</span> <span class="bu">enumerate</span>(nodes)])</span>
<span id="cb56-72"><a href="#cb56-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> combined_text</span>
<span id="cb56-73"><a href="#cb56-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-74"><a href="#cb56-74" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. 设置聊天模型并注册工具</span></span>
<span id="cb56-75"><a href="#cb56-75" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> ctl.ChatOpenRouter(</span>
<span id="cb56-76"><a href="#cb56-76" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span><span class="st">"openai/gpt-oss-120b"</span>,</span>
<span id="cb56-77"><a href="#cb56-77" aria-hidden="true" tabindex="-1"></a>    api_key<span class="op">=</span>openrouter_api_key,</span>
<span id="cb56-78"><a href="#cb56-78" aria-hidden="true" tabindex="-1"></a>    base_url<span class="op">=</span><span class="st">"https://openrouter.ai/api/v1"</span>,</span>
<span id="cb56-79"><a href="#cb56-79" aria-hidden="true" tabindex="-1"></a>    system_prompt<span class="op">=</span><span class="st">"""</span></span>
<span id="cb56-80"><a href="#cb56-80" aria-hidden="true" tabindex="-1"></a><span class="st">    你是一个负责问答任务助手。请保持回复简练。</span></span>
<span id="cb56-81"><a href="#cb56-81" aria-hidden="true" tabindex="-1"></a><span class="st">    在回复之前，始终通过 retrieve_trusted_content 工具检索相关素材。</span></span>
<span id="cb56-82"><a href="#cb56-82" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span></span>
<span id="cb56-83"><a href="#cb56-83" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb56-84"><a href="#cb56-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-85"><a href="#cb56-85" aria-hidden="true" tabindex="-1"></a>chat.register_tool(retrieve_trusted_content)</span>
<span id="cb56-86"><a href="#cb56-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-87"><a href="#cb56-87" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. 执行聊天</span></span>
<span id="cb56-88"><a href="#cb56-88" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb56-89"><a href="#cb56-89" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> chat.chat(<span class="st">"What are model variants?"</span>)</span>
<span id="cb56-90"><a href="#cb56-90" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(response)</span>
<span id="cb56-91"><a href="#cb56-91" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb56-92"><a href="#cb56-92" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"⚠️ 聊天过程出错 (可能是显示处理问题): </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;IPython.core.display.HTML object&gt;
&lt;IPython.core.display.Markdown object&gt;
⚠️ 聊天过程出错 (可能是显示处理问题): Failed to create display handle</code></pre>
</div>
</div>
</section>
</div>
<div id="tabset-4-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-4-3-tab">
<p>在 Python 的 LangChain 中，我们设置了一个完整的 RAG 流水线。这包括： 1. <strong>检索器 (Retriever)</strong>：使用我们的 <code>Chroma</code> 向量数据库。 2. <strong>提示词模版 (Prompt Template)</strong>：指示模型使用检索到的上下文来回答问题。 3. <strong>聊天模型 (Chat Model)</strong>：使用 OpenRouter 提供的 <code>gpt-4o</code>。 4. <strong>输出解析器 (Output Parser)</strong>：用于格式化最终响应。</p>
<p>这种模块化方法是构建生产级 AI 应用程序的典型方式。</p>
<section id="问题什么是模型变体what-are-model-variants-4" class="level3">
<h3 class="anchored" data-anchor-id="问题什么是模型变体what-are-model-variants-4">问题：什么是模型变体？(What are model variants?)</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain_openai <span class="im">import</span> ChatOpenAI</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain_core.prompts <span class="im">import</span> ChatPromptTemplate</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain_core.runnables <span class="im">import</span> RunnablePassthrough</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain_core.output_parsers <span class="im">import</span> StrOutputParser</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> openai <span class="im">import</span> OpenAI</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain_core.embeddings <span class="im">import</span> Embeddings</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain_chroma <span class="im">import</span> Chroma</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dotenv <span class="im">import</span> load_dotenv</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>load_dotenv()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>True</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 针对 LangChain 的自定义 OpenRouter 嵌入类</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> OpenRouterEmbeddings(Embeddings):</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, api_key: <span class="bu">str</span>, model: <span class="bu">str</span> <span class="op">=</span> <span class="st">"qwen/qwen3-embedding-8b"</span>):</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._client <span class="op">=</span> OpenAI(</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>            base_url<span class="op">=</span><span class="st">"https://openrouter.ai/api/v1"</span>,</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>            api_key<span class="op">=</span>api_key,</span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._model <span class="op">=</span> model</span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> embed_documents(<span class="va">self</span>, texts: List[<span class="bu">str</span>]) <span class="op">-&gt;</span> List[List[<span class="bu">float</span>]]:</span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""嵌入文档列表。"""</span></span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> <span class="va">self</span>._client.embeddings.create(</span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a>            model<span class="op">=</span><span class="va">self</span>._model,</span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a>            <span class="bu">input</span><span class="op">=</span>texts</span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [d.embedding <span class="cf">for</span> d <span class="kw">in</span> response.data]</span>
<span id="cb60-17"><a href="#cb60-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-18"><a href="#cb60-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> embed_query(<span class="va">self</span>, text: <span class="bu">str</span>) <span class="op">-&gt;</span> List[<span class="bu">float</span>]:</span>
<span id="cb60-19"><a href="#cb60-19" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""嵌入单个查询。"""</span></span>
<span id="cb60-20"><a href="#cb60-20" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> <span class="va">self</span>._client.embeddings.create(</span>
<span id="cb60-21"><a href="#cb60-21" aria-hidden="true" tabindex="-1"></a>            model<span class="op">=</span><span class="va">self</span>._model,</span>
<span id="cb60-22"><a href="#cb60-22" aria-hidden="true" tabindex="-1"></a>            <span class="bu">input</span><span class="op">=</span>text</span>
<span id="cb60-23"><a href="#cb60-23" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb60-24"><a href="#cb60-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> response.data[<span class="dv">0</span>].embedding</span>
<span id="cb60-25"><a href="#cb60-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-26"><a href="#cb60-26" aria-hidden="true" tabindex="-1"></a><span class="co"># 获取 OpenRouter API 密钥</span></span>
<span id="cb60-27"><a href="#cb60-27" aria-hidden="true" tabindex="-1"></a>openrouter_api_key <span class="op">=</span> os.getenv(<span class="st">"OPENROUTER_API_KEY"</span>)</span>
<span id="cb60-28"><a href="#cb60-28" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> openrouter_api_key:</span>
<span id="cb60-29"><a href="#cb60-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"未在环境变量中找到 OPENROUTER_API_KEY"</span>)</span>
<span id="cb60-30"><a href="#cb60-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-31"><a href="#cb60-31" aria-hidden="true" tabindex="-1"></a><span class="co"># 使用 OpenRouter 创建嵌入实例</span></span>
<span id="cb60-32"><a href="#cb60-32" aria-hidden="true" tabindex="-1"></a>embeddings <span class="op">=</span> OpenRouterEmbeddings(</span>
<span id="cb60-33"><a href="#cb60-33" aria-hidden="true" tabindex="-1"></a>    api_key<span class="op">=</span>openrouter_api_key,</span>
<span id="cb60-34"><a href="#cb60-34" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span><span class="st">"qwen/qwen3-embedding-8b"</span></span>
<span id="cb60-35"><a href="#cb60-35" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb60-36"><a href="#cb60-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-37"><a href="#cb60-37" aria-hidden="true" tabindex="-1"></a><span class="co"># 定义向量数据库位置</span></span>
<span id="cb60-38"><a href="#cb60-38" aria-hidden="true" tabindex="-1"></a>persist_directory <span class="op">=</span> <span class="st">"chroma_db_data"</span></span>
<span id="cb60-39"><a href="#cb60-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-40"><a href="#cb60-40" aria-hidden="true" tabindex="-1"></a><span class="co"># 加载现有的向量数据库</span></span>
<span id="cb60-41"><a href="#cb60-41" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"正在从 </span><span class="sc">{</span>persist_directory<span class="sc">}</span><span class="ss"> 加载现有向量数据库..."</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>正在从 chroma_db_data 加载现有向量数据库...</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>vectorstore <span class="op">=</span> Chroma(</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>    persist_directory<span class="op">=</span>persist_directory,</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>    embedding_function<span class="op">=</span>embeddings</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ 向量数据库加载成功"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>✓ 向量数据库加载成功</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 使用 OpenRouter 初始化 LLM</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>llm <span class="op">=</span> ChatOpenAI(</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span><span class="st">"openai/gpt-oss-120b"</span>,</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>    openai_api_key<span class="op">=</span>os.getenv(<span class="st">"OPENROUTER_API_KEY"</span>),</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>    openai_api_base<span class="op">=</span><span class="st">"https://openrouter.ai/api/v1"</span></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 创建提示词模版</span></span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>system_prompt <span class="op">=</span> (</span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"你是一个负责问答任务助手。"</span></span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"请使用以下检索到的素材来回答问题。"</span></span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"如果你不知道答案，请不要胡编乱造。"</span></span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"最多使用三句话，并保持回复简练。"</span></span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"</span><span class="ch">\n\n</span><span class="st">"</span></span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"素材: </span><span class="sc">{context}</span><span class="st">"</span></span>
<span id="cb64-16"><a href="#cb64-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"</span><span class="ch">\n\n</span><span class="st">"</span></span>
<span id="cb64-17"><a href="#cb64-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"问题: </span><span class="sc">{question}</span><span class="st">"</span></span>
<span id="cb64-18"><a href="#cb64-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb64-19"><a href="#cb64-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-20"><a href="#cb64-20" aria-hidden="true" tabindex="-1"></a>prompt <span class="op">=</span> ChatPromptTemplate.from_template(system_prompt)</span>
<span id="cb64-21"><a href="#cb64-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-22"><a href="#cb64-22" aria-hidden="true" tabindex="-1"></a><span class="co"># 创建检索器</span></span>
<span id="cb64-23"><a href="#cb64-23" aria-hidden="true" tabindex="-1"></a>retriever <span class="op">=</span> vectorstore.as_retriever(search_kwargs<span class="op">=</span>{<span class="st">"k"</span>: <span class="dv">3</span>})</span>
<span id="cb64-24"><a href="#cb64-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-25"><a href="#cb64-25" aria-hidden="true" tabindex="-1"></a><span class="co"># 用于格式化文档的辅助函数</span></span>
<span id="cb64-26"><a href="#cb64-26" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> format_docs(docs):</span>
<span id="cb64-27"><a href="#cb64-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">"</span><span class="ch">\n\n</span><span class="st">"</span>.join(doc.page_content <span class="cf">for</span> doc <span class="kw">in</span> docs)</span>
<span id="cb64-28"><a href="#cb64-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-29"><a href="#cb64-29" aria-hidden="true" tabindex="-1"></a><span class="co"># 使用 LCEL 构建 RAG 链</span></span>
<span id="cb64-30"><a href="#cb64-30" aria-hidden="true" tabindex="-1"></a>rag_chain <span class="op">=</span> (</span>
<span id="cb64-31"><a href="#cb64-31" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb64-32"><a href="#cb64-32" aria-hidden="true" tabindex="-1"></a>        <span class="st">"context"</span>: retriever <span class="op">|</span> format_docs,</span>
<span id="cb64-33"><a href="#cb64-33" aria-hidden="true" tabindex="-1"></a>        <span class="st">"question"</span>: RunnablePassthrough()</span>
<span id="cb64-34"><a href="#cb64-34" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb64-35"><a href="#cb64-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">|</span> prompt</span>
<span id="cb64-36"><a href="#cb64-36" aria-hidden="true" tabindex="-1"></a>    <span class="op">|</span> llm</span>
<span id="cb64-37"><a href="#cb64-37" aria-hidden="true" tabindex="-1"></a>    <span class="op">|</span> StrOutputParser()</span>
<span id="cb64-38"><a href="#cb64-38" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb64-39"><a href="#cb64-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-40"><a href="#cb64-40" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"✓ RAG 链创建成功！"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>✓ RAG 链创建成功！</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 测试 RAG 链</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>question <span class="op">=</span> <span class="st">"What are model variants?"</span></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">查询问题: </span><span class="sc">{</span>question<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
查询问题: What are model variants?</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 独立获取上下文文档以便展示</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>context_docs <span class="op">=</span> retriever.invoke(question)</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 调用 RAG 链</span></span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>answer <span class="op">=</span> rag_chain.invoke(question)</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> textwrap</span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> line <span class="kw">in</span> answer.split(<span class="st">'</span><span class="ch">\n</span><span class="st">'</span>):</span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(textwrap.fill(line, width<span class="op">=</span><span class="dv">80</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>模型变体是可以附加在模型标识符后面的后缀，用来改变化模型的行为或路由方式。静态变体（如
`:free`、`:beta`、`:extended`、`:exacto`、`:thinking`）仅适用于特定模型，而动态变体（如
`:online`、`:nitro`、`:floor`）可在所有模型上使用，分别提供网络搜索、优先高吞吐或低价格的路由策略。</code></pre>
</div>
</div>
</section>
</div>
</div>
</div>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/jcwinning\.github\.io\/LandingPage");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb70" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "R 和 Python 中的检索增强生成 (RAG)"</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> "Tony D"</span></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> "2025-11-02"</span></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a><span class="an">categories:</span><span class="co"> [AI, API, tutorial]</span></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a><span class="an">image:</span><span class="co"> "images.png"</span></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: true</span></span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a><span class="co">    code-copy: true</span></span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span></span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-16"><a href="#cb70-16" aria-hidden="true" tabindex="-1"></a><span class="co">  warning: false</span></span>
<span id="cb70-17"><a href="#cb70-17" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb70-18"><a href="#cb70-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-19"><a href="#cb70-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-20"><a href="#cb70-20" aria-hidden="true" tabindex="-1"></a><span class="in">```{r setup, include=FALSE}</span></span>
<span id="cb70-21"><a href="#cb70-21" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(reticulate)</span>
<span id="cb70-22"><a href="#cb70-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-23"><a href="#cb70-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Use Python 3.13</span></span>
<span id="cb70-24"><a href="#cb70-24" aria-hidden="true" tabindex="-1"></a><span class="fu">use_python</span>(<span class="st">"/Library/Frameworks/Python.framework/Versions/3.13/bin/python3"</span>, <span class="at">required =</span> <span class="cn">TRUE</span>)</span>
<span id="cb70-25"><a href="#cb70-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-26"><a href="#cb70-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Install required packages</span></span>
<span id="cb70-27"><a href="#cb70-27" aria-hidden="true" tabindex="-1"></a><span class="fu">py_install</span>(<span class="fu">c</span>(<span class="st">"openai"</span>, <span class="st">"langchain-core"</span>, <span class="st">"langchain-chroma"</span>, <span class="st">"langchain-community"</span>, <span class="st">"langchain-openai"</span>, <span class="st">"markitdown"</span>, <span class="st">"beautifulsoup4"</span>, <span class="st">"python-dotenv"</span>, <span class="st">"llama-index"</span>, <span class="st">"llama-index-vector-stores-duckdb"</span>), <span class="at">pip =</span> <span class="cn">TRUE</span>)</span>
<span id="cb70-28"><a href="#cb70-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-29"><a href="#cb70-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify Python</span></span>
<span id="cb70-30"><a href="#cb70-30" aria-hidden="true" tabindex="-1"></a><span class="fu">py_config</span>()</span>
<span id="cb70-31"><a href="#cb70-31" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-32"><a href="#cb70-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-33"><a href="#cb70-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-34"><a href="#cb70-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-35"><a href="#cb70-35" aria-hidden="true" tabindex="-1"></a><span class="fu"># 简介</span></span>
<span id="cb70-36"><a href="#cb70-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-37"><a href="#cb70-37" aria-hidden="true" tabindex="-1"></a>检索增强生成 (Retrieval-Augmented Generation, RAG) 是一种强大的技术，它将大型语言模型 (LLM) 的生成能力与信息检索的精准性相结合。通过将 LLM 的响应锚定在外部、可验证的数据中，RAG 减少了幻觉，并使模型能够回答关于特定、私有或最新信息的问题。</span>
<span id="cb70-38"><a href="#cb70-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-39"><a href="#cb70-39" aria-hidden="true" tabindex="-1"></a>在本教程中，我们将使用 R 和 Python 构建一个 RAG 系统。</span>
<span id="cb70-40"><a href="#cb70-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-41"><a href="#cb70-41" aria-hidden="true" tabindex="-1"></a>在 R 中，我们将利用 <span class="in">`ragnar`</span> 包处理 RAG 工作流，并使用 <span class="in">`ellmer`</span> 提供聊天界面。</span>
<span id="cb70-42"><a href="#cb70-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-43"><a href="#cb70-43" aria-hidden="true" tabindex="-1"></a>在 Python 中，我们将使用 <span class="in">`LangChain`</span> 构建 RAG 流水线，使用 <span class="in">`ChromaDB`</span> 作为向量数据库，并使用 <span class="in">`OpenAI`</span> 进行模型交互。</span>
<span id="cb70-44"><a href="#cb70-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-45"><a href="#cb70-45" aria-hidden="true" tabindex="-1"></a>我们的目标是创建一个系统，通过爬取 OpenRouter API 的文档，来回答与其相关的问题。</span>
<span id="cb70-46"><a href="#cb70-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-47"><a href="#cb70-47" aria-hidden="true" tabindex="-1"></a><span class="fu"># 数据采集</span></span>
<span id="cb70-48"><a href="#cb70-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-49"><a href="#cb70-49" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb70-50"><a href="#cb70-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-51"><a href="#cb70-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-52"><a href="#cb70-52" aria-hidden="true" tabindex="-1"></a><span class="fu">## R</span></span>
<span id="cb70-53"><a href="#cb70-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-54"><a href="#cb70-54" aria-hidden="true" tabindex="-1"></a>首先，我们需要为知识库收集数据。我们将使用 <span class="in">`rvest`</span> 包从 OpenRouter 文档中爬取 URL。这将为我们提供待接入的页面列表。</span>
<span id="cb70-55"><a href="#cb70-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-56"><a href="#cb70-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-59"><a href="#cb70-59" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb70-60"><a href="#cb70-60" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ragnar)</span>
<span id="cb70-61"><a href="#cb70-61" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ellmer)</span>
<span id="cb70-62"><a href="#cb70-62" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dotenv)</span>
<span id="cb70-63"><a href="#cb70-63" aria-hidden="true" tabindex="-1"></a><span class="fu">load_dot_env</span>(<span class="at">file =</span> <span class="st">".env"</span>)</span>
<span id="cb70-64"><a href="#cb70-64" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-65"><a href="#cb70-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-68"><a href="#cb70-68" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb70-69"><a href="#cb70-69" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rvest)</span>
<span id="cb70-70"><a href="#cb70-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-71"><a href="#cb70-71" aria-hidden="true" tabindex="-1"></a><span class="co"># 待爬取的 URL</span></span>
<span id="cb70-72"><a href="#cb70-72" aria-hidden="true" tabindex="-1"></a>url <span class="ot">&lt;-</span> <span class="st">"https://openrouter.ai/docs/quickstart"</span></span>
<span id="cb70-73"><a href="#cb70-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-74"><a href="#cb70-74" aria-hidden="true" tabindex="-1"></a><span class="co"># 读取页面的 HTML 内容</span></span>
<span id="cb70-75"><a href="#cb70-75" aria-hidden="true" tabindex="-1"></a>page <span class="ot">&lt;-</span> <span class="fu">read_html</span>(url)</span>
<span id="cb70-76"><a href="#cb70-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-77"><a href="#cb70-77" aria-hidden="true" tabindex="-1"></a><span class="co"># 提取所有带有 href 的 &lt;a&gt; 标签</span></span>
<span id="cb70-78"><a href="#cb70-78" aria-hidden="true" tabindex="-1"></a>links <span class="ot">&lt;-</span> page <span class="sc">%&gt;%</span></span>
<span id="cb70-79"><a href="#cb70-79" aria-hidden="true" tabindex="-1"></a>    <span class="fu">html_nodes</span>(<span class="st">"a"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb70-80"><a href="#cb70-80" aria-hidden="true" tabindex="-1"></a>    <span class="fu">html_attr</span>(<span class="st">"href"</span>)</span>
<span id="cb70-81"><a href="#cb70-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-82"><a href="#cb70-82" aria-hidden="true" tabindex="-1"></a><span class="co"># 移除空值和重复项</span></span>
<span id="cb70-83"><a href="#cb70-83" aria-hidden="true" tabindex="-1"></a>links <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">na.omit</span>(links))</span>
<span id="cb70-84"><a href="#cb70-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-85"><a href="#cb70-85" aria-hidden="true" tabindex="-1"></a><span class="co"># 可选：仅保留完整 URL</span></span>
<span id="cb70-86"><a href="#cb70-86" aria-hidden="true" tabindex="-1"></a>links_full <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"https://openrouter.ai"</span>, links[<span class="fu">grepl</span>(<span class="st">"^/docs/"</span>, links)])</span>
<span id="cb70-87"><a href="#cb70-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-88"><a href="#cb70-88" aria-hidden="true" tabindex="-1"></a><span class="co"># 打印所有链接</span></span>
<span id="cb70-89"><a href="#cb70-89" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(links_full)</span>
<span id="cb70-90"><a href="#cb70-90" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-91"><a href="#cb70-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-92"><a href="#cb70-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-93"><a href="#cb70-93" aria-hidden="true" tabindex="-1"></a><span class="fu">## Python </span></span>
<span id="cb70-94"><a href="#cb70-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-95"><a href="#cb70-95" aria-hidden="true" tabindex="-1"></a>首先，我们需要为知识库收集数据。我们将使用 <span class="in">`requests`</span> 和 <span class="in">`BeautifulSoup`</span> 从 OpenRouter 文档中爬取 URL。这将为我们提供待接入的页面列表。</span>
<span id="cb70-96"><a href="#cb70-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-99"><a href="#cb70-99" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb70-100"><a href="#cb70-100" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb70-101"><a href="#cb70-101" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(sys.executable)</span>
<span id="cb70-102"><a href="#cb70-102" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-103"><a href="#cb70-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-106"><a href="#cb70-106" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb70-107"><a href="#cb70-107" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb70-108"><a href="#cb70-108" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> bs4 <span class="im">import</span> BeautifulSoup</span>
<span id="cb70-109"><a href="#cb70-109" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dotenv <span class="im">import</span> load_dotenv</span>
<span id="cb70-110"><a href="#cb70-110" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb70-111"><a href="#cb70-111" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> markitdown <span class="im">import</span> MarkItDown</span>
<span id="cb70-112"><a href="#cb70-112" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> io <span class="im">import</span> BytesIO</span>
<span id="cb70-113"><a href="#cb70-113" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb70-114"><a href="#cb70-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-115"><a href="#cb70-115" aria-hidden="true" tabindex="-1"></a><span class="co"># 加载环境变量</span></span>
<span id="cb70-116"><a href="#cb70-116" aria-hidden="true" tabindex="-1"></a>load_dotenv()</span>
<span id="cb70-117"><a href="#cb70-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-118"><a href="#cb70-118" aria-hidden="true" tabindex="-1"></a><span class="co"># 辅助函数</span></span>
<span id="cb70-119"><a href="#cb70-119" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fetch_html(url: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">bytes</span>:</span>
<span id="cb70-120"><a href="#cb70-120" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""从 URL 获取 HTML 内容并以字节形式返回。"""</span></span>
<span id="cb70-121"><a href="#cb70-121" aria-hidden="true" tabindex="-1"></a>    resp <span class="op">=</span> requests.get(url)</span>
<span id="cb70-122"><a href="#cb70-122" aria-hidden="true" tabindex="-1"></a>    resp.raise_for_status()</span>
<span id="cb70-123"><a href="#cb70-123" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> resp.content</span>
<span id="cb70-124"><a href="#cb70-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-125"><a href="#cb70-125" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> html_to_markdown(html_bytes: <span class="bu">bytes</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb70-126"><a href="#cb70-126" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""使用 MarkItDown 将 HTML 字节转换为 Markdown。"""</span></span>
<span id="cb70-127"><a href="#cb70-127" aria-hidden="true" tabindex="-1"></a>    md <span class="op">=</span> MarkItDown()</span>
<span id="cb70-128"><a href="#cb70-128" aria-hidden="true" tabindex="-1"></a>    stream <span class="op">=</span> BytesIO(html_bytes)</span>
<span id="cb70-129"><a href="#cb70-129" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> md.convert_stream(stream, mime_type<span class="op">=</span><span class="st">"text/html"</span>)</span>
<span id="cb70-130"><a href="#cb70-130" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result.markdown</span>
<span id="cb70-131"><a href="#cb70-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-132"><a href="#cb70-132" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> save_markdown(md_content: <span class="bu">str</span>, output_path: <span class="bu">str</span>):</span>
<span id="cb70-133"><a href="#cb70-133" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""将 Markdown 内容保存到文件。"""</span></span>
<span id="cb70-134"><a href="#cb70-134" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(output_path, <span class="st">"w"</span>, encoding<span class="op">=</span><span class="st">"utf-8"</span>) <span class="im">as</span> f:</span>
<span id="cb70-135"><a href="#cb70-135" aria-hidden="true" tabindex="-1"></a>        f.write(md_content)</span>
<span id="cb70-136"><a href="#cb70-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-137"><a href="#cb70-137" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sanitize_filename(filename: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb70-138"><a href="#cb70-138" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""清理 URL 以创建合法的文件名。"""</span></span>
<span id="cb70-139"><a href="#cb70-139" aria-hidden="true" tabindex="-1"></a>    filename <span class="op">=</span> re.sub(<span class="vs">r'</span><span class="dv">^</span><span class="vs">https</span><span class="op">?</span><span class="vs">://</span><span class="pp">[^/]</span><span class="op">+</span><span class="vs">'</span>, <span class="st">''</span>, filename)</span>
<span id="cb70-140"><a href="#cb70-140" aria-hidden="true" tabindex="-1"></a>    filename <span class="op">=</span> re.sub(<span class="vs">r'</span><span class="pp">[^</span><span class="dv">\w</span><span class="ch">\-</span><span class="pp">_.]</span><span class="vs">'</span>, <span class="st">'_'</span>, filename)</span>
<span id="cb70-141"><a href="#cb70-141" aria-hidden="true" tabindex="-1"></a>    filename <span class="op">=</span> filename.strip(<span class="st">'_'</span>)</span>
<span id="cb70-142"><a href="#cb70-142" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> filename.endswith(<span class="st">'.md'</span>):</span>
<span id="cb70-143"><a href="#cb70-143" aria-hidden="true" tabindex="-1"></a>        filename <span class="op">+=</span> <span class="st">'.md'</span></span>
<span id="cb70-144"><a href="#cb70-144" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> filename</span>
<span id="cb70-145"><a href="#cb70-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-146"><a href="#cb70-146" aria-hidden="true" tabindex="-1"></a><span class="co"># 待爬取的 URL</span></span>
<span id="cb70-147"><a href="#cb70-147" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">"https://openrouter.ai/docs/quickstart"</span></span>
<span id="cb70-148"><a href="#cb70-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-149"><a href="#cb70-149" aria-hidden="true" tabindex="-1"></a><span class="co"># 读取页面的 HTML 内容</span></span>
<span id="cb70-150"><a href="#cb70-150" aria-hidden="true" tabindex="-1"></a>response <span class="op">=</span> requests.get(url)</span>
<span id="cb70-151"><a href="#cb70-151" aria-hidden="true" tabindex="-1"></a>soup <span class="op">=</span> BeautifulSoup(response.content, <span class="st">'html.parser'</span>)</span>
<span id="cb70-152"><a href="#cb70-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-153"><a href="#cb70-153" aria-hidden="true" tabindex="-1"></a><span class="co"># 提取所有带有 href 的 &lt;a&gt; 标签</span></span>
<span id="cb70-154"><a href="#cb70-154" aria-hidden="true" tabindex="-1"></a>links <span class="op">=</span> [a[<span class="st">'href'</span>] <span class="cf">for</span> a <span class="kw">in</span> soup.find_all(<span class="st">'a'</span>, href<span class="op">=</span><span class="va">True</span>)]</span>
<span id="cb70-155"><a href="#cb70-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-156"><a href="#cb70-156" aria-hidden="true" tabindex="-1"></a><span class="co"># 移除重复项</span></span>
<span id="cb70-157"><a href="#cb70-157" aria-hidden="true" tabindex="-1"></a>links <span class="op">=</span> <span class="bu">list</span>(<span class="bu">set</span>(links))</span>
<span id="cb70-158"><a href="#cb70-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-159"><a href="#cb70-159" aria-hidden="true" tabindex="-1"></a><span class="co"># 仅保留文档的完整 URL</span></span>
<span id="cb70-160"><a href="#cb70-160" aria-hidden="true" tabindex="-1"></a>links_full <span class="op">=</span> [<span class="ss">f"https://openrouter.ai</span><span class="sc">{</span>link<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> link <span class="kw">in</span> links <span class="cf">if</span> link.startswith(<span class="st">"/docs/"</span>)]</span>
<span id="cb70-161"><a href="#cb70-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-162"><a href="#cb70-162" aria-hidden="true" tabindex="-1"></a><span class="co"># 显式添加 FAQ</span></span>
<span id="cb70-163"><a href="#cb70-163" aria-hidden="true" tabindex="-1"></a>links_full.append(<span class="st">"https://openrouter.ai/docs/faq"</span>)</span>
<span id="cb70-164"><a href="#cb70-164" aria-hidden="true" tabindex="-1"></a>links_full <span class="op">=</span> <span class="bu">list</span>(<span class="bu">set</span>(links_full))</span>
<span id="cb70-165"><a href="#cb70-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-166"><a href="#cb70-166" aria-hidden="true" tabindex="-1"></a><span class="co"># 打印所有链接</span></span>
<span id="cb70-167"><a href="#cb70-167" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"找到 </span><span class="sc">{</span><span class="bu">len</span>(links_full)<span class="sc">}</span><span class="ss"> 个文档 URL"</span>)</span>
<span id="cb70-168"><a href="#cb70-168" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(links_full)</span>
<span id="cb70-169"><a href="#cb70-169" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-170"><a href="#cb70-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-171"><a href="#cb70-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-172"><a href="#cb70-172" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb70-173"><a href="#cb70-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-174"><a href="#cb70-174" aria-hidden="true" tabindex="-1"></a><span class="fu"># 将网页内容保存到本地</span></span>
<span id="cb70-175"><a href="#cb70-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-176"><a href="#cb70-176" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb70-177"><a href="#cb70-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-178"><a href="#cb70-178" aria-hidden="true" tabindex="-1"></a><span class="fu">## R</span></span>
<span id="cb70-179"><a href="#cb70-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-180"><a href="#cb70-180" aria-hidden="true" tabindex="-1"></a>为了进行语义搜索，我们需要将文本数据存储为向量（嵌入）。我们将使用 <span class="in">`DuckDB`</span> 作为本地向量数据库。我们还需要一个嵌入模型将文本转换为向量。在这里，我们配置 <span class="in">`ragnar`</span> 通过 OpenAI 兼容的 API (SiliconFlow) 使用特定的嵌入模型。</span>
<span id="cb70-181"><a href="#cb70-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-182"><a href="#cb70-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-185"><a href="#cb70-185" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb70-186"><a href="#cb70-186" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb70-187"><a href="#cb70-187" aria-hidden="true" tabindex="-1"></a><span class="co"># pages &lt;- ragnar_find_links(base_url)</span></span>
<span id="cb70-188"><a href="#cb70-188" aria-hidden="true" tabindex="-1"></a>pages <span class="ot">&lt;-</span> links_full</span>
<span id="cb70-189"><a href="#cb70-189" aria-hidden="true" tabindex="-1"></a>store_location <span class="ot">&lt;-</span> <span class="st">"openrouter.duckdb"</span></span>
<span id="cb70-190"><a href="#cb70-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-191"><a href="#cb70-191" aria-hidden="true" tabindex="-1"></a>store <span class="ot">&lt;-</span> <span class="fu">ragnar_store_create</span>(</span>
<span id="cb70-192"><a href="#cb70-192" aria-hidden="true" tabindex="-1"></a>    store_location,</span>
<span id="cb70-193"><a href="#cb70-193" aria-hidden="true" tabindex="-1"></a>    <span class="at">overwrite =</span> <span class="cn">TRUE</span>,</span>
<span id="cb70-194"><a href="#cb70-194" aria-hidden="true" tabindex="-1"></a>    <span class="at">embed =</span> \(x) ragnar<span class="sc">::</span><span class="fu">embed_openai</span>(x,</span>
<span id="cb70-195"><a href="#cb70-195" aria-hidden="true" tabindex="-1"></a>        <span class="at">model =</span> <span class="st">"BAAI/bge-m3"</span>,</span>
<span id="cb70-196"><a href="#cb70-196" aria-hidden="true" tabindex="-1"></a>        <span class="at">base_url =</span> <span class="st">"https://api.siliconflow.cn/v1"</span>,</span>
<span id="cb70-197"><a href="#cb70-197" aria-hidden="true" tabindex="-1"></a>        <span class="at">api_key =</span> <span class="fu">Sys.getenv</span>(<span class="st">"siliconflow"</span>)</span>
<span id="cb70-198"><a href="#cb70-198" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb70-199"><a href="#cb70-199" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb70-200"><a href="#cb70-200" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-201"><a href="#cb70-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-202"><a href="#cb70-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-203"><a href="#cb70-203" aria-hidden="true" tabindex="-1"></a>在存储初始化后，我们现在可以接入数据。我们遍历之前爬取的页面列表。对于每个页面，我们：</span>
<span id="cb70-204"><a href="#cb70-204" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>以 Markdown 格式读取内容。</span>
<span id="cb70-205"><a href="#cb70-205" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>将内容拆分为较小的块（约 600 字符）。</span>
<span id="cb70-206"><a href="#cb70-206" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>将这些块插入到我们的向量数据库中。</span>
<span id="cb70-207"><a href="#cb70-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-208"><a href="#cb70-208" aria-hidden="true" tabindex="-1"></a>此过程构建了我们将要搜索的索引。</span>
<span id="cb70-209"><a href="#cb70-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-210"><a href="#cb70-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-213"><a href="#cb70-213" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb70-214"><a href="#cb70-214" aria-hidden="true" tabindex="-1"></a><span class="co"># page="https://openrouter.ai/docs/faq"</span></span>
<span id="cb70-215"><a href="#cb70-215" aria-hidden="true" tabindex="-1"></a><span class="co"># chunks &lt;- page |&gt;read_as_markdown() |&gt;markdown_chunk(target_size = 2000)</span></span>
<span id="cb70-216"><a href="#cb70-216" aria-hidden="true" tabindex="-1"></a><span class="co"># ragnar_chunks_view(chunks)</span></span>
<span id="cb70-217"><a href="#cb70-217" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-218"><a href="#cb70-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-219"><a href="#cb70-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-222"><a href="#cb70-222" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb70-223"><a href="#cb70-223" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb70-224"><a href="#cb70-224" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (page <span class="cf">in</span> pages) {</span>
<span id="cb70-225"><a href="#cb70-225" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"正在接入: "</span>, page)</span>
<span id="cb70-226"><a href="#cb70-226" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(page)</span>
<span id="cb70-227"><a href="#cb70-227" aria-hidden="true" tabindex="-1"></a>    chunks <span class="ot">&lt;-</span> page <span class="sc">|&gt;</span></span>
<span id="cb70-228"><a href="#cb70-228" aria-hidden="true" tabindex="-1"></a>        <span class="fu">read_as_markdown</span>() <span class="sc">|&gt;</span></span>
<span id="cb70-229"><a href="#cb70-229" aria-hidden="true" tabindex="-1"></a>        <span class="fu">markdown_chunk</span>(<span class="at">target_size =</span> <span class="dv">2000</span>)</span>
<span id="cb70-230"><a href="#cb70-230" aria-hidden="true" tabindex="-1"></a>    <span class="co"># print(chunks)</span></span>
<span id="cb70-231"><a href="#cb70-231" aria-hidden="true" tabindex="-1"></a>    <span class="co"># print('chunks done')</span></span>
<span id="cb70-232"><a href="#cb70-232" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ragnar_store_insert</span>(store, chunks)</span>
<span id="cb70-233"><a href="#cb70-233" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="st">"插入完成"</span>)</span>
<span id="cb70-234"><a href="#cb70-234" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb70-235"><a href="#cb70-235" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-236"><a href="#cb70-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-237"><a href="#cb70-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-238"><a href="#cb70-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-241"><a href="#cb70-241" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb70-242"><a href="#cb70-242" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb70-243"><a href="#cb70-243" aria-hidden="true" tabindex="-1"></a><span class="fu">ragnar_store_build_index</span>(store)</span>
<span id="cb70-244"><a href="#cb70-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-245"><a href="#cb70-245" aria-hidden="true" tabindex="-1"></a><span class="co"># 释放连接以供后续 Python 代码使用</span></span>
<span id="cb70-246"><a href="#cb70-246" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(store)</span>
<span id="cb70-247"><a href="#cb70-247" aria-hidden="true" tabindex="-1"></a><span class="fu">gc</span>()</span>
<span id="cb70-248"><a href="#cb70-248" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-249"><a href="#cb70-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-250"><a href="#cb70-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-251"><a href="#cb70-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-252"><a href="#cb70-252" aria-hidden="true" tabindex="-1"></a><span class="fu">## Python DuckDB</span></span>
<span id="cb70-255"><a href="#cb70-255" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb70-256"><a href="#cb70-256" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb70-257"><a href="#cb70-257" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb70-258"><a href="#cb70-258" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> llama_index.core <span class="im">import</span> SimpleDirectoryReader, VectorStoreIndex, StorageContext, Settings</span>
<span id="cb70-259"><a href="#cb70-259" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> llama_index.vector_stores.duckdb <span class="im">import</span> DuckDBVectorStore</span>
<span id="cb70-260"><a href="#cb70-260" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> llama_index.embeddings.openai <span class="im">import</span> OpenAIEmbedding</span>
<span id="cb70-261"><a href="#cb70-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-262"><a href="#cb70-262" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 1. 配置 ---</span></span>
<span id="cb70-263"><a href="#cb70-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-264"><a href="#cb70-264" aria-hidden="true" tabindex="-1"></a><span class="co"># 确保 API 密钥可用</span></span>
<span id="cb70-265"><a href="#cb70-265" aria-hidden="true" tabindex="-1"></a>openrouter_api_key <span class="op">=</span> os.getenv(<span class="st">"OPENROUTER_API_KEY"</span>) <span class="co"># 或直接粘贴字符串</span></span>
<span id="cb70-266"><a href="#cb70-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-267"><a href="#cb70-267" aria-hidden="true" tabindex="-1"></a><span class="co"># 初始化指向 OpenRouter 的嵌入模型</span></span>
<span id="cb70-268"><a href="#cb70-268" aria-hidden="true" tabindex="-1"></a><span class="co"># 我们使用 OpenAI 类，因为 OpenRouter 使用了 OpenAI 兼容的 API 结构</span></span>
<span id="cb70-269"><a href="#cb70-269" aria-hidden="true" tabindex="-1"></a>embed_model <span class="op">=</span> OpenAIEmbedding(</span>
<span id="cb70-270"><a href="#cb70-270" aria-hidden="true" tabindex="-1"></a>    api_key<span class="op">=</span>openrouter_api_key,</span>
<span id="cb70-271"><a href="#cb70-271" aria-hidden="true" tabindex="-1"></a>    base_url<span class="op">=</span><span class="st">"https://openrouter.ai/api/v1"</span>,</span>
<span id="cb70-272"><a href="#cb70-272" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span><span class="st">"qwen/qwen3-embedding-8b"</span>  </span>
<span id="cb70-273"><a href="#cb70-273" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb70-274"><a href="#cb70-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-275"><a href="#cb70-275" aria-hidden="true" tabindex="-1"></a><span class="co"># 更新全局设置，以便 LlamaIndex 知道使用此模型</span></span>
<span id="cb70-276"><a href="#cb70-276" aria-hidden="true" tabindex="-1"></a>Settings.embed_model <span class="op">=</span> embed_model</span>
<span id="cb70-277"><a href="#cb70-277" aria-hidden="true" tabindex="-1"></a>Settings.chunk_size <span class="op">=</span> <span class="dv">2000</span></span>
<span id="cb70-278"><a href="#cb70-278" aria-hidden="true" tabindex="-1"></a>Settings.chunk_overlap <span class="op">=</span> <span class="dv">200</span></span>
<span id="cb70-279"><a href="#cb70-279" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 2. 接入与索引 ---</span></span>
<span id="cb70-280"><a href="#cb70-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-281"><a href="#cb70-281" aria-hidden="true" tabindex="-1"></a><span class="co"># 加载数据</span></span>
<span id="cb70-282"><a href="#cb70-282" aria-hidden="true" tabindex="-1"></a>documents <span class="op">=</span> SimpleDirectoryReader(<span class="st">"markdown_docs"</span>).load_data()</span>
<span id="cb70-283"><a href="#cb70-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-284"><a href="#cb70-284" aria-hidden="true" tabindex="-1"></a><span class="co"># 初始化 DuckDB 向量数据库</span></span>
<span id="cb70-285"><a href="#cb70-285" aria-hidden="true" tabindex="-1"></a>vector_store <span class="op">=</span> DuckDBVectorStore(<span class="st">"openrouter.duckdb"</span>, persist_dir<span class="op">=</span><span class="st">"./persist/"</span>)</span>
<span id="cb70-286"><a href="#cb70-286" aria-hidden="true" tabindex="-1"></a>storage_context <span class="op">=</span> StorageContext.from_defaults(vector_store<span class="op">=</span>vector_store)</span>
<span id="cb70-287"><a href="#cb70-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-288"><a href="#cb70-288" aria-hidden="true" tabindex="-1"></a><span class="co"># 创建索引</span></span>
<span id="cb70-289"><a href="#cb70-289" aria-hidden="true" tabindex="-1"></a><span class="co"># 这将自动使用 Settings 中定义的 Qwen 嵌入</span></span>
<span id="cb70-290"><a href="#cb70-290" aria-hidden="true" tabindex="-1"></a>index <span class="op">=</span> VectorStoreIndex.from_documents(</span>
<span id="cb70-291"><a href="#cb70-291" aria-hidden="true" tabindex="-1"></a>    documents, </span>
<span id="cb70-292"><a href="#cb70-292" aria-hidden="true" tabindex="-1"></a>    storage_context<span class="op">=</span>storage_context</span>
<span id="cb70-293"><a href="#cb70-293" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb70-294"><a href="#cb70-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-295"><a href="#cb70-295" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-296"><a href="#cb70-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-297"><a href="#cb70-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-298"><a href="#cb70-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-299"><a href="#cb70-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-300"><a href="#cb70-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-301"><a href="#cb70-301" aria-hidden="true" tabindex="-1"></a><span class="fu">## Python Chroma</span></span>
<span id="cb70-302"><a href="#cb70-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-303"><a href="#cb70-303" aria-hidden="true" tabindex="-1"></a>为了进行语义搜索，我们需要将文本数据转换为向量（嵌入）进行存储。我们将使用 <span class="in">`ChromaDB`</span> 作为本地向量数据库。我们还需要一个嵌入模型把文本转为向量。在这里，我们配置了一个自定义的 <span class="in">`OpenRouterEmbeddings`</span> 类，通过 OpenRouter API 使用 <span class="in">`qwen/qwen3-embedding-8b`</span> 模型。</span>
<span id="cb70-304"><a href="#cb70-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-305"><a href="#cb70-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-308"><a href="#cb70-308" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb70-309"><a href="#cb70-309" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb70-310"><a href="#cb70-310" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> openai <span class="im">import</span> OpenAI</span>
<span id="cb70-311"><a href="#cb70-311" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain_core.embeddings <span class="im">import</span> Embeddings</span>
<span id="cb70-312"><a href="#cb70-312" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain_chroma <span class="im">import</span> Chroma</span>
<span id="cb70-313"><a href="#cb70-313" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List</span>
<span id="cb70-314"><a href="#cb70-314" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb70-315"><a href="#cb70-315" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dotenv <span class="im">import</span> load_dotenv</span>
<span id="cb70-316"><a href="#cb70-316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-317"><a href="#cb70-317" aria-hidden="true" tabindex="-1"></a>load_dotenv()</span>
<span id="cb70-318"><a href="#cb70-318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-319"><a href="#cb70-319" aria-hidden="true" tabindex="-1"></a><span class="co"># 针对 OpenRouter API 的自定义嵌入类</span></span>
<span id="cb70-320"><a href="#cb70-320" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> OpenRouterEmbeddings(Embeddings):</span>
<span id="cb70-321"><a href="#cb70-321" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""针对 OpenRouter API 的自定义嵌入类。"""</span></span>
<span id="cb70-322"><a href="#cb70-322" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-323"><a href="#cb70-323" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, api_key: <span class="bu">str</span>, model: <span class="bu">str</span> <span class="op">=</span> <span class="st">"text-embedding-3-small"</span>):</span>
<span id="cb70-324"><a href="#cb70-324" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.client <span class="op">=</span> OpenAI(</span>
<span id="cb70-325"><a href="#cb70-325" aria-hidden="true" tabindex="-1"></a>            base_url<span class="op">=</span><span class="st">"https://openrouter.ai/api/v1"</span>,</span>
<span id="cb70-326"><a href="#cb70-326" aria-hidden="true" tabindex="-1"></a>            api_key<span class="op">=</span>api_key,</span>
<span id="cb70-327"><a href="#cb70-327" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb70-328"><a href="#cb70-328" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model <span class="op">=</span> model</span>
<span id="cb70-329"><a href="#cb70-329" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-330"><a href="#cb70-330" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> embed_documents(<span class="va">self</span>, texts: List[<span class="bu">str</span>]) <span class="op">-&gt;</span> List[List[<span class="bu">float</span>]]:</span>
<span id="cb70-331"><a href="#cb70-331" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""对文档列表进行嵌入。"""</span></span>
<span id="cb70-332"><a href="#cb70-332" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> <span class="va">self</span>.client.embeddings.create(</span>
<span id="cb70-333"><a href="#cb70-333" aria-hidden="true" tabindex="-1"></a>            extra_headers<span class="op">=</span>{</span>
<span id="cb70-334"><a href="#cb70-334" aria-hidden="true" tabindex="-1"></a>                <span class="st">"HTTP-Referer"</span>: <span class="st">"https://ai-blog.com"</span>,</span>
<span id="cb70-335"><a href="#cb70-335" aria-hidden="true" tabindex="-1"></a>                <span class="st">"X-Title"</span>: <span class="st">"AI Blog RAG"</span>,</span>
<span id="cb70-336"><a href="#cb70-336" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb70-337"><a href="#cb70-337" aria-hidden="true" tabindex="-1"></a>            model<span class="op">=</span><span class="va">self</span>.model,</span>
<span id="cb70-338"><a href="#cb70-338" aria-hidden="true" tabindex="-1"></a>            <span class="bu">input</span><span class="op">=</span>texts,</span>
<span id="cb70-339"><a href="#cb70-339" aria-hidden="true" tabindex="-1"></a>            encoding_format<span class="op">=</span><span class="st">"float"</span></span>
<span id="cb70-340"><a href="#cb70-340" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb70-341"><a href="#cb70-341" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [item.embedding <span class="cf">for</span> item <span class="kw">in</span> response.data]</span>
<span id="cb70-342"><a href="#cb70-342" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-343"><a href="#cb70-343" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> embed_query(<span class="va">self</span>, text: <span class="bu">str</span>) <span class="op">-&gt;</span> List[<span class="bu">float</span>]:</span>
<span id="cb70-344"><a href="#cb70-344" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""对单个查询进行嵌入。"""</span></span>
<span id="cb70-345"><a href="#cb70-345" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> <span class="va">self</span>.client.embeddings.create(</span>
<span id="cb70-346"><a href="#cb70-346" aria-hidden="true" tabindex="-1"></a>            extra_headers<span class="op">=</span>{</span>
<span id="cb70-347"><a href="#cb70-347" aria-hidden="true" tabindex="-1"></a>                <span class="st">"HTTP-Referer"</span>: <span class="st">"https://ai-blog.com"</span>,</span>
<span id="cb70-348"><a href="#cb70-348" aria-hidden="true" tabindex="-1"></a>                <span class="st">"X-Title"</span>: <span class="st">"AI Blog RAG"</span>,</span>
<span id="cb70-349"><a href="#cb70-349" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb70-350"><a href="#cb70-350" aria-hidden="true" tabindex="-1"></a>            model<span class="op">=</span><span class="va">self</span>.model,</span>
<span id="cb70-351"><a href="#cb70-351" aria-hidden="true" tabindex="-1"></a>            <span class="bu">input</span><span class="op">=</span>text,</span>
<span id="cb70-352"><a href="#cb70-352" aria-hidden="true" tabindex="-1"></a>            encoding_format<span class="op">=</span><span class="st">"float"</span></span>
<span id="cb70-353"><a href="#cb70-353" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb70-354"><a href="#cb70-354" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> response.data[<span class="dv">0</span>].embedding</span>
<span id="cb70-355"><a href="#cb70-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-356"><a href="#cb70-356" aria-hidden="true" tabindex="-1"></a><span class="co"># 获取 OpenRouter API 密钥</span></span>
<span id="cb70-357"><a href="#cb70-357" aria-hidden="true" tabindex="-1"></a>openrouter_api_key <span class="op">=</span> os.getenv(<span class="st">"OPENROUTER_API_KEY"</span>)</span>
<span id="cb70-358"><a href="#cb70-358" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> openrouter_api_key:</span>
<span id="cb70-359"><a href="#cb70-359" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"未在环境变量中找到 OPENROUTER_API_KEY"</span>)</span>
<span id="cb70-360"><a href="#cb70-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-361"><a href="#cb70-361" aria-hidden="true" tabindex="-1"></a><span class="co"># 使用 OpenRouter 创建嵌入实例</span></span>
<span id="cb70-362"><a href="#cb70-362" aria-hidden="true" tabindex="-1"></a>embeddings <span class="op">=</span> OpenRouterEmbeddings(</span>
<span id="cb70-363"><a href="#cb70-363" aria-hidden="true" tabindex="-1"></a>    api_key<span class="op">=</span>openrouter_api_key,</span>
<span id="cb70-364"><a href="#cb70-364" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span><span class="st">"qwen/qwen3-embedding-8b"</span></span>
<span id="cb70-365"><a href="#cb70-365" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb70-366"><a href="#cb70-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-367"><a href="#cb70-367" aria-hidden="true" tabindex="-1"></a><span class="co"># 定义向量数据库位置</span></span>
<span id="cb70-368"><a href="#cb70-368" aria-hidden="true" tabindex="-1"></a>persist_directory <span class="op">=</span> <span class="st">"chroma_db_data"</span></span>
<span id="cb70-369"><a href="#cb70-369" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-370"><a href="#cb70-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-371"><a href="#cb70-371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-372"><a href="#cb70-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-373"><a href="#cb70-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-374"><a href="#cb70-374" aria-hidden="true" tabindex="-1"></a>在存储初始化后，我们现在可以接入数据。我们遍历之前保存的 Markdown 文件。对于每个文件，我们：</span>
<span id="cb70-375"><a href="#cb70-375" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>加载内容。</span>
<span id="cb70-376"><a href="#cb70-376" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>使用 <span class="in">`RecursiveCharacterTextSplitter`</span> 将内容拆分为较小的块（约 2000 字符）。</span>
<span id="cb70-377"><a href="#cb70-377" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>从这些块中创建一个新的 <span class="in">`Chroma`</span> 向量数据库。</span>
<span id="cb70-378"><a href="#cb70-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-379"><a href="#cb70-379" aria-hidden="true" tabindex="-1"></a>此过程构建了我们将要搜索的索引。</span>
<span id="cb70-380"><a href="#cb70-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-381"><a href="#cb70-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-382"><a href="#cb70-382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-385"><a href="#cb70-385" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb70-386"><a href="#cb70-386" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb70-387"><a href="#cb70-387" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain_core.documents <span class="im">import</span> Document</span>
<span id="cb70-388"><a href="#cb70-388" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain_text_splitters <span class="im">import</span> RecursiveCharacterTextSplitter</span>
<span id="cb70-389"><a href="#cb70-389" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> shutil</span>
<span id="cb70-390"><a href="#cb70-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-391"><a href="#cb70-391" aria-hidden="true" tabindex="-1"></a><span class="co"># 加载 Markdown 文件的辅助函数</span></span>
<span id="cb70-392"><a href="#cb70-392" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> load_markdown_files(directory: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">list</span>[Document]:</span>
<span id="cb70-393"><a href="#cb70-393" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""从目录加载所有 Markdown 文件并创建 Document 对象。"""</span></span>
<span id="cb70-394"><a href="#cb70-394" aria-hidden="true" tabindex="-1"></a>    documents <span class="op">=</span> []</span>
<span id="cb70-395"><a href="#cb70-395" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(directory):</span>
<span id="cb70-396"><a href="#cb70-396" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> documents</span>
<span id="cb70-397"><a href="#cb70-397" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb70-398"><a href="#cb70-398" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> filename <span class="kw">in</span> os.listdir(directory):</span>
<span id="cb70-399"><a href="#cb70-399" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> filename.endswith(<span class="st">'.md'</span>):</span>
<span id="cb70-400"><a href="#cb70-400" aria-hidden="true" tabindex="-1"></a>            filepath <span class="op">=</span> os.path.join(directory, filename)</span>
<span id="cb70-401"><a href="#cb70-401" aria-hidden="true" tabindex="-1"></a>            <span class="cf">with</span> <span class="bu">open</span>(filepath, <span class="st">'r'</span>, encoding<span class="op">=</span><span class="st">'utf-8'</span>) <span class="im">as</span> f:</span>
<span id="cb70-402"><a href="#cb70-402" aria-hidden="true" tabindex="-1"></a>                content <span class="op">=</span> f.read()</span>
<span id="cb70-403"><a href="#cb70-403" aria-hidden="true" tabindex="-1"></a>                doc <span class="op">=</span> Document(</span>
<span id="cb70-404"><a href="#cb70-404" aria-hidden="true" tabindex="-1"></a>                    page_content<span class="op">=</span>content,</span>
<span id="cb70-405"><a href="#cb70-405" aria-hidden="true" tabindex="-1"></a>                    metadata<span class="op">=</span>{</span>
<span id="cb70-406"><a href="#cb70-406" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"source"</span>: filename,</span>
<span id="cb70-407"><a href="#cb70-407" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"filepath"</span>: filepath</span>
<span id="cb70-408"><a href="#cb70-408" aria-hidden="true" tabindex="-1"></a>                    }</span>
<span id="cb70-409"><a href="#cb70-409" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb70-410"><a href="#cb70-410" aria-hidden="true" tabindex="-1"></a>                documents.append(doc)</span>
<span id="cb70-411"><a href="#cb70-411" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> documents</span>
<span id="cb70-412"><a href="#cb70-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-413"><a href="#cb70-413" aria-hidden="true" tabindex="-1"></a><span class="co"># 创建 Markdown 文件的输出目录</span></span>
<span id="cb70-414"><a href="#cb70-414" aria-hidden="true" tabindex="-1"></a>output_dir <span class="op">=</span> <span class="st">"markdown_docs"</span></span>
<span id="cb70-415"><a href="#cb70-415" aria-hidden="true" tabindex="-1"></a>os.makedirs(output_dir, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb70-416"><a href="#cb70-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-417"><a href="#cb70-417" aria-hidden="true" tabindex="-1"></a><span class="co"># 将每个 URL 转换为 Markdown 并保存</span></span>
<span id="cb70-418"><a href="#cb70-418" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, link_url <span class="kw">in</span> <span class="bu">enumerate</span>(links_full, <span class="dv">1</span>):</span>
<span id="cb70-419"><a href="#cb70-419" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb70-420"><a href="#cb70-420" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"正在处理 </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(links_full)<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>link_url<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb70-421"><a href="#cb70-421" aria-hidden="true" tabindex="-1"></a>        html_content <span class="op">=</span> fetch_html(link_url)</span>
<span id="cb70-422"><a href="#cb70-422" aria-hidden="true" tabindex="-1"></a>        markdown_content <span class="op">=</span> html_to_markdown(html_content)</span>
<span id="cb70-423"><a href="#cb70-423" aria-hidden="true" tabindex="-1"></a>        filename <span class="op">=</span> sanitize_filename(link_url)</span>
<span id="cb70-424"><a href="#cb70-424" aria-hidden="true" tabindex="-1"></a>        output_path <span class="op">=</span> os.path.join(output_dir, filename)</span>
<span id="cb70-425"><a href="#cb70-425" aria-hidden="true" tabindex="-1"></a>        save_markdown(markdown_content, output_path)</span>
<span id="cb70-426"><a href="#cb70-426" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  ✓ 已保存至 </span><span class="sc">{</span>output_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb70-427"><a href="#cb70-427" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb70-428"><a href="#cb70-428" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  ✗ 处理 </span><span class="sc">{</span>link_url<span class="sc">}</span><span class="ss"> 时出错: </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb70-429"><a href="#cb70-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-430"><a href="#cb70-430" aria-hidden="true" tabindex="-1"></a><span class="co"># 加载 Markdown 文档</span></span>
<span id="cb70-431"><a href="#cb70-431" aria-hidden="true" tabindex="-1"></a>documents <span class="op">=</span> load_markdown_files(output_dir)</span>
<span id="cb70-432"><a href="#cb70-432" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">加载了 </span><span class="sc">{</span><span class="bu">len</span>(documents)<span class="sc">}</span><span class="ss"> 个 Markdown 文档"</span>)</span>
<span id="cb70-433"><a href="#cb70-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-434"><a href="#cb70-434" aria-hidden="true" tabindex="-1"></a><span class="co"># 将文档拆分为块</span></span>
<span id="cb70-435"><a href="#cb70-435" aria-hidden="true" tabindex="-1"></a>text_splitter <span class="op">=</span> RecursiveCharacterTextSplitter(</span>
<span id="cb70-436"><a href="#cb70-436" aria-hidden="true" tabindex="-1"></a>    chunk_size<span class="op">=</span><span class="dv">2000</span>,</span>
<span id="cb70-437"><a href="#cb70-437" aria-hidden="true" tabindex="-1"></a>    chunk_overlap<span class="op">=</span><span class="dv">200</span>,</span>
<span id="cb70-438"><a href="#cb70-438" aria-hidden="true" tabindex="-1"></a>    length_function<span class="op">=</span><span class="bu">len</span>,</span>
<span id="cb70-439"><a href="#cb70-439" aria-hidden="true" tabindex="-1"></a>    is_separator_regex<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb70-440"><a href="#cb70-440" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb70-441"><a href="#cb70-441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-442"><a href="#cb70-442" aria-hidden="true" tabindex="-1"></a>splits <span class="op">=</span> text_splitter.split_documents(documents)</span>
<span id="cb70-443"><a href="#cb70-443" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"拆分为 </span><span class="sc">{</span><span class="bu">len</span>(splits)<span class="sc">}</span><span class="ss"> 个块"</span>)</span>
<span id="cb70-444"><a href="#cb70-444" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-445"><a href="#cb70-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-446"><a href="#cb70-446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-449"><a href="#cb70-449" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb70-450"><a href="#cb70-450" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb70-451"><a href="#cb70-451" aria-hidden="true" tabindex="-1"></a><span class="co"># 如果数据库已存在，则将其移除</span></span>
<span id="cb70-452"><a href="#cb70-452" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> os.path.exists(persist_directory):</span>
<span id="cb70-453"><a href="#cb70-453" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"正在移除位于 </span><span class="sc">{</span>persist_directory<span class="sc">}</span><span class="ss"> 的现有数据库..."</span>)</span>
<span id="cb70-454"><a href="#cb70-454" aria-hidden="true" tabindex="-1"></a>    shutil.rmtree(persist_directory)</span>
<span id="cb70-455"><a href="#cb70-455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-456"><a href="#cb70-456" aria-hidden="true" tabindex="-1"></a><span class="co"># 创建新的向量数据库</span></span>
<span id="cb70-457"><a href="#cb70-457" aria-hidden="true" tabindex="-1"></a>vectorstore <span class="op">=</span> Chroma.from_documents(</span>
<span id="cb70-458"><a href="#cb70-458" aria-hidden="true" tabindex="-1"></a>    documents<span class="op">=</span>splits,</span>
<span id="cb70-459"><a href="#cb70-459" aria-hidden="true" tabindex="-1"></a>    embedding<span class="op">=</span>embeddings,</span>
<span id="cb70-460"><a href="#cb70-460" aria-hidden="true" tabindex="-1"></a>    persist_directory<span class="op">=</span>persist_directory</span>
<span id="cb70-461"><a href="#cb70-461" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb70-462"><a href="#cb70-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-463"><a href="#cb70-463" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">✓ 成功创建了包含 </span><span class="sc">{</span><span class="bu">len</span>(splits)<span class="sc">}</span><span class="ss"> 个块的 ChromaDB！"</span>)</span>
<span id="cb70-464"><a href="#cb70-464" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ 数据库已保存至: </span><span class="sc">{</span>persist_directory<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb70-465"><a href="#cb70-465" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-466"><a href="#cb70-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-467"><a href="#cb70-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-468"><a href="#cb70-468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-469"><a href="#cb70-469" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb70-470"><a href="#cb70-470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-471"><a href="#cb70-471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-472"><a href="#cb70-472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-473"><a href="#cb70-473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-474"><a href="#cb70-474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-475"><a href="#cb70-475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-476"><a href="#cb70-476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-477"><a href="#cb70-477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-478"><a href="#cb70-478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-479"><a href="#cb70-479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-480"><a href="#cb70-480" aria-hidden="true" tabindex="-1"></a><span class="fu"># 检索</span></span>
<span id="cb70-481"><a href="#cb70-481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-482"><a href="#cb70-482" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb70-483"><a href="#cb70-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-484"><a href="#cb70-484" aria-hidden="true" tabindex="-1"></a><span class="fu">## R</span></span>
<span id="cb70-485"><a href="#cb70-485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-486"><a href="#cb70-486" aria-hidden="true" tabindex="-1"></a>现在我们的知识库已经填充完毕，我们可以测试检索系统。我们可以提出一个特定的问题，例如“什么是模型变体？(What are model variants?)”，并查询存储库以查看哪些文本块最相关。这确认了我们的嵌入和搜索是否正常工作。</span>
<span id="cb70-487"><a href="#cb70-487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-488"><a href="#cb70-488" aria-hidden="true" tabindex="-1"></a><span class="fu">### 问题：什么是模型变体？(What are model variants?)</span></span>
<span id="cb70-489"><a href="#cb70-489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-490"><a href="#cb70-490" aria-hidden="true" tabindex="-1"></a>RAG 结果：</span>
<span id="cb70-491"><a href="#cb70-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-494"><a href="#cb70-494" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb70-495"><a href="#cb70-495" aria-hidden="true" tabindex="-1"></a>store_location <span class="ot">&lt;-</span> <span class="st">"openrouter.duckdb"</span></span>
<span id="cb70-496"><a href="#cb70-496" aria-hidden="true" tabindex="-1"></a>text <span class="ot">&lt;-</span> <span class="st">"What are model variants?"</span></span>
<span id="cb70-497"><a href="#cb70-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-498"><a href="#cb70-498" aria-hidden="true" tabindex="-1"></a>relevant_chunks <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb70-499"><a href="#cb70-499" aria-hidden="true" tabindex="-1"></a>    store <span class="ot">&lt;-</span> <span class="fu">ragnar_store_connect</span>(store_location)</span>
<span id="cb70-500"><a href="#cb70-500" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ragnar_retrieve</span>(store, text, <span class="at">top_k =</span> <span class="dv">3</span>)</span>
<span id="cb70-501"><a href="#cb70-501" aria-hidden="true" tabindex="-1"></a>}, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb70-502"><a href="#cb70-502" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"⚠️ 无法连接到 DuckDB (可能被锁定): "</span>, e<span class="sc">$</span>message)</span>
<span id="cb70-503"><a href="#cb70-503" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb70-504"><a href="#cb70-504" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb70-505"><a href="#cb70-505" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-506"><a href="#cb70-506" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(relevant_chunks)) {</span>
<span id="cb70-507"><a href="#cb70-507" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"检索到"</span>, <span class="fu">nrow</span>(relevant_chunks), <span class="st">"个文本块：</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb70-508"><a href="#cb70-508" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">nrow</span>(relevant_chunks))) {</span>
<span id="cb70-509"><a href="#cb70-509" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"--- 块 %d ---</span><span class="sc">\n</span><span class="st">%s</span><span class="sc">\n\n</span><span class="st">"</span>, i, relevant_chunks<span class="sc">$</span>text[i]))</span>
<span id="cb70-510"><a href="#cb70-510" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb70-511"><a href="#cb70-511" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb70-512"><a href="#cb70-512" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"知识库当前不可用（由于数据库锁定）。"</span>)</span>
<span id="cb70-513"><a href="#cb70-513" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb70-514"><a href="#cb70-514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-515"><a href="#cb70-515" aria-hidden="true" tabindex="-1"></a><span class="co"># 释放连接以避免文件锁定</span></span>
<span id="cb70-516"><a href="#cb70-516" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"store"</span>)) {</span>
<span id="cb70-517"><a href="#cb70-517" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rm</span>(store)</span>
<span id="cb70-518"><a href="#cb70-518" aria-hidden="true" tabindex="-1"></a>    <span class="fu">gc</span>()</span>
<span id="cb70-519"><a href="#cb70-519" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb70-520"><a href="#cb70-520" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-521"><a href="#cb70-521" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-522"><a href="#cb70-522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-525"><a href="#cb70-525" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb70-526"><a href="#cb70-526" aria-hidden="true" tabindex="-1"></a><span class="co"># ragnar_store_inspect(store)</span></span>
<span id="cb70-527"><a href="#cb70-527" aria-hidden="true" tabindex="-1"></a><span class="co">#ragnar_chunks_view(chunks)</span></span>
<span id="cb70-528"><a href="#cb70-528" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-529"><a href="#cb70-529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-530"><a href="#cb70-530" aria-hidden="true" tabindex="-1"></a><span class="fu">## Python DuckDB</span></span>
<span id="cb70-531"><a href="#cb70-531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-532"><a href="#cb70-532" aria-hidden="true" tabindex="-1"></a>在 Python 中，我们可以使用 <span class="in">`LlamaIndex`</span> 与我们的 DuckDB 向量数据库进行交互。在此步骤中，我们将配置嵌入模型并为查询检索前几个相关块，并将它们保存到文件中以供检查。我们暂不使用 LLM 进行生成，仅专注于验证检索质量。</span>
<span id="cb70-533"><a href="#cb70-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-534"><a href="#cb70-534" aria-hidden="true" tabindex="-1"></a><span class="fu">### 问题：什么是模型变体？(What are model variants?)</span></span>
<span id="cb70-535"><a href="#cb70-535" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-536"><a href="#cb70-536" aria-hidden="true" tabindex="-1"></a>RAG 结果：</span>
<span id="cb70-537"><a href="#cb70-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-540"><a href="#cb70-540" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb70-541"><a href="#cb70-541" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb70-542"><a href="#cb70-542" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb70-543"><a href="#cb70-543" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Python 可执行文件路径: </span><span class="sc">{</span>sys<span class="sc">.</span>executable<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb70-544"><a href="#cb70-544" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Python 路径 (sys.path): </span><span class="sc">{</span>sys<span class="sc">.</span>path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb70-545"><a href="#cb70-545" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Any, List</span>
<span id="cb70-546"><a href="#cb70-546" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> openai <span class="im">import</span> OpenAI</span>
<span id="cb70-547"><a href="#cb70-547" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> llama_index.core <span class="im">import</span> VectorStoreIndex, Settings</span>
<span id="cb70-548"><a href="#cb70-548" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> llama_index.core.embeddings <span class="im">import</span> BaseEmbedding</span>
<span id="cb70-549"><a href="#cb70-549" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> llama_index.vector_stores.duckdb <span class="im">import</span> DuckDBVectorStore</span>
<span id="cb70-550"><a href="#cb70-550" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dotenv <span class="im">import</span> load_dotenv</span>
<span id="cb70-551"><a href="#cb70-551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-552"><a href="#cb70-552" aria-hidden="true" tabindex="-1"></a><span class="co"># 加载环境变量</span></span>
<span id="cb70-553"><a href="#cb70-553" aria-hidden="true" tabindex="-1"></a>load_dotenv()</span>
<span id="cb70-554"><a href="#cb70-554" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-555"><a href="#cb70-555" aria-hidden="true" tabindex="-1"></a><span class="co"># 确保 API 密钥可用</span></span>
<span id="cb70-556"><a href="#cb70-556" aria-hidden="true" tabindex="-1"></a>openrouter_api_key <span class="op">=</span> os.getenv(<span class="st">"OPENROUTER_API_KEY"</span>)</span>
<span id="cb70-557"><a href="#cb70-557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-558"><a href="#cb70-558" aria-hidden="true" tabindex="-1"></a><span class="co"># 针对 LlamaIndex 的自定义 OpenRouter 嵌入类</span></span>
<span id="cb70-559"><a href="#cb70-559" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> OpenRouterEmbedding(BaseEmbedding):</span>
<span id="cb70-560"><a href="#cb70-560" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""与 LlamaIndex 兼容的 OpenRouter API 自定义嵌入类。"""</span></span>
<span id="cb70-561"><a href="#cb70-561" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-562"><a href="#cb70-562" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(</span>
<span id="cb70-563"><a href="#cb70-563" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>,</span>
<span id="cb70-564"><a href="#cb70-564" aria-hidden="true" tabindex="-1"></a>        api_key: <span class="bu">str</span>,</span>
<span id="cb70-565"><a href="#cb70-565" aria-hidden="true" tabindex="-1"></a>        model: <span class="bu">str</span> <span class="op">=</span> <span class="st">"qwen/qwen3-embedding-8b"</span>,</span>
<span id="cb70-566"><a href="#cb70-566" aria-hidden="true" tabindex="-1"></a>        <span class="op">**</span>kwargs: Any</span>
<span id="cb70-567"><a href="#cb70-567" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="cb70-568"><a href="#cb70-568" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>(<span class="op">**</span>kwargs)</span>
<span id="cb70-569"><a href="#cb70-569" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._client <span class="op">=</span> OpenAI(</span>
<span id="cb70-570"><a href="#cb70-570" aria-hidden="true" tabindex="-1"></a>            base_url<span class="op">=</span><span class="st">"https://openrouter.ai/api/v1"</span>,</span>
<span id="cb70-571"><a href="#cb70-571" aria-hidden="true" tabindex="-1"></a>            api_key<span class="op">=</span>api_key,</span>
<span id="cb70-572"><a href="#cb70-572" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb70-573"><a href="#cb70-573" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._model <span class="op">=</span> model</span>
<span id="cb70-574"><a href="#cb70-574" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-575"><a href="#cb70-575" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _get_query_embedding(<span class="va">self</span>, query: <span class="bu">str</span>) <span class="op">-&gt;</span> List[<span class="bu">float</span>]:</span>
<span id="cb70-576"><a href="#cb70-576" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""获取查询字符串的嵌入向量。"""</span></span>
<span id="cb70-577"><a href="#cb70-577" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> <span class="va">self</span>._client.embeddings.create(</span>
<span id="cb70-578"><a href="#cb70-578" aria-hidden="true" tabindex="-1"></a>            extra_headers<span class="op">=</span>{</span>
<span id="cb70-579"><a href="#cb70-579" aria-hidden="true" tabindex="-1"></a>                <span class="st">"HTTP-Referer"</span>: <span class="st">"https://ai-blog.com"</span>,</span>
<span id="cb70-580"><a href="#cb70-580" aria-hidden="true" tabindex="-1"></a>                <span class="st">"X-Title"</span>: <span class="st">"AI Blog RAG"</span>,</span>
<span id="cb70-581"><a href="#cb70-581" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb70-582"><a href="#cb70-582" aria-hidden="true" tabindex="-1"></a>            model<span class="op">=</span><span class="va">self</span>._model,</span>
<span id="cb70-583"><a href="#cb70-583" aria-hidden="true" tabindex="-1"></a>            <span class="bu">input</span><span class="op">=</span>query,</span>
<span id="cb70-584"><a href="#cb70-584" aria-hidden="true" tabindex="-1"></a>            encoding_format<span class="op">=</span><span class="st">"float"</span></span>
<span id="cb70-585"><a href="#cb70-585" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb70-586"><a href="#cb70-586" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> response.data[<span class="dv">0</span>].embedding</span>
<span id="cb70-587"><a href="#cb70-587" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-588"><a href="#cb70-588" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _get_text_embedding(<span class="va">self</span>, text: <span class="bu">str</span>) <span class="op">-&gt;</span> List[<span class="bu">float</span>]:</span>
<span id="cb70-589"><a href="#cb70-589" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""获取文本字符串的嵌入向量。"""</span></span>
<span id="cb70-590"><a href="#cb70-590" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._get_query_embedding(text)</span>
<span id="cb70-591"><a href="#cb70-591" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-592"><a href="#cb70-592" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> _aget_query_embedding(<span class="va">self</span>, query: <span class="bu">str</span>) <span class="op">-&gt;</span> List[<span class="bu">float</span>]:</span>
<span id="cb70-593"><a href="#cb70-593" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""异步版本的 get_query_embedding。"""</span></span>
<span id="cb70-594"><a href="#cb70-594" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._get_query_embedding(query)</span>
<span id="cb70-595"><a href="#cb70-595" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-596"><a href="#cb70-596" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> _aget_text_embedding(<span class="va">self</span>, text: <span class="bu">str</span>) <span class="op">-&gt;</span> List[<span class="bu">float</span>]:</span>
<span id="cb70-597"><a href="#cb70-597" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""异步版本的 get_text_embedding。"""</span></span>
<span id="cb70-598"><a href="#cb70-598" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._get_text_embedding(text)</span>
<span id="cb70-599"><a href="#cb70-599" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-600"><a href="#cb70-600" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. 使用自定义 OpenRouter 类配置嵌入模型</span></span>
<span id="cb70-601"><a href="#cb70-601" aria-hidden="true" tabindex="-1"></a>embed_model <span class="op">=</span> OpenRouterEmbedding(</span>
<span id="cb70-602"><a href="#cb70-602" aria-hidden="true" tabindex="-1"></a>    api_key<span class="op">=</span>openrouter_api_key,</span>
<span id="cb70-603"><a href="#cb70-603" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span><span class="st">"qwen/qwen3-embedding-8b"</span></span>
<span id="cb70-604"><a href="#cb70-604" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb70-605"><a href="#cb70-605" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-606"><a href="#cb70-606" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. 应用设置</span></span>
<span id="cb70-607"><a href="#cb70-607" aria-hidden="true" tabindex="-1"></a>Settings.embed_model <span class="op">=</span> embed_model</span>
<span id="cb70-608"><a href="#cb70-608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-609"><a href="#cb70-609" aria-hidden="true" tabindex="-1"></a><span class="co"># 加载与检索</span></span>
<span id="cb70-610"><a href="#cb70-610" aria-hidden="true" tabindex="-1"></a><span class="co"># 加载现有的 DuckDB 向量数据库</span></span>
<span id="cb70-611"><a href="#cb70-611" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"正在从 openrouter.duckdb 加载向量数据库..."</span>)</span>
<span id="cb70-612"><a href="#cb70-612" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb70-613"><a href="#cb70-613" aria-hidden="true" tabindex="-1"></a>    vector_store <span class="op">=</span> DuckDBVectorStore(database_name<span class="op">=</span><span class="st">"openrouter.duckdb"</span>, persist_dir<span class="op">=</span><span class="st">"./persist/"</span>, read_only<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb70-614"><a href="#cb70-614" aria-hidden="true" tabindex="-1"></a>    index <span class="op">=</span> VectorStoreIndex.from_vector_store(vector_store<span class="op">=</span>vector_store)</span>
<span id="cb70-615"><a href="#cb70-615" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb70-616"><a href="#cb70-616" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"⚠️ 无法加载向量数据库 (可能被锁定): </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb70-617"><a href="#cb70-617" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 创建一个空索引作为备选，或者跳过</span></span>
<span id="cb70-618"><a href="#cb70-618" aria-hidden="true" tabindex="-1"></a>    index <span class="op">=</span> <span class="va">None</span></span>
<span id="cb70-619"><a href="#cb70-619" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-620"><a href="#cb70-620" aria-hidden="true" tabindex="-1"></a><span class="co"># 定义查询</span></span>
<span id="cb70-621"><a href="#cb70-621" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="st">"What are model variants?"</span></span>
<span id="cb70-622"><a href="#cb70-622" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">60</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb70-623"><a href="#cb70-623" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"查询问题: '</span><span class="sc">{</span>query<span class="sc">}</span><span class="ss">'"</span>)</span>
<span id="cb70-624"><a href="#cb70-624" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">60</span><span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb70-625"><a href="#cb70-625" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-626"><a href="#cb70-626" aria-hidden="true" tabindex="-1"></a><span class="co"># 检索前 3 个相关块</span></span>
<span id="cb70-627"><a href="#cb70-627" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> index:</span>
<span id="cb70-628"><a href="#cb70-628" aria-hidden="true" tabindex="-1"></a>    retriever <span class="op">=</span> index.as_retriever(similarity_top_k<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb70-629"><a href="#cb70-629" aria-hidden="true" tabindex="-1"></a>    nodes <span class="op">=</span> retriever.retrieve(query)</span>
<span id="cb70-630"><a href="#cb70-630" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb70-631"><a href="#cb70-631" aria-hidden="true" tabindex="-1"></a>    nodes <span class="op">=</span> []</span>
<span id="cb70-632"><a href="#cb70-632" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-633"><a href="#cb70-633" aria-hidden="true" tabindex="-1"></a><span class="co"># 打印详细检索信息</span></span>
<span id="cb70-634"><a href="#cb70-634" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"从 DuckDB 中检索到 </span><span class="sc">{</span><span class="bu">len</span>(nodes)<span class="sc">}</span><span class="ss"> 个文本块：</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb70-635"><a href="#cb70-635" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, node <span class="kw">in</span> <span class="bu">enumerate</span>(nodes, <span class="dv">1</span>):</span>
<span id="cb70-636"><a href="#cb70-636" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'─'</span><span class="op">*</span><span class="dv">60</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb70-637"><a href="#cb70-637" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"块 </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb70-638"><a href="#cb70-638" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'─'</span><span class="op">*</span><span class="dv">60</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb70-639"><a href="#cb70-639" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-640"><a href="#cb70-640" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 打印相似度分数</span></span>
<span id="cb70-641"><a href="#cb70-641" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">hasattr</span>(node, <span class="st">'score'</span>):</span>
<span id="cb70-642"><a href="#cb70-642" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"相似度分数: </span><span class="sc">{</span>node<span class="sc">.</span>score<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb70-643"><a href="#cb70-643" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-644"><a href="#cb70-644" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 打印元数据</span></span>
<span id="cb70-645"><a href="#cb70-645" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">hasattr</span>(node, <span class="st">'metadata'</span>) <span class="kw">and</span> node.metadata:</span>
<span id="cb70-646"><a href="#cb70-646" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"元数据:"</span>)</span>
<span id="cb70-647"><a href="#cb70-647" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> key, value <span class="kw">in</span> node.metadata.items():</span>
<span id="cb70-648"><a href="#cb70-648" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  - </span><span class="sc">{</span>key<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>value<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb70-649"><a href="#cb70-649" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-650"><a href="#cb70-650" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 打印文本内容（截断显示）</span></span>
<span id="cb70-651"><a href="#cb70-651" aria-hidden="true" tabindex="-1"></a>    text_preview <span class="op">=</span> node.text[:<span class="dv">500</span>] <span class="op">+</span> <span class="st">"..."</span> <span class="cf">if</span> <span class="bu">len</span>(node.text) <span class="op">&gt;</span> <span class="dv">500</span> <span class="cf">else</span> node.text</span>
<span id="cb70-652"><a href="#cb70-652" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">内容预览:</span><span class="ch">\n</span><span class="sc">{</span>text_preview<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb70-653"><a href="#cb70-653" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-654"><a href="#cb70-654" aria-hidden="true" tabindex="-1"></a><span class="co"># Save retrieved chunks to a markdown file for easy inspection</span></span>
<span id="cb70-655"><a href="#cb70-655" aria-hidden="true" tabindex="-1"></a><span class="co"># with open("retriever.md", "w", encoding="utf-8") as f:</span></span>
<span id="cb70-656"><a href="#cb70-656" aria-hidden="true" tabindex="-1"></a><span class="co">#     f.write(f"# Query: {query}\n\n")</span></span>
<span id="cb70-657"><a href="#cb70-657" aria-hidden="true" tabindex="-1"></a><span class="co">#     f.write(f"# Retrieved {len(nodes)} chunks from openrouter.duckdb\n\n")</span></span>
<span id="cb70-658"><a href="#cb70-658" aria-hidden="true" tabindex="-1"></a><span class="co">#     for i, node in enumerate(nodes, 1):</span></span>
<span id="cb70-659"><a href="#cb70-659" aria-hidden="true" tabindex="-1"></a><span class="co">#         f.write(f"{'─'*60}\n")</span></span>
<span id="cb70-660"><a href="#cb70-660" aria-hidden="true" tabindex="-1"></a><span class="co">#         f.write(f"## Chunk {i}\n\n")</span></span>
<span id="cb70-661"><a href="#cb70-661" aria-hidden="true" tabindex="-1"></a><span class="co">#         if hasattr(node, 'score'):</span></span>
<span id="cb70-662"><a href="#cb70-662" aria-hidden="true" tabindex="-1"></a><span class="co">#             f.write(f"**Similarity Score:** {node.score:.4f}\n\n")</span></span>
<span id="cb70-663"><a href="#cb70-663" aria-hidden="true" tabindex="-1"></a><span class="co">#         if hasattr(node, 'metadata') and node.metadata:</span></span>
<span id="cb70-664"><a href="#cb70-664" aria-hidden="true" tabindex="-1"></a><span class="co">#             f.write(f"**Metadata:**\n")</span></span>
<span id="cb70-665"><a href="#cb70-665" aria-hidden="true" tabindex="-1"></a><span class="co">#             for key, value in node.metadata.items():</span></span>
<span id="cb70-666"><a href="#cb70-666" aria-hidden="true" tabindex="-1"></a><span class="co">#                 f.write(f"- {key}: {value}\n")</span></span>
<span id="cb70-667"><a href="#cb70-667" aria-hidden="true" tabindex="-1"></a><span class="co">#             f.write(f"\n")</span></span>
<span id="cb70-668"><a href="#cb70-668" aria-hidden="true" tabindex="-1"></a><span class="co">#         f.write(f"{node.text}\n\n")</span></span>
<span id="cb70-669"><a href="#cb70-669" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-670"><a href="#cb70-670" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-671"><a href="#cb70-671" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-672"><a href="#cb70-672" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-673"><a href="#cb70-673" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-674"><a href="#cb70-674" aria-hidden="true" tabindex="-1"></a><span class="fu">## Python Chroma</span></span>
<span id="cb70-675"><a href="#cb70-675" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-676"><a href="#cb70-676" aria-hidden="true" tabindex="-1"></a>现在我们的知识库已经填充完毕，我们可以测试检索系统。我们可以提出一个特定的问题，例如“什么是模型变体？ (What are model variants?)”，并查询 <span class="in">`Chroma`</span> 存储库以查看哪些文本块最相关。这确认了我们的嵌入和搜索是否正常工作。</span>
<span id="cb70-677"><a href="#cb70-677" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-678"><a href="#cb70-678" aria-hidden="true" tabindex="-1"></a><span class="fu">### 问题：什么是模型变体？ (What are model variants?)</span></span>
<span id="cb70-679"><a href="#cb70-679" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-680"><a href="#cb70-680" aria-hidden="true" tabindex="-1"></a>RAG 结果：</span>
<span id="cb70-681"><a href="#cb70-681" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-684"><a href="#cb70-684" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb70-685"><a href="#cb70-685" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> openai <span class="im">import</span> OpenAI</span>
<span id="cb70-686"><a href="#cb70-686" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain_core.embeddings <span class="im">import</span> Embeddings</span>
<span id="cb70-687"><a href="#cb70-687" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain_chroma <span class="im">import</span> Chroma</span>
<span id="cb70-688"><a href="#cb70-688" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List</span>
<span id="cb70-689"><a href="#cb70-689" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb70-690"><a href="#cb70-690" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dotenv <span class="im">import</span> load_dotenv</span>
<span id="cb70-691"><a href="#cb70-691" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-692"><a href="#cb70-692" aria-hidden="true" tabindex="-1"></a>load_dotenv()</span>
<span id="cb70-693"><a href="#cb70-693" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-694"><a href="#cb70-694" aria-hidden="true" tabindex="-1"></a><span class="co"># 针对 OpenRouter API 的自定义嵌入类</span></span>
<span id="cb70-695"><a href="#cb70-695" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> OpenRouterEmbeddings(Embeddings):</span>
<span id="cb70-696"><a href="#cb70-696" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""针对 OpenRouter API 的自定义嵌入类。"""</span></span>
<span id="cb70-697"><a href="#cb70-697" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-698"><a href="#cb70-698" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, api_key: <span class="bu">str</span>, model: <span class="bu">str</span> <span class="op">=</span> <span class="st">"qwen/qwen3-embedding-8b"</span>):</span>
<span id="cb70-699"><a href="#cb70-699" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.client <span class="op">=</span> OpenAI(</span>
<span id="cb70-700"><a href="#cb70-700" aria-hidden="true" tabindex="-1"></a>            base_url<span class="op">=</span><span class="st">"https://openrouter.ai/api/v1"</span>,</span>
<span id="cb70-701"><a href="#cb70-701" aria-hidden="true" tabindex="-1"></a>            api_key<span class="op">=</span>api_key,</span>
<span id="cb70-702"><a href="#cb70-702" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb70-703"><a href="#cb70-703" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model <span class="op">=</span> model</span>
<span id="cb70-704"><a href="#cb70-704" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-705"><a href="#cb70-705" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> embed_documents(<span class="va">self</span>, texts: List[<span class="bu">str</span>]) <span class="op">-&gt;</span> List[List[<span class="bu">float</span>]]:</span>
<span id="cb70-706"><a href="#cb70-706" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""对文档列表进行嵌入。"""</span></span>
<span id="cb70-707"><a href="#cb70-707" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> <span class="va">self</span>.client.embeddings.create(</span>
<span id="cb70-708"><a href="#cb70-708" aria-hidden="true" tabindex="-1"></a>            extra_headers<span class="op">=</span>{</span>
<span id="cb70-709"><a href="#cb70-709" aria-hidden="true" tabindex="-1"></a>                <span class="st">"HTTP-Referer"</span>: <span class="st">"https://ai-blog.com"</span>,</span>
<span id="cb70-710"><a href="#cb70-710" aria-hidden="true" tabindex="-1"></a>                <span class="st">"X-Title"</span>: <span class="st">"AI Blog RAG"</span>,</span>
<span id="cb70-711"><a href="#cb70-711" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb70-712"><a href="#cb70-712" aria-hidden="true" tabindex="-1"></a>            model<span class="op">=</span><span class="va">self</span>.model,</span>
<span id="cb70-713"><a href="#cb70-713" aria-hidden="true" tabindex="-1"></a>            <span class="bu">input</span><span class="op">=</span>texts,</span>
<span id="cb70-714"><a href="#cb70-714" aria-hidden="true" tabindex="-1"></a>            encoding_format<span class="op">=</span><span class="st">"float"</span></span>
<span id="cb70-715"><a href="#cb70-715" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb70-716"><a href="#cb70-716" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [item.embedding <span class="cf">for</span> item <span class="kw">in</span> response.data]</span>
<span id="cb70-717"><a href="#cb70-717" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-718"><a href="#cb70-718" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> embed_query(<span class="va">self</span>, text: <span class="bu">str</span>) <span class="op">-&gt;</span> List[<span class="bu">float</span>]:</span>
<span id="cb70-719"><a href="#cb70-719" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""对单个查询进行嵌入。"""</span></span>
<span id="cb70-720"><a href="#cb70-720" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> <span class="va">self</span>.client.embeddings.create(</span>
<span id="cb70-721"><a href="#cb70-721" aria-hidden="true" tabindex="-1"></a>            extra_headers<span class="op">=</span>{</span>
<span id="cb70-722"><a href="#cb70-722" aria-hidden="true" tabindex="-1"></a>                <span class="st">"HTTP-Referer"</span>: <span class="st">"https://ai-blog.com"</span>,</span>
<span id="cb70-723"><a href="#cb70-723" aria-hidden="true" tabindex="-1"></a>                <span class="st">"X-Title"</span>: <span class="st">"AI Blog RAG"</span>,</span>
<span id="cb70-724"><a href="#cb70-724" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb70-725"><a href="#cb70-725" aria-hidden="true" tabindex="-1"></a>            model<span class="op">=</span><span class="va">self</span>.model,</span>
<span id="cb70-726"><a href="#cb70-726" aria-hidden="true" tabindex="-1"></a>            <span class="bu">input</span><span class="op">=</span>text,</span>
<span id="cb70-727"><a href="#cb70-727" aria-hidden="true" tabindex="-1"></a>            encoding_format<span class="op">=</span><span class="st">"float"</span></span>
<span id="cb70-728"><a href="#cb70-728" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb70-729"><a href="#cb70-729" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> response.data[<span class="dv">0</span>].embedding</span>
<span id="cb70-730"><a href="#cb70-730" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-731"><a href="#cb70-731" aria-hidden="true" tabindex="-1"></a><span class="co"># 获取 OpenRouter API 密钥</span></span>
<span id="cb70-732"><a href="#cb70-732" aria-hidden="true" tabindex="-1"></a>openrouter_api_key <span class="op">=</span> os.getenv(<span class="st">"OPENROUTER_API_KEY"</span>)</span>
<span id="cb70-733"><a href="#cb70-733" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> openrouter_api_key:</span>
<span id="cb70-734"><a href="#cb70-734" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"未在环境变量中找到 OPENROUTER_API_KEY"</span>)</span>
<span id="cb70-735"><a href="#cb70-735" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-736"><a href="#cb70-736" aria-hidden="true" tabindex="-1"></a><span class="co"># 使用 OpenRouter 创建嵌入实例</span></span>
<span id="cb70-737"><a href="#cb70-737" aria-hidden="true" tabindex="-1"></a>embeddings <span class="op">=</span> OpenRouterEmbeddings(</span>
<span id="cb70-738"><a href="#cb70-738" aria-hidden="true" tabindex="-1"></a>    api_key<span class="op">=</span>openrouter_api_key,</span>
<span id="cb70-739"><a href="#cb70-739" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span><span class="st">"qwen/qwen3-embedding-8b"</span></span>
<span id="cb70-740"><a href="#cb70-740" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb70-741"><a href="#cb70-741" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-742"><a href="#cb70-742" aria-hidden="true" tabindex="-1"></a><span class="co"># 定义向量数据库位置</span></span>
<span id="cb70-743"><a href="#cb70-743" aria-hidden="true" tabindex="-1"></a>persist_directory <span class="op">=</span> <span class="st">"chroma_db_data"</span></span>
<span id="cb70-744"><a href="#cb70-744" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-745"><a href="#cb70-745" aria-hidden="true" tabindex="-1"></a><span class="co"># 加载现有的向量数据库</span></span>
<span id="cb70-746"><a href="#cb70-746" aria-hidden="true" tabindex="-1"></a>vectorstore <span class="op">=</span> Chroma(</span>
<span id="cb70-747"><a href="#cb70-747" aria-hidden="true" tabindex="-1"></a>    persist_directory<span class="op">=</span>persist_directory,</span>
<span id="cb70-748"><a href="#cb70-748" aria-hidden="true" tabindex="-1"></a>    embedding_function<span class="op">=</span>embeddings</span>
<span id="cb70-749"><a href="#cb70-749" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb70-750"><a href="#cb70-750" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-751"><a href="#cb70-751" aria-hidden="true" tabindex="-1"></a><span class="co"># 测试查询</span></span>
<span id="cb70-752"><a href="#cb70-752" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="st">"What are model variants?"</span></span>
<span id="cb70-753"><a href="#cb70-753" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-754"><a href="#cb70-754" aria-hidden="true" tabindex="-1"></a><span class="co"># 执行相似度搜索</span></span>
<span id="cb70-755"><a href="#cb70-755" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> vectorstore.similarity_search(query, k<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb70-756"><a href="#cb70-756" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-757"><a href="#cb70-757" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">查询问题: '</span><span class="sc">{</span>query<span class="sc">}</span><span class="ss">'"</span>)</span>
<span id="cb70-758"><a href="#cb70-758" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"找到 </span><span class="sc">{</span><span class="bu">len</span>(results)<span class="sc">}</span><span class="ss"> 个相关块：</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb70-759"><a href="#cb70-759" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-760"><a href="#cb70-760" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, doc <span class="kw">in</span> <span class="bu">enumerate</span>(results, <span class="dv">1</span>):</span>
<span id="cb70-761"><a href="#cb70-761" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"结果 </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb70-762"><a href="#cb70-762" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"来源: </span><span class="sc">{</span>doc<span class="sc">.</span>metadata<span class="sc">.</span>get(<span class="st">'source'</span>, <span class="st">'未知'</span>)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb70-763"><a href="#cb70-763" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"内容预览: </span><span class="sc">{</span>doc<span class="sc">.</span>page_content[:<span class="dv">800</span>]<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb70-764"><a href="#cb70-764" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-765"><a href="#cb70-765" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-766"><a href="#cb70-766" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-767"><a href="#cb70-767" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb70-768"><a href="#cb70-768" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-769"><a href="#cb70-769" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-770"><a href="#cb70-770" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-771"><a href="#cb70-771" aria-hidden="true" tabindex="-1"></a><span class="fu"># 结合 RAG 进行聊天 (Chat with RAG)</span></span>
<span id="cb70-772"><a href="#cb70-772" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-773"><a href="#cb70-773" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb70-774"><a href="#cb70-774" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-775"><a href="#cb70-775" aria-hidden="true" tabindex="-1"></a><span class="fu">## R</span></span>
<span id="cb70-776"><a href="#cb70-776" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-777"><a href="#cb70-777" aria-hidden="true" tabindex="-1"></a>最后一个环节是将这种检索能力连接到聊天界面。我们使用 <span class="in">`ellmer`</span> 创建一个聊天客户端。关键在于，我们使用 <span class="in">`ragnar_register_tool_retrieve`</span> 注册一个“检索工具”。这使 LLM 能够在需要信息回答用户问题时，自主查询我们的向量数据库。</span>
<span id="cb70-778"><a href="#cb70-778" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-779"><a href="#cb70-779" aria-hidden="true" tabindex="-1"></a>我们还提供了一个系统提示词，指示模型始终检查知识库并引用其来源。</span>
<span id="cb70-780"><a href="#cb70-780" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-781"><a href="#cb70-781" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-784"><a href="#cb70-784" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb70-785"><a href="#cb70-785" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ellmer)</span>
<span id="cb70-786"><a href="#cb70-786" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dotenv)</span>
<span id="cb70-787"><a href="#cb70-787" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ragnar)</span>
<span id="cb70-788"><a href="#cb70-788" aria-hidden="true" tabindex="-1"></a><span class="fu">load_dot_env</span>(<span class="at">file =</span> <span class="st">".env"</span>)</span>
<span id="cb70-789"><a href="#cb70-789" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-790"><a href="#cb70-790" aria-hidden="true" tabindex="-1"></a>chat <span class="ot">&lt;-</span> <span class="fu">chat_openrouter</span>(</span>
<span id="cb70-791"><a href="#cb70-791" aria-hidden="true" tabindex="-1"></a>    <span class="at">api_key =</span> <span class="fu">Sys.getenv</span>(<span class="st">"OPENROUTER_API_KEY"</span>),</span>
<span id="cb70-792"><a href="#cb70-792" aria-hidden="true" tabindex="-1"></a>    <span class="at">model =</span> <span class="st">"openai/gpt-oss-120b"</span>,</span>
<span id="cb70-793"><a href="#cb70-793" aria-hidden="true" tabindex="-1"></a>    <span class="at">system_prompt =</span> glue<span class="sc">::</span><span class="fu">trim</span>(<span class="st">"</span></span>
<span id="cb70-794"><a href="#cb70-794" aria-hidden="true" tabindex="-1"></a><span class="st">  你是一个负责问答任务的助手。请保持回复简练。</span></span>
<span id="cb70-795"><a href="#cb70-795" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-796"><a href="#cb70-796" aria-hidden="true" tabindex="-1"></a><span class="st">  在回复之前，请从知识库中检索相关素材。引用或转述段落，清晰地标注哪些是你自己的话，哪些是来源。</span></span>
<span id="cb70-797"><a href="#cb70-797" aria-hidden="true" tabindex="-1"></a><span class="st">  为你引用的每个来源提供一个有效的链接，以及任何其他相关的链接。</span></span>
<span id="cb70-798"><a href="#cb70-798" aria-hidden="true" tabindex="-1"></a><span class="st">  除非你已经检索并引用了来源，否则不要回答。如果你没有找到相关信息，请说“我在知识库中找不到任何相关信息”。</span></span>
<span id="cb70-799"><a href="#cb70-799" aria-hidden="true" tabindex="-1"></a><span class="st">    "</span>)</span>
<span id="cb70-800"><a href="#cb70-800" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb70-801"><a href="#cb70-801" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-802"><a href="#cb70-802" aria-hidden="true" tabindex="-1"></a><span class="co"># 尝试连接存储并注册工具</span></span>
<span id="cb70-803"><a href="#cb70-803" aria-hidden="true" tabindex="-1"></a>store_connected <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb70-804"><a href="#cb70-804" aria-hidden="true" tabindex="-1"></a><span class="fu">tryCatch</span>({</span>
<span id="cb70-805"><a href="#cb70-805" aria-hidden="true" tabindex="-1"></a>    store <span class="ot">&lt;-</span> <span class="fu">ragnar_store_connect</span>(<span class="st">"openrouter.duckdb"</span>)</span>
<span id="cb70-806"><a href="#cb70-806" aria-hidden="true" tabindex="-1"></a>    chat <span class="ot">&lt;-</span> chat <span class="sc">|&gt;</span> <span class="fu">ragnar_register_tool_retrieve</span>(store, <span class="at">top_k =</span> <span class="dv">3</span>)</span>
<span id="cb70-807"><a href="#cb70-807" aria-hidden="true" tabindex="-1"></a>    store_connected <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb70-808"><a href="#cb70-808" aria-hidden="true" tabindex="-1"></a>}, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb70-809"><a href="#cb70-809" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"⚠️ 无法连接到 DuckDB 进行工具注册: "</span>, e<span class="sc">$</span>message)</span>
<span id="cb70-810"><a href="#cb70-810" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb70-811"><a href="#cb70-811" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-812"><a href="#cb70-812" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-813"><a href="#cb70-813" aria-hidden="true" tabindex="-1"></a><span class="fu">### 问题：什么是模型变体？(What are model variants?)</span></span>
<span id="cb70-814"><a href="#cb70-814" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-817"><a href="#cb70-817" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb70-818"><a href="#cb70-818" aria-hidden="true" tabindex="-1"></a><span class="co">#| results: asis</span></span>
<span id="cb70-819"><a href="#cb70-819" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (store_connected) {</span>
<span id="cb70-820"><a href="#cb70-820" aria-hidden="true" tabindex="-1"></a>    chat<span class="sc">$</span><span class="fu">chat</span>(<span class="st">"What are model variants?"</span>)</span>
<span id="cb70-821"><a href="#cb70-821" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 聊天结束后立即释放锁</span></span>
<span id="cb70-822"><a href="#cb70-822" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rm</span>(store)</span>
<span id="cb70-823"><a href="#cb70-823" aria-hidden="true" tabindex="-1"></a>    <span class="fu">gc</span>()</span>
<span id="cb70-824"><a href="#cb70-824" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb70-825"><a href="#cb70-825" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"由于数据库锁定，R 聊天功能暂时不可用。"</span>)</span>
<span id="cb70-826"><a href="#cb70-826" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb70-827"><a href="#cb70-827" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-828"><a href="#cb70-828" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-829"><a href="#cb70-829" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-830"><a href="#cb70-830" aria-hidden="true" tabindex="-1"></a><span class="fu">## Python chatlas</span></span>
<span id="cb70-831"><a href="#cb70-831" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-832"><a href="#cb70-832" aria-hidden="true" tabindex="-1"></a>我们还可以使用 <span class="in">`chatlas`</span> 库来创建一个聊天界面。在这里，我们定义了一个自定义工具 <span class="in">`retrieve_trusted_content`</span>，用于查询我们的 DuckDB 索引。然后我们将这个工具注册到聊天模型中，使其能够在回答用户问题时引入相关信息。</span>
<span id="cb70-833"><a href="#cb70-833" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-834"><a href="#cb70-834" aria-hidden="true" tabindex="-1"></a><span class="fu">### 问题：什么是模型变体？(What are model variants?)</span></span>
<span id="cb70-835"><a href="#cb70-835" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-836"><a href="#cb70-836" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-839"><a href="#cb70-839" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb70-840"><a href="#cb70-840" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb70-841"><a href="#cb70-841" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Any, List</span>
<span id="cb70-842"><a href="#cb70-842" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> openai <span class="im">import</span> OpenAI</span>
<span id="cb70-843"><a href="#cb70-843" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> chatlas <span class="im">as</span> ctl</span>
<span id="cb70-844"><a href="#cb70-844" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> llama_index.core <span class="im">import</span> VectorStoreIndex, Settings</span>
<span id="cb70-845"><a href="#cb70-845" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> llama_index.core.embeddings <span class="im">import</span> BaseEmbedding</span>
<span id="cb70-846"><a href="#cb70-846" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> llama_index.vector_stores.duckdb <span class="im">import</span> DuckDBVectorStore</span>
<span id="cb70-847"><a href="#cb70-847" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dotenv <span class="im">import</span> load_dotenv</span>
<span id="cb70-848"><a href="#cb70-848" aria-hidden="true" tabindex="-1"></a>load_dotenv()</span>
<span id="cb70-849"><a href="#cb70-849" aria-hidden="true" tabindex="-1"></a><span class="co"># 确保 API 密钥可用</span></span>
<span id="cb70-850"><a href="#cb70-850" aria-hidden="true" tabindex="-1"></a>openrouter_api_key <span class="op">=</span> os.getenv(<span class="st">"OPENROUTER_API_KEY"</span>)</span>
<span id="cb70-851"><a href="#cb70-851" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-852"><a href="#cb70-852" aria-hidden="true" tabindex="-1"></a><span class="co"># 针对 LlamaIndex 的自定义 OpenRouter 嵌入类</span></span>
<span id="cb70-853"><a href="#cb70-853" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> OpenRouterEmbedding(BaseEmbedding):</span>
<span id="cb70-854"><a href="#cb70-854" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""与 LlamaIndex 兼容的 OpenRouter API 自定义嵌入类。"""</span></span>
<span id="cb70-855"><a href="#cb70-855" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-856"><a href="#cb70-856" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(</span>
<span id="cb70-857"><a href="#cb70-857" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>,</span>
<span id="cb70-858"><a href="#cb70-858" aria-hidden="true" tabindex="-1"></a>        api_key: <span class="bu">str</span>,</span>
<span id="cb70-859"><a href="#cb70-859" aria-hidden="true" tabindex="-1"></a>        model: <span class="bu">str</span> <span class="op">=</span> <span class="st">"qwen/qwen3-embedding-8b"</span>,</span>
<span id="cb70-860"><a href="#cb70-860" aria-hidden="true" tabindex="-1"></a>        <span class="op">**</span>kwargs: Any</span>
<span id="cb70-861"><a href="#cb70-861" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="cb70-862"><a href="#cb70-862" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>(<span class="op">**</span>kwargs)</span>
<span id="cb70-863"><a href="#cb70-863" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._client <span class="op">=</span> OpenAI(</span>
<span id="cb70-864"><a href="#cb70-864" aria-hidden="true" tabindex="-1"></a>            base_url<span class="op">=</span><span class="st">"https://openrouter.ai/api/v1"</span>,</span>
<span id="cb70-865"><a href="#cb70-865" aria-hidden="true" tabindex="-1"></a>            api_key<span class="op">=</span>api_key,</span>
<span id="cb70-866"><a href="#cb70-866" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb70-867"><a href="#cb70-867" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._model <span class="op">=</span> model</span>
<span id="cb70-868"><a href="#cb70-868" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-869"><a href="#cb70-869" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _get_query_embedding(<span class="va">self</span>, query: <span class="bu">str</span>) <span class="op">-&gt;</span> List[<span class="bu">float</span>]:</span>
<span id="cb70-870"><a href="#cb70-870" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""获取查询字符串的嵌入向量。"""</span></span>
<span id="cb70-871"><a href="#cb70-871" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> <span class="va">self</span>._client.embeddings.create(</span>
<span id="cb70-872"><a href="#cb70-872" aria-hidden="true" tabindex="-1"></a>            extra_headers<span class="op">=</span>{</span>
<span id="cb70-873"><a href="#cb70-873" aria-hidden="true" tabindex="-1"></a>                <span class="st">"HTTP-Referer"</span>: <span class="st">"https://ai-blog.com"</span>,</span>
<span id="cb70-874"><a href="#cb70-874" aria-hidden="true" tabindex="-1"></a>                <span class="st">"X-Title"</span>: <span class="st">"AI Blog RAG"</span>,</span>
<span id="cb70-875"><a href="#cb70-875" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb70-876"><a href="#cb70-876" aria-hidden="true" tabindex="-1"></a>            model<span class="op">=</span><span class="va">self</span>._model,</span>
<span id="cb70-877"><a href="#cb70-877" aria-hidden="true" tabindex="-1"></a>            <span class="bu">input</span><span class="op">=</span>query,</span>
<span id="cb70-878"><a href="#cb70-878" aria-hidden="true" tabindex="-1"></a>            encoding_format<span class="op">=</span><span class="st">"float"</span></span>
<span id="cb70-879"><a href="#cb70-879" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb70-880"><a href="#cb70-880" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> response.data[<span class="dv">0</span>].embedding</span>
<span id="cb70-881"><a href="#cb70-881" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-882"><a href="#cb70-882" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _get_text_embedding(<span class="va">self</span>, text: <span class="bu">str</span>) <span class="op">-&gt;</span> List[<span class="bu">float</span>]:</span>
<span id="cb70-883"><a href="#cb70-883" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""获取文本字符串的嵌入向量。"""</span></span>
<span id="cb70-884"><a href="#cb70-884" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._get_query_embedding(text)</span>
<span id="cb70-885"><a href="#cb70-885" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-886"><a href="#cb70-886" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> _aget_query_embedding(<span class="va">self</span>, query: <span class="bu">str</span>) <span class="op">-&gt;</span> List[<span class="bu">float</span>]:</span>
<span id="cb70-887"><a href="#cb70-887" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""异步版本的 get_query_embedding。"""</span></span>
<span id="cb70-888"><a href="#cb70-888" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._get_query_embedding(query)</span>
<span id="cb70-889"><a href="#cb70-889" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-890"><a href="#cb70-890" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> _aget_text_embedding(<span class="va">self</span>, text: <span class="bu">str</span>) <span class="op">-&gt;</span> List[<span class="bu">float</span>]:</span>
<span id="cb70-891"><a href="#cb70-891" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""异步版本的 get_text_embedding。"""</span></span>
<span id="cb70-892"><a href="#cb70-892" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._get_text_embedding(text)</span>
<span id="cb70-893"><a href="#cb70-893" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-894"><a href="#cb70-894" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. 配置嵌入模型</span></span>
<span id="cb70-895"><a href="#cb70-895" aria-hidden="true" tabindex="-1"></a>embed_model <span class="op">=</span> OpenRouterEmbedding(</span>
<span id="cb70-896"><a href="#cb70-896" aria-hidden="true" tabindex="-1"></a>    api_key<span class="op">=</span>openrouter_api_key,</span>
<span id="cb70-897"><a href="#cb70-897" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span><span class="st">"qwen/qwen3-embedding-8b"</span></span>
<span id="cb70-898"><a href="#cb70-898" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb70-899"><a href="#cb70-899" aria-hidden="true" tabindex="-1"></a>Settings.embed_model <span class="op">=</span> embed_model</span>
<span id="cb70-900"><a href="#cb70-900" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-901"><a href="#cb70-901" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. 加载索引</span></span>
<span id="cb70-902"><a href="#cb70-902" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb70-903"><a href="#cb70-903" aria-hidden="true" tabindex="-1"></a>    vector_store <span class="op">=</span> DuckDBVectorStore(database_name<span class="op">=</span><span class="st">"openrouter.duckdb"</span>, persist_dir<span class="op">=</span><span class="st">"./persist/"</span>, read_only<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb70-904"><a href="#cb70-904" aria-hidden="true" tabindex="-1"></a>    index <span class="op">=</span> VectorStoreIndex.from_vector_store(vector_store<span class="op">=</span>vector_store)</span>
<span id="cb70-905"><a href="#cb70-905" aria-hidden="true" tabindex="-1"></a>    retriever <span class="op">=</span> index.as_retriever(similarity_top_k<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb70-906"><a href="#cb70-906" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb70-907"><a href="#cb70-907" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"⚠️ 无法加载向量数据库: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb70-908"><a href="#cb70-908" aria-hidden="true" tabindex="-1"></a>    index <span class="op">=</span> <span class="va">None</span></span>
<span id="cb70-909"><a href="#cb70-909" aria-hidden="true" tabindex="-1"></a>    retriever <span class="op">=</span> <span class="va">None</span></span>
<span id="cb70-910"><a href="#cb70-910" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-911"><a href="#cb70-911" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. 定义聊天工具</span></span>
<span id="cb70-912"><a href="#cb70-912" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> retrieve_trusted_content(question: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb70-913"><a href="#cb70-913" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb70-914"><a href="#cb70-914" aria-hidden="true" tabindex="-1"></a><span class="co">    在知识库中检索信任的内容来回答问题。</span></span>
<span id="cb70-915"><a href="#cb70-915" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb70-916"><a href="#cb70-916" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> retriever:</span>
<span id="cb70-917"><a href="#cb70-917" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">"知识库当前不可用（由于数据库锁定）。"</span></span>
<span id="cb70-918"><a href="#cb70-918" aria-hidden="true" tabindex="-1"></a>    nodes <span class="op">=</span> retriever.retrieve(question)</span>
<span id="cb70-919"><a href="#cb70-919" aria-hidden="true" tabindex="-1"></a>    combined_text <span class="op">=</span> <span class="st">"</span><span class="ch">\n\n</span><span class="st">"</span>.join([<span class="ss">f"Source Content </span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">:</span><span class="ch">\n</span><span class="sc">{</span>node<span class="sc">.</span>text<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> i, node <span class="kw">in</span> <span class="bu">enumerate</span>(nodes)])</span>
<span id="cb70-920"><a href="#cb70-920" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> combined_text</span>
<span id="cb70-921"><a href="#cb70-921" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-922"><a href="#cb70-922" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. 设置聊天模型并注册工具</span></span>
<span id="cb70-923"><a href="#cb70-923" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> ctl.ChatOpenRouter(</span>
<span id="cb70-924"><a href="#cb70-924" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span><span class="st">"openai/gpt-oss-120b"</span>,</span>
<span id="cb70-925"><a href="#cb70-925" aria-hidden="true" tabindex="-1"></a>    api_key<span class="op">=</span>openrouter_api_key,</span>
<span id="cb70-926"><a href="#cb70-926" aria-hidden="true" tabindex="-1"></a>    base_url<span class="op">=</span><span class="st">"https://openrouter.ai/api/v1"</span>,</span>
<span id="cb70-927"><a href="#cb70-927" aria-hidden="true" tabindex="-1"></a>    system_prompt<span class="op">=</span><span class="st">"""</span></span>
<span id="cb70-928"><a href="#cb70-928" aria-hidden="true" tabindex="-1"></a><span class="st">    你是一个负责问答任务助手。请保持回复简练。</span></span>
<span id="cb70-929"><a href="#cb70-929" aria-hidden="true" tabindex="-1"></a><span class="st">    在回复之前，始终通过 retrieve_trusted_content 工具检索相关素材。</span></span>
<span id="cb70-930"><a href="#cb70-930" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span></span>
<span id="cb70-931"><a href="#cb70-931" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb70-932"><a href="#cb70-932" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-933"><a href="#cb70-933" aria-hidden="true" tabindex="-1"></a>chat.register_tool(retrieve_trusted_content)</span>
<span id="cb70-934"><a href="#cb70-934" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-935"><a href="#cb70-935" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. 执行聊天</span></span>
<span id="cb70-936"><a href="#cb70-936" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb70-937"><a href="#cb70-937" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> chat.chat(<span class="st">"What are model variants?"</span>)</span>
<span id="cb70-938"><a href="#cb70-938" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(response)</span>
<span id="cb70-939"><a href="#cb70-939" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb70-940"><a href="#cb70-940" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"⚠️ 聊天过程出错 (可能是显示处理问题): </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb70-941"><a href="#cb70-941" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-942"><a href="#cb70-942" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-943"><a href="#cb70-943" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-944"><a href="#cb70-944" aria-hidden="true" tabindex="-1"></a><span class="fu">## Python LangChain</span></span>
<span id="cb70-945"><a href="#cb70-945" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-946"><a href="#cb70-946" aria-hidden="true" tabindex="-1"></a>在 Python 的 LangChain 中，我们设置了一个完整的 RAG 流水线。这包括：</span>
<span id="cb70-947"><a href="#cb70-947" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**检索器 (Retriever)**：使用我们的 <span class="in">`Chroma`</span> 向量数据库。</span>
<span id="cb70-948"><a href="#cb70-948" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**提示词模版 (Prompt Template)**：指示模型使用检索到的上下文来回答问题。</span>
<span id="cb70-949"><a href="#cb70-949" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**聊天模型 (Chat Model)**：使用 OpenRouter 提供的 <span class="in">`gpt-4o`</span>。</span>
<span id="cb70-950"><a href="#cb70-950" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**输出解析器 (Output Parser)**：用于格式化最终响应。</span>
<span id="cb70-951"><a href="#cb70-951" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-952"><a href="#cb70-952" aria-hidden="true" tabindex="-1"></a>这种模块化方法是构建生产级 AI 应用程序的典型方式。</span>
<span id="cb70-953"><a href="#cb70-953" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-954"><a href="#cb70-954" aria-hidden="true" tabindex="-1"></a><span class="fu">### 问题：什么是模型变体？(What are model variants?)</span></span>
<span id="cb70-955"><a href="#cb70-955" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-956"><a href="#cb70-956" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-959"><a href="#cb70-959" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb70-960"><a href="#cb70-960" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain_openai <span class="im">import</span> ChatOpenAI</span>
<span id="cb70-961"><a href="#cb70-961" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain_core.prompts <span class="im">import</span> ChatPromptTemplate</span>
<span id="cb70-962"><a href="#cb70-962" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain_core.runnables <span class="im">import</span> RunnablePassthrough</span>
<span id="cb70-963"><a href="#cb70-963" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain_core.output_parsers <span class="im">import</span> StrOutputParser</span>
<span id="cb70-964"><a href="#cb70-964" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> openai <span class="im">import</span> OpenAI</span>
<span id="cb70-965"><a href="#cb70-965" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain_core.embeddings <span class="im">import</span> Embeddings</span>
<span id="cb70-966"><a href="#cb70-966" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain_chroma <span class="im">import</span> Chroma</span>
<span id="cb70-967"><a href="#cb70-967" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List</span>
<span id="cb70-968"><a href="#cb70-968" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb70-969"><a href="#cb70-969" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dotenv <span class="im">import</span> load_dotenv</span>
<span id="cb70-970"><a href="#cb70-970" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-971"><a href="#cb70-971" aria-hidden="true" tabindex="-1"></a>load_dotenv()</span>
<span id="cb70-972"><a href="#cb70-972" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-973"><a href="#cb70-973" aria-hidden="true" tabindex="-1"></a><span class="co"># 针对 LangChain 的自定义 OpenRouter 嵌入类</span></span>
<span id="cb70-974"><a href="#cb70-974" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> OpenRouterEmbeddings(Embeddings):</span>
<span id="cb70-975"><a href="#cb70-975" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, api_key: <span class="bu">str</span>, model: <span class="bu">str</span> <span class="op">=</span> <span class="st">"qwen/qwen3-embedding-8b"</span>):</span>
<span id="cb70-976"><a href="#cb70-976" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._client <span class="op">=</span> OpenAI(</span>
<span id="cb70-977"><a href="#cb70-977" aria-hidden="true" tabindex="-1"></a>            base_url<span class="op">=</span><span class="st">"https://openrouter.ai/api/v1"</span>,</span>
<span id="cb70-978"><a href="#cb70-978" aria-hidden="true" tabindex="-1"></a>            api_key<span class="op">=</span>api_key,</span>
<span id="cb70-979"><a href="#cb70-979" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb70-980"><a href="#cb70-980" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._model <span class="op">=</span> model</span>
<span id="cb70-981"><a href="#cb70-981" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-982"><a href="#cb70-982" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> embed_documents(<span class="va">self</span>, texts: List[<span class="bu">str</span>]) <span class="op">-&gt;</span> List[List[<span class="bu">float</span>]]:</span>
<span id="cb70-983"><a href="#cb70-983" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""嵌入文档列表。"""</span></span>
<span id="cb70-984"><a href="#cb70-984" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> <span class="va">self</span>._client.embeddings.create(</span>
<span id="cb70-985"><a href="#cb70-985" aria-hidden="true" tabindex="-1"></a>            model<span class="op">=</span><span class="va">self</span>._model,</span>
<span id="cb70-986"><a href="#cb70-986" aria-hidden="true" tabindex="-1"></a>            <span class="bu">input</span><span class="op">=</span>texts</span>
<span id="cb70-987"><a href="#cb70-987" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb70-988"><a href="#cb70-988" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [d.embedding <span class="cf">for</span> d <span class="kw">in</span> response.data]</span>
<span id="cb70-989"><a href="#cb70-989" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-990"><a href="#cb70-990" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> embed_query(<span class="va">self</span>, text: <span class="bu">str</span>) <span class="op">-&gt;</span> List[<span class="bu">float</span>]:</span>
<span id="cb70-991"><a href="#cb70-991" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""嵌入单个查询。"""</span></span>
<span id="cb70-992"><a href="#cb70-992" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> <span class="va">self</span>._client.embeddings.create(</span>
<span id="cb70-993"><a href="#cb70-993" aria-hidden="true" tabindex="-1"></a>            model<span class="op">=</span><span class="va">self</span>._model,</span>
<span id="cb70-994"><a href="#cb70-994" aria-hidden="true" tabindex="-1"></a>            <span class="bu">input</span><span class="op">=</span>text</span>
<span id="cb70-995"><a href="#cb70-995" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb70-996"><a href="#cb70-996" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> response.data[<span class="dv">0</span>].embedding</span>
<span id="cb70-997"><a href="#cb70-997" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-998"><a href="#cb70-998" aria-hidden="true" tabindex="-1"></a><span class="co"># 获取 OpenRouter API 密钥</span></span>
<span id="cb70-999"><a href="#cb70-999" aria-hidden="true" tabindex="-1"></a>openrouter_api_key <span class="op">=</span> os.getenv(<span class="st">"OPENROUTER_API_KEY"</span>)</span>
<span id="cb70-1000"><a href="#cb70-1000" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> openrouter_api_key:</span>
<span id="cb70-1001"><a href="#cb70-1001" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"未在环境变量中找到 OPENROUTER_API_KEY"</span>)</span>
<span id="cb70-1002"><a href="#cb70-1002" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1003"><a href="#cb70-1003" aria-hidden="true" tabindex="-1"></a><span class="co"># 使用 OpenRouter 创建嵌入实例</span></span>
<span id="cb70-1004"><a href="#cb70-1004" aria-hidden="true" tabindex="-1"></a>embeddings <span class="op">=</span> OpenRouterEmbeddings(</span>
<span id="cb70-1005"><a href="#cb70-1005" aria-hidden="true" tabindex="-1"></a>    api_key<span class="op">=</span>openrouter_api_key,</span>
<span id="cb70-1006"><a href="#cb70-1006" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span><span class="st">"qwen/qwen3-embedding-8b"</span></span>
<span id="cb70-1007"><a href="#cb70-1007" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb70-1008"><a href="#cb70-1008" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1009"><a href="#cb70-1009" aria-hidden="true" tabindex="-1"></a><span class="co"># 定义向量数据库位置</span></span>
<span id="cb70-1010"><a href="#cb70-1010" aria-hidden="true" tabindex="-1"></a>persist_directory <span class="op">=</span> <span class="st">"chroma_db_data"</span></span>
<span id="cb70-1011"><a href="#cb70-1011" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1012"><a href="#cb70-1012" aria-hidden="true" tabindex="-1"></a><span class="co"># 加载现有的向量数据库</span></span>
<span id="cb70-1013"><a href="#cb70-1013" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"正在从 </span><span class="sc">{</span>persist_directory<span class="sc">}</span><span class="ss"> 加载现有向量数据库..."</span>)</span>
<span id="cb70-1014"><a href="#cb70-1014" aria-hidden="true" tabindex="-1"></a>vectorstore <span class="op">=</span> Chroma(</span>
<span id="cb70-1015"><a href="#cb70-1015" aria-hidden="true" tabindex="-1"></a>    persist_directory<span class="op">=</span>persist_directory,</span>
<span id="cb70-1016"><a href="#cb70-1016" aria-hidden="true" tabindex="-1"></a>    embedding_function<span class="op">=</span>embeddings</span>
<span id="cb70-1017"><a href="#cb70-1017" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb70-1018"><a href="#cb70-1018" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ 向量数据库加载成功"</span>)</span>
<span id="cb70-1019"><a href="#cb70-1019" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1020"><a href="#cb70-1020" aria-hidden="true" tabindex="-1"></a><span class="co"># 使用 OpenRouter 初始化 LLM</span></span>
<span id="cb70-1021"><a href="#cb70-1021" aria-hidden="true" tabindex="-1"></a>llm <span class="op">=</span> ChatOpenAI(</span>
<span id="cb70-1022"><a href="#cb70-1022" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span><span class="st">"openai/gpt-oss-120b"</span>,</span>
<span id="cb70-1023"><a href="#cb70-1023" aria-hidden="true" tabindex="-1"></a>    openai_api_key<span class="op">=</span>os.getenv(<span class="st">"OPENROUTER_API_KEY"</span>),</span>
<span id="cb70-1024"><a href="#cb70-1024" aria-hidden="true" tabindex="-1"></a>    openai_api_base<span class="op">=</span><span class="st">"https://openrouter.ai/api/v1"</span></span>
<span id="cb70-1025"><a href="#cb70-1025" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb70-1026"><a href="#cb70-1026" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1027"><a href="#cb70-1027" aria-hidden="true" tabindex="-1"></a><span class="co"># 创建提示词模版</span></span>
<span id="cb70-1028"><a href="#cb70-1028" aria-hidden="true" tabindex="-1"></a>system_prompt <span class="op">=</span> (</span>
<span id="cb70-1029"><a href="#cb70-1029" aria-hidden="true" tabindex="-1"></a>    <span class="st">"你是一个负责问答任务助手。"</span></span>
<span id="cb70-1030"><a href="#cb70-1030" aria-hidden="true" tabindex="-1"></a>    <span class="st">"请使用以下检索到的素材来回答问题。"</span></span>
<span id="cb70-1031"><a href="#cb70-1031" aria-hidden="true" tabindex="-1"></a>    <span class="st">"如果你不知道答案，请不要胡编乱造。"</span></span>
<span id="cb70-1032"><a href="#cb70-1032" aria-hidden="true" tabindex="-1"></a>    <span class="st">"最多使用三句话，并保持回复简练。"</span></span>
<span id="cb70-1033"><a href="#cb70-1033" aria-hidden="true" tabindex="-1"></a>    <span class="st">"</span><span class="ch">\n\n</span><span class="st">"</span></span>
<span id="cb70-1034"><a href="#cb70-1034" aria-hidden="true" tabindex="-1"></a>    <span class="st">"素材: </span><span class="sc">{context}</span><span class="st">"</span></span>
<span id="cb70-1035"><a href="#cb70-1035" aria-hidden="true" tabindex="-1"></a>    <span class="st">"</span><span class="ch">\n\n</span><span class="st">"</span></span>
<span id="cb70-1036"><a href="#cb70-1036" aria-hidden="true" tabindex="-1"></a>    <span class="st">"问题: </span><span class="sc">{question}</span><span class="st">"</span></span>
<span id="cb70-1037"><a href="#cb70-1037" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb70-1038"><a href="#cb70-1038" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1039"><a href="#cb70-1039" aria-hidden="true" tabindex="-1"></a>prompt <span class="op">=</span> ChatPromptTemplate.from_template(system_prompt)</span>
<span id="cb70-1040"><a href="#cb70-1040" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1041"><a href="#cb70-1041" aria-hidden="true" tabindex="-1"></a><span class="co"># 创建检索器</span></span>
<span id="cb70-1042"><a href="#cb70-1042" aria-hidden="true" tabindex="-1"></a>retriever <span class="op">=</span> vectorstore.as_retriever(search_kwargs<span class="op">=</span>{<span class="st">"k"</span>: <span class="dv">3</span>})</span>
<span id="cb70-1043"><a href="#cb70-1043" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1044"><a href="#cb70-1044" aria-hidden="true" tabindex="-1"></a><span class="co"># 用于格式化文档的辅助函数</span></span>
<span id="cb70-1045"><a href="#cb70-1045" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> format_docs(docs):</span>
<span id="cb70-1046"><a href="#cb70-1046" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">"</span><span class="ch">\n\n</span><span class="st">"</span>.join(doc.page_content <span class="cf">for</span> doc <span class="kw">in</span> docs)</span>
<span id="cb70-1047"><a href="#cb70-1047" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1048"><a href="#cb70-1048" aria-hidden="true" tabindex="-1"></a><span class="co"># 使用 LCEL 构建 RAG 链</span></span>
<span id="cb70-1049"><a href="#cb70-1049" aria-hidden="true" tabindex="-1"></a>rag_chain <span class="op">=</span> (</span>
<span id="cb70-1050"><a href="#cb70-1050" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb70-1051"><a href="#cb70-1051" aria-hidden="true" tabindex="-1"></a>        <span class="st">"context"</span>: retriever <span class="op">|</span> format_docs,</span>
<span id="cb70-1052"><a href="#cb70-1052" aria-hidden="true" tabindex="-1"></a>        <span class="st">"question"</span>: RunnablePassthrough()</span>
<span id="cb70-1053"><a href="#cb70-1053" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb70-1054"><a href="#cb70-1054" aria-hidden="true" tabindex="-1"></a>    <span class="op">|</span> prompt</span>
<span id="cb70-1055"><a href="#cb70-1055" aria-hidden="true" tabindex="-1"></a>    <span class="op">|</span> llm</span>
<span id="cb70-1056"><a href="#cb70-1056" aria-hidden="true" tabindex="-1"></a>    <span class="op">|</span> StrOutputParser()</span>
<span id="cb70-1057"><a href="#cb70-1057" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb70-1058"><a href="#cb70-1058" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1059"><a href="#cb70-1059" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"✓ RAG 链创建成功！"</span>)</span>
<span id="cb70-1060"><a href="#cb70-1060" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1061"><a href="#cb70-1061" aria-hidden="true" tabindex="-1"></a><span class="co"># 测试 RAG 链</span></span>
<span id="cb70-1062"><a href="#cb70-1062" aria-hidden="true" tabindex="-1"></a>question <span class="op">=</span> <span class="st">"What are model variants?"</span></span>
<span id="cb70-1063"><a href="#cb70-1063" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1064"><a href="#cb70-1064" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">查询问题: </span><span class="sc">{</span>question<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb70-1065"><a href="#cb70-1065" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1066"><a href="#cb70-1066" aria-hidden="true" tabindex="-1"></a><span class="co"># 独立获取上下文文档以便展示</span></span>
<span id="cb70-1067"><a href="#cb70-1067" aria-hidden="true" tabindex="-1"></a>context_docs <span class="op">=</span> retriever.invoke(question)</span>
<span id="cb70-1068"><a href="#cb70-1068" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1069"><a href="#cb70-1069" aria-hidden="true" tabindex="-1"></a><span class="co"># 调用 RAG 链</span></span>
<span id="cb70-1070"><a href="#cb70-1070" aria-hidden="true" tabindex="-1"></a>answer <span class="op">=</span> rag_chain.invoke(question)</span>
<span id="cb70-1071"><a href="#cb70-1071" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> textwrap</span>
<span id="cb70-1072"><a href="#cb70-1072" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1073"><a href="#cb70-1073" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> line <span class="kw">in</span> answer.split(<span class="st">'</span><span class="ch">\n</span><span class="st">'</span>):</span>
<span id="cb70-1074"><a href="#cb70-1074" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(textwrap.fill(line, width<span class="op">=</span><span class="dv">80</span>))</span>
<span id="cb70-1075"><a href="#cb70-1075" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-1076"><a href="#cb70-1076" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1077"><a href="#cb70-1077" aria-hidden="true" tabindex="-1"></a>:::</span>
</code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p>本博客由 ❤️ 和 <a href="https://quarto.org/">Quarto</a> 构建。</p>
</div>
  </div>
</footer>




</body></html>