<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>由 AI 驱动</title>
<link>https://jcwinning.github.io/LandingPage/</link>
<atom:link href="https://jcwinning.github.io/LandingPage/index.xml" rel="self" type="application/rss+xml"/>
<description>由 Quarto 构建的 AI 博客</description>
<generator>quarto-1.8.27</generator>
<lastBuildDate>Mon, 09 Feb 2026 16:00:00 GMT</lastBuildDate>
<item>
  <title>Vibe game: 4人乒乓球游戏与游戏数据分析</title>
  <dc:creator>Tony D</dc:creator>
  <link>https://jcwinning.github.io/LandingPage/posts/vibepong/</link>
  <description><![CDATA[ 





<section id="游戏介绍" class="level1">
<h1>游戏介绍</h1>
<p>VibePong 是一款简单而引人入胜的乒乓球风格游戏，玩家可以互相竞争，也可以与 CPU 对手较量。游戏具有各种指标，如球速、游戏持续时间和玩家表现，这些指标记录在 CSV 文件中以供分析。</p>
<p>立即玩：<a href="https://jcwinning.github.io/vibepong">https://jcwinning.github.io/vibepong</a></p>
<p><img src="https://jcwinning.github.io/LandingPage/posts/vibepong/images/my screenshots 3.png" height="500"> <img src="https://jcwinning.github.io/LandingPage/posts/vibepong/images/my screenshots 1.png" height="500"></p>
</section>
<section id="游戏数据分析" class="level1">
<h1>游戏数据分析</h1>
<p>在本文档中，我们将分析 VibePong 生成的游戏数据。分析涵盖数据摄取、清洗以及带有可视化的探索性数据分析 (EDA)。</p>
</section>
<section id="第一步读取数据" class="level1">
<h1>第一步：读取数据</h1>
<p>首先，我们在 <code>game_data</code> 目录中搜索所有摘要和动作 CSV 文件，并将它们加载到 pandas DataFrame 中。</p>
<div id="20163e06" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Show Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> glob</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb1-4"></span>
<span id="cb1-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define the data path</span></span>
<span id="cb1-6">data_dir <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'./game_data'</span></span>
<span id="cb1-7"></span>
<span id="cb1-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get lists of files</span></span>
<span id="cb1-9">summary_files <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> glob.glob(os.path.join(data_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'vibepong_summary_*.csv'</span>))</span>
<span id="cb1-10">action_files <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> glob.glob(os.path.join(data_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'vibepong_actions_*.csv'</span>))</span>
<span id="cb1-11"></span>
<span id="cb1-12"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Found </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(summary_files)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> summary files and </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(action_files)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> action files."</span>)</span>
<span id="cb1-13"></span>
<span id="cb1-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load and combine summary data</span></span>
<span id="cb1-15">df_summary <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.concat([pd.read_csv(f) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> f <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> summary_files], ignore_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb1-16"></span>
<span id="cb1-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load and combine action data</span></span>
<span id="cb1-18">df_actions <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.concat([pd.read_csv(f) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> f <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> action_files], ignore_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Found 8 summary files and 8 action files.</code></pre>
</div>
</div>
<section id="逐个动作数据" class="level2">
<h2 class="anchored" data-anchor-id="逐个动作数据">逐个动作数据</h2>
<div id="92dc0f80" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>Show Code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Display the first few rows of summary data</span></span>
<span id="cb3-2">df_actions.head()</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="18">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Game ID</th>
<th data-quarto-table-cell-role="th">Timestamp (ms)</th>
<th data-quarto-table-cell-role="th">Player</th>
<th data-quarto-table-cell-role="th">Action</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>G1770703980208-940</td>
<td>4001</td>
<td>System</td>
<td>Ball served towards CPU</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>G1770703980208-940</td>
<td>4814</td>
<td>CPU</td>
<td>Hit Ball</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>G1770703980208-940</td>
<td>6431</td>
<td>Player 1</td>
<td>Hit Ball</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>G1770703980208-940</td>
<td>8048</td>
<td>CPU</td>
<td>Hit Ball</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>G1770703980208-940</td>
<td>9732</td>
<td>Player 1</td>
<td>Lost Life. Remaining: 0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="逐场游戏数据" class="level2">
<h2 class="anchored" data-anchor-id="逐场游戏数据">逐场游戏数据</h2>
<div id="1dc2423c" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>Show Code</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Display the first few rows of summary data</span></span>
<span id="cb4-2">df_summary.head()</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="19">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Game ID</th>
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th">Duration (s)</th>
<th data-quarto-table-cell-role="th">Winner</th>
<th data-quarto-table-cell-role="th">Ball Speed</th>
<th data-quarto-table-cell-role="th">Theme</th>
<th data-quarto-table-cell-role="th">Language</th>
<th data-quarto-table-cell-role="th">Player</th>
<th data-quarto-table-cell-role="th">Lives</th>
<th data-quarto-table-cell-role="th">Hits</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>G1770703980208-940</td>
<td>2026-02-10T06:13:19.507Z</td>
<td>19.30</td>
<td>CPU</td>
<td>7.02</td>
<td>light</td>
<td>zh</td>
<td>Player 1</td>
<td>0</td>
<td>1</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>G1770703980208-940</td>
<td>2026-02-10T06:13:19.507Z</td>
<td>19.30</td>
<td>CPU</td>
<td>7.02</td>
<td>light</td>
<td>zh</td>
<td>CPU</td>
<td>1</td>
<td>4</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>G1770703980208-940</td>
<td>2026-02-10T06:13:19.507Z</td>
<td>19.30</td>
<td>CPU</td>
<td>7.02</td>
<td>light</td>
<td>zh</td>
<td>Player 3</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>G1770703980208-940</td>
<td>2026-02-10T06:13:19.507Z</td>
<td>19.30</td>
<td>CPU</td>
<td>7.02</td>
<td>light</td>
<td>zh</td>
<td>Player 4</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>G1770703089772-903</td>
<td>2026-02-10T05:58:49.043Z</td>
<td>39.27</td>
<td>Tony</td>
<td>13.30</td>
<td>dark</td>
<td>en</td>
<td>Tony</td>
<td>1</td>
<td>11</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
</section>
<section id="第二步数据清洗" class="level1">
<h1>第二步：数据清洗</h1>
<p>我们将通过将时间戳转换为日期时间对象、处理数值类型并确保一致性来清洗数据。</p>
<div id="7f38d6ea" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>Show Code</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1. Convert Date in summary to datetime</span></span>
<span id="cb5-2">df_summary[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Date'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.to_datetime(df_summary[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Date'</span>])</span>
<span id="cb5-3"></span>
<span id="cb5-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 2. Ensure numeric types for metrics</span></span>
<span id="cb5-5">numeric_cols <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Duration (s)'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Ball Speed'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Lives'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Hits'</span>]</span>
<span id="cb5-6"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> col <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> numeric_cols:</span>
<span id="cb5-7">    df_summary[col] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.to_numeric(df_summary[col], errors<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'coerce'</span>)</span>
<span id="cb5-8"></span>
<span id="cb5-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 3. Handle Action data timestamps</span></span>
<span id="cb5-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Action timestamps are in ms (offset from game start)</span></span>
<span id="cb5-11">df_actions[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Timestamp (ms)'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.to_numeric(df_actions[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Timestamp (ms)'</span>], errors<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'coerce'</span>)</span>
<span id="cb5-12"></span>
<span id="cb5-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 4. Check for missing values</span></span>
<span id="cb5-14">missing_counts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df_summary.isnull().<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>()</span>
<span id="cb5-15"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Missing values in Summary data:"</span>)</span>
<span id="cb5-16"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(missing_counts)</span>
<span id="cb5-17"></span>
<span id="cb5-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Drop redundant rows if any (e.g. empty players if they didn't join)</span></span>
<span id="cb5-19">df_summary <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df_summary.dropna(subset<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Player'</span>])</span>
<span id="cb5-20"></span>
<span id="cb5-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Final head view after cleaning</span></span>
<span id="cb5-22">df_summary.head()</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Missing values in Summary data:
Game ID         0
Date            0
Duration (s)    0
Winner          0
Ball Speed      0
Theme           0
Language        0
Player          0
Lives           0
Hits            0
dtype: int64</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="20">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Game ID</th>
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th">Duration (s)</th>
<th data-quarto-table-cell-role="th">Winner</th>
<th data-quarto-table-cell-role="th">Ball Speed</th>
<th data-quarto-table-cell-role="th">Theme</th>
<th data-quarto-table-cell-role="th">Language</th>
<th data-quarto-table-cell-role="th">Player</th>
<th data-quarto-table-cell-role="th">Lives</th>
<th data-quarto-table-cell-role="th">Hits</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>G1770703980208-940</td>
<td>2026-02-10 06:13:19.507000+00:00</td>
<td>19.30</td>
<td>CPU</td>
<td>7.02</td>
<td>light</td>
<td>zh</td>
<td>Player 1</td>
<td>0</td>
<td>1</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>G1770703980208-940</td>
<td>2026-02-10 06:13:19.507000+00:00</td>
<td>19.30</td>
<td>CPU</td>
<td>7.02</td>
<td>light</td>
<td>zh</td>
<td>CPU</td>
<td>1</td>
<td>4</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>G1770703980208-940</td>
<td>2026-02-10 06:13:19.507000+00:00</td>
<td>19.30</td>
<td>CPU</td>
<td>7.02</td>
<td>light</td>
<td>zh</td>
<td>Player 3</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>G1770703980208-940</td>
<td>2026-02-10 06:13:19.507000+00:00</td>
<td>19.30</td>
<td>CPU</td>
<td>7.02</td>
<td>light</td>
<td>zh</td>
<td>Player 4</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>G1770703089772-903</td>
<td>2026-02-10 05:58:49.043000+00:00</td>
<td>39.27</td>
<td>Tony</td>
<td>13.30</td>
<td>dark</td>
<td>en</td>
<td>Tony</td>
<td>1</td>
<td>11</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="第三步eda-与可视化" class="level1">
<h1>第三步：EDA 与可视化</h1>
<p>现在我们将查看一些关键绩效指标并可视化游戏结果。</p>
<section id="获胜分布" class="level2">
<h2 class="anchored" data-anchor-id="获胜分布">获胜分布</h2>
<p>谁赢得了最多的比赛？</p>
<div id="e9bcf506" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>Show Code</summary>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> seaborn <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> sns</span>
<span id="cb7-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb7-3"></span>
<span id="cb7-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set aesthetic style</span></span>
<span id="cb7-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Use 'Arial Unicode MS' on macOS to support Chinese characters</span></span>
<span id="cb7-6">sns.set_theme(style<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"whitegrid"</span>, font<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Arial Unicode MS"</span>)</span>
<span id="cb7-7">plt.rcParams[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'axes.unicode_minus'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span></span>
<span id="cb7-8"></span>
<span id="cb7-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Count unique games per winner</span></span>
<span id="cb7-10">unique_games <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df_summary.drop_duplicates(subset<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Game ID'</span>])</span>
<span id="cb7-11">winner_counts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> unique_games[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Winner'</span>].value_counts()</span>
<span id="cb7-12"></span>
<span id="cb7-13">plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>))</span>
<span id="cb7-14">sns.barplot(x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>winner_counts.index, y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>winner_counts.values, palette<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"viridis"</span>)</span>
<span id="cb7-15">plt.title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Number of Wins by Player/CPU (获胜次数)'</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>)</span>
<span id="cb7-16">plt.ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Games Won (获胜局数)'</span>)</span>
<span id="cb7-17">plt.xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Winner (获胜者)'</span>)</span>
<span id="cb7-18">plt.show()</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://jcwinning.github.io/LandingPage/posts/vibepong/index_files/figure-html/cell-6-output-1.png" width="818" height="535" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="游戏时长-vs.-球速" class="level2">
<h2 class="anchored" data-anchor-id="游戏时长-vs.-球速">游戏时长 vs.&nbsp;球速</h2>
<p>更高的球速会导致游戏时间更短吗？</p>
<div id="813c0c64" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>Show Code</summary>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb8-1">plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>))</span>
<span id="cb8-2">sns.scatterplot(data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>unique_games, x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Ball Speed'</span>, y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Duration (s)'</span>, hue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Winner'</span>, s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span>
<span id="cb8-3">plt.title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Game Duration vs Ball Speed'</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>)</span>
<span id="cb8-4">plt.show()</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://jcwinning.github.io/LandingPage/posts/vibepong/index_files/figure-html/cell-7-output-1.png" width="812" height="530" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="每位玩家的总击球数" class="level2">
<h2 class="anchored" data-anchor-id="每位玩家的总击球数">每位玩家的总击球数</h2>
<p>追踪不同游戏会话中的技巧（击球数）。</p>
<div id="d945ce81" class="cell" data-execution_count="7">
<details class="code-fold">
<summary>Show Code</summary>
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb9-1">plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>))</span>
<span id="cb9-2">sns.boxplot(data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>df_summary, x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Player'</span>, y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Hits'</span>, palette<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"magma"</span>)</span>
<span id="cb9-3">plt.title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Distribution of Hits per Player'</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>)</span>
<span id="cb9-4">plt.show()</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://jcwinning.github.io/LandingPage/posts/vibepong/index_files/figure-html/cell-8-output-1.png" width="961" height="531" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="动作序列" class="level2">
<h2 class="anchored" data-anchor-id="动作序列">动作序列</h2>
<p>分析所有游戏中动作的频率。</p>
<div id="b8ab4544" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>Show Code</summary>
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb10-1">action_counts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df_actions[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Action'</span>].value_counts().head(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb10-2"></span>
<span id="cb10-3">plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>))</span>
<span id="cb10-4">action_counts.plot(kind<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'barh'</span>, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'skyblue'</span>)</span>
<span id="cb10-5">plt.title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Most Frequent Actions/Events'</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>)</span>
<span id="cb10-6">plt.gca().invert_yaxis()</span>
<span id="cb10-7">plt.show()</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://jcwinning.github.io/LandingPage/posts/vibepong/index_files/figure-html/cell-9-output-1.png" width="1111" height="658" class="figure-img"></p>
</figure>
</div>
</div>
</div>


<!-- -->

</section>
</section>

 ]]></description>
  <category>AI</category>
  <category>Games</category>
  <category>Data Analysis</category>
  <guid>https://jcwinning.github.io/LandingPage/posts/vibepong/</guid>
  <pubDate>Mon, 09 Feb 2026 16:00:00 GMT</pubDate>
  <media:content url="https://jcwinning.github.io/LandingPage/posts/vibepong/images/my screenshots 3.png" medium="image" type="image/png" height="136" width="144"/>
</item>
<item>
  <title>AI很复杂，我想喝杯奶茶</title>
  <dc:creator>Tony D</dc:creator>
  <link>https://jcwinning.github.io/LandingPage/posts/AI_milktea/</link>
  <description><![CDATA[ 





<p>马云爸爸这次狂砸30亿。加速AI落地的步伐。今天把千问服务器都搞崩溃了。大战只是刚刚开始。</p>
<section id="千问新年请喝奶茶或者咖啡" class="level1">
<h1>千问新年请喝奶茶或者咖啡</h1>
<p>时间：2026年2月6日-2026年2月12日</p>
<p>方法：千问App输入“帮我点奶茶”或者“我要喝挪瓦咖啡”。会自动关联淘宝下单。</p>
<p><img src="https://jcwinning.github.io/LandingPage/posts/AI_milktea/images/1.png" class="img-fluid" style="width:40.0%"> <img src="https://jcwinning.github.io/LandingPage/posts/AI_milktea/images/2.png" class="img-fluid" style="width:40.0%"></p>
<p><img src="https://jcwinning.github.io/LandingPage/posts/AI_milktea/images/0.png" class="img-fluid" style="width:80.0%"></p>
</section>
<section id="智谱上市请喝旺旺牛奶" class="level1">
<h1>智谱上市请喝旺旺牛奶</h1>
<p>时间：2026年1月8日-2026年1月16日</p>
<p>方法：配置MCP。输入“智谱旺旺”。拿到下单网址。填收货地址。</p>
<p><img src="https://jcwinning.github.io/LandingPage/posts/AI_milktea/images/3.png" class="img-fluid" style="width:80.0%"></p>
</section>
<section id="智谱coding-plan请喝泸上阿姨" class="level1">
<h1>智谱coding plan请喝泸上阿姨</h1>
<p>时间：2025年12月26日-2026年1月9日</p>
<p>方法：配置MCP。输入“阿姨助我”。拿到免费码去泸上阿姨App下单。</p>
<p><img src="https://jcwinning.github.io/LandingPage/posts/AI_milktea/images/4.png" class="img-fluid" style="width:80.0%"></p>


<!-- -->

</section>

 ]]></description>
  <category>AI</category>
  <category>MCP</category>
  <guid>https://jcwinning.github.io/LandingPage/posts/AI_milktea/</guid>
  <pubDate>Thu, 05 Feb 2026 16:00:00 GMT</pubDate>
  <media:content url="https://jcwinning.github.io/LandingPage/posts/AI_milktea/images/0.png" medium="image" type="image/png" height="134" width="144"/>
</item>
<item>
  <title>麦当劳 MCP</title>
  <dc:creator>Tony D</dc:creator>
  <link>https://jcwinning.github.io/LandingPage/posts/mcdonald_mcp/</link>
  <description><![CDATA[ 





<section id="麦当劳-mcp-文档" class="level1">
<h1>麦当劳 MCP 文档</h1>
<p>麦当劳 MCP (Model Context Protocol) 服务允许 AI 助手直接访问麦当劳中国的活动日历、优惠券和营养信息。</p>
<p><a href="https://github.com/M-China/mcd-mcp-server">麦当劳 Github</a></p>
<section id="获取-token" class="level2">
<h2 class="anchored" data-anchor-id="获取-token">1. 获取 Token</h2>
<ol type="1">
<li>访问 <a href="https://open.mcd.cn/mcp">麦当劳 MCP 开放平台</a>。</li>
<li>登录并申请您的个人 MCP Token。</li>
<li>获得 Token 后，请替换下面配置中的 <code>Your-Token</code>。</li>
</ol>
</section>
<section id="配置-mcp-服务" class="level2">
<h2 class="anchored" data-anchor-id="配置-mcp-服务">2. 配置 MCP 服务</h2>
<p>您可以将麦当劳 MCP 集成到支持 MCP 协议的各种工具中。</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" aria-controls="tabset-1-1" aria-selected="true" href="">与 ellmer Chat (R) 集成</a></li><li class="nav-item"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" aria-controls="tabset-1-2" aria-selected="false" href="">Gemini-cli 配置</a></li><li class="nav-item"><a class="nav-link" id="tabset-1-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-3" aria-controls="tabset-1-3" aria-selected="false" href="">Claude Code 配置</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" aria-labelledby="tabset-1-1-tab">
<p><code>mcptools</code> 包可以在 R 中实现 MCP 服务器与 ellmer chat 的无缝集成。以下是配合 ellmer 设置和使用麦当劳 MCP 的方法。</p>
<section id="步骤-1-安装所需包" class="level4">
<h4 class="anchored" data-anchor-id="步骤-1-安装所需包">步骤 1: 安装所需包</h4>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 如果尚未安装，请安装相关包</span></span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">install.packages</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ellmer"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mcptools"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dotenv"</span>))</span></code></pre></div></div>
</div>
</section>
<section id="步骤-2-创建-mcp-配置文件" class="level4">
<h4 class="anchored" data-anchor-id="步骤-2-创建-mcp-配置文件">步骤 2: 创建 MCP 配置文件</h4>
<p>在项目目录中创建一个名为 <code>mcp_config.json</code> 的文件，内容如下：</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-2">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"mcpServers"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-3">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"mcd-mcp"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-4">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"command"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"npx"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-5">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"args"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb2-6">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mcp-remote"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-7">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://mcp.mcd.cn/mcp-servers/mcd-mcp"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-8">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"--header"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-9">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Authorization: Bearer Your-Token"</span></span>
<span id="cb2-10">      <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb2-11">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div></div>
</div>
<p>将 <code>Your-Token</code> 替换为您从 <a href="https://open.mcd.cn/mcp">麦当劳 MCP 开放平台</a> 获取的实际 MCP token。</p>
</section>
<section id="步骤-3-加载库和配置" class="level4">
<h4 class="anchored" data-anchor-id="步骤-3-加载库和配置">步骤 3: 加载库和配置</h4>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ellmer)</span>
<span id="cb3-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(mcptools)</span>
<span id="cb3-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dotenv)</span>
<span id="cb3-4"></span>
<span id="cb3-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 加载环境变量</span></span>
<span id="cb3-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">load_dot_env</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">file =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".env"</span>)</span></code></pre></div></div>
</div>
</section>
<section id="步骤-4-使用-mcp-工具初始化聊天" class="level4">
<h4 class="anchored" data-anchor-id="步骤-4-使用-mcp-工具初始化聊天">步骤 4: 使用 MCP 工具初始化聊天</h4>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 创建一个 ellmer 聊天对象（以 OpenRouter 为例）</span></span>
<span id="cb4-2">chat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">chat_openrouter</span>(</span>
<span id="cb4-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">system_prompt =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"你是一个能够与麦当劳服务交互的得力助手。请使用中文回答，并保持简洁。"</span>,</span>
<span id="cb4-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">api_key =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Sys.getenv</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"OPENROUTER_API_KEY"</span>),</span>
<span id="cb4-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">model =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x-ai/grok-4.1-fast"</span>,</span>
<span id="cb4-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">echo =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"output"</span></span>
<span id="cb4-7">)</span>
<span id="cb4-8"></span>
<span id="cb4-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 从配置文件加载 MCP 工具</span></span>
<span id="cb4-10">mcd_tools <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mcp_tools</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">config =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mcp_config.json"</span>)</span>
<span id="cb4-11"></span>
<span id="cb4-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 向聊天对象注册 MCP 工具</span></span>
<span id="cb4-13">chat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set_tools</span>(mcd_tools)</span></code></pre></div></div>
</div>
</section>
<section id="步骤-5-配合-mcp-集成进行聊天" class="level4">
<h4 class="anchored" data-anchor-id="步骤-5-配合-mcp-集成进行聊天">步骤 5: 配合 MCP 集成进行聊天</h4>
<p>现在您可以提问，AI 将使用麦当劳 MCP 工具：</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 查询可用优惠券</span></span>
<span id="cb5-2">chat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">chat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"现在有哪些可用的优惠券？"</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>目前您有以下已领取的麦麦省优惠券可用：

- 北非蛋风味麦满分
- 9.9元大薯条
- 9.9元新派组合
- 王牌炸鸡双拼盒
- 辣翅成双
- 脆汁鸡任选
- 9.9元那么大鸡排
- 6.9元甜酷任选
- 北非蛋风味麦满分特惠组合
- 13.5元中薯条买一送一
- 19.9元辣翅成双
- 29.9元明星堡堡搭</code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 自动领取所有优惠券</span></span>
<span id="cb7-2">chat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">chat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"帮我领取所有可用的优惠券。"</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>暂无可领取的优惠券。已领取的券可继续使用。</code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 查看您的优惠券</span></span>
<span id="cb9-2">chat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">chat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"显示我目前所有的优惠券。"</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>您目前有 **12 张可用优惠券**（第1/1页）：

1. **9.9元那么大鸡排** ¥9.9 | 至2026-02-06 周1-5 | 今日到期，到店/外送
2. **6.9元甜酷任选** ¥6.9 | 至2026-02-06 周1-5 | 今日到期，到店/外送
3. **13.5元中薯条买一送一** ¥13.5 | 至2026-02-06 周1-5 | 今日到期，到店/外送
4. **19.9元辣翅成双** ¥19.9 | 至2026-02-06 周1-5 | 今日到期，到店/外送
5. **29.9元明星堡堡搭** ¥29.9 | 至2026-02-06 周1-5 | 今日到期，到店/外送
6. **9.9元大薯条** ¥9.9 | 至2026-02-13 周1-5 | 到店/外送
7. **9.9元新派组合** ¥9.9 | 至2026-02-13 周1-5 | 到店/外送
8. **王牌炸鸡双拼盒** ¥39.9 | 至2026-02-08 周六日 | 到店/外送
9. **辣翅成双** ¥19.9 | 至2026-02-08 周六日 | 到店/外送
10. **脆汁鸡任选** ¥9.9 | 至2026-02-08 周六日 | 到店/外送
11. **北非蛋风味麦满分** ¥12.9 | 至2026-02-10 早间 | 到店
12. **北非蛋风味麦满分特惠组合** ¥14.9 | 至2026-02-10 早间 | 到店</code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 查询活动日历</span></span>
<span id="cb11-2">chat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">chat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"接下来的 15 天里有哪些精彩活动？"</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>### 接下来15天（2026.2.7-2.20）精彩活动：

#### **2月7日（明日）**
- **预约麦金喜抽奖**：赢小马宝莉大麻将礼盒（00:00开启）。
- **麦麦盖毯**：128元+100积分解锁暖冬盖毯（麦麦商城）。

#### **持续/近期活动**（多至2.17）
- **麦乐鸡侠福利**（2.4-17）：下单麦乐鸡备注惊喜，赢小食。
- **麦love情人节**（2.4-15）：5款卡面礼卡，拉CP送礼。
- **新春限定新品**：金拱门虾堡、金菠萝鸡扒麦满分、金运糕升等。
- **麦麦省优惠**：9.9鸡排/薯条、19.9辣翅等（已领券可用）。
- **非遗灯会**：北京/上海等城市打卡，集章赢礼。
- **一灯一愿小票**：APP/自助机打印心愿灯票。

更多详情可查麦当劳APP活动页，部分限时/区域。</code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 获取营养信息</span></span>
<span id="cb13-2">chat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">chat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"帮我设计一份 1000 卡路里的套餐，包含一杯含糖可乐，且价格不超过 30 元。"</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>**推荐1000kcal套餐（总价≈29元，使用您的优惠券）：**

- **那么大鸡排**（9.9元券）：385kcal
- **大薯条**（9.9元券）：379kcal
- **可乐中杯**（单点≈10元）：147kcal

**总热量**：911kcal（接近1000kcal，搭配店内免费苹果片+32kcal达943kcal）  
**总价格**：29元以内，到店/外送可用（今日券有效）。营养均衡，主食+碳水+饮品。</code></pre>
</div>
</div>
</section>
</div>
<div id="tabset-1-2" class="tab-pane" aria-labelledby="tabset-1-2-tab">
<p>编辑项目根目录下的 <code>.gemini/settings.json</code> 或全局配置文件 <code>~/.gemini/settings.json</code>：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb15-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb15-2">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"mcpServers"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb15-3">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"mcd-mcp"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb15-4">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"url"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://mcp.mcd.cn/mcp-servers/mcd-mcp"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb15-5">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"headers"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb15-6">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"Authorization"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Bearer Your-Token"</span></span>
<span id="cb15-7">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb15-8">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb15-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb15-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div></div>
</div>
<div id="tabset-1-3" class="tab-pane" aria-labelledby="tabset-1-3-tab">
<p>在项目根目录创建或编辑 <code>.mcp.json</code>：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb16-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb16-2">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"mcpServers"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb16-3">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"mcd-mcp"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb16-4">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"type"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"http"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb16-5">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"url"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://mcp.mcd.cn/mcp-servers/mcd-mcp"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb16-6">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"headers"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb16-7">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"Authorization"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Bearer Your-Token"</span></span>
<span id="cb16-8">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb16-9">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb16-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb16-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div></div>
</div>
</div>
</div>


<!-- -->

</section>
</section>

 ]]></description>
  <category>AI</category>
  <category>MCP</category>
  <guid>https://jcwinning.github.io/LandingPage/posts/mcdonald_mcp/</guid>
  <pubDate>Thu, 05 Feb 2026 16:00:00 GMT</pubDate>
  <media:content url="https://jcwinning.github.io/LandingPage/posts/mcdonald_mcp/images/0.png" medium="image" type="image/png" height="99" width="144"/>
</item>
<item>
  <title>AI 裁判 (AI Judge)</title>
  <dc:creator>Tony D</dc:creator>
  <link>https://jcwinning.github.io/LandingPage/posts/AI judge/</link>
  <description><![CDATA[ 





<p>使用三种方法实现 AI 裁判 (AI Judge) 的 AI 工作流过程：<strong>LangGraph</strong>、<strong>LangChain (LCEL)</strong> 和 <strong>n8n</strong>：</p>
<ul>
<li><ol type="1">
<li><strong>用户输入</strong>：提出一个问题。</li>
</ol></li>
<li><ol start="2" type="1">
<li><strong>模型 A</strong>：生成一个回答。</li>
</ol></li>
<li><ol start="3" type="1">
<li><strong>模型 B</strong>：生成一个回答。</li>
</ol></li>
<li><ol start="4" type="1">
<li><strong>模型 C</strong>：生成一个回答。</li>
</ol></li>
<li><ol start="5" type="1">
<li><strong>裁判 (Judge)</strong>：对比这三个回答，并提供评分（0-100）和评语。</li>
</ol></li>
</ul>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">graph TD
    Start([Start]) --&gt; ModelA[Model A]
    Start --&gt; ModelB[Model B]
    Start --&gt; ModelC[Model C]
    ModelA --&gt; Judge{AI Judge}
    ModelB --&gt; Judge
    ModelC --&gt; Judge
    Judge --&gt; End([End])
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" aria-controls="tabset-1-1" aria-selected="true" href="">LangGraph</a></li><li class="nav-item"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" aria-controls="tabset-1-2" aria-selected="false" href="">LangChain</a></li><li class="nav-item"><a class="nav-link" id="tabset-1-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-3" aria-controls="tabset-1-3" aria-selected="false" href="">n8n</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" aria-labelledby="tabset-1-1-tab">
<section id="设置与环境" class="level2">
<h2 class="anchored" data-anchor-id="设置与环境">1. 设置与环境</h2>
<p>首先，我们需要导入必要的库并加载 API 密钥。我们确保环境中可以使用 openrouter。</p>
<div id="1c112194" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> typing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> TypedDict, Annotated</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langgraph.graph <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> StateGraph, END</span>
<span id="cb1-5"></span>
<span id="cb1-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load environment variables from .env file</span></span>
<span id="cb1-7">load_dotenv()</span>
<span id="cb1-8"></span>
<span id="cb1-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Verify API Key</span></span>
<span id="cb1-10"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> os.getenv(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"openrouter"</span>):</span>
<span id="cb1-11">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"WARNING: openrouter not found in environment. Please check your .env file."</span>)</span>
<span id="cb1-12"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb1-13">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"API Key loaded successfully."</span>)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>API Key loaded successfully.</code></pre>
</div>
</div>
</section>
<section id="初始化模型客户端" class="level2">
<h2 class="anchored" data-anchor-id="初始化模型客户端">2. 初始化模型客户端</h2>
<p>我们将使用标准的 openai Python 客户端，但将其指向 OpenRouter。</p>
<div id="8a9b92de" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> OpenAI</span>
<span id="cb3-2"></span>
<span id="cb3-3">client <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> OpenAI(</span>
<span id="cb3-4">    base_url<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://openrouter.ai/api/v1"</span>,</span>
<span id="cb3-5">    api_key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>os.getenv(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"openrouter"</span>),</span>
<span id="cb3-6">)</span>
<span id="cb3-7"></span>
<span id="cb3-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> query_model(model_name: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, prompt: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, system_prompt: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb3-9">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Helper function to query an LLM via OpenRouter."""</span></span>
<span id="cb3-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb3-11">        messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb3-12">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> system_prompt:</span>
<span id="cb3-13">            messages.append({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"role"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"system"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"content"</span>: system_prompt})</span>
<span id="cb3-14">        messages.append({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"role"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"user"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"content"</span>: prompt})</span>
<span id="cb3-15">        </span>
<span id="cb3-16">        response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> client.chat.completions.create(</span>
<span id="cb3-17">          extra_headers<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{</span>
<span id="cb3-18">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"HTTP-Referer"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://ai_chatbot.github.io/"</span>,  </span>
<span id="cb3-19">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"X-Title"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"AI Judge langgraph"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Your app's display name</span></span>
<span id="cb3-20">            },</span>
<span id="cb3-21">            model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>model_name,</span>
<span id="cb3-22">            messages<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>messages,</span>
<span id="cb3-23">        )</span>
<span id="cb3-24">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> response.choices[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].message.content</span>
<span id="cb3-25">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">Exception</span> <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> e:</span>
<span id="cb3-26">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Error calling </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>model_name<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>e<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span></code></pre></div></div>
</details>
</div>
</section>
<section id="定义状态-state" class="level2">
<h2 class="anchored" data-anchor-id="定义状态-state">3. 定义状态 (State)</h2>
<p>在 LangGraph 中，<strong>状态 (State)</strong> 是在节点之间传递的共享数据结构。在这里，我们的状态跟踪问题、所有回答以及最终的评判结果。</p>
<div id="439d9763" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> JudgeState(TypedDict):</span>
<span id="cb4-2">    question: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb4-3">    answer_a: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb4-4">    answer_b: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb4-5">    answer_c: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb4-6">    judgment: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span></code></pre></div></div>
</details>
</div>
</section>
<section id="定义节点-nodes" class="level2">
<h2 class="anchored" data-anchor-id="定义节点-nodes">4. 定义节点 (Nodes)</h2>
<p>我们为图定义了四个关键节点：1. <strong>模型 A 节点</strong>：回答问题。2. <strong>模型 B 节点</strong>：回答同一个问题。3. <strong>模型 C 节点</strong>：回答同一个问题。4. <strong>裁判节点</strong>：在不知道模型名称的情况下，审核问题和所有三个回答。</p>
<div id="a5769499" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Models</span></span>
<span id="cb5-2">MODEL_A <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"openai/gpt-oss-20b"</span></span>
<span id="cb5-3">MODEL_B <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"deepseek/deepseek-v3.2"</span></span>
<span id="cb5-4">MODEL_C <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x-ai/grok-4.1-fast"</span></span>
<span id="cb5-5">MODEL_JUDGE <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"google/gemini-3-flash-preview"</span></span>
<span id="cb5-6"></span>
<span id="cb5-7"></span>
<span id="cb5-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> node_model_a(state: JudgeState) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> JudgeState:</span>
<span id="cb5-9">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Query Model A"""</span></span>
<span id="cb5-10">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"--- Calling Model A ---"</span>)</span>
<span id="cb5-11">    system_msg <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"If you do not know the answer then reply I am not sure."</span></span>
<span id="cb5-12">    ans <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> query_model(MODEL_A, state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"question"</span>], system_prompt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>system_msg)</span>
<span id="cb5-13">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"answer_a"</span>: ans}</span>
<span id="cb5-14"></span>
<span id="cb5-15"></span>
<span id="cb5-16"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> node_model_b(state: JudgeState) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> JudgeState:</span>
<span id="cb5-17">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Query Model B"""</span></span>
<span id="cb5-18">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"--- Calling Model B ---"</span>)</span>
<span id="cb5-19">    system_msg <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"If you do not know the answer then reply I am not sure."</span></span>
<span id="cb5-20">    ans <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> query_model(MODEL_B, state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"question"</span>], system_prompt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>system_msg)</span>
<span id="cb5-21">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"answer_b"</span>: ans}</span>
<span id="cb5-22"></span>
<span id="cb5-23"></span>
<span id="cb5-24"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> node_model_c(state: JudgeState) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> JudgeState:</span>
<span id="cb5-25">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Query Model C"""</span></span>
<span id="cb5-26">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"--- Calling Model C ---"</span>)</span>
<span id="cb5-27">    system_msg <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"If you do not know the answer then reply I am not sure."</span></span>
<span id="cb5-28">    ans <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> query_model(MODEL_C, state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"question"</span>], system_prompt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>system_msg)</span>
<span id="cb5-29">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"answer_c"</span>: ans}</span>
<span id="cb5-30"></span>
<span id="cb5-31"></span>
<span id="cb5-32"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> node_judge(state: JudgeState) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> JudgeState:</span>
<span id="cb5-33">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Query Judge Model"""</span></span>
<span id="cb5-34">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"--- Calling Judge ---"</span>)</span>
<span id="cb5-35"></span>
<span id="cb5-36">    prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"""</span></span>
<span id="cb5-37"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">    You are an AI Judge. You will be presented with a question and three candidate answers (Model A, Model B, and Model C).</span></span>
<span id="cb5-38"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">    Your task is to judge the quality of the answers without knowing which models produced them.</span></span>
<span id="cb5-39"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">    </span></span>
<span id="cb5-40"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">    Question: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'question'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb5-41"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">    </span></span>
<span id="cb5-42"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">    Answer A:</span></span>
<span id="cb5-43"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">    </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'answer_a'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb5-44"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">    </span></span>
<span id="cb5-45"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">    Answer B:</span></span>
<span id="cb5-46"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">    </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'answer_b'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb5-47"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">    </span></span>
<span id="cb5-48"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">    Answer C:</span></span>
<span id="cb5-49"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">    </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'answer_c'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb5-50"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">    </span></span>
<span id="cb5-51"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">    Task:</span></span>
<span id="cb5-52"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">    1. Compare the three answers for accuracy, clarity, and completeness.</span></span>
<span id="cb5-53"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">    2. format and length of the answers are not important, focus on content quality.</span></span>
<span id="cb5-54"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">    3. Provide a short commentary.</span></span>
<span id="cb5-55"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">    4. Assign a score from 0 to 100 for Model A, Model B, and Model C.</span></span>
<span id="cb5-56"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">    5. Declare the overall winner.</span></span>
<span id="cb5-57"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">    </span></span>
<span id="cb5-58"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">    Output Format:</span></span>
<span id="cb5-59"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">    Commentary: &lt;text&gt;</span></span>
<span id="cb5-60"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">    Winner: &lt;Model A, Model B, or Model C&gt;</span></span>
<span id="cb5-61"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">    Score A: &lt;number&gt;</span></span>
<span id="cb5-62"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">    Score B: &lt;number&gt;</span></span>
<span id="cb5-63"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">    Score C: &lt;number&gt;</span></span>
<span id="cb5-64"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb5-65"></span>
<span id="cb5-66">    judgment <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> query_model(MODEL_JUDGE, prompt)</span>
<span id="cb5-67">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"judgment"</span>: judgment}</span></code></pre></div></div>
</details>
</div>
</section>
<section id="构建图-graph" class="level2">
<h2 class="anchored" data-anchor-id="构建图-graph">5. 构建图 (Graph)</h2>
<p>现在我们通过添加节点和定义流（边 Edges）来组装图。模型 A、模型 B 和模型 C 将<strong>独立且并行</strong>运行，然后由裁判进行评判。</p>
<div id="9fd17633" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langgraph.graph <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> START</span>
<span id="cb6-2"></span>
<span id="cb6-3">workflow <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> StateGraph(JudgeState)</span>
<span id="cb6-4"></span>
<span id="cb6-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add nodes</span></span>
<span id="cb6-6">workflow.add_node(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"model_a"</span>, node_model_a)</span>
<span id="cb6-7">workflow.add_node(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"model_b"</span>, node_model_b)</span>
<span id="cb6-8">workflow.add_node(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"model_c"</span>, node_model_c)</span>
<span id="cb6-9">workflow.add_node(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"judge"</span>, node_judge)</span>
<span id="cb6-10"></span>
<span id="cb6-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Parallel flow: START -&gt; A &amp; B &amp; C -&gt; Judge -&gt; </span><span class="re">END</span></span>
<span id="cb6-12">workflow.add_edge(START, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"model_a"</span>)</span>
<span id="cb6-13">workflow.add_edge(START, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"model_b"</span>)</span>
<span id="cb6-14">workflow.add_edge(START, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"model_c"</span>)</span>
<span id="cb6-15">workflow.add_edge(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"model_a"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"judge"</span>)</span>
<span id="cb6-16">workflow.add_edge(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"model_b"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"judge"</span>)</span>
<span id="cb6-17">workflow.add_edge(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"model_c"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"judge"</span>)</span>
<span id="cb6-18">workflow.add_edge(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"judge"</span>, END)</span>
<span id="cb6-19"></span>
<span id="cb6-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compile the graph</span></span>
<span id="cb6-21">app <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> workflow.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">compile</span>()</span></code></pre></div></div>
</details>
</div>
</section>
<section id="执行" class="level2">
<h2 class="anchored" data-anchor-id="执行">6. 执行</h2>
<p>最后，我们使用一个示例问题运行该工作流。</p>
<div id="b2104e76" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1">input_question <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Will AI take over the world in the next 50 years?"</span></span>
<span id="cb7-2"></span>
<span id="cb7-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Initialize state</span></span>
<span id="cb7-4">initial_state <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"question"</span>: input_question}</span>
<span id="cb7-5"></span>
<span id="cb7-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Run the graph</span></span>
<span id="cb7-7">result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> app.invoke(initial_state)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>--- Calling Model A ---
--- Calling Model B ---
--- Calling Model C ---
--- Calling Judge ---</code></pre>
</div>
</div>
<div id="e6869bcf" class="cell" data-execution_count="7">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Display Results</span></span>
<span id="cb9-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"="</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>)</span>
<span id="cb9-3"></span>
<span id="cb9-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"QUESTION: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'question'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb9-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"="</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
========================================
QUESTION: Will AI take over the world in the next 50 years?
========================================</code></pre>
</div>
</div>
<section id="模型-a" class="level3">
<h3 class="anchored" data-anchor-id="模型-a">模型 A</h3>
<div id="840e69dc" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(MODEL_A)</span>
<span id="cb11-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">[Model A ]:</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>result<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'answer_a'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'No response'</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>) </span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>openai/gpt-oss-20b

[Model A ]:
It’s a question that gets a lot of speculation, but most experts would agree that an AI “taking over the world” in the sense of a single autonomous entity controlling governments, economies, or everyday life is highly unlikely within the next 50 years. Here’s why:

| Factor | Current reality | 50‑year outlook | Why the scenario is unlikely |
|--------|-----------------|-----------------|------------------------------|
| **Technical state of AI** | Narrow AI (deep learning, NLP, etc.) excels at specific tasks but lacks general common‑sense reasoning, self‑reflexive goals, or long‑term planning. | Incremental progress toward more general but still domain‑specific systems (e.g., multimodal, few‑shot learning). | No evidence of a system that can autonomously redesign itself, acquire resources, or out‑maneuver human governance. |
| **Hardware limits** | Massive GPUs and specialized accelerators enable scaling but also tie performance to cost and energy consumption. | Advances in silicon, photonic processors, and quantum hardware might increase raw speed, yet training and inference for a true “world‑dominating” agent would still require astronomical data and power. | Even exascale computing would be dwarfed by the computational demands of global‑scale autonomous control. |
| **Data and knowledge** | Models are only as good as the curated data they’re trained on. Open‑world reasoning is a problem—AI can hallucinate or misinterpret new contexts. | Improvements in continual learning, self‑supervised signals, and large knowledge graphs may reduce gaps, but the universe is too vast for any single model to master. | Lack of comprehensive, up‑to‑date, context‑rich data hinders a truly autonomous agent from operating worldwide. |
| **Safety &amp; governance** | Research on alignment, interpretability, and fail‑safe mechanisms is fast growing; many organizations set up oversight boards and open‑source safety modules. | Regulatory frameworks (e.g., EU AI Act, US federal agencies) will likely enforce risk‑assessment, certification, and transparency for high‑impact systems. | Regulatory, technical, and cultural pushes make it difficult for an unverified AI to “take over” undetected. |
| **Human control** | Current deployment is tightly coupled to human objectives: APIs, fine‑tuning, and manual oversight. | Even as general‑intelligence benchmarks approach, human‑in‑the‑loop systems will remain standard in critical domains (healthcare, finance, autonomous vehicles). | Most sectors will continue to rely on hybrid human‑AI systems, limiting the chance for complete autonomous governance. |
| **Economic &amp; political dynamics** | AI innovations are commercial, funded by incumbents, and subject to market incentives. | Policy makers and civil society are increasingly active in shaping AI norms, with a focus on equity, privacy, and security. | The political will to allow a single AI entity to dominate would be resisted by multiple stakeholders. |

### What “taking over” would actually require
1. **General-purpose intelligence** with self‑directed objectives.  
2. **Access to physical resources** (energy, infrastructure).  
3. **Survival incentives** that override human safety constraints.  
4. **Strategic capabilities** to influence or bypass human institutions.

None of these exist today, and each is a major research milestone that carries significant technical, ethical, and legal barriers.

### The more realistic future
In five decades we are likely to see:
* **Better generalization** across domains, but still heavily guided by human intent.  
* **Robust safety protocols**, explainability dashboards, and audit trails.  
* **Global norms** (e.g., AI safety treaties) that constrain unchecked deployment.  
* **Distributed AI ecosystems**—many large, specialized systems operating under shared standards, not a single overseer.

### Bottom line
While it’s prudent to treat AI as a powerful tool that must be governed responsibly, the notion that a single AI will “take over the world” in the next 50 years is, given current knowledge and trends, highly improbable. It’s more realistic to focus on managing the societal, economic, and policy impacts of increasingly capable AI systems than on a dystopian domination scenario.</code></pre>
</div>
</div>
</section>
<section id="模型-b" class="level3">
<h3 class="anchored" data-anchor-id="模型-b">模型 B</h3>
<div id="9e6891f4" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(MODEL_B)</span>
<span id="cb13-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">[Model B ]:</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>result<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'answer_b'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'No response'</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb13-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"="</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>deepseek/deepseek-v3.2

[Model B ]:
That's one of the most debated questions of our time. The short answer is: **It's highly unlikely that AI will "take over the world" in a Hollywood-style robot apocalypse within 50 years, but it will almost certainly transform it in profound, disruptive, and potentially dangerous ways.**

Here’s a breakdown of the key perspectives and what "take over" could actually mean:

### 1. The "Takeover" Scenarios (Why People Worry)
*   **Loss of Control (Alignment Problem):** The core fear is that we might create a superintelligent AI (far surpassing human intelligence) whose goals are not perfectly aligned with human survival and flourishing. If such an AI were to pursue a poorly specified goal (e.g., "make paperclips"), it could treat humans as obstacles or resources.
*   **Economic and Structural Takeover:** A more plausible near-term "takeover" is economic. AI could automate a vast number of jobs, not just manual labor but also creative and cognitive work. This could lead to massive economic displacement, increased inequality, and a shift in power to those who control the AI systems.
*   **Autonomous Weapons:** The use of AI in warfare (lethal autonomous weapons or "killer robots") could lead to new forms of conflict and accidental escalation, effectively letting algorithms make life-and-death decisions.
*   **Informational and Social Control:** AI is already used for hyper-targeted propaganda, deepfakes, and social manipulation. This could erode democracy, truth, and social cohesion, allowing those in control of the technology to wield immense soft power.

### 2. The Counterarguments (Why a Hostile Takeover is Unlikely)
*   **Narrow vs. General Intelligence:** Today's AI (including large language models like me) is **narrow AI**—extraordinarily capable at specific tasks but lacking understanding, consciousness, or general-purpose reasoning. Creating Artificial General Intelligence (AGI) is a monumental, unsolved scientific challenge. 50 years is a long time in tech, but there's no guarantee AGI will be achieved.
*   **Control and Safety Research:** The field of AI alignment and safety is growing rapidly. Many of the world's top AI labs consider controlling superintelligent AI their primary research problem.
*   **Human Governance:** AI doesn't exist in a vacuum. Laws, regulations, international treaties, and corporate policies will be developed to manage its risks (just as we did for nuclear power, biotechnology, etc.). The outcome will depend heavily on human political and ethical choices.

### 3. The More Probable Reality (Next 50 Years)
The next five decades will likely be defined not by a single hostile AI, but by:
*   **Ubiquitous Integration:** AI will become like electricity—an invisible, essential utility powering everything from healthcare (personalized medicine) and science (drug discovery, climate modeling) to entertainment and transportation.
*   **The Partnership Model:** The most productive path is **human-AI collaboration**. AI will augment human capabilities, helping us solve complex problems like disease and climate change, while humans provide oversight, creativity, and ethical judgment.
*   **Major Societal Challenges:** The biggest threats won't be sentient robots, but:
    *   **Job Disruption:** We may need to radically rethink concepts like work, income, and purpose.
    *   **Bias and Fairness:** AI systems can perpetuate and amplify societal biases.
    *   **Concentration of Power:** The risk of a few corporations or governments controlling world-leading AI.
    *   **Existential Risk from Misuse:** Even without malice, advanced AI could be catastrophically misused by humans (e.g., in engineered pandemics or cyber warfare).

**Conclusion:**
Instead of a **"takeover,"** think of a **"handover."** We are increasingly handing over decisions—from what news we see to medical diagnoses to financial trades—to AI systems. The critical question for the next 50 years is not *"Will AI become our master?"* but ***"How can we build and govern AI so that it remains a powerful tool for the benefit of all humanity, and how do we adapt our societies to the immense changes it will bring?"***

The future isn't pre-written. It will be shaped by the research, policies, and ethical frameworks we develop **today.**
========================================</code></pre>
</div>
</div>
</section>
<section id="模型-c" class="level3">
<h3 class="anchored" data-anchor-id="模型-c">模型 C</h3>
<div id="f2742286" class="cell" data-execution_count="10">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(MODEL_C)</span>
<span id="cb15-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">[Model C ]:</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>result<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'answer_c'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'No response'</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb15-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"="</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>x-ai/grok-4.1-fast

[Model C ]:
I am not sure.
========================================</code></pre>
</div>
</div>
</section>
<section id="裁判模型-model-judge" class="level3">
<h3 class="anchored" data-anchor-id="裁判模型-model-judge">裁判模型 (Model JUDGE)</h3>
<div id="fd136850" class="cell" data-execution_count="11">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">&gt;&gt;&gt; JUDGE'S VERDICT &lt;&lt;&lt;"</span>)</span>
<span id="cb17-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"MODEL_A:"</span>)</span>
<span id="cb17-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(MODEL_A)</span>
<span id="cb17-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"MODEL_B:"</span>)</span>
<span id="cb17-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(MODEL_B)</span>
<span id="cb17-6"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"MODEL_C:"</span>)</span>
<span id="cb17-7"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(MODEL_C)</span>
<span id="cb17-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"MODEL_JUDGE:"</span>)</span>
<span id="cb17-9"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(MODEL_JUDGE)</span>
<span id="cb17-10"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"====="</span>)</span>
<span id="cb17-11"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"judgment"</span>])</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
&gt;&gt;&gt; JUDGE'S VERDICT &lt;&lt;&lt;
MODEL_A:
openai/gpt-oss-20b
MODEL_B:
deepseek/deepseek-v3.2
MODEL_C:
x-ai/grok-4.1-fast
MODEL_JUDGE:
google/gemini-3-flash-preview
=====
Commentary: Model A and Model B both provide excellent, high-quality responses to a complex, speculative question. Model A uses a highly structured tabular format to break down the technical, hardware, and regulatory hurdles, providing a very grounded and logical assessment of why a total takeover is unlikely. Model B offers a slightly more nuanced discussion on the different definitions of a "takeover" (economic, informational, vs. Hollywood-style), which adds a layer of depth regarding the actual risks humanity faces. Both correctly identify the distinction between Narrow AI and AGI and discuss the importance of the alignment problem. Model C is unhelpful and fails to engage with the prompt. Model A is slightly more impressive due to its systematic breakdown of current vs. future states across multiple dimensions.

Winner: Model A

Score A: 95
Score B: 92
Score C: 5</code></pre>
</div>
</div>
</section>
</section>
</div>
<div id="tabset-1-2" class="tab-pane" aria-labelledby="tabset-1-2-tab">
<section id="设置与环境-1" class="level2">
<h2 class="anchored" data-anchor-id="设置与环境-1">1. 设置与环境</h2>
<p>首先，我们需要导入必要的库并加载 API 密钥。我们确保环境中可以使用 openrouter。我们将使用 <code>langchain-openai</code> 与 OpenRouter 进行交互。</p>
<div id="d5820d7a" class="cell" data-execution_count="12">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb19-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv</span>
<span id="cb19-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChatOpenAI</span>
<span id="cb19-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.prompts <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChatPromptTemplate</span>
<span id="cb19-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.runnables <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> RunnableParallel, RunnablePassthrough</span>
<span id="cb19-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.output_parsers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> StrOutputParser</span>
<span id="cb19-7"></span>
<span id="cb19-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load environment variables from .env file</span></span>
<span id="cb19-9">load_dotenv()</span>
<span id="cb19-10"></span>
<span id="cb19-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Verify API Key</span></span>
<span id="cb19-12"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> os.getenv(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"openrouter"</span>):</span>
<span id="cb19-13">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"WARNING: openrouter not found in environment. Please check your .env file."</span>)</span>
<span id="cb19-14"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb19-15">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"API Key loaded successfully."</span>)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>API Key loaded successfully.</code></pre>
</div>
</div>
</section>
<section id="初始化模型" class="level2">
<h2 class="anchored" data-anchor-id="初始化模型">2. 初始化模型</h2>
<p>我们将初始化指向 OpenRouter 的三个模型实例。</p>
<div id="f6ad7234" class="cell" data-execution_count="13">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Models</span></span>
<span id="cb21-2">MODEL_A_NAME <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"openai/gpt-oss-20b"</span></span>
<span id="cb21-3">MODEL_B_NAME <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"deepseek/deepseek-v3.2"</span></span>
<span id="cb21-4">MODEL_C_NAME <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x-ai/grok-4.1-fast"</span></span>
<span id="cb21-5">MODEL_JUDGE_NAME <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"google/gemini-3-flash-preview"</span></span>
<span id="cb21-6"></span>
<span id="cb21-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_model(model_name: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>):</span>
<span id="cb21-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> ChatOpenAI(</span>
<span id="cb21-9">        model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>model_name,</span>
<span id="cb21-10">        api_key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>os.getenv(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"openrouter"</span>),</span>
<span id="cb21-11">        base_url<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://openrouter.ai/api/v1"</span>,</span>
<span id="cb21-12">        default_headers<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{</span>
<span id="cb21-13">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"HTTP-Referer"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://ai_chatbot.github.io/"</span>,</span>
<span id="cb21-14">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"X-Title"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"AI Judge LangChain"</span>,</span>
<span id="cb21-15">        }</span>
<span id="cb21-16">    )</span>
<span id="cb21-17"></span>
<span id="cb21-18">model_a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_model(MODEL_A_NAME)</span>
<span id="cb21-19">model_b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_model(MODEL_B_NAME)</span>
<span id="cb21-20">model_c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_model(MODEL_C_NAME)</span>
<span id="cb21-21">model_judge <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_model(MODEL_JUDGE_NAME)</span></code></pre></div></div>
</details>
</div>
</section>
<section id="定义链-chains-与工作流" class="level2">
<h2 class="anchored" data-anchor-id="定义链-chains-与工作流">3. 定义链 (Chains) 与工作流</h2>
<p>使用 LangChain 表达式语言 (LCEL)，我们可以轻松定义并行执行和顺序步骤。</p>
<div id="f71e00b7" class="cell" data-execution_count="14">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Step 1: Query models in parallel</span></span>
<span id="cb22-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># We use RunnableParallel to run model_a, model_b, and model_c at the same time.</span></span>
<span id="cb22-3">system_prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"If you do not know the answer then reply I am not sure."</span></span>
<span id="cb22-4">prompt_template <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatPromptTemplate.from_messages([</span>
<span id="cb22-5">    (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"system"</span>, system_prompt),</span>
<span id="cb22-6">    (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"user"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{question}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb22-7">])</span>
<span id="cb22-8"></span>
<span id="cb22-9">parallel_responses <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> RunnableParallel(</span>
<span id="cb22-10">    answer_a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(prompt_template <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> model_a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> StrOutputParser()),</span>
<span id="cb22-11">    answer_b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(prompt_template <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> model_b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> StrOutputParser()),</span>
<span id="cb22-12">    answer_c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(prompt_template <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> model_c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> StrOutputParser()),</span>
<span id="cb22-13">    question<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>RunnablePassthrough()</span>
<span id="cb22-14">)</span>
<span id="cb22-15"></span>
<span id="cb22-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Step 2: Define the Judge Prompt</span></span>
<span id="cb22-17">judge_prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatPromptTemplate.from_template(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb22-18"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    You are an AI Judge. You will be presented with a question and three candidate answers (Model A, Model B, and Model C).</span></span>
<span id="cb22-19"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    Your task is to judge the quality of the answers.</span></span>
<span id="cb22-20"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    </span></span>
<span id="cb22-21"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    Question: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{question}</span></span>
<span id="cb22-22"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    </span></span>
<span id="cb22-23"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    Answer A:</span></span>
<span id="cb22-24"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{answer_a}</span></span>
<span id="cb22-25"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    </span></span>
<span id="cb22-26"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    Answer B:</span></span>
<span id="cb22-27"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{answer_b}</span></span>
<span id="cb22-28"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    </span></span>
<span id="cb22-29"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    Answer C:</span></span>
<span id="cb22-30"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{answer_c}</span></span>
<span id="cb22-31"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    </span></span>
<span id="cb22-32"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    Task:</span></span>
<span id="cb22-33"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    1. Compare the three answers for accuracy, clarity, and completeness.</span></span>
<span id="cb22-34"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    2. format and length of the answers are not important, focus on content quality.</span></span>
<span id="cb22-35"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    3. Provide a short commentary.</span></span>
<span id="cb22-36"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    4. Assign a score from 0 to 100 for Model A, Model B, and Model C.</span></span>
<span id="cb22-37"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    5. Declare the overall winner.</span></span>
<span id="cb22-38"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    </span></span>
<span id="cb22-39"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    Output Format:</span></span>
<span id="cb22-40"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    Commentary: &lt;text&gt;</span></span>
<span id="cb22-41"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    Winner: &lt;Model A or Model B or Model C&gt;</span></span>
<span id="cb22-42"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    Score A: &lt;number&gt;</span></span>
<span id="cb22-43"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    Score B: &lt;number&gt;</span></span>
<span id="cb22-44"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    Score C: &lt;number&gt;</span></span>
<span id="cb22-45"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span>)</span>
<span id="cb22-46"></span>
<span id="cb22-47"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Step 3: Combine everything into a full chain</span></span>
<span id="cb22-48"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># The output of parallel_responses is a dict, which matches the input expected by judge_prompt</span></span>
<span id="cb22-49">full_chain <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> parallel_responses <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> {</span>
<span id="cb22-50">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"judgment"</span>: judge_prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> model_judge <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> StrOutputParser(),</span>
<span id="cb22-51">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"answer_a"</span>: <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> x: x[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"answer_a"</span>],</span>
<span id="cb22-52">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"answer_b"</span>: <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> x: x[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"answer_b"</span>],</span>
<span id="cb22-53">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"answer_c"</span>: <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> x: x[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"answer_c"</span>],</span>
<span id="cb22-54">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"question"</span>: <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> x: x[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"question"</span>]</span>
<span id="cb22-55">}</span></code></pre></div></div>
</details>
</div>
</section>
<section id="执行-1" class="level2">
<h2 class="anchored" data-anchor-id="执行-1">4. 执行</h2>
<p>最后，我们使用一个示例问题运行该链。</p>
<div id="a0f42c16" class="cell" data-execution_count="15">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1">input_question <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"What is the AI advantage of using transformer architectures over traditional RNNs in natural language processing tasks?"</span></span>
<span id="cb23-2"></span>
<span id="cb23-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"--- Running Workflow for Question: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>input_question<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> ---"</span>)</span>
<span id="cb23-4"></span>
<span id="cb23-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Execute the chain</span></span>
<span id="cb23-6">result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> full_chain.invoke({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"question"</span>: input_question})</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>--- Running Workflow for Question: What is the AI advantage of using transformer architectures over traditional RNNs in natural language processing tasks? ---</code></pre>
</div>
</div>
</section>
<section id="显示结果" class="level2">
<h2 class="anchored" data-anchor-id="显示结果">5. 显示结果</h2>
<div id="ed5b3613" class="cell" data-execution_count="16">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"="</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>)</span>
<span id="cb25-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"QUESTION: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'question'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb25-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"="</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
========================================
QUESTION: {'question': 'What is the AI advantage of using transformer architectures over traditional RNNs in natural language processing tasks?'}
========================================</code></pre>
</div>
</div>
<section id="模型-a-1" class="level3">
<h3 class="anchored" data-anchor-id="模型-a-1">模型 A</h3>
<div id="26eab7cf" class="cell" data-execution_count="17">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"MODEL: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>MODEL_A_NAME<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb27-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">[Model A]:</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>result<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'answer_a'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'No response'</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>) </span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>MODEL: openai/gpt-oss-20b

[Model A]:
**Transformers versus traditional RNNs**  
In natural‑language processing (NLP) the shift from recurrent neural networks (RNNs) and their gated cousins (LSTMs/GRUs) to transformer‑style architectures has become foundational.  The key AI advantages of transformers are rooted in the way they **represent, process, and learn from text**:

| Feature | How Transformers do it | Why it matters over RNNs |
|---------|------------------------|--------------------------|
| **Parallelization** | Self‑attention applies to all tokens in a sequence *simultaneously* (batchwise). | RNNs process tokens one after another; this sequential bottleneck limits GPU utilisation and slows both training and inference. |
| **Capturing long‑range dependencies** | Each token attends to every other token – weighting nearby and far‑away words equally. | RNNs suffer from vanishing/ exploding gradients and struggle to propagate signals over long distances; transformers break this barrier naturally. |
| **Memory‑friendly gradients** | Layer‑norm, residuals, and attention gradients flow easily, avoiding the need for careful gating mechanisms. | RNNs require gating (LSTM/GRU) to mitigate gradients, yet tuning them is delicate, especially with long sequences. |
| **Scalable pre‑training &amp; transfer learning** | Layer‑wise transformer blocks can be stacked to huge depths; large‑scale unsupervised architectures such as BERT, GPT, T5 can be fine‑tuned for downstream tasks. | RNN‑based models generally have not reached the same scale or generic transferability. |
| **Interpretability of attention** | Attention weights provide a view of what the model deems important as it processes each token. | RNNs do not give an explicit, interpretable alignment between inputs and outputs. |
| **Better handling of varied sequence length** | Position encodings (learned or sinusoidal) give absolute context, enabling transformers to process very short or very long sentences without structural alterations. | RNNs need separate architectures for bidirectional or unidirectional contexts; long sequences make training unstable. |
| **Efficient inference in practice** | Beam‑search decoding or caching in transformers (e.g. for GPT) can reuse past key/value matrices across time steps. | RNNs recompute hidden states at each step; caching is non‑trivial. |
| **Architectural simplicity** | Transformers consist mainly of linear layers, attention heads, and feed‑forward networks; no recurrent loops. | Less algorithmic complexity and fewer hyper‑parameters to tweak for long‑term dependencies. |

### Concrete results

| NLP task | Transformer state‑of‑the‑art | RNN‑based performance (historical) |
|---------|-----------------------------|-----------------------------------|
| Machine translation (En→De) | 0.93 BLEU (mBART, T5) | 0.75 BLEU (LSTM + attention) |
| Question answering (SQuAD2.0) | 90 % Exact Match | 70 % |
| Language modelling (perplexity on WikiText‑103) | 35 (GPT‑2) | ≈ 70 (LSTM) |

These figures simply illustrate how transformative the architecture is on a wide spectrum of tasks.

---

## Bottom line

**Transformers provide a fundamentally different, highly parallel way to capture arbitrary global context with stable learning dynamics.**  This leads to superior performance across most NLP tasks, faster training and inference, and a versatile framework for large‑scale pre‑training that RNNs cannot match.</code></pre>
</div>
</div>
</section>
<section id="模型-b-1" class="level3">
<h3 class="anchored" data-anchor-id="模型-b-1">模型 B</h3>
<div id="5d92ca91" class="cell" data-execution_count="18">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"MODEL: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>MODEL_B_NAME<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb29-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">[Model B]:</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>result<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'answer_b'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'No response'</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb29-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"="</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>MODEL: deepseek/deepseek-v3.2

[Model B]:
Of course. Here’s a clear breakdown of the key AI advantages of Transformer architectures over traditional RNNs (like LSTMs and GRUs) in NLP tasks.

The core difference is that **Transformers process all words in a sequence simultaneously** and use a **self-attention mechanism** to understand contextual relationships, whereas RNNs process words sequentially and struggle with long-range dependencies.

### Key Advantages of Transformers:

1.  **Parallelization &amp; Speed:** RNNs are inherently sequential—they must compute step-by-step, making them slow on modern hardware (GPUs/TPUs). Transformers process all tokens in a sequence in parallel, leading to vastly faster training times.

2.  **Long-Range Dependency Handling:** RNNs suffer from the "vanishing gradient" problem, making it hard to learn relationships between distant words. Transformers' self-attention mechanism can directly connect any two words in the sequence, regardless of distance, with a constant number of operations. This is crucial for tasks like document understanding or long-form text generation.

3.  **Superior Contextual Understanding via Self-Attention:** Self-attention allows each word to directly attend to all other words in the sequence, weighing their importance. This creates richer, more nuanced contextual embeddings than RNNs, which compress past information into a single hidden state.

4.  **Scalability with Model Size:** Because of parallelization, Transformers can be scaled up dramatically (more layers, larger hidden dimensions) to create massive models (like GPT and BERT). This scaling has been empirically shown to lead to consistently better performance. RNNs become prohibitively slow and unstable as they grow deeper.

5.  **Effectiveness on Modern Hardware:** Transformers are dominated by matrix multiplications, which are perfectly suited for acceleration on GPUs/TPUs. RNNs' sequential nature underutilizes this hardware.

### Where Traditional RNNs Might Still Have a Niche:
- **Streaming/Online Tasks:** For tasks where input arrives in a continuous, real-time stream (e.g., real-time speech processing), RNNs can process data incrementally without a fixed sequence length, while standard Transformers require a pre-defined context window.
- **Extremely Low-Resource Environments:** Very small RNNs can be more efficient for simple tasks where massive contextual understanding isn't needed.

**In summary, Transformers replaced RNNs as the dominant architecture in NLP because their ability to process information in parallel and model long-range dependencies directly led to **faster training, more powerful models, and significantly better performance** across almost all benchmark tasks.** The rise of large language models (LLMs) is fundamentally a result of the Transformer's scalable architecture.
========================================</code></pre>
</div>
</div>
</section>
<section id="模型-c-1" class="level3">
<h3 class="anchored" data-anchor-id="模型-c-1">模型 C</h3>
<div id="e3041ff2" class="cell" data-execution_count="19">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"MODEL: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>MODEL_C_NAME<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb31-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">[Model C]:</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>result<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'answer_c'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'No response'</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb31-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"="</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>MODEL: x-ai/grok-4.1-fast

[Model C]:
**Key AI advantages of Transformer architectures over traditional RNNs (e.g., LSTMs or GRUs) in NLP tasks:**

- **Parallel Processing**: Transformers use self-attention to process entire sequences (all tokens) simultaneously, enabling massive parallelization on GPUs/TPUs. RNNs process tokens sequentially (one timestep at a time), leading to slower training and inference, especially for long sequences.

- **Superior Handling of Long-Range Dependencies**: Self-attention mechanisms directly compute relationships between any pair of tokens, regardless of distance. RNNs struggle with this due to sequential information flow, causing "vanishing gradients" and forgetting distant context (even in improved variants like LSTMs).

- **Mitigation of Gradient Issues**: Transformers avoid recurrent connections, eliminating vanishing/exploding gradient problems during backpropagation through time (BPTT) in RNNs, allowing stable training on much longer sequences.

- **Scalability and Efficiency**: Transformers scale better with model size, data volume, and compute (e.g., via larger batch sizes and deeper layers). This has led to breakthroughs like BERT, GPT, and T5, outperforming RNNs on tasks like machine translation, summarization, and question answering.

- **Flexibility**: Positional encodings allow Transformers to handle variable-length inputs without state management, unlike RNNs which maintain hidden states.

**Empirical Evidence**: On benchmarks like GLUE or SQuAD, Transformers achieve 10-30%+ accuracy gains over RNN baselines, with training times reduced from days/weeks to hours for large datasets.

In summary, Transformers revolutionized NLP by trading recurrence for attention, enabling faster, more effective models for modern-scale data.
========================================</code></pre>
</div>
</div>
</section>
<section id="ai-裁判结论" class="level3">
<h3 class="anchored" data-anchor-id="ai-裁判结论">AI 裁判结论</h3>
<div id="84e88517" class="cell" data-execution_count="20">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">&gt;&gt;&gt; JUDGE'S VERDICT &lt;&lt;&lt;"</span>)</span>
<span id="cb33-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"MODEL_A: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>MODEL_A_NAME<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb33-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"MODEL_B: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>MODEL_B_NAME<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb33-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"MODEL_C: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>MODEL_C_NAME<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb33-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"JUDGE:   </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>MODEL_JUDGE_NAME<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb33-6"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"====="</span>)</span>
<span id="cb33-7"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'judgment'</span>])</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
&gt;&gt;&gt; JUDGE'S VERDICT &lt;&lt;&lt;
MODEL_A: openai/gpt-oss-20b
MODEL_B: deepseek/deepseek-v3.2
MODEL_C: x-ai/grok-4.1-fast
JUDGE:   google/gemini-3-flash-preview
=====
Commentary: Model A provides the most comprehensive and high-quality response. It utilizes a tabular format that makes it easy to compare specific features and their impacts. It also includes concrete (though illustrative) performance metrics and addresses more nuanced advantages like interpretability and inference caching. Model B is also excellent, adding a thoughtful section on where RNNs might still be useful, providing a balanced perspective. Model C is a solid, standard technical summary but lacks the extra depth and formatting polish of the other two.

Winner: Model A

Score A: 96
Score B: 90
Score C: 82</code></pre>
</div>
</div>
</section>
</section>
</div>
<div id="tabset-1-3" class="tab-pane" aria-labelledby="tabset-1-3-tab">
<p><img src="https://jcwinning.github.io/LandingPage/posts/AI judge/images/clipboard-1254380001.png" class="img-fluid"></p>
<section id="json-文件" class="level2">
<h2 class="anchored" data-anchor-id="json-文件">JSON 文件</h2>
<div id="4a7745cf" class="cell" data-execution_count="21">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1">{</span>
<span id="cb35-2">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"AI Judge Workflow"</span>,</span>
<span id="cb35-3">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"nodes"</span>: [</span>
<span id="cb35-4">    {</span>
<span id="cb35-5">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"parameters"</span>: {</span>
<span id="cb35-6">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"assignments"</span>: {</span>
<span id="cb35-7">          <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"assignments"</span>: [</span>
<span id="cb35-8">            {</span>
<span id="cb35-9">              <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"question-field"</span>,</span>
<span id="cb35-10">              <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"question"</span>,</span>
<span id="cb35-11">              <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"value"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"what is AI?"</span>,</span>
<span id="cb35-12">              <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"string"</span></span>
<span id="cb35-13">            }</span>
<span id="cb35-14">          ]</span>
<span id="cb35-15">        },</span>
<span id="cb35-16">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"options"</span>: {}</span>
<span id="cb35-17">      },</span>
<span id="cb35-18">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"30f77dc6-8e05-4ddb-8902-1638b09abe7b"</span>,</span>
<span id="cb35-19">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Set Question1"</span>,</span>
<span id="cb35-20">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n8n-nodes-base.set"</span>,</span>
<span id="cb35-21">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"typeVersion"</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.4</span>,</span>
<span id="cb35-22">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"position"</span>: [</span>
<span id="cb35-23">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">688</span>,</span>
<span id="cb35-24">        <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span></span>
<span id="cb35-25">      ]</span>
<span id="cb35-26">    },</span>
<span id="cb35-27">    {</span>
<span id="cb35-28">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"parameters"</span>: {</span>
<span id="cb35-29">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"method"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"POST"</span>,</span>
<span id="cb35-30">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"url"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://openrouter.ai/api/v1/chat/completions"</span>,</span>
<span id="cb35-31">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"authentication"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"genericCredentialType"</span>,</span>
<span id="cb35-32">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"genericAuthType"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"httpBearerAuth"</span>,</span>
<span id="cb35-33">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sendHeaders"</span>: true,</span>
<span id="cb35-34">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"headerParameters"</span>: {</span>
<span id="cb35-35">          <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"parameters"</span>: [</span>
<span id="cb35-36">            {</span>
<span id="cb35-37">              <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Content-Type"</span>,</span>
<span id="cb35-38">              <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"value"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"application/json"</span></span>
<span id="cb35-39">            }</span>
<span id="cb35-40">          ]</span>
<span id="cb35-41">        },</span>
<span id="cb35-42">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sendBody"</span>: true,</span>
<span id="cb35-43">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"specifyBody"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"json"</span>,</span>
<span id="cb35-44">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jsonBody"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> JSON.stringify({</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">model</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">: </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">openai/gpt-oss-120b:free</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">,</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">messages</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">: [</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    {</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">role</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">: </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">system</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">, </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">content</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">: </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">If you do not know the answer then reply I am not sure.</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">},</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    {</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">role</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">: </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">user</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">, </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">content</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">: $json.question}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  ]</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">}) </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>,</span>
<span id="cb35-45">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"options"</span>: {}</span>
<span id="cb35-46">      },</span>
<span id="cb35-47">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"104becd7-9b3d-4297-b4ab-47b1df1abd71"</span>,</span>
<span id="cb35-48">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Model A"</span>,</span>
<span id="cb35-49">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n8n-nodes-base.httpRequest"</span>,</span>
<span id="cb35-50">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"typeVersion"</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.2</span>,</span>
<span id="cb35-51">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"position"</span>: [</span>
<span id="cb35-52">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">480</span>,</span>
<span id="cb35-53">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">160</span></span>
<span id="cb35-54">      ],</span>
<span id="cb35-55">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"credentials"</span>: {</span>
<span id="cb35-56">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"httpHeaderAuth"</span>: {</span>
<span id="cb35-57">          <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Lf6835mjFnfNIqw6"</span>,</span>
<span id="cb35-58">          <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Header Auth account 2"</span></span>
<span id="cb35-59">        },</span>
<span id="cb35-60">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"httpBearerAuth"</span>: {</span>
<span id="cb35-61">          <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"KFNalQ91U3mlnQks"</span>,</span>
<span id="cb35-62">          <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Bearer Auth account"</span></span>
<span id="cb35-63">        }</span>
<span id="cb35-64">      }</span>
<span id="cb35-65">    },</span>
<span id="cb35-66">    {</span>
<span id="cb35-67">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"parameters"</span>: {</span>
<span id="cb35-68">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"method"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"POST"</span>,</span>
<span id="cb35-69">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"url"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://openrouter.ai/api/v1/chat/completions"</span>,</span>
<span id="cb35-70">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"authentication"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"genericCredentialType"</span>,</span>
<span id="cb35-71">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"genericAuthType"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"httpBearerAuth"</span>,</span>
<span id="cb35-72">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sendHeaders"</span>: true,</span>
<span id="cb35-73">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"headerParameters"</span>: {</span>
<span id="cb35-74">          <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"parameters"</span>: [</span>
<span id="cb35-75">            {</span>
<span id="cb35-76">              <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Content-Type"</span>,</span>
<span id="cb35-77">              <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"value"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"application/json"</span></span>
<span id="cb35-78">            }</span>
<span id="cb35-79">          ]</span>
<span id="cb35-80">        },</span>
<span id="cb35-81">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sendBody"</span>: true,</span>
<span id="cb35-82">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"specifyBody"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"json"</span>,</span>
<span id="cb35-83">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jsonBody"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> JSON.stringify({</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">model</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">: </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">openai/gpt-oss-20b</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">,</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">messages</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">: [</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    {</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">role</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">: </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">system</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">, </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">content</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">: </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">If you do not know the answer then reply I am not sure.</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">},</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    {</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">role</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">: </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">user</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">, </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">content</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">: $json.question}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  ]</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">}) </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>,</span>
<span id="cb35-84">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"options"</span>: {}</span>
<span id="cb35-85">      },</span>
<span id="cb35-86">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2c4d3906-bcd3-4fc6-b983-4e9e494e476f"</span>,</span>
<span id="cb35-87">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Model B"</span>,</span>
<span id="cb35-88">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n8n-nodes-base.httpRequest"</span>,</span>
<span id="cb35-89">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"typeVersion"</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.2</span>,</span>
<span id="cb35-90">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"position"</span>: [</span>
<span id="cb35-91">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">480</span>,</span>
<span id="cb35-92">        <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span></span>
<span id="cb35-93">      ],</span>
<span id="cb35-94">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"credentials"</span>: {</span>
<span id="cb35-95">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"httpHeaderAuth"</span>: {</span>
<span id="cb35-96">          <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Lf6835mjFnfNIqw6"</span>,</span>
<span id="cb35-97">          <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Header Auth account 2"</span></span>
<span id="cb35-98">        },</span>
<span id="cb35-99">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"httpBearerAuth"</span>: {</span>
<span id="cb35-100">          <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"KFNalQ91U3mlnQks"</span>,</span>
<span id="cb35-101">          <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Bearer Auth account"</span></span>
<span id="cb35-102">        }</span>
<span id="cb35-103">      }</span>
<span id="cb35-104">    },</span>
<span id="cb35-105">    {</span>
<span id="cb35-106">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"parameters"</span>: {</span>
<span id="cb35-107">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"method"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"POST"</span>,</span>
<span id="cb35-108">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"url"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://openrouter.ai/api/v1/chat/completions"</span>,</span>
<span id="cb35-109">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"authentication"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"genericCredentialType"</span>,</span>
<span id="cb35-110">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"genericAuthType"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"httpBearerAuth"</span>,</span>
<span id="cb35-111">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sendHeaders"</span>: true,</span>
<span id="cb35-112">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"headerParameters"</span>: {</span>
<span id="cb35-113">          <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"parameters"</span>: [</span>
<span id="cb35-114">            {</span>
<span id="cb35-115">              <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Content-Type"</span>,</span>
<span id="cb35-116">              <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"value"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"application/json"</span></span>
<span id="cb35-117">            }</span>
<span id="cb35-118">          ]</span>
<span id="cb35-119">        },</span>
<span id="cb35-120">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sendBody"</span>: true,</span>
<span id="cb35-121">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"specifyBody"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"json"</span>,</span>
<span id="cb35-122">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jsonBody"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> JSON.stringify({</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">model</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">: </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">arcee-ai/trinity-large-preview:free</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">,</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">messages</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">: [</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    {</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">role</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">: </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">system</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">, </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">content</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">: </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">If you do not know the answer then reply I am not sure.</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">},</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    {</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">role</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">: </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">user</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">, </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">content</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">: $json.question}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  ]</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">}) </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>,</span>
<span id="cb35-123">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"options"</span>: {}</span>
<span id="cb35-124">      },</span>
<span id="cb35-125">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"3f5e4a8b-c9d2-4ab7-a123-456789012345"</span>,</span>
<span id="cb35-126">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Model C"</span>,</span>
<span id="cb35-127">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n8n-nodes-base.httpRequest"</span>,</span>
<span id="cb35-128">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"typeVersion"</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.2</span>,</span>
<span id="cb35-129">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"position"</span>: [</span>
<span id="cb35-130">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">480</span>,</span>
<span id="cb35-131">        <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">192</span></span>
<span id="cb35-132">      ],</span>
<span id="cb35-133">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"credentials"</span>: {</span>
<span id="cb35-134">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"httpHeaderAuth"</span>: {</span>
<span id="cb35-135">          <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Lf6835mjFnfNIqw6"</span>,</span>
<span id="cb35-136">          <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Header Auth account 2"</span></span>
<span id="cb35-137">        },</span>
<span id="cb35-138">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"httpBearerAuth"</span>: {</span>
<span id="cb35-139">          <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"KFNalQ91U3mlnQks"</span>,</span>
<span id="cb35-140">          <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Bearer Auth account"</span></span>
<span id="cb35-141">        }</span>
<span id="cb35-142">      }</span>
<span id="cb35-143">    },</span>
<span id="cb35-144">    {</span>
<span id="cb35-145">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"parameters"</span>: {</span>
<span id="cb35-146">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"assignments"</span>: {</span>
<span id="cb35-147">          <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"assignments"</span>: [</span>
<span id="cb35-148">            {</span>
<span id="cb35-149">              <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"map-a"</span>,</span>
<span id="cb35-150">              <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"answer_a"</span>,</span>
<span id="cb35-151">              <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"value"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> $json.choices[0].message.content </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>,</span>
<span id="cb35-152">              <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"string"</span></span>
<span id="cb35-153">            }</span>
<span id="cb35-154">          ]</span>
<span id="cb35-155">        },</span>
<span id="cb35-156">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"options"</span>: {}</span>
<span id="cb35-157">      },</span>
<span id="cb35-158">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bb423cd5-28ff-47e5-8925-492143d26228"</span>,</span>
<span id="cb35-159">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Set Answer A1"</span>,</span>
<span id="cb35-160">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n8n-nodes-base.set"</span>,</span>
<span id="cb35-161">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"typeVersion"</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.4</span>,</span>
<span id="cb35-162">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"position"</span>: [</span>
<span id="cb35-163">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span>,</span>
<span id="cb35-164">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">160</span></span>
<span id="cb35-165">      ]</span>
<span id="cb35-166">    },</span>
<span id="cb35-167">    {</span>
<span id="cb35-168">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"parameters"</span>: {</span>
<span id="cb35-169">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"assignments"</span>: {</span>
<span id="cb35-170">          <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"assignments"</span>: [</span>
<span id="cb35-171">            {</span>
<span id="cb35-172">              <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"map-b"</span>,</span>
<span id="cb35-173">              <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"answer_b"</span>,</span>
<span id="cb35-174">              <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"value"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> $json.choices[0].message.content </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>,</span>
<span id="cb35-175">              <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"string"</span></span>
<span id="cb35-176">            }</span>
<span id="cb35-177">          ]</span>
<span id="cb35-178">        },</span>
<span id="cb35-179">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"options"</span>: {}</span>
<span id="cb35-180">      },</span>
<span id="cb35-181">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"591d8be5-132d-45a2-a69d-455467da46e5"</span>,</span>
<span id="cb35-182">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Set Answer B1"</span>,</span>
<span id="cb35-183">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n8n-nodes-base.set"</span>,</span>
<span id="cb35-184">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"typeVersion"</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.4</span>,</span>
<span id="cb35-185">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"position"</span>: [</span>
<span id="cb35-186">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span>,</span>
<span id="cb35-187">        <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span></span>
<span id="cb35-188">      ]</span>
<span id="cb35-189">    },</span>
<span id="cb35-190">    {</span>
<span id="cb35-191">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"parameters"</span>: {</span>
<span id="cb35-192">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"assignments"</span>: {</span>
<span id="cb35-193">          <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"assignments"</span>: [</span>
<span id="cb35-194">            {</span>
<span id="cb35-195">              <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"map-c"</span>,</span>
<span id="cb35-196">              <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"answer_c"</span>,</span>
<span id="cb35-197">              <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"value"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> $json.choices[0].message.content </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>,</span>
<span id="cb35-198">              <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"string"</span></span>
<span id="cb35-199">            }</span>
<span id="cb35-200">          ]</span>
<span id="cb35-201">        },</span>
<span id="cb35-202">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"options"</span>: {}</span>
<span id="cb35-203">      },</span>
<span id="cb35-204">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"7a8b9c0d-1e2f-4a3b-8c4d-5e6f7a8b9c0d"</span>,</span>
<span id="cb35-205">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Set Answer C1"</span>,</span>
<span id="cb35-206">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n8n-nodes-base.set"</span>,</span>
<span id="cb35-207">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"typeVersion"</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.4</span>,</span>
<span id="cb35-208">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"position"</span>: [</span>
<span id="cb35-209">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span>,</span>
<span id="cb35-210">        <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">192</span></span>
<span id="cb35-211">      ]</span>
<span id="cb35-212">    },</span>
<span id="cb35-213">    {</span>
<span id="cb35-214">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"parameters"</span>: {</span>
<span id="cb35-215">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mode"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"combine"</span>,</span>
<span id="cb35-216">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"combineBy"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"combineAll"</span>,</span>
<span id="cb35-217">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"options"</span>: {}</span>
<span id="cb35-218">      },</span>
<span id="cb35-219">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"merge-ab-node-id"</span>,</span>
<span id="cb35-220">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Merge AB"</span>,</span>
<span id="cb35-221">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n8n-nodes-base.merge"</span>,</span>
<span id="cb35-222">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"typeVersion"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,</span>
<span id="cb35-223">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"position"</span>: [</span>
<span id="cb35-224">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>,</span>
<span id="cb35-225">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">72</span></span>
<span id="cb35-226">      ]</span>
<span id="cb35-227">    },</span>
<span id="cb35-228">    {</span>
<span id="cb35-229">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"parameters"</span>: {</span>
<span id="cb35-230">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mode"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"combine"</span>,</span>
<span id="cb35-231">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"combineBy"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"combineAll"</span>,</span>
<span id="cb35-232">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"options"</span>: {}</span>
<span id="cb35-233">      },</span>
<span id="cb35-234">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2c89b328-cac3-4322-bcf6-b8ae5f9c0af2"</span>,</span>
<span id="cb35-235">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Merge Answers1"</span>,</span>
<span id="cb35-236">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n8n-nodes-base.merge"</span>,</span>
<span id="cb35-237">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"typeVersion"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,</span>
<span id="cb35-238">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"position"</span>: [</span>
<span id="cb35-239">        <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">160</span>,</span>
<span id="cb35-240">        <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span></span>
<span id="cb35-241">      ]</span>
<span id="cb35-242">    },</span>
<span id="cb35-243">    {</span>
<span id="cb35-244">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"parameters"</span>: {</span>
<span id="cb35-245">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"method"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"POST"</span>,</span>
<span id="cb35-246">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"url"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://openrouter.ai/api/v1/chat/completions"</span>,</span>
<span id="cb35-247">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"authentication"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"genericCredentialType"</span>,</span>
<span id="cb35-248">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"genericAuthType"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"httpBearerAuth"</span>,</span>
<span id="cb35-249">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sendHeaders"</span>: true,</span>
<span id="cb35-250">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"headerParameters"</span>: {</span>
<span id="cb35-251">          <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"parameters"</span>: [</span>
<span id="cb35-252">            {</span>
<span id="cb35-253">              <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Content-Type"</span>,</span>
<span id="cb35-254">              <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"value"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"application/json"</span></span>
<span id="cb35-255">            }</span>
<span id="cb35-256">          ]</span>
<span id="cb35-257">        },</span>
<span id="cb35-258">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sendBody"</span>: true,</span>
<span id="cb35-259">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"specifyBody"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"json"</span>,</span>
<span id="cb35-260">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jsonBody"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> JSON.stringify({</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">model</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">: </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">google/gemini-3-flash-preview</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">,</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">messages</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">: [</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    {</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">      </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">role</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">: </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">user</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">,</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">      </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">content</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">: </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">You are an AI Judge. You will be presented with a question and three candidate answers (Model A, Model B, and Model C).</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">nYour task is to judge the quality of the answers.</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">n</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">nQuestion: </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> + $(</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Set Question1</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">).first().json.question + </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">n</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">nAnswer A:</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">n</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> + ($json.answer_a || </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">No answer provided</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">) + </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">n</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">nAnswer B:</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">n</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> + ($json.answer_b || </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">No answer provided</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">) + </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">n</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">nAnswer C:</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">n</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> + ($json.answer_c || </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">No answer provided</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">) + </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">n</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">nTask:</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">n1. Compare the three answers for accuracy, clarity, and completeness.</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">n2. format and length of the answers are not important, focus on content quality.</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">n3. Provide a short commentary.</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">n4. Assign a score from 0 to 100 for Model A, Model B, and Model C.</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">n5. Declare the overall winner.</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">n</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">nOutput Format:</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">nCommentary: &lt;text&gt;</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">nWinner: &lt;Model A or Model B or Model C&gt;</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">nScore A: &lt;number&gt;</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">nScore B: &lt;number&gt;</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">nScore C: &lt;number&gt;</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    }</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  ]</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">}) </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>,</span>
<span id="cb35-261">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"options"</span>: {}</span>
<span id="cb35-262">      },</span>
<span id="cb35-263">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1d6171c9-4800-4f25-97a0-c029053e1ddc"</span>,</span>
<span id="cb35-264">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"AI Judge1"</span>,</span>
<span id="cb35-265">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n8n-nodes-base.httpRequest"</span>,</span>
<span id="cb35-266">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"typeVersion"</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.2</span>,</span>
<span id="cb35-267">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"position"</span>: [</span>
<span id="cb35-268">        <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">368</span>,</span>
<span id="cb35-269">        <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span></span>
<span id="cb35-270">      ],</span>
<span id="cb35-271">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"credentials"</span>: {</span>
<span id="cb35-272">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"httpHeaderAuth"</span>: {</span>
<span id="cb35-273">          <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Lf6835mjFnfNIqw6"</span>,</span>
<span id="cb35-274">          <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Header Auth account 2"</span></span>
<span id="cb35-275">        },</span>
<span id="cb35-276">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"httpBearerAuth"</span>: {</span>
<span id="cb35-277">          <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"KFNalQ91U3mlnQks"</span>,</span>
<span id="cb35-278">          <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Bearer Auth account"</span></span>
<span id="cb35-279">        }</span>
<span id="cb35-280">      }</span>
<span id="cb35-281">    },</span>
<span id="cb35-282">    {</span>
<span id="cb35-283">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"parameters"</span>: {</span>
<span id="cb35-284">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"assignments"</span>: {</span>
<span id="cb35-285">          <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"assignments"</span>: [</span>
<span id="cb35-286">            {</span>
<span id="cb35-287">              <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"final-result"</span>,</span>
<span id="cb35-288">              <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"verdict"</span>,</span>
<span id="cb35-289">              <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"value"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> $json.choices[0].message.content </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>,</span>
<span id="cb35-290">              <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"string"</span></span>
<span id="cb35-291">            },</span>
<span id="cb35-292">            {</span>
<span id="cb35-293">              <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"model-a-ans"</span>,</span>
<span id="cb35-294">              <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"answer_a"</span>,</span>
<span id="cb35-295">              <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"value"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> $node[</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Merge Answers1</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">].json.answer_a </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>,</span>
<span id="cb35-296">              <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"string"</span></span>
<span id="cb35-297">            },</span>
<span id="cb35-298">            {</span>
<span id="cb35-299">              <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"model-b-ans"</span>,</span>
<span id="cb35-300">              <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"answer_b"</span>,</span>
<span id="cb35-301">              <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"value"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> $node[</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Merge Answers1</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">].json.answer_b </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>,</span>
<span id="cb35-302">              <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"string"</span></span>
<span id="cb35-303">            },</span>
<span id="cb35-304">            {</span>
<span id="cb35-305">              <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"model-c-ans"</span>,</span>
<span id="cb35-306">              <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"answer_c"</span>,</span>
<span id="cb35-307">              <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"value"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> $node[</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Merge Answers1</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">].json.answer_c </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>,</span>
<span id="cb35-308">              <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"string"</span></span>
<span id="cb35-309">            }</span>
<span id="cb35-310">          ]</span>
<span id="cb35-311">        },</span>
<span id="cb35-312">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"options"</span>: {}</span>
<span id="cb35-313">      },</span>
<span id="cb35-314">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"eae7f7bf-07fc-4250-b628-1a422cfbbe12"</span>,</span>
<span id="cb35-315">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Final Output1"</span>,</span>
<span id="cb35-316">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n8n-nodes-base.set"</span>,</span>
<span id="cb35-317">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"typeVersion"</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.4</span>,</span>
<span id="cb35-318">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"position"</span>: [</span>
<span id="cb35-319">        <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">576</span>,</span>
<span id="cb35-320">        <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span></span>
<span id="cb35-321">      ]</span>
<span id="cb35-322">    }</span>
<span id="cb35-323">  ],</span>
<span id="cb35-324">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pinData"</span>: {},</span>
<span id="cb35-325">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"connections"</span>: {</span>
<span id="cb35-326">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Set Question1"</span>: {</span>
<span id="cb35-327">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"main"</span>: [</span>
<span id="cb35-328">        [</span>
<span id="cb35-329">          {</span>
<span id="cb35-330">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"node"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Model A"</span>,</span>
<span id="cb35-331">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"main"</span>,</span>
<span id="cb35-332">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"index"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb35-333">          },</span>
<span id="cb35-334">          {</span>
<span id="cb35-335">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"node"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Model B"</span>,</span>
<span id="cb35-336">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"main"</span>,</span>
<span id="cb35-337">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"index"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb35-338">          },</span>
<span id="cb35-339">          {</span>
<span id="cb35-340">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"node"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Model C"</span>,</span>
<span id="cb35-341">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"main"</span>,</span>
<span id="cb35-342">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"index"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb35-343">          }</span>
<span id="cb35-344">        ]</span>
<span id="cb35-345">      ]</span>
<span id="cb35-346">    },</span>
<span id="cb35-347">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Model A"</span>: {</span>
<span id="cb35-348">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"main"</span>: [</span>
<span id="cb35-349">        [</span>
<span id="cb35-350">          {</span>
<span id="cb35-351">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"node"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Set Answer A1"</span>,</span>
<span id="cb35-352">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"main"</span>,</span>
<span id="cb35-353">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"index"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb35-354">          }</span>
<span id="cb35-355">        ]</span>
<span id="cb35-356">      ]</span>
<span id="cb35-357">    },</span>
<span id="cb35-358">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Model B"</span>: {</span>
<span id="cb35-359">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"main"</span>: [</span>
<span id="cb35-360">        [</span>
<span id="cb35-361">          {</span>
<span id="cb35-362">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"node"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Set Answer B1"</span>,</span>
<span id="cb35-363">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"main"</span>,</span>
<span id="cb35-364">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"index"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb35-365">          }</span>
<span id="cb35-366">        ]</span>
<span id="cb35-367">      ]</span>
<span id="cb35-368">    },</span>
<span id="cb35-369">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Model C"</span>: {</span>
<span id="cb35-370">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"main"</span>: [</span>
<span id="cb35-371">        [</span>
<span id="cb35-372">          {</span>
<span id="cb35-373">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"node"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Set Answer C1"</span>,</span>
<span id="cb35-374">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"main"</span>,</span>
<span id="cb35-375">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"index"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb35-376">          }</span>
<span id="cb35-377">        ]</span>
<span id="cb35-378">      ]</span>
<span id="cb35-379">    },</span>
<span id="cb35-380">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Set Answer A1"</span>: {</span>
<span id="cb35-381">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"main"</span>: [</span>
<span id="cb35-382">        [</span>
<span id="cb35-383">          {</span>
<span id="cb35-384">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"node"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Merge AB"</span>,</span>
<span id="cb35-385">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"main"</span>,</span>
<span id="cb35-386">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"index"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb35-387">          }</span>
<span id="cb35-388">        ]</span>
<span id="cb35-389">      ]</span>
<span id="cb35-390">    },</span>
<span id="cb35-391">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Set Answer B1"</span>: {</span>
<span id="cb35-392">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"main"</span>: [</span>
<span id="cb35-393">        [</span>
<span id="cb35-394">          {</span>
<span id="cb35-395">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"node"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Merge AB"</span>,</span>
<span id="cb35-396">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"main"</span>,</span>
<span id="cb35-397">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"index"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb35-398">          }</span>
<span id="cb35-399">        ]</span>
<span id="cb35-400">      ]</span>
<span id="cb35-401">    },</span>
<span id="cb35-402">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Set Answer C1"</span>: {</span>
<span id="cb35-403">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"main"</span>: [</span>
<span id="cb35-404">        [</span>
<span id="cb35-405">          {</span>
<span id="cb35-406">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"node"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Merge Answers1"</span>,</span>
<span id="cb35-407">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"main"</span>,</span>
<span id="cb35-408">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"index"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb35-409">          }</span>
<span id="cb35-410">        ]</span>
<span id="cb35-411">      ]</span>
<span id="cb35-412">    },</span>
<span id="cb35-413">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Merge AB"</span>: {</span>
<span id="cb35-414">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"main"</span>: [</span>
<span id="cb35-415">        [</span>
<span id="cb35-416">          {</span>
<span id="cb35-417">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"node"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Merge Answers1"</span>,</span>
<span id="cb35-418">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"main"</span>,</span>
<span id="cb35-419">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"index"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb35-420">          }</span>
<span id="cb35-421">        ]</span>
<span id="cb35-422">      ]</span>
<span id="cb35-423">    },</span>
<span id="cb35-424">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Merge Answers1"</span>: {</span>
<span id="cb35-425">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"main"</span>: [</span>
<span id="cb35-426">        [</span>
<span id="cb35-427">          {</span>
<span id="cb35-428">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"node"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"AI Judge1"</span>,</span>
<span id="cb35-429">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"main"</span>,</span>
<span id="cb35-430">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"index"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb35-431">          }</span>
<span id="cb35-432">        ]</span>
<span id="cb35-433">      ]</span>
<span id="cb35-434">    },</span>
<span id="cb35-435">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"AI Judge1"</span>: {</span>
<span id="cb35-436">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"main"</span>: [</span>
<span id="cb35-437">        [</span>
<span id="cb35-438">          {</span>
<span id="cb35-439">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"node"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Final Output1"</span>,</span>
<span id="cb35-440">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"main"</span>,</span>
<span id="cb35-441">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"index"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb35-442">          }</span>
<span id="cb35-443">        ]</span>
<span id="cb35-444">      ]</span>
<span id="cb35-445">    }</span>
<span id="cb35-446">  },</span>
<span id="cb35-447">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"active"</span>: false,</span>
<span id="cb35-448">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"settings"</span>: {</span>
<span id="cb35-449">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"executionOrder"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"v1"</span>,</span>
<span id="cb35-450">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"availableInMCP"</span>: false</span>
<span id="cb35-451">  },</span>
<span id="cb35-452">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"versionId"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ac74f20b-72a9-49a6-8200-fd08707946ec"</span>,</span>
<span id="cb35-453">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"meta"</span>: {</span>
<span id="cb35-454">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"instanceId"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2f42f1cdfcab2c6a7bbd5cec68912930ccc0107686e3a7211ddcc09504c524d9"</span></span>
<span id="cb35-455">  },</span>
<span id="cb35-456">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"8a_wyeYhdVZSr42SS5Z1K"</span>,</span>
<span id="cb35-457">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tags"</span>: []</span>
<span id="cb35-458">}</span></code></pre></div></div>
</details>
</div>
</section>
</div>
</div>
</div>


<!-- -->


 ]]></description>
  <category>AI</category>
  <guid>https://jcwinning.github.io/LandingPage/posts/AI judge/</guid>
  <pubDate>Thu, 29 Jan 2026 16:00:00 GMT</pubDate>
  <media:content url="https://jcwinning.github.io/LandingPage/posts/AI judge/images/images.jpeg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>Voice Studio: 文字&lt;-&gt;语音转换</title>
  <dc:creator>Tony D</dc:creator>
  <link>https://jcwinning.github.io/LandingPage/posts/ARS/</link>
  <description><![CDATA[ 





<p>一个强大且美观的 Streamlit 应用，集成了 <strong>自动语音识别 (ASR)</strong> 和 <strong>文本转语音 (TTS)</strong> 功能。本项目旨在提供一个便捷的平台，用于对比 NVIDIA、Google 的前沿云端模型与本地 MLX 优化模型的表现。</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" aria-controls="tabset-1-1" aria-selected="true" href="">语音转文字 (STT) 界面</a></li><li class="nav-item"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" aria-controls="tabset-1-2" aria-selected="false" href="">文字转语音 (TTS) 界面</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" aria-labelledby="tabset-1-1-tab">
<p><img src="https://jcwinning.github.io/LandingPage/posts/ARS/images/my screenshots 3.png" class="img-fluid"></p>
</div>
<div id="tabset-1-2" class="tab-pane" aria-labelledby="tabset-1-2-tab">
<p><img src="https://jcwinning.github.io/LandingPage/posts/ARS/images/my screenshots 2.png" class="img-fluid"></p>
</div>
</div>
</div>
<section id="在线演示" class="level2">
<h2 class="anchored" data-anchor-id="在线演示">在线演示</h2>
<p><a href="https://jcwinning-speech-text-model.share.connect.posit.cloud/">https://jcwinning-speech-text-model.share.connect.posit.cloud/</a></p>
</section>
<section id="核心功能" class="level2">
<h2 class="anchored" data-anchor-id="核心功能">✨ 核心功能</h2>
<section id="语音转文字-stt" class="level3">
<h3 class="anchored" data-anchor-id="语音转文字-stt">🎤 语音转文字 (STT)</h3>
<ul>
<li><strong>Google Gemini 2.5 Flash Lite</strong>: 通过 OpenRouter 提供的高速、精准云端转写。</li>
<li><strong>NVIDIA Parakeet-CTC</strong>: 行业领先的 ASR 性能，基于 NVIDIA Riva Cloud。</li>
<li><strong>本地 MLX 模型</strong>: 专为 Apple Silicon 优化的本地私密转写。
<ul>
<li><strong>GLM-ASR-Nano</strong>: 轻量、高效。</li>
<li><strong>Whisper-Large-v3-Turbo</strong>: 行业顶尖、高精度的转写模型。</li>
</ul></li>
<li><strong>双输入模式</strong>: 支持实时麦克风录音或上传音频文件（WAV, MP3, M4A）。</li>
<li><strong>即时显示</strong>: 结果在每个模型完成时立即显示，无需等待所有模型。</li>
<li><strong>自动归一化</strong>: 自动将音频转换为 16kHz 单声道 WAV，确保最高识别准确度。</li>
<li><strong>结果下载</strong>: 支持将每个模型的转写结果保存为本地 <code>.md</code> 文件。</li>
</ul>
</section>
<section id="文本转语音-tts" class="level3">
<h3 class="anchored" data-anchor-id="文本转语音-tts">🔊 文本转语音 (TTS)</h3>
<ul>
<li><strong>Qwen TTS (DashScope)</strong>: 阿里通义千问提供的自然语音合成，内置 7 种性格各异的声音。</li>
<li><strong>NVIDIA Riva (Magpie)</strong>: 专业级多语言合成，采用最新的 Magpie-Multilingual 模型。</li>
<li><strong>动态声音选择</strong>: 提供丰富的中文（普通话）和英文发音人选项。</li>
</ul>
</section>
</section>
<section id="快速上手" class="level2">
<h2 class="anchored" data-anchor-id="快速上手">🚀 快速上手</h2>
<section id="环境要求" class="level3">
<h3 class="anchored" data-anchor-id="环境要求">环境要求</h3>
<ul>
<li>Python 3.10+</li>
<li>Apple Silicon (若需使用本地 MLX 功能)</li>
<li>API 密钥:
<ul>
<li><a href="https://openrouter.ai/">OpenRouter</a></li>
<li><a href="https://build.nvidia.com/">NVIDIA NIM</a></li>
<li><a href="https://dashscope.console.aliyun.com/">阿里云 DashScope</a></li>
</ul></li>
</ul>
</section>
<section id="安装步骤" class="level3">
<h3 class="anchored" data-anchor-id="安装步骤">安装步骤</h3>
<ol type="1">
<li><p>克隆仓库:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">git</span> clone <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>repository-url<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb1-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">cd</span> ARS</span></code></pre></div></div></li>
<li><p>安装依赖:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pip</span> install <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-r</span> requirements.txt</span></code></pre></div></div></li>
<li><p>在项目根目录创建 <code>.env</code> 文件并填入密钥:</p>
<pre class="env"><code>OPENROUTER_API_KEY=你的密钥
DASHSCOPE_API_KEY=你的密钥
NVIDIA_API_KEY=你的密钥</code></pre></li>
</ol>
</section>
<section id="运行应用" class="level3">
<h3 class="anchored" data-anchor-id="运行应用">运行应用</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">streamlit</span> run app.py</span></code></pre></div></div>
</section>
</section>
<section id="云端部署" class="level2">
<h2 class="anchored" data-anchor-id="云端部署">☁️ 云端部署</h2>
<p>本项目已针对 <strong>Streamlit Cloud</strong> 进行预配置： - 自动检测运行环境，在云端部署时禁用本地模型 (MLX) 以确保系统稳定。 - API 密钥可以通过 Streamlit 的 “Secrets” 面板进行安全管理。</p>
</section>
<section id="技术栈" class="level2">
<h2 class="anchored" data-anchor-id="技术栈">🛠️ 技术栈</h2>
<ul>
<li><strong>界面</strong>: Streamlit</li>
<li><strong>本地推理</strong>: MLX (针对 Mac M 芯片优化)</li>
<li><strong>云端服务</strong>: NVIDIA Riva, OpenRouter (Gemini), 阿里云 DashScope (Qwen)</li>
<li><strong>音频处理</strong>: Wave, SoundFile, Streamlit Mic Recorder</li>
</ul>
<hr>


<!-- -->

</section>

 ]]></description>
  <category>AI</category>
  <category>Audio</category>
  <category>ASR</category>
  <category>TTS</category>
  <category>Streamlit</category>
  <category>MLX</category>
  <guid>https://jcwinning.github.io/LandingPage/posts/ARS/</guid>
  <pubDate>Wed, 21 Jan 2026 16:00:00 GMT</pubDate>
  <media:content url="https://jcwinning.github.io/LandingPage/posts/ARS/images/featured.png" medium="image" type="image/png" height="144" width="144"/>
</item>
<item>
  <title>LLM 摘要系统：多平台 AI 摘要工具</title>
  <dc:creator>Tony D</dc:creator>
  <link>https://jcwinning.github.io/LandingPage/posts/llm-summary/</link>
  <description><![CDATA[ 





<section id="简介" class="level1">
<h1>简介</h1>
<p>在信息爆炸的时代，紧跟 YouTube、Bilibili、Spotify 和小红书等多个平台的内容可能会让人感到力不从心。<strong>LLM Summary System</strong> 是一个强大的统一工具，旨在通过自动下载、转写并使用最先进的大型语言模型 (LLM) 总结内容来解决这一问题。</p>
<p>该项目提供了一种无缝体验，能够将长篇音视频内容转换为简洁、具有启发性的摘要。</p>
<p><img src="https://jcwinning.github.io/LandingPage/posts/llm-summary/image/1.png" class="img-fluid"></p>
</section>
<section id="主要特性" class="level1">
<h1>主要特性</h1>
<p>该系统具备多种功能，是内容消费的强大选择：</p>
<ul>
<li><strong>多平台支持</strong>：为 YouTube、Bilibili、Spotify、小红书和小宇宙 FM 提供统一接口。</li>
<li><strong>智能处理</strong>：针对大文件和转录文本自动分块，以处理长篇内容（最高支持 200 万 Token）。</li>
<li><strong>高质量转写</strong>：使用 MLX Whisper（针对 Apple Silicon 优化），并具备 OpenAI Whisper 备选方案。</li>
<li><strong>高级摘要</strong>：支持 15 种以上 LLM 模型（包括通义千问 Qwen、GLM、DeepSeek、GPT-4、Gemini 和 Grok）。</li>
<li><strong>文本转语音 (TTS)</strong>：使用 Google Cloud TTS、Qwen 或 Gemini 将摘要重新转换为音频。</li>
<li><strong>搜索集成</strong>：利用 AI 提取的关键调，自动查找相关的阅读材料。</li>
<li><strong>实时进度跟踪</strong>：用户友好的 Streamlit Web 界面，提供实时更新。</li>
</ul>
</section>
<section id="架构概览" class="level1">
<h1>架构概览</h1>
<p>系统遵循一个流线型的工作流：</p>
<pre class="mermaid"><code>graph LR
    A[URL 输入] --&gt; B[平台检测]
    B --&gt; C[内容下载]
    C --&gt; D[音频提取]
    D --&gt; E[转写 - Whisper]
    E --&gt; F[AI 摘要生成]
    F --&gt; G[TTS 合成]
    G --&gt; H[文件输出 + Web 展示]</code></pre>
<section id="核心组件" class="level3">
<h3 class="anchored" data-anchor-id="核心组件">核心组件</h3>
<ul>
<li><strong><code>app.py</code></strong>：主要的 Streamlit Web 界面，处理并发 URL 提交和动态排队。</li>
<li><strong><code>download.py</code></strong>：统一的下载器，为所有支持的平台提供了全面的重试逻辑。</li>
<li><strong><code>process.py</code></strong>：通过智能分块处理音频转写和 AI 摘要。</li>
<li><strong><code>config.py</code></strong>：管理 LLM 模型配置和环境变量。</li>
<li><strong><code>tts.py</code></strong>：多供应商文本转语音支持，具备基于哈希的缓存机制。</li>
</ul>
</section>
</section>
<section id="高级智能" class="level1">
<h1>高级智能</h1>
<p>该系统在处理复杂任务时的表现使其脱颖而出：</p>
<section id="智能分块" class="level3">
<h3 class="anchored" data-anchor-id="智能分块">智能分块</h3>
<p>为了防止内存溢出并处理超长内容： - <strong>音频</strong>：自动分割超过 60 分钟的文件进行转写。 - <strong>文本</strong>：超过 24 万字符的转录文本将被分割成每份 10 万字符的块。</p>
</section>
<section id="搜索集成" class="level3">
<h3 class="anchored" data-anchor-id="搜索集成">搜索集成</h3>
<p>在生成摘要后，系统会提取关键词，并通过 DuckDuckGo（或百度作为备选）搜索补充材料。这确保了您对该主题有更全面的理解。</p>
</section>
</section>
<section id="快速上手" class="level1">
<h1>快速上手</h1>
<p>运行该系统的最简单方法是通过 Web 界面：</p>
<ol type="1">
<li><p><strong>克隆仓库</strong>：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">git</span> clone https://github.com/JCwinning/llm_summary.git</span>
<span id="cb2-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">cd</span> llm_summary</span></code></pre></div></div></li>
<li><p><strong>配置环境</strong>：创建一个 <code>.env</code> 文件并填入您的 API 密钥（OpenAI、DashScope 等）。</p></li>
<li><p><strong>安装依赖</strong>：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pip</span> install <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-r</span> requirements.txt</span></code></pre></div></div></li>
<li><p><strong>运行应用</strong>：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">streamlit</span> run app.py</span></code></pre></div></div></li>
</ol>
</section>
<section id="结论" class="level1">
<h1>结论</h1>
<p>LLM Summary System 不仅仅是一个下载器；它还是您的私人 AI 研究助手。无论您是学生、研究人员，还是只是想保持获取咨询，该工具都能通过将数小时的内容浓缩为分钟级的阅读，显著提高您的生产力。</p>
<p>在 <a href="https://github.com/JCwinning/llm_summary">GitHub</a> 上查看完整源代码并参与贡献。</p>


<!-- -->

</section>

 ]]></description>
  <category>AI</category>
  <category>Python</category>
  <category>LLM</category>
  <category>Open Source</category>
  <guid>https://jcwinning.github.io/LandingPage/posts/llm-summary/</guid>
  <pubDate>Wed, 07 Jan 2026 16:00:00 GMT</pubDate>
  <media:content url="https://jcwinning.github.io/LandingPage/posts/llm-summary/image/cover.png" medium="image" type="image/png" height="98" width="144"/>
</item>
<item>
  <title>AI 聊天：多语言多模型应用 (AI Chat)</title>
  <dc:creator>Tony D</dc:creator>
  <link>https://jcwinning.github.io/LandingPage/posts/AI-Chat/</link>
  <description><![CDATA[ 





<section id="简介" class="level1">
<h1>简介</h1>
<p>在人工智能飞速发展的今天，拥有一个能够与多个模型交互的统一界面是极具价值的。<a href="https://github.com/JCwinning/AI_Chat">AI Chat</a> 是一个使用 Streamlit 构建的多语言、多模型 AI 聊天应用。它支持流式响应、图像输入、并发模型查询、网络搜索以及全面的文件处理功能。</p>
<p>无论您是要对比不同大语言模型 (LLM) 的回答，还是生成精美的视觉效果，AI Chat 都能提供无缝且强大的体验。</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" aria-controls="tabset-1-1" aria-selected="true" href="">文本回答</a></li><li class="nav-item"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" aria-controls="tabset-1-2" aria-selected="false" href="">图像创作</a></li><li class="nav-item"><a class="nav-link" id="tabset-1-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-3" aria-controls="tabset-1-3" aria-selected="false" href="">上传文档摘要</a></li><li class="nav-item"><a class="nav-link" id="tabset-1-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-4" aria-controls="tabset-1-4" aria-selected="false" href="">预定义提示词</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" aria-labelledby="tabset-1-1-tab">
<p><img src="https://jcwinning.github.io/LandingPage/posts/AI-Chat/images/1.png" class="img-fluid"></p>
</div>
<div id="tabset-1-2" class="tab-pane" aria-labelledby="tabset-1-2-tab">
<p><img src="https://jcwinning.github.io/LandingPage/posts/AI-Chat/images/2.png" class="img-fluid"></p>
</div>
<div id="tabset-1-3" class="tab-pane" aria-labelledby="tabset-1-3-tab">
<p><img src="https://jcwinning.github.io/LandingPage/posts/AI-Chat/images/4.png" class="img-fluid"></p>
<p>AI 摘要论文：DeepSeek-R1: Incentivizing Reasoning Capability in LLMs via Reinforcement Learning (https://arxiv.org/pdf/2501.12948)</p>
</div>
<div id="tabset-1-4" class="tab-pane" aria-labelledby="tabset-1-4-tab">
<p><img src="https://jcwinning.github.io/LandingPage/posts/AI-Chat/images/3.png" class="img-fluid"></p>
</div>
</div>
</div>
</section>
<section id="核心特性" class="level1">
<h1>✨ 核心特性</h1>
<ul>
<li><strong>🌐 多语言支持</strong>：可在中英文界面之间即时切换。</li>
<li><strong>🤖 多模型聊天</strong>：同时向多个 AI 模型发起查询，并提供并排对比视图。</li>
<li><strong>🎨 图像生成与编辑</strong>：使用 FLUX、通义万相 (Qwen Image) 和 Gemini 等模型创建和编辑图像。</li>
<li><strong>📚 提示词库 (Prompt Bay)</strong>：内置 100+ 可搜索的系统提示词，用于专业化交互。</li>
<li><strong>🔍 Web 搜索</strong>：集成 Tavily AI 搜索，实现实时信息检索。</li>
<li><strong>🖼️ 全面的文件支持</strong>：支持上传并处理 PDF、Word 文档、Excel、CSV 和图像。</li>
<li><strong>⚡ 流式响应</strong>：实时获取多个模型的并发反馈。</li>
</ul>
</section>
<section id="快速开始" class="level1">
<h1>🚀 快速开始</h1>
<p>若要在本地运行 AI Chat，请按照以下步骤操作：</p>
<section id="前提条件" class="level3">
<h3 class="anchored" data-anchor-id="前提条件">前提条件</h3>
<ul>
<li>Python 3.7 或更高版本</li>
<li>pip 包管理器</li>
</ul>
</section>
<section id="安装步骤" class="level3">
<h3 class="anchored" data-anchor-id="安装步骤">安装步骤</h3>
<ol type="1">
<li><p><strong>克隆仓库</strong>:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">git</span> clone https://github.com/JCwinning/AI_Chat.git</span>
<span id="cb1-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">cd</span> AI_Chat</span></code></pre></div></div></li>
<li><p><strong>安装依赖</strong>:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pip</span> install <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-r</span> requirements.txt</span></code></pre></div></div></li>
<li><p><strong>配置 API 密钥</strong>: 在项目根目录创建 <code>.env</code> 文件并添加您的密钥：</p>
<pre class="env"><code>modelscope=您的-modelscope-api-key
openrouter=您的-openrouter-api-key
dashscope=您的-dashscope-api-key
bigmodel=您的-bigmodel-api-key
tavily_api_key=您的-tavily-api-key</code></pre></li>
<li><p><strong>运行应用</strong>:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">streamlit</span> run app.py</span></code></pre></div></div></li>
</ol>
</section>
</section>
<section id="架构与组件" class="level1">
<h1>🏗️ 架构与组件</h1>
<p>该项目旨在实现模块化和高性能：</p>
<ul>
<li><strong><code>app.py</code></strong>：主要入口点，使用 Streamlit 处理 UI 和会话管理。</li>
<li><strong><code>config.py</code></strong>：集中式的模型定义和供应商设置。</li>
<li><strong><code>search_providers.py</code></strong>：处理带有缓存功能的 Web 搜索集成。</li>
<li><strong>多线程</strong>：使用 Python 的 <code>threading</code> 和 <code>Queue</code> 处理并行的模型请求和流式传输。</li>
<li><strong>文件处理</strong>：利用 <code>markitdown</code> 进行文档转换，使用 <code>Pillow</code> 进行图像处理。</li>
</ul>
</section>
<section id="使用技巧" class="level1">
<h1>📖 使用技巧</h1>
<section id="并排对比" class="level3">
<h3 class="anchored" data-anchor-id="并排对比">并排对比</h3>
<p>最强大的功能之一是在“🤖 Models”选项卡中选择多个模型。当您发送消息时，应用会并行查询所有选定的模型并并排显示它们的回答，从而轻松对比其性能和准确性。</p>
</section>
<section id="使用提示词库" class="level3">
<h3 class="anchored" data-anchor-id="使用提示词库">使用提示词库</h3>
<p>不知道如何开始？使用“📚 Prompt Bay”寻找完美的系统提示词。您可以按类别或关键字搜索，并一键应用到当前会话中。</p>
</section>
<section id="高级文件分析" class="level3">
<h3 class="anchored" data-anchor-id="高级文件分析">高级文件分析</h3>
<p>上传 PDF 或 Excel 文件，应用会自动将其转换为 Markdown 或表格，并包含在对话上下文中。这允许您直接针对文档内容向 AI 提问。</p>
<hr>
<p><em>欢迎在 <a href="https://github.com/JCwinning/AI_Chat">GitHub</a> 查看完整源代码，并开始构建您自己的 AI 驱动工作流！</em></p>


<!-- -->

</section>
</section>

 ]]></description>
  <category>AI</category>
  <category>Streamlit</category>
  <category>Python</category>
  <category>LLM</category>
  <guid>https://jcwinning.github.io/LandingPage/posts/AI-Chat/</guid>
  <pubDate>Tue, 06 Jan 2026 16:00:00 GMT</pubDate>
  <media:content url="https://jcwinning.github.io/LandingPage/posts/AI-Chat/images/featured.png" medium="image" type="image/png" height="126" width="144"/>
</item>
<item>
  <title>使用 AI SQL 构建的交互式 GDP 趋势看板</title>
  <link>https://jcwinning.github.io/LandingPage/posts/gdp-trend/</link>
  <description><![CDATA[ 





<section id="项目概览" class="level1">
<h1>项目概览</h1>
<p>GDP 趋势看板 (GDP Trend Dashboard) 是一个复杂的 Web 应用程序，用于可视化和分析来自世界银行 API 的经济数据。该系统的独特之处在于其双重方法：将传统的交互式可视化与 AI 驱动的自然语言查询相结合，使技术分析师和普通用户都能轻松获取经济数据。</p>
<p>在线演示：<a href="https://world-GDP-trend.streamlit.app">https://world-GDP-trend.streamlit.app</a></p>
<p>Github：<a href="https://github.com/JCwinning/GDP_trend">https://github.com/JCwinning/GDP_trend</a></p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" aria-controls="tabset-1-1" aria-selected="true" href="">GDP 趋势</a></li><li class="nav-item"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" aria-controls="tabset-1-2" aria-selected="false" href="">AI 查询界面</a></li><li class="nav-item"><a class="nav-link" id="tabset-1-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-3" aria-controls="tabset-1-3" aria-selected="false" href="">AI 摘要生成</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" aria-labelledby="tabset-1-1-tab">
<p>交互式全球 GDP 趋势可视化</p>
<p><img src="https://jcwinning.github.io/LandingPage/posts/gdp-trend/images/0.png" class="img-fluid" style="width:100.0%"></p>
</div>
<div id="tabset-1-2" class="tab-pane" aria-labelledby="tabset-1-2-tab">
<p>交互式 AI 驱动的自然语言转 SQL</p>
<p><img src="https://jcwinning.github.io/LandingPage/posts/gdp-trend/images/1.png" class="img-fluid" style="width:100.0%"></p>
</div>
<div id="tabset-1-3" class="tab-pane" aria-labelledby="tabset-1-3-tab">
<p>AI 生成的经济数据洞见摘要</p>
<p><img src="https://jcwinning.github.io/LandingPage/posts/gdp-trend/images/2.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
</div>
<section id="核心架构" class="level2">
<h2 class="anchored" data-anchor-id="核心架构">核心架构</h2>
<section id="技术栈" class="level3">
<h3 class="anchored" data-anchor-id="技术栈">技术栈</h3>
<ul>
<li><strong>主要框架</strong>：用于交互式 Web 应用的 Streamlit</li>
<li><strong>数据处理</strong>：用于数据操作和分析的 Pandas</li>
<li><strong>可视化</strong>：用于交互式图表的 Plotly Express</li>
<li><strong>数据库</strong>：用于高效 SQL 查询的 DuckDB</li>
<li><strong>AI 集成</strong>：用于自然语言转 SQL 的 ModelScope GLM-4.6</li>
<li><strong>数据源</strong>：通过 <code>wbgapi</code> 库调用的世界银行 API</li>
</ul>
</section>
<section id="关键特性" class="level3">
<h3 class="anchored" data-anchor-id="关键特性">关键特性</h3>
<ol type="1">
<li><strong>多国 GDP 趋势对比</strong></li>
<li><strong>支持多种经济指标</strong>（GDP、人均 GDP、人口、同比增长率）</li>
<li><strong>AI 驱动的自然语言查询</strong></li>
<li><strong>使用 DuckDB 的直接 SQL 接口</strong></li>
<li><strong>完善的双语支持</strong>（中/英文）</li>
<li><strong>带交互控制的时间范围筛选</strong>（2000年至今）</li>
</ol>
</section>
</section>
<section id="数据流水线架构" class="level2">
<h2 class="anchored" data-anchor-id="数据流水线架构">数据流水线架构</h2>
<p>该应用程序实现了一个复杂的数据流水线，以确保数据质量和实时可用性：</p>
<div class="cell" data-eval="true" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">flowchart TD
    A[世界银行 API] --&gt; B[数据采集&lt;br/&gt;download_data.py]
    B --&gt; C[数据处理&lt;br/&gt;国家映射、指标计算]
    C --&gt; D[数据存储&lt;br/&gt;CSV 文件]

    D --&gt; E[Streamlit 应用&lt;br/&gt;app.py]
    E --&gt; F[DuckDB&lt;br/&gt;内存 SQL]

    F --&gt; G[可视化引擎&lt;br/&gt;Plotly Express]
    F --&gt; H[AI 查询引擎&lt;br/&gt;ModelScope API]
    F --&gt; I[会话管理&lt;br/&gt;用户状态]

    G --&gt; J[交互式图表]
    H --&gt; K[自然语言&lt;br/&gt;转 SQL]
    I --&gt; L[持久化&lt;br/&gt;查询结果]

    J --&gt; M[用户界面]
    K --&gt; M
    L --&gt; M
</pre>
</div>
<p></p><figcaption> GDP 应用架构</figcaption> </figure><p></p>
</div>
</div>
</div>
</section>
<section id="数据采集与处理" class="level2">
<h2 class="anchored" data-anchor-id="数据采集与处理">数据采集与处理</h2>
<section id="世界银行-api-集成" class="level3">
<h3 class="anchored" data-anchor-id="世界银行-api-集成">世界银行 API 集成</h3>
<p>应用程序使用世界银行 API 采集全面的经济数据：</p>
<div id="523bec37" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> wbgapi <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> wb</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pycountry</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb1-4"></span>
<span id="cb1-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> download_economic_data():</span>
<span id="cb1-6">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""从世界银行 API 下载所有国家的 GDP 数据"""</span></span>
<span id="cb1-7"></span>
<span id="cb1-8">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 定义要下载的经济指标</span></span>
<span id="cb1-9">    indicators <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb1-10">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'gdp_current_usd'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'NY.GDP.MKTP.CD'</span>,</span>
<span id="cb1-11">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'gdp_per_capita_current_usd'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'NY.GDP.PCAP.CD'</span>,</span>
<span id="cb1-12">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'population_total'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'SP.POP.TOTL'</span></span>
<span id="cb1-13">    }</span>
<span id="cb1-14"></span>
<span id="cb1-15">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 下载 2000 年至今的数据</span></span>
<span id="cb1-16">    data_frames <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb1-17">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> indicator_name, indicator_code <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> indicators.items():</span>
<span id="cb1-18">        df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> wb.get_series(</span>
<span id="cb1-19">            series<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>indicator_code,</span>
<span id="cb1-20">            economy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'all'</span>,</span>
<span id="cb1-21">            time<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'2000:2024'</span>,</span>
<span id="cb1-22">            simplify_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span></span>
<span id="cb1-23">        )</span>
<span id="cb1-24"></span>
<span id="cb1-25">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 处理并添加到集合</span></span>
<span id="cb1-26">        df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df.reset_index()</span>
<span id="cb1-27">        df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'indicator'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> indicator_name</span>
<span id="cb1-28">        data_frames.append(df)</span>
<span id="cb1-29"></span>
<span id="cb1-30">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 合并所有指标</span></span>
<span id="cb1-31">    combined_df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.concat(data_frames, ignore_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb1-32">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> combined_df</span>
<span id="cb1-33"></span>
<span id="cb1-34"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> create_country_reference_table():</span>
<span id="cb1-35">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""创建包含 ISO 代码的完整国家元数据表"""</span></span>
<span id="cb1-36">    countries <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(pycountry.countries)</span>
<span id="cb1-37"></span>
<span id="cb1-38">    df_all <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.DataFrame([{</span>
<span id="cb1-39">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'country_name'</span>: country.name,</span>
<span id="cb1-40">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'country_code_2'</span>: country.alpha_2,</span>
<span id="cb1-41">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'country_code_3'</span>: country.alpha_3</span>
<span id="cb1-42">    } <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> country <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> countries])</span>
<span id="cb1-43"></span>
<span id="cb1-44">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 添加大洲映射</span></span>
<span id="cb1-45">    iso_to_continent <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb1-46">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"US"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"North America"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CN"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Asia"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"JP"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Asia"</span>,</span>
<span id="cb1-47">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"DE"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Europe"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"GB"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Europe"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"FR"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Europe"</span></span>
<span id="cb1-48">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ... 为所有国家完成映射</span></span>
<span id="cb1-49">    }</span>
<span id="cb1-50"></span>
<span id="cb1-51">    df_all[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'continent'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df_all[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'country_code_2'</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">map</span>(iso_to_continent)</span>
<span id="cb1-52">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> df_all</span></code></pre></div></div>
</details>
</div>
</section>
<section id="数据模式与结构" class="level3">
<h3 class="anchored" data-anchor-id="数据模式与结构">数据模式与结构</h3>
<p>应用程序使用清晰、规范化的数据结构：</p>
<div id="99433cf5" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> 主要数据模式</span>
<span id="cb2-2">CREATE TABLE df_gdp (</span>
<span id="cb2-3">    country_name TEXT,        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> 显示名称 (英文)</span>
<span id="cb2-4">    country_code_2 TEXT,      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> ISO alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> 代码</span>
<span id="cb2-5">    country_code_3 TEXT,      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> ISO alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> 代码</span>
<span id="cb2-6">    continent TEXT,            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> 大洲分类</span>
<span id="cb2-7">    year INTEGER,              <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> 数据年份</span>
<span id="cb2-8">    indicator TEXT,            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> 经济指标名称</span>
<span id="cb2-9">    value REAL                <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> 指标数值</span>
<span id="cb2-10">)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-11"></span>
<span id="cb2-12"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--</span> 示例数据</span>
<span id="cb2-13">INSERT INTO df_gdp VALUES</span>
<span id="cb2-14">(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'United States'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'US'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'USA'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'North America'</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2023</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'gdp_current_usd'</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">27444144.3</span>),</span>
<span id="cb2-15">(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'United States'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'US'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'USA'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'North America'</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2023</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'gdp_per_capita_current_usd'</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">81254.2</span>),</span>
<span id="cb2-16">(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'United States'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'US'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'USA'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'North America'</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2023</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'population_total'</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">334914895.0</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div></div>
</details>
</div>
</section>
</section>
<section id="交互式可视化系统" class="level2">
<h2 class="anchored" data-anchor-id="交互式可视化系统">交互式可视化系统</h2>
<section id="plotly-express-实现" class="level3">
<h3 class="anchored" data-anchor-id="plotly-express-实现">Plotly Express 实现</h3>
<p>应用程序使用 Plotly Express 创建交互式图表，并保持一致的颜色编码：</p>
<div id="3f57170a" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> plotly.express <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> px</span>
<span id="cb3-2"></span>
<span id="cb3-3"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@st.cache_data</span></span>
<span id="cb3-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> load_data():</span>
<span id="cb3-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""加载并缓存 GDP 数据"""</span></span>
<span id="cb3-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> pd.read_csv(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'data/gdp_data_2000_present.csv'</span>)</span>
<span id="cb3-7"></span>
<span id="cb3-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> create_gdp_trend_chart(selected_countries, selected_indicator, year_range):</span>
<span id="cb3-9">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""创建交互式 GDP 趋势可视化"""</span></span>
<span id="cb3-10"></span>
<span id="cb3-11">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 加载筛选后的数据</span></span>
<span id="cb3-12">    df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> load_data()</span>
<span id="cb3-13"></span>
<span id="cb3-14">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 应用筛选条件</span></span>
<span id="cb3-15">    filtered_df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df[</span>
<span id="cb3-16">        (df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'country_name'</span>].isin(selected_countries)) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span></span>
<span id="cb3-17">        (df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'indicator'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> selected_indicator) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span></span>
<span id="cb3-18">        (df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'year'</span>].between(year_range[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], year_range[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]))</span>
<span id="cb3-19">    ]</span>
<span id="cb3-20"></span>
<span id="cb3-21">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 创建交互式折线图</span></span>
<span id="cb3-22">    fig <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> px.line(</span>
<span id="cb3-23">        filtered_df,</span>
<span id="cb3-24">        x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'year'</span>,</span>
<span id="cb3-25">        y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'value'</span>,</span>
<span id="cb3-26">        color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'country_name'</span>,</span>
<span id="cb3-27">        title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>selected_indicator<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>replace(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" "</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>title()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> 趋势'</span>,</span>
<span id="cb3-28">        labels<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{</span>
<span id="cb3-29">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'year'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'年份'</span>,</span>
<span id="cb3-30">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'value'</span>: format_indicator_label(selected_indicator),</span>
<span id="cb3-31">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'country_name'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'国家'</span></span>
<span id="cb3-32">        }</span>
<span id="cb3-33">    )</span>
<span id="cb3-34"></span>
<span id="cb3-35">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 自定义图表外观</span></span>
<span id="cb3-36">    fig.update_layout(</span>
<span id="cb3-37">        xaxis_title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"年份"</span>,</span>
<span id="cb3-38">        yaxis_title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>format_indicator_label(selected_indicator),</span>
<span id="cb3-39">        hovermode<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'x unified'</span>,</span>
<span id="cb3-40">        showlegend<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb3-41">        legend<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>(</span>
<span id="cb3-42">            orientation<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"h"</span>,</span>
<span id="cb3-43">            yanchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bottom"</span>,</span>
<span id="cb3-44">            y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.02</span>,</span>
<span id="cb3-45">            xanchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"right"</span>,</span>
<span id="cb3-46">            x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb3-47">        )</span>
<span id="cb3-48">    )</span>
<span id="cb3-49"></span>
<span id="cb3-50">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> fig</span>
<span id="cb3-51"></span>
<span id="cb3-52"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> format_indicator_label(indicator):</span>
<span id="cb3-53">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""格式化指标名称以供显示"""</span></span>
<span id="cb3-54">    labels <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb3-55">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'gdp_current_usd'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'GDP (现价美元)'</span>,</span>
<span id="cb3-56">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'gdp_per_capita_current_usd'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'人均 GDP (现价美元)'</span>,</span>
<span id="cb3-57">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'population_total'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'总人口'</span>,</span>
<span id="cb3-58">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'gdp_per_capita_current_usd_yoy'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'人均 GDP 同比增长率 (%)'</span></span>
<span id="cb3-59">    }</span>
<span id="cb3-60">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> labels.get(indicator, indicator.replace(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'_'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">' '</span>).title())</span></code></pre></div></div>
</details>
</div>
</section>
</section>
<section id="ai-驱动的分析" class="level2">
<h2 class="anchored" data-anchor-id="ai-驱动的分析">AI 驱动的分析</h2>
<section id="自然语言转-sql" class="level3">
<h3 class="anchored" data-anchor-id="自然语言转-sql">自然语言转 SQL</h3>
<p>该程序最具创新性的功能是 AI 驱动的自然语言查询：</p>
<div id="f3df571a" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> OpenAI</span>
<span id="cb4-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> duckdb</span>
<span id="cb4-3"></span>
<span id="cb4-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> generate_sql_from_question(question, language):</span>
<span id="cb4-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""使用 ModelScope API 将自然语言问题转换为 SQL 查询"""</span></span>
<span id="cb4-6"></span>
<span id="cb4-7">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 获取数据库模式上下文</span></span>
<span id="cb4-8">    schema_info <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb4-9"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    表名: df_gdp</span></span>
<span id="cb4-10"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    列名:</span></span>
<span id="cb4-11"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    - country_name (TEXT): 国家显示名称</span></span>
<span id="cb4-12"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    - country_code_2 (TEXT): ISO alpha-2 国家代码</span></span>
<span id="cb4-13"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    - continent (TEXT): 大洲分类</span></span>
<span id="cb4-14"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    - year (INTEGER): 数据年份 (2000-2024)</span></span>
<span id="cb4-15"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    - indicator (TEXT): 经济指标名称</span></span>
<span id="cb4-16"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    - value (REAL): 指标数值</span></span>
<span id="cb4-17"></span>
<span id="cb4-18"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    可用指标:</span></span>
<span id="cb4-19"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    - gdp_current_usd: 现价 GDP (美元)</span></span>
<span id="cb4-20"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    - gdp_per_capita_current_usd: 现价人均 GDP (美元)</span></span>
<span id="cb4-21"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    - population_total: 总人口</span></span>
<span id="cb4-22"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    - gdp_per_capita_current_usd_yoy: 人均 GDP 同比增长率 (%)</span></span>
<span id="cb4-23"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb4-24"></span>
<span id="cb4-25">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 创建特定语言的提示词</span></span>
<span id="cb4-26">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> language <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"zh"</span>:</span>
<span id="cb4-27">        prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"""请将以下自然语言问题转换为SQL查询，仅返回SQL语句，不要解释。</span></span>
<span id="cb4-28"></span>
<span id="cb4-29"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">数据库信息：</span></span>
<span id="cb4-30"><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>schema_info<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb4-31"></span>
<span id="cb4-32"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">用户问题：</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>question<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb4-33"></span>
<span id="cb4-34"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">要求：</span></span>
<span id="cb4-35"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">1. 只返回标准的SELECT语句</span></span>
<span id="cb4-36"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">2. 不要添加任何解释或注释</span></span>
<span id="cb4-37"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">3. 使用LIMIT 50限制结果数量"""</span></span>
<span id="cb4-38">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb4-39">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (保持原英文 prompt)</span></span>
<span id="cb4-40">        prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"""Convert the following natural language question to SQL query. Return only the SQL statement, no explanation.</span></span>
<span id="cb4-41"></span>
<span id="cb4-42"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">Database information:</span></span>
<span id="cb4-43"><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>schema_info<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb4-44"></span>
<span id="cb4-45"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">User question: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>question<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb4-46"></span>
<span id="cb4-47"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">Requirements:</span></span>
<span id="cb4-48"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">1. Return only standard SELECT statement</span></span>
<span id="cb4-49"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">2. Do not add any explanation or comments</span></span>
<span id="cb4-50"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">3. Use LIMIT 50 to restrict results"""</span></span>
<span id="cb4-51"></span>
<span id="cb4-52">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 调用 ModelScope API</span></span>
<span id="cb4-53">    client <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> OpenAI(</span>
<span id="cb4-54">        api_key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>os.getenv(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'MODELSCOPE_API_KEY'</span>),</span>
<span id="cb4-55">        base_url<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://dashscope.aliyuncs.com/compatible-mode/v1"</span></span>
<span id="cb4-56">    )</span>
<span id="cb4-57"></span>
<span id="cb4-58">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> client.chat.completions.create(</span>
<span id="cb4-59">        model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"qwen/Qwen3-235B"</span>,</span>
<span id="cb4-60">        messages<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"role"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"user"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"content"</span>: prompt}],</span>
<span id="cb4-61">        temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 使用低温度以获得一致的 SQL</span></span>
<span id="cb4-62">        max_tokens<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span></span>
<span id="cb4-63">    )</span>
<span id="cb4-64"></span>
<span id="cb4-65">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> response.choices[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].message.content.strip()</span></code></pre></div></div>
</details>
</div>
</section>
<section id="查询执行与-ai-摘要" class="level3">
<h3 class="anchored" data-anchor-id="查询执行与-ai-摘要">查询执行与 AI 摘要</h3>
<div id="0e757453" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> execute_query_with_ai_summary(sql_query, original_question):</span>
<span id="cb5-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""执行 SQL 查询并生成 AI 摘要"""</span></span>
<span id="cb5-3"></span>
<span id="cb5-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb5-5">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 使用 DuckDB 执行查询</span></span>
<span id="cb5-6">        conn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> duckdb.<span class="ex" style="color: null;
background-color: null;
font-style: inherit;">connect</span>()</span>
<span id="cb5-7">        result_df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> conn.execute(sql_query).fetchdf()</span>
<span id="cb5-8"></span>
<span id="cb5-9">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 将结果存入会话状态</span></span>
<span id="cb5-10">        st.session_state.sql_result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> result_df</span>
<span id="cb5-11">        st.session_state.sql_query <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sql_query</span>
<span id="cb5-12"></span>
<span id="cb5-13">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 如果有数据，生成 AI 摘要</span></span>
<span id="cb5-14">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> result_df.empty:</span>
<span id="cb5-15">            generate_ai_summary(result_df, original_question)</span>
<span id="cb5-16"></span>
<span id="cb5-17">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> result_df</span>
<span id="cb5-18"></span>
<span id="cb5-19">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">Exception</span> <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> e:</span>
<span id="cb5-20">        st.error(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"查询执行错误: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(e)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb5-21">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb5-22"></span>
<span id="cb5-23"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> generate_ai_summary(data_frame, question):</span>
<span id="cb5-24">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""生成查询结果的 AI 摘要"""</span></span>
<span id="cb5-25"></span>
<span id="cb5-26">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 将 DataFrame 转换为文本以便分析</span></span>
<span id="cb5-27">    data_summary <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> data_frame.to_string(index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb5-28"></span>
<span id="cb5-29">    summary_prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"""根据以下数据分析结果，提供一个简明扼要的摘要：</span></span>
<span id="cb5-30"></span>
<span id="cb5-31"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">原始问题：</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>question<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb5-32"></span>
<span id="cb5-33"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">查询结果：</span></span>
<span id="cb5-34"><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>data_summary<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb5-35"></span>
<span id="cb5-36"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">请提供：</span></span>
<span id="cb5-37"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">1. 关键发现的简要分析</span></span>
<span id="cb5-38"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">2. 任何值得注意的趋势或模式</span></span>
<span id="cb5-39"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">3. 来自数据的重要见解</span></span>
<span id="cb5-40"></span>
<span id="cb5-41"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">请将摘要控制在 200 字以内，并确保通俗易懂。"""</span></span>
<span id="cb5-42"></span>
<span id="cb5-43">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 使用 AI 生成摘要</span></span>
<span id="cb5-44">    client <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> OpenAI(</span>
<span id="cb5-45">        api_key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>os.getenv(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'MODELSCOPE_API_KEY'</span>),</span>
<span id="cb5-46">        base_url<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://dashscope.aliyuncs.com/compatible-mode/v1"</span></span>
<span id="cb5-47">    )</span>
<span id="cb5-48"></span>
<span id="cb5-49">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> client.chat.completions.create(</span>
<span id="cb5-50">        model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"qwen/Qwen3-235B"</span>,</span>
<span id="cb5-51">        messages<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"role"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"user"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"content"</span>: summary_prompt}],</span>
<span id="cb5-52">        temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>,</span>
<span id="cb5-53">        max_tokens<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span></span>
<span id="cb5-54">    )</span>
<span id="cb5-55"></span>
<span id="cb5-56">    st.session_state.ai_summary <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> response.choices[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].message.content</span></code></pre></div></div>
</details>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://jcwinning.github.io/LandingPage/posts/gdp-trend/images/1.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption>AI 查询界面 - 自然语言处理</figcaption>
</figure>
</div>
</section>
</section>
<section id="双语支持系统" class="level2">
<h2 class="anchored" data-anchor-id="双语支持系统">双语支持系统</h2>
<section id="国际化架构" class="level3">
<h3 class="anchored" data-anchor-id="国际化架构">国际化架构</h3>
<p>应用程序实现了全面的中/英文支持：</p>
<div id="d43e8624" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># language.py - 完整的翻译系统</span></span>
<span id="cb6-2">translations <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb6-3">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"en"</span>: {</span>
<span id="cb6-4">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"title"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"🌍 GDP Trend Dashboard"</span>,</span>
<span id="cb6-5">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gdp_trend"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"GDP Trend"</span>,</span>
<span id="cb6-6">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ai_powered_chat"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"AI-Powered Data Chat"</span>,</span>
<span id="cb6-7">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"default_question"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"What is the average GDP per capita for China, Japan, and Korea during 2020 to 2023?"</span></span>
<span id="cb6-8">    },</span>
<span id="cb6-9">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"zh"</span>: {</span>
<span id="cb6-10">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"title"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"🌍 GDP 趋势看板"</span>,</span>
<span id="cb6-11">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gdp_trend"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"GDP 趋势"</span>,</span>
<span id="cb6-12">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ai_powered_chat"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"AI 数据对话"</span>,</span>
<span id="cb6-13">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"default_question"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2020年至2023年期间，中国、日本和韩国的平均人均GDP是多少？"</span></span>
<span id="cb6-14">    }</span>
<span id="cb6-15">}</span>
<span id="cb6-16"></span>
<span id="cb6-17"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_text(key):</span>
<span id="cb6-18">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""获取当前语言的翻译文本"""</span></span>
<span id="cb6-19">    language <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> st.session_state.get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"language"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"en"</span>)</span>
<span id="cb6-20">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> translations.get(language, {}).get(key, key)</span>
<span id="cb6-21"></span>
<span id="cb6-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># UI 中的语言切换</span></span>
<span id="cb6-23">col1, col2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> st.columns([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb6-24"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> col1:</span>
<span id="cb6-25">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> st.button(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"English"</span>):</span>
<span id="cb6-26">        st.session_state.language <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"en"</span></span>
<span id="cb6-27">        st.rerun()</span>
<span id="cb6-28"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> col2:</span>
<span id="cb6-29">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> st.button(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"中文"</span>):</span>
<span id="cb6-30">        st.session_state.language <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"zh"</span></span>
<span id="cb6-31">        st.rerun()</span></code></pre></div></div>
</details>
</div>
</section>
</section>
<section id="用户界面设计" class="level2">
<h2 class="anchored" data-anchor-id="用户界面设计">用户界面设计</h2>
<section id="主应用程序结构" class="level3">
<h3 class="anchored" data-anchor-id="主应用程序结构">主应用程序结构</h3>
<div id="f437212a" class="cell" data-execution_count="7">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> main():</span>
<span id="cb7-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""采用标签页导航的主应用程序"""</span></span>
<span id="cb7-3"></span>
<span id="cb7-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 右上角的语言切换</span></span>
<span id="cb7-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> st.container():</span>
<span id="cb7-6">        st.markdown(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb7-7"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">        &lt;div class="language-toggle"&gt;</span></span>
<span id="cb7-8"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">            &lt;button onclick="setLanguage('en')"&gt;EN&lt;/button&gt;</span></span>
<span id="cb7-9"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">            &lt;button onclick="setLanguage('zh')"&gt;中文&lt;/button&gt;</span></span>
<span id="cb7-10"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">        &lt;/div&gt;</span></span>
<span id="cb7-11"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">        """</span>, unsafe_allow_html<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb7-12"></span>
<span id="cb7-13">    st.title(get_text(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"title"</span>))</span>
<span id="cb7-14"></span>
<span id="cb7-15">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 标签页界面</span></span>
<span id="cb7-16">    tab1, tab2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> st.tabs([get_text(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gdp_trend"</span>), get_text(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"query"</span>)])</span>
<span id="cb7-17"></span>
<span id="cb7-18">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> tab1:</span>
<span id="cb7-19">        render_gdp_trends_tab()</span>
<span id="cb7-20"></span>
<span id="cb7-21">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> tab2:</span>
<span id="cb7-22">        render_query_interface_tab()</span>
<span id="cb7-23"></span>
<span id="cb7-24"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> render_gdp_trends_tab():</span>
<span id="cb7-25">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""渲染 GDP 趋势可视化标签页"""</span></span>
<span id="cb7-26"></span>
<span id="cb7-27">    st.header(get_text(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gdp_trend"</span>))</span>
<span id="cb7-28"></span>
<span id="cb7-29">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 加载数据</span></span>
<span id="cb7-30">    df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> load_data()</span>
<span id="cb7-31"></span>
<span id="cb7-32">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 筛选控制</span></span>
<span id="cb7-33">    col1, col2, col3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> st.columns([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb7-34"></span>
<span id="cb7-35">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> col1:</span>
<span id="cb7-36">        selected_countries <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> st.multiselect(</span>
<span id="cb7-37">            get_text(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"select_countries"</span>),</span>
<span id="cb7-38">            options<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'country_name'</span>].unique(),</span>
<span id="cb7-39">            default<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'United States'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'China'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Japan'</span>]</span>
<span id="cb7-40">        )</span>
<span id="cb7-41"></span>
<span id="cb7-42">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> col2:</span>
<span id="cb7-43">        selected_indicator <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> st.selectbox(</span>
<span id="cb7-44">            get_text(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"select_indicator"</span>),</span>
<span id="cb7-45">            options<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[</span>
<span id="cb7-46">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'gdp_current_usd'</span>,</span>
<span id="cb7-47">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'gdp_per_capita_current_usd'</span>,</span>
<span id="cb7-48">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'population_total'</span>,</span>
<span id="cb7-49">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'gdp_per_capita_current_usd_yoy'</span></span>
<span id="cb7-50">            ],</span>
<span id="cb7-51">            format_func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> x: format_indicator_label(x)</span>
<span id="cb7-52">        )</span>
<span id="cb7-53"></span>
<span id="cb7-54">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> col3:</span>
<span id="cb7-55">        year_range <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> st.slider(</span>
<span id="cb7-56">            get_text(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"select_year_range"</span>),</span>
<span id="cb7-57">            min_value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2000</span>,</span>
<span id="cb7-58">            max_value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2024</span>,</span>
<span id="cb7-59">            value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2010</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2024</span>),</span>
<span id="cb7-60">            step<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb7-61">        )</span>
<span id="cb7-62"></span>
<span id="cb7-63">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 生成并显示图表</span></span>
<span id="cb7-64">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> selected_countries <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> selected_indicator:</span>
<span id="cb7-65">        fig <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> create_gdp_trend_chart(selected_countries, selected_indicator, year_range)</span>
<span id="cb7-66">        st.plotly_chart(fig, use_container_width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb7-67"></span>
<span id="cb7-68">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 显示原始数据选项</span></span>
<span id="cb7-69">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> st.checkbox(get_text(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"show_raw_data"</span>)):</span>
<span id="cb7-70">            display_filtered_data_table(selected_countries, selected_indicator, year_range)</span>
<span id="cb7-71"></span>
<span id="cb7-72"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> render_query_interface_tab():</span>
<span id="cb7-73">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""渲染 AI 驱动的查询界面标签页"""</span></span>
<span id="cb7-74"></span>
<span id="cb7-75">    st.header(get_text(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ai_powered_chat"</span>))</span>
<span id="cb7-76">    st.markdown(get_text(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ai_chat_description"</span>))</span>
<span id="cb7-77"></span>
<span id="cb7-78">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 自然语言输入</span></span>
<span id="cb7-79">    user_question <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> st.text_input(</span>
<span id="cb7-80">        get_text(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"your_question"</span>),</span>
<span id="cb7-81">        value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>st.session_state.get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"user_question"</span>, get_text(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"default_question"</span>))</span>
<span id="cb7-82">    )</span>
<span id="cb7-83"></span>
<span id="cb7-84">    col1, col2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> st.columns([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb7-85"></span>
<span id="cb7-86">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> col1:</span>
<span id="cb7-87">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> st.button(get_text(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"run_ai"</span>), <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"primary"</span>):</span>
<span id="cb7-88">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> user_question:</span>
<span id="cb7-89">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> st.spinner(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"AI 正在处理..."</span>):</span>
<span id="cb7-90">                    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 从自然语言生成 SQL</span></span>
<span id="cb7-91">                    sql_query <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> generate_sql_from_question(</span>
<span id="cb7-92">                        user_question,</span>
<span id="cb7-93">                        st.session_state.language</span>
<span id="cb7-94">                    )</span>
<span id="cb7-95"></span>
<span id="cb7-96">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> sql_query:</span>
<span id="cb7-97">                        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 执行查询并生成摘要</span></span>
<span id="cb7-98">                        result_df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> execute_query_with_ai_summary(sql_query, user_question)</span>
<span id="cb7-99"></span>
<span id="cb7-100">                        st.session_state.user_question <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> user_question</span>
<span id="cb7-101">                        st.session_state.should_generate_ai_summary <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span></span>
<span id="cb7-102"></span>
<span id="cb7-103">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 显示结果</span></span>
<span id="cb7-104">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> st.session_state.get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sql_result"</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb7-105">        display_query_results()</span></code></pre></div></div>
</details>
</div>
</section>
</section>
<section id="性能优化" class="level2">
<h2 class="anchored" data-anchor-id="性能优化">性能优化</h2>
<section id="数据缓存与效率" class="level3">
<h3 class="anchored" data-anchor-id="数据缓存与效率">数据缓存与效率</h3>
<div id="7f0ecdba" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Streamlit 数据操作缓存</span></span>
<span id="cb8-2"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@st.cache_data</span>(ttl<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3600</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 缓存 1 小时</span></span>
<span id="cb8-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> load_data():</span>
<span id="cb8-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""加载并缓存 GDP 数据"""</span></span>
<span id="cb8-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> pd.read_csv(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'data/gdp_data_2000_present.csv'</span>)</span>
<span id="cb8-6"></span>
<span id="cb8-7"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@st.cache_data</span>(ttl<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1800</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 缓存 30 分钟</span></span>
<span id="cb8-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_country_list():</span>
<span id="cb8-9">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""获取并缓存唯一的国家列表"""</span></span>
<span id="cb8-10">    df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> load_data()</span>
<span id="cb8-11">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sorted</span>(df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'country_name'</span>].unique())</span>
<span id="cb8-12"></span>
<span id="cb8-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># AI 交互的会话状态管理</span></span>
<span id="cb8-14"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> init_session_state():</span>
<span id="cb8-15">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""初始化所有会话状态变量"""</span></span>
<span id="cb8-16">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sql_result"</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> st.session_state:</span>
<span id="cb8-17">        st.session_state.sql_result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb8-18">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ai_summary"</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> st.session_state:</span>
<span id="cb8-19">        st.session_state.ai_summary <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb8-20">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"should_generate_ai_summary"</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> st.session_state:</span>
<span id="cb8-21">        st.session_state.should_generate_ai_summary <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span></span></code></pre></div></div>
</details>
</div>
</section>
<section id="错误处理与用户体验" class="level3">
<h3 class="anchored" data-anchor-id="错误处理与用户体验">错误处理与用户体验</h3>
<div id="3e412006" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> safe_api_call(func, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>args, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>kwargs):</span>
<span id="cb9-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""带错误处理的安全 API 调用"""</span></span>
<span id="cb9-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb9-4">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> func(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>args, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>kwargs)</span>
<span id="cb9-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">Exception</span> <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> e:</span>
<span id="cb9-6">        st.error(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"API 错误: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(e)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb9-7">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb9-8"></span>
<span id="cb9-9"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> validate_sql_query(sql_query):</span>
<span id="cb9-10">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""基础 SQL 查询验证"""</span></span>
<span id="cb9-11">    sql_lower <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sql_query.lower().strip()</span>
<span id="cb9-12"></span>
<span id="cb9-13">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 基础安全检查</span></span>
<span id="cb9-14">    dangerous_keywords <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'drop'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'delete'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'update'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'insert'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'alter'</span>]</span>
<span id="cb9-15">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> keyword <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> dangerous_keywords:</span>
<span id="cb9-16">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> keyword <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> sql_lower:</span>
<span id="cb9-17">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">raise</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">ValueError</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"检测到危险 SQL 关键字: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>keyword<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb9-18"></span>
<span id="cb9-19">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 确保查询以 SELECT 开头</span></span>
<span id="cb9-20">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> sql_lower.startswith(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'select'</span>):</span>
<span id="cb9-21">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">raise</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">ValueError</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"仅允许执行 SELECT 查询"</span>)</span>
<span id="cb9-22"></span>
<span id="cb9-23">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span></span></code></pre></div></div>
</details>
</div>
</section>
</section>
<section id="部署与可访问性" class="level2">
<h2 class="anchored" data-anchor-id="部署与可访问性">部署与可访问性</h2>
<section id="环境配置" class="level3">
<h3 class="anchored" data-anchor-id="环境配置">环境配置</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 环境配置</span></span>
<span id="cb10-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># .env 文件</span></span>
<span id="cb10-3"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">MODELSCOPE_API_KEY</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>your_modelscope_key</span>
<span id="cb10-4"></span>
<span id="cb10-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 安装依赖</span></span>
<span id="cb10-6"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pip</span> install <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-r</span> requirements.txt</span>
<span id="cb10-7"></span>
<span id="cb10-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 数据采集</span></span>
<span id="cb10-9"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">python</span> download_data.py</span>
<span id="cb10-10"></span>
<span id="cb10-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 运行应用程序</span></span>
<span id="cb10-12"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">streamlit</span> run app.py</span></code></pre></div></div>
</section>
<section id="必需的依赖项" class="level3">
<h3 class="anchored" data-anchor-id="必需的依赖项">必需的依赖项</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode txt code-with-copy"><code class="sourceCode default"><span id="cb11-1">streamlit&gt;=1.28.0</span>
<span id="cb11-2">pandas&gt;=1.5.0</span>
<span id="cb11-3">plotly&gt;=5.15.0</span>
<span id="cb11-4">duckdb&gt;=0.8.0</span>
<span id="cb11-5">openai&gt;=1.0.0</span>
<span id="cb11-6">python-dotenv&gt;=1.0.0</span>
<span id="cb11-7">wbgapi&gt;=1.0.0</span>
<span id="cb11-8">pycountry&gt;=22.0.0</span>
<span id="cb11-9">numpy&gt;=1.24.0</span></code></pre></div></div>
</section>
</section>
<section id="技术亮点" class="level2">
<h2 class="anchored" data-anchor-id="技术亮点">技术亮点</h2>
<section id="关键创新点" class="level3">
<h3 class="anchored" data-anchor-id="关键创新点">关键创新点</h3>
<ol type="1">
<li><strong>双界面方案</strong>：同时提供视觉和自然语言访问数据的方式</li>
<li><strong>AI 驱动的 SQL 生成</strong>：使用简单的中/英文即可进行复杂的经济查询</li>
<li><strong>实时数据处理</strong>：高效的缓存和会话管理</li>
<li><strong>全面的国际化</strong>：真正的双语支持及本地化数据显示</li>
<li><strong>生产就绪的部署</strong>：完善的错误处理和性能优化</li>
</ol>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://jcwinning.github.io/LandingPage/posts/gdp-trend/images/2.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption>AI 摘要生成</figcaption>
</figure>
</div>
</section>
</section>
<section id="经济分析示例" class="level2">
<h2 class="anchored" data-anchor-id="经济分析示例">经济分析示例</h2>
<section id="支持的查询类型" class="level3">
<h3 class="anchored" data-anchor-id="支持的查询类型">支持的查询类型</h3>
<ol type="1">
<li><strong>对比分析</strong>
<ul>
<li>“对比 2010 年至 2020 年中国和日本的 GDP 增长”</li>
<li>“2023 年哪些国家的人均 GDP 最高？”</li>
</ul></li>
<li><strong>时序分析</strong>
<ul>
<li>“显示过去十年金砖国家的 GDP 趋势”</li>
<li>“2000 年至 2020 年印度的人口增长率是多少？”</li>
</ul></li>
<li><strong>统计查询</strong>
<ul>
<li>“计算欧洲国家的平均 GDP 增长率”</li>
<li>“找出 2022 年人均 GDP 超过 50,000 美元的国家”</li>
</ul></li>
<li><strong>复杂多变量分析</strong>
<ul>
<li>“亚洲国家的人口与 GDP 之间有什么相关性？”</li>
<li>“列出连续 3 年人均 GDP 增长超过 5% 的国家”</li>
</ul></li>
</ol>
</section>
</section>
<section id="结论" class="level2">
<h2 class="anchored" data-anchor-id="结论">结论</h2>
<p>这个 GDP 趋势看板代表了经济数据分析的创新方法，将传统的视觉化技术与尖端的 AI 能力相结合。该项目展示了：</p>
<ul>
<li><strong>先进的数据集成</strong>：集成世界银行 API 与全面的经济指标</li>
<li><strong>自然语言处理</strong>：AI 驱动的 SQL 生成，实现便捷的数据查询</li>
<li><strong>专业的视觉化</strong>：采用一致设计的交互式 Plotly 图表</li>
<li><strong>双语支持</strong>：完整的英/中本地化</li>
<li><strong>生产级架构</strong>：稳健的错误处理、缓存和部署</li>
</ul>
<p>无论您是经济学家、数据科学家还是政策分析师，该应用程序都展示了现代 AI 技术如何通过直观的界面和智能自动化，使复杂的经济数据变得更加易于获取和利用。</p>
<hr>
<p><strong>技术栈</strong>：Streamlit, DuckDB, Plotly, ModelScope API, World Bank API</p>
<p><strong>数据源</strong>：世界银行 (2000-2024, 200+ 国家, 15,000+ 数据点)</p>


<!-- -->

</section>
</section>

 ]]></description>
  <category>Data Visualization</category>
  <category>Streamlit</category>
  <category>Economic Analysis</category>
  <category>AI</category>
  <guid>https://jcwinning.github.io/LandingPage/posts/gdp-trend/</guid>
  <pubDate>Mon, 17 Nov 2025 16:00:00 GMT</pubDate>
  <media:content url="https://jcwinning.github.io/LandingPage/posts/gdp-trend/images/0.png" medium="image" type="image/png" height="83" width="144"/>
</item>
<item>
  <title>Shop Map Manager (店铺地图管理系统)</title>
  <dc:creator>Tony D</dc:creator>
  <link>https://jcwinning.github.io/LandingPage/posts/shop-map-manager/</link>
  <description><![CDATA[ 





<p>一个强大且优雅的个人店铺管理系统。无论您是在追踪心爱的咖啡馆、风景名胜，还是在规划未来的行程，该应用程序都能为您提供一个强大的可视化和数据管理平台。</p>
<p>在线演示 (Streamlit): <a href="https://china-map.streamlit.app">https://china-map.streamlit.app</a> (Vercel): <a href="https://china-mapping.vercel.app/">https://china-mapping.vercel.app/</a></p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" aria-controls="tabset-1-1" aria-selected="true" href="">地图视图</a></li><li class="nav-item"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" aria-controls="tabset-1-2" aria-selected="false" href="">表格视图</a></li><li class="nav-item"><a class="nav-link" id="tabset-1-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-3" aria-controls="tabset-1-3" aria-selected="false" href="">店铺照片</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" aria-labelledby="tabset-1-1-tab">
<p><img src="https://jcwinning.github.io/LandingPage/posts/shop-map-manager/images/Picture1.png" class="img-fluid" style="width:100.0%"></p>
</div>
<div id="tabset-1-2" class="tab-pane" aria-labelledby="tabset-1-2-tab">
<p><img src="https://jcwinning.github.io/LandingPage/posts/shop-map-manager/images/Picture2.png" class="img-fluid" style="width:100.0%"></p>
</div>
<div id="tabset-1-3" class="tab-pane" aria-labelledby="tabset-1-3-tab">
<p><img src="https://jcwinning.github.io/LandingPage/posts/shop-map-manager/images/Picture3.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
</div>
<section id="核心架构演变双模式存储" class="level2">
<h2 class="anchored" data-anchor-id="核心架构演变双模式存储">核心架构演变：双模式存储</h2>
<p>本项目最重要的更新是引入了 <strong>双数据存储模式</strong>，同时兼顾了隐私和便携性：</p>
<ul>
<li><strong>本地模式</strong>：数据安全地存储在本地 <code>shops.csv</code> 文件中。适合无需任何配置的快速使用。</li>
<li><strong>云端模式</strong>：利用 <strong>Supabase</strong> 进行跨设备的实时同步。让您的旅程记录随行。</li>
</ul>
</section>
<section id="功能特性" class="level2">
<h2 class="anchored" data-anchor-id="功能特性">功能特性</h2>
<ul>
<li><strong>🔍 无限探索</strong>：无缝集成 <strong>高德地图 (Amap) API</strong>。一键搜索并添加任何地点到您的收藏。</li>
<li><strong>🎨 动态可视化</strong>：基于 <strong>Folium</strong> 的交互式地图，具有以下特色：
<ul>
<li>针对不同类别的自定义图标（咖啡、餐饮、风景等）。</li>
<li>直观的颜色编码：<strong>红色</strong> 表示 “已去过”，<strong>绿色</strong> 表示 “想去”。</li>
</ul></li>
<li><strong>📸 视觉记忆</strong>：（云端模式）为每个地点拍摄并上传多张照片，安全托管在 Supabase Storage。</li>
<li><strong>⭐ 深度洞察</strong>：不仅记录地点。还可以存储星级评分 (1-5)、个人笔记和访问时间戳。</li>
<li><strong>⚡ 实时过滤</strong>：根据行程类型或访问状态即时过滤视图，专注于您关心的内容。</li>
</ul>
</section>
<section id="技术栈" class="level2">
<h2 class="anchored" data-anchor-id="技术栈">技术栈</h2>
<table class="caption-top table">
<thead>
<tr class="header">
<th>组件</th>
<th>技术</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>前端</strong></td>
<td><a href="https://streamlit.io/">Streamlit</a></td>
</tr>
<tr class="even">
<td><strong>地图</strong></td>
<td><a href="https://python-visualization.github.io/folium/">Folium</a></td>
</tr>
<tr class="odd">
<td><strong>数据库/认证</strong></td>
<td><a href="https://supabase.com/">Supabase</a></td>
</tr>
<tr class="even">
<td><strong>API</strong></td>
<td><a href="https://lbs.amap.com/">高德地图 API</a></td>
</tr>
<tr class="odd">
<td><strong>数据逻辑</strong></td>
<td>Python &amp; Pandas</td>
</tr>
</tbody>
</table>
</section>
<section id="快速上手" class="level2">
<h2 class="anchored" data-anchor-id="快速上手">快速上手</h2>
<section id="安装" class="level3">
<h3 class="anchored" data-anchor-id="安装">1. 安装</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">git</span> clone https://github.com/JCwinning/map_app.git</span>
<span id="cb1-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">cd</span> map_app</span>
<span id="cb1-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pip</span> install <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-r</span> requirements.txt</span></code></pre></div></div>
</section>
<section id="环境配置" class="level3">
<h3 class="anchored" data-anchor-id="环境配置">2. 环境配置</h3>
<p>在根目录下创建一个 <code>.env</code> 文件：</p>
<pre class="env"><code># 必填
GAODE_API_KEY=您的密钥

# 可选：用于云端模式
SUPABASE_URL=您的 supabase url
SUPABASE_KEY=您的 supabase anon 密钥</code></pre>
</section>
<section id="启动" class="level3">
<h3 class="anchored" data-anchor-id="启动">3. 启动</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">streamlit</span> run app.py</span></code></pre></div></div>
</section>
</section>
<section id="数据管理" class="level2">
<h2 class="anchored" data-anchor-id="数据管理">数据管理</h2>
<p>无论是存储在扁平的 CSV 还是关系型的 Supabase 表中，该应用都能优雅地处理复杂的数据结构：</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>列名</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>shop_name</code></td>
<td>地点名称</td>
</tr>
<tr class="even">
<td><code>visit_status</code></td>
<td>当前状态 (已去过 / 想去)</td>
</tr>
<tr class="odd">
<td><code>rating</code></td>
<td>您的个人星级评分 (1-5)</td>
</tr>
<tr class="even">
<td><code>shop_type</code></td>
<td>类别 (例如: 咖啡, 零售, 风景)</td>
</tr>
<tr class="odd">
<td><code>images</code></td>
<td>(云端模式) 托管图像的 URL 数组</td>
</tr>
</tbody>
</table>
<hr>
</section>
<section id="结论" class="level2">
<h2 class="anchored" data-anchor-id="结论">结论</h2>
<p><strong>Shop Map Manager</strong> 已从一个简单的 CSV 可视化工具演变为一个全面的个人旅行和探索伴侣。通过连接本地的便捷性与云端的强大功能，它为现代探索者提供了极致的灵活性。</p>


<!-- -->

</section>

 ]]></description>
  <category>AI</category>
  <category>API</category>
  <category>map</category>
  <guid>https://jcwinning.github.io/LandingPage/posts/shop-map-manager/</guid>
  <pubDate>Fri, 07 Nov 2025 16:00:00 GMT</pubDate>
  <media:content url="https://jcwinning.github.io/LandingPage/posts/shop-map-manager/images/0.png" medium="image" type="image/png" height="82" width="144"/>
</item>
<item>
  <title>结合 AI 预测的 Streamlit 天气预报应用</title>
  <dc:creator>Tony D</dc:creator>
  <link>https://jcwinning.github.io/LandingPage/posts/weather-trend/</link>
  <description><![CDATA[ 





<section id="项目概览" class="level1">
<h1>项目概览</h1>
<p>在这一详尽的教程中，我将指导您创建一个精致的天气预报应用程序，该应用将现代 Web 开发与人工智能相结合。本项目演示了如何构建一个具备交互式地图、双语支持、实时数据可视化和 AI 驱动的天气分析功能的生产级天气应用。</p>
<p>在线演示: <a href="https://weather-trend.streamlit.app/">https://weather-trend.streamlit.app/</a></p>
<p>Github: <a href="https://github.com/JCwinning/weather_trend">https://github.com/JCwinning/weather_trend</a></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://jcwinning.github.io/LandingPage/posts/weather-trend/images/0.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption>天气预报应用主界面</figcaption>
</figure>
</div>
<p>这款天气预报应用不仅仅提供基础的天气数据，还集成了多项高级功能：</p>
<ul>
<li><strong>交互式位置选择</strong>：点击地图上的任意位置或通过城市名称搜索</li>
<li><strong>双语界面</strong>：完整的英文/中文语言支持及切换功能</li>
<li><strong>AI 驱动的分析</strong>：使用 DeepSeek AI 提供天气分析和建议</li>
<li><strong>高级可视化</strong>：温度趋势、空气质量监测和降雨概率</li>
<li><strong>实时数据</strong>：7 天历史数据和 5 天预报数据</li>
<li><strong>响应式设计</strong>：在桌面、平板和移动设备上运行无阻</li>
</ul>
<section id="技术架构" class="level2">
<h2 class="anchored" data-anchor-id="技术架构">技术架构</h2>
<div class="cell" data-eval="true" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">flowchart TD
    A[用户界面&lt;br/&gt;Streamlit Web 应用] --&gt; B[位置服务]
    A --&gt; C[天气数据 API]
    A --&gt; D[AI 集成层]
    A --&gt; E[可视化引擎]

    B --&gt; F[交互式地图&lt;br/&gt;Folium + OpenStreetMap]
    B --&gt; G[城市搜索&lt;br/&gt;Nominatim 地理编码]

    C --&gt; H[Open-Meteo API&lt;br/&gt;天气 + 空气质量]
    C --&gt; I[数据处理&lt;br/&gt;Pandas DataFrame]

    D --&gt; J[ModelScope API&lt;br/&gt;DeepSeek-V3.2 AI]
    D --&gt; K[智能分析&lt;br/&gt;天气建议]

    E --&gt; L[Altair 图表&lt;br/&gt;温度趋势]
    E --&gt; M[数据表格&lt;br/&gt;天气详情]

    F --&gt; A
    G --&gt; A
    I --&gt; E
    K --&gt; A
</pre>
</div>
<p></p><figcaption> 天气应用架构</figcaption> </figure><p></p>
</div>
</div>
</div>
<section id="技术栈" class="level3">
<h3 class="anchored" data-anchor-id="技术栈">技术栈</h3>
<ul>
<li><strong>前端框架</strong>：Streamlit，用于快速开发 Web 应用程序</li>
<li><strong>地图</strong>：Folium 配合 OpenStreetMap 图层，实现交互式位置选择</li>
<li><strong>数据可视化</strong>：Altair，用于专业的图表和图形</li>
<li><strong>API 集成</strong>：Open-Meteo，获取天气和空气质量数据</li>
<li><strong>AI 服务</strong>：通过 ModelScope API 使用 DeepSeek-V3.2 进行智能分析</li>
<li><strong>地理编码</strong>：Nominatim，用于地址与坐标的转换</li>
<li><strong>国际化</strong>：自定义语言系统，支持中英文切换</li>
</ul>
</section>
</section>
<section id="快速上手" class="level2">
<h2 class="anchored" data-anchor-id="快速上手">快速上手</h2>
<section id="环境要求与安装" class="level3">
<h3 class="anchored" data-anchor-id="环境要求与安装">环境要求与安装</h3>
<p>在深入代码之前，让我们先搭建好开发环境：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1. 克隆仓库</span></span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">git</span> clone <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>your-repo-url<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb1-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">cd</span> weather_trend</span>
<span id="cb1-4"></span>
<span id="cb1-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 2. 安装所需软件包</span></span>
<span id="cb1-6"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pip</span> install streamlit pandas requests altair folium streamlit-folium geopy python-dotenv openai</span>
<span id="cb1-7"></span>
<span id="cb1-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 3. 为 AI 功能设置环境变量</span></span>
<span id="cb1-9"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">echo</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"modelscope=您的 API 密钥"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> .env</span></code></pre></div></div>
</section>
<section id="核心依赖项说明" class="level3">
<h3 class="anchored" data-anchor-id="核心依赖项说明">核心依赖项说明</h3>
<ul>
<li><strong>streamlit</strong>：具备响应式 UI 组件的 Web 应用框架</li>
<li><strong>pandas</strong>：用于天气数据集的数据操作和分析</li>
<li><strong>requests</strong>：用于 API 通信的 HTTP 客户端</li>
<li><strong>altair</strong>：声明式统计可视化库</li>
<li><strong>folium + streamlit-folium</strong>：交互式地图集成</li>
<li><strong>geopy</strong>：用于位置查找的地理编码服务</li>
<li><strong>python-dotenv</strong>：环境变量管理</li>
<li><strong>openai</strong>：AI 模型集成（与 ModelScope 兼容）</li>
</ul>
</section>
</section>
<section id="核心功能实现" class="level2">
<h2 class="anchored" data-anchor-id="核心功能实现">核心功能实现</h2>
<section id="带位置选择的交互式地图" class="level3">
<h3 class="anchored" data-anchor-id="带位置选择的交互式地图">1. 带位置选择的交互式地图</h3>
<p>地图功能允许用户点击任意位置并获取该地点的实时天气数据：</p>
<div id="e719b45f" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> folium</span>
<span id="cb2-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> streamlit_folium <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> st_folium</span>
<span id="cb2-3"></span>
<span id="cb2-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 创建以默认位置为中心的交互式地图</span></span>
<span id="cb2-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> create_interactive_map(lat<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">40.7128</span>, lon<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">74.0060</span>, zoom<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>):</span>
<span id="cb2-6">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""创建交互式 Folium 地图"""</span></span>
<span id="cb2-7">    m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> folium.Map(</span>
<span id="cb2-8">        location<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[lat, lon],</span>
<span id="cb2-9">        zoom_start<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>zoom,</span>
<span id="cb2-10">        tiles<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"OpenStreetMap"</span></span>
<span id="cb2-11">    )</span>
<span id="cb2-12"></span>
<span id="cb2-13">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 添加点击事件处理器以捕获坐标</span></span>
<span id="cb2-14">    m.add_child(folium.LatLngPopup())</span>
<span id="cb2-15"></span>
<span id="cb2-16">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> m</span>
<span id="cb2-17"></span>
<span id="cb2-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 在 Streamlit 中显示地图</span></span>
<span id="cb2-19"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'map_data'</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> st.session_state:</span>
<span id="cb2-20">    st.session_state.map_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb2-21"></span>
<span id="cb2-22">map_object <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> create_interactive_map()</span>
<span id="cb2-23">st_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> st_folium(map_object, width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">700</span>, height<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span>)</span>
<span id="cb2-24"></span>
<span id="cb2-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 捕获点击处的坐标</span></span>
<span id="cb2-26"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> st_data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'last_clicked'</span>]:</span>
<span id="cb2-27">    lat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> st_data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'last_clicked'</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'lat'</span>]</span>
<span id="cb2-28">    lon <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> st_data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'last_clicked'</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'lng'</span>]</span>
<span id="cb2-29">    st.session_state.clicked_location <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (lat, lon)</span>
<span id="cb2-30">    get_weather_for_coordinates(lat, lon)</span></code></pre></div></div>
</details>
</div>
<p><strong>关键特性：</strong> - <strong>点击选择</strong>：用户可以点击地图上的任何地方 - <strong>缩放控制</strong>：标准的地图导航功能 - <strong>响应式设计</strong>：适应不同的屏幕尺寸 - <strong>坐标捕获</strong>：自动提取所选位置的信息</p>
</section>
<section id="双语城市搜索系统" class="level3">
<h3 class="anchored" data-anchor-id="双语城市搜索系统">2. 双语城市搜索系统</h3>
<p>此应用支持中英文城市名称，并具备智能的回退机制：</p>
<div id="bb7ce36c" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> re</span>
<span id="cb3-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> geopy.geocoders <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Nominatim</span>
<span id="cb3-3"></span>
<span id="cb3-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 扩展的中文字符检测</span></span>
<span id="cb3-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> contains_chinese(text):</span>
<span id="cb3-6">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""检查文本是否包含中文字符，包括 CJK 统一汉字"""</span></span>
<span id="cb3-7">    chinese_pattern <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> re.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">compile</span>(</span>
<span id="cb3-8">        <span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r"</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">[</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\u4e00</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">-</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\u9fff\u3400</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">-</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\u4dbf\U00020000</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">-</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\U0002a6df\U0002a700</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">-</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\U0002b73f</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">]</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb3-9">    )</span>
<span id="cb3-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">bool</span>(chinese_pattern.search(text))</span>
<span id="cb3-11"></span>
<span id="cb3-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 中文城市映射，以获得更好的解析效果</span></span>
<span id="cb3-13">CHINESE_CITY_MAPPING <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb3-14">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"纽约"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"New York"</span>,</span>
<span id="cb3-15">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"东京"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Tokyo"</span>,</span>
<span id="cb3-16">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"伦敦"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"London"</span>,</span>
<span id="cb3-17">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"巴黎"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Paris"</span>,</span>
<span id="cb3-18">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"洛杉矶"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Los Angeles"</span>,</span>
<span id="cb3-19">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ... 更多映射</span></span>
<span id="cb3-20">}</span>
<span id="cb3-21"></span>
<span id="cb3-22"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_coordinates_for_city(city_name):</span>
<span id="cb3-23">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""获取城市坐标，支持多语言"""</span></span>
<span id="cb3-24">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 检查中文城市名称映射</span></span>
<span id="cb3-25">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> contains_chinese(city_name) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> city_name <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> CHINESE_CITY_MAPPING:</span>
<span id="cb3-26">        city_name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> CHINESE_CITY_MAPPING[city_name]</span>
<span id="cb3-27"></span>
<span id="cb3-28">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 对城市进行地理编码</span></span>
<span id="cb3-29">    geolocator <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Nominatim(user_agent<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"weather_app"</span>)</span>
<span id="cb3-30">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb3-31">        location <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> geolocator.geocode(city_name)</span>
<span id="cb3-32">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> (location.latitude, location.longitude) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> location <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb3-33">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span>:</span>
<span id="cb3-34">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span></code></pre></div></div>
</details>
</div>
<p><strong>双语特性：</strong> - <strong>中文字符检测</strong>：针对 CJK 字符的高级正则模式 - <strong>城市名称映射</strong>：主要城市的翻译数据库 - <strong>错误处理</strong>：当地理编码失败时保持系统稳定 - <strong>Unicode 支持</strong>：完整支持国际化字符</p>
</section>
<section id="天气数据集成" class="level3">
<h3 class="anchored" data-anchor-id="天气数据集成">3. 天气数据集成</h3>
<p>该应用程序从 Open-Meteo API 获取全面的天气数据：</p>
<div id="d8752498" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> requests</span>
<span id="cb4-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb4-3"></span>
<span id="cb4-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_weather_data(latitude, longitude):</span>
<span id="cb4-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""获取 12 天的天气数据（7 天历史 + 5 天预报）"""</span></span>
<span id="cb4-6"></span>
<span id="cb4-7">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># API 端点配置</span></span>
<span id="cb4-8">    url <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://api.open-meteo.com/v1/forecast"</span></span>
<span id="cb4-9">    params <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb4-10">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'latitude'</span>: latitude,</span>
<span id="cb4-11">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'longitude'</span>: longitude,</span>
<span id="cb4-12">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'daily'</span>: [</span>
<span id="cb4-13">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'temperature_2m_max'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'temperature_2m_min'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'temperature_2m_mean'</span>,</span>
<span id="cb4-14">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'weathercode'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'windspeed_10m_max'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'precipitation_probability_max'</span>,</span>
<span id="cb4-15">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'pm10'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'pm2_5'</span></span>
<span id="cb4-16">        ],</span>
<span id="cb4-17">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'timezone'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'auto'</span>,</span>
<span id="cb4-18">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'past_days'</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 获取历史数据</span></span>
<span id="cb4-19">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'forecast_days'</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 获取未来预报</span></span>
<span id="cb4-20">    }</span>
<span id="cb4-21"></span>
<span id="cb4-22">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb4-23">        response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> requests.get(url, params<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>params, timeout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb4-24">        response.raise_for_status()</span>
<span id="cb4-25"></span>
<span id="cb4-26">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 处理响应数据</span></span>
<span id="cb4-27">        data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> response.json()</span>
<span id="cb4-28">        df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> process_weather_data(data)</span>
<span id="cb4-29"></span>
<span id="cb4-30">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> df</span>
<span id="cb4-31"></span>
<span id="cb4-32">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> requests.RequestException <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> e:</span>
<span id="cb4-33">        st.error(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"API 请求失败: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>e<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb4-34">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb4-35"></span>
<span id="cb4-36"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> process_weather_data(data):</span>
<span id="cb4-37">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""将 API 响应转换为结构化 DataFrame"""</span></span>
<span id="cb4-38">    daily_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'daily'</span>]</span>
<span id="cb4-39"></span>
<span id="cb4-40">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 创建日期范围（历史 + 未来）</span></span>
<span id="cb4-41">    dates <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.date_range(</span>
<span id="cb4-42">        start<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>pd.to_datetime(daily_data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'time'</span>][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]),</span>
<span id="cb4-43">        periods<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(daily_data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'time'</span>]),</span>
<span id="cb4-44">        freq<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'D'</span></span>
<span id="cb4-45">    )</span>
<span id="cb4-46"></span>
<span id="cb4-47">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 构建 DataFrame</span></span>
<span id="cb4-48">    df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.DataFrame({</span>
<span id="cb4-49">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'date'</span>: dates,</span>
<span id="cb4-50">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'temperature_max'</span>: daily_data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'temperature_2m_max'</span>],</span>
<span id="cb4-51">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'temperature_min'</span>: daily_data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'temperature_2m_min'</span>],</span>
<span id="cb4-52">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'temperature_mean'</span>: daily_data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'temperature_2m_mean'</span>],</span>
<span id="cb4-53">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'weather_code'</span>: daily_data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'weathercode'</span>],</span>
<span id="cb4-54">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'wind_speed_max'</span>: daily_data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'windspeed_10m_max'</span>],</span>
<span id="cb4-55">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'rain_probability'</span>: daily_data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'precipitation_probability_max'</span>],</span>
<span id="cb4-56">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'pm2_5'</span>: daily_data.get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'pm2_5'</span>, [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(dates))</span>
<span id="cb4-57">    })</span>
<span id="cb4-58"></span>
<span id="cb4-59">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 添加衍生列</span></span>
<span id="cb4-60">    df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'is_today'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'date'</span>].dt.date <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> pd.Timestamp.now().date()</span>
<span id="cb4-61">    df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'is_future'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'date'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> pd.Timestamp.now()</span>
<span id="cb4-62"></span>
<span id="cb4-63">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> df</span></code></pre></div></div>
</details>
</div>
<p><strong>数据处理特性：</strong> - <strong>历史 + 预报</strong>：7 天过去 + 5 天未来 - <strong>空气质量集成</strong>：PM2.5 和 PM10 数据 - <strong>指标衍生</strong>：今日检测和未来趋势分析 - <strong>错误管理</strong>：健壮的 API 错误处理机制</p>
</section>
<section id="高级数据可视化" class="level3">
<h3 class="anchored" data-anchor-id="高级数据可视化">4. 高级数据可视化</h3>
<p>温度趋势图，清晰地区分了历史数据和预报数据：</p>
<div id="3d7325f3" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> altair <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> alt</span>
<span id="cb5-2"></span>
<span id="cb5-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> create_temperature_chart(weather_df):</span>
<span id="cb5-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""创建交互式温度趋势图"""</span></span>
<span id="cb5-5"></span>
<span id="cb5-6">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 包含温度线的基准图表</span></span>
<span id="cb5-7">    base_chart <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> alt.Chart(weather_df).mark_line(</span>
<span id="cb5-8">        point<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb5-9">        strokeWidth<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,</span>
<span id="cb5-10">        opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span></span>
<span id="cb5-11">    ).encode(</span>
<span id="cb5-12">        x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>alt.X(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'date:T'</span>, title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'日期'</span>),</span>
<span id="cb5-13">        y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>alt.Y(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'temperature_mean:Q'</span>, title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'温度 (°C)'</span>, scale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>alt.Scale(domain<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[weather_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'temperature_min'</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">min</span>()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, weather_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'temperature_max'</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>]))</span>
<span id="cb5-14">    ).properties(</span>
<span id="cb5-15">        width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">800</span>,</span>
<span id="cb5-16">        height<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">400</span>,</span>
<span id="cb5-17">        title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'温度趋势图'</span></span>
<span id="cb5-18">    )</span>
<span id="cb5-19"></span>
<span id="cb5-20">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 历史数据（实线）</span></span>
<span id="cb5-21">    historical_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> weather_df[weather_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'is_future'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>]</span>
<span id="cb5-22">    historical_line <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> base_chart.transform_filter(</span>
<span id="cb5-23">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'datum.is_future == false'</span></span>
<span id="cb5-24">    ).encode(</span>
<span id="cb5-25">        color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>alt.value(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'blue'</span>),</span>
<span id="cb5-26">        strokeDash<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>alt.value([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 实线</span></span>
<span id="cb5-27">    )</span>
<span id="cb5-28"></span>
<span id="cb5-29">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 未来预报（虚线）</span></span>
<span id="cb5-30">    future_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> weather_df[weather_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'is_future'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>]</span>
<span id="cb5-31">    future_line <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> base_chart.transform_filter(</span>
<span id="cb5-32">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'datum.is_future == true'</span></span>
<span id="cb5-33">    ).encode(</span>
<span id="cb5-34">        color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>alt.value(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'red'</span>),</span>
<span id="cb5-35">        strokeDash<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>alt.value([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>])  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 虚线</span></span>
<span id="cb5-36">    )</span>
<span id="cb5-37"></span>
<span id="cb5-38">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 今日指示线</span></span>
<span id="cb5-39">    today_line <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> alt.Chart(pd.DataFrame({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'x'</span>: [pd.Timestamp.now()]})).mark_rule(</span>
<span id="cb5-40">        strokeDash<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>],</span>
<span id="cb5-41">        stroke<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'green'</span>,</span>
<span id="cb5-42">        strokeWidth<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb5-43">    ).encode(x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'x:T'</span>)</span>
<span id="cb5-44"></span>
<span id="cb5-45">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> (historical_line <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> future_line <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> today_line).resolve_scale(color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'independent'</span>)</span></code></pre></div></div>
</details>
</div>
<p><strong>可视化特性：</strong> - <strong>线条样式区分</strong>：实线（历史）对比虚线（预报） - <strong>今日指示器</strong>：对当前日期的视觉标记 - <strong>颜色编码</strong>：蓝色代表过去，红色代表未来 - <strong>交互式提示</strong>：悬停时显示数据点信息</p>
</section>
<section id="空气质量监测" class="level3">
<h3 class="anchored" data-anchor-id="空气质量监测">5. 空气质量监测</h3>
<p>符合 EPA 标准的 PM2.5 水平颜色编码：</p>
<div id="bdf36778" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_air_quality_level(pm25_value):</span>
<span id="cb6-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""基于美国 EPA PM2.5 标准获取空气质量等级"""</span></span>
<span id="cb6-3"></span>
<span id="cb6-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> pm25_value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>:</span>
<span id="cb6-5">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {</span>
<span id="cb6-6">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'level'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'优'</span>,</span>
<span id="cb6-7">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'color'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'#00e400'</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 深绿</span></span>
<span id="cb6-8">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'text_color'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'white'</span>,</span>
<span id="cb6-9">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'icon'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'🟢'</span></span>
<span id="cb6-10">        }</span>
<span id="cb6-11">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> pm25_value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">35.4</span>:</span>
<span id="cb6-12">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {</span>
<span id="cb6-13">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'level'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'良'</span>,</span>
<span id="cb6-14">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'color'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'#ffff00'</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 浅黄</span></span>
<span id="cb6-15">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'text_color'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'black'</span>,</span>
<span id="cb6-16">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'icon'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'🟢'</span></span>
<span id="cb6-17">        }</span>
<span id="cb6-18">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> pm25_value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">55.4</span>:</span>
<span id="cb6-19">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {</span>
<span id="cb6-20">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'level'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'轻度污染'</span>,</span>
<span id="cb6-21">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'color'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'#ff7e00'</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 橙黄</span></span>
<span id="cb6-22">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'text_color'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'black'</span>,</span>
<span id="cb6-23">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'icon'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'🟡'</span></span>
<span id="cb6-24">        }</span>
<span id="cb6-25">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> pm25_value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">150.4</span>:</span>
<span id="cb6-26">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {</span>
<span id="cb6-27">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'level'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'中度污染'</span>,</span>
<span id="cb6-28">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'color'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'#ff0000'</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 红色</span></span>
<span id="cb6-29">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'text_color'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'white'</span>,</span>
<span id="cb6-30">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'icon'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'🟠'</span></span>
<span id="cb6-31">        }</span>
<span id="cb6-32">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> pm25_value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">250.4</span>:</span>
<span id="cb6-33">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {</span>
<span id="cb6-34">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'level'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'重度污染'</span>,</span>
<span id="cb6-35">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'color'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'#8f3f97'</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 紫色</span></span>
<span id="cb6-36">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'text_color'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'white'</span>,</span>
<span id="cb6-37">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'icon'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'🔴'</span></span>
<span id="cb6-38">        }</span>
<span id="cb6-39">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb6-40">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {</span>
<span id="cb6-41">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'level'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'严重污染'</span>,</span>
<span id="cb6-42">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'color'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'#7e0023'</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 深褐</span></span>
<span id="cb6-43">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'text_color'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'white'</span>,</span>
<span id="cb6-44">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'icon'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'⚫'</span></span>
<span id="cb6-45">        }</span>
<span id="cb6-46"></span>
<span id="cb6-47"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> display_air_quality_badge(pm25_value):</span>
<span id="cb6-48">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""显示带视觉指示的空气质量徽章"""</span></span>
<span id="cb6-49">    aq_info <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_air_quality_level(pm25_value)</span>
<span id="cb6-50"></span>
<span id="cb6-51">    st.markdown(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"""</span></span>
<span id="cb6-52"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">    &lt;div style="background-color: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>aq_info[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'color'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">; color: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>aq_info[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'text_color'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-53"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">                padding: 10px; border-radius: 5px; text-align: center; margin: 5px 0;"&gt;</span></span>
<span id="cb6-54"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">        &lt;strong&gt;</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>aq_info[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'icon'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> PM2.5: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>pm25_value<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> μg/m³&lt;/strong&gt;&lt;br&gt;</span></span>
<span id="cb6-55"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">        &lt;small&gt;</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>aq_info[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'level'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">&lt;/small&gt;</span></span>
<span id="cb6-56"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">    &lt;/div&gt;</span></span>
<span id="cb6-57"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">    """</span>, unsafe_allow_html<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span></code></pre></div></div>
</details>
</div>
<p><strong>空气质量功能特性：</strong> - <strong>EPA 标准</strong>：基于美国环境保护署的标准 - <strong>视觉指示器</strong>：带图标的颜色编码徽章 - <strong>可访问性</strong>：高对比度色值确保可读性 - <strong>科普性</strong>：通过等级说明帮助用户理解</p>
</section>
</section>
<section id="ai-驱动的天气智能" class="level2">
<h2 class="anchored" data-anchor-id="ai-驱动的天气智能">AI 驱动的天气智能</h2>
<section id="集成-deepseek-ai" class="level3">
<h3 class="anchored" data-anchor-id="集成-deepseek-ai">集成 DeepSeek AI</h3>
<p>本项目最具创新性的功能是使用 ModelScope 平台上的 DeepSeek-V3.2 模型提供 AI 天气分析：</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://jcwinning.github.io/LandingPage/posts/weather-trend/images/1.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption>AI 天气分析建议</figcaption>
</figure>
</div>
<div id="aa6bb07f" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> OpenAI</span>
<span id="cb7-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb7-3"></span>
<span id="cb7-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 初始化 ModelScope 的 AI 客户端</span></span>
<span id="cb7-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> init_ai_client():</span>
<span id="cb7-6">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""初始化用于 ModelScope API 的 OpenAI 客户端"""</span></span>
<span id="cb7-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> OpenAI(</span>
<span id="cb7-8">        base_url<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://dashscope.aliyuncs.com/compatible-mode/v1"</span>,</span>
<span id="cb7-9">        api_key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>os.getenv(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"modelscope"</span>),</span>
<span id="cb7-10">    )</span>
<span id="cb7-11"></span>
<span id="cb7-12"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> generate_weather_insights(weather_df, location_name, language<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"en"</span>):</span>
<span id="cb7-13">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""生成 AI 驱动的天气分析建议"""</span></span>
<span id="cb7-14"></span>
<span id="cb7-15">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 准备用于 AI 分析的天气数据</span></span>
<span id="cb7-16">    today_index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> weather_df[weather_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'is_today'</span>]].index[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">any</span>(weather_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'is_today'</span>]) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb7-17">    historical_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> weather_df.iloc[:today_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 截至今日</span></span>
<span id="cb7-18">    future_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> weather_df.iloc[today_index:]  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 今日起</span></span>
<span id="cb7-19"></span>
<span id="cb7-20">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 为 AI 创建天气摘要</span></span>
<span id="cb7-21">    weather_summary <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"""</span></span>
<span id="cb7-22"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">    地点: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>location_name<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb7-23"></span>
<span id="cb7-24"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">    历史天气 (过去 </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(historical_data)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> 天):</span></span>
<span id="cb7-25"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">    - 温度范围: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>historical_data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'temperature_min'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">min</span>()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">°C 到 </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>historical_data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'temperature_max'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">°C</span></span>
<span id="cb7-26"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">    - 平均温度: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>historical_data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'temperature_mean'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>mean()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">°C</span></span>
<span id="cb7-27"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">    - 空气质量范围: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>historical_data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'pm2_5'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">min</span>()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> 到 </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>historical_data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'pm2_5'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> PM2.5</span></span>
<span id="cb7-28"></span>
<span id="cb7-29"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">    天气预报 (未来 </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(future_data)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> 天):</span></span>
<span id="cb7-30"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">    - 温度范围: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>future_data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'temperature_min'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">min</span>()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">°C 到 </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>future_data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'temperature_max'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">°C</span></span>
<span id="cb7-31"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">    - 平均降雨概率: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>future_data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'rain_probability'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>mean()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.0f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">%</span></span>
<span id="cb7-32"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb7-33"></span>
<span id="cb7-34">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 根据语言生成提示词</span></span>
<span id="cb7-35">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> language <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"zh"</span>:</span>
<span id="cb7-36">        prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"""</span></span>
<span id="cb7-37"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">        基于以下天气数据，请提供简洁实用的天气建议（100-200字）：</span></span>
<span id="cb7-38"></span>
<span id="cb7-39"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">        </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>weather_summary<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb7-40"></span>
<span id="cb7-41"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">        请包括：</span></span>
<span id="cb7-42"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">        1. 天气模式分析</span></span>
<span id="cb7-43"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">        2. 穿衣建议</span></span>
<span id="cb7-44"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">        3. 户外活动建议</span></span>
<span id="cb7-45"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">        4. 健康注意事项（如空气质量相关）</span></span>
<span id="cb7-46"></span>
<span id="cb7-47"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">        请用中文回复，语气友好实用。</span></span>
<span id="cb7-48"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">        """</span></span>
<span id="cb7-49">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb7-50">        prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"""</span></span>
<span id="cb7-51"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">        Based on the following weather data, please provide concise and practical weather advice (100-200 words):</span></span>
<span id="cb7-52"></span>
<span id="cb7-53"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">        </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>weather_summary<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb7-54"></span>
<span id="cb7-55"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">        Please include:</span></span>
<span id="cb7-56"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">        1. Weather pattern analysis</span></span>
<span id="cb7-57"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">        2. Clothing recommendations</span></span>
<span id="cb7-58"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">        3. Outdoor activity suggestions</span></span>
<span id="cb7-59"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">        4. Health considerations (related to air quality if applicable)</span></span>
<span id="cb7-60"></span>
<span id="cb7-61"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">        Please respond in </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>language<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> with a friendly and practical tone.</span></span>
<span id="cb7-62"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">        """</span></span>
<span id="cb7-63"></span>
<span id="cb7-64">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb7-65">        client <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> init_ai_client()</span>
<span id="cb7-66">        response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> client.chat.completions.create(</span>
<span id="cb7-67">            model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"deepseek-ai/DeepSeek-V3"</span>,</span>
<span id="cb7-68">            messages<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"role"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"user"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"content"</span>: prompt}],</span>
<span id="cb7-69">            max_tokens<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span>,</span>
<span id="cb7-70">            temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span></span>
<span id="cb7-71">        )</span>
<span id="cb7-72"></span>
<span id="cb7-73">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> response.choices[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].message.content</span>
<span id="cb7-74"></span>
<span id="cb7-75">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">Exception</span> <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> e:</span>
<span id="cb7-76">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"AI 服务暂时不可用。错误信息: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(e)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb7-77"></span>
<span id="cb7-78"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 在 Streamlit 应用中</span></span>
<span id="cb7-79"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> st.button(get_text(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ai_button"</span>, language)):</span>
<span id="cb7-80">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> st.spinner(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"正在获取 AI 天气建议..."</span>):</span>
<span id="cb7-81">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'weather_df'</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> st.session_state <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'location_name'</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> st.session_state:</span>
<span id="cb7-82">            ai_insights <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> generate_weather_insights(</span>
<span id="cb7-83">                st.session_state.weather_df,</span>
<span id="cb7-84">                st.session_state.location_name,</span>
<span id="cb7-85">                language</span>
<span id="cb7-86">            )</span>
<span id="cb7-87">            st.markdown(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"### 🤖 AI 天气分析"</span>)</span>
<span id="cb7-88">            st.write(ai_insights)</span>
<span id="cb7-89">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb7-90">            st.warning(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"请先获取天气数据。"</span>)</span></code></pre></div></div>
</details>
</div>
<p><strong>AI 特性：</strong> - <strong>上下文感知分析</strong>：同时处理历史和预报数据 - <strong>多语言支持</strong>：AI 根据用户选择的语言回复 - <strong>实用建议</strong>：提供穿衣、活动和健康方面的见解 - <strong>容错处理</strong>：在 AI 服务不可用时优雅地提示</p>
</section>
<section id="ai-提示词工程" class="level3">
<h3 class="anchored" data-anchor-id="ai-提示词工程">AI 提示词工程</h3>
<p>AI 系统通过精心设计的提示词生成有价值的见解：</p>
<p><strong>提示词结构：</strong> 1. <strong>数据上下文</strong>：全面的天气统计信息 2. <strong>任务定义</strong>：明确的分析要求 3. <strong>输出格式</strong>：结构化的回复类别 4. <strong>语言适配</strong>：与 UI 语言保持一致</p>
<p><strong>建议类别：</strong> - <strong>天气模式分析</strong>：趋势和异常分析 - <strong>穿衣建议</strong>：实用的穿着指导 - <strong>活动建议</strong>：户外计划的推荐 - <strong>健康注意事项</strong>：空气质量及天气影响</p>
</section>
</section>
<section id="国际化系统" class="level2">
<h2 class="anchored" data-anchor-id="国际化系统">国际化系统</h2>
<section id="语言管理架构" class="level3">
<h3 class="anchored" data-anchor-id="语言管理架构">语言管理架构</h3>
<p>应用实现了一个全面的双语系统：</p>
<div id="f544aa0c" class="cell" data-execution_count="7">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># language.py - 翻译管理</span></span>
<span id="cb8-2">TRANSLATIONS <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb8-3">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"en"</span>: {</span>
<span id="cb8-4">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"app_title"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Weather Forecast App"</span>,</span>
<span id="cb8-5">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sidebar_header"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Weather Query"</span>,</span>
<span id="cb8-6">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"city_input_placeholder"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Enter a city name"</span>,</span>
<span id="cb8-7">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"get_weather_button"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Get Weather"</span>,</span>
<span id="cb8-8">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"weather_trends_title"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Weather Trends for"</span>,</span>
<span id="cb8-9">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ai_button"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"AI Weather Advice"</span>,</span>
<span id="cb8-10">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ... 更多翻译</span></span>
<span id="cb8-11">    },</span>
<span id="cb8-12">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"zh"</span>: {</span>
<span id="cb8-13">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"app_title"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"天气预报应用"</span>,</span>
<span id="cb8-14">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sidebar_header"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"天气查询"</span>,</span>
<span id="cb8-15">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"city_input_placeholder"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"输入城市名称"</span>,</span>
<span id="cb8-16">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"get_weather_button"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"获取天气"</span>,</span>
<span id="cb8-17">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"weather_trends_title"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"天气趋势"</span>,</span>
<span id="cb8-18">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ai_button"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"AI天气建议"</span>,</span>
<span id="cb8-19">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ... 更多翻译</span></span>
<span id="cb8-20">    }</span>
<span id="cb8-21">}</span>
<span id="cb8-22"></span>
<span id="cb8-23"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_text(key, language<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"en"</span>):</span>
<span id="cb8-24">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""获取指定键和语言的翻译文本"""</span></span>
<span id="cb8-25">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> TRANSLATIONS.get(language, {}).get(key, key)</span>
<span id="cb8-26"></span>
<span id="cb8-27"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_available_languages():</span>
<span id="cb8-28">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""获取可用的语言选项"""</span></span>
<span id="cb8-29">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"en"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"English"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"zh"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"中文"</span>}</span>
<span id="cb8-30"></span>
<span id="cb8-31"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 在主程序 (app.py) 中</span></span>
<span id="cb8-32"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> main():</span>
<span id="cb8-33">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 语言状态管理</span></span>
<span id="cb8-34">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'language'</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> st.session_state:</span>
<span id="cb8-35">        st.session_state.language <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"en"</span></span>
<span id="cb8-36"></span>
<span id="cb8-37">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 语言切换按钮</span></span>
<span id="cb8-38">    current_lang <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> st.session_state.language</span>
<span id="cb8-39">    available_langs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_available_languages()</span>
<span id="cb8-40"></span>
<span id="cb8-41">    col1, col2, col3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> st.columns([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>])</span>
<span id="cb8-42">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> col1:</span>
<span id="cb8-43">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> st.button(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"EN"</span>, disabled<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>current_lang<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"en"</span>):</span>
<span id="cb8-44">            st.session_state.language <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"en"</span></span>
<span id="cb8-45">            st.rerun()</span>
<span id="cb8-46"></span>
<span id="cb8-47">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> col2:</span>
<span id="cb8-48">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> st.button(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"中文"</span>, disabled<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>current_lang<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"zh"</span>):</span>
<span id="cb8-49">            st.session_state.language <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"zh"</span></span>
<span id="cb8-50">            st.rerun()</span>
<span id="cb8-51"></span>
<span id="cb8-52">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 在所有 UI 元素中使用当前语言</span></span>
<span id="cb8-53">    language <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> st.session_state.language</span>
<span id="cb8-54">    st.title(get_text(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"app_title"</span>, language))</span>
<span id="cb8-55">    st.sidebar.header(get_text(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sidebar_header"</span>, language))</span></code></pre></div></div>
</details>
</div>
<p><strong>国际化特性：</strong> - <strong>完整的 UI 翻译</strong>：本地化所有界面元素 - <strong>动态语言切换</strong>：语言更改时即时更新 UI - <strong>中文字符支持</strong>：完整的 Unicode 和 CJK 支持 - <strong>语境一致</strong>：AI 回复与 UI 语言相匹配</p>
</section>
</section>
<section id="高级-ui-组件" class="level2">
<h2 class="anchored" data-anchor-id="高级-ui-组件">高级 UI 组件</h2>
<section id="带视觉指示的天气数据表" class="level3">
<h3 class="anchored" data-anchor-id="带视觉指示的天气数据表">带视觉指示的天气数据表</h3>
<p>天气表结合了数据与视觉元素，方便用户快速理解：</p>
<div id="16638b34" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> create_weather_table(weather_df, language<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"en"</span>):</span>
<span id="cb9-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""创建增强的天气表，包含图标和颜色显示"""</span></span>
<span id="cb9-3"></span>
<span id="cb9-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 天气代码到 Emoji 的映射</span></span>
<span id="cb9-5">    WEATHER_ICONS <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb9-6">        <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"☀️"</span>,   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 晴</span></span>
<span id="cb9-7">        <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"⛅"</span>,   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 晴间多云</span></span>
<span id="cb9-8">        <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"☁️"</span>,   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 多云</span></span>
<span id="cb9-9">        <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"☁️"</span>,   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 阴</span></span>
<span id="cb9-10">        <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">45</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"🌫️"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 雾</span></span>
<span id="cb9-11">        <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"🌦️"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 阵雨</span></span>
<span id="cb9-12">        <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">51</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"🌧️"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 雨</span></span>
<span id="cb9-13">        <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">53</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"❄️"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 雪</span></span>
<span id="cb9-14">        <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">95</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"⛈️"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 雷阵雨</span></span>
<span id="cb9-15">    }</span>
<span id="cb9-16"></span>
<span id="cb9-17">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> format_weather_row(row):</span>
<span id="cb9-18">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""格式化单行天气情况并添加样式"""</span></span>
<span id="cb9-19">        date_str <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> row[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'date'</span>].strftime(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'%Y-%m-</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%d</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb9-20">        temp_range <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>row[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'temperature_min'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">° ~ </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>row[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'temperature_max'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">°"</span></span>
<span id="cb9-21">        weather_icon <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> WEATHER_ICONS.get(row[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'weather_code'</span>], <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"🌡️"</span>)</span>
<span id="cb9-22"></span>
<span id="cb9-23">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 空气质量徽章</span></span>
<span id="cb9-24">        aq_info <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_air_quality_level(row[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'pm2_5'</span>])</span>
<span id="cb9-25">        aq_badge <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'&lt;span style="background-color: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>aq_info[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"color"</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">; color: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>aq_info[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text_color"</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">; padding: 2px 6px; border-radius: 3px; font-size: 0.8em;"&gt;</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>aq_info[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"icon"</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>row[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pm2_5"</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.0f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">&lt;/span&gt;'</span></span>
<span id="cb9-26"></span>
<span id="cb9-27">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 降雨概率指示</span></span>
<span id="cb9-28">        rain_color <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'red'</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> row[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'rain_probability'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">80</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'orange'</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> row[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'rain_probability'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'gray'</span></span>
<span id="cb9-29">        rain_indicator <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'&lt;span style="color: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>rain_color<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">;"&gt;🔴 </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>row[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rain_probability"</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.0f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">%&lt;/span&gt;'</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> row[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'rain_probability'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'&lt;span style="color: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>rain_color<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">;"&gt;🟢 </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>row[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rain_probability"</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.0f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">%&lt;/span&gt;'</span></span>
<span id="cb9-30"></span>
<span id="cb9-31">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># “今日”行高亮显示</span></span>
<span id="cb9-32">        row_style <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'font-size: 1.2em; font-weight: bold;'</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> row[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'is_today'</span>] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span></span>
<span id="cb9-33"></span>
<span id="cb9-34">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {</span>
<span id="cb9-35">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'日期'</span>: <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'&lt;span style="</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>row_style<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"&gt;</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>date_str<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">&lt;/span&gt;'</span>,</span>
<span id="cb9-36">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'天气'</span>: <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'&lt;span style="</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>row_style<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"&gt;</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>weather_icon<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">&lt;/span&gt;'</span>,</span>
<span id="cb9-37">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'温度'</span>: <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'&lt;span style="</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>row_style<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"&gt;</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>temp_range<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">&lt;/span&gt;'</span>,</span>
<span id="cb9-38">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'风速'</span>: <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'&lt;span style="</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>row_style<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"&gt;💨 </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>row[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"wind_speed_max"</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> km/h&lt;/span&gt;'</span>,</span>
<span id="cb9-39">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'降雨'</span>: rain_indicator,</span>
<span id="cb9-40">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'空气质量'</span>: aq_badge</span>
<span id="cb9-41">        }</span>
<span id="cb9-42"></span>
<span id="cb9-43">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 对所有行应用格式化</span></span>
<span id="cb9-44">    formatted_rows <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [format_weather_row(row) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> _, row <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> weather_df.iterrows()]</span>
<span id="cb9-45"></span>
<span id="cb9-46">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> pd.DataFrame(formatted_rows)</span>
<span id="cb9-47"></span>
<span id="cb9-48"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 在 Streamlit 中显示</span></span>
<span id="cb9-49">st.markdown(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"### 📊 天气详情"</span>)</span>
<span id="cb9-50">st.dataframe(</span>
<span id="cb9-51">    create_weather_table(weather_df, language),</span>
<span id="cb9-52">    width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1200</span>,</span>
<span id="cb9-53">    hide_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb9-54">    unsafe_allow_html<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span></span>
<span id="cb9-55">)</span></code></pre></div></div>
</details>
</div>
<p><strong>表格特性：</strong> - <strong>天气图标</strong>：Emoji 表达方式，直观易懂 - <strong>今日高亮</strong>：对当天日期使用更大、加粗的文字 - <strong>空气质量徽章</strong>：颜色编码的 PM2.5 指标 - <strong>降雨概率</strong>：基于 Material Design 色系的视觉指示 - <strong>响应式布局</strong>：适应各种屏幕宽度</p>
</section>
</section>
<section id="部署与生产" class="level2">
<h2 class="anchored" data-anchor-id="部署与生产">部署与生产</h2>
<section id="环境配置" class="level3">
<h3 class="anchored" data-anchor-id="环境配置">环境配置</h3>
<p>在生产环境部署时，请配置环境变量：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># .env 文件</span></span>
<span id="cb10-2"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">modelscope</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>您的 <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">API</span> 密钥</span>
<span id="cb10-3"></span>
<span id="cb10-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 其他生产环境设置</span></span>
<span id="cb10-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 考虑频率限制、缓存机制和监控</span></span></code></pre></div></div>
</section>
<section id="部署到-streamlit-cloud" class="level3">
<h3 class="anchored" data-anchor-id="部署到-streamlit-cloud">部署到 Streamlit Cloud</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1. 安装 Streamlit CLI</span></span>
<span id="cb11-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pip</span> install streamlit</span>
<span id="cb11-3"></span>
<span id="cb11-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 2. 登录 Streamlit</span></span>
<span id="cb11-5"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">streamlit</span> login</span>
<span id="cb11-6"></span>
<span id="cb11-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 3. 部署到 Streamlit Cloud</span></span>
<span id="cb11-8"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">streamlit</span> run app.py  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 首先在本地测试</span></span>
<span id="cb11-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 然后通过 cloud.streamlit.io 或 CLI 进行部署</span></span></code></pre></div></div>
</section>
<section id="docker-部署-可选" class="level3">
<h3 class="anchored" data-anchor-id="docker-部署-可选">Docker 部署 (可选)</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode dockerfile code-with-copy"><code class="sourceCode dockerfile"><span id="cb12-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">FROM</span> python:3.9-slim</span>
<span id="cb12-2"></span>
<span id="cb12-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">WORKDIR</span> /app</span>
<span id="cb12-4"></span>
<span id="cb12-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">COPY</span> requirements.txt .</span>
<span id="cb12-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">RUN</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pip</span> install <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-r</span> requirements.txt</span>
<span id="cb12-7"></span>
<span id="cb12-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">COPY</span> . .</span>
<span id="cb12-9"></span>
<span id="cb12-10"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">EXPOSE</span> 8501</span>
<span id="cb12-11"></span>
<span id="cb12-12"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">CMD</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"streamlit"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"run"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"app.py"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"--server.address"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"0.0.0.0"</span>]</span></code></pre></div></div>
</section>
</section>
<section id="性能优化" class="level2">
<h2 class="anchored" data-anchor-id="性能优化">性能优化</h2>
<section id="缓存策略" class="level3">
<h3 class="anchored" data-anchor-id="缓存策略">缓存策略</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@st.cache_data</span>(ttl<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3600</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 缓存 1 小时</span></span>
<span id="cb13-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_weather_data_cached(lat, lon):</span>
<span id="cb13-3">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""缓存天气数据获取操作"""</span></span>
<span id="cb13-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> get_weather_data(lat, lon)</span>
<span id="cb13-5"></span>
<span id="cb13-6"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@st.cache_resource</span></span>
<span id="cb13-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_ai_client():</span>
<span id="cb13-8">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""缓存 AI 客户端初始化"""</span></span>
<span id="cb13-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> init_ai_client()</span>
<span id="cb13-10"></span>
<span id="cb13-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 缓存地图生成</span></span>
<span id="cb13-12"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@st.cache_data</span>(ttl<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3600</span>)</span>
<span id="cb13-13"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> create_map_cached(lat, lon):</span>
<span id="cb13-14">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""缓存地图创建操作"""</span></span>
<span id="cb13-15">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> create_interactive_map(lat, lon)</span></code></pre></div></div>
</section>
<section id="错误处理与容错" class="level3">
<h3 class="anchored" data-anchor-id="错误处理与容错">错误处理与容错</h3>
<div id="b57baa86" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> robust_api_call(func, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>args, max_retries<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>kwargs):</span>
<span id="cb14-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""带重试逻辑的高可用 API 调用"""</span></span>
<span id="cb14-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> attempt <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(max_retries):</span>
<span id="cb14-4">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb14-5">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> func(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>args, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>kwargs)</span>
<span id="cb14-6">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> requests.exceptions.Timeout:</span>
<span id="cb14-7">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> attempt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> max_retries <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:</span>
<span id="cb14-8">                st.error(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"天气服务暂时不可用"</span>)</span>
<span id="cb14-9">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb14-10">            time.sleep(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span> attempt)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 指数退避重试</span></span>
<span id="cb14-11">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> requests.exceptions.RequestException <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> e:</span>
<span id="cb14-12">            st.error(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"API 错误: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>e<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb14-13">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span></code></pre></div></div>
</details>
</div>
<ul>
<li><strong>数据可视化</strong>：专业图表与交互式地图。</li>
<li><strong>AI 集成</strong>：将语言模型实际应用于数据分析。</li>
<li><strong>国际化</strong>：完整的双语支持。</li>
<li><strong>生产就绪</strong>：包含错误处理、缓存和性能优化。</li>
</ul>
<p>无论您是在构建天气应用、数据看板还是 AI 驱动的工具，该项目都为创建复杂且用户友好的应用程序提供了坚实的基础。</p>


<!-- -->

</section>
</section>
</section>

 ]]></description>
  <category>Python</category>
  <category>Streamlit</category>
  <category>AI</category>
  <category>tutorial</category>
  <guid>https://jcwinning.github.io/LandingPage/posts/weather-trend/</guid>
  <pubDate>Wed, 05 Nov 2025 16:00:00 GMT</pubDate>
  <media:content url="https://jcwinning.github.io/LandingPage/posts/weather-trend/images/0.png" medium="image" type="image/png" height="83" width="144"/>
</item>
<item>
  <title>结合 AI 分析的 Shiny 和 Streamlit 体重追踪看板</title>
  <dc:creator>Tony D</dc:creator>
  <link>https://jcwinning.github.io/LandingPage/posts/weight-tracking/</link>
  <description><![CDATA[ 





<section id="项目概览" class="level1">
<h1>项目概览</h1>
<p>体重追踪应用是一款全面的 R Shiny Web 应用程序，可帮助用户监测体重趋势、计算 BMI，并获得基于 AI 的个性化健康建议。本项目的一个特别之处在于它集成了多个 AI 服务商，并具备实时数据同步功能。</p>
<p>在线演示: <a href="https://jcflyingco.shinyapps.io/weight_tracking/">https://jcflyingco.shinyapps.io/weight_tracking/</a></p>
<p>Github: <a href="https://github.com/JCwinning/weight_tracking">https://github.com/JCwinning/weight_tracking</a></p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" aria-controls="tabset-1-1" aria-selected="true" href="">体重趋势图</a></li><li class="nav-item"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" aria-controls="tabset-1-2" aria-selected="false" href="">AI 反馈</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" aria-labelledby="tabset-1-1-tab">
<p><img src="https://jcwinning.github.io/LandingPage/posts/weight-tracking/images/0.png" class="img-fluid" style="width:100.0%"></p>
</div>
<div id="tabset-1-2" class="tab-pane" aria-labelledby="tabset-1-2-tab">
<p><img src="https://jcwinning.github.io/LandingPage/posts/weight-tracking/images/3.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
</div>
<section id="核心功能" class="level2">
<h2 class="anchored" data-anchor-id="核心功能">核心功能</h2>
<section id="健康监测能力" class="level3">
<h3 class="anchored" data-anchor-id="健康监测能力">健康监测能力</h3>
<ul>
<li><strong>体重追踪</strong>：交互式的体重记录和随时间变化的可视化。</li>
<li><strong>BMI 计算器</strong>：自动计算 BMI 并与健康范围进行对比。</li>
<li><strong>单位转换</strong>：在公制（kg/cm）和英制（磅/英寸）之间无缝切换。</li>
<li><strong>实时更新</strong>：当修改 Excel 文件时，数据会自动刷新。</li>
</ul>
</section>
<section id="高级技术特性" class="level3">
<h3 class="anchored" data-anchor-id="高级技术特性">高级技术特性</h3>
<ul>
<li><strong>多服务商 AI 集成</strong>：支持 Modelscope、OpenRouter、Gemini 和 OpenAI 兼容的 API。</li>
<li><strong>完善的国际化</strong>：完整的英文/中文双语支持，包含 50+ 个翻译字段。</li>
<li><strong>实时文件监控</strong>：当数据文件发生变化时，UI 会自动更新。</li>
<li><strong>交互式可视化</strong>：具备缩放、平移和悬停功能的 Plotly 图表。</li>
<li><strong>数据管理</strong>：支持 Excel 导入/导出，并具备响应式数据更新。</li>
</ul>
</section>
</section>
<section id="技术架构" class="level2">
<h2 class="anchored" data-anchor-id="技术架构">技术架构</h2>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>

</div>
<p></p><figcaption> 体重追踪应用架构</figcaption> </figure><p></p>
</div>
</div>
</div>
<section id="技术栈" class="level3">
<h3 class="anchored" data-anchor-id="技术栈">技术栈</h3>
<ul>
<li><strong>主要框架</strong>：R Shiny（经典架构）</li>
<li><strong>UI 组件</strong>：基于 Bootstrap 的响应式设计，使用 <code>bslib</code></li>
<li><strong>数据处理</strong>：<code>tidyverse</code>, <code>readxl</code>, <code>openxlsx</code></li>
<li><strong>可视化</strong>：使用 <code>plotly</code> 实现交互式图表</li>
<li><strong>AI 集成</strong>：使用 <code>ellmer</code> 支持多服务商 AI</li>
</ul>
</section>
<section id="文件结构分析" class="level3">
<h3 class="anchored" data-anchor-id="文件结构分析">文件结构分析</h3>
<pre><code>weight_tracking/
├── ui.R              # 包含控件的多标签界面
├── server.R          # 服务器逻辑和数据管理
├── global.R          # URL 书签配置
├── ai_config.R       # 统一的 AI 服务商管理
├── language.R        # 完整的国际化系统
├── weight.xlsx       # 主要数据存储
├── www/logo.png      # 应用品牌标识
└── images/           # 应用截图</code></pre>
</section>
</section>
<section id="数据管理系统" class="level2">
<h2 class="anchored" data-anchor-id="数据管理系统">数据管理系统</h2>
<p>该应用实现了一套精致的数据处理流程，确保了实时同步和高效的数据处理。</p>
<section id="数据处理工作流" class="level3">
<h3 class="anchored" data-anchor-id="数据处理工作流">数据处理工作流</h3>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>

</div>
<p></p><figcaption> 数据处理工作流</figcaption> </figure><p></p>
</div>
</div>
</div>
</section>
<section id="实时文件监控" class="level3">
<h3 class="anchored" data-anchor-id="实时文件监控">实时文件监控</h3>
<p>应用使用 <code>reactivePoll()</code> 来监控 Excel 数据文件的更改：</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 实时数据监控，间隔为 1000ms</span></span>
<span id="cb2-2">weight_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">reactivePoll</span>(</span>
<span id="cb2-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">intervalMillis =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>,</span>
<span id="cb2-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">session =</span> session,</span>
<span id="cb2-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">checkFunc =</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>() {</span>
<span id="cb2-6">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 检查文件修改时间</span></span>
<span id="cb2-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.exists</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"weight.xlsx"</span>)) {</span>
<span id="cb2-8">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.info</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"weight.xlsx"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>mtime</span>
<span id="cb2-9">    } <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> {</span>
<span id="cb2-10">      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb2-11">    }</span>
<span id="cb2-12">  },</span>
<span id="cb2-13">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">valueFunc =</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>() {</span>
<span id="cb2-14">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 读取并处理 Excel 文件</span></span>
<span id="cb2-15">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.exists</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"weight.xlsx"</span>)) {</span>
<span id="cb2-16">      data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_excel</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"weight.xlsx"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb2-17">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb2-18">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Date =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">anytime</span>(Date),</span>
<span id="cb2-19">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">BMI =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(</span>
<span id="cb2-20">            Unit <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"kg"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> Weight <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (Height<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,</span>
<span id="cb2-21">            Unit <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pound"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> (Weight <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.453592</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> ((Height <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.54</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb2-22">          )</span>
<span id="cb2-23">        )</span>
<span id="cb2-24">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(data)</span>
<span id="cb2-25">    }</span>
<span id="cb2-26">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>())</span>
<span id="cb2-27">  }</span>
<span id="cb2-28">)</span></code></pre></div></div>
</details>
</div>
</section>
<section id="bmi-计算算法" class="level3">
<h3 class="anchored" data-anchor-id="bmi-计算算法">BMI 计算算法</h3>
<p>应用实现了包含单位转换的全面 BMI 计算：</p>
<section id="bmi-类别和健康范围" class="level4">
<h4 class="anchored" data-anchor-id="bmi-类别和健康范围">BMI 类别和健康范围</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>BMI 范围</th>
<th>类别</th>
<th>健康风险</th>
<th>颜色代码</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>&lt; 18.5</td>
<td>体重过轻</td>
<td>中度风险</td>
<td>黄色</td>
</tr>
<tr class="even">
<td>18.5 - 24.9</td>
<td>体重正常</td>
<td>风险最小</td>
<td>绿色</td>
</tr>
<tr class="odd">
<td>25.0 - 29.9</td>
<td>超重</td>
<td>风险增加</td>
<td>橙色</td>
</tr>
<tr class="even">
<td>≥ 30.0</td>
<td>肥胖</td>
<td>高风险</td>
<td>红色</td>
</tr>
</tbody>
</table>
</section>
<section id="单位转换示例" class="level4">
<h4 class="anchored" data-anchor-id="单位转换示例">单位转换示例</h4>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 公制和英制单位的 BMI 计算</span></span>
<span id="cb3-2">calculate_bmi <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(weight, height, unit) {</span>
<span id="cb3-3">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (unit <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"kg"</span>) {</span>
<span id="cb3-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 公制计算</span></span>
<span id="cb3-5">    bmi <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> weight <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> ((height<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb3-6">  } <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> {</span>
<span id="cb3-7">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 英制计算并转换</span></span>
<span id="cb3-8">    weight_kg <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> weight <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.453592</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 磅转换为千克</span></span>
<span id="cb3-9">    height_m <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> height <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.54</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 英寸转换为米</span></span>
<span id="cb3-10">    bmi <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> weight_kg <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (height_m<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb3-11">  }</span>
<span id="cb3-12"></span>
<span id="cb3-13">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># BMI 分类</span></span>
<span id="cb3-14">  category <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(</span>
<span id="cb3-15">    bmi <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">18.5</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"underweight"</span>,</span>
<span id="cb3-16">    bmi <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">25</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"normal"</span>,</span>
<span id="cb3-17">    bmi <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"overweight"</span>,</span>
<span id="cb3-18">    <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"obese"</span></span>
<span id="cb3-19">  )</span>
<span id="cb3-20"></span>
<span id="cb3-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bmi =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(bmi, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">category =</span> category))</span>
<span id="cb3-22">}</span></code></pre></div></div>
</details>
</div>
</section>
</section>
</section>
<section id="ai-集成架构" class="level2">
<h2 class="anchored" data-anchor-id="ai-集成架构">AI 集成架构</h2>
<section id="多服务商-ai-系统" class="level3">
<h3 class="anchored" data-anchor-id="多服务商-ai-系统">多服务商 AI 系统</h3>
<p>应用支持多个 AI 服务商，并可动态切换：</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># AI 服务商配置</span></span>
<span id="cb4-2">ai_providers <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb4-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">modelscope =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb4-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">provider_url =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://api-inference.modelscope.cn/v1"</span>,</span>
<span id="cb4-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">models =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"zhipuAI/GLM-4.6"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Qwen/Qwen3-Next-80B-A3B-Instruct"</span>)</span>
<span id="cb4-6">  ),</span>
<span id="cb4-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">openrouter =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb4-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">provider_url =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://openrouter.ai/api/v1"</span>,</span>
<span id="cb4-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">models =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"openai/gpt-oss-120b:exacto"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"minimax/minimax-m2:free"</span>)</span>
<span id="cb4-10">  ),</span>
<span id="cb4-11">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Gemini =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb4-12">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">provider_url =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://generativelanguage.googleapis.com/v1beta/openai/"</span>,</span>
<span id="cb4-13">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">models =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gemini-2.5-flash"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gemini-2.5-pro"</span>)</span>
<span id="cb4-14">  )</span>
<span id="cb4-15">)</span>
<span id="cb4-16"></span>
<span id="cb4-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 动态服务商选择</span></span>
<span id="cb4-18"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">observeEvent</span>(input<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ai_provider, {</span>
<span id="cb4-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set_current_provider</span>(input<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ai_provider)</span>
<span id="cb4-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">updateSelectInput</span>(session, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ai_model"</span>,</span>
<span id="cb4-21">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">choices =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_provider_models</span>(input<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ai_provider))</span>
<span id="cb4-22">})</span></code></pre></div></div>
</details>
</div>
</section>
<section id="ai-健康建议系统" class="level3">
<h3 class="anchored" data-anchor-id="ai-健康建议系统">AI 健康建议系统</h3>
<p>AI 根据体重趋势生成个性化健康建议：</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># AI 建议生成</span></span>
<span id="cb5-2">get_ai_suggestion <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(weight_data, api_key, model, provider) {</span>
<span id="cb5-3">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 准备 AI 分析数据</span></span>
<span id="cb5-4">  recent_trend <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">analyze_weight_trend</span>(weight_data)</span>
<span id="cb5-5">  current_bmi <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_current_bmi</span>(weight_data)</span>
<span id="cb5-6"></span>
<span id="cb5-7">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 创建特定语言的提示词</span></span>
<span id="cb5-8">  prompt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (current_language <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"zh"</span>) {</span>
<span id="cb5-9">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"基于以下体重数据分析，请提供个性化的健康建议："</span>,</span>
<span id="cb5-10">          <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"最近体重趋势："</span>, recent_trend,</span>
<span id="cb5-11">          <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"当前BMI："</span>, current_bmi,</span>
<span id="cb5-12">          <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"请用中文回复，包含具体的饮食和运动建议。"</span>)</span>
<span id="cb5-13">  } <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> {</span>
<span id="cb5-14">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Based on the following weight data analysis, please provide personalized health advice:"</span>,</span>
<span id="cb5-15">          <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Recent weight trend:"</span>, recent_trend,</span>
<span id="cb5-16">          <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Current BMI:"</span>, current_bmi,</span>
<span id="cb5-17">          <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Please respond in English with specific diet and exercise recommendations."</span>)</span>
<span id="cb5-18">  }</span>
<span id="cb5-19"></span>
<span id="cb5-20">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 调用选定服务商的 API</span></span>
<span id="cb5-21">  response <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> ellmer<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">chat_completion</span>(</span>
<span id="cb5-22">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">model =</span> model,</span>
<span id="cb5-23">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">messages =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb5-24">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">role =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"user"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">content =</span> prompt)</span>
<span id="cb5-25">    ),</span>
<span id="cb5-26">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">api_key =</span> api_key,</span>
<span id="cb5-27">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">base_url =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_provider_url</span>(provider)</span>
<span id="cb5-28">  )</span>
<span id="cb5-29"></span>
<span id="cb5-30">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(response<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>choices[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>message<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>content)</span>
<span id="cb5-31">}</span></code></pre></div></div>
</details>
</div>
</section>
</section>
<section id="用户界面设计" class="level2">
<h2 class="anchored" data-anchor-id="用户界面设计">用户界面设计</h2>
<section id="多标签导航结构" class="level3">
<h3 class="anchored" data-anchor-id="多标签导航结构">多标签导航结构</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 基于标签页的界面组织</span></span>
<span id="cb6-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mainPanel</span>(</span>
<span id="cb6-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tabsetPanel</span>(</span>
<span id="cb6-4">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tabPanel</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_text</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"plot_tab"</span>),</span>
<span id="cb6-5">             <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 体重和 BMI 图表</span></span>
<span id="cb6-6">             <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fluidRow</span>(</span>
<span id="cb6-7">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">column</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plotlyOutput</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"weight_plot"</span>)),</span>
<span id="cb6-8">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">column</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plotlyOutput</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bmi_plot"</span>))</span>
<span id="cb6-9">             )</span>
<span id="cb6-10">    ),</span>
<span id="cb6-11">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tabPanel</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_text</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ui_tab"</span>),</span>
<span id="cb6-12">             <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 包含语法高亮的 UI 代码查看器</span></span>
<span id="cb6-13">             <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">verbatimTextOutput</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ui_code"</span>)</span>
<span id="cb6-14">    ),</span>
<span id="cb6-15">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tabPanel</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_text</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"server_tab"</span>),</span>
<span id="cb6-16">             <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Server 代码查看器</span></span>
<span id="cb6-17">             <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">verbatimTextOutput</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"server_code"</span>)</span>
<span id="cb6-18">    ),</span>
<span id="cb6-19">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tabPanel</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_text</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data_tab"</span>),</span>
<span id="cb6-20">             <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 交互式数据表格</span></span>
<span id="cb6-21">             DT<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dataTableOutput</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data_table"</span>)</span>
<span id="cb6-22">    )</span>
<span id="cb6-23">  )</span>
<span id="cb6-24">)</span></code></pre></div></div>
</details>
</div>
</section>
<section id="国际化系统" class="level3">
<h3 class="anchored" data-anchor-id="国际化系统">国际化系统</h3>
<p>完善的双语支持，具备动态语言切换功能：</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 语言翻译系统</span></span>
<span id="cb7-2">translations <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb7-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">en =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb7-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">app_title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Weight tracking"</span>,</span>
<span id="cb7-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">your_weight =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Your weight:"</span>,</span>
<span id="cb7-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">your_bmi =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Your BMI:"</span>,</span>
<span id="cb7-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">get_ai_suggestion =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Get AI Suggestion"</span></span>
<span id="cb7-8">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ... 更多翻译</span></span>
<span id="cb7-9">  ),</span>
<span id="cb7-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">zh =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb7-11">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">app_title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"体重追踪"</span>,</span>
<span id="cb7-12">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">your_weight =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"您的体重:"</span>,</span>
<span id="cb7-13">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">your_bmi =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"您的BMI:"</span>,</span>
<span id="cb7-14">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">get_ai_suggestion =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"获取AI建议"</span></span>
<span id="cb7-15">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ... 更多翻译</span></span>
<span id="cb7-16">  )</span>
<span id="cb7-17">)</span>
<span id="cb7-18"></span>
<span id="cb7-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 语言切换处理器</span></span>
<span id="cb7-20"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">observeEvent</span>(input<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>lang_en, {</span>
<span id="cb7-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">current_lang</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"en"</span>)</span>
<span id="cb7-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set_language</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"en"</span>)</span>
<span id="cb7-23">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">updateUI</span>()  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 触发 UI 更新</span></span>
<span id="cb7-24">})</span></code></pre></div></div>
</details>
</div>
</section>
</section>
<section id="数据可视化" class="level2">
<h2 class="anchored" data-anchor-id="数据可视化">数据可视化</h2>
<section id="交互式-plotly-图表" class="level3">
<h3 class="anchored" data-anchor-id="交互式-plotly-图表">交互式 Plotly 图表</h3>
<p>应用具备带健康指标的动态图表：</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 带健康范围的 BMI 图表</span></span>
<span id="cb8-2">output<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>bmi_plot <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">renderPlotly</span>({</span>
<span id="cb8-3">  data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">weight_data</span>()</span>
<span id="cb8-4"></span>
<span id="cb8-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_ly</span>(data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>Date, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>BMI, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'scatter'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mode =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'lines+markers'</span>,</span>
<span id="cb8-6">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">name =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_text</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"chart_bmi_legend"</span>),</span>
<span id="cb8-7">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">line =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'blue'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>),</span>
<span id="cb8-8">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">marker =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb8-9">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 添加健康范围带</span></span>
<span id="cb8-10">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_trace</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">18.5</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(data)), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mode =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'lines'</span>,</span>
<span id="cb8-11">              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">line =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'green'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dash =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'dash'</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">name =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"理想范围起点"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb8-12">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_trace</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">24.9</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(data)), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mode =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'lines'</span>,</span>
<span id="cb8-13">              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">line =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'red'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dash =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'dash'</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">name =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"理想范围终点"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb8-14">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">layout</span>(</span>
<span id="cb8-15">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_text</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"chart_bmi_title"</span>),</span>
<span id="cb8-16">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xaxis =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"日期"</span>),</span>
<span id="cb8-17">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yaxis =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"BMI"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">range =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">35</span>)),</span>
<span id="cb8-18">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hovermode =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'x unified'</span></span>
<span id="cb8-19">    )</span>
<span id="cb8-20">})</span></code></pre></div></div>
</details>
</div>
</section>
</section>
<section id="部署与配置" class="level2">
<h2 class="anchored" data-anchor-id="部署与配置">部署与配置</h2>
<section id="shinyapps.io-部署" class="level3">
<h3 class="anchored" data-anchor-id="shinyapps.io-部署">ShinyApps.io 部署</h3>
<p>应用已部署并可通过以下链接访问： <strong>https://jcflyingco.shinyapps.io/weight-tracking/</strong></p>
</section>
<section id="url-书签系统" class="level3">
<h3 class="anchored" data-anchor-id="url-书签系统">URL 书签系统</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 在 global.R 中启用 URL 书签</span></span>
<span id="cb9-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">shinyServer</span>(</span>
<span id="cb9-3">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(input, output, session) {</span>
<span id="cb9-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 书签配置</span></span>
<span id="cb9-5">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">enableBookmarking</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"url"</span>)</span>
<span id="cb9-6"></span>
<span id="cb9-7">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 保存/恢复 UI 状态</span></span>
<span id="cb9-8">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setBookmarkExclude</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lang_en"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lang_zh"</span>))  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 排除语言按钮</span></span>
<span id="cb9-9">  }</span>
<span id="cb9-10">)</span></code></pre></div></div>
</details>
</div>
</section>
</section>
<section id="性能优化" class="level2">
<h2 class="anchored" data-anchor-id="性能优化">性能优化</h2>
<section id="响应式编程最佳实践" class="level3">
<h3 class="anchored" data-anchor-id="响应式编程最佳实践">响应式编程最佳实践</h3>
<p>应用实现了高效的响应式编程：</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 高效的带缓存数据处理</span></span>
<span id="cb10-2">processed_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">reactive</span>({</span>
<span id="cb10-3">  data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">weight_data</span>()</span>
<span id="cb10-4">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(data) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>)</span>
<span id="cb10-5"></span>
<span id="cb10-6">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 仅计算一次派生指标</span></span>
<span id="cb10-7">  data <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb10-8">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb10-9">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Weight_Change =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">diff</span>(Weight)),</span>
<span id="cb10-10">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">BMI_Category =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(</span>
<span id="cb10-11">        BMI <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">18.5</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"underweight"</span>,</span>
<span id="cb10-12">        BMI <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">25</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"normal"</span>,</span>
<span id="cb10-13">        BMI <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"overweight"</span>,</span>
<span id="cb10-14">        <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"obese"</span></span>
<span id="cb10-15">      ),</span>
<span id="cb10-16">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Date_Formatted =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">format</span>(Date, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"%Y-%m-%d"</span>)</span>
<span id="cb10-17">    )</span>
<span id="cb10-18">})</span>
<span id="cb10-19"></span>
<span id="cb10-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 用于多个输出的共享计算</span></span>
<span id="cb10-21">current_stats <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">reactive</span>({</span>
<span id="cb10-22">  data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">processed_data</span>()</span>
<span id="cb10-23">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.null</span>(data) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">||</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(data) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>)</span>
<span id="cb10-24"></span>
<span id="cb10-25">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb10-26">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">last_weight =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tail</span>(data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Weight, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),</span>
<span id="cb10-27">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">last_bmi =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tail</span>(data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>BMI, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),</span>
<span id="cb10-28">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">trend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">calculate_trend</span>(data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Weight),</span>
<span id="cb10-29">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">days_tracked =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(data)</span>
<span id="cb10-30">  )</span>
<span id="cb10-31">})</span></code></pre></div></div>
</details>
</div>
</section>
</section>
<section id="安全与最佳实践" class="level2">
<h2 class="anchored" data-anchor-id="安全与最佳实践">安全与最佳实践</h2>
<section id="api-密钥管理" class="level3">
<h3 class="anchored" data-anchor-id="api-密钥管理">API 密钥管理</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 安全的 API 密钥处理（仅限会话存储）</span></span>
<span id="cb11-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">observeEvent</span>(input<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>get_ai_suggestion, {</span>
<span id="cb11-3">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.null</span>(input<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>api_key) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">||</span> input<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>api_key <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>) {</span>
<span id="cb11-4">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">showNotification</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_text</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"please_provide_api_key"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"error"</span>)</span>
<span id="cb11-5">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>()</span>
<span id="cb11-6">  }</span>
<span id="cb11-7"></span>
<span id="cb11-8">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 使用会话中的 API 密钥（不持久化）</span></span>
<span id="cb11-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">withBusyIndicator</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"正在获取 AI 建议..."</span>, {</span>
<span id="cb11-10">    suggestion <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_ai_suggestion</span>(</span>
<span id="cb11-11">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">weight_data =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">weight_data</span>(),</span>
<span id="cb11-12">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">api_key =</span> input<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>api_key,</span>
<span id="cb11-13">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">model =</span> input<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ai_model,</span>
<span id="cb11-14">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">provider =</span> input<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ai_provider</span>
<span id="cb11-15">    )</span>
<span id="cb11-16"></span>
<span id="cb11-17">    output<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ai_response <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">renderUI</span>({</span>
<span id="cb11-18">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">div</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">class =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"markdown-content"</span>,</span>
<span id="cb11-19">          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">HTML</span>(markdown<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">renderMarkdown</span>(suggestion))</span>
<span id="cb11-20">      )</span>
<span id="cb11-21">    })</span>
<span id="cb11-22">  })</span>
<span id="cb11-23">})</span></code></pre></div></div>
</details>
</div>
</section>
<section id="错误处理" class="level3">
<h3 class="anchored" data-anchor-id="错误处理">错误处理</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 全面的错误处理</span></span>
<span id="cb12-2">get_ai_suggestion <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(...) {</span>
<span id="cb12-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tryCatch</span>({</span>
<span id="cb12-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># API 调用逻辑</span></span>
<span id="cb12-5">    response <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> ellmer<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">chat_completion</span>(...)</span>
<span id="cb12-6">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(response<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>choices[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>message<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>content)</span>
<span id="cb12-7">  }, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">error =</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(e) {</span>
<span id="cb12-8">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 错误日志记录和用户反馈</span></span>
<span id="cb12-9">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log_error</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"AI API 错误:"</span>, e<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>message))</span>
<span id="cb12-10">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_text</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ai_error_check_config"</span>))</span>
<span id="cb12-11">  })</span>
<span id="cb12-12">}</span></code></pre></div></div>
</details>
</div>
</section>
</section>
<section id="使用示例与用户工作流" class="level2">
<h2 class="anchored" data-anchor-id="使用示例与用户工作流">使用示例与用户工作流</h2>
<section id="每日体重追踪工作流" class="level3">
<h3 class="anchored" data-anchor-id="每日体重追踪工作流">每日体重追踪工作流</h3>
<ol type="1">
<li>在浏览器中打开应用程序。</li>
<li>查看当前体重趋势图和 BMI 图表。</li>
<li>通过 Excel 上传添加新的体重数据。</li>
<li>获取 AI 驱动的健康建议。</li>
<li>下载更新后的数据供离线使用。</li>
</ol>
</section>
<section id="多语言使用" class="level3">
<h3 class="anchored" data-anchor-id="多语言使用">多语言使用</h3>
<ol type="1">
<li>使用右上角的按钮在 EN/中文 之间切换。</li>
<li>所有 UI 元素动态更新。</li>
<li>AI 提示词适配所选语言。</li>
<li>图表和数据保持语境一致。</li>
</ol>
</section>
</section>
<section id="技术成就" class="level2">
<h2 class="anchored" data-anchor-id="技术成就">技术成就</h2>
<section id="核心创新" class="level3">
<h3 class="anchored" data-anchor-id="核心创新">核心创新</h3>
<ol type="1">
<li><strong>实时 Excel 同步</strong>：数据更改时 UI 自动更新。</li>
<li><strong>多服务商 AI 集成</strong>：灵活的 AI 服务商切换。</li>
<li><strong>完善的国际化</strong>：完整的双语支持。</li>
<li><strong>专业 UI 设计</strong>：基于 Bootstrap 的响应式布局。</li>
<li><strong>交互式可视化</strong>：可缩放、可悬停的 Plotly 图表。</li>
</ol>
</section>
<section id="性能指标" class="level3">
<h3 class="anchored" data-anchor-id="性能指标">性能指标</h3>
<ul>
<li><strong>数据刷新</strong>：1 秒轮询间隔。</li>
<li><strong>图表渲染</strong>：典型数据集渲染时间 &lt; 100ms。</li>
<li><strong>API 响应</strong>：AI 建议响应时间为 2-5 秒。</li>
<li><strong>内存占用</strong>：1000+ 条记录下内存占用 &lt; 50MB。</li>
</ul>
</section>
</section>
<section id="未来增强方向" class="level2">
<h2 class="anchored" data-anchor-id="未来增强方向">未来增强方向</h2>
<p>下一版本的潜在改进点：</p>
<ol type="1">
<li><strong>数据库集成</strong>：将 Excel 替换为 SQLite/PostgreSQL。</li>
<li><strong>用户认证</strong>：支持多用户，实现个人数据隔离。</li>
<li><strong>移动端优化</strong>：为移动设备提供 PWA 特性。</li>
<li><strong>高级分析</strong>：使用时间序列构建体重预测模型。</li>
<li><strong>集成 API</strong>：连接健身追踪器和健康应用。</li>
</ol>
</section>
<section id="结论" class="level2">
<h2 class="anchored" data-anchor-id="结论">结论</h2>
<p>这款体重追踪应用展示了将 R Shiny 的响应式编程与现代 AI 技术相结合的强大力量。项目展示了：</p>
<ul>
<li><strong>精细的数据管理</strong>：实时文件监控和响应式更新。</li>
<li><strong>AI 集成</strong>：集成多服务商并提供个性化健康建议。</li>
<li><strong>国际化</strong>：完整的双语实现。</li>
<li><strong>专业的 UI/UX</strong>：现代响应式设计配合交互式可视化。</li>
</ul>
<p>无论您是关注健康监测、数据可视化，还是 AI 集成，本项目都为您提供了一个使用 R Shiny 构建生产级 Web 应用的绝佳范例。</p>
<hr>


<!-- -->

</section>
</section>

 ]]></description>
  <category>AI</category>
  <category>API</category>
  <category>tutorial</category>
  <guid>https://jcwinning.github.io/LandingPage/posts/weight-tracking/</guid>
  <pubDate>Tue, 04 Nov 2025 16:00:00 GMT</pubDate>
  <media:content url="https://jcwinning.github.io/LandingPage/posts/weight-tracking/images/0.png" medium="image" type="image/png" height="84" width="144"/>
</item>
<item>
  <title>基于 RAG 的威士忌品鉴笔记</title>
  <dc:creator>Tony D</dc:creator>
  <link>https://jcwinning.github.io/LandingPage/posts/whisky-tasting/</link>
  <description><![CDATA[ 





<section id="项目概览" class="level1">
<h1>项目概览</h1>
<p>威士忌品鉴应用是一款先进的 AI 驱动 Web 应用程序，可生成详细、专业的威士忌品鉴笔记和建议。该系统的特别之处在于其采用了多 Agent 架构，并配备了专门的 AI 人格，每个人格都经过了不同威士忌评论源和语言风格的训练。</p>
<p>在线演示 (Modelscope): <a href="https://modelscope.cn/studios/ttflying/whisky_AI_tasting">https://modelscope.cn/studios/ttflying/whisky_AI_tasting</a></p>
<p>在线演示 (Shinyapp): <a href="https://jcflyingco.shinyapps.io/ai-whisky-tasting">https://jcflyingco.shinyapps.io/ai-whisky-tasting/</a></p>
<p>Github: <a href="https://github.com/JCwinning/whisky_tasting">https://github.com/JCwinning/whisky_tasting</a></p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" aria-controls="tabset-1-1" aria-selected="true" href="">AI 品鉴词</a></li><li class="nav-item"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" aria-controls="tabset-1-2" aria-selected="false" href="">AI 推荐</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" aria-labelledby="tabset-1-1-tab">
<p><img src="https://jcwinning.github.io/LandingPage/posts/whisky-tasting/images/0.png" class="img-fluid" style="width:100.0%"></p>
</div>
<div id="tabset-1-2" class="tab-pane" aria-labelledby="tabset-1-2-tab">
<p><img src="https://jcwinning.github.io/LandingPage/posts/whisky-tasting/images/1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
</div>
<section id="核心架构" class="level2">
<h2 class="anchored" data-anchor-id="核心架构">核心架构</h2>
<section id="多-agent-ai-系统" class="level3">
<h3 class="anchored" data-anchor-id="多-agent-ai-系统">多 Agent AI 系统</h3>
<p>该应用包含三个专门的 AI Agent，每个 Agent 都有独特的特征和数据源：</p>
<ol type="1">
<li><strong>DrunkTony (dt)</strong> - 中文 Agent，专注于中文威士忌评论。</li>
<li><strong>WhiskyFunny (wf)</strong> - 英文 Agent，数据源自 whiskyfun.com。</li>
<li><strong>WhiskyNotebook (wn)</strong> - 英文 Agent，数据源自 whiskynotes.be。</li>
</ol>
</section>
<section id="技术栈" class="level3">
<h3 class="anchored" data-anchor-id="技术栈">技术栈</h3>
<ul>
<li><strong>主要语言</strong>: Python 3.13+</li>
<li><strong>Web 框架</strong>: Streamlit (主选) + Shiny for Python (备选)</li>
<li><strong>数据库</strong>: DuckDB (376MB，针对向量操作进行了优化)</li>
<li><strong>AI/ML</strong>: OpenAI API, 向量嵌入 (Vector embeddings), RAG 系统</li>
<li><strong>数据源</strong>: 使用 BeautifulSoup4 进行网页抓取</li>
</ul>
</section>
</section>
<section id="数据库架构" class="level2">
<h2 class="anchored" data-anchor-id="数据库架构">数据库架构</h2>
<section id="数据模式与来源" class="level3">
<h3 class="anchored" data-anchor-id="数据模式与来源">数据模式与来源</h3>
<p>系统使用 DuckDB 作为主数据库，因其在向量操作方面表现卓越：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-- 数据库结构</span></span>
<span id="cb1-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">CREATE</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">TABLE</span> drinktony_embed (</span>
<span id="cb1-3">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">full</span> TEXT,</span>
<span id="cb1-4">    bottle_embedding <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">FLOAT</span>[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>]  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-- 1024 维向量</span></span>
<span id="cb1-5">);</span>
<span id="cb1-6"></span>
<span id="cb1-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">CREATE</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">TABLE</span> whiskyfun_embed (</span>
<span id="cb1-8">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">full</span> TEXT,</span>
<span id="cb1-9">    bottle_embedding <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">FLOAT</span>[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>]</span>
<span id="cb1-10">);</span>
<span id="cb1-11"></span>
<span id="cb1-12"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">CREATE</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">TABLE</span> whiskynote_embed (</span>
<span id="cb1-13">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">full</span> TEXT,</span>
<span id="cb1-14">    bottle_embedding <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">FLOAT</span>[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>]</span>
<span id="cb1-15">);</span></code></pre></div></div>
</section>
<section id="数据采集流程" class="level3">
<h3 class="anchored" data-anchor-id="数据采集流程">数据采集流程</h3>
<div id="be223295" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get_data_dt.py 中的网页抓取示例</span></span>
<span id="cb2-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> scrape_drinktony_reviews():</span>
<span id="cb2-3">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""从 drinktony.netlify.app 抓取中文威士忌评论"""</span></span>
<span id="cb2-4">    url <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://drinktony.netlify.app/"</span></span>
<span id="cb2-5">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> requests.get(url)</span>
<span id="cb2-6">    soup <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> BeautifulSoup(response.content, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"html.parser"</span>)</span>
<span id="cb2-7"></span>
<span id="cb2-8">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 查找所有评论链接</span></span>
<span id="cb2-9">    post_links <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [urljoin(url, a.get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"href"</span>))</span>
<span id="cb2-10">                 <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> a <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> soup.select(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"a.quarto-grid-link"</span>)]</span>
<span id="cb2-11"></span>
<span id="cb2-12">    all_reviews <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb2-13">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> post_url <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> post_links:</span>
<span id="cb2-14">        response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> requests.get(post_url)</span>
<span id="cb2-15">        soup <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> BeautifulSoup(response.content, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"html.parser"</span>)</span>
<span id="cb2-16"></span>
<span id="cb2-17">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 提取评论章节</span></span>
<span id="cb2-18">        review_sections <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> soup.select(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"section.level1"</span>)</span>
<span id="cb2-19">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> section <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> review_sections:</span>
<span id="cb2-20">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 解析威士忌名称和评论内容</span></span>
<span id="cb2-21">            whisky_name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> extract_whisky_name(section)</span>
<span id="cb2-22">            review_text <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> extract_review_text(section)</span>
<span id="cb2-23">            all_reviews.append({</span>
<span id="cb2-24">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'whisky'</span>: whisky_name,</span>
<span id="cb2-25">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'review'</span>: review_text</span>
<span id="cb2-26">            })</span>
<span id="cb2-27"></span>
<span id="cb2-28">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> all_reviews</span></code></pre></div></div>
</details>
</div>
</section>
</section>
<section id="aiml-实现" class="level2">
<h2 class="anchored" data-anchor-id="aiml-实现">AI/ML 实现</h2>
<section id="向量嵌入技术" class="level3">
<h3 class="anchored" data-anchor-id="向量嵌入技术">向量嵌入技术</h3>
<p>应用使用尖端的嵌入技术将文本转换为高维向量，以便进行语义相似度搜索。</p>
<section id="嵌入模型详情" class="level4">
<h4 class="anchored" data-anchor-id="嵌入模型详情">嵌入模型详情</h4>
<p><strong>模型</strong>: BAAI/bge-large-zh-v1.5 - <strong>维度</strong>: 1024 - <strong>服务商</strong>: SiliconFlow API - <strong>用途</strong>: 跨语言文本理解（在中英文方面表现均很出色）</p>
</section>
<section id="为什么选择-bge-large-zh" class="level4">
<h4 class="anchored" data-anchor-id="为什么选择-bge-large-zh">为什么选择 BGE-Large-ZH?</h4>
<ol type="1">
<li><strong>跨语言能力</strong>: 在理解中英文威士忌专业术语方面表现优异。</li>
<li><strong>高性能</strong>: 与通用嵌入模型相比，具备更出色的语义理解能力。</li>
<li><strong>高效尺寸</strong>: 1024 维度在性能和存储效率之间达到了平衡。</li>
<li><strong>API 访问</strong>: 通过 SiliconFlow 提供稳定的服务。</li>
</ol>
</section>
<section id="嵌入流程" class="level4">
<h4 class="anchored" data-anchor-id="嵌入流程">嵌入流程</h4>
<p>该应用使用 BGE-Large-ZH-v1.5 模型生成嵌入向量：</p>
<div id="221c4646" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_embedding(text: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, api_key: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>):</span>
<span id="cb3-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""使用 SiliconFlow API 生成文本嵌入"""</span></span>
<span id="cb3-3">    client <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> OpenAI(</span>
<span id="cb3-4">        api_key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>api_key,</span>
<span id="cb3-5">        base_url<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://api.siliconflow.cn/v1"</span></span>
<span id="cb3-6">    )</span>
<span id="cb3-7">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> client.embeddings.create(</span>
<span id="cb3-8">        model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"BAAI/bge-large-zh-v1.5"</span>,</span>
<span id="cb3-9">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[text]</span>
<span id="cb3-10">    )</span>
<span id="cb3-11">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> np.array(response.data[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].embedding)</span>
<span id="cb3-12"></span>
<span id="cb3-13"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> cosine_similarity(v1, v2):</span>
<span id="cb3-14">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""计算两个向量之间的余弦相似度"""</span></span>
<span id="cb3-15">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> v1 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">or</span> v2 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb3-16">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb3-17">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> np.dot(v1, v2) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (np.linalg.norm(v1) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> np.linalg.norm(v2))</span></code></pre></div></div>
</details>
</div>
</section>
</section>
<section id="rag-系统架构" class="level3">
<h3 class="anchored" data-anchor-id="rag-系统架构">RAG 系统架构</h3>
<p>检索增强生成 (RAG) 系统是此应用的核心创新。让我们详细探讨其组件。</p>
</section>
<section id="rag-工作流" class="level3">
<h3 class="anchored" data-anchor-id="rag-工作流">RAG 工作流</h3>
<p>检索增强生成过程遵循以下步骤：</p>
<pre class="mermaid"><code>%%| fig-cap: "威士忌品鉴的 RAG 工作流"
flowchart TD
    A[用户输入&lt;br/&gt;威士忌名称] --&gt; B[生成嵌入向量]
    B --&gt; C[DuckDB 中的&lt;br/&gt;向量相似度搜索]
    C --&gt; D[检索前 10 条&lt;br/&gt;相似评论]
    D --&gt; E[为 LLM 格式化上下文]
    E --&gt; F[主 LLM&lt;br/&gt;生成品鉴笔记]
    F --&gt; G[副 LLM&lt;br/&gt;生成推荐建议]
    G --&gt; H[格式化并&lt;br/&gt;显示结果]

    C --&gt; I[数据库]
    I --&gt; J[drinktony_embed&lt;br/&gt;1200 条中文评论]
    I --&gt; K[whiskyfun_embed&lt;br/&gt;2 万条英文评论]
    I --&gt; L[whiskynote_embed&lt;br/&gt;5000 条英文评论]</code></pre>
</section>
<section id="相似度搜索实现" class="level3">
<h3 class="anchored" data-anchor-id="相似度搜索实现">相似度搜索实现</h3>
<div id="8be53adf" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> find_similar_chunks(</span>
<span id="cb5-2">    query_embedding,</span>
<span id="cb5-3">    db_path,</span>
<span id="cb5-4">    table_name,</span>
<span id="cb5-5">    text_col,</span>
<span id="cb5-6">    embedding_col,</span>
<span id="cb5-7">    top_n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>,</span>
<span id="cb5-8">):</span>
<span id="cb5-9">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""使用余弦相似度在数据库中查找最相似的文本块"""</span></span>
<span id="cb5-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb5-11">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> duckdb.<span class="ex" style="color: null;
background-color: null;
font-style: inherit;">connect</span>(database<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>db_path, read_only<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> con:</span>
<span id="cb5-12">            df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> con.execute(</span>
<span id="cb5-13">                <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'SELECT "</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>text_col<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">", "</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>embedding_col<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">" FROM "</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>table_name<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"'</span></span>
<span id="cb5-14">            ).fetchdf()</span>
<span id="cb5-15"></span>
<span id="cb5-16">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 计算相似度</span></span>
<span id="cb5-17">            similarities <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb5-18">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> _, row <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> df.iterrows():</span>
<span id="cb5-19">                text <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> row[text_col]</span>
<span id="cb5-20">                embedding <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array(row[embedding_col])</span>
<span id="cb5-21">                similarity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cosine_similarity(query_embedding, embedding)</span>
<span id="cb5-22">                similarities.append((text, similarity))</span>
<span id="cb5-23"></span>
<span id="cb5-24">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 按相似度排序并返回前 N 条</span></span>
<span id="cb5-25">            similarities.sort(key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> x: x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], reverse<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb5-26">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> similarities[:top_n]</span>
<span id="cb5-27"></span>
<span id="cb5-28">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">Exception</span> <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> e:</span>
<span id="cb5-29">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"搜索相似块时出错: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>e<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb5-30">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> []</span></code></pre></div></div>
</details>
</div>
</section>
</section>
<section id="专门-agent-的实现" class="level2">
<h2 class="anchored" data-anchor-id="专门-agent-的实现">专门 Agent 的实现</h2>
<section id="drunktony-中文-agent" class="level3">
<h3 class="anchored" data-anchor-id="drunktony-中文-agent">DrunkTony (中文 Agent)</h3>
<div id="78e9c8b2" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> run_conversation(query, api_key, model):</span>
<span id="cb6-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""生成中文格式的威士忌品鉴笔记"""</span></span>
<span id="cb6-3"></span>
<span id="cb6-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 第 1 步：生成嵌入并查找相似评论</span></span>
<span id="cb6-5">    query_embedding <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_embedding(query, api_key)</span>
<span id="cb6-6">    similar_reviews <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> find_similar_chunks(</span>
<span id="cb6-7">        query_embedding<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>query_embedding,</span>
<span id="cb6-8">        db_path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/whisky_database.duckdb"</span>,</span>
<span id="cb6-9">        table_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"drinktony_embed"</span>,</span>
<span id="cb6-10">        text_col<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"full"</span>,</span>
<span id="cb6-11">        embedding_col<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bottle_embedding"</span></span>
<span id="cb6-12">    )</span>
<span id="cb6-13"></span>
<span id="cb6-14">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 第 2 步：为 LLM 准备上下文</span></span>
<span id="cb6-15">    context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">---</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>.join([review[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> review <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> similar_reviews])</span>
<span id="cb6-16"></span>
<span id="cb6-17">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 第 3 步：生成品鉴笔记</span></span>
<span id="cb6-18">    prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"""作为威士忌专家，基于以下威士忌品鉴笔记，为"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>query<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"生成专业的品鉴报告：</span></span>
<span id="cb6-19"></span>
<span id="cb6-20"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">参考品鉴笔记：</span></span>
<span id="cb6-21"><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>context<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb6-22"></span>
<span id="cb6-23"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">请按以下格式输出：</span></span>
<span id="cb6-24"><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>query<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb6-25"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">闻香: [详细描述]</span></span>
<span id="cb6-26"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">品味: [详细描述]</span></span>
<span id="cb6-27"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">打分: [90-100分]</span></span>
<span id="cb6-28"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb6-29"></span>
<span id="cb6-30">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> llm_client.chat.completions.create(</span>
<span id="cb6-31">        model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>model,</span>
<span id="cb6-32">        messages<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[</span>
<span id="cb6-33">            {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"role"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"system"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"content"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"你是一位专业的威士忌品鉴师，擅长生成详细准确的品鉴笔记。"</span>},</span>
<span id="cb6-34">            {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"role"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"user"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"content"</span>: prompt}</span>
<span id="cb6-35">        ],</span>
<span id="cb6-36">        temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>,</span>
<span id="cb6-37">        max_tokens<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span></span>
<span id="cb6-38">    )</span>
<span id="cb6-39"></span>
<span id="cb6-40">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> response.choices[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].message.content</span></code></pre></div></div>
</details>
</div>
</section>
<section id="whiskyfunny-英文-agent" class="level3">
<h3 class="anchored" data-anchor-id="whiskyfunny-英文-agent">WhiskyFunny (英文 Agent)</h3>
<div id="d7aa02cd" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> run_conversation(query, api_key, model):</span>
<span id="cb7-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""生成英文格式的威士忌品鉴笔记"""</span></span>
<span id="cb7-3"></span>
<span id="cb7-4">    query_embedding <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_embedding(query, api_key)</span>
<span id="cb7-5">    similar_reviews <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> find_similar_chunks(</span>
<span id="cb7-6">        query_embedding<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>query_embedding,</span>
<span id="cb7-7">        db_path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/whisky_database.duckdb"</span>,</span>
<span id="cb7-8">        table_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"whiskyfun_embed"</span>,</span>
<span id="cb7-9">        text_col<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"full"</span>,</span>
<span id="cb7-10">        embedding_col<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bottle_embedding"</span></span>
<span id="cb7-11">    )</span>
<span id="cb7-12"></span>
<span id="cb7-13">    context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">---</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>.join([review[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> review <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> similar_reviews])</span>
<span id="cb7-14"></span>
<span id="cb7-15">    prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"""As a whisky expert, generate professional tasting notes for "</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>query<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">" based on these reference reviews:</span></span>
<span id="cb7-16"></span>
<span id="cb7-17"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">Reference reviews:</span></span>
<span id="cb7-18"><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>context<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb7-19"></span>
<span id="cb7-20"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">Please output in this format:</span></span>
<span id="cb7-21"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">Colour: [detailed description]</span></span>
<span id="cb7-22"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">Nose: [detailed aroma description]</span></span>
<span id="cb7-23"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">Mouth: [detailed taste description]</span></span>
<span id="cb7-24"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">Finish: [detailed finish description]</span></span>
<span id="cb7-25"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">Comments: [overall impression]</span></span>
<span id="cb7-26"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">SGP: xxx - xx points</span></span>
<span id="cb7-27"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb7-28"></span>
<span id="cb7-29">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> llm_client.chat.completions.create(</span>
<span id="cb7-30">        model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>model,</span>
<span id="cb7-31">        messages<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[</span>
<span id="cb7-32">            {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"role"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"system"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"content"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are a professional whisky taster specializing in detailed sensory analysis."</span>},</span>
<span id="cb7-33">            {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"role"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"user"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"content"</span>: prompt}</span>
<span id="cb7-34">        ],</span>
<span id="cb7-35">        temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>,</span>
<span id="cb7-36">        max_tokens<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1200</span></span>
<span id="cb7-37">    )</span>
<span id="cb7-38"></span>
<span id="cb7-39">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> response.choices[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].message.content</span></code></pre></div></div>
</details>
</div>
</section>
</section>
<section id="推荐引擎" class="level2">
<h2 class="anchored" data-anchor-id="推荐引擎">推荐引擎</h2>
<section id="双-llm-推荐系统" class="level3">
<h3 class="anchored" data-anchor-id="双-llm-推荐系统">双 LLM 推荐系统</h3>
<p>应用使用一个独立的 LLM 来生成威士忌推荐建议：</p>
<div id="d60e91fb" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> recommend_whiskies_by_profile(tasting_notes, api_key, model):</span>
<span id="cb8-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""基于品鉴特征生成威士忌推荐"""</span></span>
<span id="cb8-3"></span>
<span id="cb8-4">    prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"""Based on these tasting notes, recommend 2 similar whiskies that the user might enjoy:</span></span>
<span id="cb8-5"></span>
<span id="cb8-6"><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>Tasting Notes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:}</span></span>
<span id="cb8-7"><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>tasting_notes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb8-8"></span>
<span id="cb8-9"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">Please provide:</span></span>
<span id="cb8-10"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">1. Whisky name with brief description</span></span>
<span id="cb8-11"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">2. Why it matches the user's preference</span></span>
<span id="cb8-12"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">3. Price range and availability</span></span>
<span id="cb8-13"></span>
<span id="cb8-14"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">Format each recommendation as:</span></span>
<span id="cb8-15"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">**Recommendation [1/2]:** [Whisky Name]</span></span>
<span id="cb8-16"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">**Why it matches:** [detailed reasoning]</span></span>
<span id="cb8-17"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">**Details:** [price, availability, tasting profile]</span></span>
<span id="cb8-18"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb8-19"></span>
<span id="cb8-20">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> recommendation_client.chat.completions.create(</span>
<span id="cb8-21">        model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>model,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 推荐使用不同的模型</span></span>
<span id="cb8-22">        messages<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[</span>
<span id="cb8-23">            {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"role"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"system"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"content"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are a whisky recommendation expert with deep knowledge of global whisky brands and profiles."</span>},</span>
<span id="cb8-24">            {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"role"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"user"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"content"</span>: prompt}</span>
<span id="cb8-25">        ],</span>
<span id="cb8-26">        temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>,</span>
<span id="cb8-27">        max_tokens<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">800</span></span>
<span id="cb8-28">    )</span>
<span id="cb8-29"></span>
<span id="cb8-30">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> response.choices[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].message.content</span></code></pre></div></div>
</details>
</div>
</section>
</section>
<section id="用户界面设计" class="level2">
<h2 class="anchored" data-anchor-id="用户界面设计">用户界面设计</h2>
<section id="streamlit-实现" class="level3">
<h3 class="anchored" data-anchor-id="streamlit-实现">Streamlit 实现</h3>
<div id="63277e57" class="cell" data-execution_count="7">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 主应用程序界面</span></span>
<span id="cb9-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> main():</span>
<span id="cb9-3">    st.set_page_config(</span>
<span id="cb9-4">        page_title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"AI 威士忌品鉴系统"</span>,</span>
<span id="cb9-5">        page_icon<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"🥃"</span>,</span>
<span id="cb9-6">        layout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"wide"</span></span>
<span id="cb9-7">    )</span>
<span id="cb9-8"></span>
<span id="cb9-9">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 侧边栏 Agent 选择</span></span>
<span id="cb9-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> st.sidebar:</span>
<span id="cb9-11">        st.header(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"🥃 威士忌 AI 品鉴"</span>)</span>
<span id="cb9-12"></span>
<span id="cb9-13">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Agent 选择</span></span>
<span id="cb9-14">        agent_type <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> st.selectbox(</span>
<span id="cb9-15">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"选择品鉴 Agent:"</span>,</span>
<span id="cb9-16">            [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"DrunkTony (中文)"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"WhiskyFunny (English)"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"WhiskyNotebook (English)"</span>],</span>
<span id="cb9-17">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">help</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"每个 Agent 都有不同的性格和数据源"</span></span>
<span id="cb9-18">        )</span>
<span id="cb9-19"></span>
<span id="cb9-20">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 模型选择</span></span>
<span id="cb9-21">        model_options <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_model_options(agent_type)</span>
<span id="cb9-22">        selected_model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> st.selectbox(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"模型:"</span>, model_options)</span>
<span id="cb9-23"></span>
<span id="cb9-24">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 主内容区域</span></span>
<span id="cb9-25">    st.header(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"专业的威士忌品鉴笔记生成器"</span>)</span>
<span id="cb9-26"></span>
<span id="cb9-27">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 输入部分</span></span>
<span id="cb9-28">    col1, col2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> st.columns([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb9-29">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> col1:</span>
<span id="cb9-30">        whisky_name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> st.text_input(</span>
<span id="cb9-31">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"输入威士忌名称:"</span>,</span>
<span id="cb9-32">            placeholder<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"例如: Macallan 18 Year Old"</span>,</span>
<span id="cb9-33">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">help</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"输入完整的威士忌名称，包括年份和桶型"</span></span>
<span id="cb9-34">        )</span>
<span id="cb9-35"></span>
<span id="cb9-36">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> col2:</span>
<span id="cb9-37">        st.write(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 间距</span></span>
<span id="cb9-38">        generate_btn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> st.button(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"🍷 生成品鉴笔记"</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"primary"</span>)</span>
<span id="cb9-39">        recommend_btn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> st.button(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"🎯 获取推荐"</span>)</span>
<span id="cb9-40"></span>
<span id="cb9-41">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 输出部分</span></span>
<span id="cb9-42">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> generate_btn:</span>
<span id="cb9-43">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> whisky_name:</span>
<span id="cb9-44">            st.error(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"请输入威士忌名称"</span>)</span>
<span id="cb9-45">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb9-46">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> st.spinner(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"正在分析威士忌..."</span>):</span>
<span id="cb9-47">                tasting_notes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> generate_tasting_notes(whisky_name, agent_type, selected_model)</span>
<span id="cb9-48">                st.markdown(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"### 🥃 品鉴笔记"</span>)</span>
<span id="cb9-49">                st.markdown(tasting_notes)</span>
<span id="cb9-50"></span>
<span id="cb9-51">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> recommend_btn:</span>
<span id="cb9-52">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> st.spinner(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"正在查找推荐..."</span>):</span>
<span id="cb9-53">            recommendations <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_recommendations(tasting_notes, agent_type)</span>
<span id="cb9-54">            st.markdown(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"### 🎯 个性化推荐"</span>)</span>
<span id="cb9-55">            st.markdown(recommendations)</span></code></pre></div></div>
</details>
</div>
</section>
</section>
<section id="频率限制与成本管理" class="level2">
<h2 class="anchored" data-anchor-id="频率限制与成本管理">频率限制与成本管理</h2>
<section id="api-使用控制" class="level3">
<h3 class="anchored" data-anchor-id="api-使用控制">API 使用控制</h3>
<div id="b9345ef8" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 频率限制实现</span></span>
<span id="cb10-2">RATE_LIMIT_FILE <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rate_limit.json"</span></span>
<span id="cb10-3">MAX_RUNS_PER_DAY <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">80</span></span>
<span id="cb10-4"></span>
<span id="cb10-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_rate_limit_data():</span>
<span id="cb10-6">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""获取当前使用数据"""</span></span>
<span id="cb10-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb10-8">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(RATE_LIMIT_FILE, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"r"</span>) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> f:</span>
<span id="cb10-9">            data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> json.load(f)</span>
<span id="cb10-10">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 确保键存在</span></span>
<span id="cb10-11">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"date"</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> data <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">or</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"count"</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> data:</span>
<span id="cb10-12">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"date"</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(datetime.date.today()), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"count"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>}</span>
<span id="cb10-13">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> data</span>
<span id="cb10-14">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> (<span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">FileNotFoundError</span>, json.JSONDecodeError):</span>
<span id="cb10-15">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"date"</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(datetime.date.today()), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"count"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>}</span>
<span id="cb10-16"></span>
<span id="cb10-17"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> check_rate_limit():</span>
<span id="cb10-18">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""检查用户是否超出了每日限制"""</span></span>
<span id="cb10-19">    data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_rate_limit_data()</span>
<span id="cb10-20">    today <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(datetime.date.today())</span>
<span id="cb10-21"></span>
<span id="cb10-22">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"date"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> today:</span>
<span id="cb10-23">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 为新的一天重置计数器</span></span>
<span id="cb10-24">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"date"</span>: today, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"count"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"can_run"</span>: <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>}</span>
<span id="cb10-25"></span>
<span id="cb10-26">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"count"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> MAX_RUNS_PER_DAY:</span>
<span id="cb10-27">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"date"</span>: today, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"count"</span>: data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"count"</span>], <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"can_run"</span>: <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>}</span>
<span id="cb10-28"></span>
<span id="cb10-29">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"date"</span>: today, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"count"</span>: data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"count"</span>], <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"can_run"</span>: <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>}</span></code></pre></div></div>
</details>
</div>
</section>
</section>
<section id="性能优化" class="level2">
<h2 class="anchored" data-anchor-id="性能优化">性能优化</h2>
<section id="向量数据库性能" class="level3">
<h3 class="anchored" data-anchor-id="向量数据库性能">向量数据库性能</h3>
<div id="463c1b95" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 针对大数据的分批优化相似度搜索</span></span>
<span id="cb11-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> batch_similarity_search(query_embedding, db_path, table_name, batch_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>):</span>
<span id="cb11-3">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""针对大型数据集的分批相似度搜索优化"""</span></span>
<span id="cb11-4"></span>
<span id="cb11-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> duckdb.<span class="ex" style="color: null;
background-color: null;
font-style: inherit;">connect</span>(database<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>db_path, read_only<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> con:</span>
<span id="cb11-6">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 获取总行数</span></span>
<span id="cb11-7">        total_rows <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> con.execute(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"SELECT COUNT(*) FROM </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>table_name<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>).fetchone()[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb11-8"></span>
<span id="cb11-9">        all_similarities <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb11-10"></span>
<span id="cb11-11">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 分批处理以管理内存</span></span>
<span id="cb11-12">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> offset <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, total_rows, batch_size):</span>
<span id="cb11-13">            batch_df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> con.execute(</span>
<span id="cb11-14">                <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'SELECT full, bottle_embedding FROM </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>table_name<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> LIMIT </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>batch_size<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> OFFSET </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>offset<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span></span>
<span id="cb11-15">            ).fetchdf()</span>
<span id="cb11-16"></span>
<span id="cb11-17">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 计算该批次的相似度</span></span>
<span id="cb11-18">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> _, row <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> batch_df.iterrows():</span>
<span id="cb11-19">                embedding <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array(row[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bottle_embedding'</span>])</span>
<span id="cb11-20">                similarity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cosine_similarity(query_embedding, embedding)</span>
<span id="cb11-21">                all_similarities.append((row[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'full'</span>], similarity))</span>
<span id="cb11-22"></span>
<span id="cb11-23">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 排序并返回前几条结果</span></span>
<span id="cb11-24">        all_similarities.sort(key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> x: x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], reverse<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb11-25">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> all_similarities[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>]</span></code></pre></div></div>
</details>
</div>
</section>
</section>
<section id="部署与配置" class="level2">
<h2 class="anchored" data-anchor-id="部署与配置">部署与配置</h2>
<section id="环境搭建" class="level3">
<h3 class="anchored" data-anchor-id="环境搭建">环境搭建</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># .env 文件中的环境变量</span></span>
<span id="cb12-2"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">SILICONFLOW_API_KEY</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>您的 <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">SiliconFlow</span> 密钥</span>
<span id="cb12-3"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">MODELSCOPE_API_KEY</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>您的 <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ModelScope</span> 密钥</span>
<span id="cb12-4"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">GEMINI_API_KEY</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>您的 <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Gemini</span> 密钥  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 可选</span></span>
<span id="cb12-5"></span>
<span id="cb12-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 数据库初始化</span></span>
<span id="cb12-7"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">python</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-c</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb12-8"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">import duckdb</span></span>
<span id="cb12-9"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">conn = duckdb.connect('data/whisky_database.duckdb')</span></span>
<span id="cb12-10"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"># 创建支持向量的表格</span></span>
<span id="cb12-11"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span></code></pre></div></div>
</section>
<section id="shiny-for-python-备选方案" class="level3">
<h3 class="anchored" data-anchor-id="shiny-for-python-备选方案">Shiny for Python 备选方案</h3>
<div id="b6a00a34" class="cell" data-execution_count="10">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 使用 Shiny 实现的备选 UI</span></span>
<span id="cb13-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> shiny <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> App, ui, render, reactive, req</span>
<span id="cb13-3"></span>
<span id="cb13-4">app_ui <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ui.page_fluid(</span>
<span id="cb13-5">    ui.h2(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"🥃 AI 威士忌品鉴系统"</span>),</span>
<span id="cb13-6">    ui.layout_sidebar(</span>
<span id="cb13-7">        ui.sidebar(</span>
<span id="cb13-8">            ui.input_select(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"agent"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"选择 Agent:"</span>, [</span>
<span id="cb13-9">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"DrunkTony (中文)"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"WhiskyFunny (English)"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"WhiskyNotebook (English)"</span></span>
<span id="cb13-10">            ]),</span>
<span id="cb13-11">            ui.input_text(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"whisky_name"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"威士忌名称:"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>),</span>
<span id="cb13-12">            ui.input_action_button(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"generate"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"生成品鉴笔记"</span>)</span>
<span id="cb13-13">        ),</span>
<span id="cb13-14">        ui.output_text_verbatim(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tasting_notes"</span>),</span>
<span id="cb13-15">        ui.output_text_verbatim(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"recommendations"</span>)</span>
<span id="cb13-16">    )</span>
<span id="cb13-17">)</span>
<span id="cb13-18"></span>
<span id="cb13-19"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> server(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span>, output, session):</span>
<span id="cb13-20">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@output</span></span>
<span id="cb13-21">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@render.text</span></span>
<span id="cb13-22">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> tasting_notes():</span>
<span id="cb13-23">        req(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span>.generate())</span>
<span id="cb13-24">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 生成品鉴笔记逻辑</span></span>
<span id="cb13-25">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> generate_tasting_notes(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span>.whisky_name(), <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span>.agent())</span>
<span id="cb13-26"></span>
<span id="cb13-27">app <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> App(app_ui, server)</span></code></pre></div></div>
</details>
</div>
</section>
</section>
<section id="技术成就" class="level2">
<h2 class="anchored" data-anchor-id="技术成就">技术成就</h2>
<section id="核心创新" class="level3">
<h3 class="anchored" data-anchor-id="核心创新">核心创新</h3>
<ol type="1">
<li><strong>多 Agent 架构</strong>: 拥有不同的 AI 人格和数据源。</li>
<li><strong>RAG 实现</strong>: 使用真实威士忌评论进行检索增强生成。</li>
<li><strong>向量数据库</strong>: 使用 376MB 数据库进行高效相似度搜索。</li>
<li><strong>双语支持</strong>: 提供中文和英文 Agent。</li>
<li><strong>成本管理</strong>: 内置频率限制和 API 优化。</li>
<li><strong>专业品鉴格式</strong>: 符合行业标准的笔记结构。</li>
</ol>
</section>
<section id="性能指标" class="level3">
<h3 class="anchored" data-anchor-id="性能指标">性能指标</h3>
<table class="caption-top table">
<thead>
<tr class="header">
<th>指标</th>
<th>数值</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>数据库大小</td>
<td>376MB (26,000+ 条评论)</td>
</tr>
<tr class="even">
<td>嵌入维度</td>
<td>1024</td>
</tr>
<tr class="odd">
<td>搜索延迟</td>
<td>&lt; 2 秒</td>
</tr>
<tr class="even">
<td>每日请求限制</td>
<td>80 次请求</td>
</tr>
<tr class="odd">
<td>支持语言</td>
<td>2 (EN/ZH)</td>
</tr>
<tr class="even">
<td>数据源</td>
<td>3 (drinktony, whiskyfun, whiskynotes)</td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="未来增强方向" class="level2">
<h2 class="anchored" data-anchor-id="未来增强方向">未来增强方向</h2>
<p>下一版本的潜在改进点：</p>
<ol type="1">
<li><strong>高级相似度算法</strong>: 实现文本 + 元数据的混合搜索。</li>
<li><strong>用户个性化</strong>: 随着时间推移学习用户的偏好。</li>
<li><strong>移动端应用</strong>: 原生的 iOS/Android 应用程序。</li>
<li><strong>实时数据更新</strong>: 自动化的网页抓取流水线。</li>
<li><strong>口味特征分析</strong>: 根据用户偏好生成其口味特征图谱。</li>
<li><strong>社交功能</strong>: 与社区分享品鉴笔记和推荐。</li>
</ol>
</section>
<section id="结论" class="level2">
<h2 class="anchored" data-anchor-id="结论">结论</h2>
<p>这款威士忌品鉴应用展示了将 RAG 技术与专门的 AI Agent 相结合，从而构建复杂的领域特定系统的强大力量。本项目展示了：</p>
<ul>
<li><strong>先进的 AI 架构</strong>: 具备不同人格的多 Agent 系统。</li>
<li><strong>数据工程</strong>: 大规模向量数据库管理。</li>
<li><strong>专业知识</strong>: 行业标准的品鉴笔记格式。</li>
<li><strong>用户体验</strong>: 跨平台的简洁、直观界面。</li>
<li><strong>成本效益</strong>: 智能的频率限制和优化。</li>
</ul>
<p>无论您是威士忌爱好者、AI 开发人员还是数据科学家，本项目都为您提供了一个极佳的范例，展示了如何结合真实世界数据与先进机器学习技术来构建生产级 AI 应用。</p>
<hr>
<p><strong>技术栈</strong>: Python, Streamlit, DuckDB, OpenAI API, 向量嵌入 (Vector Embeddings)</p>
<p><strong>数据库</strong>: 涵盖 3 个专门来源的 26,000+ 条真实威士忌评论。</p>


<!-- -->

</section>
</section>

 ]]></description>
  <category>AI</category>
  <category>API</category>
  <category>tutorial</category>
  <guid>https://jcwinning.github.io/LandingPage/posts/whisky-tasting/</guid>
  <pubDate>Tue, 04 Nov 2025 16:00:00 GMT</pubDate>
  <media:content url="https://jcwinning.github.io/LandingPage/posts/whisky-tasting/images/0.png" medium="image" type="image/png" height="66" width="144"/>
</item>
<item>
  <title>使用 Streamlit 构建的 YOLO 目标检测应用</title>
  <dc:creator>Tony D</dc:creator>
  <link>https://jcwinning.github.io/LandingPage/posts/yolo-app/</link>
  <description><![CDATA[ 





<section id="项目概览" class="level1">
<h1>项目概览</h1>
<p>该应用是一个全面的 Streamlit Web 应用程序，利用 YOLO11（Ultralytics 框架）提供目标检测功能，支持多种输入源和处理后端。该项目的特别之处在于其多模型架构和生产级别的特性。</p>
<p>在线演示: <a href="https://yolo-live.streamlit.app/">https://yolo-live.streamlit.app/</a></p>
<p>Github: <a href="https://github.com/JCwinning/YOLO_app">https://github.com/JCwinning/YOLO_app</a></p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" aria-controls="tabset-1-1" aria-selected="true" href="">目标检测</a></li><li class="nav-item"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" aria-controls="tabset-1-2" aria-selected="false" href="">物体识别</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" aria-labelledby="tabset-1-1-tab">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://jcwinning.github.io/LandingPage/posts/yolo-app/images/0.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption>应用程序截图 - 主界面</figcaption>
</figure>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" aria-labelledby="tabset-1-2-tab">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://jcwinning.github.io/LandingPage/posts/yolo-app/images/1.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption>应用程序截图 - 检测结果</figcaption>
</figure>
</div>
</div>
</div>
</div>
<section id="核心特性" class="level2">
<h2 class="anchored" data-anchor-id="核心特性">核心特性</h2>
<section id="多输入支持" class="level3">
<h3 class="anchored" data-anchor-id="多输入支持">多输入支持</h3>
<p>应用支持多种输入方式： - <strong>文件上传</strong>：从本地存储上传图像和视频。 - <strong>URL 输入</strong>：直接从网络输入图像 URL。 - <strong>实时相机</strong>：使用设备相机进行实时照片捕获。</p>
</section>
<section id="多模型架构" class="level3">
<h3 class="anchored" data-anchor-id="多模型架构">多模型架构</h3>
<p>其最突出的特性之一是支持不同的 AI 模型：</p>
<section id="本地-yolo11-模型" class="level4">
<h4 class="anchored" data-anchor-id="本地-yolo11-模型">1. 本地 YOLO11 模型</h4>
<ul>
<li>五种不同的模型变体（nano, small, medium, large, extra-large）。</li>
<li>自动设备检测，支持 Apple Silicon 的 MPS 加速。</li>
<li>在不支持加速的情况下自动回退至 CPU，确保更广的兼容性。</li>
</ul>
</section>
<section id="云端模型" class="level4">
<h4 class="anchored" data-anchor-id="云端模型">2. 云端模型</h4>
<ul>
<li>通过 DashScope API 调用 <strong>Qwen-Image-Edit</strong> 进行高级图像标注。</li>
<li>通过 OpenRouter API 调用 <strong>Gemini 2.5 Flash Image</strong> 进行前沿的图像处理。</li>
</ul>
</section>
</section>
<section id="高级功能" class="level3">
<h3 class="anchored" data-anchor-id="高级功能">高级功能</h3>
<ul>
<li><strong>双语界面</strong>：完整的英文/中文支持，包含 113+ 个翻译字段。</li>
<li><strong>智能 UI 管理</strong>：处理后自动隐藏输入图像。</li>
<li><strong>下载功能</strong>：支持将标注后的结果保存到本地。</li>
<li><strong>进度追踪</strong>：视频处理过程中的实时进度更新。</li>
<li><strong>会话管理</strong>：在用户交互过程中保持持久化状态。</li>
</ul>
</section>
</section>
<section id="技术架构" class="level2">
<h2 class="anchored" data-anchor-id="技术架构">技术架构</h2>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>

</div>
<p></p><figcaption> 系统架构图</figcaption> </figure><p></p>
</div>
</div>
</div>
<section id="核心依赖" class="level3">
<h3 class="anchored" data-anchor-id="核心依赖">核心依赖</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode toml code-with-copy"><code class="sourceCode toml"><span id="cb1-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[project]</span></span>
<span id="cb1-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">name</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"yolo-app"</span></span>
<span id="cb1-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">requires-python</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&gt;=3.12"</span></span>
<span id="cb1-4"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">dependencies</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb1-5">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dashscope&gt;=1.17.0"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span>      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 阿里云 API</span></span>
<span id="cb1-6">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"opencv-python&gt;=4.11.0.86"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 计算机视觉</span></span>
<span id="cb1-7">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"streamlit&gt;=1.50.0"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span>       <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Web 框架</span></span>
<span id="cb1-8">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"torch&gt;=2.2"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span>              <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 深度学习</span></span>
<span id="cb1-9">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ultralytics&gt;=8.3.0"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span>      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># YOLO 框架</span></span>
<span id="cb1-10"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span></code></pre></div></div>
</section>
<section id="应用程序结构" class="level3">
<h3 class="anchored" data-anchor-id="应用程序结构">应用程序结构</h3>
<p>主应用程序 (<code>app.py</code>) 由 1,000 多行结构良好的 Python 代码组成，主要分为以下几个组件：</p>
<section id="国际化系统" class="level4">
<h4 class="anchored" data-anchor-id="国际化系统">1. 国际化系统</h4>
<div id="e9a018b1" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> language <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> translations</span>
<span id="cb2-2"></span>
<span id="cb2-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_translation(key, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>kwargs):</span>
<span id="cb2-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""使用当前会话语言的翻译函数"""</span></span>
<span id="cb2-5">    lang <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> st.session_state.get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"language"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"en"</span>)</span>
<span id="cb2-6">    text <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> translations[lang].get(key, translations[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"en"</span>].get(key, key))</span>
<span id="cb2-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> text.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">format</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>kwargs) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> kwargs <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> text</span></code></pre></div></div>
</details>
</div>
</section>
<section id="设备优化" class="level4">
<h4 class="anchored" data-anchor-id="设备优化">2. 设备优化</h4>
<div id="0fc36c3e" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_device():</span>
<span id="cb3-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""自动检测最佳可用设备"""</span></span>
<span id="cb3-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> torch.backends.mps.is_available():</span>
<span id="cb3-4">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mps"</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Apple Silicon GPU 加速</span></span>
<span id="cb3-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cpu"</span>      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 回退至 CPU</span></span>
<span id="cb3-6"> </span>
<span id="cb3-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 模型加载与设备优化</span></span>
<span id="cb3-8">device <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_device()</span>
<span id="cb3-9">model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> YOLO(selected_model).to(device)</span>
<span id="cb3-10">st.info(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Using device: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>device<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>upper()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div></div>
</details>
</div>
</section>
<section id="图像处理流水线" class="level4">
<h4 class="anchored" data-anchor-id="图像处理流水线">3. 图像处理流水线</h4>
<div id="cbbc6a43" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> encode_image_to_base64(image):</span>
<span id="cb4-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""将 PIL 图像编码为 base64 字符串并进行尺寸压缩"""</span></span>
<span id="cb4-3">    max_size_bytes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 8MB 限制</span></span>
<span id="cb4-4"></span>
<span id="cb4-5">    formats_and_qualities <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb4-6">        (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"JPEG"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">95</span>), (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"JPEG"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">85</span>), (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"JPEG"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">75</span>),</span>
<span id="cb4-7">        (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"WEBP"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">95</span>), (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"WEBP"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">85</span>), (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"WEBP"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">75</span>),</span>
<span id="cb4-8">    ]</span>
<span id="cb4-9"></span>
<span id="cb4-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> fmt, quality <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> formats_and_qualities:</span>
<span id="cb4-11">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 尝试不同的压缩策略</span></span>
<span id="cb4-12">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ... 压缩逻辑</span></span></code></pre></div></div>
</details>
</div>
</section>
</section>
<section id="多模型处理" class="level3">
<h3 class="anchored" data-anchor-id="多模型处理">多模型处理</h3>
<section id="本地-yolo-处理" class="level4">
<h4 class="anchored" data-anchor-id="本地-yolo-处理">本地 YOLO 处理</h4>
<p>应用支持所有 YOLO11 模型变体，并具备自动性能优化：</p>
<div id="0288c7d6" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 模型选择界面</span></span>
<span id="cb5-2">model_options <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"yolo11n.pt"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"yolo11s.pt"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"yolo11m.pt"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"yolo11l.pt"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"yolo11x.pt"</span>]</span>
<span id="cb5-3">model_descriptions <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb5-4">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"yolo11n.pt"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Nano - 最快，精度最低"</span>,</span>
<span id="cb5-5">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"yolo11s.pt"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Small - 均衡性好"</span>,</span>
<span id="cb5-6">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"yolo11m.pt"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Medium - 推荐使用"</span>,</span>
<span id="cb5-7">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"yolo11l.pt"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Large - 精度较高"</span>,</span>
<span id="cb5-8">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"yolo11x.pt"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Extra Large - 精度最高"</span></span>
<span id="cb5-9">}</span>
<span id="cb5-10"></span>
<span id="cb5-11">selected_model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> st.sidebar.selectbox(</span>
<span id="cb5-12">    get_translation(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"model_selection"</span>),</span>
<span id="cb5-13">    model_options,</span>
<span id="cb5-14">    index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>model_options.index(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"yolo11s.pt"</span>),</span>
<span id="cb5-15">    format_func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> x: <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>model_descriptions[x]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> (</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">)"</span></span>
<span id="cb5-16">)</span>
<span id="cb5-17"></span>
<span id="cb5-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 带进度追踪的检测过程</span></span>
<span id="cb5-19"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> detect_objects(image, model, confidence_threshold<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>):</span>
<span id="cb5-20">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""执行带进度追踪的目标检测"""</span></span>
<span id="cb5-21">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> st.spinner(get_translation(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"processing"</span>)):</span>
<span id="cb5-22">        results <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.predict(image, conf<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>confidence_threshold)</span>
<span id="cb5-23"></span>
<span id="cb5-24">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 处理结果</span></span>
<span id="cb5-25">        detections <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb5-26">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> result <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> results:</span>
<span id="cb5-27">            boxes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> result.boxes</span>
<span id="cb5-28">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> box <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> boxes:</span>
<span id="cb5-29">                x1, y1, x2, y2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> box.xyxy[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].cpu().numpy()</span>
<span id="cb5-30">                conf <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> box.conf[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].cpu().numpy()</span>
<span id="cb5-31">                cls <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(box.cls[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].cpu().numpy())</span>
<span id="cb5-32">                class_name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.names[cls]</span>
<span id="cb5-33"></span>
<span id="cb5-34">                detections.append({</span>
<span id="cb5-35">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'class'</span>: class_name,</span>
<span id="cb5-36">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'confidence'</span>: conf,</span>
<span id="cb5-37">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bbox'</span>: [x1, y1, x2, y2]</span>
<span id="cb5-38">                })</span>
<span id="cb5-39"></span>
<span id="cb5-40">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> detections, results</span></code></pre></div></div>
</details>
</div>
</section>
<section id="云端-api-集成" class="level4">
<h4 class="anchored" data-anchor-id="云端-api-集成">云端 API 集成</h4>
<p>对于云端模型，应用负责 API 身份验证和请求格式化：</p>
<div id="3217db15" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> process_with_qwen(image, api_key):</span>
<span id="cb6-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""使用阿里云 DashScope 提供的 Qwen-Image-Edit 处理图像"""</span></span>
<span id="cb6-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb6-4">        response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> MultiModalConversation.call(</span>
<span id="cb6-5">            model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'qwen-image-edit'</span>,</span>
<span id="cb6-6">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[</span>
<span id="cb6-7">                {</span>
<span id="cb6-8">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'role'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'user'</span>,</span>
<span id="cb6-9">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'content'</span>: [</span>
<span id="cb6-10">                        {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'image'</span>: <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"data:image/jpeg;base64,</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>image_b64<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>},</span>
<span id="cb6-11">                        {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'text'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Please identify and label all objects in this image.'</span>}</span>
<span id="cb6-12">                    ]</span>
<span id="cb6-13">                }</span>
<span id="cb6-14">            ]</span>
<span id="cb6-15">        )</span>
<span id="cb6-16">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> response</span>
<span id="cb6-17">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">Exception</span> <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> e:</span>
<span id="cb6-18">        st.error(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"API Error: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(e)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb6-19">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span></code></pre></div></div>
</details>
</div>
</section>
</section>
</section>
<section id="用户界面设计" class="level2">
<h2 class="anchored" data-anchor-id="用户界面设计">用户界面设计</h2>
<section id="布局结构" class="level3">
<h3 class="anchored" data-anchor-id="布局结构">布局结构</h3>
<p>应用程序采用专业的三个分栏布局：</p>
<ol type="1">
<li><strong>侧边栏</strong>：模型选择、置信度阈值、语言设置。</li>
<li><strong>主区域</strong>：输入方式选择、图像/视频显示、结果展示。</li>
<li><strong>结果面板</strong>：检测统计、下载选项。</li>
</ol>
</section>
<section id="双语支持" class="level3">
<h3 class="anchored" data-anchor-id="双语支持">双语支持</h3>
<p>翻译系统管理所有的 UI 元素：</p>
<div id="34a243be" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1">translations <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb7-2">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"en"</span>: {</span>
<span id="cb7-3">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"title"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"YOLO11 Object Detection"</span>,</span>
<span id="cb7-4">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"upload_file"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Upload File"</span>,</span>
<span id="cb7-5">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"camera_input"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Use Camera"</span>,</span>
<span id="cb7-6">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ... 更多字段</span></span>
<span id="cb7-7">    },</span>
<span id="cb7-8">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"zh"</span>: {</span>
<span id="cb7-9">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"title"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"YOLO11 目标检测"</span>,</span>
<span id="cb7-10">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"upload_file"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"上传文件"</span>,</span>
<span id="cb7-11">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"camera_input"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"使用相机"</span>,</span>
<span id="cb7-12">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ... 对应的中文翻译</span></span>
<span id="cb7-13">    }</span>
<span id="cb7-14">}</span></code></pre></div></div>
</details>
</div>
</section>
</section>
<section id="性能优化" class="level2">
<h2 class="anchored" data-anchor-id="性能优化">性能优化</h2>
<section id="模型性能对比" class="level3">
<h3 class="anchored" data-anchor-id="模型性能对比">模型性能对比</h3>
<table class="caption-top table">
<thead>
<tr class="header">
<th>模型</th>
<th>参数量</th>
<th>mAP</th>
<th>推理时间 (CPU)</th>
<th>推理时间 (MPS)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>YOLO11n</td>
<td>2.6M</td>
<td>37.2</td>
<td>15ms</td>
<td>3ms</td>
</tr>
<tr class="even">
<td>YOLO11s</td>
<td>9.4M</td>
<td>45.5</td>
<td>28ms</td>
<td>6ms</td>
</tr>
<tr class="odd">
<td>YOLO11m</td>
<td>25.4M</td>
<td>51.2</td>
<td>52ms</td>
<td>12ms</td>
</tr>
<tr class="even">
<td>YOLO11l</td>
<td>43.7M</td>
<td>53.4</td>
<td>84ms</td>
<td>18ms</td>
</tr>
<tr class="odd">
<td>YOLO11x</td>
<td>68.2M</td>
<td>54.7</td>
<td>126ms</td>
<td>26ms</td>
</tr>
</tbody>
</table>
</section>
<section id="apple-silicon-加速" class="level3">
<h3 class="anchored" data-anchor-id="apple-silicon-加速">Apple Silicon 加速</h3>
<p>该应用会自动检测并在 Apple Silicon 设备上利用 Metal Performance Shaders (MPS)：</p>
<div id="99a3bce5" class="cell" data-execution_count="7">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1">device <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mps"</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> torch.backends.mps.is_available() <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cpu"</span></span>
<span id="cb8-2">model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> YOLO(selected_model).to(device)</span>
<span id="cb8-3"></span>
<span id="cb8-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 性能监控</span></span>
<span id="cb8-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> time</span>
<span id="cb8-6">start_time <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> time.time()</span>
<span id="cb8-7">results <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.predict(image)</span>
<span id="cb8-8">inference_time <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (time.time() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> start_time) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span></span>
<span id="cb8-9"></span>
<span id="cb8-10">st.metric(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"推理时间 (</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>device<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>upper()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">)"</span>, <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>inference_time<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">ms"</span>)</span></code></pre></div></div>
</details>
</div>
</section>
<section id="云端-api-的图像压缩" class="level3">
<h3 class="anchored" data-anchor-id="云端-api-的图像压缩">云端 API 的图像压缩</h3>
<p>为了满足 API 的大小限制，应用实现了智能图像压缩：</p>
<div id="1df2e271" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> compress_image_for_api(image, max_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>):</span>
<span id="cb9-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""压缩图像以满足 API 要求"""</span></span>
<span id="cb9-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> quality <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">95</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">85</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">75</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">65</span>]:</span>
<span id="cb9-4">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> fmt <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"JPEG"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"WEBP"</span>]:</span>
<span id="cb9-5">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">buffer</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> BytesIO()</span>
<span id="cb9-6">            image.save(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">buffer</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">format</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>fmt, quality<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>quality)</span>
<span id="cb9-7">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">buffer</span>.tell() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> max_size:</span>
<span id="cb9-8">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">buffer</span>.getvalue()</span>
<span id="cb9-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span></code></pre></div></div>
</details>
</div>
</section>
</section>
<section id="部署与生产特性" class="level2">
<h2 class="anchored" data-anchor-id="部署与生产特性">部署与生产特性</h2>
<section id="会话管理" class="level3">
<h3 class="anchored" data-anchor-id="会话管理">会话管理</h3>
<p>应用程序维护着全面的会话状态：</p>
<div id="e939fe1f" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1">session_state_vars <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb10-2">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"current_image"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"uploaded_image_bytes"</span>,</span>
<span id="cb10-3">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"current_video"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"uploaded_video_bytes"</span>,</span>
<span id="cb10-4">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"camera_active"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"camera_frame"</span>,</span>
<span id="cb10-5">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"qwen_processed"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gemini_processed"</span>,</span>
<span id="cb10-6">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"language"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"input_method_index"</span></span>
<span id="cb10-7">]</span></code></pre></div></div>
</details>
</div>
</section>
<section id="错误处理" class="level3">
<h3 class="anchored" data-anchor-id="错误处理">错误处理</h3>
<p>健壮的错误处理确保了优雅的降级服务：</p>
<div id="d8a1421f" class="cell" data-execution_count="10">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb11-2">    result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.predict(image, conf<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>confidence_threshold)</span>
<span id="cb11-3">    st.success(get_translation(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"detection_success"</span>))</span>
<span id="cb11-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">Exception</span> <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> e:</span>
<span id="cb11-5">    st.error(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"检测失败: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(e)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb11-6">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 回退至备选处理方法</span></span></code></pre></div></div>
</details>
</div>
</section>
</section>
<section id="快速开始" class="level2">
<h2 class="anchored" data-anchor-id="快速开始">快速开始</h2>
<section id="前提条件" class="level3">
<h3 class="anchored" data-anchor-id="前提条件">前提条件</h3>
<ul>
<li>Python 3.12 或更高版本</li>
<li>现代包管理器（推荐使用 uv）</li>
<li>对于云端模型：需要 DashScope 和 OpenRouter 的 API 密钥</li>
</ul>
</section>
<section id="安装步骤" class="level3">
<h3 class="anchored" data-anchor-id="安装步骤">安装步骤</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 克隆仓库</span></span>
<span id="cb12-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">git</span> clone <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>repository-url<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb12-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">cd</span> YOLO_app</span>
<span id="cb12-4"></span>
<span id="cb12-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 使用 uv 同步依赖（推荐）</span></span>
<span id="cb12-6"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uv</span> sync</span>
<span id="cb12-7"></span>
<span id="cb12-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 备选：使用 pip 安装</span></span>
<span id="cb12-9"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pip</span> install <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-r</span> requirements.txt</span>
<span id="cb12-10"></span>
<span id="cb12-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 运行应用</span></span>
<span id="cb12-12"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">streamlit</span> run app.py</span></code></pre></div></div>
</section>
<section id="api-配置" class="level3">
<h3 class="anchored" data-anchor-id="api-配置">API 配置</h3>
<p>创建一个包含 API 密钥的 <code>.env</code> 文件：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb13-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 阿里云 DashScope API</span></span>
<span id="cb13-2"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">DASHSCOPE_API_KEY</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>您的密钥</span>
<span id="cb13-3"></span>
<span id="cb13-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># OpenRouter API (用于 Gemini)</span></span>
<span id="cb13-5"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">OPENROUTER_API_KEY</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>您的密钥</span></code></pre></div></div>
</section>
<section id="快速使用示例" class="level3">
<h3 class="anchored" data-anchor-id="快速使用示例">快速使用示例</h3>
<section id="基础图像检测" class="level4">
<h4 class="anchored" data-anchor-id="基础图像检测">基础图像检测</h4>
<ol type="1">
<li>启动应用程序。</li>
<li>上传图像或提供图像 URL。</li>
<li>选择您偏好的 YOLO11 模型（推荐使用 yolo11s.pt）。</li>
<li>根据需要调整置信度阈值。</li>
<li>点击“开始检测”。</li>
<li>查看结果并下载标注后的图像。</li>
</ol>
</section>
<section id="实时相机检测" class="level4">
<h4 class="anchored" data-anchor-id="实时相机检测">实时相机检测</h4>
<ol type="1">
<li>选择“使用相机”输入方式。</li>
<li>在提示时授予相机权限。</li>
<li>拍摄照片。</li>
<li>选择检测模型。</li>
<li>获取即时的目标检测结果。</li>
</ol>
</section>
<section id="云端模型处理" class="level4">
<h4 class="anchored" data-anchor-id="云端模型处理">云端模型处理</h4>
<ol type="1">
<li>在侧边栏输入您的 API 密钥。</li>
<li>上传图像。</li>
<li>选择 “Qwen-Image-Edit” 或 “Gemini 2.5 Flash” 模型。</li>
<li>利用先进的 AI 能力处理图像。</li>
<li>将结果与本地 YOLO 模型进行对比。</li>
</ol>
</section>
</section>
</section>
<section id="未来增强方向" class="level2">
<h2 class="anchored" data-anchor-id="未来增强方向">未来增强方向</h2>
<p>未来版本的潜在改进点：</p>
<ol type="1">
<li><strong>更多模型</strong>：集成更多的云端 AI 服务。</li>
<li><strong>实时视频处理</strong>：增强视频流处理能力。</li>
<li><strong>自定义模型训练</strong>：允许用户训练自定义 YOLO 模型。</li>
<li><strong>移动端优化</strong>：为移动设备支持提供 PWA 特性。</li>
<li><strong>批量处理</strong>：同时处理多张图像。</li>
</ol>
</section>
<section id="结论" class="level2">
<h2 class="anchored" data-anchor-id="结论">结论</h2>
<p>这款 YOLO 目标检测应用展示了如何构建一个复杂的、生产级别的计算机视觉系统。本地和云端模型的结合、双语支持以及全面的错误处理，使其不仅适用于开发环境，也适用于生产环境。</p>
<p>该项目展示了以下方面的最佳实践： - 使用现代包管理工具进行 Python 开发。 - Streamlit Web 应用程序架构。 - 计算机视觉 API 集成。 - 国际化与可访问性。 - 针对不同硬件平台的性能优化。</p>
<p>无论您是对计算机视觉、Web 开发还是 AI 应用感兴趣，本项目都为您提供了一个构建先进 AI 驱动 Web 应用的坚实基础。</p>
<hr>


<!-- -->

</section>
</section>

 ]]></description>
  <category>AI</category>
  <category>API</category>
  <category>tutorial</category>
  <guid>https://jcwinning.github.io/LandingPage/posts/yolo-app/</guid>
  <pubDate>Tue, 04 Nov 2025 16:00:00 GMT</pubDate>
  <media:content url="https://jcwinning.github.io/LandingPage/posts/yolo-app/images/0.png" medium="image" type="image/png" height="83" width="144"/>
</item>
<item>
  <title>MCP 教程：将麦当劳服务与 AI Agent 集成</title>
  <dc:creator>Tony D</dc:creator>
  <link>https://jcwinning.github.io/LandingPage/posts/MCP/</link>
  <description><![CDATA[ 





<section id="什么是模型上下文协议-mcp" class="level1">
<h1>什么是模型上下文协议 (MCP)？</h1>
<p><strong>模型上下文协议 (Model Context Protocol, MCP)</strong> 是一项开放标准，旨在使 AI 模型能够无缝连接外部数据源和工具。 它由 Anthropic 开发，充当一个通用接口（类似于 USB 接口），允许开发者为大语言模型（LLM）提供对本地文件、数据库和第三方 API 的标准化、安全访问，而无需为每个特定服务编写自定义集成。</p>
<p>通过使用 MCP，AI Agent 可以“触及”物理世界，执行诸如查看库存、查询营养数据，甚至领取优惠券等任务——正如我们将在本教程中使用麦当劳服务所演示的那样。</p>
</section>
<section id="设置-mcp" class="level1">
<h1>设置 MCP</h1>
<section id="获取密钥" class="level2">
<h2 class="anchored" data-anchor-id="获取密钥">获取密钥</h2>
<ol type="1">
<li><p>从 https://openrouter.ai 获取 LLM 模型 API Key。</p></li>
<li><p>从 https://open.mcd.cn/mcp 获取访问 mcd-mcp 的 <code>MCD_TOKEN</code>。</p></li>
</ol>
<p>并将它们保存到 <code>.env</code> 文件中：</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1">OPENROUTER_API_KEY<span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span>xxxxxx</span>
<span id="cb1-2"></span>
<span id="cb1-3">MCD_TOKEN<span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span>XXXX</span></code></pre></div>
</details>
</div>
</section>
</section>
<section id="在代码中使用-mcp" class="level1">
<h1>在代码中使用 MCP</h1>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" aria-controls="tabset-1-1" aria-selected="true" href="">R 代码实现</a></li><li class="nav-item"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" aria-controls="tabset-1-2" aria-selected="false" href="">Python 代码实现</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" aria-labelledby="tabset-1-1-tab">
<section id="初始化集成-mcp-工具的聊天" class="level3">
<h3 class="anchored" data-anchor-id="初始化集成-mcp-工具的聊天">初始化集成 MCP 工具的聊天</h3>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ellmer)</span>
<span id="cb2-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(mcptools)</span>
<span id="cb2-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dotenv)</span>
<span id="cb2-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load environment variables</span></span>
<span id="cb2-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">load_dot_env</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">file =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".env"</span>)</span>
<span id="cb2-6"></span>
<span id="cb2-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define model </span></span>
<span id="cb2-8">model_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x-ai/grok-4.1-fast"</span></span></code></pre></div>
</details>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create an ellmer chat object (using OpenRouter as example)</span></span>
<span id="cb3-2">chat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">chat_openrouter</span>(</span>
<span id="cb3-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">system_prompt =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"您是一位麦当劳助手。请简短回答。"</span>,</span>
<span id="cb3-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">api_key =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Sys.getenv</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"OPENROUTER_API_KEY"</span>),</span>
<span id="cb3-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">model =</span> model_name,</span>
<span id="cb3-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">echo =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"output"</span></span>
<span id="cb3-7">)</span>
<span id="cb3-8"></span>
<span id="cb3-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create dynamic configuration with token from environment</span></span>
<span id="cb3-10">config_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb3-11">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mcpServers =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb3-12">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mcd-mcp"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb3-13">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">command =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"npx"</span>,</span>
<span id="cb3-14">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">args =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(</span>
<span id="cb3-15">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mcp-remote"</span>,</span>
<span id="cb3-16">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://mcp.mcd.cn/mcp-servers/mcd-mcp"</span>,</span>
<span id="cb3-17">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"--header"</span>,</span>
<span id="cb3-18">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Authorization: Bearer "</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Sys.getenv</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"MCD_TOKEN"</span>))</span>
<span id="cb3-19">      )</span>
<span id="cb3-20">    )</span>
<span id="cb3-21">  )</span>
<span id="cb3-22">)</span>
<span id="cb3-23"></span>
<span id="cb3-24">config_file <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tempfile</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fileext =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".json"</span>)</span>
<span id="cb3-25">jsonlite<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write_json</span>(config_data, config_file, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">auto_unbox =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb3-26"></span>
<span id="cb3-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load MCP tools via the temporary configuration file</span></span>
<span id="cb3-28">mcd_tools <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mcp_tools</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">config =</span> config_file)</span>
<span id="cb3-29"></span>
<span id="cb3-30"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Register the MCP tools with the chat</span></span>
<span id="cb3-31">chat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set_tools</span>(mcd_tools)</span></code></pre></div>
</details>
</div>
</section>
<section id="集成-mcp-的对话测试" class="level3">
<h3 class="anchored" data-anchor-id="集成-mcp-的对话测试">集成 MCP 的对话测试</h3>
<p>现在你可以提问，AI 将使用麦当劳 MCP 工具：</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Query available coupons</span></span>
<span id="cb4-2">chat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">chat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"目前有什么优惠券"</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>您当前可用的麦麦省优惠券（均已领取）：

- 北非蛋风味麦满分特惠组合
- 9.9元大薯条
- 9.9元新派组合
- 北非蛋风味麦满分</code></pre>
</div>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Auto-claim all coupons</span></span>
<span id="cb6-2">chat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">chat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"帮我领取所有优惠券"</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>暂无可领取的优惠券，所有可用券已领取！</code></pre>
</div>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get nutrition information</span></span>
<span id="cb8-2">chat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">chat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"帮我建议一个1000卡路里的套餐，需要包括有糖可乐。"</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>**推荐套餐（总热量 ≈1011 kcal）：**

- 麦辣鸡腿汉堡（485 kcal）
- 大薯条（379 kcal，使用9.9元优惠券）
- 可乐中杯（147 kcal）

营养均衡，辣味主食+薯条+甜饮，超值！</code></pre>
</div>
</div>
</section>
</div>
<div id="tabset-1-2" class="tab-pane" aria-labelledby="tabset-1-2-tab">
<section id="初始化集成-mcp-工具的聊天-1" class="level3">
<h3 class="anchored" data-anchor-id="初始化集成-mcp-工具的聊天-1">初始化集成 MCP 工具的聊天</h3>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb10-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> asyncio</span>
<span id="cb10-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv</span>
<span id="cb10-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_mcp_adapters.client <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> MultiServerMCPClient</span>
<span id="cb10-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChatOpenAI</span>
<span id="cb10-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langgraph.prebuilt <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> create_react_agent</span>
<span id="cb10-7"></span>
<span id="cb10-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load environment variables</span></span>
<span id="cb10-9">load_dotenv()</span>
<span id="cb10-10"></span>
<span id="cb10-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define model (using OpenRouter)</span></span>
<span id="cb10-12">model_name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x-ai/grok-4.1-fast"</span></span>
<span id="cb10-13"></span>
<span id="cb10-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create the LLM with OpenRouter</span></span>
<span id="cb10-15">llm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatOpenAI(</span>
<span id="cb10-16">    model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>model_name,</span>
<span id="cb10-17">    openai_api_key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>os.getenv(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"OPENROUTER_API_KEY"</span>),</span>
<span id="cb10-18">    openai_api_base<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://openrouter.ai/api/v1"</span>,</span>
<span id="cb10-19">    temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb10-20">)</span>
<span id="cb10-21"></span>
<span id="cb10-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Build the mcp-remote command with authorization header</span></span>
<span id="cb10-23">mcd_token <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> os.getenv(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"MCD_TOKEN"</span>)</span>
<span id="cb10-24">mcp_command_args <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb10-25">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mcp-remote"</span>,</span>
<span id="cb10-26">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://mcp.mcd.cn/mcp-servers/mcd-mcp"</span>,</span>
<span id="cb10-27">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"--header"</span>,</span>
<span id="cb10-28">    <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Authorization: Bearer </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>mcd_token<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb10-29">]</span>
<span id="cb10-30"></span>
<span id="cb10-31"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Configure the MCP client</span></span>
<span id="cb10-32">mcp_config <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb10-33">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mcd-mcp"</span>: {</span>
<span id="cb10-34">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"command"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"npx"</span>,</span>
<span id="cb10-35">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"args"</span>: mcp_command_args,</span>
<span id="cb10-36">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"transport"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"stdio"</span></span>
<span id="cb10-37">    }</span>
<span id="cb10-38">}</span>
<span id="cb10-39"></span>
<span id="cb10-40"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">async</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> run_mcp_agent(query: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>):</span>
<span id="cb10-41">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Run an MCP-enabled agent with the given query."""</span></span>
<span id="cb10-42">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create client (no context manager in v0.1.0+)</span></span>
<span id="cb10-43">    client <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> MultiServerMCPClient(mcp_config)</span>
<span id="cb10-44">    </span>
<span id="cb10-45">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get tools from MCP server (await required)</span></span>
<span id="cb10-46">    tools <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> client.get_tools()</span>
<span id="cb10-47">    </span>
<span id="cb10-48">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a ReAct agent with the tools</span></span>
<span id="cb10-49">    agent <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> create_react_agent(llm, tools)</span>
<span id="cb10-50">    </span>
<span id="cb10-51">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Run the agent</span></span>
<span id="cb10-52">    result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> agent.ainvoke({</span>
<span id="cb10-53">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"messages"</span>: [</span>
<span id="cb10-54">            {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"role"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"system"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"content"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are a helpful assistant that can interact with McDonald's services. Please be concise."</span>},</span>
<span id="cb10-55">            {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"role"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"user"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"content"</span>: query}</span>
<span id="cb10-56">        ]</span>
<span id="cb10-57">    })</span>
<span id="cb10-58">    </span>
<span id="cb10-59">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Return the final response</span></span>
<span id="cb10-60">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"messages"</span>][<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].content</span></code></pre></div>
</details>
</div>
</section>
<section id="集成-mcp-的对话测试-1" class="level3">
<h3 class="anchored" data-anchor-id="集成-mcp-的对话测试-1">集成 MCP 的对话测试</h3>
<p>现在你可以提问，AI 将使用麦当劳 MCP 工具：</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Query available coupons</span></span>
<span id="cb11-2">asyncio.run(run_mcp_agent(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"What coupons are available right now?"</span>))</span></code></pre></div>
</details>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Auto-claim all coupons</span></span>
<span id="cb12-2">asyncio.run(run_mcp_agent(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Help me claim all available coupons."</span>))</span></code></pre></div>
</details>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check your coupons</span></span>
<span id="cb13-2">asyncio.run(run_mcp_agent(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Show me all my current coupons."</span>))</span></code></pre></div>
</details>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb14-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Query campaign calendar</span></span>
<span id="cb14-2">asyncio.run(run_mcp_agent(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"What exciting activities are happening in the next 15 days?"</span>))</span></code></pre></div>
</details>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb15-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get nutrition information</span></span>
<span id="cb15-2">asyncio.run(run_mcp_agent(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Help me design a 1000-calorie meal that includes a sugared cola and costs no more than 30 yuan."</span>))</span></code></pre></div>
</details>
</div>
</section>
</div>
</div>
</div>
</section>
<section id="在-agent-中使用-mcp" class="level1">
<h1>在 Agent 中使用 MCP</h1>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-2-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-1" aria-controls="tabset-2-1" aria-selected="true" href="">Claude Code CLI</a></li><li class="nav-item"><a class="nav-link" id="tabset-2-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-2" aria-controls="tabset-2-2" aria-selected="false" href="">Gemini CLI</a></li><li class="nav-item"><a class="nav-link" id="tabset-2-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-3" aria-controls="tabset-2-3" aria-selected="false" href="">Opencode CLI</a></li><li class="nav-item"><a class="nav-link" id="tabset-2-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-4" aria-controls="tabset-2-4" aria-selected="false" href="">Antigravity IDE</a></li><li class="nav-item"><a class="nav-link" id="tabset-2-5-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-5" aria-controls="tabset-2-5" aria-selected="false" href="">Trae IDE</a></li><li class="nav-item"><a class="nav-link" id="tabset-2-6-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-6" aria-controls="tabset-2-6" aria-selected="false" href="">Cody Buddy</a></li><li class="nav-item"><a class="nav-link" id="tabset-2-7-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-7" aria-controls="tabset-2-7" aria-selected="false" href="">Qoder</a></li><li class="nav-item"><a class="nav-link" id="tabset-2-8-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-8" aria-controls="tabset-2-8" aria-selected="false" href="">Cline VS Code</a></li></ul>
<div class="tab-content">
<div id="tabset-2-1" class="tab-pane active" aria-labelledby="tabset-2-1-tab">
<p>将 “xxx” 替换为你的 Token，并将以下设置添加到用户级或项目级配置文件中。</p>
<section id="json-文件配置" class="level3">
<h3 class="anchored" data-anchor-id="json-文件配置">JSON 文件配置</h3>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1">{</span>
<span id="cb16-2">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mcpServers"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> {</span>
<span id="cb16-3">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mcd-mcp"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> {</span>
<span id="cb16-4">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"http"</span>,</span>
<span id="cb16-5">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"url"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://mcp.mcd.cn/mcp-servers/mcd-mcp"</span>,</span>
<span id="cb16-6">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"headers"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> {</span>
<span id="cb16-7">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Authorization"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Bearer xxx"</span></span>
<span id="cb16-8">      }</span>
<span id="cb16-9">    }</span>
<span id="cb16-10">  }</span>
<span id="cb16-11">}</span></code></pre></div>
</details>
</div>
<p><em>用户级配置文件</em>:</p>
<p>~/.claude.json</p>
<p><em>项目级配置文件</em>:</p>
<p>your_project/.mcp.json</p>
</section>
<section id="提问-what-coupons-are-available-right-now" class="level3">
<h3 class="anchored" data-anchor-id="提问-what-coupons-are-available-right-now">提问: “What coupons are available right now?”</h3>
<p><img src="https://jcwinning.github.io/LandingPage/posts/MCP/images/clipboard-3343486679.png" class="img-fluid" width="700"></p>
</section>
</div>
<div id="tabset-2-2" class="tab-pane" aria-labelledby="tabset-2-2-tab">
<p>将 “xxx” 替换为你的 Token，并将以下设置添加到用户级或项目级配置文件中。</p>
<section id="json-文件配置-1" class="level3">
<h3 class="anchored" data-anchor-id="json-文件配置-1">JSON 文件配置</h3>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb17-1">{</span>
<span id="cb17-2"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mcpServers"</span>: {</span>
<span id="cb17-3">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mcd-mcp"</span>: {</span>
<span id="cb17-4">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"url"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://mcp.mcd.cn/mcp-servers/mcd-mcp"</span>,</span>
<span id="cb17-5">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"headers"</span>: {</span>
<span id="cb17-6">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Authorization"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Bearer xxx"</span></span>
<span id="cb17-7">      }</span>
<span id="cb17-8">    }</span>
<span id="cb17-9">  } </span>
<span id="cb17-10">} </span></code></pre></div>
</details>
</div>
<p><em>用户级配置</em>:</p>
<p>~/.gemini/settings.json</p>
<p><em>项目级配置</em>:</p>
<p>your_project/.gemini/settings.json</p>
</section>
<section id="提问-what-coupons-are-available-right-now-1" class="level3">
<h3 class="anchored" data-anchor-id="提问-what-coupons-are-available-right-now-1">提问: “What coupons are available right now?”</h3>
<p><img src="https://jcwinning.github.io/LandingPage/posts/MCP/images/clipboard-1202098417.png" class="img-fluid" width="700"></p>
</section>
</div>
<div id="tabset-2-3" class="tab-pane" aria-labelledby="tabset-2-3-tab">
<p>将 “xxx” 替换为你的 Token，并将以下设置添加到用户级或项目级配置文件中。</p>
<section id="json-文件配置-2" class="level3">
<h3 class="anchored" data-anchor-id="json-文件配置-2">JSON 文件配置</h3>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb18-1">{</span>
<span id="cb18-2">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"$schema"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://opencode.ai/config.json"</span>,</span>
<span id="cb18-3">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mcp"</span>: {</span>
<span id="cb18-4">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mcd-mcp"</span>: {</span>
<span id="cb18-5">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"remote"</span>,</span>
<span id="cb18-6">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"url"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://mcp.mcd.cn/mcp-servers/mcd-mcp"</span>,</span>
<span id="cb18-7">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"enabled"</span>: true,</span>
<span id="cb18-8">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"headers"</span>: {</span>
<span id="cb18-9">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Authorization"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Bearer xxx"</span></span>
<span id="cb18-10">      }</span>
<span id="cb18-11">    }</span>
<span id="cb18-12">  }</span>
<span id="cb18-13">}</span></code></pre></div>
</details>
</div>
<p><em>用户级配置</em>:</p>
<p>~/.opencode.json</p>
<p><em>项目级配置</em>:</p>
<p>.config/opencode/opencode.json</p>
</section>
<section id="提问-what-coupons-are-available-right-now-2" class="level3">
<h3 class="anchored" data-anchor-id="提问-what-coupons-are-available-right-now-2">提问: “What coupons are available right now?”</h3>
<p><img src="https://jcwinning.github.io/LandingPage/posts/MCP/images/clipboard-4015309059.png" class="img-fluid"></p>
</section>
</div>
<div id="tabset-2-4" class="tab-pane" aria-labelledby="tabset-2-4-tab">
<p>将 “xxx” 替换为你的 Token，并将以下设置添加到用户级或项目级配置文件中。</p>
<section id="json-文件配置-3" class="level3">
<h3 class="anchored" data-anchor-id="json-文件配置-3">JSON 文件配置</h3>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb19-1">{</span>
<span id="cb19-2">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mcpServers"</span>: {</span>
<span id="cb19-3">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mcd-mcp"</span>: {</span>
<span id="cb19-4">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"serverUrl"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://mcp.mcd.cn/mcp-servers/mcd-mcp"</span>,</span>
<span id="cb19-5">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"headers"</span>: {</span>
<span id="cb19-6">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Authorization"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Bearer xxx"</span></span>
<span id="cb19-7">      }</span>
<span id="cb19-8">    }</span>
<span id="cb19-9">  }</span>
<span id="cb19-10">}</span></code></pre></div>
</details>
</div>
<p><em>用户级配置</em>:</p>
<p>~/.gemini/antigravity/mcp_config.json</p>
<p><em>项目级配置</em>:</p>
<p>暂不支持</p>
</section>
<section id="提问-what-coupons-are-available-right-now-3" class="level3">
<h3 class="anchored" data-anchor-id="提问-what-coupons-are-available-right-now-3">提问: “What coupons are available right now?”</h3>
<p><img src="https://jcwinning.github.io/LandingPage/posts/MCP/images/clipboard-4292207523.png" class="img-fluid"></p>
</section>
</div>
<div id="tabset-2-5" class="tab-pane" aria-labelledby="tabset-2-5-tab">
<p>将 “xxx” 替换为你的 Token，并将以下设置添加到用户级或项目级配置文件中。</p>
<section id="json-文件配置-4" class="level3">
<h3 class="anchored" data-anchor-id="json-文件配置-4">JSON 文件配置</h3>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb20-1">{</span>
<span id="cb20-2">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mcpServers"</span>: {</span>
<span id="cb20-3">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mcd-mcp"</span>: {</span>
<span id="cb20-4">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"command"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"npx"</span>,</span>
<span id="cb20-5">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"args"</span>: [</span>
<span id="cb20-6">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mcp-remote"</span>,</span>
<span id="cb20-7">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://mcp.mcd.cn/mcp-servers/mcd-mcp"</span>,</span>
<span id="cb20-8">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"--header"</span>,</span>
<span id="cb20-9">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Authorization: Bearer xxx"</span></span>
<span id="cb20-10">      ]</span>
<span id="cb20-11">    }</span>
<span id="cb20-12">  }</span>
<span id="cb20-13">}</span></code></pre></div>
</details>
</div>
<p><em>用户级配置</em>:</p>
<p>~/user/Library/Application Support/Trae/User/mcp.json</p>
<p><em>项目级配置</em>:</p>
<p>your_project/.trae/mcp.json</p>
</section>
<section id="开启-trae-项目级设置-setting---beta---enable-project-mcp" class="level3">
<h3 class="anchored" data-anchor-id="开启-trae-项目级设置-setting---beta---enable-project-mcp">开启 Trae 项目级设置: Setting -&gt; Beta -&gt; Enable project MCP</h3>
</section>
<section id="切换模式为-builder-并提问-what-coupons-are-available-right-now" class="level3">
<h3 class="anchored" data-anchor-id="切换模式为-builder-并提问-what-coupons-are-available-right-now">切换模式为 <span class="citation" data-cites="Builder">@Builder</span> 并提问: “What coupons are available right now?”</h3>
<p><img src="https://jcwinning.github.io/LandingPage/posts/MCP/images/clipboard-1218453575.png" class="img-fluid"></p>
</section>
</div>
<div id="tabset-2-6" class="tab-pane" aria-labelledby="tabset-2-6-tab">
<p>Coming soon</p>
</div>
<div id="tabset-2-7" class="tab-pane" aria-labelledby="tabset-2-7-tab">
<p>Coming soon</p>
</div>
<div id="tabset-2-8" class="tab-pane" aria-labelledby="tabset-2-8-tab">
<p>Coming soon</p>
</div>
</div>
</div>


<!-- -->

</section>

 ]]></description>
  <category>AI</category>
  <category>API</category>
  <category>tutorial</category>
  <guid>https://jcwinning.github.io/LandingPage/posts/MCP/</guid>
  <pubDate>Sat, 01 Nov 2025 16:00:00 GMT</pubDate>
  <media:content url="https://jcwinning.github.io/LandingPage/posts/MCP/images/0.png" medium="image" type="image/png" height="74" width="144"/>
</item>
<item>
  <title>R 和 Python 中的检索增强生成 (RAG)</title>
  <dc:creator>Tony D</dc:creator>
  <link>https://jcwinning.github.io/LandingPage/posts/RAG/</link>
  <description><![CDATA[ 





<section id="简介" class="level1">
<h1>简介</h1>
<p>检索增强生成 (Retrieval-Augmented Generation, RAG) 是一种强大的技术，它将大型语言模型 (LLM) 的生成能力与信息检索的精准性相结合。通过将 LLM 的响应锚定在外部、可验证的数据中，RAG 减少了幻觉，并使模型能够回答关于特定、私有或最新信息的问题。</p>
<p>在本教程中，我们将使用 R 和 Python 构建一个 RAG 系统。</p>
<p>在 R 中，我们将利用 <code>ragnar</code> 包处理 RAG 工作流，并使用 <code>ellmer</code> 提供聊天界面。</p>
<p>在 Python 中，我们将使用 <code>LangChain</code> 构建 RAG 流水线，使用 <code>ChromaDB</code> 作为向量数据库，并使用 <code>OpenAI</code> 进行模型交互。</p>
<p>我们的目标是创建一个系统，通过爬取 OpenRouter API 的文档，来回答与其相关的问题。</p>
</section>
<section id="数据采集" class="level1">
<h1>数据采集</h1>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" aria-controls="tabset-1-1" aria-selected="true" href="">R</a></li><li class="nav-item"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" aria-controls="tabset-1-2" aria-selected="false" href="">Python</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" aria-labelledby="tabset-1-1-tab">
<p>首先，我们需要为知识库收集数据。我们将使用 <code>rvest</code> 包从 OpenRouter 文档中爬取 URL。这将为我们提供待接入的页面列表。</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ragnar)</span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ellmer)</span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dotenv)</span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">load_dot_env</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">file =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".env"</span>)</span></code></pre></div></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(rvest)</span>
<span id="cb2-2"></span>
<span id="cb2-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 待爬取的 URL</span></span>
<span id="cb2-4">url <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://openrouter.ai/docs/quickstart"</span></span>
<span id="cb2-5"></span>
<span id="cb2-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 读取页面的 HTML 内容</span></span>
<span id="cb2-7">page <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_html</span>(url)</span>
<span id="cb2-8"></span>
<span id="cb2-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 提取所有带有 href 的 &lt;a&gt; 标签</span></span>
<span id="cb2-10">links <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> page <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb2-11">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">html_nodes</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"a"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb2-12">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">html_attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"href"</span>)</span>
<span id="cb2-13"></span>
<span id="cb2-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 移除空值和重复项</span></span>
<span id="cb2-15">links <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">na.omit</span>(links))</span>
<span id="cb2-16"></span>
<span id="cb2-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 可选：仅保留完整 URL</span></span>
<span id="cb2-18">links_full <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://openrouter.ai"</span>, links[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grepl</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"^/docs/"</span>, links)])</span>
<span id="cb2-19"></span>
<span id="cb2-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 打印所有链接</span></span>
<span id="cb2-21"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(links_full)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "https://openrouter.ai/docs/api-reference/overview"                               
 [2] "https://openrouter.ai/docs/quickstart"                                           
 [3] "https://openrouter.ai/docs/api/reference/overview"                               
 [4] "https://openrouter.ai/docs/sdks/agentic-usage"                                   
 [5] "https://openrouter.ai/docs/guides/overview/principles"                           
 [6] "https://openrouter.ai/docs/guides/overview/models"                               
 [7] "https://openrouter.ai/docs/faq"                                                  
 [8] "https://openrouter.ai/docs/guides/overview/report-feedback"                      
 [9] "https://openrouter.ai/docs/guides/routing/model-fallbacks"                       
[10] "https://openrouter.ai/docs/guides/routing/provider-selection"                    
[11] "https://openrouter.ai/docs/guides/features/presets"                              
[12] "https://openrouter.ai/docs/guides/features/tool-calling"                         
[13] "https://openrouter.ai/docs/guides/features/structured-outputs"                   
[14] "https://openrouter.ai/docs/guides/features/message-transforms"                   
[15] "https://openrouter.ai/docs/guides/features/zero-completion-insurance"            
[16] "https://openrouter.ai/docs/guides/features/zdr"                                  
[17] "https://openrouter.ai/docs/app-attribution"                                      
[18] "https://openrouter.ai/docs/guides/features/guardrails"                           
[19] "https://openrouter.ai/docs/faq#how-are-rate-limits-calculated"                   
[20] "https://openrouter.ai/docs/api/reference/streaming"                              
[21] "https://openrouter.ai/docs/guides/community/frameworks-and-integrations-overview"</code></pre>
</div>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" aria-labelledby="tabset-1-2-tab">
<p>首先，我们需要为知识库收集数据。我们将使用 <code>requests</code> 和 <code>BeautifulSoup</code> 从 OpenRouter 文档中爬取 URL。这将为我们提供待接入的页面列表。</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> sys</span>
<span id="cb4-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(sys.executable)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>/Library/Frameworks/Python.framework/Versions/3.13/bin/python3</code></pre>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> requests</span>
<span id="cb6-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> bs4 <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> BeautifulSoup</span>
<span id="cb6-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv</span>
<span id="cb6-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb6-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> markitdown <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> MarkItDown</span>
<span id="cb6-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> io <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> BytesIO</span>
<span id="cb6-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> re</span>
<span id="cb6-8"></span>
<span id="cb6-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 加载环境变量</span></span>
<span id="cb6-10">load_dotenv()</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>True</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 辅助函数</span></span>
<span id="cb8-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> fetch_html(url: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">bytes</span>:</span>
<span id="cb8-3">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""从 URL 获取 HTML 内容并以字节形式返回。"""</span></span>
<span id="cb8-4">    resp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> requests.get(url)</span>
<span id="cb8-5">    resp.raise_for_status()</span>
<span id="cb8-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> resp.content</span>
<span id="cb8-7"></span>
<span id="cb8-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> html_to_markdown(html_bytes: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">bytes</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb8-9">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""使用 MarkItDown 将 HTML 字节转换为 Markdown。"""</span></span>
<span id="cb8-10">    md <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> MarkItDown()</span>
<span id="cb8-11">    stream <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> BytesIO(html_bytes)</span>
<span id="cb8-12">    result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> md.convert_stream(stream, mime_type<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text/html"</span>)</span>
<span id="cb8-13">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> result.markdown</span>
<span id="cb8-14"></span>
<span id="cb8-15"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> save_markdown(md_content: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, output_path: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>):</span>
<span id="cb8-16">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""将 Markdown 内容保存到文件。"""</span></span>
<span id="cb8-17">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(output_path, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"w"</span>, encoding<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"utf-8"</span>) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> f:</span>
<span id="cb8-18">        f.write(md_content)</span>
<span id="cb8-19"></span>
<span id="cb8-20"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> sanitize_filename(filename: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb8-21">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""清理 URL 以创建合法的文件名。"""</span></span>
<span id="cb8-22">    filename <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> re.sub(<span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r'</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">^</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">https</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">://</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">[^/]</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span>, filename)</span>
<span id="cb8-23">    filename <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> re.sub(<span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r'</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">[^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">\w</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\-</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">_.]</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'_'</span>, filename)</span>
<span id="cb8-24">    filename <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> filename.strip(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'_'</span>)</span>
<span id="cb8-25">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> filename.endswith(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.md'</span>):</span>
<span id="cb8-26">        filename <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.md'</span></span>
<span id="cb8-27">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> filename</span>
<span id="cb8-28"></span>
<span id="cb8-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 待爬取的 URL</span></span>
<span id="cb8-30">url <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://openrouter.ai/docs/quickstart"</span></span>
<span id="cb8-31"></span>
<span id="cb8-32"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 读取页面的 HTML 内容</span></span>
<span id="cb8-33">response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> requests.get(url)</span>
<span id="cb8-34">soup <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> BeautifulSoup(response.content, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'html.parser'</span>)</span>
<span id="cb8-35"></span>
<span id="cb8-36"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 提取所有带有 href 的 &lt;a&gt; 标签</span></span>
<span id="cb8-37">links <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [a[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'href'</span>] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> a <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> soup.find_all(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'a'</span>, href<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)]</span>
<span id="cb8-38"></span>
<span id="cb8-39"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 移除重复项</span></span>
<span id="cb8-40">links <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(links))</span>
<span id="cb8-41"></span>
<span id="cb8-42"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 仅保留文档的完整 URL</span></span>
<span id="cb8-43">links_full <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"https://openrouter.ai</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>link<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> link <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> links <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> link.startswith(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/docs/"</span>)]</span>
<span id="cb8-44"></span>
<span id="cb8-45"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 显式添加 FAQ</span></span>
<span id="cb8-46">links_full.append(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://openrouter.ai/docs/faq"</span>)</span>
<span id="cb8-47">links_full <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(links_full))</span>
<span id="cb8-48"></span>
<span id="cb8-49"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 打印所有链接</span></span>
<span id="cb8-50"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"找到 </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(links_full)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> 个文档 URL"</span>)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>找到 21 个文档 URL</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(links_full)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>['https://openrouter.ai/docs/faq', 'https://openrouter.ai/docs/sdks/agentic-usage', 'https://openrouter.ai/docs/guides/features/message-transforms', 'https://openrouter.ai/docs/api/reference/overview', 'https://openrouter.ai/docs/guides/overview/principles', 'https://openrouter.ai/docs/guides/overview/report-feedback', 'https://openrouter.ai/docs/api-reference/overview', 'https://openrouter.ai/docs/quickstart', 'https://openrouter.ai/docs/guides/community/frameworks-and-integrations-overview', 'https://openrouter.ai/docs/guides/routing/provider-selection', 'https://openrouter.ai/docs/guides/features/structured-outputs', 'https://openrouter.ai/docs/faq#how-are-rate-limits-calculated', 'https://openrouter.ai/docs/guides/features/presets', 'https://openrouter.ai/docs/guides/routing/model-fallbacks', 'https://openrouter.ai/docs/guides/features/guardrails', 'https://openrouter.ai/docs/api/reference/streaming', 'https://openrouter.ai/docs/guides/features/zdr', 'https://openrouter.ai/docs/app-attribution', 'https://openrouter.ai/docs/guides/features/tool-calling', 'https://openrouter.ai/docs/guides/overview/models', 'https://openrouter.ai/docs/guides/features/zero-completion-insurance']</code></pre>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="将网页内容保存到本地" class="level1">
<h1>将网页内容保存到本地</h1>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-2-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-1" aria-controls="tabset-2-1" aria-selected="true" href="">R</a></li><li class="nav-item"><a class="nav-link" id="tabset-2-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-2" aria-controls="tabset-2-2" aria-selected="false" href="">Python DuckDB</a></li><li class="nav-item"><a class="nav-link" id="tabset-2-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-3" aria-controls="tabset-2-3" aria-selected="false" href="">Python Chroma</a></li></ul>
<div class="tab-content">
<div id="tabset-2-1" class="tab-pane active" aria-labelledby="tabset-2-1-tab">
<p>为了进行语义搜索，我们需要将文本数据存储为向量（嵌入）。我们将使用 <code>DuckDB</code> 作为本地向量数据库。我们还需要一个嵌入模型将文本转换为向量。在这里，我们配置 <code>ragnar</code> 通过 OpenAI 兼容的 API (SiliconFlow) 使用特定的嵌入模型。</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># pages &lt;- ragnar_find_links(base_url)</span></span>
<span id="cb12-2">pages <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> links_full</span>
<span id="cb12-3">store_location <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"openrouter.duckdb"</span></span>
<span id="cb12-4"></span>
<span id="cb12-5">store <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ragnar_store_create</span>(</span>
<span id="cb12-6">    store_location,</span>
<span id="cb12-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">overwrite =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,</span>
<span id="cb12-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">embed =</span> \(x) ragnar<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">embed_openai</span>(x,</span>
<span id="cb12-9">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">model =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"BAAI/bge-m3"</span>,</span>
<span id="cb12-10">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">base_url =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://api.siliconflow.cn/v1"</span>,</span>
<span id="cb12-11">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">api_key =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Sys.getenv</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"siliconflow"</span>)</span>
<span id="cb12-12">    )</span>
<span id="cb12-13">)</span></code></pre></div></div>
</details>
</div>
<p>在存储初始化后，我们现在可以接入数据。我们遍历之前爬取的页面列表。对于每个页面，我们： 1. 以 Markdown 格式读取内容。 2. 将内容拆分为较小的块（约 600 字符）。 3. 将这些块插入到我们的向量数据库中。</p>
<p>此过程构建了我们将要搜索的索引。</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># page="https://openrouter.ai/docs/faq"</span></span>
<span id="cb13-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># chunks &lt;- page |&gt;read_as_markdown() |&gt;markdown_chunk(target_size = 2000)</span></span>
<span id="cb13-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ragnar_chunks_view(chunks)</span></span></code></pre></div></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> (page <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> pages) {</span>
<span id="cb14-2">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">message</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"正在接入: "</span>, page)</span>
<span id="cb14-3">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(page)</span>
<span id="cb14-4">    chunks <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> page <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb14-5">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_as_markdown</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb14-6">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">markdown_chunk</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">target_size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2000</span>)</span>
<span id="cb14-7">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># print(chunks)</span></span>
<span id="cb14-8">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># print('chunks done')</span></span>
<span id="cb14-9">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ragnar_store_insert</span>(store, chunks)</span>
<span id="cb14-10">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"插入完成"</span>)</span>
<span id="cb14-11">}</span></code></pre></div></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ragnar_store_build_index</span>(store)</span>
<span id="cb15-2"></span>
<span id="cb15-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 释放连接以供后续 Python 代码使用</span></span>
<span id="cb15-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rm</span>(store)</span>
<span id="cb15-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gc</span>()</span></code></pre></div></div>
</details>
</div>
</div>
<div id="tabset-2-2" class="tab-pane" aria-labelledby="tabset-2-2-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb16-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> llama_index.core <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> SimpleDirectoryReader, VectorStoreIndex, StorageContext, Settings</span>
<span id="cb16-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> llama_index.vector_stores.duckdb <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> DuckDBVectorStore</span>
<span id="cb16-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> llama_index.embeddings.openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> OpenAIEmbedding</span>
<span id="cb16-5"></span>
<span id="cb16-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># --- 1. 配置 ---</span></span>
<span id="cb16-7"></span>
<span id="cb16-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 确保 API 密钥可用</span></span>
<span id="cb16-9">openrouter_api_key <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> os.getenv(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"OPENROUTER_API_KEY"</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 或直接粘贴字符串</span></span>
<span id="cb16-10"></span>
<span id="cb16-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 初始化指向 OpenRouter 的嵌入模型</span></span>
<span id="cb16-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 我们使用 OpenAI 类，因为 OpenRouter 使用了 OpenAI 兼容的 API 结构</span></span>
<span id="cb16-13">embed_model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> OpenAIEmbedding(</span>
<span id="cb16-14">    api_key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>openrouter_api_key,</span>
<span id="cb16-15">    base_url<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://openrouter.ai/api/v1"</span>,</span>
<span id="cb16-16">    model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"qwen/qwen3-embedding-8b"</span>  </span>
<span id="cb16-17">)</span>
<span id="cb16-18"></span>
<span id="cb16-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 更新全局设置，以便 LlamaIndex 知道使用此模型</span></span>
<span id="cb16-20">Settings.embed_model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> embed_model</span>
<span id="cb16-21">Settings.chunk_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2000</span></span>
<span id="cb16-22">Settings.chunk_overlap <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span></span>
<span id="cb16-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># --- 2. 接入与索引 ---</span></span>
<span id="cb16-24"></span>
<span id="cb16-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 加载数据</span></span>
<span id="cb16-26">documents <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> SimpleDirectoryReader(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"markdown_docs"</span>).load_data()</span>
<span id="cb16-27"></span>
<span id="cb16-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 初始化 DuckDB 向量数据库</span></span>
<span id="cb16-29">vector_store <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DuckDBVectorStore(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"openrouter.duckdb"</span>, persist_dir<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"./persist/"</span>)</span>
<span id="cb16-30">storage_context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> StorageContext.from_defaults(vector_store<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>vector_store)</span>
<span id="cb16-31"></span>
<span id="cb16-32"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 创建索引</span></span>
<span id="cb16-33"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 这将自动使用 Settings 中定义的 Qwen 嵌入</span></span>
<span id="cb16-34">index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> VectorStoreIndex.from_documents(</span>
<span id="cb16-35">    documents, </span>
<span id="cb16-36">    storage_context<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>storage_context</span>
<span id="cb16-37">)</span></code></pre></div></div>
</details>
</div>
</div>
<div id="tabset-2-3" class="tab-pane" aria-labelledby="tabset-2-3-tab">
<p>为了进行语义搜索，我们需要将文本数据转换为向量（嵌入）进行存储。我们将使用 <code>ChromaDB</code> 作为本地向量数据库。我们还需要一个嵌入模型把文本转为向量。在这里，我们配置了一个自定义的 <code>OpenRouterEmbeddings</code> 类，通过 OpenRouter API 使用 <code>qwen/qwen3-embedding-8b</code> 模型。</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> OpenAI</span>
<span id="cb17-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.embeddings <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Embeddings</span>
<span id="cb17-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_chroma <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Chroma</span>
<span id="cb17-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> typing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> List</span>
<span id="cb17-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb17-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv</span>
<span id="cb17-7"></span>
<span id="cb17-8">load_dotenv()</span>
<span id="cb17-9"></span>
<span id="cb17-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 针对 OpenRouter API 的自定义嵌入类</span></span>
<span id="cb17-11"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> OpenRouterEmbeddings(Embeddings):</span>
<span id="cb17-12">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""针对 OpenRouter API 的自定义嵌入类。"""</span></span>
<span id="cb17-13">    </span>
<span id="cb17-14">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, api_key: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, model: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text-embedding-3-small"</span>):</span>
<span id="cb17-15">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.client <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> OpenAI(</span>
<span id="cb17-16">            base_url<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://openrouter.ai/api/v1"</span>,</span>
<span id="cb17-17">            api_key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>api_key,</span>
<span id="cb17-18">        )</span>
<span id="cb17-19">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model</span>
<span id="cb17-20">    </span>
<span id="cb17-21">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> embed_documents(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, texts: List[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> List[List[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>]]:</span>
<span id="cb17-22">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""对文档列表进行嵌入。"""</span></span>
<span id="cb17-23">        response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.client.embeddings.create(</span>
<span id="cb17-24">            extra_headers<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{</span>
<span id="cb17-25">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"HTTP-Referer"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://ai-blog.com"</span>,</span>
<span id="cb17-26">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"X-Title"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"AI Blog RAG"</span>,</span>
<span id="cb17-27">            },</span>
<span id="cb17-28">            model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.model,</span>
<span id="cb17-29">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>texts,</span>
<span id="cb17-30">            encoding_format<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"float"</span></span>
<span id="cb17-31">        )</span>
<span id="cb17-32">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> [item.embedding <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> item <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> response.data]</span>
<span id="cb17-33">    </span>
<span id="cb17-34">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> embed_query(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, text: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> List[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>]:</span>
<span id="cb17-35">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""对单个查询进行嵌入。"""</span></span>
<span id="cb17-36">        response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.client.embeddings.create(</span>
<span id="cb17-37">            extra_headers<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{</span>
<span id="cb17-38">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"HTTP-Referer"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://ai-blog.com"</span>,</span>
<span id="cb17-39">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"X-Title"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"AI Blog RAG"</span>,</span>
<span id="cb17-40">            },</span>
<span id="cb17-41">            model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.model,</span>
<span id="cb17-42">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>text,</span>
<span id="cb17-43">            encoding_format<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"float"</span></span>
<span id="cb17-44">        )</span>
<span id="cb17-45">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> response.data[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].embedding</span>
<span id="cb17-46"></span>
<span id="cb17-47"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 获取 OpenRouter API 密钥</span></span>
<span id="cb17-48">openrouter_api_key <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> os.getenv(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"OPENROUTER_API_KEY"</span>)</span>
<span id="cb17-49"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> openrouter_api_key:</span>
<span id="cb17-50">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">raise</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">ValueError</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"未在环境变量中找到 OPENROUTER_API_KEY"</span>)</span>
<span id="cb17-51"></span>
<span id="cb17-52"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 使用 OpenRouter 创建嵌入实例</span></span>
<span id="cb17-53">embeddings <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> OpenRouterEmbeddings(</span>
<span id="cb17-54">    api_key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>openrouter_api_key,</span>
<span id="cb17-55">    model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"qwen/qwen3-embedding-8b"</span></span>
<span id="cb17-56">)</span>
<span id="cb17-57"></span>
<span id="cb17-58"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 定义向量数据库位置</span></span>
<span id="cb17-59">persist_directory <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"chroma_db_data"</span></span></code></pre></div></div>
</details>
</div>
<p>在存储初始化后，我们现在可以接入数据。我们遍历之前保存的 Markdown 文件。对于每个文件，我们： 1. 加载内容。 2. 使用 <code>RecursiveCharacterTextSplitter</code> 将内容拆分为较小的块（约 2000 字符）。 3. 从这些块中创建一个新的 <code>Chroma</code> 向量数据库。</p>
<p>此过程构建了我们将要搜索的索引。</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.documents <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Document</span>
<span id="cb18-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_text_splitters <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> RecursiveCharacterTextSplitter</span>
<span id="cb18-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> shutil</span>
<span id="cb18-4"></span>
<span id="cb18-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 加载 Markdown 文件的辅助函数</span></span>
<span id="cb18-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> load_markdown_files(directory: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>[Document]:</span>
<span id="cb18-7">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""从目录加载所有 Markdown 文件并创建 Document 对象。"""</span></span>
<span id="cb18-8">    documents <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb18-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> os.path.exists(directory):</span>
<span id="cb18-10">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> documents</span>
<span id="cb18-11">        </span>
<span id="cb18-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> filename <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> os.listdir(directory):</span>
<span id="cb18-13">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> filename.endswith(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.md'</span>):</span>
<span id="cb18-14">            filepath <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> os.path.join(directory, filename)</span>
<span id="cb18-15">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(filepath, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'r'</span>, encoding<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'utf-8'</span>) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> f:</span>
<span id="cb18-16">                content <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f.read()</span>
<span id="cb18-17">                doc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Document(</span>
<span id="cb18-18">                    page_content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>content,</span>
<span id="cb18-19">                    metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{</span>
<span id="cb18-20">                        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"source"</span>: filename,</span>
<span id="cb18-21">                        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"filepath"</span>: filepath</span>
<span id="cb18-22">                    }</span>
<span id="cb18-23">                )</span>
<span id="cb18-24">                documents.append(doc)</span>
<span id="cb18-25">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> documents</span>
<span id="cb18-26"></span>
<span id="cb18-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 创建 Markdown 文件的输出目录</span></span>
<span id="cb18-28">output_dir <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"markdown_docs"</span></span>
<span id="cb18-29">os.makedirs(output_dir, exist_ok<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb18-30"></span>
<span id="cb18-31"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 将每个 URL 转换为 Markdown 并保存</span></span>
<span id="cb18-32"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, link_url <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(links_full, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>):</span>
<span id="cb18-33">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb18-34">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"正在处理 </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">/</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(links_full)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>link_url<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb18-35">        html_content <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fetch_html(link_url)</span>
<span id="cb18-36">        markdown_content <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> html_to_markdown(html_content)</span>
<span id="cb18-37">        filename <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sanitize_filename(link_url)</span>
<span id="cb18-38">        output_path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> os.path.join(output_dir, filename)</span>
<span id="cb18-39">        save_markdown(markdown_content, output_path)</span>
<span id="cb18-40">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  ✓ 已保存至 </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>output_path<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb18-41">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">Exception</span> <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> e:</span>
<span id="cb18-42">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  ✗ 处理 </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>link_url<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> 时出错: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(e)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb18-43"></span>
<span id="cb18-44"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 加载 Markdown 文档</span></span>
<span id="cb18-45">documents <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> load_markdown_files(output_dir)</span>
<span id="cb18-46"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">加载了 </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(documents)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> 个 Markdown 文档"</span>)</span>
<span id="cb18-47"></span>
<span id="cb18-48"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 将文档拆分为块</span></span>
<span id="cb18-49">text_splitter <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> RecursiveCharacterTextSplitter(</span>
<span id="cb18-50">    chunk_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2000</span>,</span>
<span id="cb18-51">    chunk_overlap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>,</span>
<span id="cb18-52">    length_function<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>,</span>
<span id="cb18-53">    is_separator_regex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>,</span>
<span id="cb18-54">)</span>
<span id="cb18-55"></span>
<span id="cb18-56">splits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> text_splitter.split_documents(documents)</span>
<span id="cb18-57"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"拆分为 </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(splits)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> 个块"</span>)</span></code></pre></div></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 如果数据库已存在，则将其移除</span></span>
<span id="cb19-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> os.path.exists(persist_directory):</span>
<span id="cb19-3">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"正在移除位于 </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>persist_directory<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> 的现有数据库..."</span>)</span>
<span id="cb19-4">    shutil.rmtree(persist_directory)</span>
<span id="cb19-5"></span>
<span id="cb19-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 创建新的向量数据库</span></span>
<span id="cb19-7">vectorstore <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chroma.from_documents(</span>
<span id="cb19-8">    documents<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>splits,</span>
<span id="cb19-9">    embedding<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>embeddings,</span>
<span id="cb19-10">    persist_directory<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>persist_directory</span>
<span id="cb19-11">)</span>
<span id="cb19-12"></span>
<span id="cb19-13"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">✓ 成功创建了包含 </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(splits)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> 个块的 ChromaDB！"</span>)</span>
<span id="cb19-14"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"✓ 数据库已保存至: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>persist_directory<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="检索" class="level1">
<h1>检索</h1>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-3-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-1" aria-controls="tabset-3-1" aria-selected="true" href="">R</a></li><li class="nav-item"><a class="nav-link" id="tabset-3-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-2" aria-controls="tabset-3-2" aria-selected="false" href="">Python DuckDB</a></li><li class="nav-item"><a class="nav-link" id="tabset-3-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-3" aria-controls="tabset-3-3" aria-selected="false" href="">Python Chroma</a></li></ul>
<div class="tab-content">
<div id="tabset-3-1" class="tab-pane active" aria-labelledby="tabset-3-1-tab">
<p>现在我们的知识库已经填充完毕，我们可以测试检索系统。我们可以提出一个特定的问题，例如“什么是模型变体？(What are model variants?)”，并查询存储库以查看哪些文本块最相关。这确认了我们的嵌入和搜索是否正常工作。</p>
<section id="问题什么是模型变体what-are-model-variants" class="level3">
<h3 class="anchored" data-anchor-id="问题什么是模型变体what-are-model-variants">问题：什么是模型变体？(What are model variants?)</h3>
<p>RAG 结果：</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1">store_location <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"openrouter.duckdb"</span></span>
<span id="cb20-2">text <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"What are model variants?"</span></span>
<span id="cb20-3"></span>
<span id="cb20-4">relevant_chunks <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tryCatch</span>({</span>
<span id="cb20-5">    store <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ragnar_store_connect</span>(store_location)</span>
<span id="cb20-6">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ragnar_retrieve</span>(store, text, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">top_k =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span>
<span id="cb20-7">}, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">error =</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(e) {</span>
<span id="cb20-8">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">message</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"⚠️ 无法连接到 DuckDB (可能被锁定): "</span>, e<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>message)</span>
<span id="cb20-9">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>)</span>
<span id="cb20-10">})</span>
<span id="cb20-11"></span>
<span id="cb20-12"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.null</span>(relevant_chunks)) {</span>
<span id="cb20-13">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"检索到"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(relevant_chunks), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"个文本块：</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb20-14">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> (i <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_len</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(relevant_chunks))) {</span>
<span id="cb20-15">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sprintf</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"--- 块 %d ---</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">%s</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>, i, relevant_chunks<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>text[i]))</span>
<span id="cb20-16">    }</span>
<span id="cb20-17">} <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> {</span>
<span id="cb20-18">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"知识库当前不可用（由于数据库锁定）。"</span>)</span>
<span id="cb20-19">}</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>检索到 6 个文本块：

--- 块 1 ---
[Zero Completion Insurance](/docs/features/zero-completion-insurance)
  + [Provisioning API Keys](/docs/features/provisioning-api-keys)
  + [App Attribution](/docs/app-attribution)
* API Reference

  + [Overview](/docs/api-reference/overview)
  + [Streaming](/docs/api-reference/streaming)
  + [Embeddings](/docs/api-reference/embeddings)
  + [Limits](/docs/api-reference/limits)
  + [Authentication](/docs/api-reference/authentication)
  + [Parameters](/docs/api-reference/parameters)
  + [Errors](/docs/api-reference/errors)
  + Responses API
  + beta.responses
  + Analytics
  + Credits
  + Embeddings
  + Generations
  + Models
  + Endpoints
  + Parameters
  + Providers
  + API Keys
  + O Auth
  + Chat
  + Completions
* SDK Reference (BETA)

  + [Python SDK](/docs/sdks/python)
  + [TypeScript SDK](/docs/sdks/typescript)
* Use Cases

  + [BYOK](/docs/use-cases/byok)
  + [Crypto API](/docs/use-cases/crypto-api)
  + [OAuth PKCE](/docs/use-cases/oauth-pkce)
  + [MCP Servers](/docs/use-cases/mcp-servers)
  + [Organization Management](/docs/use-cases/organization-management)
  + [For Providers](/docs/use-cases/for-providers)
  + [Reasoning Tokens](/docs/use-cases/reasoning-tokens)
  + [Usage Accounting](/docs/use-cases/usage-accounting)
  + [User Tracking](/docs/use-cases/user-tracking)
* Community

  + [Frameworks and Integrations Overview](/docs/community/frameworks-and-integrations-overview)
  + [Effect AI SDK](/docs/community/effect-ai-sdk)
  + [Arize](/docs/community/arize)
  + [LangChain](/docs/community/lang-chain)
  + [LiveKit](/docs/community/live-kit)
  + [Langfuse](/docs/community/langfuse)
  + [Mastra](/docs/community/mastra)
  + [OpenAI SDK](/docs/community/open-ai-sdk)
  + [PydanticAI](/docs/community/pydantic-ai)
  + [Vercel AI SDK](/docs/community/vercel-ai-sdk)
  + [Xcode](/docs/community/xcode)
  + [Zapier](/docs/community/zapier)
  + [Discord](https://discord.gg/openrouter)

Light

On this page

* [Requests](#requests)
* [Completions Request Format](#completions-request-format)
* [Headers](#headers)
* [Assistant Prefill](#assistant-prefill)
* [Responses](#responses)
* [CompletionsResponse Format](#completionsresponse-format)
* [Finish Reason](#finish-reason)
* [Querying Cost and Stats](#querying-cost-and-stats)

[API Reference](/docs/api-reference/overview)



--- 块 2 ---
###### How frequently are new models added?

We work on adding models as quickly as we can. We often have partnerships with
the labs releasing models and can release models as soon as they are
available. If there is a model missing that you’d like OpenRouter to support, feel free to message us on
[Discord](https://discord.gg/openrouter).

###### What are model variants?

Variants are suffixes that can be added to the model slug to change its behavior.

Static variants can only be used with specific models and these are listed in our [models api](https://openrouter.ai/api/v1/models).

1. `:free` - The model is always provided for free and has low rate limits.
2. `:beta` - The model is not moderated by OpenRouter.
3. `:extended` - The model has longer than usual context length.
4. `:exacto` - The model only uses OpenRouter-curated high-quality endpoints.
5. `:thinking` - The model supports reasoning by default.

Dynamic variants can be used on all models and they change the behavior of how the request is routed or used.

1. `:online` - All requests will run a query to extract web results that are attached to the prompt.
2. `:nitro` - Providers will be sorted by throughput rather than the default sort, optimizing for faster response times.
3. `:floor` - Providers will be sorted by price rather than the default sort, prioritizing the most cost-effective options.

###### I am an inference provider, how can I get listed on OpenRouter?

You can read our requirements at the [Providers
page](/docs/use-cases/for-providers). If you would like to contact us, the best
place to reach us is over email.

###### What is the expected latency/response time for different models?

For each model on OpenRouter we show the latency (time to first token) and the token
throughput for all providers. You can use this to estimate how long requests
will take. If you would like to optimize for throughput you can use the
`:nitro` variant to route to the fastest provider.



--- 块 3 ---
###### How frequently are new models added?

We work on adding models as quickly as we can. We often have partnerships with
the labs releasing models and can release models as soon as they are
available. If there is a model missing that you’d like OpenRouter to support, feel free to message us on
[Discord](https://discord.gg/openrouter).

###### What are model variants?

Variants are suffixes that can be added to the model slug to change its behavior.

Static variants can only be used with specific models and these are listed in our [models api](https://openrouter.ai/api/v1/models).

1. `:free` - The model is always provided for free and has low rate limits.
2. `:beta` - The model is not moderated by OpenRouter.
3. `:extended` - The model has longer than usual context length.
4. `:exacto` - The model only uses OpenRouter-curated high-quality endpoints.
5. `:thinking` - The model supports reasoning by default.

Dynamic variants can be used on all models and they change the behavior of how the request is routed or used.

1. `:online` - All requests will run a query to extract web results that are attached to the prompt.
2. `:nitro` - Providers will be sorted by throughput rather than the default sort, optimizing for faster response times.
3. `:floor` - Providers will be sorted by price rather than the default sort, prioritizing the most cost-effective options.

###### I am an inference provider, how can I get listed on OpenRouter?

You can read our requirements at the [Providers
page](/docs/use-cases/for-providers). If you would like to contact us, the best
place to reach us is over email.

###### What is the expected latency/response time for different models?

For each model on OpenRouter we show the latency (time to first token) and the token
throughput for all providers. You can use this to estimate how long requests
will take. If you would like to optimize for throughput you can use the
`:nitro` variant to route to the fastest provider.



--- 块 4 ---
## The `models` parameter

The `models` parameter lets you automatically try other models if the primary model’s providers are down, rate-limited, or refuse to reply due to content moderation.

TypeScript SDKTypeScript (fetch)Python

```code-block-root not-prose rounded-b-[inherit] rounded-t-none
|  |  |
| --- | --- |
| 1 | import { OpenRouter } from '@openrouter/sdk'; |
| 2 |  |
| 3 | const openRouter = new OpenRouter({ |
| 4 | apiKey: '&lt;OPENROUTER_API_KEY&gt;', |
| 5 | }); |
| 6 |  |
| 7 | const completion = await openRouter.chat.send({ |
| 8 | models: ['anthropic/claude-3.5-sonnet', 'gryphe/mythomax-l2-13b'], |
| 9 | messages: [ |
| 10 | { |
| 11 | role: 'user', |
| 12 | content: 'What is the meaning of life?', |
| 13 | }, |
| 14 | ], |
| 15 | }); |
| 16 |  |
| 17 | console.log(completion.choices[0].message.content); |
```

If the model you selected returns an error, OpenRouter will try to use the fallback model instead. If the fallback model is down or returns an error, OpenRouter will return that error.

By default, any error can trigger the use of a fallback model, including context length validation errors, moderation flags for filtered models, rate-limiting, and downtime.

Requests are priced using the model that was ultimately used, which will be returned in the `model` attribute of the response body.

## Using with OpenAI SDK

To use the `models` array with the OpenAI SDK, include it in the `extra_body` parameter. In the example below, gpt-4o will be tried first, and the `models` array will be tried in order as fallbacks.

PythonTypeScript



--- 块 5 ---
[Web Search](/docs/features/web-search)
  + [Zero Completion Insurance](/docs/features/zero-completion-insurance)
  + [Provisioning API Keys](/docs/features/provisioning-api-keys)
  + [App Attribution](/docs/app-attribution)
* API Reference

  + [Overview](/docs/api-reference/overview)
  + [Streaming](/docs/api-reference/streaming)
  + [Embeddings](/docs/api-reference/embeddings)
  + [Limits](/docs/api-reference/limits)
  + [Authentication](/docs/api-reference/authentication)
  + [Parameters](/docs/api-reference/parameters)
  + [Errors](/docs/api-reference/errors)
  + Responses API
  + beta.responses
  + Analytics
  + Credits
  + Embeddings
  + Generations
  + Models
  + Endpoints
  + Parameters
  + Providers
  + API Keys
  + O Auth
  + Chat
  + Completions
* SDK Reference (BETA)

  + [Python SDK](/docs/sdks/python)
  + [TypeScript SDK](/docs/sdks/typescript)
* Use Cases

  + [BYOK](/docs/use-cases/byok)
  + [Crypto API](/docs/use-cases/crypto-api)
  + [OAuth PKCE](/docs/use-cases/oauth-pkce)
  + [MCP Servers](/docs/use-cases/mcp-servers)
  + [Organization Management](/docs/use-cases/organization-management)
  + [For Providers](/docs/use-cases/for-providers)
  + [Reasoning Tokens](/docs/use-cases/reasoning-tokens)
  + [Usage Accounting](/docs/use-cases/usage-accounting)
  + [User Tracking](/docs/use-cases/user-tracking)
* Community

  + [Frameworks and Integrations Overview](/docs/community/frameworks-and-integrations-overview)
  + [Effect AI SDK](/docs/community/effect-ai-sdk)
  + [Arize](/docs/community/arize)
  + [LangChain](/docs/community/lang-chain)
  + [LiveKit](/docs/community/live-kit)
  + [Langfuse](/docs/community/langfuse)
  + [Mastra](/docs/community/mastra)
  + [OpenAI SDK](/docs/community/open-ai-sdk)
  + [PydanticAI](/docs/community/pydantic-ai)
  + [Vercel AI SDK](/docs/community/vercel-ai-sdk)
  + [Xcode](/docs/community/xcode)
  + [Zapier](/docs/community/zapier)
  + [Discord](https://discord.gg/openrouter)

Light

On this page

* [Within OpenRouter](#within-openrouter)
* [Provider Policies](#provider-policies)
* [Training on Prompts](#training-on-prompts)
* [Data Retention &amp; Logging](#data-retention--logging)
* [Enterprise EU in-region routing](#enterprise-eu-in-region-routing)

[Features](/docs/features/privacy-and-logging)



--- 块 6 ---
[Web Search](/docs/features/web-search)
  + [Zero Completion Insurance](/docs/features/zero-completion-insurance)
  + [Provisioning API Keys](/docs/features/provisioning-api-keys)
  + [App Attribution](/docs/app-attribution)
* API Reference

  + [Overview](/docs/api-reference/overview)
  + [Streaming](/docs/api-reference/streaming)
  + [Embeddings](/docs/api-reference/embeddings)
  + [Limits](/docs/api-reference/limits)
  + [Authentication](/docs/api-reference/authentication)
  + [Parameters](/docs/api-reference/parameters)
  + [Errors](/docs/api-reference/errors)
  + Responses API
  + beta.responses
  + Analytics
  + Credits
  + Embeddings
  + Generations
  + Models
  + Endpoints
  + Parameters
  + Providers
  + API Keys
  + O Auth
  + Chat
  + Completions
* SDK Reference (BETA)

  + [Python SDK](/docs/sdks/python)
  + [TypeScript SDK](/docs/sdks/typescript)
* Use Cases

  + [BYOK](/docs/use-cases/byok)
  + [Crypto API](/docs/use-cases/crypto-api)
  + [OAuth PKCE](/docs/use-cases/oauth-pkce)
  + [MCP Servers](/docs/use-cases/mcp-servers)
  + [Organization Management](/docs/use-cases/organization-management)
  + [For Providers](/docs/use-cases/for-providers)
  + [Reasoning Tokens](/docs/use-cases/reasoning-tokens)
  + [Usage Accounting](/docs/use-cases/usage-accounting)
  + [User Tracking](/docs/use-cases/user-tracking)
* Community

  + [Frameworks and Integrations Overview](/docs/community/frameworks-and-integrations-overview)
  + [Effect AI SDK](/docs/community/effect-ai-sdk)
  + [Arize](/docs/community/arize)
  + [LangChain](/docs/community/lang-chain)
  + [LiveKit](/docs/community/live-kit)
  + [Langfuse](/docs/community/langfuse)
  + [Mastra](/docs/community/mastra)
  + [OpenAI SDK](/docs/community/open-ai-sdk)
  + [PydanticAI](/docs/community/pydantic-ai)
  + [Vercel AI SDK](/docs/community/vercel-ai-sdk)
  + [Xcode](/docs/community/xcode)
  + [Zapier](/docs/community/zapier)
  + [Discord](https://discord.gg/openrouter)

Light

On this page

* [How OpenRouter Manages Data Policies](#how-openrouter-manages-data-policies)
* [Per-Request ZDR Enforcement](#per-request-zdr-enforcement)
* [Usage](#usage)
* [Caching](#caching)
* [OpenRouter’s Retention Policy](#openrouters-retention-policy)
* [Zero Retention Endpoints](#zero-retention-endpoints)

[Features](/docs/features/privacy-and-logging)</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 释放连接以避免文件锁定</span></span>
<span id="cb22-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exists</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"store"</span>)) {</span>
<span id="cb22-3">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rm</span>(store)</span>
<span id="cb22-4">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gc</span>()</span>
<span id="cb22-5">}</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>          used  (Mb) gc trigger  (Mb) limit (Mb) max used  (Mb)
Ncells 2385439 127.4    4675528 249.8         NA  3250438 173.6
Vcells 4239754  32.4   10146329  77.5      16384  5558189  42.5</code></pre>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ragnar_store_inspect(store)</span></span>
<span id="cb24-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#ragnar_chunks_view(chunks)</span></span></code></pre></div></div>
</details>
</div>
</section>
</div>
<div id="tabset-3-2" class="tab-pane" aria-labelledby="tabset-3-2-tab">
<p>在 Python 中，我们可以使用 <code>LlamaIndex</code> 与我们的 DuckDB 向量数据库进行交互。在此步骤中，我们将配置嵌入模型并为查询检索前几个相关块，并将它们保存到文件中以供检查。我们暂不使用 LLM 进行生成，仅专注于验证检索质量。</p>
<section id="问题什么是模型变体what-are-model-variants-1" class="level3">
<h3 class="anchored" data-anchor-id="问题什么是模型变体what-are-model-variants-1">问题：什么是模型变体？(What are model variants?)</h3>
<p>RAG 结果：</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb25-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> sys</span>
<span id="cb25-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Python 可执行文件路径: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>sys<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>executable<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Python 可执行文件路径: /Library/Frameworks/Python.framework/Versions/3.13/bin/python3</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Python 路径 (sys.path): </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>sys<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>path<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Python 路径 (sys.path): ['', '/Library/Frameworks/Python.framework/Versions/3.13/bin', '/Library/Frameworks/Python.framework/Versions/3.13/lib/python313.zip', '/Library/Frameworks/Python.framework/Versions/3.13/lib/python3.13', '/Library/Frameworks/Python.framework/Versions/3.13/lib/python3.13/lib-dynload', '/Library/Frameworks/Python.framework/Versions/3.13/lib/python3.13/site-packages', '/Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/library/reticulate/python']</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> typing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Any, List</span>
<span id="cb29-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> OpenAI</span>
<span id="cb29-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> llama_index.core <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> VectorStoreIndex, Settings</span>
<span id="cb29-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> llama_index.core.embeddings <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> BaseEmbedding</span>
<span id="cb29-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> llama_index.vector_stores.duckdb <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> DuckDBVectorStore</span>
<span id="cb29-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv</span>
<span id="cb29-7"></span>
<span id="cb29-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 加载环境变量</span></span>
<span id="cb29-9">load_dotenv()</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>True</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 确保 API 密钥可用</span></span>
<span id="cb31-2">openrouter_api_key <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> os.getenv(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"OPENROUTER_API_KEY"</span>)</span>
<span id="cb31-3"></span>
<span id="cb31-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 针对 LlamaIndex 的自定义 OpenRouter 嵌入类</span></span>
<span id="cb31-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> OpenRouterEmbedding(BaseEmbedding):</span>
<span id="cb31-6">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""与 LlamaIndex 兼容的 OpenRouter API 自定义嵌入类。"""</span></span>
<span id="cb31-7">    </span>
<span id="cb31-8">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(</span>
<span id="cb31-9">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>,</span>
<span id="cb31-10">        api_key: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>,</span>
<span id="cb31-11">        model: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"qwen/qwen3-embedding-8b"</span>,</span>
<span id="cb31-12">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>kwargs: Any</span>
<span id="cb31-13">    ):</span>
<span id="cb31-14">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">super</span>().<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>kwargs)</span>
<span id="cb31-15">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._client <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> OpenAI(</span>
<span id="cb31-16">            base_url<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://openrouter.ai/api/v1"</span>,</span>
<span id="cb31-17">            api_key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>api_key,</span>
<span id="cb31-18">        )</span>
<span id="cb31-19">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model</span>
<span id="cb31-20">    </span>
<span id="cb31-21">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> _get_query_embedding(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, query: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> List[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>]:</span>
<span id="cb31-22">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""获取查询字符串的嵌入向量。"""</span></span>
<span id="cb31-23">        response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._client.embeddings.create(</span>
<span id="cb31-24">            extra_headers<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{</span>
<span id="cb31-25">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"HTTP-Referer"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://ai-blog.com"</span>,</span>
<span id="cb31-26">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"X-Title"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"AI Blog RAG"</span>,</span>
<span id="cb31-27">            },</span>
<span id="cb31-28">            model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._model,</span>
<span id="cb31-29">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>query,</span>
<span id="cb31-30">            encoding_format<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"float"</span></span>
<span id="cb31-31">        )</span>
<span id="cb31-32">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> response.data[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].embedding</span>
<span id="cb31-33">    </span>
<span id="cb31-34">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> _get_text_embedding(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, text: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> List[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>]:</span>
<span id="cb31-35">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""获取文本字符串的嵌入向量。"""</span></span>
<span id="cb31-36">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._get_query_embedding(text)</span>
<span id="cb31-37">    </span>
<span id="cb31-38">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">async</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> _aget_query_embedding(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, query: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> List[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>]:</span>
<span id="cb31-39">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""异步版本的 get_query_embedding。"""</span></span>
<span id="cb31-40">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._get_query_embedding(query)</span>
<span id="cb31-41">    </span>
<span id="cb31-42">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">async</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> _aget_text_embedding(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, text: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> List[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>]:</span>
<span id="cb31-43">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""异步版本的 get_text_embedding。"""</span></span>
<span id="cb31-44">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._get_text_embedding(text)</span>
<span id="cb31-45"></span>
<span id="cb31-46"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1. 使用自定义 OpenRouter 类配置嵌入模型</span></span>
<span id="cb31-47">embed_model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> OpenRouterEmbedding(</span>
<span id="cb31-48">    api_key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>openrouter_api_key,</span>
<span id="cb31-49">    model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"qwen/qwen3-embedding-8b"</span></span>
<span id="cb31-50">)</span>
<span id="cb31-51"></span>
<span id="cb31-52"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 2. 应用设置</span></span>
<span id="cb31-53">Settings.embed_model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> embed_model</span>
<span id="cb31-54"></span>
<span id="cb31-55"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 加载与检索</span></span>
<span id="cb31-56"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 加载现有的 DuckDB 向量数据库</span></span>
<span id="cb31-57"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"正在从 openrouter.duckdb 加载向量数据库..."</span>)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>正在从 openrouter.duckdb 加载向量数据库...</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb33-2">    vector_store <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DuckDBVectorStore(database_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"openrouter.duckdb"</span>, persist_dir<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"./persist/"</span>, read_only<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb33-3">    index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> VectorStoreIndex.from_vector_store(vector_store<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>vector_store)</span>
<span id="cb33-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">Exception</span> <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> e:</span>
<span id="cb33-5">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"⚠️ 无法加载向量数据库 (可能被锁定): </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>e<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb33-6">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 创建一个空索引作为备选，或者跳过</span></span>
<span id="cb33-7">    index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb33-8"></span>
<span id="cb33-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 定义查询</span></span>
<span id="cb33-10">query <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"What are model variants?"</span></span>
<span id="cb33-11"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'='</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
============================================================</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"查询问题: '</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>query<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'"</span>)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>查询问题: 'What are model variants?'</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'='</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>============================================================</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb39" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 检索前 3 个相关块</span></span>
<span id="cb39-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> index:</span>
<span id="cb39-3">    retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> index.as_retriever(similarity_top_k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span>
<span id="cb39-4">    nodes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> retriever.retrieve(query)</span>
<span id="cb39-5"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb39-6">    nodes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb39-7"></span>
<span id="cb39-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 打印详细检索信息</span></span>
<span id="cb39-9"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"从 DuckDB 中检索到 </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(nodes)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> 个文本块：</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>从 DuckDB 中检索到 5 个文本块：</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb41" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, node <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(nodes, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>):</span>
<span id="cb41-2">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'─'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb41-3">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"块 </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb41-4">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'─'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb41-5"></span>
<span id="cb41-6">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 打印相似度分数</span></span>
<span id="cb41-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">hasattr</span>(node, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'score'</span>):</span>
<span id="cb41-8">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"相似度分数: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>node<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>score<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb41-9"></span>
<span id="cb41-10">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 打印元数据</span></span>
<span id="cb41-11">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">hasattr</span>(node, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'metadata'</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> node.metadata:</span>
<span id="cb41-12">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"元数据:"</span>)</span>
<span id="cb41-13">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> key, value <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> node.metadata.items():</span>
<span id="cb41-14">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  - </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>key<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>value<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb41-15"></span>
<span id="cb41-16">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 打印文本内容（截断显示）</span></span>
<span id="cb41-17">    text_preview <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> node.text[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"..."</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(node.text) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> node.text</span>
<span id="cb41-18">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">内容预览:</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>text_preview<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>────────────────────────────────────────────────────────────
块 1
────────────────────────────────────────────────────────────
相似度分数: 0.6170
元数据:
  - file_path: /Users/jinchaoduan/Documents/post_project/AI_Blog/posts/RAG/markdown_docs/docs_features_exacto-variant.md
  - file_name: docs_features_exacto-variant.md
  - file_type: text/markdown
  - file_size: 7972
  - creation_date: 2025-11-21
  - last_modified_date: 2025-11-21

内容预览:
Search

`/`

Ask AI

[API](/docs/api-reference/overview)[Models](https://openrouter.ai/models)[Chat](https://openrouter.ai/chat)[Ranking](https://openrouter.ai/rankings)

* Overview

  + [Quickstart](/docs/quickstart)
  + [FAQ](/docs/faq)
  + [Principles](/docs/overview/principles)
  + [Models](/docs/overview/models)
  + [Enterprise](https://openrouter.ai/enterprise)
* Features

  + [Privacy and Logging](/docs/features/privacy-and-logging)
  + [Zero Data Retention (ZDR)](/docs/features/zdr)
  + ...

────────────────────────────────────────────────────────────
块 2
────────────────────────────────────────────────────────────
相似度分数: 0.6101
元数据:
  - file_path: /Users/jinchaoduan/Documents/post_project/AI_Blog/posts/RAG/markdown_docs/docs_overview_models.md
  - file_name: docs_overview_models.md
  - file_type: text/markdown
  - file_size: 9021
  - creation_date: 2025-11-21
  - last_modified_date: 2025-11-21

内容预览:
Search

`/`

Ask AI

[API](/docs/api-reference/overview)[Models](https://openrouter.ai/models)[Chat](https://openrouter.ai/chat)[Ranking](https://openrouter.ai/rankings)

* Overview

  + [Quickstart](/docs/quickstart)
  + [FAQ](/docs/faq)
  + [Principles](/docs/overview/principles)
  + [Models](/docs/overview/models)
  + [Enterprise](https://openrouter.ai/enterprise)
* Features

  + [Privacy and Logging](/docs/features/privacy-and-logging)
  + [Zero Data Retention (ZDR)](/docs/features/zdr)
  + ...

────────────────────────────────────────────────────────────
块 3
────────────────────────────────────────────────────────────
相似度分数: 0.5821
元数据:
  - file_path: /Users/jinchaoduan/Documents/post_project/AI_Blog/posts/RAG/markdown_docs/docs_guides_overview_models.md
  - file_name: docs_guides_overview_models.md
  - file_type: text/markdown
  - file_size: 7557
  - creation_date: 2026-01-06
  - last_modified_date: 2026-01-06

内容预览:
Search

`/`

Ask AI

[Models](https://openrouter.ai/models)[Chat](https://openrouter.ai/chat)[Ranking](https://openrouter.ai/rankings)[Docs](/docs/api-reference/overview)

[Docs](/docs/quickstart)[API Reference](/docs/api/reference/overview)[SDK Reference](/docs/sdks/call-model/overview)

[Docs](/docs/quickstart)[API Reference](/docs/api/reference/overview)[SDK Reference](/docs/sdks/call-model/overview)

* Overview

  + [Quickstart](/docs/quickstart)
  + [Principles](/docs/guides/overview/princi...

────────────────────────────────────────────────────────────
块 4
────────────────────────────────────────────────────────────
相似度分数: 0.5763
元数据:
  - file_path: /Users/jinchaoduan/Documents/post_project/AI_Blog/posts/RAG/markdown_docs/docs_faq_how-are-rate-limits-calculated.md
  - file_name: docs_faq_how-are-rate-limits-calculated.md
  - file_type: text/markdown
  - file_size: 17710
  - creation_date: 2026-01-06
  - last_modified_date: 2026-01-06

内容预览:
Search

`/`

Ask AI

[Models](https://openrouter.ai/models)[Chat](https://openrouter.ai/chat)[Ranking](https://openrouter.ai/rankings)[Docs](/docs/api-reference/overview)

[Docs](/docs/quickstart)[API Reference](/docs/api/reference/overview)[SDK Reference](/docs/sdks/call-model/overview)

[Docs](/docs/quickstart)[API Reference](/docs/api/reference/overview)[SDK Reference](/docs/sdks/call-model/overview)

* Overview

  + [Quickstart](/docs/quickstart)
  + [Principles](/docs/guides/overview/princi...

────────────────────────────────────────────────────────────
块 5
────────────────────────────────────────────────────────────
相似度分数: 0.5703
元数据:
  - file_path: /Users/jinchaoduan/Documents/post_project/AI_Blog/posts/RAG/markdown_docs/docs_features_model-routing.md
  - file_name: docs_features_model-routing.md
  - file_type: text/markdown
  - file_size: 7024
  - creation_date: 2025-11-21
  - last_modified_date: 2025-11-21

内容预览:
|
| 17 | } |
| 18 | ] |
| 19 | ) |
| 20 |  |
| 21 | print(completion.choices[0].message.content) |
```

Was this page helpful?

YesNo

[Previous](/docs/features/zdr)[#### Provider Routing

Route requests to the best provider

Next](/docs/features/provider-routing)[Built with](https://buildwithfern.com/?utm_campaign=buildWith&amp;utm_medium=docs&amp;utm_source=openrouter.ai)

[![Logo](https://files.buildwithfern.com/openrouter.docs.buildwithfern.com/docs/2025-11-21T16:36:36.134Z/content/assets/logo.svg)!...</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb43" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"></span>
<span id="cb43-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Save retrieved chunks to a markdown file for easy inspection</span></span>
<span id="cb43-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># with open("retriever.md", "w", encoding="utf-8") as f:</span></span>
<span id="cb43-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     f.write(f"# Query: {query}\n\n")</span></span>
<span id="cb43-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     f.write(f"# Retrieved {len(nodes)} chunks from openrouter.duckdb\n\n")</span></span>
<span id="cb43-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     for i, node in enumerate(nodes, 1):</span></span>
<span id="cb43-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#         f.write(f"{'─'*60}\n")</span></span>
<span id="cb43-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#         f.write(f"## Chunk {i}\n\n")</span></span>
<span id="cb43-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#         if hasattr(node, 'score'):</span></span>
<span id="cb43-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#             f.write(f"**Similarity Score:** {node.score:.4f}\n\n")</span></span>
<span id="cb43-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#         if hasattr(node, 'metadata') and node.metadata:</span></span>
<span id="cb43-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#             f.write(f"**Metadata:**\n")</span></span>
<span id="cb43-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#             for key, value in node.metadata.items():</span></span>
<span id="cb43-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#                 f.write(f"- {key}: {value}\n")</span></span>
<span id="cb43-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#             f.write(f"\n")</span></span>
<span id="cb43-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#         f.write(f"{node.text}\n\n")</span></span></code></pre></div></div>
</details>
</div>
</section>
</div>
<div id="tabset-3-3" class="tab-pane" aria-labelledby="tabset-3-3-tab">
<p>现在我们的知识库已经填充完毕，我们可以测试检索系统。我们可以提出一个特定的问题，例如“什么是模型变体？ (What are model variants?)”，并查询 <code>Chroma</code> 存储库以查看哪些文本块最相关。这确认了我们的嵌入和搜索是否正常工作。</p>
<section id="问题什么是模型变体-what-are-model-variants" class="level3">
<h3 class="anchored" data-anchor-id="问题什么是模型变体-what-are-model-variants">问题：什么是模型变体？ (What are model variants?)</h3>
<p>RAG 结果：</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb44" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> OpenAI</span>
<span id="cb44-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.embeddings <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Embeddings</span>
<span id="cb44-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_chroma <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Chroma</span>
<span id="cb44-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> typing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> List</span>
<span id="cb44-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb44-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv</span>
<span id="cb44-7"></span>
<span id="cb44-8">load_dotenv()</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>True</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb46" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 针对 OpenRouter API 的自定义嵌入类</span></span>
<span id="cb46-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> OpenRouterEmbeddings(Embeddings):</span>
<span id="cb46-3">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""针对 OpenRouter API 的自定义嵌入类。"""</span></span>
<span id="cb46-4">    </span>
<span id="cb46-5">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, api_key: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, model: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"qwen/qwen3-embedding-8b"</span>):</span>
<span id="cb46-6">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.client <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> OpenAI(</span>
<span id="cb46-7">            base_url<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://openrouter.ai/api/v1"</span>,</span>
<span id="cb46-8">            api_key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>api_key,</span>
<span id="cb46-9">        )</span>
<span id="cb46-10">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model</span>
<span id="cb46-11">    </span>
<span id="cb46-12">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> embed_documents(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, texts: List[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> List[List[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>]]:</span>
<span id="cb46-13">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""对文档列表进行嵌入。"""</span></span>
<span id="cb46-14">        response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.client.embeddings.create(</span>
<span id="cb46-15">            extra_headers<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{</span>
<span id="cb46-16">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"HTTP-Referer"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://ai-blog.com"</span>,</span>
<span id="cb46-17">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"X-Title"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"AI Blog RAG"</span>,</span>
<span id="cb46-18">            },</span>
<span id="cb46-19">            model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.model,</span>
<span id="cb46-20">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>texts,</span>
<span id="cb46-21">            encoding_format<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"float"</span></span>
<span id="cb46-22">        )</span>
<span id="cb46-23">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> [item.embedding <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> item <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> response.data]</span>
<span id="cb46-24">    </span>
<span id="cb46-25">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> embed_query(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, text: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> List[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>]:</span>
<span id="cb46-26">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""对单个查询进行嵌入。"""</span></span>
<span id="cb46-27">        response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.client.embeddings.create(</span>
<span id="cb46-28">            extra_headers<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{</span>
<span id="cb46-29">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"HTTP-Referer"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://ai-blog.com"</span>,</span>
<span id="cb46-30">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"X-Title"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"AI Blog RAG"</span>,</span>
<span id="cb46-31">            },</span>
<span id="cb46-32">            model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.model,</span>
<span id="cb46-33">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>text,</span>
<span id="cb46-34">            encoding_format<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"float"</span></span>
<span id="cb46-35">        )</span>
<span id="cb46-36">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> response.data[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].embedding</span>
<span id="cb46-37"></span>
<span id="cb46-38"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 获取 OpenRouter API 密钥</span></span>
<span id="cb46-39">openrouter_api_key <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> os.getenv(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"OPENROUTER_API_KEY"</span>)</span>
<span id="cb46-40"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> openrouter_api_key:</span>
<span id="cb46-41">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">raise</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">ValueError</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"未在环境变量中找到 OPENROUTER_API_KEY"</span>)</span>
<span id="cb46-42"></span>
<span id="cb46-43"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 使用 OpenRouter 创建嵌入实例</span></span>
<span id="cb46-44">embeddings <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> OpenRouterEmbeddings(</span>
<span id="cb46-45">    api_key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>openrouter_api_key,</span>
<span id="cb46-46">    model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"qwen/qwen3-embedding-8b"</span></span>
<span id="cb46-47">)</span>
<span id="cb46-48"></span>
<span id="cb46-49"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 定义向量数据库位置</span></span>
<span id="cb46-50">persist_directory <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"chroma_db_data"</span></span>
<span id="cb46-51"></span>
<span id="cb46-52"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 加载现有的向量数据库</span></span>
<span id="cb46-53">vectorstore <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chroma(</span>
<span id="cb46-54">    persist_directory<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>persist_directory,</span>
<span id="cb46-55">    embedding_function<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>embeddings</span>
<span id="cb46-56">)</span>
<span id="cb46-57"></span>
<span id="cb46-58"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 测试查询</span></span>
<span id="cb46-59">query <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"What are model variants?"</span></span>
<span id="cb46-60"></span>
<span id="cb46-61"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 执行相似度搜索</span></span>
<span id="cb46-62">results <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> vectorstore.similarity_search(query, k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span>
<span id="cb46-63"></span>
<span id="cb46-64"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">查询问题: '</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>query<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'"</span>)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
查询问题: 'What are model variants?'</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb48" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"找到 </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(results)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> 个相关块：</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>找到 5 个相关块：</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb50" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, doc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(results, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>):</span>
<span id="cb50-2">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"结果 </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">:"</span>)</span>
<span id="cb50-3">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"来源: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>doc<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'source'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'未知'</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb50-4">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"内容预览: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>doc<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>page_content[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">800</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">..."</span>)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>结果 1:
来源: docs_faq_how-are-rate-limits-calculated.md
内容预览: ###### What are model variants?

Variants are suffixes that can be added to the model slug to change its behavior.

Static variants can only be used with specific models and these are listed in our [models api](https://openrouter.ai/api/v1/models).

1. `:free` - The model is always provided for free and has low rate limits.
2. `:beta` - The model is not moderated by OpenRouter.
3. `:extended` - The model has longer than usual context length.
4. `:exacto` - The model only uses OpenRouter-curated high-quality endpoints.
5. `:thinking` - The model supports reasoning by default.

Dynamic variants can be used on all models and they change the behavior of how the request is routed or used.

1. `:online` - All requests will run a query to extract web results that are attached to the prompt.
2. `:...
结果 2:
来源: docs_faq.md
内容预览: ###### What are model variants?

Variants are suffixes that can be added to the model slug to change its behavior.

Static variants can only be used with specific models and these are listed in our [models api](https://openrouter.ai/api/v1/models).

1. `:free` - The model is always provided for free and has low rate limits.
2. `:beta` - The model is not moderated by OpenRouter.
3. `:extended` - The model has longer than usual context length.
4. `:exacto` - The model only uses OpenRouter-curated high-quality endpoints.
5. `:thinking` - The model supports reasoning by default.

Dynamic variants can be used on all models and they change the behavior of how the request is routed or used.

1. `:online` - All requests will run a query to extract web results that are attached to the prompt.
2. `:...
结果 3:
来源: docs_use-cases_crypto-api.md
内容预览: [API](/docs/api-reference/overview)[Models](https://openrouter.ai/models)[Chat](https://openrouter.ai/chat)[Ranking](https://openrouter.ai/rankings)...
结果 4:
来源: docs_sdks_typescript.md
内容预览: [API](/docs/api-reference/overview)[Models](https://openrouter.ai/models)[Chat](https://openrouter.ai/chat)[Ranking](https://openrouter.ai/rankings)...
结果 5:
来源: docs_features_provider-routing.md
内容预览: Route requests through OpenRouter-curated providers

Next](/docs/features/exacto-variant)[Built with](https://buildwithfern.com/?utm_campaign=buildWith&amp;utm_medium=docs&amp;utm_source=openrouter.ai)

[![Logo](https://files.buildwithfern.com/openrouter.docs.buildwithfern.com/docs/2025-11-21T16:36:36.134Z/content/assets/logo.svg)![Logo](https://files.buildwithfern.com/openrouter.docs.buildwithfern.com/docs/2025-11-21T16:36:36.134Z/content/assets/logo-white.svg)](https://openrouter.ai/)

[API](/docs/api-reference/overview)[Models](https://openrouter.ai/models)[Chat](https://openrouter.ai/chat)[Ranking](https://openrouter.ai/rankings)...</code></pre>
</div>
</div>
</section>
</div>
</div>
</div>
</section>
<section id="结合-rag-进行聊天-chat-with-rag" class="level1">
<h1>结合 RAG 进行聊天 (Chat with RAG)</h1>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-4-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-1" aria-controls="tabset-4-1" aria-selected="true" href="">R</a></li><li class="nav-item"><a class="nav-link" id="tabset-4-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-2" aria-controls="tabset-4-2" aria-selected="false" href="">Python chatlas</a></li><li class="nav-item"><a class="nav-link" id="tabset-4-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-3" aria-controls="tabset-4-3" aria-selected="false" href="">Python LangChain</a></li></ul>
<div class="tab-content">
<div id="tabset-4-1" class="tab-pane active" aria-labelledby="tabset-4-1-tab">
<p>最后一个环节是将这种检索能力连接到聊天界面。我们使用 <code>ellmer</code> 创建一个聊天客户端。关键在于，我们使用 <code>ragnar_register_tool_retrieve</code> 注册一个“检索工具”。这使 LLM 能够在需要信息回答用户问题时，自主查询我们的向量数据库。</p>
<p>我们还提供了一个系统提示词，指示模型始终检查知识库并引用其来源。</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb52" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ellmer)</span>
<span id="cb52-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dotenv)</span>
<span id="cb52-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ragnar)</span>
<span id="cb52-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">load_dot_env</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">file =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".env"</span>)</span>
<span id="cb52-5"></span>
<span id="cb52-6">chat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">chat_openrouter</span>(</span>
<span id="cb52-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">api_key =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Sys.getenv</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"OPENROUTER_API_KEY"</span>),</span>
<span id="cb52-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">model =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"openai/gpt-oss-120b"</span>,</span>
<span id="cb52-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">system_prompt =</span> glue<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">trim</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb52-10"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  你是一个负责问答任务的助手。请保持回复简练。</span></span>
<span id="cb52-11"></span>
<span id="cb52-12"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  在回复之前，请从知识库中检索相关素材。引用或转述段落，清晰地标注哪些是你自己的话，哪些是来源。</span></span>
<span id="cb52-13"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  为你引用的每个来源提供一个有效的链接，以及任何其他相关的链接。</span></span>
<span id="cb52-14"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  除非你已经检索并引用了来源，否则不要回答。如果你没有找到相关信息，请说“我在知识库中找不到任何相关信息”。</span></span>
<span id="cb52-15"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    "</span>)</span>
<span id="cb52-16">)</span>
<span id="cb52-17"></span>
<span id="cb52-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 尝试连接存储并注册工具</span></span>
<span id="cb52-19">store_connected <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span></span>
<span id="cb52-20"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tryCatch</span>({</span>
<span id="cb52-21">    store <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ragnar_store_connect</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"openrouter.duckdb"</span>)</span>
<span id="cb52-22">    chat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> chat <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ragnar_register_tool_retrieve</span>(store, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">top_k =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span>
<span id="cb52-23">    store_connected <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span></span>
<span id="cb52-24">}, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">error =</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(e) {</span>
<span id="cb52-25">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">message</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"⚠️ 无法连接到 DuckDB 进行工具注册: "</span>, e<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>message)</span>
<span id="cb52-26">})</span></code></pre></div></div>
</details>
</div>
<section id="问题什么是模型变体what-are-model-variants-2" class="level3">
<h3 class="anchored" data-anchor-id="问题什么是模型变体what-are-model-variants-2">问题：什么是模型变体？(What are model variants?)</h3>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb53" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (store_connected) {</span>
<span id="cb53-2">    chat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">chat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"What are model variants?"</span>)</span>
<span id="cb53-3">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 聊天结束后立即释放锁</span></span>
<span id="cb53-4">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rm</span>(store)</span>
<span id="cb53-5">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gc</span>()</span>
<span id="cb53-6">} <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> {</span>
<span id="cb53-7">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"由于数据库锁定，R 聊天功能暂时不可用。"</span>)</span>
<span id="cb53-8">}</span></code></pre></div></div>
</details>
<p><strong>模型变体（model variants）</strong>是可以在模型标识（slug）后添加的后缀，用来改变模型的行为方式。</p>
<ul>
<li><strong>静态变体</strong>只能用于特定模型，列在 <a href="https://openrouter.ai/api/v1/models">Models API</a> 中。例如：
<ol type="1">
<li><code>:free</code> – 始终免费提供，且速率限制较低。<br>
</li>
<li><code>:beta</code> – 不受 OpenRouter 内容审查。<br>
</li>
<li><code>:extended</code> – 提供比常规更长的上下文长度。<br>
</li>
<li><code>:exacto</code> – 仅使用 OpenRouter 精选的高质量端点。<br>
</li>
<li><code>:thinking</code> – 默认支持推理（reasoning）。</li>
</ol></li>
<li><strong>动态变体</strong>可以在所有模型上使用，改变请求的路由或使用方式。例如：
<ol type="1">
<li><code>:online</code> – 在提示中附加网络搜索结果。<br>
</li>
<li><code>:nitro</code> – 按吞吐量排序提供者，优先更快响应。<br>
</li>
<li><code>:floor</code> – 按价格排序提供者，优先更具成本效益的选项。</li>
</ol></li>
</ul>
<blockquote class="blockquote">
<p>“Variants are suffixes that can be added to the model slug to change its behavior.”【来源: OpenRouter FAQ – 模型和提供者】(https://openrouter.ai/docs/faq) used (Mb) gc trigger (Mb) limit (Mb) max used (Mb) Ncells 3083914 164.7 4675528 249.8 NA 4675528 249.8 Vcells 5315244 40.6 10146329 77.5 16384 9527284 72.7</p>
</blockquote>
</section>
</div>
<div id="tabset-4-2" class="tab-pane" aria-labelledby="tabset-4-2-tab">
<p>我们还可以使用 <code>chatlas</code> 库来创建一个聊天界面。在这里，我们定义了一个自定义工具 <code>retrieve_trusted_content</code>，用于查询我们的 DuckDB 索引。然后我们将这个工具注册到聊天模型中，使其能够在回答用户问题时引入相关信息。</p>
<section id="问题什么是模型变体what-are-model-variants-3" class="level3">
<h3 class="anchored" data-anchor-id="问题什么是模型变体what-are-model-variants-3">问题：什么是模型变体？(What are model variants?)</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb54" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb54-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> typing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Any, List</span>
<span id="cb54-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> OpenAI</span>
<span id="cb54-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> chatlas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> ctl</span>
<span id="cb54-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> llama_index.core <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> VectorStoreIndex, Settings</span>
<span id="cb54-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> llama_index.core.embeddings <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> BaseEmbedding</span>
<span id="cb54-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> llama_index.vector_stores.duckdb <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> DuckDBVectorStore</span>
<span id="cb54-8"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv</span>
<span id="cb54-9">load_dotenv()</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>True</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb56" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 确保 API 密钥可用</span></span>
<span id="cb56-2">openrouter_api_key <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> os.getenv(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"OPENROUTER_API_KEY"</span>)</span>
<span id="cb56-3"></span>
<span id="cb56-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 针对 LlamaIndex 的自定义 OpenRouter 嵌入类</span></span>
<span id="cb56-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> OpenRouterEmbedding(BaseEmbedding):</span>
<span id="cb56-6">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""与 LlamaIndex 兼容的 OpenRouter API 自定义嵌入类。"""</span></span>
<span id="cb56-7"></span>
<span id="cb56-8">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(</span>
<span id="cb56-9">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>,</span>
<span id="cb56-10">        api_key: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>,</span>
<span id="cb56-11">        model: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"qwen/qwen3-embedding-8b"</span>,</span>
<span id="cb56-12">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>kwargs: Any</span>
<span id="cb56-13">    ):</span>
<span id="cb56-14">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">super</span>().<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>kwargs)</span>
<span id="cb56-15">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._client <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> OpenAI(</span>
<span id="cb56-16">            base_url<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://openrouter.ai/api/v1"</span>,</span>
<span id="cb56-17">            api_key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>api_key,</span>
<span id="cb56-18">        )</span>
<span id="cb56-19">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model</span>
<span id="cb56-20"></span>
<span id="cb56-21">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> _get_query_embedding(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, query: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> List[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>]:</span>
<span id="cb56-22">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""获取查询字符串的嵌入向量。"""</span></span>
<span id="cb56-23">        response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._client.embeddings.create(</span>
<span id="cb56-24">            extra_headers<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{</span>
<span id="cb56-25">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"HTTP-Referer"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://ai-blog.com"</span>,</span>
<span id="cb56-26">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"X-Title"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"AI Blog RAG"</span>,</span>
<span id="cb56-27">            },</span>
<span id="cb56-28">            model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._model,</span>
<span id="cb56-29">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>query,</span>
<span id="cb56-30">            encoding_format<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"float"</span></span>
<span id="cb56-31">        )</span>
<span id="cb56-32">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> response.data[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].embedding</span>
<span id="cb56-33"></span>
<span id="cb56-34">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> _get_text_embedding(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, text: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> List[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>]:</span>
<span id="cb56-35">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""获取文本字符串的嵌入向量。"""</span></span>
<span id="cb56-36">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._get_query_embedding(text)</span>
<span id="cb56-37"></span>
<span id="cb56-38">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">async</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> _aget_query_embedding(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, query: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> List[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>]:</span>
<span id="cb56-39">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""异步版本的 get_query_embedding。"""</span></span>
<span id="cb56-40">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._get_query_embedding(query)</span>
<span id="cb56-41"></span>
<span id="cb56-42">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">async</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> _aget_text_embedding(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, text: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> List[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>]:</span>
<span id="cb56-43">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""异步版本的 get_text_embedding。"""</span></span>
<span id="cb56-44">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._get_text_embedding(text)</span>
<span id="cb56-45"></span>
<span id="cb56-46"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1. 配置嵌入模型</span></span>
<span id="cb56-47">embed_model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> OpenRouterEmbedding(</span>
<span id="cb56-48">    api_key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>openrouter_api_key,</span>
<span id="cb56-49">    model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"qwen/qwen3-embedding-8b"</span></span>
<span id="cb56-50">)</span>
<span id="cb56-51">Settings.embed_model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> embed_model</span>
<span id="cb56-52"></span>
<span id="cb56-53"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 2. 加载索引</span></span>
<span id="cb56-54"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb56-55">    vector_store <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DuckDBVectorStore(database_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"openrouter.duckdb"</span>, persist_dir<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"./persist/"</span>, read_only<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb56-56">    index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> VectorStoreIndex.from_vector_store(vector_store<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>vector_store)</span>
<span id="cb56-57">    retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> index.as_retriever(similarity_top_k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span>
<span id="cb56-58"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">Exception</span> <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> e:</span>
<span id="cb56-59">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"⚠️ 无法加载向量数据库: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>e<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb56-60">    index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb56-61">    retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb56-62"></span>
<span id="cb56-63"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 3. 定义聊天工具</span></span>
<span id="cb56-64"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> retrieve_trusted_content(question: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb56-65">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb56-66"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    在知识库中检索信任的内容来回答问题。</span></span>
<span id="cb56-67"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb56-68">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> retriever:</span>
<span id="cb56-69">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"知识库当前不可用（由于数据库锁定）。"</span></span>
<span id="cb56-70">    nodes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> retriever.retrieve(question)</span>
<span id="cb56-71">    combined_text <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>.join([<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Source Content </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">:</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>node<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>text<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, node <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(nodes)])</span>
<span id="cb56-72">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> combined_text</span>
<span id="cb56-73"></span>
<span id="cb56-74"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 4. 设置聊天模型并注册工具</span></span>
<span id="cb56-75">chat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ctl.ChatOpenRouter(</span>
<span id="cb56-76">    model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"openai/gpt-oss-120b"</span>,</span>
<span id="cb56-77">    api_key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>openrouter_api_key,</span>
<span id="cb56-78">    base_url<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://openrouter.ai/api/v1"</span>,</span>
<span id="cb56-79">    system_prompt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb56-80"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    你是一个负责问答任务助手。请保持回复简练。</span></span>
<span id="cb56-81"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    在回复之前，始终通过 retrieve_trusted_content 工具检索相关素材。</span></span>
<span id="cb56-82"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb56-83">)</span>
<span id="cb56-84"></span>
<span id="cb56-85">chat.register_tool(retrieve_trusted_content)</span>
<span id="cb56-86"></span>
<span id="cb56-87"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 5. 执行聊天</span></span>
<span id="cb56-88"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb56-89">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> chat.chat(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"What are model variants?"</span>)</span>
<span id="cb56-90">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(response)</span>
<span id="cb56-91"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">Exception</span> <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> e:</span>
<span id="cb56-92">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"⚠️ 聊天过程出错 (可能是显示处理问题): </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>e<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;IPython.core.display.HTML object&gt;
&lt;IPython.core.display.Markdown object&gt;
⚠️ 聊天过程出错 (可能是显示处理问题): Failed to create display handle</code></pre>
</div>
</div>
</section>
</div>
<div id="tabset-4-3" class="tab-pane" aria-labelledby="tabset-4-3-tab">
<p>在 Python 的 LangChain 中，我们设置了一个完整的 RAG 流水线。这包括： 1. <strong>检索器 (Retriever)</strong>：使用我们的 <code>Chroma</code> 向量数据库。 2. <strong>提示词模版 (Prompt Template)</strong>：指示模型使用检索到的上下文来回答问题。 3. <strong>聊天模型 (Chat Model)</strong>：使用 OpenRouter 提供的 <code>gpt-4o</code>。 4. <strong>输出解析器 (Output Parser)</strong>：用于格式化最终响应。</p>
<p>这种模块化方法是构建生产级 AI 应用程序的典型方式。</p>
<section id="问题什么是模型变体what-are-model-variants-4" class="level3">
<h3 class="anchored" data-anchor-id="问题什么是模型变体what-are-model-variants-4">问题：什么是模型变体？(What are model variants?)</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb58" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChatOpenAI</span>
<span id="cb58-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.prompts <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChatPromptTemplate</span>
<span id="cb58-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.runnables <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> RunnablePassthrough</span>
<span id="cb58-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.output_parsers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> StrOutputParser</span>
<span id="cb58-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> OpenAI</span>
<span id="cb58-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.embeddings <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Embeddings</span>
<span id="cb58-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_chroma <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Chroma</span>
<span id="cb58-8"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> typing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> List</span>
<span id="cb58-9"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb58-10"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv</span>
<span id="cb58-11"></span>
<span id="cb58-12">load_dotenv()</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>True</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb60" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 针对 LangChain 的自定义 OpenRouter 嵌入类</span></span>
<span id="cb60-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> OpenRouterEmbeddings(Embeddings):</span>
<span id="cb60-3">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, api_key: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, model: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"qwen/qwen3-embedding-8b"</span>):</span>
<span id="cb60-4">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._client <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> OpenAI(</span>
<span id="cb60-5">            base_url<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://openrouter.ai/api/v1"</span>,</span>
<span id="cb60-6">            api_key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>api_key,</span>
<span id="cb60-7">        )</span>
<span id="cb60-8">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model</span>
<span id="cb60-9"></span>
<span id="cb60-10">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> embed_documents(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, texts: List[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> List[List[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>]]:</span>
<span id="cb60-11">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""嵌入文档列表。"""</span></span>
<span id="cb60-12">        response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._client.embeddings.create(</span>
<span id="cb60-13">            model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._model,</span>
<span id="cb60-14">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>texts</span>
<span id="cb60-15">        )</span>
<span id="cb60-16">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> [d.embedding <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> d <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> response.data]</span>
<span id="cb60-17"></span>
<span id="cb60-18">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> embed_query(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, text: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> List[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>]:</span>
<span id="cb60-19">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""嵌入单个查询。"""</span></span>
<span id="cb60-20">        response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._client.embeddings.create(</span>
<span id="cb60-21">            model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._model,</span>
<span id="cb60-22">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>text</span>
<span id="cb60-23">        )</span>
<span id="cb60-24">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> response.data[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].embedding</span>
<span id="cb60-25"></span>
<span id="cb60-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 获取 OpenRouter API 密钥</span></span>
<span id="cb60-27">openrouter_api_key <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> os.getenv(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"OPENROUTER_API_KEY"</span>)</span>
<span id="cb60-28"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> openrouter_api_key:</span>
<span id="cb60-29">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">raise</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">ValueError</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"未在环境变量中找到 OPENROUTER_API_KEY"</span>)</span>
<span id="cb60-30"></span>
<span id="cb60-31"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 使用 OpenRouter 创建嵌入实例</span></span>
<span id="cb60-32">embeddings <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> OpenRouterEmbeddings(</span>
<span id="cb60-33">    api_key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>openrouter_api_key,</span>
<span id="cb60-34">    model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"qwen/qwen3-embedding-8b"</span></span>
<span id="cb60-35">)</span>
<span id="cb60-36"></span>
<span id="cb60-37"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 定义向量数据库位置</span></span>
<span id="cb60-38">persist_directory <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"chroma_db_data"</span></span>
<span id="cb60-39"></span>
<span id="cb60-40"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 加载现有的向量数据库</span></span>
<span id="cb60-41"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"正在从 </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>persist_directory<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> 加载现有向量数据库..."</span>)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>正在从 chroma_db_data 加载现有向量数据库...</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb62" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1">vectorstore <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chroma(</span>
<span id="cb62-2">    persist_directory<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>persist_directory,</span>
<span id="cb62-3">    embedding_function<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>embeddings</span>
<span id="cb62-4">)</span>
<span id="cb62-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"✓ 向量数据库加载成功"</span>)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>✓ 向量数据库加载成功</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb64" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 使用 OpenRouter 初始化 LLM</span></span>
<span id="cb64-2">llm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatOpenAI(</span>
<span id="cb64-3">    model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"openai/gpt-oss-120b"</span>,</span>
<span id="cb64-4">    openai_api_key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>os.getenv(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"OPENROUTER_API_KEY"</span>),</span>
<span id="cb64-5">    openai_api_base<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://openrouter.ai/api/v1"</span></span>
<span id="cb64-6">)</span>
<span id="cb64-7"></span>
<span id="cb64-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 创建提示词模版</span></span>
<span id="cb64-9">system_prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (</span>
<span id="cb64-10">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"你是一个负责问答任务助手。"</span></span>
<span id="cb64-11">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"请使用以下检索到的素材来回答问题。"</span></span>
<span id="cb64-12">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"如果你不知道答案，请不要胡编乱造。"</span></span>
<span id="cb64-13">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"最多使用三句话，并保持回复简练。"</span></span>
<span id="cb64-14">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb64-15">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"素材: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{context}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb64-16">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb64-17">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"问题: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{question}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb64-18">)</span>
<span id="cb64-19"></span>
<span id="cb64-20">prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatPromptTemplate.from_template(system_prompt)</span>
<span id="cb64-21"></span>
<span id="cb64-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 创建检索器</span></span>
<span id="cb64-23">retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> vectorstore.as_retriever(search_kwargs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"k"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>})</span>
<span id="cb64-24"></span>
<span id="cb64-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 用于格式化文档的辅助函数</span></span>
<span id="cb64-26"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> format_docs(docs):</span>
<span id="cb64-27">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>.join(doc.page_content <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> doc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> docs)</span>
<span id="cb64-28"></span>
<span id="cb64-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 使用 LCEL 构建 RAG 链</span></span>
<span id="cb64-30">rag_chain <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (</span>
<span id="cb64-31">    {</span>
<span id="cb64-32">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"context"</span>: retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> format_docs,</span>
<span id="cb64-33">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"question"</span>: RunnablePassthrough()</span>
<span id="cb64-34">    }</span>
<span id="cb64-35">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> prompt</span>
<span id="cb64-36">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> llm</span>
<span id="cb64-37">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> StrOutputParser()</span>
<span id="cb64-38">)</span>
<span id="cb64-39"></span>
<span id="cb64-40"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"✓ RAG 链创建成功！"</span>)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>✓ RAG 链创建成功！</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb66" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 测试 RAG 链</span></span>
<span id="cb66-2">question <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"What are model variants?"</span></span>
<span id="cb66-3"></span>
<span id="cb66-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">查询问题: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>question<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
查询问题: What are model variants?</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb68" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 独立获取上下文文档以便展示</span></span>
<span id="cb68-2">context_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> retriever.invoke(question)</span>
<span id="cb68-3"></span>
<span id="cb68-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 调用 RAG 链</span></span>
<span id="cb68-5">answer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rag_chain.invoke(question)</span>
<span id="cb68-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> textwrap</span>
<span id="cb68-7"></span>
<span id="cb68-8"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> line <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> answer.split(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>):</span>
<span id="cb68-9">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(textwrap.fill(line, width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">80</span>))</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>模型变体是可以附加在模型标识符后面的后缀，用来改变化模型的行为或路由方式。静态变体（如
`:free`、`:beta`、`:extended`、`:exacto`、`:thinking`）仅适用于特定模型，而动态变体（如
`:online`、`:nitro`、`:floor`）可在所有模型上使用，分别提供网络搜索、优先高吞吐或低价格的路由策略。</code></pre>
</div>
</div>
</section>
</div>
</div>
</div>


<!-- -->

</section>

 ]]></description>
  <category>AI</category>
  <category>API</category>
  <category>tutorial</category>
  <guid>https://jcwinning.github.io/LandingPage/posts/RAG/</guid>
  <pubDate>Sat, 01 Nov 2025 16:00:00 GMT</pubDate>
  <media:content url="https://jcwinning.github.io/LandingPage/posts/RAG/images.png" medium="image" type="image/png" height="79" width="144"/>
</item>
<item>
  <title>OpenRouter：多 AI 模型的统一 API</title>
  <dc:creator>Tony D</dc:creator>
  <link>https://jcwinning.github.io/LandingPage/posts/openrouter/</link>
  <description><![CDATA[ 





<section id="openrouter-简介" class="level1">
<h1>OpenRouter 简介</h1>
<p>OpenRouter 是一个强大的平台，它提供了一个统一的 API 接口，用于访问来自不同提供商的多个 AI 模型。开发人员无需分别为每个 AI 服务进行集成，而是可以使用 OpenRouter 的单一端点访问来自 OpenAI、Anthropic、Google 等公司的模型。</p>
<section id="openrouter-入门" class="level2">
<h2 class="anchored" data-anchor-id="openrouter-入门">OpenRouter 入门</h2>
<p>使用 OpenRouter 非常简单，只需几个步骤即可完成。该平台旨在最大限度地减少设置时间，同时保持安全最佳实践。</p>
</section>
<section id="创建您的-openrouter-账户" class="level2">
<h2 class="anchored" data-anchor-id="创建您的-openrouter-账户">1. 创建您的 OpenRouter 账户</h2>
<p>首先，访问 <a href="https://openrouter.ai">openrouter.ai</a> 并创建一个账户。注册过程非常简单：</p>
<ol type="1">
<li><strong>注册</strong>：使用您的电子邮箱或社交登录（Google、GitHub）</li>
<li><strong>验证邮箱</strong>：通过验证链接确认您的电子邮箱地址</li>
<li><strong>访问仪表板</strong>：导航到仪表板，您可以在那里找到您的 API 密钥</li>
</ol>
<p><strong>💡 专家提示</strong>：您的仪表板提供了宝贵的洞察，包括： - 使用统计和成本追踪 - 模型性能指标 - API 密钥管理 - 账单信息</p>
</section>
<section id="安全的-api-密钥管理" class="level2">
<h2 class="anchored" data-anchor-id="安全的-api-密钥管理">2. 安全的 API 密钥管理</h2>
<p>在使用 AI API 时，安全至关重要。切勿直接在代码中硬编码 API 密钥。相反，使用环境变来确保您的凭据安全：</p>
<section id="为什么环境变量很重要" class="level3">
<h3 class="anchored" data-anchor-id="为什么环境变量很重要">为什么环境变量很重要</h3>
<ul>
<li><strong>安全性</strong>：防止在版本控制中意外泄露</li>
<li><strong>灵活性</strong>：允许为开发、测试和生产环境使用不同的密钥</li>
<li><strong>协作</strong>：团队成员可以在不共享的情况下使用自己的密钥</li>
<li><strong>部署</strong>：易于在不同的托管环境中进行管理</li>
</ul>
</section>
<section id="设置环境变量" class="level3">
<h3 class="anchored" data-anchor-id="设置环境变量">设置环境变量</h3>
<p>在项目根目录下创建一个 <code>.env</code> 文件：</p>
<p>OPENROUTER_API_KEY=your_actual_api_key_here</p>
<p>安装 <code>python-dotenv</code> 库以加载环境变量：</p>
<p>pip install python-dotenv</p>
</section>
</section>
<section id="您的第一次-api-调用" class="level2">
<h2 class="anchored" data-anchor-id="您的第一次-api-调用">3. 您的第一次 API 调用</h2>
<p>现在您已经设置好了 API 密钥，让我们进行第一次 API 调用。OpenRouter 巧妙地使用了与 OpenAI 相同的 API 格式，这意味着您可以使用熟悉的 <code>openai</code> Python 库 —— 只是使用不同的基端点 URL。</p>
<section id="了解架构" class="level3">
<h3 class="anchored" data-anchor-id="了解架构">了解架构</h3>
<p><strong>🔧 它是如何工作的</strong>：OpenRouter 充当智能代理，负责： 1. 接收您的标准化 API 请求 2. 将其路由到适当的 AI 模型提供商 3. 处理特定于提供商的身份验证和格式化 4. 以一致的格式返回响应 5. 追踪所有模型的使用情况和成本</p>
</section>
<section id="必需的依赖项" class="level3">
<h3 class="anchored" data-anchor-id="必需的依赖项">必需的依赖项</h3>
<p>在开始之前，请确保您已安装必要的 Python 包：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pip</span> install openai python-dotenv</span></code></pre></div></div>
<ul>
<li><strong>openai</strong>: 官方的 OpenAI Python 客户端（与 OpenRouter 兼容）</li>
<li><strong>python-dotenv</strong>: 用于从 <code>.env</code> 文件加载环境变量</li>
</ul>
</section>
<section id="基础文本生成示例" class="level3">
<h3 class="anchored" data-anchor-id="基础文本生成示例">基础文本生成示例</h3>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" aria-controls="tabset-1-1" aria-selected="true" href="">Python (使用 OpenAI 包)</a></li><li class="nav-item"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" aria-controls="tabset-1-2" aria-selected="false" href="">Python (使用 Chatlas 包)</a></li><li class="nav-item"><a class="nav-link" id="tabset-1-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-3" aria-controls="tabset-1-3" aria-selected="false" href="">R (使用 Ellmer 包)</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" aria-labelledby="tabset-1-1-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> OpenAI</span>
<span id="cb2-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb2-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv</span>
<span id="cb2-4"></span>
<span id="cb2-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 从 .env 文件加载环境变量</span></span>
<span id="cb2-6">load_dotenv()</span>
<span id="cb2-7"></span>
<span id="cb2-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 使用 OpenRouter 初始化 OpenAI 客户端</span></span>
<span id="cb2-9">client <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> OpenAI(</span>
<span id="cb2-10">  base_url<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://openrouter.ai/api/v1"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># OpenRouter 的 API 端点</span></span>
<span id="cb2-11">  api_key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>os.getenv(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"OPENROUTER_API_KEY"</span>),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 您安全的 API 密钥</span></span>
<span id="cb2-12">)</span>
<span id="cb2-13"></span>
<span id="cb2-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 使用 OpenRouter 创建对话补全</span></span>
<span id="cb2-15">completion <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> client.chat.completions.create(</span>
<span id="cb2-16">  extra_headers<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{</span>
<span id="cb2-17">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"HTTP-Referer"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://your-site.com"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 可选：帮助 OpenRouter 改进服务</span></span>
<span id="cb2-18">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"X-Title"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Your Site Name"</span>,             <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 可选：用于 OpenRouter 排名的网站名称</span></span>
<span id="cb2-19">  },</span>
<span id="cb2-20">  model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"openai/gpt-oss-20b:free"</span>,          <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 用于测试/开发的免费模型</span></span>
<span id="cb2-21">  messages<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[</span>
<span id="cb2-22">    {</span>
<span id="cb2-23">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"role"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"user"</span>,</span>
<span id="cb2-24">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"content"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"你好！你能用简单的术语解释一下什么是 OpenRouter 吗？"</span></span>
<span id="cb2-25">    }</span>
<span id="cb2-26">  ],</span>
<span id="cb2-27">  temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 控制创造力 (0.0 = 确定性, 1.0 = 非常有创意)</span></span>
<span id="cb2-28">)</span>
<span id="cb2-29"></span>
<span id="cb2-30"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 提取并打印响应</span></span>
<span id="cb2-31"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(completion.choices[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].message.content)</span></code></pre></div></div>
</details>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" aria-labelledby="tabset-1-2-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> chatlas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChatOpenRouter</span>
<span id="cb3-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb3-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv</span>
<span id="cb3-4"></span>
<span id="cb3-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 从 .env 文件加载环境变量</span></span>
<span id="cb3-6">load_dotenv()</span>
<span id="cb3-7"></span>
<span id="cb3-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 使用 OpenRouter 初始化 OpenAI 客户端</span></span>
<span id="cb3-9">client <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatOpenRouter(api_key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>os.getenv(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"OPENROUTER_API_KEY"</span>)</span>
<span id="cb3-10">,base_url<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'https://openrouter.ai/api/v1'</span></span>
<span id="cb3-11"> ,system_prompt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb3-12"> ,model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"openai/gpt-oss-20b:free"</span>)</span></code></pre></div></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1">response<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>client.chat(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"法国的首都是哪里？"</span>)</span>
<span id="cb4-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#str(response)</span></span></code></pre></div></div>
</details>
</div>
</div>
<div id="tabset-1-3" class="tab-pane" aria-labelledby="tabset-1-3-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ellmer)</span>
<span id="cb5-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dotenv)</span>
<span id="cb5-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">load_dot_env</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">file =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".env"</span>)</span>
<span id="cb5-4"></span>
<span id="cb5-5">chat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">chat_openrouter</span>(</span>
<span id="cb5-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">system_prompt =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb5-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">api_key =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Sys.getenv</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"OPENROUTER_API_KEY"</span>),</span>
<span id="cb5-8"> </span>
<span id="cb5-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">model =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"openai/gpt-oss-20b:free"</span>,</span>
<span id="cb5-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">echo =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span></span>
<span id="cb5-11">)</span></code></pre></div></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">chat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">chat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"给我讲三个关于统计学家的笑话"</span>)</span></code></pre></div></div>
</details>
</div>
</div>
</div>
</div>
<p><strong>核心组件说明：</strong></p>
<ul>
<li><strong><code>base_url</code></strong>：指向 OpenRouter 的 API 而非 OpenAI 的</li>
<li><strong><code>model</code></strong>：使用 OpenRouter 的模型命名格式 (<code>提供商/模型名称</code>)</li>
<li><strong><code>extra_headers</code></strong>：可选，但建议用于 OpenRouter 的分析</li>
<li><strong><code>temperature</code></strong>：控制响应的创造力（范围 0.0-2.0）</li>
<li><strong><code>messages</code></strong>：标准的聊天格式，采用基于角色的对话结构</li>
</ul>
<p><strong>💡 模型选择建议：</strong> - <strong>免费模型</strong>：非常适合开发阶段（以 <code>*free</code> 结尾） - <strong>经济型模型</strong>：适合生产环境的成本效益模型（以 <code>*:budget</code> 结尾） - <strong>高级模型</strong>：最佳性能（<code>*</code>、<code>*:pro</code>、<code>*:latest</code>） - <strong>专业模型</strong>：针对特定任务优化的模型（编程、数学、创意写作）</p>
</section>
</section>
<section id="掌握系统提示词-system-prompts" class="level2">
<h2 class="anchored" data-anchor-id="掌握系统提示词-system-prompts">4. 掌握系统提示词 (System Prompts)</h2>
<p>系统提示词是塑造 AI 行为、个性和回复风格的强大工具。它们设置了整个对话的上下文和规则，在对话流中出现在用户消息之前。</p>
<section id="什么是系统提示词" class="level3">
<h3 class="anchored" data-anchor-id="什么是系统提示词">什么是系统提示词？</h3>
<p>系统提示词充当<strong>元指令</strong>，指导 AI 在整个对话中应如何反应。它们最先被处理，并影响所有后续的交互。</p>
</section>
<section id="为什么系统提示词很重要" class="level3">
<h3 class="anchored" data-anchor-id="为什么系统提示词很重要">为什么系统提示词很重要</h3>
<ul>
<li><strong>一致的行为</strong>：确保 AI 在整个过程中保持所需的个性</li>
<li><strong>输出格式</strong>：规定响应结构（JSON、Markdown、代码块）</li>
<li><strong>安全约束</strong>：设置回复的边界和限制</li>
<li><strong>上下文设置</strong>：提供背景信息以获得更好的回复</li>
<li><strong>任务专门化</strong>：针对特定用例优化 AI</li>
</ul>
</section>
<section id="有效的系统提示词示例" class="level3">
<h3 class="anchored" data-anchor-id="有效的系统提示词示例">有效的系统提示词示例</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 带有系统提示词的示例</span></span>
<span id="cb7-2">completion <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> client.chat.completions.create(</span>
<span id="cb7-3">  model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"openai/gpt-oss-20b:free"</span>,</span>
<span id="cb7-4">  messages<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[</span>
<span id="cb7-5">    {</span>
<span id="cb7-6">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"role"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"system"</span>,</span>
<span id="cb7-7">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"content"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"你是一个乐于助人的 AI 助手，可以用简单的术语解释技术概念。始终保持友好，并尽可能使用类比，保持简单。"</span></span>
<span id="cb7-8">    },</span>
<span id="cb7-9">    {</span>
<span id="cb7-10">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"role"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"user"</span>,</span>
<span id="cb7-11">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"content"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"LLM 模型中的温度 (temperature) 是如何工作的？"</span></span>
<span id="cb7-12">    }</span>
<span id="cb7-13">  ],</span>
<span id="cb7-14">  temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span></span>
<span id="cb7-15">)</span>
<span id="cb7-16"></span>
<span id="cb7-17"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(completion.choices[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].message.content)</span></code></pre></div></div>
</details>
</div>
<p>常见的系统提示词模式：</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 不同的系统提示词示例</span></span>
<span id="cb8-2">system_prompts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb8-3">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"coding_assistant"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"你是一个专家级程序员。提供整洁、注释良好的代码解决方案，并解释你的推理。"</span>,</span>
<span id="cb8-4">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"creative_writer"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"你是一个创意故事讲述者。编写具有生动描述和引人入胜角色的动人叙述。"</span>,</span>
<span id="cb8-5">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data_analyst"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"你是一个数据分析师。根据数据提供见解，建议可视化方式，并清晰地解释统计概念。"</span>,</span>
<span id="cb8-6">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tutor"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"你是一个耐心的导师。将复杂的主题分解为简单的步骤并提供鼓励性的反馈。"</span></span>
<span id="cb8-7">}</span>
<span id="cb8-8"></span>
<span id="cb8-9"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> chat_with_persona(persona, user_message):</span>
<span id="cb8-10">    completion <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> client.chat.completions.create(</span>
<span id="cb8-11">        model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"openai/gpt-oss-20b:free"</span>,</span>
<span id="cb8-12">        messages<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[</span>
<span id="cb8-13">            {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"role"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"system"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"content"</span>: system_prompts[persona]},</span>
<span id="cb8-14">            {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"role"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"user"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"content"</span>: user_message}</span>
<span id="cb8-15">        ],</span>
<span id="cb8-16">        temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span></span>
<span id="cb8-17">    )</span>
<span id="cb8-18">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> completion.choices[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].message.content</span>
<span id="cb8-19"></span>
<span id="cb8-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 示例用法</span></span>
<span id="cb8-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#response = chat_with_persona("coding_assistant", "如何用 Python 反转字符串？")</span></span>
<span id="cb8-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#print(response)</span></span></code></pre></div></div>
</details>
</div>
</section>
</section>
<section id="流式响应实时-ai-交互" class="level2">
<h2 class="anchored" data-anchor-id="流式响应实时-ai-交互">5. 流式响应：实时 AI 交互</h2>
<p>流式传输 (Streaming) 是提升用户体验的利器，特别是在聊天应用和交互式工具中。流式传输不是等待完整的响应，而是在生成内容时立即交付，从而创造自然且引人入胜的对话。</p>
<section id="为什么流式传输很重要" class="level3">
<h3 class="anchored" data-anchor-id="为什么流式传输很重要">为什么流式传输很重要</h3>
<p><strong>🚀 用户体验优势：</strong> - <strong>立即反馈</strong>：用户能立即看到响应开始生成 - <strong>降低感知延迟</strong>：内容在生成时即刻显示 - <strong>自然的对话流</strong>：模仿人类说话的模式 - <strong>进度指示</strong>：用户知道 AI 正在工作 - <strong>及早终止</strong>：如果需要，用户可以停止过长的回复</p>
<p><strong>⚡ 技术优势：</strong> - <strong>更低的内存占用</strong>：无需缓冲完整响应 - <strong>更快的首字节时间</strong>：内容立即开始流动 - <strong>更好的错误处理</strong>：在过程中更早发现问题 - <strong>资源效率</strong>：增量处理数据</p>
</section>
<section id="在-openrouter-中实现流式传输" class="level3">
<h3 class="anchored" data-anchor-id="在-openrouter-中实现流式传输">在 OpenRouter 中实现流式传输</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 初始化 OpenAI 客户端（如果尚未完成）</span></span>
<span id="cb9-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> OpenAI</span>
<span id="cb9-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb9-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv</span>
<span id="cb9-5"></span>
<span id="cb9-6">load_dotenv()</span>
<span id="cb9-7">client <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> OpenAI(</span>
<span id="cb9-8">  base_url<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://openrouter.ai/api/v1"</span>,</span>
<span id="cb9-9">  api_key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>os.getenv(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"OPENROUTER_API_KEY"</span>),</span>
<span id="cb9-10">)</span>
<span id="cb9-11"></span>
<span id="cb9-12"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> stream_response(model, message):</span>
<span id="cb9-13">    stream <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> client.chat.completions.create(</span>
<span id="cb9-14">        model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>model,</span>
<span id="cb9-15">        messages<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"role"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"user"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"content"</span>: message}],</span>
<span id="cb9-16">        stream<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span></span>
<span id="cb9-17">    )</span>
<span id="cb9-18"></span>
<span id="cb9-19">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> chunk <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> stream:</span>
<span id="cb9-20">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> chunk.choices[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].delta.content <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb9-21">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(chunk.choices[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].delta.content, end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span>, flush<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb9-22"></span>
<span id="cb9-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 流式传输示例</span></span>
<span id="cb9-24"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"正在流式传输响应："</span>)</span>
<span id="cb9-25">stream_response(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"openai/gpt-oss-20b:free"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"请给我讲一个关于 AI 的短篇故事"</span>)</span>
<span id="cb9-26"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>()  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 流式传输结束后添加换行</span></span></code></pre></div></div>
</details>
</div>
</section>
<section id="文字转图像-text-to-image" class="level3">
<h3 class="anchored" data-anchor-id="文字转图像-text-to-image">6. 文字转图像 (Text to Image)</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> OpenAI</span>
<span id="cb10-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> base64</span>
<span id="cb10-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> datetime</span></code></pre></div></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># | eval: false</span></span>
<span id="cb11-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> OpenAI</span>
<span id="cb11-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb11-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv</span>
<span id="cb11-5"></span>
<span id="cb11-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 从 .env 文件加载环境变量</span></span>
<span id="cb11-7">load_dotenv()</span>
<span id="cb11-8"></span>
<span id="cb11-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 使用 OpenRouter 初始化 OpenAI 客户端</span></span>
<span id="cb11-10">client <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> OpenAI(</span>
<span id="cb11-11">    base_url<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://openrouter.ai/api/v1"</span>,</span>
<span id="cb11-12">    api_key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>os.getenv(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"OPENROUTER_API_KEY"</span>),</span>
<span id="cb11-13">)</span></code></pre></div></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 图像生成请求</span></span>
<span id="cb12-2">response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> client.chat.completions.create(</span>
<span id="cb12-3">    extra_headers<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{</span>
<span id="cb12-4">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"HTTP-Referer"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"www.tonydotdev.com"</span>,</span>
<span id="cb12-5">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"X-Title"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"TT_AI_blog"</span>,</span>
<span id="cb12-6">    },</span>
<span id="cb12-7">    model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"google/gemini-2.5-flash-image"</span>,</span>
<span id="cb12-8">    messages<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[</span>
<span id="cb12-9">        {</span>
<span id="cb12-10">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"role"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"user"</span>,</span>
<span id="cb12-11">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"content"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"生成一张宁静且写实的日出雪山风景图。"</span>,</span>
<span id="cb12-12">        }</span>
<span id="cb12-13">    ],</span>
<span id="cb12-14">    modalities<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"image"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text"</span>],</span>
<span id="cb12-15">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#image_size="1024x1024",</span></span>
<span id="cb12-16">)</span></code></pre></div></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> base64</span>
<span id="cb13-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> datetime</span>
<span id="cb13-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 提取消息</span></span>
<span id="cb13-4">message <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> response.choices[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].message</span>
<span id="cb13-5"></span>
<span id="cb13-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 处理图像输出（base64 字符串位于 "data:image/png;base64,..." 中）</span></span>
<span id="cb13-7"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> message.images:</span>
<span id="cb13-8">    data_url <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> message.images[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"image_url"</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"url"</span>]</span>
<span id="cb13-9"></span>
<span id="cb13-10">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 如果存在前缀则将其剥离</span></span>
<span id="cb13-11">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> data_url.startswith(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data:image"</span>):</span>
<span id="cb13-12">        _, base64_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> data_url.split(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">","</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb13-13">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb13-14">        base64_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> data_url</span>
<span id="cb13-15"></span>
<span id="cb13-16">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 解码并保存为 PNG</span></span>
<span id="cb13-17">    image_bytes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> base64.b64decode(base64_data)</span>
<span id="cb13-18">    current_time <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> datetime.datetime.now().strftime(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"%H%M"</span>)</span>
<span id="cb13-19">    output_file <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"text_image_gemini_25_openrouter_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>current_time<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">.png"</span></span>
<span id="cb13-20">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(output_file, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"wb"</span>) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> f:</span>
<span id="cb13-21">        f.write(image_bytes)</span>
<span id="cb13-22"></span>
<span id="cb13-23">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"✅ 图像已保存为 </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>output_file<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb13-24"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb13-25">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"❌ 响应中未返回图像"</span>)</span></code></pre></div></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> IPython.display <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Image, display</span>
<span id="cb14-2"></span>
<span id="cb14-3">display(Image(filename<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text_image_gemini_25_openrouter_1352.png"</span>))</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;IPython.core.display.Image object&gt;</code></pre>
</div>
</div>
</section>
<section id="图像转文字-image-to-text" class="level3">
<h3 class="anchored" data-anchor-id="图像转文字-image-to-text">7. 图像转文字 (Image to Text)</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> base64</span>
<span id="cb16-2"></span>
<span id="cb16-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 将本地图像转换为 data URL</span></span>
<span id="cb16-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text_image_gemini_25_openrouter_1352.png"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rb"</span>) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> image_file:</span>
<span id="cb16-5">    base64_image <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> base64.b64encode(image_file.read()).decode(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'utf-8'</span>)</span>
<span id="cb16-6">    data_url <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"data:image/png;base64,</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>base64_image<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb16-7"></span>
<span id="cb16-8">completion <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> client.chat.completions.create(</span>
<span id="cb16-9">  extra_headers<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{</span>
<span id="cb16-10">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"HTTP-Referer"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&lt;您的网站URL&gt;"</span>, <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 可选：OpenRouter 排名用的网站 URL</span></span>
<span id="cb16-11">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"X-Title"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&lt;您的网站名称&gt;"</span>, <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 可选：OpenRouter 排名用的网站名称</span></span>
<span id="cb16-12">  },</span>
<span id="cb16-13">  extra_body<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{},</span>
<span id="cb16-14">  model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"nvidia/nemotron-nano-12b-v2-vl:free"</span>,</span>
<span id="cb16-15">  messages<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[</span>
<span id="cb16-16">              {</span>
<span id="cb16-17">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"role"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"user"</span>,</span>
<span id="cb16-18">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"content"</span>: [</span>
<span id="cb16-19">                  {</span>
<span id="cb16-20">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text"</span>,</span>
<span id="cb16-21">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"这张图片里有什么？"</span></span>
<span id="cb16-22">                  },</span>
<span id="cb16-23">                  {</span>
<span id="cb16-24">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"image_url"</span>,</span>
<span id="cb16-25">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"image_url"</span>: {</span>
<span id="cb16-26">                      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"url"</span>: data_url</span>
<span id="cb16-27">                    }</span>
<span id="cb16-28">                  }</span>
<span id="cb16-29">                ]</span>
<span id="cb16-30">              }</span>
<span id="cb16-31">            ]</span>
<span id="cb16-32">)</span>
<span id="cb16-33"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(completion.choices[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].message.content)</span></code></pre></div></div>
</details>
</div>
</section>
<section id="文字与图像结合生成图像-text-image-to-image" class="level3">
<h3 class="anchored" data-anchor-id="文字与图像结合生成图像-text-image-to-image">8. 文字与图像结合生成图像 (Text &amp; Image to Image)</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># | eval: false</span></span>
<span id="cb17-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> base64</span>
<span id="cb17-3"></span>
<span id="cb17-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 将之前生成的图像转换为 base64</span></span>
<span id="cb17-5"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text_image_gemini_25_openrouter_1352.png"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rb"</span>) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> image_file:</span>
<span id="cb17-6">    base64_image <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> base64.b64encode(image_file.read()).decode(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"utf-8"</span>)</span>
<span id="cb17-7"></span>
<span id="cb17-8">response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> client.chat.completions.create(</span>
<span id="cb17-9">    extra_headers<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{</span>
<span id="cb17-10">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"HTTP-Referer"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"www.tonydotdev.com"</span>,</span>
<span id="cb17-11">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"X-Title"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"TT_AI_blog"</span>,</span>
<span id="cb17-12">    },</span>
<span id="cb17-13">    model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"google/gemini-2.5-flash-image"</span>,</span>
<span id="cb17-14">    messages<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[</span>
<span id="cb17-15">        {</span>
<span id="cb17-16">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"role"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"user"</span>,</span>
<span id="cb17-17">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"content"</span>: [</span>
<span id="cb17-18">                {</span>
<span id="cb17-19">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text"</span>,</span>
<span id="cb17-20">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"将这张图片转换为日落版本，使用更温暖的色彩和金色的光线。在前景中增加一个正在滑雪的人。"</span>,</span>
<span id="cb17-21">                },</span>
<span id="cb17-22">                {</span>
<span id="cb17-23">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"image_url"</span>,</span>
<span id="cb17-24">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"image_url"</span>: {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"url"</span>: <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"data:image/png;base64,</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>base64_image<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>},</span>
<span id="cb17-25">                },</span>
<span id="cb17-26">            ],</span>
<span id="cb17-27">        }</span>
<span id="cb17-28">    ],</span>
<span id="cb17-29">    modalities<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"image"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text"</span>],</span>
<span id="cb17-30">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># image_size="1024x1024",</span></span>
<span id="cb17-31">)</span></code></pre></div></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> base64</span>
<span id="cb18-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> datetime</span>
<span id="cb18-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 提取消息</span></span>
<span id="cb18-4">message <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> response.choices[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].message</span>
<span id="cb18-5"></span>
<span id="cb18-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 处理图像输出（base64 字符串位于 "data:image/png;base64,..." 中）</span></span>
<span id="cb18-7"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> message.images:</span>
<span id="cb18-8">    data_url <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> message.images[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"image_url"</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"url"</span>]</span>
<span id="cb18-9"></span>
<span id="cb18-10">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 如果存在前缀则将其剥离</span></span>
<span id="cb18-11">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> data_url.startswith(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data:image"</span>):</span>
<span id="cb18-12">        _, base64_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> data_url.split(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">","</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb18-13">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb18-14">        base64_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> data_url</span>
<span id="cb18-15"></span>
<span id="cb18-16">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 解码并保存为 PNG</span></span>
<span id="cb18-17">    image_bytes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> base64.b64decode(base64_data)</span>
<span id="cb18-18">    current_time <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> datetime.datetime.now().strftime(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"%H%M"</span>)</span>
<span id="cb18-19">    output_file <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"text_image_gemini_25_openrouter_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>current_time<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">.png"</span></span>
<span id="cb18-20">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(output_file, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"wb"</span>) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> f:</span>
<span id="cb18-21">        f.write(image_bytes)</span>
<span id="cb18-22"></span>
<span id="cb18-23">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"✅ 图像已保存为 </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>output_file<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb18-24"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb18-25">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"❌ 响应中未返回图像"</span>)</span></code></pre></div></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> IPython.display <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Image, display</span>
<span id="cb19-2"></span>
<span id="cb19-3">display(Image(filename<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text_image_gemini_25_openrouter_1405.png"</span>))</span></code></pre></div></div>
</details>
</div>
</section>
<section id="embedding" class="level3">
<h3 class="anchored" data-anchor-id="embedding">8 Embedding</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> OpenAI</span>
<span id="cb20-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## 8. 文本嵌入 (Embedding)</span></span></code></pre></div></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> OpenAI</span>
<span id="cb21-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb21-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv</span>
<span id="cb21-4"></span>
<span id="cb21-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 从 .env 文件加载环境变量</span></span>
<span id="cb21-6">load_dotenv()</span>
<span id="cb21-7"></span>
<span id="cb21-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 使用 OpenRouter 初始化 OpenAI 客户端</span></span>
<span id="cb21-9">client <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> OpenAI(</span>
<span id="cb21-10">    base_url<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://openrouter.ai/api/v1"</span>,</span>
<span id="cb21-11">    api_key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>os.getenv(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"OPENROUTER_API_KEY"</span>),</span>
<span id="cb21-12">)</span>
<span id="cb21-13"></span>
<span id="cb21-14"></span>
<span id="cb21-15">embedding <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> client.embeddings.create(</span>
<span id="cb21-16">  extra_headers<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{</span>
<span id="cb21-17">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"HTTP-Referer"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&lt;YOUR_SITE_URL&gt;"</span>, <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 可选：OpenRouter 排名用的网站 URL</span></span>
<span id="cb21-18">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"X-Title"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&lt;YOUR_SITE_NAME&gt;"</span>, <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 可选：OpenRouter 排名用的网站名称</span></span>
<span id="cb21-19">  },</span>
<span id="cb21-20">  model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"thenlper/gte-base"</span>,</span>
<span id="cb21-21">  <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"I can"</span>,</span>
<span id="cb21-22">  encoding_format<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"float"</span></span>
<span id="cb21-23">)</span>
<span id="cb21-24"></span>
<span id="cb21-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#print(embedding.data[0].embedding) </span></span></code></pre></div></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(embedding.data[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].embedding)</span></code></pre></div></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(embedding.data[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].embedding[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>])  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 打印前 5 个维度</span></span></code></pre></div></div>
</details>
</div>
</section>
</section>
<section id="成本管理优化您的-ai-支出" class="level2">
<h2 class="anchored" data-anchor-id="成本管理优化您的-ai-支出">成本管理：优化您的 AI 支出</h2>
<p>OpenRouter 最强大的功能之一是其透明的定价模型和成本管理能力。对于生产级 AI 应用来说，理解和管理成本至关重要。</p>
</section>
<section id="为什么成本管理很重要" class="level2">
<h2 class="anchored" data-anchor-id="为什么成本管理很重要">为什么成本管理很重要</h2>
<p><strong>💰 财务规划：</strong> - 可预测的每月支出 - 为不同用例分配预算 - AI 功能的 ROI 分析 - 每个用户的成本追踪</p>
<p><strong>🔍 技术优化：</strong> - 根据成本/性能比选择模型 - 提示词工程以减少 Token 使用 - 重复请求的缓存策略 - 提高效率的批量处理</p>
</section>
<section id="实时成本追踪" class="level2">
<h2 class="anchored" data-anchor-id="实时成本追踪">实时成本追踪</h2>
<p>OpenRouter 提供了通过编程方式访问所有模型当前定价的接口：</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 初始化 OpenAI 客户端（如果尚未完成）</span></span>
<span id="cb24-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> OpenAI</span>
<span id="cb24-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb24-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv</span>
<span id="cb24-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb24-6"></span>
<span id="cb24-7">load_dotenv()</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>True</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1">client <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> OpenAI(</span>
<span id="cb26-2">  base_url<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://openrouter.ai/api/v1"</span>,</span>
<span id="cb26-3">  api_key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>os.getenv(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"OPENROUTER_API_KEY"</span>),</span>
<span id="cb26-4">)</span>
<span id="cb26-5"></span>
<span id="cb26-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_model_pricing():</span>
<span id="cb26-7">    models_list <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> client.models.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>()</span>
<span id="cb26-8">    pricing_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb26-9"></span>
<span id="cb26-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> model <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> models_list.data:</span>
<span id="cb26-11">        name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">id</span></span>
<span id="cb26-12">        pricing <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.pricing</span>
<span id="cb26-13"></span>
<span id="cb26-14">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 获取模型元数据</span></span>
<span id="cb26-15">        context_length <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">getattr</span>(model, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'context_length'</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>)</span>
<span id="cb26-16">        description <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">getattr</span>(model, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'description'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span>)</span>
<span id="cb26-17"></span>
<span id="cb26-18">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 获取创建日期并转换为可读格式</span></span>
<span id="cb26-19">        created_timestamp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">getattr</span>(model, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'created'</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>)</span>
<span id="cb26-20">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> created_timestamp:</span>
<span id="cb26-21">            <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> datetime</span>
<span id="cb26-22">            created_date <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> datetime.datetime.fromtimestamp(created_timestamp).strftime(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'%Y-%m-</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%d</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb26-23">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb26-24">            created_date <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb26-25"></span>
<span id="cb26-26">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 从模型名称中提取公司（'/' 前的第一部分）</span></span>
<span id="cb26-27">        company <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> name.split(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'/'</span>)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'/'</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> name <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Unknown'</span></span>
<span id="cb26-28"></span>
<span id="cb26-29">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 将每个 Token 的价格转换为每 100 万个 Token 的成本</span></span>
<span id="cb26-30">        prompt_cost <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>(pricing.get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'prompt'</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000000</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> pricing <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> pricing.get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'prompt'</span>) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb26-31">        completion_cost <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>(pricing.get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'completion'</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000000</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> pricing <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> pricing.get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'completion'</span>) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb26-32">        request_cost <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>(pricing.get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'request'</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000000</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> pricing <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> pricing.get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'request'</span>) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb26-33">        image_cost <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>(pricing.get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'image'</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000000</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> pricing <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> pricing.get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'image'</span>) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb26-34"></span>
<span id="cb26-35">        pricing_data.append({</span>
<span id="cb26-36">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'模型'</span>: name,</span>
<span id="cb26-37">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'公司'</span>: company,</span>
<span id="cb26-38">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'描述'</span>: description,</span>
<span id="cb26-39">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'上下文长度'</span>: context_length,</span>
<span id="cb26-40">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'创建日期'</span>: created_date,</span>
<span id="cb26-41">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'提示词成本_每1M'</span>: prompt_cost,</span>
<span id="cb26-42">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'补全成本_每1M'</span>: completion_cost,</span>
<span id="cb26-43">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'请求成本_每1M'</span>: request_cost,</span>
<span id="cb26-44">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'图像成本_每1M'</span>: image_cost</span>
<span id="cb26-45">        })</span>
<span id="cb26-46"></span>
<span id="cb26-47">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 创建 Pandas DataFrame</span></span>
<span id="cb26-48">    df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.DataFrame(pricing_data)</span>
<span id="cb26-49"></span>
<span id="cb26-50">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 按公司、模型名称排序，方便整理</span></span>
<span id="cb26-51">    df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df.sort_values([<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'公司'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'模型'</span>]).reset_index(drop<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb26-52"></span>
<span id="cb26-53">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> df</span>
<span id="cb26-54"></span>
<span id="cb26-55"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 获取价格 DataFrame（全量模型以及仅付费模型）</span></span>
<span id="cb26-56">all_models_df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_model_pricing()</span></code></pre></div></div>
</details>
</div>
<section id="最昂贵的模型" class="level4">
<h4 class="anchored" data-anchor-id="最昂贵的模型">最昂贵的模型</h4>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> panel <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pn</span>
<span id="cb27-2"></span>
<span id="cb27-3"></span>
<span id="cb27-4">df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> all_models_df[</span>
<span id="cb27-5">    [</span>
<span id="cb27-6">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"模型"</span>,</span>
<span id="cb27-7">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"上下文长度"</span>,</span>
<span id="cb27-8">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"创建日期"</span>,</span>
<span id="cb27-9">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"提示词成本_每1M"</span>,</span>
<span id="cb27-10">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"补全成本_每1M"</span>,</span>
<span id="cb27-11">    ]</span>
<span id="cb27-12">].sort_values(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"提示词成本_每1M"</span>, ascending<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb27-13"></span>
<span id="cb27-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 创建一个带分页的表格</span></span>
<span id="cb27-15">pn.extension(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tabulator"</span>)</span>
<span id="cb27-16">table <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pn.widgets.Tabulator(df, pagination<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"local"</span>, page_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, show_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb27-17">table</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Tabulator(page_size=10, pagination='local', show_index=False, value=              ...)</code></pre>
</div>
</div>
</section>
</section>
<section id="最佳实践生产就绪的-ai-开发" class="level2">
<h2 class="anchored" data-anchor-id="最佳实践生产就绪的-ai-开发">最佳实践：生产就绪的 AI 开发</h2>
<p>遵循这些最佳实践将帮助您使用 OpenRouter 构建稳健、安全且高效的 AI 应用程序。</p>
</section>
<section id="安全最佳实践" class="level2">
<h2 class="anchored" data-anchor-id="安全最佳实践">🔒 安全最佳实践</h2>
<section id="api-密钥管理" class="level3">
<h3 class="anchored" data-anchor-id="api-密钥管理">1. API 密钥管理</h3>
<ul>
<li><strong>切勿硬编码 API 密钥</strong>在源代码或配置文件中</li>
<li><strong>使用环境变量</strong>或秘密管理系统（如 AWS Secrets Manager、Azure Key Vault）</li>
<li><strong>定期轮换 API 密钥</strong>并实施密钥轮换策略</li>
<li><strong>使用不同的密钥</strong>用于开发、测试和生产环境</li>
<li><strong>将 .env 添加到 .gitignore</strong> —— 永远不要将凭据提交到版本控制中</li>
</ul>
</section>
<section id="输入验证与清理" class="level3">
<h3 class="anchored" data-anchor-id="输入验证与清理">2. 输入验证与清理</h3>
<ul>
<li><strong>在发送到 AI 模型之前验证用户输入</strong></li>
<li><strong>清理提示词</strong>以防止提示词注入攻击</li>
<li><strong>实施速率限制</strong>以防止滥用</li>
<li><strong>记录并监控</strong>异常活动模式</li>
</ul>
</section>
</section>
<section id="性能最佳实践" class="level2">
<h2 class="anchored" data-anchor-id="性能最佳实践">⚡ 性能最佳实践</h2>
<section id="模型选择策略" class="level3">
<h3 class="anchored" data-anchor-id="模型选择策略">3. 模型选择策略</h3>
<ul>
<li><strong>为您的用例选择合适的模型</strong> —— 并非所有任务都需要最昂贵的模型</li>
<li><strong>针对您的特定用例进行模型基准测试</strong></li>
<li><strong>使用免费模型</strong>进行开发和测试</li>
<li><strong>考虑专用模型</strong>处理特定任务（编程、数学、创意写作）</li>
</ul>
</section>
<section id="优化技术" class="level3">
<h3 class="anchored" data-anchor-id="优化技术">4. 优化技术</h3>
<ul>
<li><strong>实施缓存</strong>以减少重复请求的成本</li>
<li><strong>使用流式传输</strong>以获得更好的用户体验</li>
<li><strong>在适当情况下进行批量请求</strong>以提高效率</li>
<li><strong>优化提示词</strong> —— 精心设计的提示词可以减少 Token 使用并改善结果</li>
</ul>
</section>
</section>
<section id="可靠性最佳实践" class="level2">
<h2 class="anchored" data-anchor-id="可靠性最佳实践">🛡️ 可靠性最佳实践</h2>
<section id="错误处理与容错" class="level3">
<h3 class="anchored" data-anchor-id="错误处理与容错">5. 错误处理与容错</h3>
<ul>
<li><strong>实施全面的错误处理</strong> —— 模型可能会不可用或受到速率限制</li>
<li><strong>使用备用模型</strong> —— 确保即使一个模型宕机，您的应用程序仍能正常运行</li>
<li><strong>实施带有指数退避的重试逻辑</strong></li>
<li><strong>监控响应时间</strong>并设置适当的超时</li>
</ul>
</section>
<section id="监控与分析" class="level3">
<h3 class="anchored" data-anchor-id="监控与分析">6. 监控与分析</h3>
<ul>
<li><strong>监控使用情况</strong> —— 追踪成本并设置限制</li>
<li><strong>追踪性能指标</strong>（延迟、成功率、错误率）</li>
<li><strong>为异常活动模式设置告警</strong></li>
<li><strong>创建实时监控仪表板</strong></li>
</ul>
</section>
</section>
<section id="成本管理最佳实践" class="level2">
<h2 class="anchored" data-anchor-id="成本管理最佳实践">📊 成本管理最佳实践</h2>
<section id="预算控制" class="level3">
<h3 class="anchored" data-anchor-id="预算控制">7. 预算控制</h3>
<ul>
<li><strong>在 OpenRouter 仪表板中设置支出限制</strong>和告警</li>
<li><strong>为非关键任务使用高性价比模型</strong></li>
<li><strong>实施 Token 计数</strong>以在请求前估算成本</li>
<li><strong>定期查看使用报告</strong>以识别优化机会</li>
</ul>
</section>
</section>
<section id="结论构建-ai-应用的未来" class="level2">
<h2 class="anchored" data-anchor-id="结论构建-ai-应用的未来">结论：构建 AI 应用的未来</h2>
<p>OpenRouter 代表了开发人员与 AI 模型交互方式的范式转变。通过提供访问世界上最先进 AI 模型的统一、可靠且极具成本效益的网关，OpenRouter 让开发人员能够专注于创造价值，而不是处理复杂的基础设施。</p>


<!-- -->

</section>
</section>

 ]]></description>
  <category>AI</category>
  <category>API</category>
  <category>tutorial</category>
  <guid>https://jcwinning.github.io/LandingPage/posts/openrouter/</guid>
  <pubDate>Fri, 31 Oct 2025 16:00:00 GMT</pubDate>
  <media:content url="https://jcwinning.github.io/LandingPage/posts/openrouter/images.png" medium="image" type="image/png" height="48" width="144"/>
</item>
</channel>
</rss>
