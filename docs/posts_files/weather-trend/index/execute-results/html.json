{
  "hash": "8440d607c566ec70ca3ad5993b1b5117",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: \"ç»“åˆ AI é¢„æµ‹çš„ Streamlit å¤©æ°”é¢„æŠ¥åº”ç”¨\"\nauthor: \"Tony D\"\ndate: \"2025-11-06\"\ncategories: [Python, Streamlit, AI, tutorial]\nimage: \"images/0.png\"\n\nformat:\n  html:\n    code-fold: true\n    code-tools: true\n    code-copy: true\n\nexecute:\n  eval: false\n  warning: false\n---\n\n\n# é¡¹ç›®æ¦‚è§ˆ\n\nåœ¨è¿™ä¸€è¯¦å°½çš„æ•™ç¨‹ä¸­ï¼Œæˆ‘å°†æŒ‡å¯¼æ‚¨åˆ›å»ºä¸€ä¸ªç²¾è‡´çš„å¤©æ°”é¢„æŠ¥åº”ç”¨ç¨‹åºï¼Œè¯¥åº”ç”¨å°†ç°ä»£ Web å¼€å‘ä¸äººå·¥æ™ºèƒ½ç›¸ç»“åˆã€‚æœ¬é¡¹ç›®æ¼”ç¤ºäº†å¦‚ä½•æ„å»ºä¸€ä¸ªå…·å¤‡äº¤äº’å¼åœ°å›¾ã€åŒè¯­æ”¯æŒã€å®æ—¶æ•°æ®å¯è§†åŒ–å’Œ AI é©±åŠ¨çš„å¤©æ°”åˆ†æåŠŸèƒ½çš„ç”Ÿäº§çº§å¤©æ°”åº”ç”¨ã€‚\n\n\nåœ¨çº¿æ¼”ç¤º: [https://weather-trend.streamlit.app/](https://weather-trend.streamlit.app/)\n\nGithub: [https://github.com/JCwinning/weather_trend](https://github.com/JCwinning/weather_trend)\n\n\n![å¤©æ°”é¢„æŠ¥åº”ç”¨ä¸»ç•Œé¢](images/0.png){width=\"100%\"}\n\n\n\nè¿™æ¬¾å¤©æ°”é¢„æŠ¥åº”ç”¨ä¸ä»…ä»…æä¾›åŸºç¡€çš„å¤©æ°”æ•°æ®ï¼Œè¿˜é›†æˆäº†å¤šé¡¹é«˜çº§åŠŸèƒ½ï¼š\n\n- **äº¤äº’å¼ä½ç½®é€‰æ‹©**ï¼šç‚¹å‡»åœ°å›¾ä¸Šçš„ä»»æ„ä½ç½®æˆ–é€šè¿‡åŸå¸‚åç§°æœç´¢\n- **åŒè¯­ç•Œé¢**ï¼šå®Œæ•´çš„è‹±æ–‡/ä¸­æ–‡è¯­è¨€æ”¯æŒåŠåˆ‡æ¢åŠŸèƒ½\n- **AI é©±åŠ¨çš„åˆ†æ**ï¼šä½¿ç”¨ DeepSeek AI æä¾›å¤©æ°”åˆ†æå’Œå»ºè®®\n- **é«˜çº§å¯è§†åŒ–**ï¼šæ¸©åº¦è¶‹åŠ¿ã€ç©ºæ°”è´¨é‡ç›‘æµ‹å’Œé™é›¨æ¦‚ç‡\n- **å®æ—¶æ•°æ®**ï¼š7 å¤©å†å²æ•°æ®å’Œ 5 å¤©é¢„æŠ¥æ•°æ®\n- **å“åº”å¼è®¾è®¡**ï¼šåœ¨æ¡Œé¢ã€å¹³æ¿å’Œç§»åŠ¨è®¾å¤‡ä¸Šè¿è¡Œæ— é˜»\n\n## æŠ€æœ¯æ¶æ„\n\n```{mermaid}\n%%| fig-cap: \"å¤©æ°”åº”ç”¨æ¶æ„\"\n%%| eval: true\nflowchart TD\n    A[ç”¨æˆ·ç•Œé¢<br/>Streamlit Web åº”ç”¨] --> B[ä½ç½®æœåŠ¡]\n    A --> C[å¤©æ°”æ•°æ® API]\n    A --> D[AI é›†æˆå±‚]\n    A --> E[å¯è§†åŒ–å¼•æ“]\n\n    B --> F[äº¤äº’å¼åœ°å›¾<br/>Folium + OpenStreetMap]\n    B --> G[åŸå¸‚æœç´¢<br/>Nominatim åœ°ç†ç¼–ç ]\n\n    C --> H[Open-Meteo API<br/>å¤©æ°” + ç©ºæ°”è´¨é‡]\n    C --> I[æ•°æ®å¤„ç†<br/>Pandas DataFrame]\n\n    D --> J[ModelScope API<br/>DeepSeek-V3.2 AI]\n    D --> K[æ™ºèƒ½åˆ†æ<br/>å¤©æ°”å»ºè®®]\n\n    E --> L[Altair å›¾è¡¨<br/>æ¸©åº¦è¶‹åŠ¿]\n    E --> M[æ•°æ®è¡¨æ ¼<br/>å¤©æ°”è¯¦æƒ…]\n\n    F --> A\n    G --> A\n    I --> E\n    K --> A\n```\n\n### æŠ€æœ¯æ ˆ\n\n- **å‰ç«¯æ¡†æ¶**ï¼šStreamlitï¼Œç”¨äºå¿«é€Ÿå¼€å‘ Web åº”ç”¨ç¨‹åº\n- **åœ°å›¾**ï¼šFolium é…åˆ OpenStreetMap å›¾å±‚ï¼Œå®ç°äº¤äº’å¼ä½ç½®é€‰æ‹©\n- **æ•°æ®å¯è§†åŒ–**ï¼šAltairï¼Œç”¨äºä¸“ä¸šçš„å›¾è¡¨å’Œå›¾å½¢\n- **API é›†æˆ**ï¼šOpen-Meteoï¼Œè·å–å¤©æ°”å’Œç©ºæ°”è´¨é‡æ•°æ®\n- **AI æœåŠ¡**ï¼šé€šè¿‡ ModelScope API ä½¿ç”¨ DeepSeek-V3.2 è¿›è¡Œæ™ºèƒ½åˆ†æ\n- **åœ°ç†ç¼–ç **ï¼šNominatimï¼Œç”¨äºåœ°å€ä¸åæ ‡çš„è½¬æ¢\n- **å›½é™…åŒ–**ï¼šè‡ªå®šä¹‰è¯­è¨€ç³»ç»Ÿï¼Œæ”¯æŒä¸­è‹±æ–‡åˆ‡æ¢\n\n## å¿«é€Ÿä¸Šæ‰‹\n\n### ç¯å¢ƒè¦æ±‚ä¸å®‰è£…\n\nåœ¨æ·±å…¥ä»£ç ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆæ­å»ºå¥½å¼€å‘ç¯å¢ƒï¼š\n\n```bash\n# 1. å…‹éš†ä»“åº“\ngit clone <your-repo-url>\ncd weather_trend\n\n# 2. å®‰è£…æ‰€éœ€è½¯ä»¶åŒ…\npip install streamlit pandas requests altair folium streamlit-folium geopy python-dotenv openai\n\n# 3. ä¸º AI åŠŸèƒ½è®¾ç½®ç¯å¢ƒå˜é‡\necho \"modelscope=æ‚¨çš„ API å¯†é’¥\" > .env\n```\n\n### æ ¸å¿ƒä¾èµ–é¡¹è¯´æ˜\n\n- **streamlit**ï¼šå…·å¤‡å“åº”å¼ UI ç»„ä»¶çš„ Web åº”ç”¨æ¡†æ¶\n- **pandas**ï¼šç”¨äºå¤©æ°”æ•°æ®é›†çš„æ•°æ®æ“ä½œå’Œåˆ†æ\n- **requests**ï¼šç”¨äº API é€šä¿¡çš„ HTTP å®¢æˆ·ç«¯\n- **altair**ï¼šå£°æ˜å¼ç»Ÿè®¡å¯è§†åŒ–åº“\n- **folium + streamlit-folium**ï¼šäº¤äº’å¼åœ°å›¾é›†æˆ\n- **geopy**ï¼šç”¨äºä½ç½®æŸ¥æ‰¾çš„åœ°ç†ç¼–ç æœåŠ¡\n- **python-dotenv**ï¼šç¯å¢ƒå˜é‡ç®¡ç†\n- **openai**ï¼šAI æ¨¡å‹é›†æˆï¼ˆä¸ ModelScope å…¼å®¹ï¼‰\n\n## æ ¸å¿ƒåŠŸèƒ½å®ç°\n\n### 1. å¸¦ä½ç½®é€‰æ‹©çš„äº¤äº’å¼åœ°å›¾\n\nåœ°å›¾åŠŸèƒ½å…è®¸ç”¨æˆ·ç‚¹å‡»ä»»æ„ä½ç½®å¹¶è·å–è¯¥åœ°ç‚¹çš„å®æ—¶å¤©æ°”æ•°æ®ï¼š\n\n::: {#c34f4570 .cell execution_count=1}\n``` {.python .cell-code}\nimport folium\nfrom streamlit_folium import st_folium\n\n# åˆ›å»ºä»¥é»˜è®¤ä½ç½®ä¸ºä¸­å¿ƒçš„äº¤äº’å¼åœ°å›¾\ndef create_interactive_map(lat=40.7128, lon=-74.0060, zoom=10):\n    \"\"\"åˆ›å»ºäº¤äº’å¼ Folium åœ°å›¾\"\"\"\n    m = folium.Map(\n        location=[lat, lon],\n        zoom_start=zoom,\n        tiles=\"OpenStreetMap\"\n    )\n\n    # æ·»åŠ ç‚¹å‡»äº‹ä»¶å¤„ç†å™¨ä»¥æ•è·åæ ‡\n    m.add_child(folium.LatLngPopup())\n\n    return m\n\n# åœ¨ Streamlit ä¸­æ˜¾ç¤ºåœ°å›¾\nif 'map_data' not in st.session_state:\n    st.session_state.map_data = None\n\nmap_object = create_interactive_map()\nst_data = st_folium(map_object, width=700, height=500)\n\n# æ•è·ç‚¹å‡»å¤„çš„åæ ‡\nif st_data['last_clicked']:\n    lat = st_data['last_clicked']['lat']\n    lon = st_data['last_clicked']['lng']\n    st.session_state.clicked_location = (lat, lon)\n    get_weather_for_coordinates(lat, lon)\n```\n:::\n\n\n**å…³é”®ç‰¹æ€§ï¼š**\n- **ç‚¹å‡»é€‰æ‹©**ï¼šç”¨æˆ·å¯ä»¥ç‚¹å‡»åœ°å›¾ä¸Šçš„ä»»ä½•åœ°æ–¹\n- **ç¼©æ”¾æ§åˆ¶**ï¼šæ ‡å‡†çš„åœ°å›¾å¯¼èˆªåŠŸèƒ½\n- **å“åº”å¼è®¾è®¡**ï¼šé€‚åº”ä¸åŒçš„å±å¹•å°ºå¯¸\n- **åæ ‡æ•è·**ï¼šè‡ªåŠ¨æå–æ‰€é€‰ä½ç½®çš„ä¿¡æ¯\n\n### 2. åŒè¯­åŸå¸‚æœç´¢ç³»ç»Ÿ\n\næ­¤åº”ç”¨æ”¯æŒä¸­è‹±æ–‡åŸå¸‚åç§°ï¼Œå¹¶å…·å¤‡æ™ºèƒ½çš„å›é€€æœºåˆ¶ï¼š\n\n::: {#7351a659 .cell execution_count=2}\n``` {.python .cell-code}\nimport re\nfrom geopy.geocoders import Nominatim\n\n# æ‰©å±•çš„ä¸­æ–‡å­—ç¬¦æ£€æµ‹\ndef contains_chinese(text):\n    \"\"\"æ£€æŸ¥æ–‡æœ¬æ˜¯å¦åŒ…å«ä¸­æ–‡å­—ç¬¦ï¼ŒåŒ…æ‹¬ CJK ç»Ÿä¸€æ±‰å­—\"\"\"\n    chinese_pattern = re.compile(\n        r\"[\\u4e00-\\u9fff\\u3400-\\u4dbf\\U00020000-\\U0002a6df\\U0002a700-\\U0002b73f]\"\n    )\n    return bool(chinese_pattern.search(text))\n\n# ä¸­æ–‡åŸå¸‚æ˜ å°„ï¼Œä»¥è·å¾—æ›´å¥½çš„è§£ææ•ˆæœ\nCHINESE_CITY_MAPPING = {\n    \"çº½çº¦\": \"New York\",\n    \"ä¸œäº¬\": \"Tokyo\",\n    \"ä¼¦æ•¦\": \"London\",\n    \"å·´é»\": \"Paris\",\n    \"æ´›æ‰çŸ¶\": \"Los Angeles\",\n    # ... æ›´å¤šæ˜ å°„\n}\n\ndef get_coordinates_for_city(city_name):\n    \"\"\"è·å–åŸå¸‚åæ ‡ï¼Œæ”¯æŒå¤šè¯­è¨€\"\"\"\n    # æ£€æŸ¥ä¸­æ–‡åŸå¸‚åç§°æ˜ å°„\n    if contains_chinese(city_name) and city_name in CHINESE_CITY_MAPPING:\n        city_name = CHINESE_CITY_MAPPING[city_name]\n\n    # å¯¹åŸå¸‚è¿›è¡Œåœ°ç†ç¼–ç \n    geolocator = Nominatim(user_agent=\"weather_app\")\n    try:\n        location = geolocator.geocode(city_name)\n        return (location.latitude, location.longitude) if location else None\n    except:\n        return None\n```\n:::\n\n\n**åŒè¯­ç‰¹æ€§ï¼š**\n- **ä¸­æ–‡å­—ç¬¦æ£€æµ‹**ï¼šé’ˆå¯¹ CJK å­—ç¬¦çš„é«˜çº§æ­£åˆ™æ¨¡å¼\n- **åŸå¸‚åç§°æ˜ å°„**ï¼šä¸»è¦åŸå¸‚çš„ç¿»è¯‘æ•°æ®åº“\n- **é”™è¯¯å¤„ç†**ï¼šå½“åœ°ç†ç¼–ç å¤±è´¥æ—¶ä¿æŒç³»ç»Ÿç¨³å®š\n- **Unicode æ”¯æŒ**ï¼šå®Œæ•´æ”¯æŒå›½é™…åŒ–å­—ç¬¦\n\n### 3. å¤©æ°”æ•°æ®é›†æˆ\n\nè¯¥åº”ç”¨ç¨‹åºä» Open-Meteo API è·å–å…¨é¢çš„å¤©æ°”æ•°æ®ï¼š\n\n::: {#b210aad4 .cell execution_count=3}\n``` {.python .cell-code}\nimport requests\nimport pandas as pd\n\ndef get_weather_data(latitude, longitude):\n    \"\"\"è·å– 12 å¤©çš„å¤©æ°”æ•°æ®ï¼ˆ7 å¤©å†å² + 5 å¤©é¢„æŠ¥ï¼‰\"\"\"\n\n    # API ç«¯ç‚¹é…ç½®\n    url = \"https://api.open-meteo.com/v1/forecast\"\n    params = {\n        'latitude': latitude,\n        'longitude': longitude,\n        'daily': [\n            'temperature_2m_max', 'temperature_2m_min', 'temperature_2m_mean',\n            'weathercode', 'windspeed_10m_max', 'precipitation_probability_max',\n            'pm10', 'pm2_5'\n        ],\n        'timezone': 'auto',\n        'past_days': 7,  # è·å–å†å²æ•°æ®\n        'forecast_days': 5  # è·å–æœªæ¥é¢„æŠ¥\n    }\n\n    try:\n        response = requests.get(url, params=params, timeout=10)\n        response.raise_for_status()\n\n        # å¤„ç†å“åº”æ•°æ®\n        data = response.json()\n        df = process_weather_data(data)\n\n        return df\n\n    except requests.RequestException as e:\n        st.error(f\"API è¯·æ±‚å¤±è´¥: {e}\")\n        return None\n\ndef process_weather_data(data):\n    \"\"\"å°† API å“åº”è½¬æ¢ä¸ºç»“æ„åŒ– DataFrame\"\"\"\n    daily_data = data['daily']\n\n    # åˆ›å»ºæ—¥æœŸèŒƒå›´ï¼ˆå†å² + æœªæ¥ï¼‰\n    dates = pd.date_range(\n        start=pd.to_datetime(daily_data['time'][0]),\n        periods=len(daily_data['time']),\n        freq='D'\n    )\n\n    # æ„å»º DataFrame\n    df = pd.DataFrame({\n        'date': dates,\n        'temperature_max': daily_data['temperature_2m_max'],\n        'temperature_min': daily_data['temperature_2m_min'],\n        'temperature_mean': daily_data['temperature_2m_mean'],\n        'weather_code': daily_data['weathercode'],\n        'wind_speed_max': daily_data['windspeed_10m_max'],\n        'rain_probability': daily_data['precipitation_probability_max'],\n        'pm2_5': daily_data.get('pm2_5', [0] * len(dates))\n    })\n\n    # æ·»åŠ è¡ç”Ÿåˆ—\n    df['is_today'] = df['date'].dt.date == pd.Timestamp.now().date()\n    df['is_future'] = df['date'] > pd.Timestamp.now()\n\n    return df\n```\n:::\n\n\n**æ•°æ®å¤„ç†ç‰¹æ€§ï¼š**\n- **å†å² + é¢„æŠ¥**ï¼š7 å¤©è¿‡å» + 5 å¤©æœªæ¥\n- **ç©ºæ°”è´¨é‡é›†æˆ**ï¼šPM2.5 å’Œ PM10 æ•°æ®\n- **æŒ‡æ ‡è¡ç”Ÿ**ï¼šä»Šæ—¥æ£€æµ‹å’Œæœªæ¥è¶‹åŠ¿åˆ†æ\n- **é”™è¯¯ç®¡ç†**ï¼šå¥å£®çš„ API é”™è¯¯å¤„ç†æœºåˆ¶\n\n### 4. é«˜çº§æ•°æ®å¯è§†åŒ–\n\næ¸©åº¦è¶‹åŠ¿å›¾ï¼Œæ¸…æ™°åœ°åŒºåˆ†äº†å†å²æ•°æ®å’Œé¢„æŠ¥æ•°æ®ï¼š\n\n::: {#21a467a5 .cell execution_count=4}\n``` {.python .cell-code}\nimport altair as alt\n\ndef create_temperature_chart(weather_df):\n    \"\"\"åˆ›å»ºäº¤äº’å¼æ¸©åº¦è¶‹åŠ¿å›¾\"\"\"\n\n    # åŒ…å«æ¸©åº¦çº¿çš„åŸºå‡†å›¾è¡¨\n    base_chart = alt.Chart(weather_df).mark_line(\n        point=True,\n        strokeWidth=3,\n        opacity=0.8\n    ).encode(\n        x=alt.X('date:T', title='æ—¥æœŸ'),\n        y=alt.Y('temperature_mean:Q', title='æ¸©åº¦ (Â°C)', scale=alt.Scale(domain=[weather_df['temperature_min'].min()-5, weather_df['temperature_max'].max()+5]))\n    ).properties(\n        width=800,\n        height=400,\n        title='æ¸©åº¦è¶‹åŠ¿å›¾'\n    )\n\n    # å†å²æ•°æ®ï¼ˆå®çº¿ï¼‰\n    historical_data = weather_df[weather_df['is_future'] == False]\n    historical_line = base_chart.transform_filter(\n        'datum.is_future == false'\n    ).encode(\n        color=alt.value('blue'),\n        strokeDash=alt.value([0])  # å®çº¿\n    )\n\n    # æœªæ¥é¢„æŠ¥ï¼ˆè™šçº¿ï¼‰\n    future_data = weather_df[weather_df['is_future'] == True]\n    future_line = base_chart.transform_filter(\n        'datum.is_future == true'\n    ).encode(\n        color=alt.value('red'),\n        strokeDash=alt.value([5, 5])  # è™šçº¿\n    )\n\n    # ä»Šæ—¥æŒ‡ç¤ºçº¿\n    today_line = alt.Chart(pd.DataFrame({'x': [pd.Timestamp.now()]})).mark_rule(\n        strokeDash=[2, 2],\n        stroke='green',\n        strokeWidth=2\n    ).encode(x='x:T')\n\n    return (historical_line + future_line + today_line).resolve_scale(color='independent')\n```\n:::\n\n\n**å¯è§†åŒ–ç‰¹æ€§ï¼š**\n- **çº¿æ¡æ ·å¼åŒºåˆ†**ï¼šå®çº¿ï¼ˆå†å²ï¼‰å¯¹æ¯”è™šçº¿ï¼ˆé¢„æŠ¥ï¼‰\n- **ä»Šæ—¥æŒ‡ç¤ºå™¨**ï¼šå¯¹å½“å‰æ—¥æœŸçš„è§†è§‰æ ‡è®°\n- **é¢œè‰²ç¼–ç **ï¼šè“è‰²ä»£è¡¨è¿‡å»ï¼Œçº¢è‰²ä»£è¡¨æœªæ¥\n- **äº¤äº’å¼æç¤º**ï¼šæ‚¬åœæ—¶æ˜¾ç¤ºæ•°æ®ç‚¹ä¿¡æ¯\n\n### 5. ç©ºæ°”è´¨é‡ç›‘æµ‹\n\nç¬¦åˆ EPA æ ‡å‡†çš„ PM2.5 æ°´å¹³é¢œè‰²ç¼–ç ï¼š\n\n::: {#1936eb5a .cell execution_count=5}\n``` {.python .cell-code}\ndef get_air_quality_level(pm25_value):\n    \"\"\"åŸºäºç¾å›½ EPA PM2.5 æ ‡å‡†è·å–ç©ºæ°”è´¨é‡ç­‰çº§\"\"\"\n\n    if pm25_value <= 12:\n        return {\n            'level': 'ä¼˜',\n            'color': '#00e400',  # æ·±ç»¿\n            'text_color': 'white',\n            'icon': 'ğŸŸ¢'\n        }\n    elif pm25_value <= 35.4:\n        return {\n            'level': 'è‰¯',\n            'color': '#ffff00',  # æµ…é»„\n            'text_color': 'black',\n            'icon': 'ğŸŸ¢'\n        }\n    elif pm25_value <= 55.4:\n        return {\n            'level': 'è½»åº¦æ±¡æŸ“',\n            'color': '#ff7e00',  # æ©™é»„\n            'text_color': 'black',\n            'icon': 'ğŸŸ¡'\n        }\n    elif pm25_value <= 150.4:\n        return {\n            'level': 'ä¸­åº¦æ±¡æŸ“',\n            'color': '#ff0000',  # çº¢è‰²\n            'text_color': 'white',\n            'icon': 'ğŸŸ '\n        }\n    elif pm25_value <= 250.4:\n        return {\n            'level': 'é‡åº¦æ±¡æŸ“',\n            'color': '#8f3f97',  # ç´«è‰²\n            'text_color': 'white',\n            'icon': 'ğŸ”´'\n        }\n    else:\n        return {\n            'level': 'ä¸¥é‡æ±¡æŸ“',\n            'color': '#7e0023',  # æ·±è¤\n            'text_color': 'white',\n            'icon': 'âš«'\n        }\n\ndef display_air_quality_badge(pm25_value):\n    \"\"\"æ˜¾ç¤ºå¸¦è§†è§‰æŒ‡ç¤ºçš„ç©ºæ°”è´¨é‡å¾½ç« \"\"\"\n    aq_info = get_air_quality_level(pm25_value)\n\n    st.markdown(f\"\"\"\n    <div style=\"background-color: {aq_info['color']}; color: {aq_info['text_color']};\n                padding: 10px; border-radius: 5px; text-align: center; margin: 5px 0;\">\n        <strong>{aq_info['icon']} PM2.5: {pm25_value} Î¼g/mÂ³</strong><br>\n        <small>{aq_info['level']}</small>\n    </div>\n    \"\"\", unsafe_allow_html=True)\n```\n:::\n\n\n**ç©ºæ°”è´¨é‡åŠŸèƒ½ç‰¹æ€§ï¼š**\n- **EPA æ ‡å‡†**ï¼šåŸºäºç¾å›½ç¯å¢ƒä¿æŠ¤ç½²çš„æ ‡å‡†\n- **è§†è§‰æŒ‡ç¤ºå™¨**ï¼šå¸¦å›¾æ ‡çš„é¢œè‰²ç¼–ç å¾½ç« \n- **å¯è®¿é—®æ€§**ï¼šé«˜å¯¹æ¯”åº¦è‰²å€¼ç¡®ä¿å¯è¯»æ€§\n- **ç§‘æ™®æ€§**ï¼šé€šè¿‡ç­‰çº§è¯´æ˜å¸®åŠ©ç”¨æˆ·ç†è§£\n\n## AI é©±åŠ¨çš„å¤©æ°”æ™ºèƒ½\n\n### é›†æˆ DeepSeek AI\n\næœ¬é¡¹ç›®æœ€å…·åˆ›æ–°æ€§çš„åŠŸèƒ½æ˜¯ä½¿ç”¨ ModelScope å¹³å°ä¸Šçš„ DeepSeek-V3.2 æ¨¡å‹æä¾› AI å¤©æ°”åˆ†æï¼š\n\n![AI å¤©æ°”åˆ†æå»ºè®®](images/1.png){width=\"100%\"}\n\n::: {#bdfefd0e .cell execution_count=6}\n``` {.python .cell-code}\nfrom openai import OpenAI\nimport os\n\n# åˆå§‹åŒ– ModelScope çš„ AI å®¢æˆ·ç«¯\ndef init_ai_client():\n    \"\"\"åˆå§‹åŒ–ç”¨äº ModelScope API çš„ OpenAI å®¢æˆ·ç«¯\"\"\"\n    return OpenAI(\n        base_url=\"https://dashscope.aliyuncs.com/compatible-mode/v1\",\n        api_key=os.getenv(\"modelscope\"),\n    )\n\ndef generate_weather_insights(weather_df, location_name, language=\"en\"):\n    \"\"\"ç”Ÿæˆ AI é©±åŠ¨çš„å¤©æ°”åˆ†æå»ºè®®\"\"\"\n\n    # å‡†å¤‡ç”¨äº AI åˆ†æçš„å¤©æ°”æ•°æ®\n    today_index = weather_df[weather_df['is_today']].index[0] if any(weather_df['is_today']) else 0\n    historical_data = weather_df.iloc[:today_index+1]  # æˆªè‡³ä»Šæ—¥\n    future_data = weather_df.iloc[today_index:]  # ä»Šæ—¥èµ·\n\n    # ä¸º AI åˆ›å»ºå¤©æ°”æ‘˜è¦\n    weather_summary = f\"\"\"\n    åœ°ç‚¹: {location_name}\n\n    å†å²å¤©æ°” (è¿‡å» {len(historical_data)} å¤©):\n    - æ¸©åº¦èŒƒå›´: {historical_data['temperature_min'].min():.1f}Â°C åˆ° {historical_data['temperature_max'].max():.1f}Â°C\n    - å¹³å‡æ¸©åº¦: {historical_data['temperature_mean'].mean():.1f}Â°C\n    - ç©ºæ°”è´¨é‡èŒƒå›´: {historical_data['pm2_5'].min():.1f} åˆ° {historical_data['pm2_5'].max():.1f} PM2.5\n\n    å¤©æ°”é¢„æŠ¥ (æœªæ¥ {len(future_data)} å¤©):\n    - æ¸©åº¦èŒƒå›´: {future_data['temperature_min'].min():.1f}Â°C åˆ° {future_data['temperature_max'].max():.1f}Â°C\n    - å¹³å‡é™é›¨æ¦‚ç‡: {future_data['rain_probability'].mean():.0f}%\n    \"\"\"\n\n    # æ ¹æ®è¯­è¨€ç”Ÿæˆæç¤ºè¯\n    if language == \"zh\":\n        prompt = f\"\"\"\n        åŸºäºä»¥ä¸‹å¤©æ°”æ•°æ®ï¼Œè¯·æä¾›ç®€æ´å®ç”¨çš„å¤©æ°”å»ºè®®ï¼ˆ100-200å­—ï¼‰ï¼š\n\n        {weather_summary}\n\n        è¯·åŒ…æ‹¬ï¼š\n        1. å¤©æ°”æ¨¡å¼åˆ†æ\n        2. ç©¿è¡£å»ºè®®\n        3. æˆ·å¤–æ´»åŠ¨å»ºè®®\n        4. å¥åº·æ³¨æ„äº‹é¡¹ï¼ˆå¦‚ç©ºæ°”è´¨é‡ç›¸å…³ï¼‰\n\n        è¯·ç”¨ä¸­æ–‡å›å¤ï¼Œè¯­æ°”å‹å¥½å®ç”¨ã€‚\n        \"\"\"\n    else:\n        prompt = f\"\"\"\n        Based on the following weather data, please provide concise and practical weather advice (100-200 words):\n\n        {weather_summary}\n\n        Please include:\n        1. Weather pattern analysis\n        2. Clothing recommendations\n        3. Outdoor activity suggestions\n        4. Health considerations (related to air quality if applicable)\n\n        Please respond in {language} with a friendly and practical tone.\n        \"\"\"\n\n    try:\n        client = init_ai_client()\n        response = client.chat.completions.create(\n            model=\"deepseek-ai/DeepSeek-V3\",\n            messages=[{\"role\": \"user\", \"content\": prompt}],\n            max_tokens=300,\n            temperature=0.7\n        )\n\n        return response.choices[0].message.content\n\n    except Exception as e:\n        return f\"AI æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ã€‚é”™è¯¯ä¿¡æ¯: {str(e)}\"\n\n# åœ¨ Streamlit åº”ç”¨ä¸­\nif st.button(get_text(\"ai_button\", language)):\n    with st.spinner(\"æ­£åœ¨è·å– AI å¤©æ°”å»ºè®®...\"):\n        if 'weather_df' in st.session_state and 'location_name' in st.session_state:\n            ai_insights = generate_weather_insights(\n                st.session_state.weather_df,\n                st.session_state.location_name,\n                language\n            )\n            st.markdown(\"### ğŸ¤– AI å¤©æ°”åˆ†æ\")\n            st.write(ai_insights)\n        else:\n            st.warning(\"è¯·å…ˆè·å–å¤©æ°”æ•°æ®ã€‚\")\n```\n:::\n\n\n**AI ç‰¹æ€§ï¼š**\n- **ä¸Šä¸‹æ–‡æ„ŸçŸ¥åˆ†æ**ï¼šåŒæ—¶å¤„ç†å†å²å’Œé¢„æŠ¥æ•°æ®\n- **å¤šè¯­è¨€æ”¯æŒ**ï¼šAI æ ¹æ®ç”¨æˆ·é€‰æ‹©çš„è¯­è¨€å›å¤\n- **å®ç”¨å»ºè®®**ï¼šæä¾›ç©¿è¡£ã€æ´»åŠ¨å’Œå¥åº·æ–¹é¢çš„è§è§£\n- **å®¹é”™å¤„ç†**ï¼šåœ¨ AI æœåŠ¡ä¸å¯ç”¨æ—¶ä¼˜é›…åœ°æç¤º\n\n### AI æç¤ºè¯å·¥ç¨‹\n\nAI ç³»ç»Ÿé€šè¿‡ç²¾å¿ƒè®¾è®¡çš„æç¤ºè¯ç”Ÿæˆæœ‰ä»·å€¼çš„è§è§£ï¼š\n\n**æç¤ºè¯ç»“æ„ï¼š**\n1. **æ•°æ®ä¸Šä¸‹æ–‡**ï¼šå…¨é¢çš„å¤©æ°”ç»Ÿè®¡ä¿¡æ¯\n2. **ä»»åŠ¡å®šä¹‰**ï¼šæ˜ç¡®çš„åˆ†æè¦æ±‚\n3. **è¾“å‡ºæ ¼å¼**ï¼šç»“æ„åŒ–çš„å›å¤ç±»åˆ«\n4. **è¯­è¨€é€‚é…**ï¼šä¸ UI è¯­è¨€ä¿æŒä¸€è‡´\n\n**å»ºè®®ç±»åˆ«ï¼š**\n- **å¤©æ°”æ¨¡å¼åˆ†æ**ï¼šè¶‹åŠ¿å’Œå¼‚å¸¸åˆ†æ\n- **ç©¿è¡£å»ºè®®**ï¼šå®ç”¨çš„ç©¿ç€æŒ‡å¯¼\n- **æ´»åŠ¨å»ºè®®**ï¼šæˆ·å¤–è®¡åˆ’çš„æ¨è\n- **å¥åº·æ³¨æ„äº‹é¡¹**ï¼šç©ºæ°”è´¨é‡åŠå¤©æ°”å½±å“\n\n## å›½é™…åŒ–ç³»ç»Ÿ\n\n### è¯­è¨€ç®¡ç†æ¶æ„\n\nåº”ç”¨å®ç°äº†ä¸€ä¸ªå…¨é¢çš„åŒè¯­ç³»ç»Ÿï¼š\n\n::: {#7ba005a3 .cell execution_count=7}\n``` {.python .cell-code}\n# language.py - ç¿»è¯‘ç®¡ç†\nTRANSLATIONS = {\n    \"en\": {\n        \"app_title\": \"Weather Forecast App\",\n        \"sidebar_header\": \"Weather Query\",\n        \"city_input_placeholder\": \"Enter a city name\",\n        \"get_weather_button\": \"Get Weather\",\n        \"weather_trends_title\": \"Weather Trends for\",\n        \"ai_button\": \"AI Weather Advice\",\n        # ... æ›´å¤šç¿»è¯‘\n    },\n    \"zh\": {\n        \"app_title\": \"å¤©æ°”é¢„æŠ¥åº”ç”¨\",\n        \"sidebar_header\": \"å¤©æ°”æŸ¥è¯¢\",\n        \"city_input_placeholder\": \"è¾“å…¥åŸå¸‚åç§°\",\n        \"get_weather_button\": \"è·å–å¤©æ°”\",\n        \"weather_trends_title\": \"å¤©æ°”è¶‹åŠ¿\",\n        \"ai_button\": \"AIå¤©æ°”å»ºè®®\",\n        # ... æ›´å¤šç¿»è¯‘\n    }\n}\n\ndef get_text(key, language=\"en\"):\n    \"\"\"è·å–æŒ‡å®šé”®å’Œè¯­è¨€çš„ç¿»è¯‘æ–‡æœ¬\"\"\"\n    return TRANSLATIONS.get(language, {}).get(key, key)\n\ndef get_available_languages():\n    \"\"\"è·å–å¯ç”¨çš„è¯­è¨€é€‰é¡¹\"\"\"\n    return {\"en\": \"English\", \"zh\": \"ä¸­æ–‡\"}\n\n# åœ¨ä¸»ç¨‹åº (app.py) ä¸­\ndef main():\n    # è¯­è¨€çŠ¶æ€ç®¡ç†\n    if 'language' not in st.session_state:\n        st.session_state.language = \"en\"\n\n    # è¯­è¨€åˆ‡æ¢æŒ‰é’®\n    current_lang = st.session_state.language\n    available_langs = get_available_languages()\n\n    col1, col2, col3 = st.columns([1,1,6])\n    with col1:\n        if st.button(\"EN\", disabled=current_lang==\"en\"):\n            st.session_state.language = \"en\"\n            st.rerun()\n\n    with col2:\n        if st.button(\"ä¸­æ–‡\", disabled=current_lang==\"zh\"):\n            st.session_state.language = \"zh\"\n            st.rerun()\n\n    # åœ¨æ‰€æœ‰ UI å…ƒç´ ä¸­ä½¿ç”¨å½“å‰è¯­è¨€\n    language = st.session_state.language\n    st.title(get_text(\"app_title\", language))\n    st.sidebar.header(get_text(\"sidebar_header\", language))\n```\n:::\n\n\n**å›½é™…åŒ–ç‰¹æ€§ï¼š**\n- **å®Œæ•´çš„ UI ç¿»è¯‘**ï¼šæœ¬åœ°åŒ–æ‰€æœ‰ç•Œé¢å…ƒç´ \n- **åŠ¨æ€è¯­è¨€åˆ‡æ¢**ï¼šè¯­è¨€æ›´æ”¹æ—¶å³æ—¶æ›´æ–° UI\n- **ä¸­æ–‡å­—ç¬¦æ”¯æŒ**ï¼šå®Œæ•´çš„ Unicode å’Œ CJK æ”¯æŒ\n- **è¯­å¢ƒä¸€è‡´**ï¼šAI å›å¤ä¸ UI è¯­è¨€ç›¸åŒ¹é…\n\n## é«˜çº§ UI ç»„ä»¶\n\n### å¸¦è§†è§‰æŒ‡ç¤ºçš„å¤©æ°”æ•°æ®è¡¨\n\nå¤©æ°”è¡¨ç»“åˆäº†æ•°æ®ä¸è§†è§‰å…ƒç´ ï¼Œæ–¹ä¾¿ç”¨æˆ·å¿«é€Ÿç†è§£ï¼š\n\n::: {#8d02fc18 .cell execution_count=8}\n``` {.python .cell-code}\ndef create_weather_table(weather_df, language=\"en\"):\n    \"\"\"åˆ›å»ºå¢å¼ºçš„å¤©æ°”è¡¨ï¼ŒåŒ…å«å›¾æ ‡å’Œé¢œè‰²æ˜¾ç¤º\"\"\"\n\n    # å¤©æ°”ä»£ç åˆ° Emoji çš„æ˜ å°„\n    WEATHER_ICONS = {\n        0: \"â˜€ï¸\",   # æ™´\n        1: \"â›…\",   # æ™´é—´å¤šäº‘\n        2: \"â˜ï¸\",   # å¤šäº‘\n        3: \"â˜ï¸\",   # é˜´\n        45: \"ğŸŒ«ï¸\",  # é›¾\n        48: \"ğŸŒ¦ï¸\",  # é˜µé›¨\n        51: \"ğŸŒ§ï¸\",  # é›¨\n        53: \"â„ï¸\",  # é›ª\n        95: \"â›ˆï¸\",  # é›·é˜µé›¨\n    }\n\n    def format_weather_row(row):\n        \"\"\"æ ¼å¼åŒ–å•è¡Œå¤©æ°”æƒ…å†µå¹¶æ·»åŠ æ ·å¼\"\"\"\n        date_str = row['date'].strftime('%Y-%m-%d')\n        temp_range = f\"{row['temperature_min']:.1f}Â° ~ {row['temperature_max']:.1f}Â°\"\n        weather_icon = WEATHER_ICONS.get(row['weather_code'], \"ğŸŒ¡ï¸\")\n\n        # ç©ºæ°”è´¨é‡å¾½ç« \n        aq_info = get_air_quality_level(row['pm2_5'])\n        aq_badge = f'<span style=\"background-color: {aq_info[\"color\"]}; color: {aq_info[\"text_color\"]}; padding: 2px 6px; border-radius: 3px; font-size: 0.8em;\">{aq_info[\"icon\"]} {row[\"pm2_5\"]:.0f}</span>'\n\n        # é™é›¨æ¦‚ç‡æŒ‡ç¤º\n        rain_color = 'red' if row['rain_probability'] >= 80 else 'orange' if row['rain_probability'] >= 50 else 'gray'\n        rain_indicator = f'<span style=\"color: {rain_color};\">ğŸ”´ {row[\"rain_probability\"]:.0f}%</span>' if row['rain_probability'] >= 50 else f'<span style=\"color: {rain_color};\">ğŸŸ¢ {row[\"rain_probability\"]:.0f}%</span>'\n\n        # â€œä»Šæ—¥â€è¡Œé«˜äº®æ˜¾ç¤º\n        row_style = 'font-size: 1.2em; font-weight: bold;' if row['is_today'] else ''\n\n        return {\n            'æ—¥æœŸ': f'<span style=\"{row_style}\">{date_str}</span>',\n            'å¤©æ°”': f'<span style=\"{row_style}\">{weather_icon}</span>',\n            'æ¸©åº¦': f'<span style=\"{row_style}\">{temp_range}</span>',\n            'é£é€Ÿ': f'<span style=\"{row_style}\">ğŸ’¨ {row[\"wind_speed_max\"]:.1f} km/h</span>',\n            'é™é›¨': rain_indicator,\n            'ç©ºæ°”è´¨é‡': aq_badge\n        }\n\n    # å¯¹æ‰€æœ‰è¡Œåº”ç”¨æ ¼å¼åŒ–\n    formatted_rows = [format_weather_row(row) for _, row in weather_df.iterrows()]\n\n    return pd.DataFrame(formatted_rows)\n\n# åœ¨ Streamlit ä¸­æ˜¾ç¤º\nst.markdown(\"### ğŸ“Š å¤©æ°”è¯¦æƒ…\")\nst.dataframe(\n    create_weather_table(weather_df, language),\n    width=1200,\n    hide_index=True,\n    unsafe_allow_html=True\n)\n```\n:::\n\n\n**è¡¨æ ¼ç‰¹æ€§ï¼š**\n- **å¤©æ°”å›¾æ ‡**ï¼šEmoji è¡¨è¾¾æ–¹å¼ï¼Œç›´è§‚æ˜“æ‡‚\n- **ä»Šæ—¥é«˜äº®**ï¼šå¯¹å½“å¤©æ—¥æœŸä½¿ç”¨æ›´å¤§ã€åŠ ç²—çš„æ–‡å­—\n- **ç©ºæ°”è´¨é‡å¾½ç« **ï¼šé¢œè‰²ç¼–ç çš„ PM2.5 æŒ‡æ ‡\n- **é™é›¨æ¦‚ç‡**ï¼šåŸºäº Material Design è‰²ç³»çš„è§†è§‰æŒ‡ç¤º\n- **å“åº”å¼å¸ƒå±€**ï¼šé€‚åº”å„ç§å±å¹•å®½åº¦\n\n## éƒ¨ç½²ä¸ç”Ÿäº§\n\n### ç¯å¢ƒé…ç½®\n\nåœ¨ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ—¶ï¼Œè¯·é…ç½®ç¯å¢ƒå˜é‡ï¼š\n\n```bash\n# .env æ–‡ä»¶\nmodelscope=æ‚¨çš„ API å¯†é’¥\n\n# å…¶ä»–ç”Ÿäº§ç¯å¢ƒè®¾ç½®\n# è€ƒè™‘é¢‘ç‡é™åˆ¶ã€ç¼“å­˜æœºåˆ¶å’Œç›‘æ§\n```\n\n### éƒ¨ç½²åˆ° Streamlit Cloud\n\n```bash\n# 1. å®‰è£… Streamlit CLI\npip install streamlit\n\n# 2. ç™»å½• Streamlit\nstreamlit login\n\n# 3. éƒ¨ç½²åˆ° Streamlit Cloud\nstreamlit run app.py  # é¦–å…ˆåœ¨æœ¬åœ°æµ‹è¯•\n# ç„¶åé€šè¿‡ cloud.streamlit.io æˆ– CLI è¿›è¡Œéƒ¨ç½²\n```\n\n### Docker éƒ¨ç½² (å¯é€‰)\n\n```dockerfile\nFROM python:3.9-slim\n\nWORKDIR /app\n\nCOPY requirements.txt .\nRUN pip install -r requirements.txt\n\nCOPY . .\n\nEXPOSE 8501\n\nCMD [\"streamlit\", \"run\", \"app.py\", \"--server.address\", \"0.0.0.0\"]\n```\n\n## æ€§èƒ½ä¼˜åŒ–\n\n### ç¼“å­˜ç­–ç•¥\n\n```python\n@st.cache_data(ttl=3600)  # ç¼“å­˜ 1 å°æ—¶\ndef get_weather_data_cached(lat, lon):\n    \"\"\"ç¼“å­˜å¤©æ°”æ•°æ®è·å–æ“ä½œ\"\"\"\n    return get_weather_data(lat, lon)\n\n@st.cache_resource\ndef get_ai_client():\n    \"\"\"ç¼“å­˜ AI å®¢æˆ·ç«¯åˆå§‹åŒ–\"\"\"\n    return init_ai_client()\n\n# ç¼“å­˜åœ°å›¾ç”Ÿæˆ\n@st.cache_data(ttl=3600)\ndef create_map_cached(lat, lon):\n    \"\"\"ç¼“å­˜åœ°å›¾åˆ›å»ºæ“ä½œ\"\"\"\n    return create_interactive_map(lat, lon)\n```\n\n### é”™è¯¯å¤„ç†ä¸å®¹é”™\n\n::: {#1817e4bd .cell execution_count=9}\n``` {.python .cell-code}\ndef robust_api_call(func, *args, max_retries=3, **kwargs):\n    \"\"\"å¸¦é‡è¯•é€»è¾‘çš„é«˜å¯ç”¨ API è°ƒç”¨\"\"\"\n    for attempt in range(max_retries):\n        try:\n            return func(*args, **kwargs)\n        except requests.exceptions.Timeout:\n            if attempt == max_retries - 1:\n                st.error(\"å¤©æ°”æœåŠ¡æš‚æ—¶ä¸å¯ç”¨\")\n                return None\n            time.sleep(2 ** attempt)  # æŒ‡æ•°é€€é¿é‡è¯•\n        except requests.exceptions.RequestException as e:\n            st.error(f\"API é”™è¯¯: {e}\")\n            return None\n```\n:::\n\n\n- **æ•°æ®å¯è§†åŒ–**ï¼šä¸“ä¸šå›¾è¡¨ä¸äº¤äº’å¼åœ°å›¾ã€‚\n- **AI é›†æˆ**ï¼šå°†è¯­è¨€æ¨¡å‹å®é™…åº”ç”¨äºæ•°æ®åˆ†æã€‚\n- **å›½é™…åŒ–**ï¼šå®Œæ•´çš„åŒè¯­æ”¯æŒã€‚\n- **ç”Ÿäº§å°±ç»ª**ï¼šåŒ…å«é”™è¯¯å¤„ç†ã€ç¼“å­˜å’Œæ€§èƒ½ä¼˜åŒ–ã€‚\n\næ— è®ºæ‚¨æ˜¯åœ¨æ„å»ºå¤©æ°”åº”ç”¨ã€æ•°æ®çœ‹æ¿è¿˜æ˜¯ AI é©±åŠ¨çš„å·¥å…·ï¼Œè¯¥é¡¹ç›®éƒ½ä¸ºåˆ›å»ºå¤æ‚ä¸”ç”¨æˆ·å‹å¥½çš„åº”ç”¨ç¨‹åºæä¾›äº†åšå®çš„åŸºç¡€ã€‚\n\n",
    "supporting": [
      "index_files/figure-html"
    ],
    "filters": [],
    "includes": {}
  }
}